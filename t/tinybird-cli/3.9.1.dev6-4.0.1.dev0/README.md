# Comparing `tmp/tinybird-cli-3.9.1.dev6.tar.gz` & `tmp/tinybird-cli-4.0.1.dev0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "tinybird-cli-3.9.1.dev6.tar", last modified: Tue Apr 30 08:59:36 2024, max compression
+gzip compressed data, was "tinybird-cli-4.0.1.dev0.tar", last modified: Tue May 28 07:16:19 2024, max compression
```

## Comparing `tinybird-cli-3.9.1.dev6.tar` & `tinybird-cli-4.0.1.dev0.tar`

### file list

```diff
@@ -1,52 +1,52 @@
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.694357 tinybird-cli-3.9.1.dev6/
--rw-r--r--   0 root         (0) root         (0)    68837 2024-04-30 08:59:36.693358 tinybird-cli-3.9.1.dev6/PKG-INFO
--rw-r--r--   0 root         (0) root         (0)       38 2024-04-30 08:59:36.694357 tinybird-cli-3.9.1.dev6/setup.cfg
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.690358 tinybird-cli-3.9.1.dev6/tinybird/
--rw-rw-rw-   0 root         (0) root         (0)      254 2024-04-30 08:59:35.000000 tinybird-cli-3.9.1.dev6/tinybird/__cli__.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.690358 tinybird-cli-3.9.1.dev6/tinybird/ch_utils/
--rw-rw-rw-   0 root         (0) root         (0)     3657 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/ch_utils/constants.py
--rw-rw-rw-   0 root         (0) root         (0)    39699 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/ch_utils/engine.py
--rw-rw-rw-   0 root         (0) root         (0)      975 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/check_pypi.py
--rw-rw-rw-   0 root         (0) root         (0)    46918 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/client.py
--rw-rw-rw-   0 root         (0) root         (0)     2003 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/config.py
--rw-rw-rw-   0 root         (0) root         (0)    15244 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/connectors.py
--rw-rw-rw-   0 root         (0) root         (0)      845 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/context.py
--rw-rw-rw-   0 root         (0) root         (0)   212518 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/datafile.py
--rw-rw-rw-   0 root         (0) root         (0)     7060 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/datatypes.py
--rw-rw-rw-   0 root         (0) root         (0)    59923 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/feedback_manager.py
--rw-rw-rw-   0 root         (0) root         (0)     4707 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/git_settings.py
--rw-rw-rw-   0 root         (0) root         (0)    41589 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/sql.py
--rw-rw-rw-   0 root         (0) root         (0)    81435 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/sql_template.py
--rw-rw-rw-   0 root         (0) root         (0)    10196 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/sql_template_fmt.py
--rw-rw-rw-   0 root         (0) root         (0)    11568 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/sql_toolset.py
--rw-rw-rw-   0 root         (0) root         (0)    27763 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/syncasync.py
--rw-rw-rw-   0 root         (0) root         (0)      674 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.692358 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/
--rw-rw-rw-   0 root         (0) root         (0)     8601 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/auth.py
--rw-rw-rw-   0 root         (0) root         (0)    37863 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/branch.py
--rw-rw-rw-   0 root         (0) root         (0)    14087 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/cicd.py
--rw-rw-rw-   0 root         (0) root         (0)    64868 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/cli.py
--rw-rw-rw-   0 root         (0) root         (0)    78344 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/common.py
--rw-rw-rw-   0 root         (0) root         (0)    11484 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/config.py
--rw-rw-rw-   0 root         (0) root         (0)    31660 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/connection.py
--rw-rw-rw-   0 root         (0) root         (0)    31944 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/datasource.py
--rw-rw-rw-   0 root         (0) root         (0)     3367 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/exceptions.py
--rw-rw-rw-   0 root         (0) root         (0)     2964 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/job.py
--rw-rw-rw-   0 root         (0) root         (0)    26155 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/pipe.py
--rw-rw-rw-   0 root         (0) root         (0)     2010 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/regions.py
--rw-rw-rw-   0 root         (0) root         (0)    10490 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/telemetry.py
--rw-rw-rw-   0 root         (0) root         (0)     4223 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/test.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.693358 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/tinyunit/
--rw-rw-rw-   0 root         (0) root         (0)    11667 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/tinyunit/tinyunit.py
--rw-rw-rw-   0 root         (0) root         (0)     1868 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py
--rw-rw-rw-   0 root         (0) root         (0)     4383 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/token.py
--rw-rw-rw-   0 root         (0) root         (0)    11064 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/workspace.py
--rw-rw-rw-   0 root         (0) root         (0)     8268 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/workspace_members.py
--rw-rw-rw-   0 root         (0) root         (0)    41982 2024-04-30 08:59:31.000000 tinybird-cli-3.9.1.dev6/tinybird/tornado_template.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-30 08:59:36.693358 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/
--rw-r--r--   0 root         (0) root         (0)    68837 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/PKG-INFO
--rw-r--r--   0 root         (0) root         (0)     1348 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/SOURCES.txt
--rw-r--r--   0 root         (0) root         (0)        1 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/dependency_links.txt
--rw-r--r--   0 root         (0) root         (0)       43 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/entry_points.txt
--rw-r--r--   0 root         (0) root         (0)      732 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/requires.txt
--rw-r--r--   0 root         (0) root         (0)       45 2024-04-30 08:59:36.000000 tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/top_level.txt
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.014757 tinybird-cli-4.0.1.dev0/
+-rw-r--r--   0 root         (0) root         (0)    70608 2024-05-28 07:16:19.014757 tinybird-cli-4.0.1.dev0/PKG-INFO
+-rw-r--r--   0 root         (0) root         (0)       38 2024-05-28 07:16:19.014757 tinybird-cli-4.0.1.dev0/setup.cfg
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.011757 tinybird-cli-4.0.1.dev0/tinybird/
+-rw-rw-rw-   0 root         (0) root         (0)      254 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird/__cli__.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.011757 tinybird-cli-4.0.1.dev0/tinybird/ch_utils/
+-rw-rw-rw-   0 root         (0) root         (0)     3657 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/ch_utils/constants.py
+-rw-rw-rw-   0 root         (0) root         (0)    39699 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/ch_utils/engine.py
+-rw-rw-rw-   0 root         (0) root         (0)      975 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/check_pypi.py
+-rw-rw-rw-   0 root         (0) root         (0)    46918 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/client.py
+-rw-rw-rw-   0 root         (0) root         (0)     2003 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/config.py
+-rw-rw-rw-   0 root         (0) root         (0)    15244 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/connectors.py
+-rw-rw-rw-   0 root         (0) root         (0)     1127 2024-05-28 07:16:04.000000 tinybird-cli-4.0.1.dev0/tinybird/context.py
+-rw-rw-rw-   0 root         (0) root         (0)   210873 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/datafile.py
+-rw-rw-rw-   0 root         (0) root         (0)     7060 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/datatypes.py
+-rw-rw-rw-   0 root         (0) root         (0)    60657 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/feedback_manager.py
+-rw-rw-rw-   0 root         (0) root         (0)     4707 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/git_settings.py
+-rw-rw-rw-   0 root         (0) root         (0)    41589 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/sql.py
+-rw-rw-rw-   0 root         (0) root         (0)    81800 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/sql_template.py
+-rw-rw-rw-   0 root         (0) root         (0)    10196 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/sql_template_fmt.py
+-rw-rw-rw-   0 root         (0) root         (0)    11523 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/sql_toolset.py
+-rw-rw-rw-   0 root         (0) root         (0)    27763 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/syncasync.py
+-rw-rw-rw-   0 root         (0) root         (0)      674 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.013757 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/
+-rw-rw-rw-   0 root         (0) root         (0)     8601 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/auth.py
+-rw-rw-rw-   0 root         (0) root         (0)    38296 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/branch.py
+-rw-rw-rw-   0 root         (0) root         (0)    13910 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/cicd.py
+-rw-rw-rw-   0 root         (0) root         (0)    64576 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/cli.py
+-rw-rw-rw-   0 root         (0) root         (0)    78296 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/common.py
+-rw-rw-rw-   0 root         (0) root         (0)    11484 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/config.py
+-rw-rw-rw-   0 root         (0) root         (0)    32368 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/connection.py
+-rw-rw-rw-   0 root         (0) root         (0)    31968 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/datasource.py
+-rw-rw-rw-   0 root         (0) root         (0)     3367 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/exceptions.py
+-rw-rw-rw-   0 root         (0) root         (0)     2964 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/job.py
+-rw-rw-rw-   0 root         (0) root         (0)    26132 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/pipe.py
+-rw-rw-rw-   0 root         (0) root         (0)     2228 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/regions.py
+-rw-rw-rw-   0 root         (0) root         (0)    10490 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/telemetry.py
+-rw-rw-rw-   0 root         (0) root         (0)     4223 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/test.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.013757 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/tinyunit/
+-rw-rw-rw-   0 root         (0) root         (0)    11667 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/tinyunit/tinyunit.py
+-rw-rw-rw-   0 root         (0) root         (0)     1868 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py
+-rw-rw-rw-   0 root         (0) root         (0)     4383 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/token.py
+-rw-rw-rw-   0 root         (0) root         (0)    11064 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/workspace.py
+-rw-rw-rw-   0 root         (0) root         (0)     8268 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/workspace_members.py
+-rw-rw-rw-   0 root         (0) root         (0)    41982 2024-05-28 07:16:05.000000 tinybird-cli-4.0.1.dev0/tinybird/tornado_template.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-05-28 07:16:19.014757 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/
+-rw-r--r--   0 root         (0) root         (0)    70608 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/PKG-INFO
+-rw-r--r--   0 root         (0) root         (0)     1348 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/SOURCES.txt
+-rw-r--r--   0 root         (0) root         (0)        1 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/dependency_links.txt
+-rw-r--r--   0 root         (0) root         (0)       43 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/entry_points.txt
+-rw-r--r--   0 root         (0) root         (0)      732 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/requires.txt
+-rw-r--r--   0 root         (0) root         (0)       45 2024-05-28 07:16:18.000000 tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/top_level.txt
```

### Comparing `tinybird-cli-3.9.1.dev6/PKG-INFO` & `tinybird-cli-4.0.1.dev0/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tinybird-cli
-Version: 3.9.1.dev6
+Version: 4.0.1.dev0
 Summary: Tinybird Command Line Tool
 Home-page: https://www.tinybird.co/docs/cli/introduction.html
 Author: Tinybird
 Author-email: support@tinybird.co
 Requires-Python: >=3.8, <3.12
 Description-Content-Type: text/x-rst
 Provides-Extra: bigquery
@@ -14,37 +14,48 @@
 =============
 
 The Tinybird command-line tool allows you to use all the Tinybird functionality directly from the command line. Additionally, it includes several functions to create and manage data projects easily.
 
 Changelog
 ----------
 
-3.9.1.dev6
+4.0.0
 ************
 
-- `Added` Support for unlink materialized pipes doing `tb workspace clear`
+This is a major release, please read the commands affected below and consider updating your scripts and workflow before upgrading to these version.
 
-3.9.1.dev5
-************
-
-- `Added` support for adding multiple tokens when pushing a `.datasource` file
+- `Deprecated` `--semver` flag and `tb release` commands are now deprecated. You can keep using `tb deploy` to integrate and deploy from git. Changes are deployed to the main Workspace instead of to a Release.
+- `Removed` `--cicd` flag and CI/CD templates generation from `tb init`. You can still use the git integration, just create your own pipelines. You can use the ones in this repo as an exmple https://github.com/tinybirdco/ci
+- `Removed` `tb env` command is removed, use `tb branch` instead.
+- `Deprecated` .datasource files with `ENGINE "Join"` are deprecated, use `Engine "MergeeTree"` instead.
+- `Deprecated` `tb materialize`
+- `Removed` Drop the `--timeout` flag from `tb push` which made the populate job to timeout. You can use now `--wait` to wait for the job to finish or nothing to just create the job and return.
+- `Removed` Support for `KEY` directive is removed. The `KEY` was used to create a Data Source with Join engine by the given `KEY` column name. Join engines are also deprecated, you can use a regular `MergeTree` Data Source instead and adapt the pipes SQL accordingly.
 
-3.9.1.dev4
+3.12.0
 ************
 
-- `Fixed` s3 iamrole connection creation will not fail when `pbcopy` dependency is not available
+- `Added` new "us-west-2" region to `tb auth ls`
+- `Fixed` "Appended 0 new rows" message when appending NDJSON
 
-3.9.1.dev3
+3.11.0
 ************
 
-- `Fixed` Fixed a bug on data branching
+- `Added` confirmation step to `tb datasource sync` command
+- `Fixed` support for KAFKA_STORE_BINARY_HEADERS for new Data Sources. Only relevant when KAFKA_STORE_HEADERS is also enabled, used to store Kafka headers as binary data (default option from now on).
+- `Fixed` Report error when `tb push --force --yes` cannot apply a change in a .datasource schema
+- `Fixed` Skip error when using `tb push --only-changes` and no local .git directory is present
 
-3.9.1.dev2
+3.10.0
 ************
 
+- `Added` support for unlink materialized pipes doing `tb workspace clear`
+- `Added` support for adding multiple tokens when pushing a `.datasource` file
+- `Fixed` s3 iamrole connection creation will not fail when `pbcopy` dependency is not available
+- `Fixed` Fixed a bug on data branching
 - `Fixed` Support ngram index
 
 3.9.0
 ************
 
 - `Added` Support for connection names when doing `tb connection rm`
 - `Added` New `--policy` option for `create s3_iamrole` command that will generate different hints depending on the case
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/ch_utils/constants.py` & `tinybird-cli-4.0.1.dev0/tinybird/ch_utils/constants.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/ch_utils/engine.py` & `tinybird-cli-4.0.1.dev0/tinybird/ch_utils/engine.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/check_pypi.py` & `tinybird-cli-4.0.1.dev0/tinybird/check_pypi.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/client.py` & `tinybird-cli-4.0.1.dev0/tinybird/client.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/config.py` & `tinybird-cli-4.0.1.dev0/tinybird/config.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/connectors.py` & `tinybird-cli-4.0.1.dev0/tinybird/connectors.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/datafile.py` & `tinybird-cli-4.0.1.dev0/tinybird/datafile.py`

 * *Files 1% similar despite different names*

```diff
@@ -1505,11779 +1505,11676 @@
 00005e00: 2020 2020 2020 6966 2073 656c 662e 6472        if self.dr
 00005e10: 795f 7275 6e20 6f72 2068 6173 5f73 656d  y_run or has_sem
 00005e20: 7665 723a 0a20 2020 2020 2020 2020 2020  ver:.           
 00005e30: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
 00005e40: 6966 2073 656c 662e 6973 5f67 6974 5f72  if self.is_git_r
 00005e50: 656c 6561 7365 206f 7220 7365 6c66 2e6f  elease or self.o
 00005e60: 6e6c 795f 6368 616e 6765 733a 0a20 2020  nly_changes:.   
-00005e70: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-00005e80: 695f 6769 745f 7265 6c65 6173 6520 3d20  i_git_release = 
-00005e90: 7365 6c66 2e63 6c69 5f67 6974 5f72 656c  self.cli_git_rel
-00005ea0: 6561 7365 206f 7220 434c 4947 6974 5265  ease or CLIGitRe
-00005eb0: 6c65 6173 6528 290a 2020 2020 2020 2020  lease().        
-00005ec0: 2020 2020 6966 2073 656c 662e 6375 7272      if self.curr
-00005ed0: 656e 745f 7265 6c65 6173 653a 0a20 2020  ent_release:.   
-00005ee0: 2020 2020 2020 2020 2020 2020 2072 656c               rel
-00005ef0: 6561 7365 203d 2061 7761 6974 2073 656c  ease = await sel
-00005f00: 662e 636c 695f 6769 745f 7265 6c65 6173  f.cli_git_releas
-00005f10: 652e 7570 6461 7465 5f72 656c 6561 7365  e.update_release
-00005f20: 2873 656c 662e 7462 5f63 6c69 656e 742c  (self.tb_client,
-00005f30: 2073 656c 662e 6375 7272 656e 745f 7773   self.current_ws
-00005f40: 2c20 636f 6d6d 6974 290a 2020 2020 2020  , commit).      
-00005f50: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-00005f60: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-00005f70: 6167 6572 2e73 7563 6365 7373 5f67 6974  ager.success_git
-00005f80: 5f72 656c 6561 7365 2872 656c 6561 7365  _release(release
-00005f90: 5f63 6f6d 6d69 743d 7265 6c65 6173 655b  _commit=release[
-00005fa0: 2263 6f6d 6d69 7422 5d29 290a 2020 2020  "commit"])).    
-00005fb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005fc0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00005fd0: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
-00005fe0: 6b4d 616e 6167 6572 2e77 6172 6e69 6e67  kManager.warning
-00005ff0: 5f6e 6f5f 7265 6c65 6173 6528 2929 0a0a  _no_release())..
-00006000: 2020 2020 6173 796e 6320 6465 6620 6465      async def de
-00006010: 6c65 7465 5f72 6573 6f75 7263 6573 2873  lete_resources(s
-00006020: 656c 662c 2064 656c 6574 6564 3a20 4c69  elf, deleted: Li
-00006030: 7374 5b73 7472 5d2c 2072 656d 6f74 655f  st[str], remote_
-00006040: 7069 7065 733a 204c 6973 745b 4469 6374  pipes: List[Dict
-00006050: 5b73 7472 2c20 416e 795d 5d2c 2064 7279  [str, Any]], dry
-00006060: 5f72 756e 3a20 626f 6f6c 203d 2046 616c  _run: bool = Fal
-00006070: 7365 293a 0a20 2020 2020 2020 2061 7379  se):.        asy
-00006080: 6e63 2064 6566 2064 656c 6574 655f 7069  nc def delete_pi
-00006090: 7065 2872 6573 6f75 7263 655f 6e61 6d65  pe(resource_name
-000060a0: 5f6f 725f 6964 3a20 7374 722c 2064 7279  _or_id: str, dry
-000060b0: 5f72 756e 3a20 626f 6f6c 203d 2046 616c  _run: bool = Fal
-000060c0: 7365 293a 0a20 2020 2020 2020 2020 2020  se):.           
-000060d0: 2069 6620 6472 795f 7275 6e3a 0a20 2020   if dry_run:.   
-000060e0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-000060f0: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
-00006100: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
-00006110: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
-00006120: 6f5f 6465 6c65 7469 6e67 5f72 6573 6f75  o_deleting_resou
-00006130: 7263 6528 6472 795f 7275 6e3d 225b 4452  rce(dry_run="[DR
-00006140: 5920 5255 4e5d 2022 2c20 7265 736f 7572  Y RUN] ", resour
-00006150: 6365 5f6e 616d 653d 7265 736f 7572 6365  ce_name=resource
-00006160: 5f6e 616d 655f 6f72 5f69 6429 0a20 2020  _name_or_id).   
-00006170: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00006180: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00006190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000061a0: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
-000061b0: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
-000061c0: 5f64 656c 6574 696e 675f 7265 736f 7572  _deleting_resour
-000061d0: 6365 2864 7279 5f72 756e 3d22 222c 2072  ce(dry_run="", r
-000061e0: 6573 6f75 7263 655f 6e61 6d65 3d72 6573  esource_name=res
-000061f0: 6f75 7263 655f 6e61 6d65 5f6f 725f 6964  ource_name_or_id
-00006200: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00006210: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00006220: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00006230: 7420 7365 6c66 2e74 625f 636c 6965 6e74  t self.tb_client
-00006240: 2e70 6970 655f 6465 6c65 7465 2872 6573  .pipe_delete(res
-00006250: 6f75 7263 655f 6e61 6d65 5f6f 725f 6964  ource_name_or_id
-00006260: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006270: 2020 6578 6365 7074 2041 7574 6845 7863    except AuthExc
-00006280: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062a0: 2072 6169 7365 2043 4c49 4769 7452 656c   raise CLIGitRel
-000062b0: 6561 7365 4578 6365 7074 696f 6e28 7374  easeException(st
-000062c0: 7228 6529 290a 2020 2020 2020 2020 2020  r(e)).          
-000062d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062f0: 636c 6963 6b2e 6563 686f 2846 6565 6462  click.echo(Feedb
-00006300: 6163 6b4d 616e 6167 6572 2e73 7563 6365  ackManager.succe
-00006310: 7373 5f64 656c 6574 6528 6e61 6d65 3d72  ss_delete(name=r
-00006320: 6573 6f75 7263 655f 6e61 6d65 5f6f 725f  esource_name_or_
-00006330: 6964 2929 0a0a 2020 2020 2020 2020 6173  id))..        as
-00006340: 796e 6320 6465 6620 6465 6c65 7465 5f64  ync def delete_d
-00006350: 6174 6173 6f75 7263 6528 7265 736f 7572  atasource(resour
-00006360: 6365 5f6e 616d 655f 6f72 5f69 643a 2073  ce_name_or_id: s
-00006370: 7472 2c20 6472 795f 7275 6e3a 2062 6f6f  tr, dry_run: boo
-00006380: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
-00006390: 2020 2020 2020 2020 6966 2064 7279 5f72          if dry_r
-000063a0: 756e 3a0a 2020 2020 2020 2020 2020 2020  un:.            
-000063b0: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
-000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063d0: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
-000063e0: 6765 722e 696e 666f 5f64 656c 6574 696e  ger.info_deletin
-000063f0: 675f 7265 736f 7572 6365 2864 7279 5f72  g_resource(dry_r
-00006400: 756e 3d22 5b44 5259 2052 554e 5d20 222c  un="[DRY RUN] ",
-00006410: 2072 6573 6f75 7263 655f 6e61 6d65 3d72   resource_name=r
-00006420: 6573 6f75 7263 655f 6e61 6d65 5f6f 725f  esource_name_or_
-00006430: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
-00006440: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00006450: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006460: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-00006470: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-00006480: 6572 2e69 6e66 6f5f 6465 6c65 7469 6e67  er.info_deleting
-00006490: 5f72 6573 6f75 7263 6528 6472 795f 7275  _resource(dry_ru
-000064a0: 6e3d 2222 2c20 7265 736f 7572 6365 5f6e  n="", resource_n
-000064b0: 616d 653d 7265 736f 7572 6365 5f6e 616d  ame=resource_nam
-000064c0: 655f 6f72 5f69 6429 290a 2020 2020 2020  e_or_id)).      
-000064d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000064e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064f0: 2020 2061 7761 6974 2073 656c 662e 7462     await self.tb
-00006500: 5f63 6c69 656e 742e 6461 7461 736f 7572  _client.datasour
-00006510: 6365 5f64 656c 6574 6528 7265 736f 7572  ce_delete(resour
-00006520: 6365 5f6e 616d 655f 6f72 5f69 6429 0a20  ce_name_or_id). 
-00006530: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006540: 7863 6570 7420 4361 6e4e 6f74 4265 4465  xcept CanNotBeDe
-00006550: 6c65 7465 6445 7863 6570 7469 6f6e 2061  letedException a
-00006560: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00006570: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
-00006580: 4c49 4769 7452 656c 6561 7365 4578 6365  LIGitReleaseExce
-00006590: 7074 696f 6e28 7374 7228 6529 290a 2020  ption(str(e)).  
-000065a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000065b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000065c0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-000065d0: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-000065e0: 6572 2e73 7563 6365 7373 5f64 656c 6574  er.success_delet
-000065f0: 6528 6e61 6d65 3d72 6573 6f75 7263 655f  e(name=resource_
-00006600: 6e61 6d65 5f6f 725f 6964 2929 0a0a 2020  name_or_id))..  
-00006610: 2020 2020 2020 7265 736f 7572 6365 5f65        resource_e
-00006620: 7874 656e 7369 6f6e 5f70 726f 6365 7373  xtension_process
-00006630: 6f72 203d 207b 222e 6461 7461 736f 7572  or = {".datasour
-00006640: 6365 223a 2064 656c 6574 655f 6461 7461  ce": delete_data
-00006650: 736f 7572 6365 2c20 222e 7069 7065 223a  source, ".pipe":
-00006660: 2064 656c 6574 655f 7069 7065 7d0a 0a20   delete_pipe}.. 
-00006670: 2020 2020 2020 2023 2062 7569 6c64 7320         # builds 
-00006680: 7069 7065 7320 6465 7073 2074 6865 206f  pipes deps the o
-00006690: 7468 6572 2077 6179 2061 726f 756e 6420  ther way around 
-000066a0: 6672 6f6d 2041 5049 2074 6f20 7573 6520  from API to use 
-000066b0: 7769 7468 2074 6f70 6f73 6f72 740a 2020  with toposort.  
-000066c0: 2020 2020 2020 2320 692e 6520 7b27 616e        # i.e {'an
-000066d0: 616c 7974 6963 735f 6869 7473 273a 205b  alytics_hits': [
-000066e0: 2761 6e61 6c79 7469 6373 5f70 6167 6573  'analytics_pages
-000066f0: 272c 2027 7472 656e 6427 2c20 2761 6e61  ', 'trend', 'ana
-00006700: 6c79 7469 6373 5f73 6f75 7263 6573 272c  lytics_sources',
-00006710: 2027 616e 616c 7974 6963 735f 7365 7373   'analytics_sess
-00006720: 696f 6e73 275d 7d0a 2020 2020 2020 2020  ions']}.        
-00006730: 7069 7065 735f 6465 7073 3a20 4469 6374  pipes_deps: Dict
-00006740: 5b73 7472 2c20 4c69 7374 5b73 7472 5d5d  [str, List[str]]
-00006750: 203d 207b 7d0a 2020 2020 2020 2020 7265   = {}.        re
-00006760: 6d6f 7465 5f70 6970 6573 5f74 7970 653a  mote_pipes_type:
-00006770: 2044 6963 745b 7374 722c 2073 7472 5d20   Dict[str, str] 
-00006780: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-00006790: 2070 6970 6520 696e 2072 656d 6f74 655f   pipe in remote_
-000067a0: 7069 7065 733a 0a20 2020 2020 2020 2020  pipes:.         
-000067b0: 2020 2070 6970 6573 5f64 6570 735b 7069     pipes_deps[pi
-000067c0: 7065 5b22 6e61 6d65 225d 5d20 3d20 5b5d  pe["name"]] = []
-000067d0: 0a20 2020 2020 2020 2020 2020 2072 656d  .            rem
-000067e0: 6f74 655f 7069 7065 735f 7479 7065 5b70  ote_pipes_type[p
-000067f0: 6970 655b 226e 616d 6522 5d5d 203d 2070  ipe["name"]] = p
-00006800: 6970 655b 2274 7970 6522 5d0a 2020 2020  ipe["type"].    
-00006810: 2020 2020 2020 2020 666f 7220 6e6f 6465          for node
-00006820: 2069 6e20 7069 7065 5b22 6e6f 6465 7322   in pipe["nodes"
-00006830: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00006840: 2020 2066 6f72 2064 6570 2069 6e20 6e6f     for dep in no
-00006850: 6465 5b22 6465 7065 6e64 656e 6369 6573  de["dependencies
-00006860: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-00006870: 2020 2020 2020 2020 6966 2064 6570 2069          if dep i
-00006880: 6e20 5b70 6970 655b 226e 616d 6522 5d20  n [pipe["name"] 
-00006890: 666f 7220 7069 7065 2069 6e20 7265 6d6f  for pipe in remo
-000068a0: 7465 5f70 6970 6573 5d3a 0a20 2020 2020  te_pipes]:.     
-000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068c0: 2020 2070 6970 6573 5f64 6570 732e 7365     pipes_deps.se
-000068d0: 7464 6566 6175 6c74 2864 6570 2c20 5b5d  tdefault(dep, []
-000068e0: 292e 6170 7065 6e64 2870 6970 655b 226e  ).append(pipe["n
-000068f0: 616d 6522 5d29 0a20 2020 2020 2020 2064  ame"]).        d
-00006900: 656c 6574 6564 5f72 6573 6f75 7263 6573  eleted_resources
-00006910: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-00006920: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00006930: 2050 6174 6828 7265 736f 7572 6365 292e   Path(resource).
-00006940: 7265 736f 6c76 6528 292e 7374 656d 3a20  resolve().stem: 
-00006950: 7265 736f 7572 6365 2066 6f72 2072 6573  resource for res
-00006960: 6f75 7263 6520 696e 2064 656c 6574 6564  ource in deleted
-00006970: 2069 6620 222e 696e 636c 2220 6e6f 7420   if ".incl" not 
-00006980: 696e 2072 6573 6f75 7263 650a 2020 2020  in resource.    
-00006990: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
-000069a0: 6f72 2067 726f 7570 2069 6e20 746f 706f  or group in topo
-000069b0: 736f 7274 2870 6970 6573 5f64 6570 7329  sort(pipes_deps)
-000069c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000069d0: 666f 7220 6561 6368 206c 6576 656c 206b  for each level k
-000069e0: 6565 7020 6d61 7465 7269 616c 697a 6564  eep materialized
-000069f0: 2066 6f72 2074 6865 2065 6e64 0a20 2020   for the end.   
-00006a00: 2020 2020 2020 2020 2066 6f72 2070 6970           for pip
-00006a10: 655f 6e61 6d65 2069 6e20 736f 7274 6564  e_name in sorted
-00006a20: 2867 726f 7570 2c20 6b65 793d 6c61 6d62  (group, key=lamb
-00006a30: 6461 2078 3a20 7265 6d6f 7465 5f70 6970  da x: remote_pip
-00006a40: 6573 5f74 7970 655b 785d 203d 3d20 226d  es_type[x] == "m
-00006a50: 6174 6572 6961 6c69 7a65 6422 293a 0a20  aterialized"):. 
-00006a60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006a70: 6620 7069 7065 5f6e 616d 6520 696e 2064  f pipe_name in d
-00006a80: 656c 6574 6564 5f72 6573 6f75 7263 6573  eleted_resources
-00006a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006aa0: 2020 2020 2020 7265 736f 7572 6365 5f70        resource_p
-00006ab0: 6174 6820 3d20 6465 6c65 7465 645f 7265  ath = deleted_re
-00006ac0: 736f 7572 6365 732e 706f 7028 7069 7065  sources.pop(pipe
-00006ad0: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
-00006ae0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b00: 2020 2020 2020 2020 6177 6169 7420 7265          await re
-00006b10: 736f 7572 6365 5f65 7874 656e 7369 6f6e  source_extension
-00006b20: 5f70 726f 6365 7373 6f72 5b50 6174 6828  _processor[Path(
-00006b30: 7265 736f 7572 6365 5f70 6174 6829 2e73  resource_path).s
-00006b40: 7566 6669 785d 2870 6970 655f 6e61 6d65  uffix](pipe_name
-00006b50: 2c20 6472 795f 7275 6e29 0a20 2020 2020  , dry_run).     
-00006b60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006b70: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2020 2020 2020 2020 7261 6973 6520 434c          raise CL
-00006ba0: 4947 6974 5265 6c65 6173 6545 7863 6570  IGitReleaseExcep
-00006bb0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-00006bc0: 6167 6572 2e65 7272 6f72 5f66 696c 655f  ager.error_file_
-00006bd0: 6578 7465 6e73 696f 6e28 6669 6c65 6e61  extension(filena
-00006be0: 6d65 3d72 6573 6f75 7263 655f 7061 7468  me=resource_path
-00006bf0: 2929 0a0a 2020 2020 2020 2020 2320 4465  ))..        # De
-00006c00: 6c65 7465 2070 656e 6469 6e67 2072 6573  lete pending res
-00006c10: 6f75 7263 6573 2028 6461 7461 736f 7572  ources (datasour
-00006c20: 6365 7329 0a20 2020 2020 2020 2066 6f72  ces).        for
-00006c30: 206e 616d 652c 2070 6174 6820 696e 2064   name, path in d
-00006c40: 656c 6574 6564 5f72 6573 6f75 7263 6573  eleted_resources
-00006c50: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00006c60: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00006c70: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00006c80: 2072 6573 6f75 7263 655f 6578 7465 6e73   resource_extens
-00006c90: 696f 6e5f 7072 6f63 6573 736f 725b 5061  ion_processor[Pa
-00006ca0: 7468 2870 6174 6829 2e73 7566 6669 785d  th(path).suffix]
-00006cb0: 286e 616d 652c 2064 7279 5f72 756e 290a  (name, dry_run).
-00006cc0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00006cd0: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00006ce0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00006cf0: 7365 2043 4c49 4769 7452 656c 6561 7365  se CLIGitRelease
-00006d00: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-00006d10: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-00006d20: 6669 6c65 5f65 7874 656e 7369 6f6e 2866  file_extension(f
-00006d30: 696c 656e 616d 653d 7061 7468 2929 0a0a  ilename=path))..
-00006d40: 0a63 6c61 7373 2044 6174 6166 696c 653a  .class Datafile:
-00006d50: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00006d60: 5f28 7365 6c66 2920 2d3e 204e 6f6e 653a  _(self) -> None:
-00006d70: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-00006d80: 696e 7461 696e 6572 3a20 4f70 7469 6f6e  intainer: Option
-00006d90: 616c 5b73 7472 5d20 3d20 4e6f 6e65 0a20  al[str] = None. 
-00006da0: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-00006db0: 6365 733a 204c 6973 745b 7374 725d 203d  ces: List[str] =
-00006dc0: 205b 5d0a 2020 2020 2020 2020 7365 6c66   [].        self
-00006dd0: 2e6e 6f64 6573 3a20 4c69 7374 5b44 6963  .nodes: List[Dic
-00006de0: 745b 7374 722c 2041 6e79 5d5d 203d 205b  t[str, Any]] = [
-00006df0: 5d0a 2020 2020 2020 2020 7365 6c66 2e74  ].        self.t
-00006e00: 6f6b 656e 733a 204c 6973 745b 4469 6374  okens: List[Dict
-00006e10: 5b73 7472 2c20 416e 795d 5d20 3d20 5b5d  [str, Any]] = []
-00006e20: 0a20 2020 2020 2020 2073 656c 662e 6b65  .        self.ke
-00006e30: 7973 3a20 4c69 7374 5b44 6963 745b 7374  ys: List[Dict[st
-00006e40: 722c 2041 6e79 5d5d 203d 205b 5d0a 2020  r, Any]] = [].  
-00006e50: 2020 2020 2020 7365 6c66 2e76 6572 7369        self.versi
-00006e60: 6f6e 3a20 4f70 7469 6f6e 616c 5b69 6e74  on: Optional[int
-00006e70: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-00006e80: 2073 656c 662e 6465 7363 7269 7074 696f   self.descriptio
-00006e90: 6e3a 204f 7074 696f 6e61 6c5b 7374 725d  n: Optional[str]
-00006ea0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00006eb0: 7365 6c66 2e72 6177 3a20 4f70 7469 6f6e  self.raw: Option
-00006ec0: 616c 5b4c 6973 745b 7374 725d 5d20 3d20  al[List[str]] = 
-00006ed0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-00006ee0: 662e 696e 636c 7564 6573 3a20 4469 6374  f.includes: Dict
-00006ef0: 5b73 7472 2c20 416e 795d 203d 207b 7d0a  [str, Any] = {}.
-00006f00: 2020 2020 2020 2020 7365 6c66 2e73 6861          self.sha
-00006f10: 7265 645f 7769 7468 3a20 4c69 7374 5b73  red_with: List[s
-00006f20: 7472 5d20 3d20 5b5d 0a0a 2020 2020 6465  tr] = []..    de
-00006f30: 6620 7661 6c69 6461 7465 2873 656c 6629  f validate(self)
-00006f40: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006f50: 2020 666f 7220 7820 696e 2073 656c 662e    for x in self.
-00006f60: 6e6f 6465 733a 0a20 2020 2020 2020 2020  nodes:.         
-00006f70: 2020 2069 6620 6e6f 7420 785b 226e 616d     if not x["nam
-00006f80: 6522 5d2e 7374 7269 7028 293a 0a20 2020  e"].strip():.   
-00006f90: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00006fa0: 7365 2056 616c 6964 6174 696f 6e45 7863  se ValidationExc
-00006fb0: 6570 7469 6f6e 2822 696e 7661 6c69 6420  eption("invalid 
-00006fc0: 6e6f 6465 206e 616d 652c 2063 616e 2774  node name, can't
-00006fd0: 2062 6520 656d 7074 7922 290a 2020 2020   be empty").    
-00006fe0: 2020 2020 2020 2020 6966 2022 7371 6c22          if "sql"
-00006ff0: 206e 6f74 2069 6e20 783a 0a20 2020 2020   not in x:.     
-00007000: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00007010: 2056 616c 6964 6174 696f 6e45 7863 6570   ValidationExcep
-00007020: 7469 6f6e 2822 6e6f 6465 2025 7320 6d75  tion("node %s mu
-00007030: 7374 2068 6176 6520 6120 5351 4c20 7175  st have a SQL qu
-00007040: 6572 7922 2025 2078 5b22 6e61 6d65 225d  ery" % x["name"]
-00007050: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-00007060: 662e 7665 7273 696f 6e20 6973 206e 6f74  f.version is not
-00007070: 204e 6f6e 6520 616e 6420 286e 6f74 2069   None and (not i
-00007080: 7369 6e73 7461 6e63 6528 7365 6c66 2e76  sinstance(self.v
-00007090: 6572 7369 6f6e 2c20 696e 7429 206f 7220  ersion, int) or 
-000070a0: 7365 6c66 2e76 6572 7369 6f6e 203c 2030  self.version < 0
-000070b0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000070c0: 6169 7365 2056 616c 6964 6174 696f 6e45  aise ValidationE
-000070d0: 7863 6570 7469 6f6e 2822 7665 7273 696f  xception("versio
-000070e0: 6e20 6d75 7374 2062 6520 6120 706f 7369  n must be a posi
-000070f0: 7469 7665 2069 6e74 6567 6572 2229 0a0a  tive integer")..
-00007100: 2020 2020 6465 6620 6973 5f65 7175 616c      def is_equal
-00007110: 2873 656c 662c 206f 7468 6572 293a 0a20  (self, other):. 
-00007120: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-00007130: 6c66 2e6e 6f64 6573 2920 213d 206c 656e  lf.nodes) != len
-00007140: 286f 7468 6572 2e6e 6f64 6573 293a 0a20  (other.nodes):. 
-00007150: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007160: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-00007170: 2066 6f72 2069 2c20 5f20 696e 2065 6e75   for i, _ in enu
-00007180: 6d65 7261 7465 2873 656c 662e 6e6f 6465  merate(self.node
-00007190: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-000071a0: 6966 2073 656c 662e 6e6f 6465 735b 695d  if self.nodes[i]
-000071b0: 2021 3d20 6f74 6865 722e 6e6f 6465 735b   != other.nodes[
-000071c0: 695d 3a0a 2020 2020 2020 2020 2020 2020  i]:.            
-000071d0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-000071e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000071f0: 2054 7275 650a 0a0a 6465 6620 7061 7273   True...def pars
-00007200: 655f 6461 7461 736f 7572 6365 280a 2020  e_datasource(.  
-00007210: 2020 6669 6c65 6e61 6d65 3a20 7374 722c    filename: str,
-00007220: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
-00007230: 733a 2062 6f6f 6c20 3d20 5472 7565 2c20  s: bool = True, 
-00007240: 636f 6e74 656e 743a 204f 7074 696f 6e61  content: Optiona
-00007250: 6c5b 7374 725d 203d 204e 6f6e 652c 2073  l[str] = None, s
-00007260: 6b69 705f 6576 616c 3a20 626f 6f6c 203d  kip_eval: bool =
-00007270: 2046 616c 7365 0a29 202d 3e20 4461 7461   False.) -> Data
-00007280: 6669 6c65 3a0a 2020 2020 6261 7365 7061  file:.    basepa
-00007290: 7468 203d 2022 220a 2020 2020 6966 206e  th = "".    if n
-000072a0: 6f74 2063 6f6e 7465 6e74 3a0a 2020 2020  ot content:.    
-000072b0: 2020 2020 7769 7468 206f 7065 6e28 6669      with open(fi
-000072c0: 6c65 6e61 6d65 2920 6173 2066 696c 653a  lename) as file:
-000072d0: 0a20 2020 2020 2020 2020 2020 2073 203d  .            s =
-000072e0: 2066 696c 652e 7265 6164 2829 0a20 2020   file.read().   
-000072f0: 2020 2020 2062 6173 6570 6174 6820 3d20       basepath = 
-00007300: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-00007310: 6669 6c65 6e61 6d65 290a 2020 2020 656c  filename).    el
-00007320: 7365 3a0a 2020 2020 2020 2020 7320 3d20  se:.        s = 
-00007330: 636f 6e74 656e 740a 0a20 2020 2074 7279  content..    try
-00007340: 3a0a 2020 2020 2020 2020 646f 6320 3d20  :.        doc = 
-00007350: 7061 7273 6528 732c 2022 6465 6661 756c  parse(s, "defaul
-00007360: 7422 2c20 6261 7365 7061 7468 2c20 7265  t", basepath, re
-00007370: 706c 6163 655f 696e 636c 7564 6573 3d72  place_includes=r
-00007380: 6570 6c61 6365 5f69 6e63 6c75 6465 732c  eplace_includes,
-00007390: 2073 6b69 705f 6576 616c 3d73 6b69 705f   skip_eval=skip_
-000073a0: 6576 616c 290a 2020 2020 6578 6365 7074  eval).    except
-000073b0: 2050 6172 7365 4578 6365 7074 696f 6e20   ParseException 
-000073c0: 6173 2065 3a0a 2020 2020 2020 2020 7261  as e:.        ra
-000073d0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-000073e0: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-000073f0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-00007400: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
-00007410: 696e 675f 6669 6c65 2866 696c 656e 616d  ing_file(filenam
-00007420: 653d 6669 6c65 6e61 6d65 2c20 6c69 6e65  e=filename, line
-00007430: 6e6f 3d65 2e6c 696e 656e 6f2c 2065 7272  no=e.lineno, err
-00007440: 6f72 3d65 290a 2020 2020 2020 2020 2920  or=e).        ) 
-00007450: 6672 6f6d 204e 6f6e 650a 0a20 2020 2069  from None..    i
-00007460: 6620 6c65 6e28 646f 632e 6e6f 6465 7329  f len(doc.nodes)
-00007470: 203e 2031 3a0a 2020 2020 2020 2020 7261   > 1:.        ra
-00007480: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00007490: 227b 6669 6c65 6e61 6d65 7d3a 2064 6174  "{filename}: dat
-000074a0: 6173 6f75 7263 6573 2063 616e 2774 2068  asources can't h
-000074b0: 6176 6520 6d6f 7265 2074 6861 6e20 6f6e  ave more than on
-000074c0: 6520 6e6f 6465 2229 0a0a 2020 2020 7265  e node")..    re
-000074d0: 7475 726e 2064 6f63 0a0a 0a64 6566 2070  turn doc...def p
-000074e0: 6172 7365 5f70 6970 6528 0a20 2020 2066  arse_pipe(.    f
-000074f0: 696c 656e 616d 653a 2073 7472 2c20 7265  ilename: str, re
-00007500: 706c 6163 655f 696e 636c 7564 6573 3a20  place_includes: 
-00007510: 626f 6f6c 203d 2054 7275 652c 2063 6f6e  bool = True, con
-00007520: 7465 6e74 3a20 4f70 7469 6f6e 616c 5b73  tent: Optional[s
-00007530: 7472 5d20 3d20 4e6f 6e65 2c20 736b 6970  tr] = None, skip
-00007540: 5f65 7661 6c3a 2062 6f6f 6c20 3d20 4661  _eval: bool = Fa
-00007550: 6c73 650a 2920 2d3e 2044 6174 6166 696c  lse.) -> Datafil
-00007560: 653a 0a20 2020 2062 6173 6570 6174 6820  e:.    basepath 
-00007570: 3d20 2222 0a20 2020 2069 6620 6e6f 7420  = "".    if not 
-00007580: 636f 6e74 656e 743a 0a20 2020 2020 2020  content:.       
-00007590: 2077 6974 6820 6f70 656e 2866 696c 656e   with open(filen
-000075a0: 616d 6529 2061 7320 6669 6c65 3a0a 2020  ame) as file:.  
-000075b0: 2020 2020 2020 2020 2020 7320 3d20 6669            s = fi
-000075c0: 6c65 2e72 6561 6428 290a 2020 2020 2020  le.read().      
-000075d0: 2020 6261 7365 7061 7468 203d 206f 732e    basepath = os.
-000075e0: 7061 7468 2e64 6972 6e61 6d65 2866 696c  path.dirname(fil
-000075f0: 656e 616d 6529 0a20 2020 2065 6c73 653a  ename).    else:
-00007600: 0a20 2020 2020 2020 2073 203d 2063 6f6e  .        s = con
-00007610: 7465 6e74 0a0a 2020 2020 7472 793a 0a20  tent..    try:. 
-00007620: 2020 2020 2020 2073 716c 203d 2022 220a         sql = "".
-00007630: 2020 2020 2020 2020 646f 6320 3d20 7061          doc = pa
-00007640: 7273 6528 732c 2062 6173 6570 6174 683d  rse(s, basepath=
-00007650: 6261 7365 7061 7468 2c20 7265 706c 6163  basepath, replac
-00007660: 655f 696e 636c 7564 6573 3d72 6570 6c61  e_includes=repla
-00007670: 6365 5f69 6e63 6c75 6465 732c 2073 6b69  ce_includes, ski
-00007680: 705f 6576 616c 3d73 6b69 705f 6576 616c  p_eval=skip_eval
-00007690: 290a 2020 2020 2020 2020 666f 7220 6e6f  ).        for no
-000076a0: 6465 2069 6e20 646f 632e 6e6f 6465 733a  de in doc.nodes:
-000076b0: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
-000076c0: 203d 206e 6f64 652e 6765 7428 2273 716c   = node.get("sql
-000076d0: 222c 2022 2229 0a20 2020 2020 2020 2020  ", "").         
-000076e0: 2020 2069 6620 7371 6c2e 7374 7269 7028     if sql.strip(
-000076f0: 295b 305d 203d 3d20 2225 223a 0a20 2020  )[0] == "%":.   
-00007700: 2020 2020 2020 2020 2020 2020 2073 716c               sql
-00007710: 2c20 5f20 3d20 7265 6e64 6572 5f73 716c  , _ = render_sql
-00007720: 5f74 656d 706c 6174 6528 7371 6c5b 313a  _template(sql[1:
-00007730: 5d2c 2074 6573 745f 6d6f 6465 3d54 7275  ], test_mode=Tru
-00007740: 652c 206e 616d 653d 6e6f 6465 5b22 6e61  e, name=node["na
-00007750: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
-00007760: 2020 2320 6974 276c 6c20 6661 696c 2077    # it'll fail w
-00007770: 6974 6820 6120 4d6f 6475 6c65 4e6f 7446  ith a ModuleNotF
-00007780: 6f75 6e64 4572 726f 7220 7768 656e 2074  oundError when t
-00007790: 6865 2074 6f6f 6c73 6574 2069 7320 6e6f  he toolset is no
-000077a0: 7420 6176 6169 6c61 626c 6520 6275 7420  t available but 
-000077b0: 6974 2072 6574 7572 6e73 2074 6865 2070  it returns the p
-000077c0: 6172 7365 6420 646f 630a 2020 2020 2020  arsed doc.      
-000077d0: 2020 2020 2020 6672 6f6d 2074 696e 7962        from tinyb
-000077e0: 6972 642e 7371 6c5f 746f 6f6c 7365 7420  ird.sql_toolset 
-000077f0: 696d 706f 7274 2066 6f72 6d61 745f 7371  import format_sq
-00007800: 6c20 6173 2074 6f6f 6c73 6574 5f66 6f72  l as toolset_for
-00007810: 6d61 745f 7371 6c0a 0a20 2020 2020 2020  mat_sql..       
-00007820: 2020 2020 2074 6f6f 6c73 6574 5f66 6f72       toolset_for
-00007830: 6d61 745f 7371 6c28 7371 6c29 0a20 2020  mat_sql(sql).   
-00007840: 2065 7863 6570 7420 5061 7273 6545 7863   except ParseExc
-00007850: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00007860: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-00007870: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-00007880: 0a20 2020 2020 2020 2020 2020 2046 6565  .            Fee
-00007890: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-000078a0: 6f72 5f70 6172 7369 6e67 5f66 696c 6528  or_parsing_file(
-000078b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000078c0: 2066 696c 656e 616d 653d 6669 6c65 6e61   filename=filena
-000078d0: 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c 696e  me, lineno=e.lin
-000078e0: 656e 6f2c 2065 7272 6f72 3d66 227b 7374  eno, error=f"{st
-000078f0: 7228 6529 7d20 2b20 5351 4c28 7061 7273  r(e)} + SQL(pars
-00007900: 6520 6578 6365 7074 696f 6e29 3a20 7b73  e exception): {s
-00007910: 716c 7d22 0a20 2020 2020 2020 2020 2020  ql}".           
-00007920: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
-00007930: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-00007940: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-00007950: 2074 2c20 7465 6d70 6c61 7465 5f76 6172   t, template_var
-00007960: 6961 626c 6573 203d 2067 6574 5f74 656d  iables = get_tem
-00007970: 706c 6174 655f 616e 645f 7661 7269 6162  plate_and_variab
-00007980: 6c65 7328 7371 6c2c 206e 616d 653d 6e6f  les(sql, name=no
-00007990: 6465 5b22 6e61 6d65 225d 290a 0a20 2020  de["name"])..   
-000079a0: 2020 2020 2069 6620 7371 6c2e 7374 7269       if sql.stri
-000079b0: 7028 295b 305d 2021 3d20 2225 2220 616e  p()[0] != "%" an
-000079c0: 6420 6c65 6e28 7465 6d70 6c61 7465 5f76  d len(template_v
-000079d0: 6172 6961 626c 6573 2920 3e20 303a 0a20  ariables) > 0:. 
-000079e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000079f0: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-00007a00: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-00007a10: 6e61 6765 722e 6572 726f 725f 7465 6d70  nager.error_temp
-00007a20: 6c61 7465 5f73 7461 7274 2866 696c 656e  late_start(filen
-00007a30: 616d 653d 6669 6c65 6e61 6d65 2929 0a20  ame=filename)). 
-00007a40: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
-00007a50: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
-00007a60: 6e28 0a20 2020 2020 2020 2020 2020 2046  n(.            F
-00007a70: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
-00007a80: 7272 6f72 5f70 6172 7369 6e67 5f66 696c  rror_parsing_fil
-00007a90: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00007aa0: 2020 2066 696c 656e 616d 653d 6669 6c65     filename=file
-00007ab0: 6e61 6d65 2c20 6c69 6e65 6e6f 3d22 222c  name, lineno="",
-00007ac0: 2065 7272 6f72 3d66 227b 7374 7228 6529   error=f"{str(e)
-00007ad0: 7d20 2b20 5351 4c28 7661 6c75 6520 6572  } + SQL(value er
-00007ae0: 726f 7229 3a20 7b73 716c 7d22 0a20 2020  ror): {sql}".   
-00007af0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00007b00: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
-00007b10: 556e 436c 6f73 6564 4966 4572 726f 7220  UnClosedIfError 
-00007b20: 6173 2065 3a0a 2020 2020 2020 2020 7261  as e:.        ra
-00007b30: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-00007b40: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-00007b50: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-00007b60: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
-00007b70: 696e 675f 6e6f 6465 5f77 6974 685f 756e  ing_node_with_un
-00007b80: 636c 6f73 6564 5f69 6628 6e6f 6465 3d65  closed_if(node=e
-00007b90: 2e6e 6f64 652c 2070 6970 653d 6669 6c65  .node, pipe=file
-00007ba0: 6e61 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c  name, lineno=e.l
-00007bb0: 696e 656e 6f2c 2073 716c 3d65 2e73 716c  ineno, sql=e.sql
-00007bc0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00007bd0: 6578 6365 7074 204d 6f64 756c 654e 6f74  except ModuleNot
-00007be0: 466f 756e 6445 7272 6f72 3a0a 2020 2020  FoundError:.    
-00007bf0: 2020 2020 7061 7373 0a0a 2020 2020 7265      pass..    re
-00007c00: 7475 726e 2064 6f63 0a0a 0a64 6566 2070  turn doc...def p
-00007c10: 6172 7365 5f74 6f6b 656e 280a 2020 2020  arse_token(.    
-00007c20: 6669 6c65 6e61 6d65 3a20 7374 722c 2072  filename: str, r
-00007c30: 6570 6c61 6365 5f69 6e63 6c75 6465 733a  eplace_includes:
-00007c40: 2062 6f6f 6c20 3d20 5472 7565 2c20 636f   bool = True, co
-00007c50: 6e74 656e 743a 204f 7074 696f 6e61 6c5b  ntent: Optional[
-00007c60: 7374 725d 203d 204e 6f6e 652c 2073 6b69  str] = None, ski
-00007c70: 705f 6576 616c 3a20 626f 6f6c 203d 2046  p_eval: bool = F
-00007c80: 616c 7365 0a29 202d 3e20 4461 7461 6669  alse.) -> Datafi
-00007c90: 6c65 3a0a 2020 2020 6966 206e 6f74 2063  le:.    if not c
-00007ca0: 6f6e 7465 6e74 3a0a 2020 2020 2020 2020  ontent:.        
-00007cb0: 7769 7468 206f 7065 6e28 6669 6c65 6e61  with open(filena
-00007cc0: 6d65 2920 6173 2066 696c 653a 0a20 2020  me) as file:.   
-00007cd0: 2020 2020 2020 2020 2073 203d 2066 696c           s = fil
-00007ce0: 652e 7265 6164 2829 0a20 2020 2020 2020  e.read().       
-00007cf0: 2062 6173 6570 6174 6820 3d20 6f73 2e70   basepath = os.p
-00007d00: 6174 682e 6469 726e 616d 6528 6669 6c65  ath.dirname(file
-00007d10: 6e61 6d65 290a 2020 2020 656c 7365 3a0a  name).    else:.
-00007d20: 2020 2020 2020 2020 7320 3d20 636f 6e74          s = cont
-00007d30: 656e 740a 0a20 2020 2074 7279 3a0a 2020  ent..    try:.  
-00007d40: 2020 2020 2020 7371 6c20 3d20 2222 0a20        sql = "". 
-00007d50: 2020 2020 2020 2064 6f63 203d 2070 6172         doc = par
-00007d60: 7365 2873 2c20 6261 7365 7061 7468 3d62  se(s, basepath=b
-00007d70: 6173 6570 6174 682c 2072 6570 6c61 6365  asepath, replace
-00007d80: 5f69 6e63 6c75 6465 733d 7265 706c 6163  _includes=replac
-00007d90: 655f 696e 636c 7564 6573 2c20 736b 6970  e_includes, skip
-00007da0: 5f65 7661 6c3d 736b 6970 5f65 7661 6c29  _eval=skip_eval)
-00007db0: 0a20 2020 2065 7863 6570 7420 5061 7273  .    except Pars
-00007dc0: 6545 7863 6570 7469 6f6e 2061 7320 653a  eException as e:
-00007dd0: 0a20 2020 2020 2020 2072 6169 7365 2063  .        raise c
-00007de0: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
-00007df0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00007e00: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
-00007e10: 2e65 7272 6f72 5f70 6172 7369 6e67 5f66  .error_parsing_f
-00007e20: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
-00007e30: 2020 2020 2066 696c 656e 616d 653d 6669       filename=fi
-00007e40: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d65  lename, lineno=e
-00007e50: 2e6c 696e 656e 6f2c 2065 7272 6f72 3d66  .lineno, error=f
-00007e60: 227b 7374 7228 6529 7d20 2b20 5351 4c28  "{str(e)} + SQL(
-00007e70: 7061 7273 6520 6578 6365 7074 696f 6e29  parse exception)
-00007e80: 3a20 7b73 716c 7d22 0a20 2020 2020 2020  : {sql}".       
-00007e90: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
-00007ea0: 0a20 2020 2065 7863 6570 7420 5661 6c75  .    except Valu
-00007eb0: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
-00007ec0: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-00007ed0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-00007ee0: 0a20 2020 2020 2020 2020 2020 2046 6565  .            Fee
-00007ef0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-00007f00: 6f72 5f70 6172 7369 6e67 5f66 696c 6528  or_parsing_file(
-00007f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007f20: 2066 696c 656e 616d 653d 6669 6c65 6e61   filename=filena
-00007f30: 6d65 2c20 6c69 6e65 6e6f 3d22 222c 2065  me, lineno="", e
-00007f40: 7272 6f72 3d66 227b 7374 7228 6529 7d20  rror=f"{str(e)} 
-00007f50: 2b20 5351 4c28 7661 6c75 6520 6572 726f  + SQL(value erro
-00007f60: 7229 3a20 7b73 716c 7d22 0a20 2020 2020  r): {sql}".     
-00007f70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007f80: 2029 0a20 2020 2065 7863 6570 7420 556e   ).    except Un
-00007f90: 436c 6f73 6564 4966 4572 726f 7220 6173  ClosedIfError as
-00007fa0: 2065 3a0a 2020 2020 2020 2020 7261 6973   e:.        rais
-00007fb0: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-00007fc0: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-00007fd0: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
-00007fe0: 6765 722e 6572 726f 725f 7061 7273 696e  ger.error_parsin
-00007ff0: 675f 6e6f 6465 5f77 6974 685f 756e 636c  g_node_with_uncl
-00008000: 6f73 6564 5f69 6628 6e6f 6465 3d65 2e6e  osed_if(node=e.n
-00008010: 6f64 652c 2070 6970 653d 6669 6c65 6e61  ode, pipe=filena
-00008020: 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c 696e  me, lineno=e.lin
-00008030: 656e 6f2c 2073 716c 3d65 2e73 716c 290a  eno, sql=e.sql).
-00008040: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
-00008050: 6365 7074 204d 6f64 756c 654e 6f74 466f  cept ModuleNotFo
-00008060: 756e 6445 7272 6f72 3a0a 2020 2020 2020  undError:.      
-00008070: 2020 7061 7373 0a0a 2020 2020 7265 7475    pass..    retu
-00008080: 726e 2064 6f63 0a0a 0a64 6566 205f 756e  rn doc...def _un
-00008090: 7175 6f74 6528 783a 2073 7472 293a 0a20  quote(x: str):. 
-000080a0: 2020 2051 554f 5445 5320 3d20 2827 2227     QUOTES = ('"'
-000080b0: 2c20 2227 2229 0a20 2020 2069 6620 785b  , "'").    if x[
-000080c0: 305d 2069 6e20 5155 4f54 4553 2061 6e64  0] in QUOTES and
-000080d0: 2078 5b2d 315d 2069 6e20 5155 4f54 4553   x[-1] in QUOTES
-000080e0: 3a0a 2020 2020 2020 2020 7820 3d20 785b  :.        x = x[
-000080f0: 313a 2d31 5d0a 2020 2020 7265 7475 726e  1:-1].    return
-00008100: 2078 0a0a 0a64 6566 2065 7661 6c5f 7661   x...def eval_va
-00008110: 7228 733a 2073 7472 2c20 736b 6970 3a20  r(s: str, skip: 
-00008120: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-00008130: 2073 7472 3a0a 2020 2020 6966 2073 6b69   str:.    if ski
-00008140: 703a 0a20 2020 2020 2020 2072 6574 7572  p:.        retur
-00008150: 6e20 730a 2020 2020 2320 7265 706c 6163  n s.    # replac
-00008160: 6520 454e 5620 7661 7269 6162 6c65 730a  e ENV variables.
-00008170: 2020 2020 2320 6974 2773 2070 726f 6261      # it's proba
-00008180: 626c 7920 6120 6261 6420 6964 6561 2074  bly a bad idea t
-00008190: 6f20 616c 6c6f 7720 746f 2067 6574 2061  o allow to get a
-000081a0: 6e79 2065 6e76 2076 6172 0a20 2020 2072  ny env var.    r
-000081b0: 6574 7572 6e20 5465 6d70 6c61 7465 2873  eturn Template(s
-000081c0: 292e 7361 6665 5f73 7562 7374 6974 7574  ).safe_substitut
-000081d0: 6528 6f73 2e65 6e76 6972 6f6e 290a 0a0a  e(os.environ)...
-000081e0: 6465 6620 7061 7273 6528 0a20 2020 2073  def parse(.    s
-000081f0: 3a20 7374 722c 0a20 2020 2064 6566 6175  : str,.    defau
-00008200: 6c74 5f6e 6f64 653a 204f 7074 696f 6e61  lt_node: Optiona
-00008210: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00008220: 2020 2062 6173 6570 6174 683a 2073 7472     basepath: str
-00008230: 203d 2022 2e22 2c0a 2020 2020 7265 706c   = ".",.    repl
-00008240: 6163 655f 696e 636c 7564 6573 3a20 626f  ace_includes: bo
-00008250: 6f6c 203d 2054 7275 652c 0a20 2020 2073  ol = True,.    s
-00008260: 6b69 705f 6576 616c 3a20 626f 6f6c 203d  kip_eval: bool =
-00008270: 2046 616c 7365 2c0a 2920 2d3e 2044 6174   False,.) -> Dat
-00008280: 6166 696c 653a 2020 2320 6e6f 7161 3a20  afile:  # noqa: 
-00008290: 4339 3031 0a20 2020 2022 2222 0a20 2020  C901.    """.   
-000082a0: 2050 6172 7365 7320 6073 6020 7374 7269   Parses `s` stri
-000082b0: 6e67 2069 6e74 6f20 6120 646f 6375 6d65  ng into a docume
-000082c0: 6e74 0a20 2020 203e 3e3e 2064 203d 2070  nt.    >>> d = p
-000082d0: 6172 7365 2822 4652 4f4d 2053 4352 4154  arse("FROM SCRAT
-000082e0: 4348 5c5c 6e53 4f55 5243 4520 2768 7474  CH\\nSOURCE 'htt
-000082f0: 7073 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  ps://example.com
-00008300: 275c 5c6e 2374 6869 7320 6973 2061 2063  '\\n#this is a c
-00008310: 6f6d 6d65 6e74 5c5c 6e4d 4149 4e54 4149  omment\\nMAINTAI
-00008320: 4e45 5220 2772 616d 626f 2720 2374 6869  NER 'rambo' #thi
-00008330: 7320 6973 206d 655c 5c6e 4e4f 4445 205c  s is me\\nNODE \
-00008340: 5c22 7465 7374 5f30 315c 5c22 5c5c 6e20  \"test_01\\"\\n 
-00008350: 2020 2044 4553 4352 4950 5449 4f4e 2074     DESCRIPTION t
-00008360: 6869 7320 6973 2061 206e 6f64 6520 7468  his is a node th
-00008370: 6174 2064 6f65 7320 7768 6174 6576 6572  at does whatever
-00008380: 5c5c 6e53 514c 203e 5c5c 6e5c 5c6e 2020  \\nSQL >\\n\\n  
-00008390: 2020 2020 2020 5345 4c45 4354 202a 2066        SELECT * f
-000083a0: 726f 6d20 7465 7374 5f30 305c 5c6e 5c5c  rom test_00\\n\\
-000083b0: 6e5c 5c6e 4e4f 4445 205c 5c22 7465 7374  n\\nNODE \\"test
-000083c0: 5f30 325c 5c22 5c5c 6e20 2020 2044 4553  _02\\"\\n    DES
-000083d0: 4352 4950 5449 4f4e 2074 6869 7320 6973  CRIPTION this is
-000083e0: 2061 206e 6f64 6520 7468 6174 2064 6f65   a node that doe
-000083f0: 7320 7768 6174 6576 6572 5c5c 6e53 514c  s whatever\\nSQL
-00008400: 203e 5c5c 6e5c 5c6e 2020 2020 5345 4c45   >\\n\\n    SELE
-00008410: 4354 202a 2066 726f 6d20 7465 7374 5f30  CT * from test_0
-00008420: 315c 5c6e 2020 2020 5748 4552 4520 6120  1\\n    WHERE a 
-00008430: 3e20 315c 5c6e 2020 2020 4752 4f55 5020  > 1\\n    GROUP 
-00008440: 6279 2061 5c5c 6e22 290a 2020 2020 3e3e  by a\\n").    >>
-00008450: 3e20 642e 6d61 696e 7461 696e 6572 0a20  > d.maintainer. 
-00008460: 2020 2027 7261 6d62 6f27 0a20 2020 203e     'rambo'.    >
-00008470: 3e3e 2064 2e73 6f75 7263 6573 0a20 2020  >> d.sources.   
-00008480: 205b 2768 7474 7073 3a2f 2f65 7861 6d70   ['https://examp
-00008490: 6c65 2e63 6f6d 275d 0a20 2020 203e 3e3e  le.com'].    >>>
-000084a0: 206c 656e 2864 2e6e 6f64 6573 290a 2020   len(d.nodes).  
-000084b0: 2020 320a 2020 2020 3e3e 3e20 642e 6e6f    2.    >>> d.no
-000084c0: 6465 735b 305d 0a20 2020 207b 276e 616d  des[0].    {'nam
-000084d0: 6527 3a20 2774 6573 745f 3031 272c 2027  e': 'test_01', '
-000084e0: 6465 7363 7269 7074 696f 6e27 3a20 2774  description': 't
-000084f0: 6869 7320 6973 2061 206e 6f64 6520 7468  his is a node th
-00008500: 6174 2064 6f65 7320 7768 6174 6576 6572  at does whatever
-00008510: 272c 2027 7371 6c27 3a20 2753 454c 4543  ', 'sql': 'SELEC
-00008520: 5420 2a20 6672 6f6d 2074 6573 745f 3030  T * from test_00
-00008530: 277d 0a20 2020 203e 3e3e 2064 2e6e 6f64  '}.    >>> d.nod
-00008540: 6573 5b31 5d0a 2020 2020 7b27 6e61 6d65  es[1].    {'name
-00008550: 273a 2027 7465 7374 5f30 3227 2c20 2764  ': 'test_02', 'd
-00008560: 6573 6372 6970 7469 6f6e 273a 2027 7468  escription': 'th
-00008570: 6973 2069 7320 6120 6e6f 6465 2074 6861  is is a node tha
-00008580: 7420 646f 6573 2077 6861 7465 7665 7227  t does whatever'
-00008590: 2c20 2773 716c 273a 2027 5345 4c45 4354  , 'sql': 'SELECT
-000085a0: 202a 2066 726f 6d20 7465 7374 5f30 315c   * from test_01\
-000085b0: 5c6e 5748 4552 4520 6120 3e20 315c 5c6e  \nWHERE a > 1\\n
-000085c0: 4752 4f55 5020 6279 2061 277d 0a20 2020  GROUP by a'}.   
-000085d0: 2022 2222 0a20 2020 206c 696e 6573 203d   """.    lines =
-000085e0: 206c 6973 7428 5374 7269 6e67 494f 2873   list(StringIO(s
-000085f0: 2c20 6e65 776c 696e 653d 4e6f 6e65 2929  , newline=None))
-00008600: 0a0a 2020 2020 646f 6320 3d20 4461 7461  ..    doc = Data
-00008610: 6669 6c65 2829 0a20 2020 2064 6f63 2e72  file().    doc.r
-00008620: 6177 203d 206c 6973 7428 5374 7269 6e67  aw = list(String
-00008630: 494f 2873 2c20 6e65 776c 696e 653d 4e6f  IO(s, newline=No
-00008640: 6e65 2929 0a0a 2020 2020 7061 7273 6572  ne))..    parser
-00008650: 5f73 7461 7465 203d 206e 616d 6564 7475  _state = namedtu
-00008660: 706c 6528 2270 6172 7365 725f 7374 6174  ple("parser_stat
-00008670: 6522 2c20 5b22 6d75 6c74 696c 696e 6522  e", ["multiline"
-00008680: 2c20 2263 7572 7265 6e74 5f6e 6f64 6522  , "current_node"
-00008690: 2c20 2263 6f6d 6d61 6e64 222c 2022 6d75  , "command", "mu
-000086a0: 6c74 696c 696e 655f 7374 7269 6e67 222c  ltiline_string",
-000086b0: 2022 6973 5f73 716c 225d 290a 0a20 2020   "is_sql"])..   
-000086c0: 2070 6172 7365 725f 7374 6174 652e 6d75   parser_state.mu
-000086d0: 6c74 696c 696e 6520 3d20 4661 6c73 650a  ltiline = False.
-000086e0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
-000086f0: 2e63 7572 7265 6e74 5f6e 6f64 6520 3d20  .current_node = 
-00008700: 4661 6c73 650a 0a20 2020 2064 6566 2061  False..    def a
-00008710: 7373 6967 6e28 6174 7472 293a 0a20 2020  ssign(attr):.   
-00008720: 2020 2020 2064 6566 205f 666e 2878 2c20       def _fn(x, 
-00008730: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00008740: 2020 2020 2020 2073 6574 6174 7472 2864         setattr(d
-00008750: 6f63 2c20 6174 7472 2c20 5f75 6e71 756f  oc, attr, _unquo
-00008760: 7465 2878 2929 0a0a 2020 2020 2020 2020  te(x))..        
-00008770: 7265 7475 726e 205f 666e 0a0a 2020 2020  return _fn..    
-00008780: 6465 6620 7363 6865 6d61 282a 6172 6773  def schema(*args
-00008790: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000087a0: 2020 2020 2073 203d 205f 756e 7175 6f74       s = _unquot
-000087b0: 6528 2222 2e6a 6f69 6e28 6172 6773 2929  e("".join(args))
-000087c0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000087d0: 2020 2020 2020 2020 2020 7368 203d 2070            sh = p
-000087e0: 6172 7365 5f74 6162 6c65 5f73 7472 7563  arse_table_struc
-000087f0: 7475 7265 2873 290a 2020 2020 2020 2020  ture(s).        
-00008800: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00008810: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00008820: 2020 2072 6169 7365 2050 6172 7365 4578     raise ParseEx
-00008830: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
-00008840: 4d61 6e61 6765 722e 6572 726f 725f 7061  Manager.error_pa
-00008850: 7273 696e 675f 7363 6865 6d61 286c 696e  rsing_schema(lin
-00008860: 653d 6b77 6172 6773 5b22 6c69 6e65 6e6f  e=kwargs["lineno
-00008870: 225d 2c20 6572 726f 723d 6529 290a 0a20  "], error=e)).. 
-00008880: 2020 2020 2020 2070 6172 7365 725f 7374         parser_st
-00008890: 6174 652e 6375 7272 656e 745f 6e6f 6465  ate.current_node
-000088a0: 5b22 7363 6865 6d61 225d 203d 2022 2c22  ["schema"] = ","
-000088b0: 2e6a 6f69 6e28 7363 6865 6d61 5f74 6f5f  .join(schema_to_
-000088c0: 7371 6c5f 636f 6c75 6d6e 7328 7368 2929  sql_columns(sh))
-000088d0: 0a20 2020 2020 2020 2070 6172 7365 725f  .        parser_
-000088e0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
-000088f0: 6465 5b22 636f 6c75 6d6e 7322 5d20 3d20  de["columns"] = 
-00008900: 7368 0a0a 2020 2020 6465 6620 696e 6465  sh..    def inde
-00008910: 7865 7328 2a61 7267 732c 202a 2a6b 7761  xes(*args, **kwa
-00008920: 7267 7329 3a0a 2020 2020 2020 2020 7320  rgs):.        s 
-00008930: 3d20 5f75 6e71 756f 7465 2822 222e 6a6f  = _unquote("".jo
-00008940: 696e 2861 7267 7329 290a 2020 2020 2020  in(args)).      
-00008950: 2020 6966 206e 6f74 2073 3a0a 2020 2020    if not s:.    
-00008960: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00008970: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00008980: 2020 2020 2020 2020 696e 6465 7865 7320          indexes 
-00008990: 3d20 7061 7273 655f 696e 6465 7865 735f  = parse_indexes_
-000089a0: 7374 7275 6374 7572 6528 732e 7370 6c69  structure(s.spli
-000089b0: 746c 696e 6573 2829 290a 2020 2020 2020  tlines()).      
-000089c0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-000089d0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-000089e0: 2020 2020 2072 6169 7365 2050 6172 7365       raise Parse
-000089f0: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-00008a00: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-00008a10: 7061 7273 696e 675f 696e 6469 6365 7328  parsing_indices(
-00008a20: 6c69 6e65 3d6b 7761 7267 735b 226c 696e  line=kwargs["lin
-00008a30: 656e 6f22 5d2c 2065 7272 6f72 3d65 2929  eno"], error=e))
-00008a40: 0a0a 2020 2020 2020 2020 7061 7273 6572  ..        parser
-00008a50: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
-00008a60: 6f64 655b 2269 6e64 6578 6573 225d 203d  ode["indexes"] =
-00008a70: 2069 6e64 6578 6573 0a0a 2020 2020 6465   indexes..    de
-00008a80: 6620 6173 7369 676e 5f76 6172 2876 3a20  f assign_var(v: 
-00008a90: 7374 7229 202d 3e20 4361 6c6c 6162 6c65  str) -> Callable
-00008aa0: 5b5b 5661 7241 7267 2873 7472 292c 204b  [[VarArg(str), K
-00008ab0: 7741 7267 2841 6e79 295d 2c20 4e6f 6e65  wArg(Any)], None
-00008ac0: 5d3a 0a20 2020 2020 2020 2064 6566 205f  ]:.        def _
-00008ad0: 6628 2a61 7267 733a 2073 7472 2c20 2a2a  f(*args: str, **
-00008ae0: 6b77 6172 6773 3a20 416e 7929 3a0a 2020  kwargs: Any):.  
-00008af0: 2020 2020 2020 2020 2020 7320 3d20 5f75            s = _u
-00008b00: 6e71 756f 7465 2828 2220 222e 6a6f 696e  nquote((" ".join
-00008b10: 2861 7267 7329 292e 7374 7269 7028 2929  (args)).strip())
-00008b20: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00008b30: 7365 725f 7374 6174 652e 6375 7272 656e  ser_state.curren
-00008b40: 745f 6e6f 6465 5b76 2e6c 6f77 6572 2829  t_node[v.lower()
-00008b50: 5d20 3d20 6576 616c 5f76 6172 2873 2c20  ] = eval_var(s, 
-00008b60: 736b 6970 3d73 6b69 705f 6576 616c 290a  skip=skip_eval).
-00008b70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00008b80: 5f66 0a0a 2020 2020 6465 6620 736f 7572  _f..    def sour
-00008b90: 6365 7328 783a 2073 7472 2c20 2a2a 6b77  ces(x: str, **kw
-00008ba0: 6172 6773 3a20 416e 7929 202d 3e20 4e6f  args: Any) -> No
-00008bb0: 6e65 3a0a 2020 2020 2020 2020 646f 632e  ne:.        doc.
-00008bc0: 736f 7572 6365 732e 6170 7065 6e64 285f  sources.append(_
-00008bd0: 756e 7175 6f74 6528 7829 290a 0a20 2020  unquote(x))..   
-00008be0: 2064 6566 206e 6f64 6528 2a61 7267 733a   def node(*args:
-00008bf0: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
-00008c00: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
-00008c10: 2020 2020 2020 6e6f 6465 203d 207b 226e        node = {"n
-00008c20: 616d 6522 3a20 6576 616c 5f76 6172 285f  ame": eval_var(_
-00008c30: 756e 7175 6f74 6528 6172 6773 5b30 5d29  unquote(args[0])
-00008c40: 297d 0a20 2020 2020 2020 2064 6f63 2e6e  )}.        doc.n
-00008c50: 6f64 6573 2e61 7070 656e 6428 6e6f 6465  odes.append(node
-00008c60: 290a 2020 2020 2020 2020 7061 7273 6572  ).        parser
-00008c70: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
-00008c80: 6f64 6520 3d20 6e6f 6465 0a0a 2020 2020  ode = node..    
-00008c90: 6465 6620 7363 6f70 6528 2a61 7267 733a  def scope(*args:
-00008ca0: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
-00008cb0: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
-00008cc0: 2020 2020 2020 7363 6f70 6520 3d20 7b22        scope = {"
-00008cd0: 6e61 6d65 223a 2065 7661 6c5f 7661 7228  name": eval_var(
-00008ce0: 5f75 6e71 756f 7465 2861 7267 735b 305d  _unquote(args[0]
-00008cf0: 2929 7d0a 2020 2020 2020 2020 646f 632e  ))}.        doc.
-00008d00: 6e6f 6465 732e 6170 7065 6e64 2873 636f  nodes.append(sco
-00008d10: 7065 290a 2020 2020 2020 2020 7061 7273  pe).        pars
-00008d20: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
-00008d30: 5f6e 6f64 6520 3d20 7363 6f70 650a 0a20  _node = scope.. 
-00008d40: 2020 2064 6566 2064 6573 6372 6970 7469     def descripti
-00008d50: 6f6e 282a 6172 6773 3a20 7374 722c 202a  on(*args: str, *
-00008d60: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
-00008d70: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
-00008d80: 6573 6372 6970 7469 6f6e 203d 2028 2220  escription = (" 
-00008d90: 222e 6a6f 696e 2861 7267 7329 292e 7374  ".join(args)).st
-00008da0: 7269 7028 290a 0a20 2020 2020 2020 2069  rip()..        i
-00008db0: 6620 7061 7273 6572 5f73 7461 7465 2e63  f parser_state.c
-00008dc0: 7572 7265 6e74 5f6e 6f64 653a 0a20 2020  urrent_node:.   
-00008dd0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
-00008de0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
-00008df0: 6465 5b22 6465 7363 7269 7074 696f 6e22  de["description"
-00008e00: 5d20 3d20 6465 7363 7269 7074 696f 6e0a  ] = description.
-00008e10: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00008e20: 6172 7365 725f 7374 6174 652e 6375 7272  arser_state.curr
-00008e30: 656e 745f 6e6f 6465 2e67 6574 2822 6e61  ent_node.get("na
-00008e40: 6d65 222c 2022 2229 203d 3d20 2264 6566  me", "") == "def
-00008e50: 6175 6c74 223a 0a20 2020 2020 2020 2020  ault":.         
-00008e60: 2020 2020 2020 2064 6f63 2e64 6573 6372         doc.descr
-00008e70: 6970 7469 6f6e 203d 2064 6573 6372 6970  iption = descrip
-00008e80: 7469 6f6e 0a20 2020 2020 2020 2065 6c73  tion.        els
-00008e90: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
-00008ea0: 6f63 2e64 6573 6372 6970 7469 6f6e 203d  oc.description =
-00008eb0: 2064 6573 6372 6970 7469 6f6e 0a0a 2020   description..  
-00008ec0: 2020 6465 6620 7371 6c28 7661 725f 6e61    def sql(var_na
-00008ed0: 6d65 3a20 7374 722c 202a 2a6b 7761 7267  me: str, **kwarg
-00008ee0: 733a 2041 6e79 2920 2d3e 2043 616c 6c61  s: Any) -> Calla
-00008ef0: 626c 655b 5b73 7472 2c20 4b77 4172 6728  ble[[str, KwArg(
-00008f00: 416e 7929 5d2c 204e 6f6e 655d 3a0a 2020  Any)], None]:.  
-00008f10: 2020 2020 2020 6465 6620 5f66 2873 716c        def _f(sql
-00008f20: 3a20 7374 722c 202a 2a6b 7761 7267 733a  : str, **kwargs:
-00008f30: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
-00008f40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00008f50: 7420 7061 7273 6572 5f73 7461 7465 2e63  t parser_state.c
-00008f60: 7572 7265 6e74 5f6e 6f64 653a 0a20 2020  urrent_node:.   
-00008f70: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00008f80: 7365 2050 6172 7365 4578 6365 7074 696f  se ParseExceptio
-00008f90: 6e28 2253 514c 206d 7573 7420 6265 2063  n("SQL must be c
-00008fa0: 616c 6c65 6420 6166 7465 7220 6120 4e4f  alled after a NO
-00008fb0: 4445 2063 6f6d 6d61 6e64 2229 0a20 2020  DE command").   
-00008fc0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
-00008fd0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
-00008fe0: 6465 5b76 6172 5f6e 616d 655d 203d 2028  de[var_name] = (
-00008ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009000: 2074 6578 7477 7261 702e 6465 6465 6e74   textwrap.dedent
-00009010: 2873 716c 292e 7273 7472 6970 2829 2069  (sql).rstrip() i
-00009020: 6620 2225 2220 6e6f 7420 696e 2073 716c  f "%" not in sql
-00009030: 2e73 7472 6970 2829 5b30 5d20 656c 7365  .strip()[0] else
-00009040: 2073 716c 2e73 7472 6970 2829 0a20 2020   sql.strip().   
-00009050: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00009060: 2020 2020 2320 4841 434b 2074 6869 7320      # HACK this 
-00009070: 6361 7374 2069 7320 6e65 6564 6564 2062  cast is needed b
-00009080: 6563 6175 7365 204d 7970 790a 2020 2020  ecause Mypy.    
-00009090: 2020 2020 7265 7475 726e 2063 6173 7428      return cast(
-000090a0: 4361 6c6c 6162 6c65 5b5b 7374 722c 204b  Callable[[str, K
-000090b0: 7741 7267 2841 6e79 295d 2c20 4e6f 6e65  wArg(Any)], None
-000090c0: 5d2c 205f 6629 0a0a 2020 2020 6465 6620  ], _f)..    def 
-000090d0: 6173 7369 676e 5f6e 6f64 655f 7661 7228  assign_node_var(
-000090e0: 763a 2073 7472 2920 2d3e 2043 616c 6c61  v: str) -> Calla
-000090f0: 626c 655b 5b56 6172 4172 6728 7374 7229  ble[[VarArg(str)
-00009100: 2c20 4b77 4172 6728 416e 7929 5d2c 204e  , KwArg(Any)], N
-00009110: 6f6e 655d 3a0a 2020 2020 2020 2020 6465  one]:.        de
-00009120: 6620 5f66 282a 6172 6773 3a20 7374 722c  f _f(*args: str,
-00009130: 202a 2a6b 7761 7267 733a 2041 6e79 2920   **kwargs: Any) 
-00009140: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00009150: 2020 2020 2069 6620 6e6f 7420 7061 7273       if not pars
-00009160: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
-00009170: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
-00009180: 2020 2020 2020 2072 6169 7365 2050 6172         raise Par
-00009190: 7365 4578 6365 7074 696f 6e28 2225 7320  seException("%s 
-000091a0: 6d75 7374 2062 6520 6361 6c6c 6564 2061  must be called a
-000091b0: 6674 6572 2061 204e 4f44 4520 636f 6d6d  fter a NODE comm
-000091c0: 616e 6422 2025 2076 290a 2020 2020 2020  and" % v).      
-000091d0: 2020 2020 2020 7265 7475 726e 2061 7373        return ass
-000091e0: 6967 6e5f 7661 7228 7629 282a 6172 6773  ign_var(v)(*args
-000091f0: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-00009200: 2020 2020 2072 6574 7572 6e20 5f66 0a0a       return _f..
-00009210: 2020 2020 6465 6620 6164 645f 746f 6b65      def add_toke
-00009220: 6e28 2a61 7267 733a 2073 7472 2c20 2a2a  n(*args: str, **
-00009230: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-00009240: 4e6f 6e65 3a20 2023 2074 6f6b 656e 5f6e  None:  # token_n
-00009250: 616d 652c 2070 6572 6d69 7373 696f 6e73  ame, permissions
-00009260: 293a 0a20 2020 2020 2020 2069 6620 6c65  ):.        if le
-00009270: 6e28 6172 6773 2920 3c20 323a 0a20 2020  n(args) < 2:.   
-00009280: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
-00009290: 6172 7365 4578 6365 7074 696f 6e28 2754  arseException('T
-000092a0: 4f4b 454e 2067 6574 7320 7477 6f20 7061  OKEN gets two pa
-000092b0: 7261 6d73 2c20 746f 6b65 6e20 6e61 6d65  rams, token name
-000092c0: 2061 6e64 2070 6572 6d69 7373 696f 6e73   and permissions
-000092d0: 2065 2e67 2054 4f4b 454e 2022 7265 6164   e.g TOKEN "read
-000092e0: 2061 7069 2074 6f6b 656e 2220 5245 4144   api token" READ
-000092f0: 2729 0a20 2020 2020 2020 2064 6f63 2e74  ').        doc.t
-00009300: 6f6b 656e 732e 6170 7065 6e64 287b 2274  okens.append({"t
-00009310: 6f6b 656e 5f6e 616d 6522 3a20 5f75 6e71  oken_name": _unq
-00009320: 756f 7465 2861 7267 735b 305d 292c 2022  uote(args[0]), "
-00009330: 7065 726d 6973 7369 6f6e 7322 3a20 6172  permissions": ar
-00009340: 6773 5b31 5d7d 290a 0a20 2020 2064 6566  gs[1]})..    def
-00009350: 2061 6464 5f6b 6579 282a 6172 6773 3a20   add_key(*args: 
-00009360: 7374 722c 202a 2a6b 7761 7267 733a 2041  str, **kwargs: A
-00009370: 6e79 2920 2d3e 204e 6f6e 653a 2020 2320  ny) -> None:  # 
-00009380: 746f 6b65 6e5f 6e61 6d65 2c20 7065 726d  token_name, perm
-00009390: 6973 7369 6f6e 7329 3a0a 2020 2020 2020  issions):.      
-000093a0: 2020 6966 206c 656e 2861 7267 7329 203c    if len(args) <
-000093b0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-000093c0: 7261 6973 6520 5061 7273 6545 7863 6570  raise ParseExcep
-000093d0: 7469 6f6e 2822 4b45 5920 6765 7473 206f  tion("KEY gets o
-000093e0: 6e65 2070 6172 616d 7322 290a 2020 2020  ne params").    
-000093f0: 2020 2020 646f 632e 6b65 7973 2e61 7070      doc.keys.app
-00009400: 656e 6428 7b22 636f 6c75 6d6e 223a 205f  end({"column": _
-00009410: 756e 7175 6f74 6528 6172 6773 5b30 5d29  unquote(args[0])
-00009420: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-00009430: 282a 6172 6773 3a20 7374 722c 202a 2a6b  (*args: str, **k
-00009440: 7761 7267 733a 2041 6e79 2920 2d3e 204e  wargs: Any) -> N
-00009450: 6f6e 653a 0a20 2020 2020 2020 2070 7269  one:.        pri
-00009460: 6e74 2822 7465 7374 222c 2061 7267 732c  nt("test", args,
-00009470: 206b 7761 7267 7329 0a0a 2020 2020 6465   kwargs)..    de
-00009480: 6620 696e 636c 7564 6528 2a61 7267 733a  f include(*args:
-00009490: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
-000094a0: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
-000094b0: 2020 2020 2020 6620 3d20 5f75 6e71 756f        f = _unquo
-000094c0: 7465 2861 7267 735b 305d 290a 2020 2020  te(args[0]).    
-000094d0: 2020 2020 6620 3d20 6576 616c 5f76 6172      f = eval_var
-000094e0: 2866 290a 2020 2020 2020 2020 6174 7472  (f).        attr
-000094f0: 7320 3d20 6469 6374 285f 756e 7175 6f74  s = dict(_unquot
-00009500: 6528 7829 2e73 706c 6974 2822 3d22 2c20  e(x).split("=", 
-00009510: 3129 2066 6f72 2078 2069 6e20 6172 6773  1) for x in args
-00009520: 5b31 3a5d 290a 2020 2020 2020 2020 6e6f  [1:]).        no
-00009530: 6e6c 6f63 616c 206c 696e 6573 0a20 2020  nlocal lines.   
-00009540: 2020 2020 206c 696e 656e 6f20 3d20 6b77       lineno = kw
-00009550: 6172 6773 5b22 6c69 6e65 6e6f 225d 0a20  args["lineno"]. 
-00009560: 2020 2020 2020 2072 6570 6c61 6365 5f69         replace_i
-00009570: 6e63 6c75 6465 7320 3d20 6b77 6172 6773  ncludes = kwargs
-00009580: 5b22 7265 706c 6163 655f 696e 636c 7564  ["replace_includ
-00009590: 6573 225d 0a20 2020 2020 2020 206e 203d  es"].        n =
-000095a0: 206c 696e 656e 6f0a 2020 2020 2020 2020   lineno.        
-000095b0: 6172 6773 5f77 6974 685f 6174 7472 7320  args_with_attrs 
-000095c0: 3d20 2220 222e 6a6f 696e 2861 7267 7329  = " ".join(args)
-000095d0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-000095e0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-000095f0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-00009600: 2020 2020 2020 206e 202b 3d20 310a 2020         n += 1.  
-00009610: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00009620: 206c 656e 286c 696e 6573 2920 3c3d 206e   len(lines) <= n
-00009630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009640: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00009650: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-00009660: 4e4f 4445 2220 696e 206c 696e 6573 5b6e  NODE" in lines[n
-00009670: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00009680: 2020 2020 2020 2064 6f63 2e69 6e63 6c75         doc.inclu
-00009690: 6465 735b 6172 6773 5f77 6974 685f 6174  des[args_with_at
-000096a0: 7472 735d 203d 206c 696e 6573 5b6e 5d0a  trs] = lines[n].
-000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096c0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-000096d0: 2020 2020 2020 6966 2061 7267 735f 7769        if args_wi
-000096e0: 7468 5f61 7474 7273 206e 6f74 2069 6e20  th_attrs not in 
-000096f0: 646f 632e 696e 636c 7564 6573 3a0a 2020  doc.includes:.  
-00009700: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00009710: 632e 696e 636c 7564 6573 5b61 7267 735f  c.includes[args_
-00009720: 7769 7468 5f61 7474 7273 5d20 3d20 2222  with_attrs] = ""
-00009730: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00009740: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00009750: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00009760: 2020 2020 2023 2049 6620 7468 6973 2070       # If this p
-00009770: 6172 7365 2077 6173 2074 7269 6767 6572  arse was trigger
-00009780: 6564 2062 7920 666f 726d 6174 2c20 7765  ed by format, we
-00009790: 2064 6f6e 2774 2077 616e 7420 746f 2072   don't want to r
-000097a0: 6570 6c61 6365 2074 6865 2066 696c 650a  eplace the file.
-000097b0: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
-000097c0: 6570 6c61 6365 5f69 6e63 6c75 6465 733a  eplace_includes:
-000097d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000097e0: 7572 6e0a 0a20 2020 2020 2020 2023 2062  urn..        # b
-000097f0: 6520 7375 7265 2074 6f20 7265 706c 6163  e sure to replac
-00009800: 6520 7468 6520 696e 636c 7564 6520 6c69  e the include li
-00009810: 6e65 0a20 2020 2020 2020 2070 203d 2050  ne.        p = P
-00009820: 6174 6828 6261 7365 7061 7468 290a 0a20  ath(basepath).. 
-00009830: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00009840: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
-00009850: 6e28 7020 2f20 6629 2061 7320 6669 6c65  n(p / f) as file
-00009860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009870: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00009880: 2020 2020 2020 2020 2020 206c 6c20 3d20             ll = 
-00009890: 6c69 7374 2853 7472 696e 6749 4f28 6669  list(StringIO(fi
-000098a0: 6c65 2e72 6561 6428 292c 206e 6577 6c69  le.read(), newli
-000098b0: 6e65 3d4e 6f6e 6529 290a 2020 2020 2020  ne=None)).      
-000098c0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-000098d0: 6465 5f6c 696e 6520 3d20 5b6c 696e 6520  de_line = [line 
-000098e0: 666f 7220 6c69 6e65 2069 6e20 6c6c 2069  for line in ll i
-000098f0: 6620 224e 4f44 4522 2069 6e20 6c69 6e65  f "NODE" in line
-00009900: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00009910: 2020 2020 2020 6966 206e 6f64 655f 6c69        if node_li
-00009920: 6e65 2061 6e64 2064 6f63 2e69 6e63 6c75  ne and doc.inclu
-00009930: 6465 735b 6172 6773 5f77 6974 685f 6174  des[args_with_at
-00009940: 7472 735d 3a0a 2020 2020 2020 2020 2020  trs]:.          
-00009950: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00009960: 632e 696e 636c 7564 6573 5b6e 6f64 655f  c.includes[node_
-00009970: 6c69 6e65 5b30 5d2e 7370 6c69 7428 224e  line[0].split("N
-00009980: 4f44 4522 295b 2d31 5d2e 7370 6c69 7428  ODE")[-1].split(
-00009990: 225c 6e22 295b 305d 2e73 7472 6970 2829  "\n")[0].strip()
-000099a0: 5d20 3d20 2222 0a20 2020 2020 2020 2020  ] = "".         
-000099b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-000099c0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-000099d0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-000099e0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000099f0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-00009a00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009a10: 696c 652e 7365 656b 2830 290a 2020 2020  ile.seek(0).    
-00009a20: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-00009a30: 735b 6c69 6e65 6e6f 203a 206c 696e 656e  s[lineno : linen
-00009a40: 6f20 2b20 315d 203d 205b 2222 5d20 2b20  o + 1] = [""] + 
-00009a50: 6c69 7374 280a 2020 2020 2020 2020 2020  list(.          
-00009a60: 2020 2020 2020 2020 2020 5374 7269 6e67            String
-00009a70: 494f 2854 656d 706c 6174 6528 6669 6c65  IO(Template(file
-00009a80: 2e72 6561 6428 2929 2e73 6166 655f 7375  .read()).safe_su
-00009a90: 6273 7469 7475 7465 2861 7474 7273 292c  bstitute(attrs),
-00009aa0: 206e 6577 6c69 6e65 3d4e 6f6e 6529 0a20   newline=None). 
-00009ab0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00009ac0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00009ad0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00009ae0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00009af0: 6169 7365 2049 6e63 6c75 6465 4669 6c65  aise IncludeFile
-00009b00: 4e6f 7446 6f75 6e64 4578 6365 7074 696f  NotFoundExceptio
-00009b10: 6e28 6629 0a0a 2020 2020 6465 6620 7665  n(f)..    def ve
-00009b20: 7273 696f 6e28 2a61 7267 733a 2073 7472  rsion(*args: str
-00009b30: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
-00009b40: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00009b50: 2020 6966 206c 656e 2861 7267 7329 203c    if len(args) <
-00009b60: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00009b70: 7261 6973 6520 5061 7273 6545 7863 6570  raise ParseExcep
-00009b80: 7469 6f6e 2822 5645 5253 494f 4e20 6765  tion("VERSION ge
-00009b90: 7473 206f 6e65 2070 6f73 6974 6976 6520  ts one positive 
-00009ba0: 696e 7465 6765 7220 7061 7261 6d22 290a  integer param").
-00009bb0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00009bc0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
-00009bd0: 203d 2069 6e74 2861 7267 735b 305d 290a   = int(args[0]).
-00009be0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-00009bf0: 6572 7369 6f6e 203c 2030 3a0a 2020 2020  ersion < 0:.    
-00009c00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00009c10: 6520 5661 6c69 6461 7469 6f6e 4578 6365  e ValidationExce
-00009c20: 7074 696f 6e28 2276 6572 7369 6f6e 206d  ption("version m
-00009c30: 7573 7420 6265 2061 2070 6f73 6974 6976  ust be a positiv
-00009c40: 6520 696e 7465 6765 7220 652e 6720 5645  e integer e.g VE
-00009c50: 5253 494f 4e20 3222 290a 2020 2020 2020  RSION 2").      
-00009c60: 2020 2020 2020 646f 632e 7665 7273 696f        doc.versio
-00009c70: 6e20 3d20 7665 7273 696f 6e0a 2020 2020  n = version.    
-00009c80: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-00009c90: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00009ca0: 2020 2072 6169 7365 2056 616c 6964 6174     raise Validat
-00009cb0: 696f 6e45 7863 6570 7469 6f6e 2822 7665  ionException("ve
-00009cc0: 7273 696f 6e20 6d75 7374 2062 6520 6120  rsion must be a 
-00009cd0: 706f 7369 7469 7665 2069 6e74 6567 6572  positive integer
-00009ce0: 2065 2e67 2056 4552 5349 4f4e 2032 2229   e.g VERSION 2")
-00009cf0: 0a0a 2020 2020 6465 6620 7368 6172 6564  ..    def shared
-00009d00: 5f77 6974 6828 2a61 7267 733a 2073 7472  _with(*args: str
-00009d10: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
-00009d20: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00009d30: 2020 666f 7220 656e 7472 6965 7320 696e    for entries in
-00009d40: 2061 7267 733a 0a20 2020 2020 2020 2020   args:.         
-00009d50: 2020 2023 2049 6e20 6361 7365 2074 6865     # In case the
-00009d60: 7920 7370 6563 6966 7920 6d75 6c74 6970  y specify multip
-00009d70: 6c65 2077 6f72 6b73 7061 6365 730a 2020  le workspaces.  
-00009d80: 2020 2020 2020 2020 2020 646f 632e 7368            doc.sh
-00009d90: 6172 6564 5f77 6974 6820 2b3d 205b 776f  ared_with += [wo
-00009da0: 726b 7370 6163 652e 7374 7269 7028 2920  rkspace.strip() 
-00009db0: 666f 7220 776f 726b 7370 6163 6520 696e  for workspace in
-00009dc0: 2065 6e74 7269 6573 2e73 706c 6974 6c69   entries.splitli
-00009dd0: 6e65 7328 295d 0a0a 2020 2020 6465 6620  nes()]..    def 
-00009de0: 5f5f 696e 6974 5f65 6e67 696e 6528 763a  __init_engine(v:
-00009df0: 2073 7472 293a 0a20 2020 2020 2020 2069   str):.        i
-00009e00: 6620 6e6f 7420 7061 7273 6572 5f73 7461  f not parser_sta
-00009e10: 7465 2e63 7572 7265 6e74 5f6e 6f64 653a  te.current_node:
-00009e20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00009e30: 7365 2045 7863 6570 7469 6f6e 2866 227b  se Exception(f"{
-00009e40: 767d 206d 7573 7420 6265 2063 616c 6c65  v} must be calle
-00009e50: 6420 6166 7465 7220 6120 4e4f 4445 2063  d after a NODE c
-00009e60: 6f6d 6d61 6e64 2229 0a20 2020 2020 2020  ommand").       
-00009e70: 2069 6620 2265 6e67 696e 6522 206e 6f74   if "engine" not
-00009e80: 2069 6e20 7061 7273 6572 5f73 7461 7465   in parser_state
-00009e90: 2e63 7572 7265 6e74 5f6e 6f64 653a 0a20  .current_node:. 
-00009ea0: 2020 2020 2020 2020 2020 2070 6172 7365             parse
-00009eb0: 725f 7374 6174 652e 6375 7272 656e 745f  r_state.current_
-00009ec0: 6e6f 6465 5b22 656e 6769 6e65 225d 203d  node["engine"] =
-00009ed0: 207b 2274 7970 6522 3a20 4e6f 6e65 2c20   {"type": None, 
-00009ee0: 2261 7267 7322 3a20 5b5d 7d0a 0a20 2020  "args": []}..   
-00009ef0: 2064 6566 2073 6574 5f65 6e67 696e 6528   def set_engine(
-00009f00: 2a61 7267 733a 2073 7472 2c20 2a2a 6b77  *args: str, **kw
-00009f10: 6172 6773 3a20 416e 7929 202d 3e20 4e6f  args: Any) -> No
-00009f20: 6e65 3a0a 2020 2020 2020 2020 5f5f 696e  ne:.        __in
-00009f30: 6974 5f65 6e67 696e 6528 2245 4e47 494e  it_engine("ENGIN
-00009f40: 4522 290a 2020 2020 2020 2020 656e 6769  E").        engi
-00009f50: 6e65 5f74 7970 6520 3d20 5f75 6e71 756f  ne_type = _unquo
-00009f60: 7465 2828 2220 222e 6a6f 696e 2861 7267  te((" ".join(arg
-00009f70: 7329 292e 7374 7269 7028 2929 0a20 2020  s)).strip()).   
-00009f80: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
-00009f90: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
-00009fa0: 656e 6769 6e65 225d 5b22 7479 7065 225d  engine"]["type"]
-00009fb0: 203d 2065 7661 6c5f 7661 7228 656e 6769   = eval_var(engi
-00009fc0: 6e65 5f74 7970 652c 2073 6b69 703d 736b  ne_type, skip=sk
-00009fd0: 6970 5f65 7661 6c29 0a0a 2020 2020 6465  ip_eval)..    de
-00009fe0: 6620 6164 645f 656e 6769 6e65 5f76 6172  f add_engine_var
-00009ff0: 2876 3a20 7374 7229 202d 3e20 4361 6c6c  (v: str) -> Call
-0000a000: 6162 6c65 5b5b 5661 7241 7267 2873 7472  able[[VarArg(str
-0000a010: 292c 204b 7741 7267 2841 6e79 295d 2c20  ), KwArg(Any)], 
-0000a020: 4e6f 6e65 5d3a 0a20 2020 2020 2020 2064  None]:.        d
-0000a030: 6566 205f 6628 2a61 7267 733a 2073 7472  ef _f(*args: str
-0000a040: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
-0000a050: 3a0a 2020 2020 2020 2020 2020 2020 5f5f  :.            __
-0000a060: 696e 6974 5f65 6e67 696e 6528 6622 454e  init_engine(f"EN
-0000a070: 4749 4e45 5f7b 767d 222e 7570 7065 7228  GINE_{v}".upper(
-0000a080: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-0000a090: 6e67 696e 655f 6172 6720 3d20 6576 616c  ngine_arg = eval
-0000a0a0: 5f76 6172 285f 756e 7175 6f74 6528 2822  _var(_unquote(("
-0000a0b0: 2022 2e6a 6f69 6e28 6172 6773 2929 2e73   ".join(args)).s
-0000a0c0: 7472 6970 2829 292c 2073 6b69 703d 736b  trip()), skip=sk
-0000a0d0: 6970 5f65 7661 6c29 0a20 2020 2020 2020  ip_eval).       
-0000a0e0: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
-0000a0f0: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
-0000a100: 656e 6769 6e65 225d 5b22 6172 6773 225d  engine"]["args"]
-0000a110: 2e61 7070 656e 6428 2876 2c20 656e 6769  .append((v, engi
-0000a120: 6e65 5f61 7267 2929 0a0a 2020 2020 2020  ne_arg))..      
-0000a130: 2020 7265 7475 726e 205f 660a 0a20 2020    return _f..   
-0000a140: 2063 6d64 7320 3d20 7b0a 2020 2020 2020   cmds = {.      
-0000a150: 2020 2266 726f 6d22 3a20 6173 7369 676e    "from": assign
-0000a160: 2822 6672 6f6d 2229 2c0a 2020 2020 2020  ("from"),.      
-0000a170: 2020 2273 6f75 7263 6522 3a20 736f 7572    "source": sour
-0000a180: 6365 732c 0a20 2020 2020 2020 2022 6d61  ces,.        "ma
-0000a190: 696e 7461 696e 6572 223a 2061 7373 6967  intainer": assig
-0000a1a0: 6e28 226d 6169 6e74 6169 6e65 7222 292c  n("maintainer"),
-0000a1b0: 0a20 2020 2020 2020 2022 7363 6865 6d61  .        "schema
-0000a1c0: 223a 2073 6368 656d 612c 0a20 2020 2020  ": schema,.     
-0000a1d0: 2020 2022 696e 6465 7865 7322 3a20 696e     "indexes": in
-0000a1e0: 6465 7865 732c 0a20 2020 2020 2020 2023  dexes,.        #
-0000a1f0: 2054 4f44 4f3a 2041 6464 6564 2074 6f20   TODO: Added to 
-0000a200: 6265 2061 626c 6520 746f 206d 6572 6765  be able to merge
-0000a210: 204d 5220 3131 3334 372c 206c 6574 2773   MR 11347, let's
-0000a220: 2072 656d 6f76 6520 6974 2061 6674 6572   remove it after
-0000a230: 7761 7264 730a 2020 2020 2020 2020 2269  wards.        "i
-0000a240: 6e64 6963 6573 223a 2069 6e64 6578 6573  ndices": indexes
-0000a250: 2c0a 2020 2020 2020 2020 2265 6e67 696e  ,.        "engin
-0000a260: 6522 3a20 7365 745f 656e 6769 6e65 2c0a  e": set_engine,.
-0000a270: 2020 2020 2020 2020 2270 6172 7469 7469          "partiti
-0000a280: 6f6e 5f6b 6579 223a 2061 7373 6967 6e5f  on_key": assign_
-0000a290: 7661 7228 2270 6172 7469 7469 6f6e 5f6b  var("partition_k
-0000a2a0: 6579 2229 2c0a 2020 2020 2020 2020 2273  ey"),.        "s
-0000a2b0: 6f72 7469 6e67 5f6b 6579 223a 2061 7373  orting_key": ass
-0000a2c0: 6967 6e5f 7661 7228 2273 6f72 7469 6e67  ign_var("sorting
-0000a2d0: 5f6b 6579 2229 2c0a 2020 2020 2020 2020  _key"),.        
-0000a2e0: 2270 7269 6d61 7279 5f6b 6579 223a 2061  "primary_key": a
-0000a2f0: 7373 6967 6e5f 7661 7228 2270 7269 6d61  ssign_var("prima
-0000a300: 7279 5f6b 6579 2229 2c0a 2020 2020 2020  ry_key"),.      
-0000a310: 2020 2273 616d 706c 696e 675f 6b65 7922    "sampling_key"
-0000a320: 3a20 6173 7369 676e 5f76 6172 2822 7361  : assign_var("sa
-0000a330: 6d70 6c69 6e67 5f6b 6579 2229 2c0a 2020  mpling_key"),.  
-0000a340: 2020 2020 2020 2274 746c 223a 2061 7373        "ttl": ass
-0000a350: 6967 6e5f 7661 7228 2274 746c 2229 2c0a  ign_var("ttl"),.
-0000a360: 2020 2020 2020 2020 2273 6574 7469 6e67          "setting
-0000a370: 7322 3a20 6173 7369 676e 5f76 6172 2822  s": assign_var("
-0000a380: 7365 7474 696e 6773 2229 2c0a 2020 2020  settings"),.    
-0000a390: 2020 2020 226e 6f64 6522 3a20 6e6f 6465      "node": node
-0000a3a0: 2c0a 2020 2020 2020 2020 2273 636f 7065  ,.        "scope
-0000a3b0: 223a 2073 636f 7065 2c0a 2020 2020 2020  ": scope,.      
-0000a3c0: 2020 2264 6573 6372 6970 7469 6f6e 223a    "description":
-0000a3d0: 2064 6573 6372 6970 7469 6f6e 2c0a 2020   description,.  
-0000a3e0: 2020 2020 2020 2274 7970 6522 3a20 6173        "type": as
-0000a3f0: 7369 676e 5f6e 6f64 655f 7661 7228 2274  sign_node_var("t
-0000a400: 7970 6522 292c 0a20 2020 2020 2020 2022  ype"),.        "
-0000a410: 6461 7461 736f 7572 6365 223a 2061 7373  datasource": ass
-0000a420: 6967 6e5f 6e6f 6465 5f76 6172 2822 6461  ign_node_var("da
-0000a430: 7461 736f 7572 6365 2229 2c0a 2020 2020  tasource"),.    
-0000a440: 2020 2020 2274 6167 7322 3a20 6173 7369      "tags": assi
-0000a450: 676e 5f6e 6f64 655f 7661 7228 2274 6167  gn_node_var("tag
-0000a460: 7322 292c 0a20 2020 2020 2020 2022 7461  s"),.        "ta
-0000a470: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
-0000a480: 3a20 6173 7369 676e 5f6e 6f64 655f 7661  : assign_node_va
-0000a490: 7228 2274 6172 6765 745f 6461 7461 736f  r("target_dataso
-0000a4a0: 7572 6365 2229 2c0a 2020 2020 2020 2020  urce"),.        
-0000a4b0: 2263 6f70 795f 7363 6865 6475 6c65 223a  "copy_schedule":
-0000a4c0: 2061 7373 6967 6e5f 6e6f 6465 5f76 6172   assign_node_var
-0000a4d0: 2843 6f70 7950 6172 616d 6574 6572 732e  (CopyParameters.
-0000a4e0: 434f 5059 5f53 4348 4544 554c 4529 2c0a  COPY_SCHEDULE),.
-0000a4f0: 2020 2020 2020 2020 2272 6573 6f75 7263          "resourc
-0000a500: 6522 3a20 6173 7369 676e 5f6e 6f64 655f  e": assign_node_
-0000a510: 7661 7228 2272 6573 6f75 7263 6522 292c  var("resource"),
-0000a520: 0a20 2020 2020 2020 2022 6669 6c74 6572  .        "filter
-0000a530: 223a 2061 7373 6967 6e5f 6e6f 6465 5f76  ": assign_node_v
-0000a540: 6172 2822 6669 6c74 6572 2229 2c0a 2020  ar("filter"),.  
-0000a550: 2020 2020 2020 2274 6f6b 656e 223a 2061        "token": a
-0000a560: 6464 5f74 6f6b 656e 2c0a 2020 2020 2020  dd_token,.      
-0000a570: 2020 226b 6579 223a 2061 6464 5f6b 6579    "key": add_key
-0000a580: 2c0a 2020 2020 2020 2020 2274 6573 7422  ,.        "test"
-0000a590: 3a20 7465 7374 2c0a 2020 2020 2020 2020  : test,.        
-0000a5a0: 2269 6e63 6c75 6465 223a 2069 6e63 6c75  "include": inclu
-0000a5b0: 6465 2c0a 2020 2020 2020 2020 2273 716c  de,.        "sql
-0000a5c0: 223a 2073 716c 2822 7371 6c22 292c 0a20  ": sql("sql"),. 
-0000a5d0: 2020 2020 2020 2022 7665 7273 696f 6e22         "version"
-0000a5e0: 3a20 7665 7273 696f 6e2c 0a20 2020 2020  : version,.     
-0000a5f0: 2020 2022 6b61 666b 615f 636f 6e6e 6563     "kafka_connec
-0000a600: 7469 6f6e 5f6e 616d 6522 3a20 6173 7369  tion_name": assi
-0000a610: 676e 5f76 6172 2822 6b61 666b 615f 636f  gn_var("kafka_co
-0000a620: 6e6e 6563 7469 6f6e 5f6e 616d 6522 292c  nnection_name"),
-0000a630: 0a20 2020 2020 2020 2022 6b61 666b 615f  .        "kafka_
-0000a640: 746f 7069 6322 3a20 6173 7369 676e 5f76  topic": assign_v
-0000a650: 6172 2822 6b61 666b 615f 746f 7069 6322  ar("kafka_topic"
-0000a660: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
-0000a670: 615f 6772 6f75 705f 6964 223a 2061 7373  a_group_id": ass
-0000a680: 6967 6e5f 7661 7228 226b 6166 6b61 5f67  ign_var("kafka_g
-0000a690: 726f 7570 5f69 6422 292c 0a20 2020 2020  roup_id"),.     
-0000a6a0: 2020 2022 6b61 666b 615f 626f 6f74 7374     "kafka_bootst
-0000a6b0: 7261 705f 7365 7276 6572 7322 3a20 6173  rap_servers": as
-0000a6c0: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
-0000a6d0: 626f 6f74 7374 7261 705f 7365 7276 6572  bootstrap_server
-0000a6e0: 7322 292c 0a20 2020 2020 2020 2022 6b61  s"),.        "ka
-0000a6f0: 666b 615f 6b65 7922 3a20 6173 7369 676e  fka_key": assign
-0000a700: 5f76 6172 2822 6b61 666b 615f 6b65 7922  _var("kafka_key"
-0000a710: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
-0000a720: 615f 7365 6372 6574 223a 2061 7373 6967  a_secret": assig
-0000a730: 6e5f 7661 7228 226b 6166 6b61 5f73 6563  n_var("kafka_sec
-0000a740: 7265 7422 292c 0a20 2020 2020 2020 2022  ret"),.        "
-0000a750: 6b61 666b 615f 7363 6865 6d61 5f72 6567  kafka_schema_reg
-0000a760: 6973 7472 795f 7572 6c22 3a20 6173 7369  istry_url": assi
-0000a770: 676e 5f76 6172 2822 6b61 666b 615f 7363  gn_var("kafka_sc
-0000a780: 6865 6d61 5f72 6567 6973 7472 795f 7572  hema_registry_ur
-0000a790: 6c22 292c 0a20 2020 2020 2020 2022 6b61  l"),.        "ka
-0000a7a0: 666b 615f 7461 7267 6574 5f70 6172 7469  fka_target_parti
-0000a7b0: 7469 6f6e 7322 3a20 6173 7369 676e 5f76  tions": assign_v
-0000a7c0: 6172 2822 6b61 666b 615f 7461 7267 6574  ar("kafka_target
-0000a7d0: 5f70 6172 7469 7469 6f6e 7322 292c 0a20  _partitions"),. 
-0000a7e0: 2020 2020 2020 2022 6b61 666b 615f 6175         "kafka_au
-0000a7f0: 746f 5f6f 6666 7365 745f 7265 7365 7422  to_offset_reset"
-0000a800: 3a20 6173 7369 676e 5f76 6172 2822 6b61  : assign_var("ka
-0000a810: 666b 615f 6175 746f 5f6f 6666 7365 745f  fka_auto_offset_
-0000a820: 7265 7365 7422 292c 0a20 2020 2020 2020  reset"),.       
-0000a830: 2022 6b61 666b 615f 7374 6f72 655f 7261   "kafka_store_ra
-0000a840: 775f 7661 6c75 6522 3a20 6173 7369 676e  w_value": assign
-0000a850: 5f76 6172 2822 6b61 666b 615f 7374 6f72  _var("kafka_stor
-0000a860: 655f 7261 775f 7661 6c75 6522 292c 0a20  e_raw_value"),. 
-0000a870: 2020 2020 2020 2022 6b61 666b 615f 7374         "kafka_st
-0000a880: 6f72 655f 6865 6164 6572 7322 3a20 6173  ore_headers": as
-0000a890: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
-0000a8a0: 7374 6f72 655f 6865 6164 6572 7322 292c  store_headers"),
-0000a8b0: 0a20 2020 2020 2020 2022 6b61 666b 615f  .        "kafka_
-0000a8c0: 6b65 795f 6176 726f 5f64 6573 6572 6961  key_avro_deseria
-0000a8d0: 6c69 7a61 7469 6f6e 223a 2061 7373 6967  lization": assig
-0000a8e0: 6e5f 7661 7228 226b 6166 6b61 5f6b 6579  n_var("kafka_key
-0000a8f0: 5f61 7672 6f5f 6465 7365 7269 616c 697a  _avro_deserializ
-0000a900: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
-0000a910: 2022 696d 706f 7274 5f73 6572 7669 6365   "import_service
-0000a920: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
-0000a930: 6d70 6f72 745f 7365 7276 6963 6522 292c  mport_service"),
-0000a940: 0a20 2020 2020 2020 2022 696d 706f 7274  .        "import
-0000a950: 5f63 6f6e 6e65 6374 696f 6e5f 6e61 6d65  _connection_name
-0000a960: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
-0000a970: 6d70 6f72 745f 636f 6e6e 6563 7469 6f6e  mport_connection
-0000a980: 5f6e 616d 6522 292c 0a20 2020 2020 2020  _name"),.       
-0000a990: 2022 696d 706f 7274 5f73 6368 6564 756c   "import_schedul
-0000a9a0: 6522 3a20 6173 7369 676e 5f76 6172 2822  e": assign_var("
-0000a9b0: 696d 706f 7274 5f73 6368 6564 756c 6522  import_schedule"
-0000a9c0: 292c 0a20 2020 2020 2020 2022 696d 706f  ),.        "impo
-0000a9d0: 7274 5f73 7472 6174 6567 7922 3a20 6173  rt_strategy": as
-0000a9e0: 7369 676e 5f76 6172 2822 696d 706f 7274  sign_var("import
-0000a9f0: 5f73 7472 6174 6567 7922 292c 0a20 2020  _strategy"),.   
-0000aa00: 2020 2020 2022 696d 706f 7274 5f65 7874       "import_ext
-0000aa10: 6572 6e61 6c5f 6461 7461 736f 7572 6365  ernal_datasource
-0000aa20: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
-0000aa30: 6d70 6f72 745f 6578 7465 726e 616c 5f64  mport_external_d
-0000aa40: 6174 6173 6f75 7263 6522 292c 0a20 2020  atasource"),.   
-0000aa50: 2020 2020 2022 696d 706f 7274 5f62 7563       "import_buc
-0000aa60: 6b65 745f 7572 6922 3a20 6173 7369 676e  ket_uri": assign
-0000aa70: 5f76 6172 2822 696d 706f 7274 5f62 7563  _var("import_buc
-0000aa80: 6b65 745f 7572 6922 292c 0a20 2020 2020  ket_uri"),.     
-0000aa90: 2020 2022 696d 706f 7274 5f71 7565 7279     "import_query
-0000aaa0: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
-0000aab0: 6d70 6f72 745f 7175 6572 7922 292c 0a20  mport_query"),. 
-0000aac0: 2020 2020 2020 2022 7368 6172 6564 5f77         "shared_w
-0000aad0: 6974 6822 3a20 7368 6172 6564 5f77 6974  ith": shared_wit
-0000aae0: 682c 0a20 2020 2020 2020 2022 6578 706f  h,.        "expo
-0000aaf0: 7274 5f73 6572 7669 6365 223a 2061 7373  rt_service": ass
-0000ab00: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
-0000ab10: 7365 7276 6963 6522 292c 0a20 2020 2020  service"),.     
-0000ab20: 2020 2022 6578 706f 7274 5f63 6f6e 6e65     "export_conne
-0000ab30: 6374 696f 6e5f 6e61 6d65 223a 2061 7373  ction_name": ass
-0000ab40: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
-0000ab50: 636f 6e6e 6563 7469 6f6e 5f6e 616d 6522  connection_name"
-0000ab60: 292c 0a20 2020 2020 2020 2022 6578 706f  ),.        "expo
-0000ab70: 7274 5f73 6368 6564 756c 6522 3a20 6173  rt_schedule": as
-0000ab80: 7369 676e 5f76 6172 2822 6578 706f 7274  sign_var("export
-0000ab90: 5f73 6368 6564 756c 6522 292c 0a20 2020  _schedule"),.   
-0000aba0: 2020 2020 2022 6578 706f 7274 5f62 7563       "export_buc
-0000abb0: 6b65 745f 7572 6922 3a20 6173 7369 676e  ket_uri": assign
-0000abc0: 5f76 6172 2822 6578 706f 7274 5f62 7563  _var("export_buc
-0000abd0: 6b65 745f 7572 6922 292c 0a20 2020 2020  ket_uri"),.     
-0000abe0: 2020 2022 6578 706f 7274 5f66 696c 655f     "export_file_
-0000abf0: 7465 6d70 6c61 7465 223a 2061 7373 6967  template": assig
-0000ac00: 6e5f 7661 7228 2265 7870 6f72 745f 6669  n_var("export_fi
-0000ac10: 6c65 5f74 656d 706c 6174 6522 292c 0a20  le_template"),. 
-0000ac20: 2020 2020 2020 2022 6578 706f 7274 5f66         "export_f
-0000ac30: 6f72 6d61 7422 3a20 6173 7369 676e 5f76  ormat": assign_v
-0000ac40: 6172 2822 6578 706f 7274 5f66 6f72 6d61  ar("export_forma
-0000ac50: 7422 292c 0a20 2020 2020 2020 2022 6578  t"),.        "ex
-0000ac60: 706f 7274 5f73 7472 6174 6567 7922 3a20  port_strategy": 
-0000ac70: 6173 7369 676e 5f76 6172 2822 6578 706f  assign_var("expo
-0000ac80: 7274 5f73 7472 6174 6567 7922 292c 0a20  rt_strategy"),. 
-0000ac90: 2020 2020 2020 2022 6578 706f 7274 5f63         "export_c
-0000aca0: 6f6d 7072 6573 7369 6f6e 223a 2061 7373  ompression": ass
-0000acb0: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
-0000acc0: 636f 6d70 7265 7373 696f 6e22 292c 0a20  compression"),. 
-0000acd0: 2020 207d 0a0a 2020 2020 656e 6769 6e65     }..    engine
-0000ace0: 5f76 6172 7320 3d20 7365 7428 290a 0a20  _vars = set().. 
-0000acf0: 2020 2066 6f72 205f 656e 6769 6e65 2c20     for _engine, 
-0000ad00: 2870 6172 616d 732c 206f 7074 696f 6e73  (params, options
-0000ad10: 2920 696e 2045 4e41 424c 4544 5f45 4e47  ) in ENABLED_ENG
-0000ad20: 494e 4553 3a0a 2020 2020 2020 2020 666f  INES:.        fo
-0000ad30: 7220 7020 696e 2070 6172 616d 733a 0a20  r p in params:. 
-0000ad40: 2020 2020 2020 2020 2020 2065 6e67 696e             engin
-0000ad50: 655f 7661 7273 2e61 6464 2870 2e6e 616d  e_vars.add(p.nam
-0000ad60: 6529 0a20 2020 2020 2020 2066 6f72 206f  e).        for o
-0000ad70: 2069 6e20 6f70 7469 6f6e 733a 0a20 2020   in options:.   
-0000ad80: 2020 2020 2020 2020 2065 6e67 696e 655f           engine_
-0000ad90: 7661 7273 2e61 6464 286f 2e6e 616d 6529  vars.add(o.name)
-0000ada0: 0a20 2020 2066 6f72 2076 2069 6e20 656e  .    for v in en
-0000adb0: 6769 6e65 5f76 6172 733a 0a20 2020 2020  gine_vars:.     
-0000adc0: 2020 2063 6d64 735b 6622 656e 6769 6e65     cmds[f"engine
-0000add0: 5f7b 767d 225d 203d 2061 6464 5f65 6e67  _{v}"] = add_eng
-0000ade0: 696e 655f 7661 7228 7629 0a0a 2020 2020  ine_var(v)..    
-0000adf0: 6966 2064 6566 6175 6c74 5f6e 6f64 653a  if default_node:
-0000ae00: 0a20 2020 2020 2020 206e 6f64 6528 6465  .        node(de
-0000ae10: 6661 756c 745f 6e6f 6465 290a 0a20 2020  fault_node)..   
-0000ae20: 206c 696e 656e 6f20 3d20 300a 2020 2020   lineno = 0.    
-0000ae30: 7472 793a 0a20 2020 2020 2020 2077 6869  try:.        whi
-0000ae40: 6c65 206c 696e 656e 6f20 3c20 6c65 6e28  le lineno < len(
-0000ae50: 6c69 6e65 7329 3a0a 2020 2020 2020 2020  lines):.        
-0000ae60: 2020 2020 6c69 6e65 203d 206c 696e 6573      line = lines
-0000ae70: 5b6c 696e 656e 6f5d 0a20 2020 2020 2020  [lineno].       
-0000ae80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000ae90: 2020 2020 2020 2020 2020 7361 203d 2073            sa = s
-0000aea0: 686c 6578 2e73 686c 6578 286c 696e 6529  hlex.shlex(line)
-0000aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aec0: 2073 612e 7768 6974 6573 7061 6365 5f73   sa.whitespace_s
-0000aed0: 706c 6974 203d 2054 7275 650a 2020 2020  plit = True.    
-0000aee0: 2020 2020 2020 2020 2020 2020 6c65 7865              lexe
-0000aef0: 7220 3d20 6c69 7374 2873 6129 0a20 2020  r = list(sa).   
-0000af00: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000af10: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
-0000af20: 2020 2020 2020 2020 2020 2020 7361 203d              sa =
-0000af30: 2073 686c 6578 2e73 686c 6578 2873 686c   shlex.shlex(shl
-0000af40: 6578 2e71 756f 7465 286c 696e 6529 290a  ex.quote(line)).
-0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af60: 7361 2e77 6869 7465 7370 6163 655f 7370  sa.whitespace_sp
-0000af70: 6c69 7420 3d20 5472 7565 0a20 2020 2020  lit = True.     
-0000af80: 2020 2020 2020 2020 2020 206c 6578 6572             lexer
-0000af90: 203d 206c 6973 7428 7361 290a 2020 2020   = list(sa).    
-0000afa0: 2020 2020 2020 2020 6966 206c 6578 6572          if lexer
-0000afb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000afc0: 2020 636d 642c 2061 7267 7320 3d20 6c65    cmd, args = le
-0000afd0: 7865 725b 305d 2c20 6c65 7865 725b 313a  xer[0], lexer[1:
-0000afe0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000aff0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
-0000b000: 2020 2020 2020 2020 2020 2070 6172 7365             parse
-0000b010: 725f 7374 6174 652e 6d75 6c74 696c 696e  r_state.multilin
-0000b020: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000b030: 2020 2020 2020 616e 6420 636d 642e 6c6f        and cmd.lo
-0000b040: 7765 7228 2920 696e 2063 6d64 730a 2020  wer() in cmds.  
-0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b060: 2020 616e 6420 6e6f 7420 286c 696e 652e    and not (line.
-0000b070: 7374 6172 7473 7769 7468 2822 2022 2920  startswith(" ") 
-0000b080: 6f72 206c 696e 652e 7374 6172 7473 7769  or line.startswi
-0000b090: 7468 2822 5c74 2229 206f 7220 6c69 6e65  th("\t") or line
-0000b0a0: 2e6c 6f77 6572 2829 2e73 7461 7274 7377  .lower().startsw
-0000b0b0: 6974 6828 2266 726f 6d22 2929 0a20 2020  ith("from")).   
-0000b0c0: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
-0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0e0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
-0000b0f0: 2e6d 756c 7469 6c69 6e65 203d 2046 616c  .multiline = Fal
-0000b100: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0000b110: 2020 2020 2020 2063 6d64 735b 7061 7273         cmds[pars
-0000b120: 6572 5f73 7461 7465 2e63 6f6d 6d61 6e64  er_state.command
-0000b130: 5d28 0a20 2020 2020 2020 2020 2020 2020  ](.             
-0000b140: 2020 2020 2020 2020 2020 2070 6172 7365             parse
-0000b150: 725f 7374 6174 652e 6d75 6c74 696c 696e  r_state.multilin
-0000b160: 655f 7374 7269 6e67 2c20 6c69 6e65 6e6f  e_string, lineno
-0000b170: 3d6c 696e 656e 6f2c 2072 6570 6c61 6365  =lineno, replace
-0000b180: 5f69 6e63 6c75 6465 733d 7265 706c 6163  _includes=replac
-0000b190: 655f 696e 636c 7564 6573 0a20 2020 2020  e_includes.     
-0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000b1b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000b1c0: 2020 6966 206e 6f74 2070 6172 7365 725f    if not parser_
-0000b1d0: 7374 6174 652e 6d75 6c74 696c 696e 653a  state.multiline:
-0000b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b1f0: 2020 2020 2069 6620 6c65 6e28 6172 6773       if len(args
-0000b200: 2920 3e3d 2031 2061 6e64 2061 7267 735b  ) >= 1 and args[
-0000b210: 305d 203d 3d20 223e 223a 0a20 2020 2020  0] == ">":.     
-0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b230: 2020 2070 6172 7365 725f 7374 6174 652e     parser_state.
-0000b240: 6d75 6c74 696c 696e 6520 3d20 5472 7565  multiline = True
-0000b250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b260: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
-0000b270: 7374 6174 652e 636f 6d6d 616e 6420 3d20  state.command = 
-0000b280: 636d 642e 6c6f 7765 7228 290a 2020 2020  cmd.lower().    
-0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2a0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
-0000b2b0: 2e6d 756c 7469 6c69 6e65 5f73 7472 696e  .multiline_strin
-0000b2c0: 6720 3d20 2222 0a20 2020 2020 2020 2020  g = "".         
-0000b2d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b2f0: 2020 2020 2020 2020 2069 6620 636d 642e           if cmd.
-0000b300: 6c6f 7765 7228 2920 696e 2063 6d64 733a  lower() in cmds:
-0000b310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b320: 2020 2020 2020 2020 2020 2020 2063 6d64               cmd
-0000b330: 735b 636d 642e 6c6f 7765 7228 295d 282a  s[cmd.lower()](*
-0000b340: 6172 6773 2c20 6c69 6e65 6e6f 3d6c 696e  args, lineno=lin
-0000b350: 656e 6f2c 2072 6570 6c61 6365 5f69 6e63  eno, replace_inc
-0000b360: 6c75 6465 733d 7265 706c 6163 655f 696e  ludes=replace_in
-0000b370: 636c 7564 6573 290a 2020 2020 2020 2020  cludes).        
-0000b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b390: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-0000b3c0: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
-0000b3d0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-0000b3e0: 6f72 5f6f 7074 696f 6e28 6f70 7469 6f6e  or_option(option
-0000b3f0: 3d63 6d64 2e75 7070 6572 2829 2929 0a20  =cmd.upper())). 
-0000b400: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000b410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b420: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
-0000b430: 7374 6174 652e 6d75 6c74 696c 696e 655f  state.multiline_
-0000b440: 7374 7269 6e67 202b 3d20 6c69 6e65 0a20  string += line. 
-0000b450: 2020 2020 2020 2020 2020 206c 696e 656e             linen
-0000b460: 6f20 2b3d 2031 0a20 2020 2020 2020 2023  o += 1.        #
-0000b470: 2063 6c6f 7365 2066 696e 616c 2073 7461   close final sta
-0000b480: 7465 0a20 2020 2020 2020 2069 6620 7061  te.        if pa
-0000b490: 7273 6572 5f73 7461 7465 2e6d 756c 7469  rser_state.multi
-0000b4a0: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
-0000b4b0: 2020 636d 6473 5b70 6172 7365 725f 7374    cmds[parser_st
-0000b4c0: 6174 652e 636f 6d6d 616e 645d 2870 6172  ate.command](par
-0000b4d0: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
-0000b4e0: 696e 655f 7374 7269 6e67 2c20 6c69 6e65  ine_string, line
-0000b4f0: 6e6f 3d6c 696e 656e 6f2c 2072 6570 6c61  no=lineno, repla
-0000b500: 6365 5f69 6e63 6c75 6465 733d 7265 706c  ce_includes=repl
-0000b510: 6163 655f 696e 636c 7564 6573 290a 2020  ace_includes).  
-0000b520: 2020 6578 6365 7074 2050 6172 7365 4578    except ParseEx
-0000b530: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0000b540: 2020 2020 2020 7261 6973 6520 5061 7273        raise Pars
-0000b550: 6545 7863 6570 7469 6f6e 2873 7472 2865  eException(str(e
-0000b560: 292c 206c 696e 656e 6f3d 6c69 6e65 6e6f  ), lineno=lineno
-0000b570: 290a 2020 2020 6578 6365 7074 2056 616c  ).    except Val
-0000b580: 6964 6174 696f 6e45 7863 6570 7469 6f6e  idationException
-0000b590: 2061 7320 653a 0a20 2020 2020 2020 2072   as e:.        r
-0000b5a0: 6169 7365 2056 616c 6964 6174 696f 6e45  aise ValidationE
-0000b5b0: 7863 6570 7469 6f6e 2873 7472 2865 292c  xception(str(e),
-0000b5c0: 206c 696e 656e 6f3d 6c69 6e65 6e6f 290a   lineno=lineno).
-0000b5d0: 2020 2020 6578 6365 7074 2049 6e64 6578      except Index
-0000b5e0: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
-0000b5f0: 2020 2020 6966 2022 6e6f 6465 2220 696e      if "node" in
-0000b600: 206c 696e 652e 6c6f 7765 7228 293a 0a20   line.lower():. 
-0000b610: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000b620: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-0000b630: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-0000b640: 6e61 6765 722e 6572 726f 725f 6d69 7373  nager.error_miss
-0000b650: 696e 675f 6e6f 6465 5f6e 616d 6528 2929  ing_node_name())
-0000b660: 0a20 2020 2020 2020 2065 6c69 6620 2273  .        elif "s
-0000b670: 716c 2220 696e 206c 696e 652e 6c6f 7765  ql" in line.lowe
-0000b680: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-0000b690: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-0000b6a0: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-0000b6b0: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-0000b6c0: 725f 6d69 7373 696e 675f 7371 6c5f 636f  r_missing_sql_co
-0000b6d0: 6d6d 616e 6428 2929 0a20 2020 2020 2020  mmand()).       
-0000b6e0: 2065 6c69 6620 2264 6174 6173 6f75 7263   elif "datasourc
-0000b6f0: 6522 2069 6e20 6c69 6e65 2e6c 6f77 6572  e" in line.lower
-0000b700: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000b710: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
-0000b720: 6b45 7863 6570 7469 6f6e 2846 6565 6462  kException(Feedb
-0000b730: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
-0000b740: 5f6d 6973 7369 6e67 5f64 6174 6173 6f75  _missing_datasou
-0000b750: 7263 655f 6e61 6d65 2829 290a 2020 2020  rce_name()).    
-0000b760: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000b770: 2020 2020 2020 7261 6973 6520 5661 6c69        raise Vali
-0000b780: 6461 7469 6f6e 4578 6365 7074 696f 6e28  dationException(
-0000b790: 6622 5661 6c69 6461 7469 6f6e 2065 7272  f"Validation err
-0000b7a0: 6f72 2c20 666f 756e 6420 7b6c 696e 657d  or, found {line}
-0000b7b0: 2069 6e20 6c69 6e65 207b 7374 7228 6c69   in line {str(li
-0000b7c0: 6e65 6e6f 297d 3a20 7b73 7472 2865 297d  neno)}: {str(e)}
-0000b7d0: 222c 206c 696e 656e 6f3d 6c69 6e65 6e6f  ", lineno=lineno
-0000b7e0: 290a 2020 2020 6578 6365 7074 2049 6e63  ).    except Inc
-0000b7f0: 6c75 6465 4669 6c65 4e6f 7446 6f75 6e64  ludeFileNotFound
-0000b800: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0000b810: 2020 2020 2020 2020 7261 6973 6520 650a          raise e.
-0000b820: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0000b830: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000b840: 2020 2074 7261 6365 6261 636b 2e70 7269     traceback.pri
-0000b850: 6e74 5f74 6228 652e 5f5f 7472 6163 6562  nt_tb(e.__traceb
-0000b860: 6163 6b5f 5f29 0a20 2020 2020 2020 2072  ack__).        r
-0000b870: 6169 7365 2050 6172 7365 4578 6365 7074  aise ParseExcept
-0000b880: 696f 6e28 6622 556e 6578 7065 6374 6564  ion(f"Unexpected
-0000b890: 2065 7272 6f72 3a20 7b65 7d22 2c20 6c69   error: {e}", li
-0000b8a0: 6e65 6e6f 3d6c 696e 656e 6f29 0a0a 2020  neno=lineno)..  
-0000b8b0: 2020 7265 7475 726e 2064 6f63 0a0a 0a64    return doc...d
-0000b8c0: 6566 2067 656e 6572 6174 655f 7265 736f  ef generate_reso
-0000b8d0: 7572 6365 5f66 6f72 5f6b 6579 286b 6579  urce_for_key(key
-0000b8e0: 3a20 7374 722c 206e 616d 653a 2073 7472  : str, name: str
-0000b8f0: 2c20 7363 6865 6d61 3a20 7374 722c 2076  , schema: str, v
-0000b900: 6572 7369 6f6e 3a20 7374 722c 2072 6573  ersion: str, res
-0000b910: 5f6e 616d 653a 2073 7472 2920 2d3e 204c  _name: str) -> L
-0000b920: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-0000b930: 795d 5d3a 0a20 2020 2072 6573 6f75 7263  y]]:.    resourc
-0000b940: 6573 3a20 4c69 7374 5b44 6963 745b 7374  es: List[Dict[st
-0000b950: 722c 2041 6e79 5d5d 203d 205b 5d0a 2020  r, Any]] = [].  
-0000b960: 2020 2320 6461 7461 736f 7572 6365 0a20    # datasource. 
-0000b970: 2020 2064 735f 6e61 6d65 203d 2066 227b     ds_name = f"{
-0000b980: 6e61 6d65 7d5f 6a6f 696e 5f62 795f 7b6b  name}_join_by_{k
-0000b990: 6579 7d7b 7665 7273 696f 6e7d 220a 2020  ey}{version}".  
-0000b9a0: 2020 7061 7261 6d73 203d 207b 0a20 2020    params = {.   
-0000b9b0: 2020 2020 2022 6e61 6d65 223a 2064 735f       "name": ds_
-0000b9c0: 6e61 6d65 2c0a 2020 2020 2020 2020 2273  name,.        "s
-0000b9d0: 6368 656d 6122 3a20 7363 6865 6d61 2c0a  chema": schema,.
-0000b9e0: 2020 2020 2020 2020 2265 6e67 696e 6522          "engine"
-0000b9f0: 3a20 224a 6f69 6e22 2c0a 2020 2020 2020  : "Join",.      
-0000ba00: 2020 2265 6e67 696e 655f 6a6f 696e 5f73    "engine_join_s
-0000ba10: 7472 6963 746e 6573 7322 3a20 2241 4e59  trictness": "ANY
-0000ba20: 222c 0a20 2020 2020 2020 2022 656e 6769  ",.        "engi
-0000ba30: 6e65 5f6a 6f69 6e5f 7479 7065 223a 2022  ne_join_type": "
-0000ba40: 4c45 4654 222c 0a20 2020 2020 2020 2022  LEFT",.        "
-0000ba50: 656e 6769 6e65 5f6b 6579 5f63 6f6c 756d  engine_key_colum
-0000ba60: 6e73 223a 206b 6579 2c0a 2020 2020 7d0a  ns": key,.    }.
-0000ba70: 2020 2020 7265 736f 7572 6365 732e 6170      resources.ap
-0000ba80: 7065 6e64 280a 2020 2020 2020 2020 7b0a  pend(.        {.
-0000ba90: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-0000baa0: 6f75 7263 655f 6e61 6d65 223a 2066 227b  ource_name": f"{
-0000bab0: 6e61 6d65 7d5f 6a6f 696e 5f62 795f 7b6b  name}_join_by_{k
-0000bac0: 6579 7d22 2c0a 2020 2020 2020 2020 2020  ey}",.          
-0000bad0: 2020 2272 6573 6f75 7263 6522 3a20 2264    "resource": "d
-0000bae0: 6174 6173 6f75 7263 6573 222c 0a20 2020  atasources",.   
-0000baf0: 2020 2020 2020 2020 2022 7061 7261 6d73           "params
-0000bb00: 223a 2070 6172 616d 732c 0a20 2020 2020  ": params,.     
-0000bb10: 2020 2020 2020 2022 6669 6c65 6e61 6d65         "filename
-0000bb20: 223a 2066 227b 7061 7261 6d73 5b27 6e61  ": f"{params['na
-0000bb30: 6d65 275d 7d2e 6461 7461 736f 7572 6365  me']}.datasource
-0000bb40: 222c 0a20 2020 2020 2020 207d 0a20 2020  ",.        }.   
-0000bb50: 2029 0a20 2020 2072 6573 6f75 7263 6573   ).    resources
-0000bb60: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-0000bb70: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-0000bb80: 7265 736f 7572 6365 5f6e 616d 6522 3a20  resource_name": 
-0000bb90: 6622 7b6e 616d 657d 5f6a 6f69 6e5f 6279  f"{name}_join_by
-0000bba0: 5f7b 6b65 797d 5f70 6970 6522 2c0a 2020  _{key}_pipe",.  
-0000bbb0: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
-0000bbc0: 7263 6522 3a20 2270 6970 6573 222c 0a20  rce": "pipes",. 
-0000bbd0: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
-0000bbe0: 6e61 6d65 223a 2066 227b 7061 7261 6d73  name": f"{params
-0000bbf0: 5b27 6e61 6d65 275d 7d2e 7069 7065 222c  ['name']}.pipe",
-0000bc00: 0a20 2020 2020 2020 2020 2020 2022 6e61  .            "na
-0000bc10: 6d65 223a 2066 227b 6e61 6d65 7d5f 6a6f  me": f"{name}_jo
-0000bc20: 696e 5f62 795f 7b6b 6579 7d5f 7069 7065  in_by_{key}_pipe
-0000bc30: 7b76 6572 7369 6f6e 7d22 2c0a 2020 2020  {version}",.    
-0000bc40: 2020 2020 2020 2020 2273 6368 656d 6122          "schema"
-0000bc50: 3a20 7363 6865 6d61 2c0a 2020 2020 2020  : schema,.      
-0000bc60: 2020 2020 2020 226e 6f64 6573 223a 205b        "nodes": [
-0000bc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc80: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000bc90: 2020 2020 2020 2022 7371 6c22 3a20 6622         "sql": f"
-0000bca0: 7365 6c65 6374 202a 2066 726f 6d20 7b6e  select * from {n
-0000bcb0: 616d 657d 7b76 6572 7369 6f6e 7d22 2c0a  ame}{version}",.
-0000bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcd0: 2020 2020 2270 6172 616d 7322 3a20 7b22      "params": {"
-0000bce0: 6e61 6d65 223a 2066 227b 6e61 6d65 7d5f  name": f"{name}_
-0000bcf0: 6a6f 696e 5f62 795f 7b6b 6579 7d5f 7669  join_by_{key}_vi
-0000bd00: 6577 222c 2022 7479 7065 223a 2022 6d61  ew", "type": "ma
-0000bd10: 7465 7269 616c 697a 6564 222c 2022 6461  terialized", "da
-0000bd20: 7461 736f 7572 6365 223a 2064 735f 6e61  tasource": ds_na
-0000bd30: 6d65 7d2c 0a20 2020 2020 2020 2020 2020  me},.           
-0000bd40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0000bd50: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0000bd60: 2020 2264 6570 7322 3a20 5b72 6573 5f6e    "deps": [res_n
-0000bd70: 616d 655d 2c20 2023 205b 6473 5f6e 616d  ame],  # [ds_nam
-0000bd80: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
-0000bd90: 2274 6f6b 656e 7322 3a20 5b5d 2c0a 2020  "tokens": [],.  
-0000bda0: 2020 2020 2020 7d0a 2020 2020 290a 2020        }.    ).  
-0000bdb0: 2020 7265 7475 726e 2072 6573 6f75 7263    return resourc
-0000bdc0: 6573 0a0a 0a61 7379 6e63 2064 6566 2070  es...async def p
-0000bdd0: 726f 6365 7373 5f66 696c 6528 0a20 2020  rocess_file(.   
-0000bde0: 2066 696c 656e 616d 653a 2073 7472 2c0a   filename: str,.
-0000bdf0: 2020 2020 7462 5f63 6c69 656e 743a 2054      tb_client: T
-0000be00: 696e 7942 2c0a 2020 2020 7265 736f 7572  inyB,.    resour
-0000be10: 6365 5f76 6572 7369 6f6e 733a 204f 7074  ce_versions: Opt
-0000be20: 696f 6e61 6c5b 4469 6374 5d20 3d20 4e6f  ional[Dict] = No
-0000be30: 6e65 2c0a 2020 2020 736b 6970 5f63 6f6e  ne,.    skip_con
-0000be40: 6e65 6374 6f72 733a 2062 6f6f 6c20 3d20  nectors: bool = 
-0000be50: 4661 6c73 652c 0a20 2020 2077 6f72 6b73  False,.    works
-0000be60: 7061 6365 5f6d 6170 3a20 4f70 7469 6f6e  pace_map: Option
-0000be70: 616c 5b44 6963 745d 203d 204e 6f6e 652c  al[Dict] = None,
-0000be80: 0a20 2020 2077 6f72 6b73 7061 6365 5f6c  .    workspace_l
-0000be90: 6962 5f70 6174 6873 3a20 4f70 7469 6f6e  ib_paths: Option
-0000bea0: 616c 5b4c 6973 745b 5475 706c 655b 7374  al[List[Tuple[st
-0000beb0: 722c 2073 7472 5d5d 5d20 3d20 4e6f 6e65  r, str]]] = None
-0000bec0: 2c0a 2020 2020 6375 7272 656e 745f 7773  ,.    current_ws
-0000bed0: 3a20 4f70 7469 6f6e 616c 5b44 6963 745b  : Optional[Dict[
-0000bee0: 7374 722c 2041 6e79 5d5d 203d 204e 6f6e  str, Any]] = Non
-0000bef0: 652c 0a29 3a20 2023 206e 6f71 613a 2043  e,.):  # noqa: C
-0000bf00: 3930 3120 4230 3036 0a20 2020 2069 6620  901 B006.    if 
-0000bf10: 776f 726b 7370 6163 655f 6d61 7020 6973  workspace_map is
-0000bf20: 204e 6f6e 653a 0a20 2020 2020 2020 2077   None:.        w
-0000bf30: 6f72 6b73 7061 6365 5f6d 6170 203d 207b  orkspace_map = {
-0000bf40: 7d0a 0a20 2020 2069 6620 7265 736f 7572  }..    if resour
-0000bf50: 6365 5f76 6572 7369 6f6e 7320 6973 204e  ce_versions is N
-0000bf60: 6f6e 653a 0a20 2020 2020 2020 2072 6573  one:.        res
-0000bf70: 6f75 7263 655f 7665 7273 696f 6e73 203d  ource_versions =
-0000bf80: 207b 7d0a 2020 2020 7265 736f 7572 6365   {}.    resource
-0000bf90: 5f76 6572 7369 6f6e 735f 7374 7269 6e67  _versions_string
-0000bfa0: 203d 207b 6b3a 2066 225f 5f76 7b76 7d22   = {k: f"__v{v}"
-0000bfb0: 2066 6f72 206b 2c20 7620 696e 2072 6573   for k, v in res
-0000bfc0: 6f75 7263 655f 7665 7273 696f 6e73 2e69  ource_versions.i
-0000bfd0: 7465 6d73 2829 2069 6620 7620 3e3d 2030  tems() if v >= 0
-0000bfe0: 7d0a 0a20 2020 2064 6566 2067 6574 5f65  }..    def get_e
-0000bff0: 6e67 696e 655f 7061 7261 6d73 286e 6f64  ngine_params(nod
-0000c000: 653a 2044 6963 745b 7374 722c 2041 6e79  e: Dict[str, Any
-0000c010: 5d29 202d 3e20 4469 6374 5b73 7472 2c20  ]) -> Dict[str, 
-0000c020: 416e 795d 3a0a 2020 2020 2020 2020 7061  Any]:.        pa
-0000c030: 7261 6d73 203d 207b 7d0a 0a20 2020 2020  rams = {}..     
-0000c040: 2020 2069 6620 2265 6e67 696e 6522 2069     if "engine" i
-0000c050: 6e20 6e6f 6465 3a0a 2020 2020 2020 2020  n node:.        
-0000c060: 2020 2020 656e 6769 6e65 203d 206e 6f64      engine = nod
-0000c070: 655b 2265 6e67 696e 6522 5d5b 2274 7970  e["engine"]["typ
-0000c080: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-0000c090: 7061 7261 6d73 5b22 656e 6769 6e65 225d  params["engine"]
-0000c0a0: 203d 2065 6e67 696e 650a 2020 2020 2020   = engine.      
-0000c0b0: 2020 2020 2020 6172 6773 203d 206e 6f64        args = nod
-0000c0c0: 655b 2265 6e67 696e 6522 5d5b 2261 7267  e["engine"]["arg
-0000c0d0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0000c0e0: 666f 7220 6b2c 2076 2069 6e20 6172 6773  for k, v in args
-0000c0f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c100: 2020 7061 7261 6d73 5b66 2265 6e67 696e    params[f"engin
-0000c110: 655f 7b6b 7d22 5d20 3d20 760a 2020 2020  e_{k}"] = v.    
-0000c120: 2020 2020 7265 7475 726e 2070 6172 616d      return param
-0000c130: 730a 0a20 2020 2061 7379 6e63 2064 6566  s..    async def
-0000c140: 2067 6574 5f6b 6166 6b61 5f70 6172 616d   get_kafka_param
-0000c150: 7328 6e6f 6465 3a20 4469 6374 5b73 7472  s(node: Dict[str
-0000c160: 2c20 416e 795d 293a 0a20 2020 2020 2020  , Any]):.       
-0000c170: 2070 6172 616d 7320 3d20 7b6b 6579 3a20   params = {key: 
-0000c180: 7661 6c75 6520 666f 7220 6b65 792c 2076  value for key, v
-0000c190: 616c 7565 2069 6e20 6e6f 6465 2e69 7465  alue in node.ite
-0000c1a0: 6d73 2829 2069 6620 6b65 792e 7374 6172  ms() if key.star
-0000c1b0: 7473 7769 7468 2822 6b61 666b 6122 297d  tswith("kafka")}
-0000c1c0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0000c1d0: 2073 6b69 705f 636f 6e6e 6563 746f 7273   skip_connectors
-0000c1e0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0000c1f0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000c200: 2020 2063 6f6e 6e65 6374 6f72 5f70 6172     connector_par
-0000c210: 616d 7320 3d20 7b0a 2020 2020 2020 2020  ams = {.        
-0000c220: 2020 2020 2020 2020 2020 2020 226b 6166              "kaf
-0000c230: 6b61 5f62 6f6f 7473 7472 6170 5f73 6572  ka_bootstrap_ser
-0000c240: 7665 7273 223a 2070 6172 616d 732e 6765  vers": params.ge
-0000c250: 7428 226b 6166 6b61 5f62 6f6f 7473 7472  t("kafka_bootstr
-0000c260: 6170 5f73 6572 7665 7273 222c 204e 6f6e  ap_servers", Non
-0000c270: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000c280: 2020 2020 2020 2020 226b 6166 6b61 5f6b          "kafka_k
-0000c290: 6579 223a 2070 6172 616d 732e 6765 7428  ey": params.get(
-0000c2a0: 226b 6166 6b61 5f6b 6579 222c 204e 6f6e  "kafka_key", Non
-0000c2b0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000c2c0: 2020 2020 2020 2020 226b 6166 6b61 5f73          "kafka_s
-0000c2d0: 6563 7265 7422 3a20 7061 7261 6d73 2e67  ecret": params.g
-0000c2e0: 6574 2822 6b61 666b 615f 7365 6372 6574  et("kafka_secret
-0000c2f0: 222c 204e 6f6e 6529 2c0a 2020 2020 2020  ", None),.      
-0000c300: 2020 2020 2020 2020 2020 2020 2020 226b                "k
-0000c310: 6166 6b61 5f63 6f6e 6e65 6374 696f 6e5f  afka_connection_
-0000c320: 6e61 6d65 223a 2070 6172 616d 732e 6765  name": params.ge
-0000c330: 7428 226b 6166 6b61 5f63 6f6e 6e65 6374  t("kafka_connect
-0000c340: 696f 6e5f 6e61 6d65 222c 204e 6f6e 6529  ion_name", None)
-0000c350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c360: 2020 2020 2020 226b 6166 6b61 5f61 7574        "kafka_aut
-0000c370: 6f5f 6f66 6673 6574 5f72 6573 6574 223a  o_offset_reset":
-0000c380: 2070 6172 616d 732e 6765 7428 226b 6166   params.get("kaf
-0000c390: 6b61 5f61 7574 6f5f 6f66 6673 6574 5f72  ka_auto_offset_r
-0000c3a0: 6573 6574 222c 204e 6f6e 6529 2c0a 2020  eset", None),.  
-0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3c0: 2020 226b 6166 6b61 5f73 6368 656d 615f    "kafka_schema_
-0000c3d0: 7265 6769 7374 7279 5f75 726c 223a 2070  registry_url": p
-0000c3e0: 6172 616d 732e 6765 7428 226b 6166 6b61  arams.get("kafka
-0000c3f0: 5f73 6368 656d 615f 7265 6769 7374 7279  _schema_registry
-0000c400: 5f75 726c 222c 204e 6f6e 6529 2c0a 2020  _url", None),.  
-0000c410: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0000c420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c430: 2063 6f6e 6e65 6374 6f72 203d 2061 7761   connector = awa
-0000c440: 6974 2074 625f 636c 6965 6e74 2e67 6574  it tb_client.get
-0000c450: 5f63 6f6e 6e65 6374 696f 6e28 2a2a 636f  _connection(**co
-0000c460: 6e6e 6563 746f 725f 7061 7261 6d73 290a  nnector_params).
-0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c480: 6966 206e 6f74 2063 6f6e 6e65 6374 6f72  if not connector
-0000c490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c4a0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0000c4b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c4c0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0000c4d0: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
-0000c4e0: 7265 6174 696e 675f 6b61 666b 615f 636f  reating_kafka_co
-0000c4f0: 6e6e 6563 7469 6f6e 2863 6f6e 6e65 6374  nnection(connect
-0000c500: 696f 6e5f 6e61 6d65 3d70 6172 616d 735b  ion_name=params[
-0000c510: 226b 6166 6b61 5f63 6f6e 6e65 6374 696f  "kafka_connectio
-0000c520: 6e5f 6e61 6d65 225d 290a 2020 2020 2020  n_name"]).      
-0000c530: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c550: 2020 2020 7265 7175 6972 6564 5f70 6172      required_par
-0000c560: 616d 7320 3d20 5b0a 2020 2020 2020 2020  ams = [.        
-0000c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c580: 636f 6e6e 6563 746f 725f 7061 7261 6d73  connector_params
-0000c590: 5b22 6b61 666b 615f 626f 6f74 7374 7261  ["kafka_bootstra
-0000c5a0: 705f 7365 7276 6572 7322 5d2c 0a20 2020  p_servers"],.   
-0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5c0: 2020 2020 2063 6f6e 6e65 6374 6f72 5f70       connector_p
-0000c5d0: 6172 616d 735b 226b 6166 6b61 5f6b 6579  arams["kafka_key
-0000c5e0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0000c5f0: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
-0000c600: 6563 746f 725f 7061 7261 6d73 5b22 6b61  ector_params["ka
-0000c610: 666b 615f 7365 6372 6574 225d 2c0a 2020  fka_secret"],.  
-0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c630: 2020 5d0a 0a20 2020 2020 2020 2020 2020    ]..           
-0000c640: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000c650: 616c 6c28 7265 7175 6972 6564 5f70 6172  all(required_par
-0000c660: 616d 7329 3a0a 2020 2020 2020 2020 2020  ams):.          
-0000c670: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000c680: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0000c690: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
-0000c6a0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f75  kManager.error_u
-0000c6b0: 6e6b 6e6f 776e 5f6b 6166 6b61 5f63 6f6e  nknown_kafka_con
-0000c6c0: 6e65 6374 696f 6e28 6461 7461 736f 7572  nection(datasour
-0000c6d0: 6365 3d6e 616d 6529 290a 0a20 2020 2020  ce=name))..     
-0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c6f0: 6f6e 6e65 6374 6f72 203d 2061 7761 6974  onnector = await
-0000c700: 2074 625f 636c 6965 6e74 2e63 6f6e 6e65   tb_client.conne
-0000c710: 6374 696f 6e5f 6372 6561 7465 5f6b 6166  ction_create_kaf
-0000c720: 6b61 282a 2a63 6f6e 6e65 6374 6f72 5f70  ka(**connector_p
-0000c730: 6172 616d 7329 0a20 2020 2020 2020 2020  arams).         
-0000c740: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0000c750: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0000c760: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000c770: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-0000c780: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0000c790: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0000c7a0: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0000c7b0: 636f 6e6e 6563 7469 6f6e 5f63 7265 6174  connection_creat
-0000c7c0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0000c7d0: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
-0000c7e0: 6374 696f 6e5f 6e61 6d65 3d70 6172 616d  ction_name=param
-0000c7f0: 735b 226b 6166 6b61 5f63 6f6e 6e65 6374  s["kafka_connect
-0000c800: 696f 6e5f 6e61 6d65 225d 2c20 6572 726f  ion_name"], erro
-0000c810: 723d 7374 7228 6529 0a20 2020 2020 2020  r=str(e).       
-0000c820: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000c830: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000c840: 0a0a 2020 2020 2020 2020 2020 2020 636c  ..            cl
-0000c850: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
-0000c860: 6b4d 616e 6167 6572 2e73 7563 6365 7373  kManager.success
-0000c870: 5f63 6f6e 6e65 6374 696f 6e5f 7573 696e  _connection_usin
-0000c880: 6728 636f 6e6e 6563 7469 6f6e 5f6e 616d  g(connection_nam
-0000c890: 653d 636f 6e6e 6563 746f 725b 226e 616d  e=connector["nam
-0000c8a0: 6522 5d29 290a 0a20 2020 2020 2020 2020  e"]))..         
-0000c8b0: 2020 2070 6172 616d 732e 7570 6461 7465     params.update
-0000c8c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c8d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0000c8e0: 2020 2020 2020 2020 2263 6f6e 6e65 6374          "connect
-0000c8f0: 6f72 223a 2063 6f6e 6e65 6374 6f72 5b22  or": connector["
-0000c900: 6964 225d 2c0a 2020 2020 2020 2020 2020  id"],.          
-0000c910: 2020 2020 2020 2020 2020 2273 6572 7669            "servi
-0000c920: 6365 223a 2022 6b61 666b 6122 2c0a 2020  ce": "kafka",.  
-0000c930: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0000c940: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000c950: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-0000c960: 7261 6d73 0a0a 2020 2020 6173 796e 6320  rams..    async 
-0000c970: 6465 6620 6765 745f 696d 706f 7274 5f70  def get_import_p
-0000c980: 6172 616d 7328 6461 7461 736f 7572 6365  arams(datasource
-0000c990: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
-0000c9a0: 2c20 6e6f 6465 3a20 4469 6374 5b73 7472  , node: Dict[str
-0000c9b0: 2c20 416e 795d 2920 2d3e 2044 6963 745b  , Any]) -> Dict[
-0000c9c0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
-0000c9d0: 2020 2070 6172 616d 733a 2044 6963 745b     params: Dict[
-0000c9e0: 7374 722c 2041 6e79 5d20 3d20 7b6b 6579  str, Any] = {key
-0000c9f0: 3a20 7661 6c75 6520 666f 7220 6b65 792c  : value for key,
-0000ca00: 2076 616c 7565 2069 6e20 6e6f 6465 2e69   value in node.i
-0000ca10: 7465 6d73 2829 2069 6620 6b65 792e 7374  tems() if key.st
-0000ca20: 6172 7473 7769 7468 2822 696d 706f 7274  artswith("import
-0000ca30: 5f22 297d 0a0a 2020 2020 2020 2020 6966  _")}..        if
-0000ca40: 206c 656e 2870 6172 616d 7329 203d 3d20   len(params) == 
-0000ca50: 3020 6f72 2073 6b69 705f 636f 6e6e 6563  0 or skip_connec
-0000ca60: 746f 7273 3a0a 2020 2020 2020 2020 2020  tors:.          
-0000ca70: 2020 7265 7475 726e 2070 6172 616d 730a    return params.
-0000ca80: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
-0000ca90: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-0000caa0: 3d20 6e6f 6465 2e67 6574 2822 696d 706f  = node.get("impo
-0000cab0: 7274 5f73 6572 7669 6365 222c 204e 6f6e  rt_service", Non
-0000cac0: 6529 0a0a 2020 2020 2020 2020 6966 2073  e)..        if s
-0000cad0: 6572 7669 6365 2061 6e64 2073 6572 7669  ervice and servi
-0000cae0: 6365 2e6c 6f77 6572 2829 203d 3d20 2262  ce.lower() == "b
-0000caf0: 6967 7175 6572 7922 3a0a 2020 2020 2020  igquery":.      
-0000cb00: 2020 2020 2020 6966 206e 6f74 2061 7761        if not awa
-0000cb10: 6974 2074 625f 636c 6965 6e74 2e63 6865  it tb_client.che
-0000cb20: 636b 5f67 6370 5f72 6561 645f 7065 726d  ck_gcp_read_perm
-0000cb30: 6973 7369 6f6e 7328 293a 0a20 2020 2020  issions():.     
-0000cb40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000cb50: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-0000cb60: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-0000cb70: 6e61 6765 722e 6572 726f 725f 756e 6b6e  nager.error_unkn
-0000cb80: 6f77 6e5f 6271 5f63 6f6e 6e65 6374 696f  own_bq_connectio
-0000cb90: 6e28 6461 7461 736f 7572 6365 3d64 6174  n(datasource=dat
-0000cba0: 6173 6f75 7263 655b 226e 616d 6522 5d29  asource["name"])
-0000cbb0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0000cbc0: 2042 6967 7175 6572 7920 646f 6573 6e27   Bigquery doesn'
-0000cbd0: 7420 6861 7665 2061 2064 6174 616c 696e  t have a datalin
-0000cbe0: 6b2c 2073 6f20 7765 2063 616e 2073 746f  k, so we can sto
-0000cbf0: 7020 6865 7265 0a20 2020 2020 2020 2020  p here.         
-0000cc00: 2020 2072 6574 7572 6e20 7061 7261 6d73     return params
-0000cc10: 0a0a 2020 2020 2020 2020 2320 5265 7374  ..        # Rest
-0000cc20: 206f 6620 636f 6e6e 6563 746f 7273 0a0a   of connectors..
-0000cc30: 2020 2020 2020 2020 636f 6e6e 6563 746f          connecto
-0000cc40: 725f 6964 3a20 4f70 7469 6f6e 616c 5b73  r_id: Optional[s
-0000cc50: 7472 5d20 3d20 6e6f 6465 2e67 6574 2822  tr] = node.get("
-0000cc60: 696d 706f 7274 5f63 6f6e 6e65 6374 6f72  import_connector
-0000cc70: 222c 204e 6f6e 6529 0a20 2020 2020 2020  ", None).       
-0000cc80: 2063 6f6e 6e65 6374 6f72 5f6e 616d 653a   connector_name:
-0000cc90: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0000cca0: 206e 6f64 652e 6765 7428 2269 6d70 6f72   node.get("impor
-0000ccb0: 745f 636f 6e6e 6563 7469 6f6e 5f6e 616d  t_connection_nam
-0000ccc0: 6522 2c20 4e6f 6e65 290a 2020 2020 2020  e", None).      
-0000ccd0: 2020 6966 206e 6f74 2063 6f6e 6e65 6374    if not connect
-0000cce0: 6f72 5f6e 616d 6520 616e 6420 6e6f 7420  or_name and not 
-0000ccf0: 636f 6e6e 6563 746f 725f 6964 3a0a 2020  connector_id:.  
-0000cd00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000cd10: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-0000cd20: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-0000cd30: 6167 6572 2e65 7272 6f72 5f6d 6973 7369  ager.error_missi
-0000cd40: 6e67 5f63 6f6e 6e65 6374 696f 6e5f 6e61  ng_connection_na
-0000cd50: 6d65 2864 6174 6173 6f75 7263 653d 6461  me(datasource=da
-0000cd60: 7461 736f 7572 6365 5b22 6e61 6d65 225d  tasource["name"]
-0000cd70: 2929 0a0a 2020 2020 2020 2020 6966 206e  ))..        if n
-0000cd80: 6f74 2063 6f6e 6e65 6374 6f72 5f69 643a  ot connector_id:
-0000cd90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000cda0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
-0000cdb0: 6f6e 6e65 6374 6f72 5f6e 616d 652c 2073  onnector_name, s
-0000cdc0: 7472 290a 0a20 2020 2020 2020 2020 2020  tr)..           
-0000cdd0: 2063 6f6e 6e65 6374 6f72 3a20 4f70 7469   connector: Opti
-0000cde0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
-0000cdf0: 6e79 5d5d 203d 2061 7761 6974 2074 625f  ny]] = await tb_
-0000ce00: 636c 6965 6e74 2e67 6574 5f63 6f6e 6e65  client.get_conne
-0000ce10: 6374 6f72 2863 6f6e 6e65 6374 6f72 5f6e  ctor(connector_n
-0000ce20: 616d 652c 2073 6572 7669 6365 290a 0a20  ame, service).. 
-0000ce30: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000ce40: 7420 636f 6e6e 6563 746f 723a 0a20 2020  t connector:.   
-0000ce50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000ce60: 7365 2045 7863 6570 7469 6f6e 280a 2020  se Exception(.  
-0000ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce80: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-0000ce90: 722e 6572 726f 725f 756e 6b6e 6f77 6e5f  r.error_unknown_
-0000cea0: 636f 6e6e 6563 7469 6f6e 2864 6174 6173  connection(datas
-0000ceb0: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
-0000cec0: 5b22 6e61 6d65 225d 2c20 636f 6e6e 6563  ["name"], connec
-0000ced0: 7469 6f6e 3d63 6f6e 6e65 6374 6f72 5f6e  tion=connector_n
-0000cee0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0000cef0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000cf00: 2020 2063 6f6e 6e65 6374 6f72 5f69 6420     connector_id 
-0000cf10: 3d20 636f 6e6e 6563 746f 725b 2269 6422  = connector["id"
-0000cf20: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
-0000cf30: 7276 6963 6520 3d20 636f 6e6e 6563 746f  rvice = connecto
-0000cf40: 725b 2273 6572 7669 6365 225d 0a0a 2020  r["service"]..  
-0000cf50: 2020 2020 2020 2320 5468 6520 4150 4920        # The API 
-0000cf60: 6e65 6564 7320 7468 6520 636f 6e6e 6563  needs the connec
-0000cf70: 746f 7220 4944 2074 6f20 6372 6561 7465  tor ID to create
-0000cf80: 2074 6865 2064 6174 6173 6f75 7263 652e   the datasource.
-0000cf90: 0a20 2020 2020 2020 2070 6172 616d 735b  .        params[
-0000cfa0: 2269 6d70 6f72 745f 636f 6e6e 6563 746f  "import_connecto
-0000cfb0: 7222 5d20 3d20 636f 6e6e 6563 746f 725f  r"] = connector_
-0000cfc0: 6964 0a20 2020 2020 2020 2069 6620 7365  id.        if se
-0000cfd0: 7276 6963 653a 0a20 2020 2020 2020 2020  rvice:.         
-0000cfe0: 2020 2070 6172 616d 735b 2269 6d70 6f72     params["impor
-0000cff0: 745f 7365 7276 6963 6522 5d20 3d20 7365  t_service"] = se
-0000d000: 7276 6963 650a 0a20 2020 2020 2020 2069  rvice..        i
-0000d010: 6620 7365 7276 6963 6520 696e 2050 5245  f service in PRE
-0000d020: 5649 4557 5f43 4f4e 4e45 4354 4f52 5f53  VIEW_CONNECTOR_S
-0000d030: 4552 5649 4345 533a 0a20 2020 2020 2020  ERVICES:.       
-0000d040: 2020 2020 2069 6620 6e6f 7420 7061 7261       if not para
-0000d050: 6d73 2e67 6574 2822 696d 706f 7274 5f62  ms.get("import_b
-0000d060: 7563 6b65 745f 7572 6922 2c20 4e6f 6e65  ucket_uri", None
-0000d070: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000d080: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
-0000d090: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
-0000d0a0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-0000d0b0: 726f 725f 6d69 7373 696e 675f 6275 636b  ror_missing_buck
-0000d0c0: 6574 5f75 7269 2864 6174 6173 6f75 7263  et_uri(datasourc
-0000d0d0: 653d 6461 7461 736f 7572 6365 5b22 6e61  e=datasource["na
-0000d0e0: 6d65 225d 2929 0a20 2020 2020 2020 2065  me"])).        e
-0000d0f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000d100: 2069 6620 6e6f 7420 7061 7261 6d73 2e67   if not params.g
-0000d110: 6574 2822 696d 706f 7274 5f65 7874 6572  et("import_exter
-0000d120: 6e61 6c5f 6461 7461 736f 7572 6365 222c  nal_datasource",
-0000d130: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
-0000d140: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
-0000d150: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
-0000d160: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0000d170: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
-0000d180: 4d61 6e61 6765 722e 6572 726f 725f 6d69  Manager.error_mi
-0000d190: 7373 696e 675f 6578 7465 726e 616c 5f64  ssing_external_d
-0000d1a0: 6174 6173 6f75 7263 6528 6461 7461 736f  atasource(dataso
-0000d1b0: 7572 6365 3d64 6174 6173 6f75 7263 655b  urce=datasource[
-0000d1c0: 226e 616d 6522 5d29 0a20 2020 2020 2020  "name"]).       
-0000d1d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000d1e0: 2020 2020 7265 7475 726e 2070 6172 616d      return param
-0000d1f0: 730a 0a20 2020 2069 6620 4461 7461 4669  s..    if DataFi
-0000d200: 6c65 4578 7465 6e73 696f 6e73 2e44 4154  leExtensions.DAT
-0000d210: 4153 4f55 5243 4520 696e 2066 696c 656e  ASOURCE in filen
-0000d220: 616d 653a 0a20 2020 2020 2020 2064 6f63  ame:.        doc
-0000d230: 203d 2070 6172 7365 5f64 6174 6173 6f75   = parse_datasou
-0000d240: 7263 6528 6669 6c65 6e61 6d65 290a 2020  rce(filename).  
-0000d250: 2020 2020 2020 6e6f 6465 203d 2064 6f63        node = doc
-0000d260: 2e6e 6f64 6573 5b30 5d0a 2020 2020 2020  .nodes[0].      
-0000d270: 2020 6465 7073 3a20 4c69 7374 5b73 7472    deps: List[str
-0000d280: 5d20 3d20 5b5d 0a20 2020 2020 2020 2023  ] = [].        #
-0000d290: 2072 6565 6d70 6c61 6365 2074 6162 6c65   reemplace table
-0000d2a0: 7320 6f6e 206d 6174 6572 6961 6c69 7a65  s on materialize
-0000d2b0: 6420 636f 6c75 6d6e 730a 2020 2020 2020  d columns.      
-0000d2c0: 2020 636f 6c75 6d6e 7320 3d20 7061 7273    columns = pars
-0000d2d0: 655f 7461 626c 655f 7374 7275 6374 7572  e_table_structur
-0000d2e0: 6528 6e6f 6465 5b22 7363 6865 6d61 225d  e(node["schema"]
-0000d2f0: 290a 0a20 2020 2020 2020 205f 666f 726d  )..        _form
-0000d300: 6174 203d 2022 6373 7622 0a20 2020 2020  at = "csv".     
-0000d310: 2020 2066 6f72 2078 2069 6e20 636f 6c75     for x in colu
-0000d320: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-0000d330: 2069 6620 785b 2264 6566 6175 6c74 5f76   if x["default_v
-0000d340: 616c 7565 225d 2061 6e64 2078 5b22 6465  alue"] and x["de
-0000d350: 6661 756c 745f 7661 6c75 6522 5d2e 6c6f  fault_value"].lo
-0000d360: 7765 7228 292e 7374 6172 7473 7769 7468  wer().startswith
-0000d370: 2822 6d61 7465 7269 616c 697a 6564 2229  ("materialized")
-0000d380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d390: 2020 2320 7475 726e 2065 7870 7265 7373    # turn express
-0000d3a0: 696f 6e20 746f 2061 2073 656c 6563 7420  ion to a select 
-0000d3b0: 7175 6572 7920 746f 2073 716c 5f67 6574  query to sql_get
-0000d3c0: 5f75 7365 645f 7461 626c 6573 2063 616e  _used_tables can
-0000d3d0: 2067 6574 2074 6865 2075 7365 6420 7461   get the used ta
-0000d3e0: 626c 6573 0a20 2020 2020 2020 2020 2020  bles.           
-0000d3f0: 2020 2020 2071 203d 2022 7365 6c65 6374       q = "select
-0000d400: 2022 202b 2078 5b22 6465 6661 756c 745f   " + x["default_
-0000d410: 7661 6c75 6522 5d5b 6c65 6e28 226d 6174  value"][len("mat
-0000d420: 6572 6961 6c69 7a65 6422 2920 3a5d 0a20  erialized") :]. 
-0000d430: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000d440: 6162 6c65 7320 3d20 6177 6169 7420 7462  ables = await tb
-0000d450: 5f63 6c69 656e 742e 7371 6c5f 6765 745f  _client.sql_get_
-0000d460: 7573 6564 5f74 6162 6c65 7328 7129 0a20  used_tables(q). 
-0000d470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000d480: 206d 6174 6572 6961 6c69 7a65 6420 636f   materialized co
-0000d490: 6c75 6d6e 7320 6578 7072 6573 7369 6f6e  lumns expression
-0000d4a0: 7320 636f 756c 6420 6861 7665 206a 6f69  s could have joi
-0000d4b0: 6e73 2073 6f20 7765 206e 6565 6420 746f  ns so we need to
-0000d4c0: 2061 6464 2074 6865 6d20 6173 2061 2064   add them as a d
-0000d4d0: 6570 0a20 2020 2020 2020 2020 2020 2020  ep.             
-0000d4e0: 2020 2064 6570 7320 2b3d 2074 6162 6c65     deps += table
-0000d4f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000d500: 2020 2320 6765 6e65 7261 7465 2072 6570    # generate rep
-0000d510: 6c61 6365 6d65 6e74 7320 616e 6420 7265  lacements and re
-0000d520: 706c 6163 6520 7468 6520 7175 6572 790a  place the query.
-0000d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d540: 7265 706c 6163 656d 656e 7473 203d 207b  replacements = {
-0000d550: 743a 2074 202b 2072 6573 6f75 7263 655f  t: t + resource_
-0000d560: 7665 7273 696f 6e73 5f73 7472 696e 672e  versions_string.
-0000d570: 6765 7428 742c 2022 2229 2066 6f72 2074  get(t, "") for t
-0000d580: 2069 6e20 7461 626c 6573 7d0a 0a20 2020   in tables}..   
-0000d590: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-0000d5a0: 6c61 6365 645f 7265 7375 6c74 7320 3d20  laced_results = 
-0000d5b0: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
-0000d5c0: 7265 706c 6163 655f 7461 626c 6573 2871  replace_tables(q
-0000d5d0: 2c20 7265 706c 6163 656d 656e 7473 290a  , replacements).
-0000d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5f0: 785b 2264 6566 6175 6c74 5f76 616c 7565  x["default_value
-0000d600: 225d 203d 2072 6570 6c61 6365 645f 7265  "] = replaced_re
-0000d610: 7375 6c74 732e 7265 706c 6163 6528 2253  sults.replace("S
-0000d620: 454c 4543 5422 2c20 226d 6174 6572 6961  ELECT", "materia
-0000d630: 6c69 7a65 6422 2c20 3129 0a20 2020 2020  lized", 1).     
-0000d640: 2020 2020 2020 2069 6620 782e 6765 7428         if x.get(
-0000d650: 226a 736f 6e70 6174 6822 2c20 4e6f 6e65  "jsonpath", None
-0000d660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000d670: 2020 205f 666f 726d 6174 203d 2022 6e64     _format = "nd
-0000d680: 6a73 6f6e 220a 0a20 2020 2020 2020 2073  json"..        s
-0000d690: 6368 656d 6120 3d20 222c 222e 6a6f 696e  chema = ",".join
-0000d6a0: 2873 6368 656d 615f 746f 5f73 716c 5f63  (schema_to_sql_c
-0000d6b0: 6f6c 756d 6e73 2863 6f6c 756d 6e73 2929  olumns(columns))
-0000d6c0: 0a0a 2020 2020 2020 2020 6e61 6d65 203d  ..        name =
-0000d6d0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-0000d6e0: 6528 6669 6c65 6e61 6d65 292e 7273 706c  e(filename).rspl
-0000d6f0: 6974 2822 2e22 2c20 3129 5b30 5d0a 0a20  it(".", 1)[0].. 
-0000d700: 2020 2020 2020 2069 6620 776f 726b 7370         if worksp
-0000d710: 6163 655f 6c69 625f 7061 7468 733a 0a20  ace_lib_paths:. 
-0000d720: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0000d730: 6b5f 6e61 6d65 2c20 776b 5f70 6174 6820  k_name, wk_path 
-0000d740: 696e 2077 6f72 6b73 7061 6365 5f6c 6962  in workspace_lib
-0000d750: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
-0000d760: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d780: 2050 6174 6828 6669 6c65 6e61 6d65 292e   Path(filename).
-0000d790: 7265 6c61 7469 7665 5f74 6f28 776b 5f70  relative_to(wk_p
-0000d7a0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0000d7b0: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
-0000d7c0: 6622 7b77 6f72 6b73 7061 6365 5f6d 6170  f"{workspace_map
-0000d7d0: 2e67 6574 2877 6b5f 6e61 6d65 2c20 776b  .get(wk_name, wk
-0000d7e0: 5f6e 616d 6529 7d2e 7b6e 616d 657d 220a  _name)}.{name}".
-0000d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d800: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
-0000d810: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000d820: 2020 2020 2020 2023 2074 6865 2070 6174         # the pat
-0000d830: 6820 7761 7320 6e6f 7420 7265 6c61 7469  h was not relati
-0000d840: 7665 2c20 6e6f 7420 696e 7369 6465 2077  ve, not inside w
-0000d850: 6f72 6b73 7061 6365 0a20 2020 2020 2020  orkspace.       
-0000d860: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-0000d870: 730a 0a20 2020 2020 2020 2072 6573 5f6e  s..        res_n
-0000d880: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
-0000d890: 2020 2076 6572 7369 6f6e 203d 2066 225f     version = f"_
-0000d8a0: 5f76 7b64 6f63 2e76 6572 7369 6f6e 7d22  _v{doc.version}"
-0000d8b0: 2069 6620 646f 632e 7665 7273 696f 6e20   if doc.version 
-0000d8c0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-0000d8d0: 2022 220a 0a20 2020 2020 2020 2064 6566   ""..        def
-0000d8e0: 2061 7070 656e 645f 7665 7273 696f 6e5f   append_version_
-0000d8f0: 746f 5f6e 616d 6528 6e61 6d65 3a20 7374  to_name(name: st
-0000d900: 722c 2076 6572 7369 6f6e 3a20 7374 7229  r, version: str)
-0000d910: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000d920: 2020 2020 2069 6620 7665 7273 696f 6e20       if version 
-0000d930: 213d 2022 223a 0a20 2020 2020 2020 2020  != "":.         
-0000d940: 2020 2020 2020 206e 616d 6520 3d20 6e61         name = na
-0000d950: 6d65 2e72 6570 6c61 6365 2822 2e22 2c20  me.replace(".", 
-0000d960: 225f 2229 0a20 2020 2020 2020 2020 2020  "_").           
-0000d970: 2020 2020 2072 6574 7572 6e20 6e61 6d65       return name
-0000d980: 202b 2076 6572 7369 6f6e 0a20 2020 2020   + version.     
-0000d990: 2020 2020 2020 2072 6574 7572 6e20 6e61         return na
-0000d9a0: 6d65 0a0a 2020 2020 2020 2020 6465 7363  me..        desc
-0000d9b0: 7269 7074 696f 6e20 3d20 6e6f 6465 2e67  ription = node.g
-0000d9c0: 6574 2822 6465 7363 7269 7074 696f 6e22  et("description"
-0000d9d0: 2c20 2222 290a 2020 2020 2020 2020 696e  , "").        in
-0000d9e0: 6465 7865 735f 6c69 7374 203d 206e 6f64  dexes_list = nod
-0000d9f0: 652e 6765 7428 2269 6e64 6578 6573 222c  e.get("indexes",
-0000da00: 205b 5d29 0a20 2020 2020 2020 2069 6e64   []).        ind
-0000da10: 6578 6573 203d 204e 6f6e 650a 2020 2020  exes = None.    
-0000da20: 2020 2020 6966 2069 6e64 6578 6573 5f6c      if indexes_l
-0000da30: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-0000da40: 2069 6e64 6578 6573 203d 2022 5c6e 222e   indexes = "\n".
-0000da50: 6a6f 696e 285b 696e 6465 782e 746f 5f73  join([index.to_s
-0000da60: 716c 2829 2066 6f72 2069 6e64 6578 2069  ql() for index i
-0000da70: 6e20 696e 6465 7865 735f 6c69 7374 5d29  n indexes_list])
-0000da80: 0a20 2020 2020 2020 2070 6172 616d 7320  .        params 
-0000da90: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0000daa0: 226e 616d 6522 3a20 6170 7065 6e64 5f76  "name": append_v
-0000dab0: 6572 7369 6f6e 5f74 6f5f 6e61 6d65 286e  ersion_to_name(n
-0000dac0: 616d 652c 2076 6572 7369 6f6e 292c 0a20  ame, version),. 
-0000dad0: 2020 2020 2020 2020 2020 2022 6465 7363             "desc
-0000dae0: 7269 7074 696f 6e22 3a20 6465 7363 7269  ription": descri
-0000daf0: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
-0000db00: 2020 2022 7363 6865 6d61 223a 2073 6368     "schema": sch
-0000db10: 656d 612c 0a20 2020 2020 2020 2020 2020  ema,.           
-0000db20: 2022 696e 6465 7865 7322 3a20 696e 6465   "indexes": inde
-0000db30: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
-0000db40: 2022 696e 6465 7865 735f 6c69 7374 223a   "indexes_list":
-0000db50: 2069 6e64 6578 6573 5f6c 6973 742c 0a20   indexes_list,. 
-0000db60: 2020 2020 2020 2020 2020 2022 666f 726d             "form
-0000db70: 6174 223a 205f 666f 726d 6174 2c0a 2020  at": _format,.  
-0000db80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0000db90: 2070 6172 616d 732e 7570 6461 7465 2867   params.update(g
-0000dba0: 6574 5f65 6e67 696e 655f 7061 7261 6d73  et_engine_params
-0000dbb0: 286e 6f64 6529 290a 0a20 2020 2020 2020  (node))..       
-0000dbc0: 2069 6620 2269 6d70 6f72 745f 7365 7276   if "import_serv
-0000dbd0: 6963 6522 2069 6e20 6e6f 6465 206f 7220  ice" in node or 
-0000dbe0: 2269 6d70 6f72 745f 636f 6e6e 6563 7469  "import_connecti
-0000dbf0: 6f6e 5f6e 616d 6522 2069 6e20 6e6f 6465  on_name" in node
-0000dc00: 3a0a 2020 2020 2020 2020 2020 2020 5641  :.            VA
-0000dc10: 4c49 445f 5345 5256 4943 4553 3a20 5475  LID_SERVICES: Tu
-0000dc20: 706c 655b 7374 722c 202e 2e2e 5d20 3d20  ple[str, ...] = 
-0000dc30: 2822 6269 6771 7565 7279 222c 2022 736e  ("bigquery", "sn
-0000dc40: 6f77 666c 616b 6522 2c20 2273 3322 2c20  owflake", "s3", 
-0000dc50: 2273 335f 6961 6d72 6f6c 6522 2c20 2267  "s3_iamrole", "g
-0000dc60: 6373 2229 0a0a 2020 2020 2020 2020 2020  cs")..          
-0000dc70: 2020 696d 706f 7274 5f70 6172 616d 7320    import_params 
-0000dc80: 3d20 6177 6169 7420 6765 745f 696d 706f  = await get_impo
-0000dc90: 7274 5f70 6172 616d 7328 7061 7261 6d73  rt_params(params
-0000dca0: 2c20 6e6f 6465 290a 0a20 2020 2020 2020  , node)..       
-0000dcb0: 2020 2020 2073 6572 7669 6365 203d 2069       service = i
-0000dcc0: 6d70 6f72 745f 7061 7261 6d73 2e67 6574  mport_params.get
-0000dcd0: 2822 696d 706f 7274 5f73 6572 7669 6365  ("import_service
-0000dce0: 222c 204e 6f6e 6529 0a20 2020 2020 2020  ", None).       
-0000dcf0: 2020 2020 2069 6620 7365 7276 6963 6520       if service 
-0000dd00: 616e 6420 7365 7276 6963 6520 6e6f 7420  and service not 
-0000dd10: 696e 2056 414c 4944 5f53 4552 5649 4345  in VALID_SERVICE
-0000dd20: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
-0000dd30: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0000dd40: 6f6e 2866 2255 6e6b 6e6f 776e 2069 6d70  on(f"Unknown imp
-0000dd50: 6f72 7420 7365 7276 6963 653a 207b 7365  ort service: {se
-0000dd60: 7276 6963 657d 2229 0a0a 2020 2020 2020  rvice}")..      
-0000dd70: 2020 2020 2020 6966 2073 6572 7669 6365        if service
-0000dd80: 2069 6e20 5052 4556 4945 575f 434f 4e4e   in PREVIEW_CONN
-0000dd90: 4543 544f 525f 5345 5256 4943 4553 3a0a  ECTOR_SERVICES:.
-0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddb0: 4f4e 5f44 454d 414e 445f 4352 4f4e 203d  ON_DEMAND_CRON =
-0000ddc0: 204f 4e5f 4445 4d41 4e44 0a20 2020 2020   ON_DEMAND.     
-0000ddd0: 2020 2020 2020 2020 2020 2041 5554 4f5f             AUTO_
-0000dde0: 4352 4f4e 203d 2022 4061 7574 6f22 0a20  CRON = "@auto". 
-0000ddf0: 2020 2020 2020 2020 2020 2020 2020 204f                 O
-0000de00: 4e5f 4445 4d41 4e44 5f43 524f 4e5f 4558  N_DEMAND_CRON_EX
-0000de10: 5045 4354 4544 5f42 595f 5448 455f 4150  PECTED_BY_THE_AP
-0000de20: 4920 3d20 2240 6f6e 6365 220a 2020 2020  I = "@once".    
-0000de30: 2020 2020 2020 2020 2020 2020 5641 4c49              VALI
-0000de40: 445f 4352 4f4e 533a 2054 7570 6c65 5b73  D_CRONS: Tuple[s
-0000de50: 7472 2c20 2e2e 2e5d 203d 2028 4f4e 5f44  tr, ...] = (ON_D
-0000de60: 454d 414e 445f 4352 4f4e 2c20 4155 544f  EMAND_CRON, AUTO
-0000de70: 5f43 524f 4e29 0a20 2020 2020 2020 2020  _CRON).         
-0000de80: 2020 2020 2020 2063 726f 6e20 3d20 6e6f         cron = no
-0000de90: 6465 2e67 6574 2822 696d 706f 7274 5f73  de.get("import_s
-0000dea0: 6368 6564 756c 6522 2c20 4f4e 5f44 454d  chedule", ON_DEM
-0000deb0: 414e 445f 4352 4f4e 290a 0a20 2020 2020  AND_CRON)..     
-0000dec0: 2020 2020 2020 2020 2020 2069 6620 6372             if cr
-0000ded0: 6f6e 206e 6f74 2069 6e20 5641 4c49 445f  on not in VALID_
-0000dee0: 4352 4f4e 533a 0a20 2020 2020 2020 2020  CRONS:.         
-0000def0: 2020 2020 2020 2020 2020 2076 616c 6964             valid
-0000df00: 5f76 616c 7565 7320 3d20 222c 2022 2e6a  _values = ", ".j
-0000df10: 6f69 6e28 5641 4c49 445f 4352 4f4e 5329  oin(VALID_CRONS)
-0000df20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000df30: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0000df40: 7469 6f6e 2866 2249 6e76 616c 6964 2069  tion(f"Invalid i
-0000df50: 6d70 6f72 7420 7363 6865 6475 6c65 3a20  mport schedule: 
-0000df60: 277b 6372 6f6e 7d27 2e20 5661 6c69 6420  '{cron}'. Valid 
-0000df70: 7661 6c75 6573 2061 7265 3a20 7b76 616c  values are: {val
-0000df80: 6964 5f76 616c 7565 737d 2229 0a0a 2020  id_values}")..  
-0000df90: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000dfa0: 2063 726f 6e20 3d3d 204f 4e5f 4445 4d41   cron == ON_DEMA
-0000dfb0: 4e44 5f43 524f 4e3a 0a20 2020 2020 2020  ND_CRON:.       
-0000dfc0: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
-0000dfd0: 6f72 745f 7061 7261 6d73 5b22 696d 706f  ort_params["impo
-0000dfe0: 7274 5f73 6368 6564 756c 6522 5d20 3d20  rt_schedule"] = 
-0000dff0: 4f4e 5f44 454d 414e 445f 4352 4f4e 5f45  ON_DEMAND_CRON_E
-0000e000: 5850 4543 5445 445f 4259 5f54 4845 5f41  XPECTED_BY_THE_A
-0000e010: 5049 0a20 2020 2020 2020 2020 2020 2020  PI.             
-0000e020: 2020 2069 6620 6372 6f6e 203d 3d20 4155     if cron == AU
-0000e030: 544f 5f43 524f 4e20 616e 6420 6375 7272  TO_CRON and curr
-0000e040: 656e 745f 7773 3a0a 2020 2020 2020 2020  ent_ws:.        
-0000e050: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0000e060: 7370 6163 6573 203d 2028 6177 6169 7420  spaces = (await 
-0000e070: 7462 5f63 6c69 656e 742e 7573 6572 5f77  tb_client.user_w
-0000e080: 6f72 6b73 7061 6365 7328 2929 2e67 6574  orkspaces()).get
-0000e090: 2822 776f 726b 7370 6163 6573 222c 205b  ("workspaces", [
-0000e0a0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-0000e0b0: 2020 2020 2020 2072 6174 655f 6c69 6d69         rate_limi
-0000e0c0: 7473 3a20 4469 6374 5b73 7472 2c20 4469  ts: Dict[str, Di
-0000e0d0: 6374 5b73 7472 2c20 696e 745d 5d20 3d20  ct[str, int]] = 
-0000e0e0: 6e65 7874 280a 2020 2020 2020 2020 2020  next(.          
-0000e0f0: 2020 2020 2020 2020 2020 2020 2020 2877                (w
-0000e100: 2e67 6574 2822 7261 7465 5f6c 696d 6974  .get("rate_limit
-0000e110: 7322 2c20 7b7d 2920 666f 7220 7720 696e  s", {}) for w in
-0000e120: 2077 6f72 6b73 7061 6365 7320 6966 2077   workspaces if w
-0000e130: 5b22 6964 225d 203d 3d20 6375 7272 656e  ["id"] == curren
-0000e140: 745f 7773 5b22 6964 225d 292c 207b 7d0a  t_ws["id"]), {}.
-0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e160: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000e170: 2020 2020 2020 2020 2020 7065 7269 6f64            period
-0000e180: 3a20 696e 7420 3d20 7261 7465 5f6c 696d  : int = rate_lim
-0000e190: 6974 732e 6765 7428 2261 7069 5f64 6174  its.get("api_dat
-0000e1a0: 6173 6f75 7263 6573 5f63 7265 6174 655f  asources_create_
-0000e1b0: 6170 7065 6e64 5f72 6570 6c61 6365 222c  append_replace",
-0000e1c0: 207b 7d29 2e67 6574 2822 7065 7269 6f64   {}).get("period
-0000e1d0: 222c 2036 3029 0a0a 2020 2020 2020 2020  ", 60)..        
-0000e1e0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-0000e1f0: 7365 636f 6e64 735f 746f 5f63 726f 6e5f  seconds_to_cron_
-0000e200: 6578 7072 6573 7369 6f6e 2873 6563 6f6e  expression(secon
-0000e210: 6473 3a20 696e 7429 202d 3e20 7374 723a  ds: int) -> str:
-0000e220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e230: 2020 2020 2020 2020 206d 696e 7574 6573           minutes
-0000e240: 203d 2073 6563 6f6e 6473 202f 2f20 3630   = seconds // 60
-0000e250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e260: 2020 2020 2020 2020 2068 6f75 7273 203d           hours =
-0000e270: 206d 696e 7574 6573 202f 2f20 3630 0a20   minutes // 60. 
-0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e290: 2020 2020 2020 2064 6179 7320 3d20 686f         days = ho
-0000e2a0: 7572 7320 2f2f 2032 340a 2020 2020 2020  urs // 24.      
-0000e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2c0: 2020 6966 2064 6179 7320 3e20 303a 0a20    if days > 0:. 
-0000e2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000e2f0: 6e20 6622 3020 3020 2a2f 7b64 6179 737d  n f"0 0 */{days}
-0000e300: 202a 202a 220a 2020 2020 2020 2020 2020   * *".          
-0000e310: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e320: 2068 6f75 7273 203e 2030 3a0a 2020 2020   hours > 0:.    
-0000e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e340: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0000e350: 2230 202a 2f7b 686f 7572 737d 202a 202a  "0 */{hours} * *
-0000e360: 202a 220a 2020 2020 2020 2020 2020 2020   *".            
-0000e370: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0000e380: 696e 7574 6573 203e 2030 3a0a 2020 2020  inutes > 0:.    
-0000e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3a0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0000e3b0: 222a 2f7b 6d69 6e75 7465 737d 202a 202a  "*/{minutes} * *
-0000e3c0: 202a 202a 220a 2020 2020 2020 2020 2020   * *".          
-0000e3d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000e3e0: 7475 726e 2066 222a 2f7b 7365 636f 6e64  turn f"*/{second
-0000e3f0: 737d 202a 202a 202a 202a 220a 0a20 2020  s} * * * *"..   
-0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e410: 2069 6d70 6f72 745f 7061 7261 6d73 5b22   import_params["
-0000e420: 696d 706f 7274 5f73 6368 6564 756c 6522  import_schedule"
-0000e430: 5d20 3d20 7365 636f 6e64 735f 746f 5f63  ] = seconds_to_c
-0000e440: 726f 6e5f 6578 7072 6573 7369 6f6e 2870  ron_expression(p
-0000e450: 6572 696f 6429 0a0a 2020 2020 2020 2020  eriod)..        
-0000e460: 2020 2020 2320 496e 636c 7564 6520 616c      # Include al
-0000e470: 6c20 696d 706f 7274 5f20 7061 7261 6d65  l import_ parame
-0000e480: 7465 7273 2069 6e20 7468 6520 6461 7461  ters in the data
-0000e490: 736f 7572 6365 2070 6172 616d 730a 2020  source params.  
-0000e4a0: 2020 2020 2020 2020 2020 7061 7261 6d73            params
-0000e4b0: 2e75 7064 6174 6528 696d 706f 7274 5f70  .update(import_p
-0000e4c0: 6172 616d 7329 0a0a 2020 2020 2020 2020  arams)..        
-0000e4d0: 2020 2020 2320 5375 6273 7469 7475 7465      # Substitute
-0000e4e0: 2074 6865 2069 6d70 6f72 7420 7061 7261   the import para
-0000e4f0: 6d65 7465 7273 2077 6974 6820 7468 6520  meters with the 
-0000e500: 6f6e 6573 2075 7365 6420 6279 2074 6865  ones used by the
-0000e510: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-0000e520: 6d70 6f72 7420 4150 493a 0a20 2020 2020  mport API:.     
-0000e530: 2020 2020 2020 2023 202d 2049 6620 616e         # - If an
-0000e540: 2069 6d70 6f72 7420 7061 7261 6d65 7465   import paramete
-0000e550: 7220 6973 206e 6f74 2070 7265 7365 6e74  r is not present
-0000e560: 2061 6e64 2074 6865 7265 2773 2061 2064   and there's a d
-0000e570: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
-0000e580: 2020 2023 2020 2076 616c 7565 2c20 7573     #   value, us
-0000e590: 6520 7468 6520 6465 6661 756c 7420 7661  e the default va
-0000e5a0: 6c75 652e 0a20 2020 2020 2020 2020 2020  lue..           
-0000e5b0: 2023 202d 2049 6620 7468 6520 7265 7375   # - If the resu
-0000e5c0: 6c74 696e 6720 7661 6c75 6520 6973 204e  lting value is N
-0000e5d0: 6f6e 652c 2064 6f20 6e6f 7420 6164 6420  one, do not add 
-0000e5e0: 7468 6520 7061 7261 6d65 7465 722e 0a20  the parameter.. 
-0000e5f0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
-0000e600: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
-0000e610: 2061 6e79 2075 6e6b 6e6f 776e 2069 6d70   any unknown imp
-0000e620: 6f72 745f 2070 6172 616d 6574 6572 2069  ort_ parameter i
-0000e630: 7320 6c65 6176 6564 2061 7320 6973 2e0a  s leaved as is..
-0000e640: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000e650: 6b65 7920 696e 2049 6d70 6f72 7452 6570  key in ImportRep
-0000e660: 6c61 6365 6d65 6e74 732e 6765 745f 6461  lacements.get_da
-0000e670: 7461 6669 6c65 5f70 6172 616d 6574 6572  tafile_parameter
-0000e680: 5f6b 6579 7328 293a 0a20 2020 2020 2020  _keys():.       
-0000e690: 2020 2020 2020 2020 2072 6570 6c61 6365           replace
-0000e6a0: 6d65 6e74 2c20 6465 6661 756c 745f 7661  ment, default_va
-0000e6b0: 6c75 6520 3d20 496d 706f 7274 5265 706c  lue = ImportRepl
-0000e6c0: 6163 656d 656e 7473 2e67 6574 5f61 7069  acements.get_api
-0000e6d0: 5f70 6172 616d 5f66 6f72 5f64 6174 6166  _param_for_dataf
-0000e6e0: 696c 655f 7061 7261 6d28 7365 7276 6963  ile_param(servic
-0000e6f0: 652c 206b 6579 290a 2020 2020 2020 2020  e, key).        
-0000e700: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
-0000e710: 6570 6c61 6365 6d65 6e74 3a0a 2020 2020  eplacement:.    
-0000e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e730: 636f 6e74 696e 7565 2020 2320 5765 2073  continue  # We s
-0000e740: 686f 756c 6420 6e6f 7420 7265 6163 6820  hould not reach 
-0000e750: 7468 6973 206e 6576 6572 2c20 6275 7420  this never, but 
-0000e760: 6a75 7374 2069 6e20 6361 7365 2e2e 2e0a  just in case....
-0000e770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e780: 2076 616c 7565 3a20 416e 790a 2020 2020   value: Any.    
-0000e790: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000e7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e7b0: 2020 2020 2076 616c 7565 203d 2070 6172       value = par
-0000e7c0: 616d 735b 6b65 795d 0a20 2020 2020 2020  ams[key].       
-0000e7d0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0000e7e0: 2070 6172 616d 735b 6b65 795d 0a20 2020   params[key].   
-0000e7f0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000e800: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-0000e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e820: 2020 7661 6c75 6520 3d20 6465 6661 756c    value = defaul
-0000e830: 745f 7661 6c75 650a 0a20 2020 2020 2020  t_value..       
-0000e840: 2020 2020 2020 2020 2069 6620 7661 6c75           if valu
-0000e850: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e860: 2020 2020 2020 2070 6172 616d 735b 7265         params[re
-0000e870: 706c 6163 656d 656e 745d 203d 2076 616c  placement] = val
-0000e880: 7565 0a0a 2020 2020 2020 2020 6966 2022  ue..        if "
-0000e890: 6b61 666b 615f 636f 6e6e 6563 7469 6f6e  kafka_connection
-0000e8a0: 5f6e 616d 6522 2069 6e20 6e6f 6465 3a0a  _name" in node:.
-0000e8b0: 2020 2020 2020 2020 2020 2020 6b61 666b              kafk
-0000e8c0: 615f 7061 7261 6d73 203d 2061 7761 6974  a_params = await
-0000e8d0: 2067 6574 5f6b 6166 6b61 5f70 6172 616d   get_kafka_param
-0000e8e0: 7328 6e6f 6465 290a 2020 2020 2020 2020  s(node).        
-0000e8f0: 2020 2020 7061 7261 6d73 2e75 7064 6174      params.updat
-0000e900: 6528 6b61 666b 615f 7061 7261 6d73 290a  e(kafka_params).
-0000e910: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-0000e920: 7061 7261 6d73 5b22 666f 726d 6174 225d  params["format"]
-0000e930: 0a0a 2020 2020 2020 2020 6966 2022 7461  ..        if "ta
-0000e940: 6773 2220 696e 206e 6f64 653a 0a20 2020  gs" in node:.   
-0000e950: 2020 2020 2020 2020 2074 6167 7320 3d20           tags = 
-0000e960: 7b6b 3a20 765b 305d 2066 6f72 206b 2c20  {k: v[0] for k, 
-0000e970: 7620 696e 2075 726c 6c69 622e 7061 7273  v in urllib.pars
-0000e980: 652e 7061 7273 655f 7173 286e 6f64 655b  e.parse_qs(node[
-0000e990: 2274 6167 7322 5d29 2e69 7465 6d73 2829  "tags"]).items()
-0000e9a0: 7d0a 2020 2020 2020 2020 2020 2020 7061  }.            pa
-0000e9b0: 7261 6d73 2e75 7064 6174 6528 7461 6773  rams.update(tags
-0000e9c0: 290a 0a20 2020 2020 2020 2072 6573 6f75  )..        resou
-0000e9d0: 7263 6573 3a20 4c69 7374 5b44 6963 745b  rces: List[Dict[
-0000e9e0: 7374 722c 2041 6e79 5d5d 203d 205b 5d0a  str, Any]] = [].
-0000e9f0: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-0000ea00: 6573 2e61 7070 656e 6428 0a20 2020 2020  es.append(.     
-0000ea10: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0000ea20: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
-0000ea30: 6365 223a 2022 6461 7461 736f 7572 6365  ce": "datasource
-0000ea40: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0000ea50: 2020 2020 2272 6573 6f75 7263 655f 6e61      "resource_na
-0000ea60: 6d65 223a 206e 616d 652c 0a20 2020 2020  me": name,.     
-0000ea70: 2020 2020 2020 2020 2020 2022 7665 7273             "vers
-0000ea80: 696f 6e22 3a20 646f 632e 7665 7273 696f  ion": doc.versio
-0000ea90: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0000eaa0: 2020 2022 7061 7261 6d73 223a 2070 6172     "params": par
-0000eab0: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-0000eac0: 2020 2020 2022 6669 6c65 6e61 6d65 223a       "filename":
-0000ead0: 2066 696c 656e 616d 652c 0a20 2020 2020   filename,.     
-0000eae0: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
-0000eaf0: 223a 2064 6f63 2e6b 6579 732c 0a20 2020  ": doc.keys,.   
-0000eb00: 2020 2020 2020 2020 2020 2020 2022 6465               "de
-0000eb10: 7073 223a 2064 6570 732c 0a20 2020 2020  ps": deps,.     
-0000eb20: 2020 2020 2020 2020 2020 2022 746f 6b65             "toke
-0000eb30: 6e73 223a 2064 6f63 2e74 6f6b 656e 732c  ns": doc.tokens,
-0000eb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eb50: 2022 7368 6172 6564 5f77 6974 6822 3a20   "shared_with": 
-0000eb60: 646f 632e 7368 6172 6564 5f77 6974 682c  doc.shared_with,
-0000eb70: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0000eb80: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000eb90: 2020 2320 6765 6e65 7261 7465 2065 7874    # generate ext
-0000eba0: 7261 2072 6573 6f75 7263 6573 2069 6e20  ra resources in 
-0000ebb0: 6361 7365 206f 6620 7468 6520 6b65 790a  case of the key.
-0000ebc0: 2020 2020 2020 2020 6966 2064 6f63 2e6b          if doc.k
-0000ebd0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-0000ebe0: 2066 6f72 206b 2069 6e20 646f 632e 6b65   for k in doc.ke
-0000ebf0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-0000ec00: 2020 2020 7265 736f 7572 6365 7320 2b3d      resources +=
-0000ec10: 2067 656e 6572 6174 655f 7265 736f 7572   generate_resour
-0000ec20: 6365 5f66 6f72 5f6b 6579 286b 5b22 636f  ce_for_key(k["co
-0000ec30: 6c75 6d6e 225d 2c20 6e61 6d65 2c20 7061  lumn"], name, pa
-0000ec40: 7261 6d73 5b22 7363 6865 6d61 225d 2c20  rams["schema"], 
-0000ec50: 7665 7273 696f 6e2c 2072 6573 5f6e 616d  version, res_nam
-0000ec60: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0000ec70: 2020 2023 2073 6574 2064 6572 6976 6564     # set derived
-0000ec80: 2072 6573 6f75 7263 6573 2076 6572 7369   resources versi
-0000ec90: 6f6e 2074 6865 2073 616d 6520 7468 6520  on the same the 
-0000eca0: 7061 7265 6e74 0a20 2020 2020 2020 2020  parent.         
-0000ecb0: 2020 2020 2020 2066 6f72 2078 2069 6e20         for x in 
-0000ecc0: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
-0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-0000ece0: 5b22 7665 7273 696f 6e22 5d20 3d20 646f  ["version"] = do
-0000ecf0: 632e 7665 7273 696f 6e0a 0a20 2020 2020  c.version..     
-0000ed00: 2020 2072 6574 7572 6e20 7265 736f 7572     return resour
-0000ed10: 6365 730a 0a20 2020 2065 6c69 6620 4461  ces..    elif Da
-0000ed20: 7461 4669 6c65 4578 7465 6e73 696f 6e73  taFileExtensions
-0000ed30: 2e50 4950 4520 696e 2066 696c 656e 616d  .PIPE in filenam
-0000ed40: 653a 0a20 2020 2020 2020 2064 6f63 203d  e:.        doc =
-0000ed50: 2070 6172 7365 5f70 6970 6528 6669 6c65   parse_pipe(file
-0000ed60: 6e61 6d65 290a 2020 2020 2020 2020 7665  name).        ve
-0000ed70: 7273 696f 6e20 3d20 6622 5f5f 767b 646f  rsion = f"__v{do
-0000ed80: 632e 7665 7273 696f 6e7d 2220 6966 2064  c.version}" if d
-0000ed90: 6f63 2e76 6572 7369 6f6e 2069 7320 6e6f  oc.version is no
-0000eda0: 7420 4e6f 6e65 2065 6c73 6520 2222 0a20  t None else "". 
-0000edb0: 2020 2020 2020 206e 616d 6520 3d20 6f73         name = os
-0000edc0: 2e70 6174 682e 6261 7365 6e61 6d65 2866  .path.basename(f
-0000edd0: 696c 656e 616d 6529 2e73 706c 6974 2822  ilename).split("
-0000ede0: 2e22 295b 305d 0a20 2020 2020 2020 2064  .")[0].        d
-0000edf0: 6573 6372 6970 7469 6f6e 203d 2064 6f63  escription = doc
-0000ee00: 2e64 6573 6372 6970 7469 6f6e 2069 6620  .description if 
-0000ee10: 646f 632e 6465 7363 7269 7074 696f 6e20  doc.description 
-0000ee20: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-0000ee30: 2022 220a 0a20 2020 2020 2020 2064 6570   ""..        dep
-0000ee40: 7320 3d20 5b5d 0a20 2020 2020 2020 206e  s = [].        n
-0000ee50: 6f64 6573 3a20 4c69 7374 5b44 6963 745b  odes: List[Dict[
-0000ee60: 7374 722c 2041 6e79 5d5d 203d 205b 5d0a  str, Any]] = [].
-0000ee70: 0a20 2020 2020 2020 2066 6f72 206e 6f64  .        for nod
-0000ee80: 6520 696e 2064 6f63 2e6e 6f64 6573 3a0a  e in doc.nodes:.
-0000ee90: 2020 2020 2020 2020 2020 2020 7371 6c20              sql 
-0000eea0: 3d20 6e6f 6465 5b22 7371 6c22 5d0a 2020  = node["sql"].  
-0000eeb0: 2020 2020 2020 2020 2020 6e6f 6465 5f74            node_t
-0000eec0: 7970 6520 3d20 6e6f 6465 2e67 6574 2822  ype = node.get("
-0000eed0: 7479 7065 222c 2022 7374 616e 6461 7264  type", "standard
-0000eee0: 2229 2e6c 6f77 6572 2829 0a20 2020 2020  ").lower().     
-0000eef0: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
-0000ef00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0000ef10: 2020 226e 616d 6522 3a20 6e6f 6465 5b22    "name": node["
-0000ef20: 6e61 6d65 225d 2c0a 2020 2020 2020 2020  name"],.        
-0000ef30: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-0000ef40: 6e6f 6465 5f74 7970 652c 0a20 2020 2020  node_type,.     
-0000ef50: 2020 2020 2020 2020 2020 2022 6465 7363             "desc
-0000ef60: 7269 7074 696f 6e22 3a20 6e6f 6465 2e67  ription": node.g
-0000ef70: 6574 2822 6465 7363 7269 7074 696f 6e22  et("description"
-0000ef80: 2c20 2222 292c 0a20 2020 2020 2020 2020  , ""),.         
-0000ef90: 2020 2020 2020 2022 7461 7267 6574 5f64         "target_d
-0000efa0: 6174 6173 6f75 7263 6522 3a20 6e6f 6465  atasource": node
-0000efb0: 2e67 6574 2822 7461 7267 6574 5f64 6174  .get("target_dat
-0000efc0: 6173 6f75 7263 6522 2c20 4e6f 6e65 292c  asource", None),
-0000efd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000efe0: 2022 636f 7079 5f73 6368 6564 756c 6522   "copy_schedule"
-0000eff0: 3a20 6e6f 6465 2e67 6574 2843 6f70 7950  : node.get(CopyP
-0000f000: 6172 616d 6574 6572 732e 434f 5059 5f53  arameters.COPY_S
-0000f010: 4348 4544 554c 452c 204e 6f6e 6529 2c0a  CHEDULE, None),.
-0000f020: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-0000f030: 2020 2020 2020 2020 2020 2069 735f 6578             is_ex
-0000f040: 706f 7274 5f6e 6f64 6520 3d20 4578 706f  port_node = Expo
-0000f050: 7274 5265 706c 6163 656d 656e 7473 2e69  rtReplacements.i
-0000f060: 735f 6578 706f 7274 5f6e 6f64 6528 6e6f  s_export_node(no
-0000f070: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-0000f080: 6578 706f 7274 5f70 6172 616d 7320 3d20  export_params = 
-0000f090: 4578 706f 7274 5265 706c 6163 656d 656e  ExportReplacemen
-0000f0a0: 7473 2e67 6574 5f70 6172 616d 735f 6672  ts.get_params_fr
-0000f0b0: 6f6d 5f64 6174 6166 696c 6528 6e6f 6465  om_datafile(node
-0000f0c0: 2920 6966 2069 735f 6578 706f 7274 5f6e  ) if is_export_n
-0000f0d0: 6f64 6520 656c 7365 204e 6f6e 650a 0a20  ode else None.. 
-0000f0e0: 2020 2020 2020 2020 2020 2073 716c 203d             sql =
-0000f0f0: 2073 716c 2e73 7472 6970 2829 0a20 2020   sql.strip().   
-0000f100: 2020 2020 2020 2020 2069 735f 7465 6d70           is_temp
-0000f110: 6c61 7465 203d 2046 616c 7365 0a20 2020  late = False.   
-0000f120: 2020 2020 2020 2020 2069 6620 7371 6c5b           if sql[
-0000f130: 305d 203d 3d20 2225 223a 0a20 2020 2020  0] == "%":.     
-0000f140: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f160: 2020 2020 7371 6c5f 7265 6e64 6572 6564      sql_rendered
-0000f170: 2c20 5f20 3d20 7265 6e64 6572 5f73 716c  , _ = render_sql
-0000f180: 5f74 656d 706c 6174 6528 7371 6c5b 313a  _template(sql[1:
-0000f190: 5d2c 2074 6573 745f 6d6f 6465 3d54 7275  ], test_mode=Tru
-0000f1a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0000f1b0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0000f1c0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0000f1d0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000f1e0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0000f1f0: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-0000f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f210: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-0000f220: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
-0000f230: 6e6f 6465 286e 6f64 653d 6e6f 6465 5b22  node(node=node["
-0000f240: 6e61 6d65 225d 2c20 7069 7065 3d6e 616d  name"], pipe=nam
-0000f250: 652c 2065 7272 6f72 3d73 7472 2865 2929  e, error=str(e))
-0000f260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f270: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000f280: 2020 2020 2020 2069 735f 7465 6d70 6c61         is_templa
-0000f290: 7465 203d 2054 7275 650a 2020 2020 2020  te = True.      
-0000f2a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000f2b0: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
-0000f2c0: 7265 6e64 6572 6564 203d 2073 716c 0a0a  rendered = sql..
-0000f2d0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000f2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f2f0: 2064 6570 656e 6465 6e63 6965 7320 3d20   dependencies = 
-0000f300: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
-0000f310: 7371 6c5f 6765 745f 7573 6564 5f74 6162  sql_get_used_tab
-0000f320: 6c65 7328 7371 6c5f 7265 6e64 6572 6564  les(sql_rendered
-0000f330: 2c20 7261 6973 696e 673d 5472 7565 290a  , raising=True).
-0000f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f350: 6465 7073 202b 3d20 5b74 2066 6f72 2074  deps += [t for t
-0000f360: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
-0000f370: 2069 6620 7420 6e6f 7420 696e 205b 6e5b   if t not in [n[
-0000f380: 226e 616d 6522 5d20 666f 7220 6e20 696e  "name"] for n in
-0000f390: 2064 6f63 2e6e 6f64 6573 5d5d 0a0a 2020   doc.nodes]]..  
-0000f3a0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000f3b0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0000f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f3d0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-0000f3e0: 636b 4578 6365 7074 696f 6e28 0a20 2020  ckException(.   
-0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f400: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
-0000f410: 2e65 7272 6f72 5f70 6172 7369 6e67 5f6e  .error_parsing_n
-0000f420: 6f64 6528 6e6f 6465 3d6e 6f64 655b 226e  ode(node=node["n
-0000f430: 616d 6522 5d2c 2070 6970 653d 6e61 6d65  ame"], pipe=name
-0000f440: 2c20 6572 726f 723d 7374 7228 6529 290a  , error=str(e)).
-0000f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f460: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0000f470: 6620 6973 5f74 656d 706c 6174 653a 0a20  f is_template:. 
-0000f480: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000f490: 6570 7320 2b3d 2067 6574 5f75 7365 645f  eps += get_used_
-0000f4a0: 7461 626c 6573 5f69 6e5f 7465 6d70 6c61  tables_in_templa
-0000f4b0: 7465 2873 716c 5b31 3a5d 290a 0a20 2020  te(sql[1:])..   
-0000f4c0: 2020 2020 2020 2020 2069 735f 6e65 6974           is_neit
-0000f4d0: 6865 725f 636f 7079 5f6e 6f72 5f6d 6174  her_copy_nor_mat
-0000f4e0: 6572 6961 6c69 7a65 6420 3d20 2264 6174  erialized = "dat
-0000f4f0: 6173 6f75 7263 6522 206e 6f74 2069 6e20  asource" not in 
-0000f500: 6e6f 6465 2061 6e64 2022 7461 7267 6574  node and "target
-0000f510: 5f64 6174 6173 6f75 7263 6522 206e 6f74  _datasource" not
-0000f520: 2069 6e20 6e6f 6465 0a20 2020 2020 2020   in node.       
-0000f530: 2020 2020 2069 6620 2265 6e67 696e 6522       if "engine"
-0000f540: 2069 6e20 6e6f 6465 2061 6e64 2069 735f   in node and is_
-0000f550: 6e65 6974 6865 725f 636f 7079 5f6e 6f72  neither_copy_nor
-0000f560: 5f6d 6174 6572 6961 6c69 7a65 643a 0a20  _materialized:. 
-0000f570: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f580: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000f590: 2244 6566 696e 696e 6720 454e 4749 4e45  "Defining ENGINE
-0000f5a0: 206f 7074 696f 6e73 2069 6e20 6120 6e6f   options in a no
-0000f5b0: 6465 2072 6571 7569 7265 7320 6120 4441  de requires a DA
-0000f5c0: 5441 534f 5552 4345 2229 0a0a 2020 2020  TASOURCE")..    
-0000f5d0: 2020 2020 2020 2020 6966 2022 6461 7461          if "data
-0000f5e0: 736f 7572 6365 2220 696e 206e 6f64 653a  source" in node:
-0000f5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f600: 2070 6172 616d 735b 2264 6174 6173 6f75   params["datasou
-0000f610: 7263 6522 5d20 3d20 6e6f 6465 5b22 6461  rce"] = node["da
-0000f620: 7461 736f 7572 6365 225d 202b 2072 6573  tasource"] + res
-0000f630: 6f75 7263 655f 7665 7273 696f 6e73 5f73  ource_versions_s
-0000f640: 7472 696e 672e 6765 7428 6e6f 6465 5b22  tring.get(node["
-0000f650: 6461 7461 736f 7572 6365 225d 2c20 2222  datasource"], ""
-0000f660: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f670: 2020 6465 7073 202b 3d20 5b6e 6f64 655b    deps += [node[
-0000f680: 2264 6174 6173 6f75 7263 6522 5d5d 0a0a  "datasource"]]..
-0000f690: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-0000f6a0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
-0000f6b0: 6522 2069 6e20 6e6f 6465 3a0a 2020 2020  e" in node:.    
-0000f6c0: 2020 2020 2020 2020 2020 2020 7061 7261              para
-0000f6d0: 6d73 5b22 7461 7267 6574 5f64 6174 6173  ms["target_datas
-0000f6e0: 6f75 7263 6522 5d20 3d20 6e6f 6465 5b22  ource"] = node["
-0000f6f0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
-0000f700: 6522 5d20 2b20 7265 736f 7572 6365 5f76  e"] + resource_v
-0000f710: 6572 7369 6f6e 735f 7374 7269 6e67 2e67  ersions_string.g
-0000f720: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-0000f730: 2020 2020 2020 2020 6e6f 6465 5b22 7461          node["ta
-0000f740: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
-0000f750: 5d2c 2022 220a 2020 2020 2020 2020 2020  ], "".          
-0000f760: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000f770: 2020 2020 2020 2020 6465 7073 202b 3d20          deps += 
-0000f780: 5b6e 6f64 655b 2274 6172 6765 745f 6461  [node["target_da
-0000f790: 7461 736f 7572 6365 225d 5d0a 0a20 2020  tasource"]]..   
-0000f7a0: 2020 2020 2020 2020 2070 6172 616d 732e           params.
-0000f7b0: 7570 6461 7465 2867 6574 5f65 6e67 696e  update(get_engin
-0000f7c0: 655f 7061 7261 6d73 286e 6f64 6529 290a  e_params(node)).
-0000f7d0: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
-0000f7e0: 2063 7265 6174 655f 7265 706c 6163 656d   create_replacem
-0000f7f0: 656e 745f 666f 725f 7265 736f 7572 6365  ent_for_resource
-0000f800: 286e 616d 653a 2073 7472 2920 2d3e 2073  (name: str) -> s
-0000f810: 7472 3a0a 2020 2020 2020 2020 2020 2020  tr:.            
-0000f820: 2020 2020 666f 7220 6f6c 645f 7773 2c20      for old_ws, 
-0000f830: 6e65 775f 7773 2069 6e20 776f 726b 7370  new_ws in worksp
-0000f840: 6163 655f 6d61 702e 6974 656d 7328 293a  ace_map.items():
-0000f850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f860: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
-0000f870: 2e72 6570 6c61 6365 2866 227b 6f6c 645f  .replace(f"{old_
-0000f880: 7773 7d2e 222c 2066 227b 6e65 775f 7773  ws}.", f"{new_ws
-0000f890: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
-0000f8a0: 2020 2020 2072 6574 7572 6e20 6e61 6d65       return name
-0000f8b0: 202b 2072 6573 6f75 7263 655f 7665 7273   + resource_vers
-0000f8c0: 696f 6e73 5f73 7472 696e 672e 6765 7428  ions_string.get(
-0000f8d0: 6e61 6d65 2c20 2222 290a 0a20 2020 2020  name, "")..     
-0000f8e0: 2020 2020 2020 2072 6570 6c61 6365 6d65         replaceme
-0000f8f0: 6e74 7320 3d20 7b0a 2020 2020 2020 2020  nts = {.        
-0000f900: 2020 2020 2020 2020 783a 2063 7265 6174          x: creat
-0000f910: 655f 7265 706c 6163 656d 656e 745f 666f  e_replacement_fo
-0000f920: 725f 7265 736f 7572 6365 2878 2920 666f  r_resource(x) fo
-0000f930: 7220 7820 696e 2064 6570 7320 6966 2078  r x in deps if x
-0000f940: 206e 6f74 2069 6e20 5b6e 5b22 6e61 6d65   not in [n["name
-0000f950: 225d 2066 6f72 206e 2069 6e20 646f 632e  "] for n in doc.
-0000f960: 6e6f 6465 735d 0a20 2020 2020 2020 2020  nodes].         
-0000f970: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0000f980: 2020 2320 4649 584d 453a 2049 6465 616c    # FIXME: Ideal
-0000f990: 6c79 2077 6520 7368 6f75 6c64 2075 7365  ly we should use
-0000f9a0: 2061 7761 6974 2074 625f 636c 6965 6e74   await tb_client
-0000f9b0: 2e72 6570 6c61 6365 5f74 6162 6c65 7328  .replace_tables(
-0000f9c0: 7371 6c2c 2072 6570 6c61 6365 6d65 6e74  sql, replacement
-0000f9d0: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-0000f9e0: 6f72 206f 6c64 2c20 6e65 7720 696e 2072  or old, new in r
-0000f9f0: 6570 6c61 6365 6d65 6e74 732e 6974 656d  eplacements.item
-0000fa00: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000fa10: 2020 2020 2073 716c 203d 2072 652e 7375       sql = re.su
-0000fa20: 6228 2228 5b5c 7420 5c5c 6e27 5d2b 7c5e  b("([\t \\n']+|^
-0000fa30: 2922 202b 206f 6c64 202b 2022 285b 5c74  )" + old + "([\t
-0000fa40: 205c 5c6e 275c 5c29 5d2b 7c24 2922 2c20   \\n'\\)]+|$)", 
-0000fa50: 225c 5c31 2220 2b20 6e65 7720 2b20 225c  "\\1" + new + "\
-0000fa60: 5c32 222c 2073 716c 290a 0a20 2020 2020  \2", sql)..     
-0000fa70: 2020 2020 2020 2069 6620 2274 6167 7322         if "tags"
-0000fa80: 2069 6e20 6e6f 6465 3a0a 2020 2020 2020   in node:.      
-0000fa90: 2020 2020 2020 2020 2020 7461 6773 203d            tags =
-0000faa0: 207b 6b3a 2076 5b30 5d20 666f 7220 6b2c   {k: v[0] for k,
-0000fab0: 2076 2069 6e20 7572 6c6c 6962 2e70 6172   v in urllib.par
-0000fac0: 7365 2e70 6172 7365 5f71 7328 6e6f 6465  se.parse_qs(node
-0000fad0: 5b22 7461 6773 225d 292e 6974 656d 7328  ["tags"]).items(
-0000fae0: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
-0000faf0: 2020 2070 6172 616d 732e 7570 6461 7465     params.update
-0000fb00: 2874 6167 7329 0a0a 2020 2020 2020 2020  (tags)..        
-0000fb10: 2020 2020 6e6f 6465 732e 6170 7065 6e64      nodes.append
-0000fb20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000fb30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0000fb40: 2020 2020 2020 2020 2273 716c 223a 2073          "sql": s
-0000fb50: 716c 2c0a 2020 2020 2020 2020 2020 2020  ql,.            
-0000fb60: 2020 2020 2020 2020 2270 6172 616d 7322          "params"
-0000fb70: 3a20 7061 7261 6d73 2c0a 2020 2020 2020  : params,.      
-0000fb80: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-0000fb90: 7870 6f72 745f 7061 7261 6d73 223a 2065  xport_params": e
-0000fba0: 7870 6f72 745f 7061 7261 6d73 2c0a 2020  xport_params,.  
-0000fbb0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0000fbc0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000fbd0: 2020 2020 2020 2072 6574 7572 6e20 5b0a         return [.
-0000fbe0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0000fc00: 6573 6f75 7263 6522 3a20 2270 6970 6573  esource": "pipes
-0000fc10: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000fc20: 2020 2022 7265 736f 7572 6365 5f6e 616d     "resource_nam
-0000fc30: 6522 3a20 6e61 6d65 2c0a 2020 2020 2020  e": name,.      
-0000fc40: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
-0000fc50: 6f6e 223a 2064 6f63 2e76 6572 7369 6f6e  on": doc.version
-0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fc70: 2020 2266 696c 656e 616d 6522 3a20 6669    "filename": fi
-0000fc80: 6c65 6e61 6d65 2c0a 2020 2020 2020 2020  lename,.        
-0000fc90: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-0000fca0: 6e61 6d65 202b 2076 6572 7369 6f6e 2c0a  name + version,.
-0000fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcc0: 226e 6f64 6573 223a 206e 6f64 6573 2c0a  "nodes": nodes,.
-0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fce0: 2264 6570 7322 3a20 5b78 2066 6f72 2078  "deps": [x for x
-0000fcf0: 2069 6e20 7365 7428 6465 7073 295d 2c0a   in set(deps)],.
-0000fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd10: 2274 6f6b 656e 7322 3a20 646f 632e 746f  "tokens": doc.to
-0000fd20: 6b65 6e73 2c0a 2020 2020 2020 2020 2020  kens,.          
-0000fd30: 2020 2020 2020 2264 6573 6372 6970 7469        "descripti
-0000fd40: 6f6e 223a 2064 6573 6372 6970 7469 6f6e  on": description
-0000fd50: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-0000fd60: 2020 2020 2020 2020 5d0a 2020 2020 656c          ].    el
-0000fd70: 6966 2044 6174 6146 696c 6545 7874 656e  if DataFileExten
-0000fd80: 7369 6f6e 732e 544f 4b45 4e20 696e 2066  sions.TOKEN in f
-0000fd90: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
-0000fda0: 2064 6f63 203d 2070 6172 7365 5f74 6f6b   doc = parse_tok
-0000fdb0: 656e 2866 696c 656e 616d 6529 0a20 2020  en(filename).   
-0000fdc0: 2020 2020 206e 616d 6520 3d20 6f73 2e70       name = os.p
-0000fdd0: 6174 682e 6261 7365 6e61 6d65 2866 696c  ath.basename(fil
-0000fde0: 656e 616d 6529 2e73 706c 6974 2844 6174  ename).split(Dat
-0000fdf0: 6146 696c 6545 7874 656e 7369 6f6e 732e  aFileExtensions.
-0000fe00: 544f 4b45 4e29 5b30 5d0a 2020 2020 2020  TOKEN)[0].      
-0000fe10: 2020 6465 7363 7269 7074 696f 6e20 3d20    description = 
-0000fe20: 646f 632e 6465 7363 7269 7074 696f 6e20  doc.description 
-0000fe30: 6f72 2022 220a 2020 2020 2020 2020 7665  or "".        ve
-0000fe40: 7273 696f 6e20 3d20 6622 5f5f 767b 646f  rsion = f"__v{do
-0000fe50: 632e 7665 7273 696f 6e7d 2220 6966 2064  c.version}" if d
-0000fe60: 6f63 2e76 6572 7369 6f6e 2069 7320 6e6f  oc.version is no
-0000fe70: 7420 4e6f 6e65 2065 6c73 6520 2222 0a20  t None else "". 
-0000fe80: 2020 2020 2020 2073 636f 7065 7320 3d20         scopes = 
-0000fe90: 646f 632e 6e6f 6465 7320 6f72 205b 5d0a  doc.nodes or [].
-0000fea0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-0000feb0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0000fec0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000fed0: 7265 736f 7572 6365 223a 2022 746f 6b65  resource": "toke
-0000fee0: 6e73 222c 0a20 2020 2020 2020 2020 2020  ns",.           
-0000fef0: 2020 2020 2022 7265 736f 7572 6365 5f6e       "resource_n
-0000ff00: 616d 6522 3a20 6e61 6d65 2c0a 2020 2020  ame": name,.    
-0000ff10: 2020 2020 2020 2020 2020 2020 2276 6572              "ver
-0000ff20: 7369 6f6e 223a 2064 6f63 2e76 6572 7369  sion": doc.versi
-0000ff30: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0000ff40: 2020 2020 2266 696c 656e 616d 6522 3a20      "filename": 
-0000ff50: 6669 6c65 6e61 6d65 2c0a 2020 2020 2020  filename,.      
-0000ff60: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
-0000ff70: 3a20 6e61 6d65 202b 2076 6572 7369 6f6e  : name + version
-0000ff80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ff90: 2020 2273 636f 7065 7322 3a20 7363 6f70    "scopes": scop
-0000ffa0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0000ffb0: 2020 2020 2264 6573 6372 6970 7469 6f6e      "description
-0000ffc0: 223a 2064 6573 6372 6970 7469 6f6e 2c0a  ": description,.
-0000ffd0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0000ffe0: 2020 2020 2020 5d0a 2020 2020 656c 7365        ].    else
-0000fff0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00010000: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-00010010: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-00010020: 6167 6572 2e65 7272 6f72 5f66 696c 655f  ager.error_file_
-00010030: 6578 7465 6e73 696f 6e28 6669 6c65 6e61  extension(filena
-00010040: 6d65 3d66 696c 656e 616d 6529 290a 0a0a  me=filename))...
-00010050: 6465 6620 6675 6c6c 5f70 6174 685f 6279  def full_path_by
-00010060: 5f6e 616d 6528 0a20 2020 2066 6f6c 6465  _name(.    folde
-00010070: 723a 2073 7472 2c20 6e61 6d65 3a20 7374  r: str, name: st
-00010080: 722c 2077 6f72 6b73 7061 6365 5f6c 6962  r, workspace_lib
-00010090: 5f70 6174 6873 3a20 4f70 7469 6f6e 616c  _paths: Optional
-000100a0: 5b4c 6973 745b 5475 706c 655b 7374 722c  [List[Tuple[str,
-000100b0: 2073 7472 5d5d 5d20 3d20 4e6f 6e65 0a29   str]]] = None.)
-000100c0: 202d 3e20 4f70 7469 6f6e 616c 5b50 6174   -> Optional[Pat
-000100d0: 685d 3a0a 2020 2020 6620 3d20 5061 7468  h]:.    f = Path
-000100e0: 2866 6f6c 6465 7229 0a20 2020 2064 7320  (folder).    ds 
-000100f0: 3d20 6e61 6d65 202b 2022 2e64 6174 6173  = name + ".datas
-00010100: 6f75 7263 6522 0a20 2020 2069 6620 6f73  ource".    if os
-00010110: 2e70 6174 682e 6973 6669 6c65 286f 732e  .path.isfile(os.
-00010120: 7061 7468 2e6a 6f69 6e28 666f 6c64 6572  path.join(folder
-00010130: 2c20 6473 2929 3a0a 2020 2020 2020 2020  , ds)):.        
-00010140: 7265 7475 726e 2066 202f 2064 730a 2020  return f / ds.  
-00010150: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-00010160: 696c 6528 6620 2f20 2264 6174 6173 6f75  ile(f / "datasou
-00010170: 7263 6573 2220 2f20 6473 293a 0a20 2020  rces" / ds):.   
-00010180: 2020 2020 2072 6574 7572 6e20 6620 2f20       return f / 
-00010190: 2264 6174 6173 6f75 7263 6573 2220 2f20  "datasources" / 
-000101a0: 6473 0a0a 2020 2020 7069 7065 203d 206e  ds..    pipe = n
-000101b0: 616d 6520 2b20 222e 7069 7065 220a 2020  ame + ".pipe".  
-000101c0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-000101d0: 696c 6528 6f73 2e70 6174 682e 6a6f 696e  ile(os.path.join
-000101e0: 2866 6f6c 6465 722c 2070 6970 6529 293a  (folder, pipe)):
-000101f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010200: 6620 2f20 7069 7065 0a0a 2020 2020 6966  f / pipe..    if
-00010210: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-00010220: 6620 2f20 2265 6e64 706f 696e 7473 2220  f / "endpoints" 
-00010230: 2f20 7069 7065 293a 0a20 2020 2020 2020  / pipe):.       
-00010240: 2072 6574 7572 6e20 6620 2f20 2265 6e64   return f / "end
-00010250: 706f 696e 7473 2220 2f20 7069 7065 0a0a  points" / pipe..
-00010260: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
-00010270: 7366 696c 6528 6620 2f20 2270 6970 6573  sfile(f / "pipes
-00010280: 2220 2f20 7069 7065 293a 0a20 2020 2020  " / pipe):.     
-00010290: 2020 2072 6574 7572 6e20 6620 2f20 2270     return f / "p
-000102a0: 6970 6573 2220 2f20 7069 7065 0a0a 2020  ipes" / pipe..  
-000102b0: 2020 746f 6b65 6e20 3d20 6e61 6d65 202b    token = name +
-000102c0: 2022 2e74 6f6b 656e 220a 2020 2020 6966   ".token".    if
-000102d0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-000102e0: 6620 2f20 2274 6f6b 656e 7322 202f 2074  f / "tokens" / t
-000102f0: 6f6b 656e 293a 0a20 2020 2020 2020 2072  oken):.        r
-00010300: 6574 7572 6e20 6620 2f20 2274 6f6b 656e  eturn f / "token
-00010310: 7322 202f 2074 6f6b 656e 0a0a 2020 2020  s" / token..    
-00010320: 6966 2077 6f72 6b73 7061 6365 5f6c 6962  if workspace_lib
-00010330: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
-00010340: 666f 7220 776b 5f6e 616d 652c 2077 6b5f  for wk_name, wk_
-00010350: 7061 7468 2069 6e20 776f 726b 7370 6163  path in workspac
-00010360: 655f 6c69 625f 7061 7468 733a 0a20 2020  e_lib_paths:.   
-00010370: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
-00010380: 2e73 7461 7274 7377 6974 6828 6622 7b77  .startswith(f"{w
-00010390: 6b5f 6e61 6d65 7d2e 2229 3a0a 2020 2020  k_name}."):.    
-000103a0: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-000103b0: 6675 6c6c 5f70 6174 685f 6279 5f6e 616d  full_path_by_nam
-000103c0: 6528 776b 5f70 6174 682c 206e 616d 652e  e(wk_path, name.
-000103d0: 7265 706c 6163 6528 6622 7b77 6b5f 6e61  replace(f"{wk_na
-000103e0: 6d65 7d2e 222c 2022 2229 290a 2020 2020  me}.", "")).    
-000103f0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00010400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010410: 2020 2020 2020 7265 7475 726e 2072 0a20        return r. 
-00010420: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00010430: 0a64 6566 2066 696e 645f 6669 6c65 5f62  .def find_file_b
-00010440: 795f 6e61 6d65 280a 2020 2020 666f 6c64  y_name(.    fold
-00010450: 6572 3a20 7374 722c 0a20 2020 206e 616d  er: str,.    nam
-00010460: 653a 2073 7472 2c0a 2020 2020 7665 7262  e: str,.    verb
-00010470: 6f73 653a 2062 6f6f 6c20 3d20 4661 6c73  ose: bool = Fals
-00010480: 652c 0a20 2020 2069 735f 7261 773a 2062  e,.    is_raw: b
-00010490: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-000104a0: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
-000104b0: 6174 6873 3a20 4f70 7469 6f6e 616c 5b4c  aths: Optional[L
-000104c0: 6973 745b 5475 706c 655b 7374 722c 2073  ist[Tuple[str, s
-000104d0: 7472 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  tr]]] = None,.  
-000104e0: 2020 7265 736f 7572 6365 3a20 4f70 7469    resource: Opti
-000104f0: 6f6e 616c 5b44 6963 745d 203d 204e 6f6e  onal[Dict] = Non
-00010500: 652c 0a29 3a0a 2020 2020 6620 3d20 5061  e,.):.    f = Pa
-00010510: 7468 2866 6f6c 6465 7229 0a20 2020 2064  th(folder).    d
-00010520: 7320 3d20 6e61 6d65 202b 2022 2e64 6174  s = name + ".dat
-00010530: 6173 6f75 7263 6522 0a20 2020 2069 6620  asource".    if 
-00010540: 6f73 2e70 6174 682e 6973 6669 6c65 286f  os.path.isfile(o
-00010550: 732e 7061 7468 2e6a 6f69 6e28 666f 6c64  s.path.join(fold
-00010560: 6572 2c20 6473 2929 3a0a 2020 2020 2020  er, ds)):.      
-00010570: 2020 7265 7475 726e 2064 732c 204e 6f6e    return ds, Non
-00010580: 650a 2020 2020 6966 206f 732e 7061 7468  e.    if os.path
-00010590: 2e69 7366 696c 6528 6620 2f20 2264 6174  .isfile(f / "dat
-000105a0: 6173 6f75 7263 6573 2220 2f20 6473 293a  asources" / ds):
-000105b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000105c0: 6473 2c20 4e6f 6e65 0a0a 2020 2020 7069  ds, None..    pi
-000105d0: 7065 203d 206e 616d 6520 2b20 222e 7069  pe = name + ".pi
-000105e0: 7065 220a 2020 2020 6966 206f 732e 7061  pe".    if os.pa
-000105f0: 7468 2e69 7366 696c 6528 6f73 2e70 6174  th.isfile(os.pat
-00010600: 682e 6a6f 696e 2866 6f6c 6465 722c 2070  h.join(folder, p
-00010610: 6970 6529 293a 0a20 2020 2020 2020 2072  ipe)):.        r
-00010620: 6574 7572 6e20 7069 7065 2c20 4e6f 6e65  eturn pipe, None
-00010630: 0a0a 2020 2020 6966 206f 732e 7061 7468  ..    if os.path
-00010640: 2e69 7366 696c 6528 6620 2f20 2265 6e64  .isfile(f / "end
-00010650: 706f 696e 7473 2220 2f20 7069 7065 293a  points" / pipe):
-00010660: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010670: 7069 7065 2c20 4e6f 6e65 0a0a 2020 2020  pipe, None..    
-00010680: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-00010690: 6528 6620 2f20 2270 6970 6573 2220 2f20  e(f / "pipes" / 
-000106a0: 7069 7065 293a 0a20 2020 2020 2020 2072  pipe):.        r
-000106b0: 6574 7572 6e20 7069 7065 2c20 4e6f 6e65  eturn pipe, None
-000106c0: 0a0a 2020 2020 746f 6b65 6e20 3d20 6e61  ..    token = na
-000106d0: 6d65 202b 2022 2e74 6f6b 656e 220a 2020  me + ".token".  
-000106e0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-000106f0: 696c 6528 6620 2f20 2274 6f6b 656e 7322  ile(f / "tokens"
-00010700: 202f 2074 6f6b 656e 293a 0a20 2020 2020   / token):.     
-00010710: 2020 2072 6574 7572 6e20 746f 6b65 6e2c     return token,
-00010720: 204e 6f6e 650a 0a20 2020 2023 206c 6f6f   None..    # loo
-00010730: 6b20 666f 7220 7468 6520 6669 6c65 2069  k for the file i
-00010740: 6e20 7375 6264 6972 6563 746f 7269 6573  n subdirectories
-00010750: 2069 6620 6974 2773 206e 6f74 2066 6f75   if it's not fou
-00010760: 6e64 2069 6e20 6461 7461 736f 7572 6365  nd in datasource
-00010770: 7320 666f 6c64 6572 0a20 2020 2069 6620  s folder.    if 
-00010780: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
-00010790: 7468 733a 0a20 2020 2020 2020 205f 7265  ths:.        _re
-000107a0: 736f 7572 6365 203d 204e 6f6e 650a 2020  source = None.  
-000107b0: 2020 2020 2020 666f 7220 776b 5f6e 616d        for wk_nam
-000107c0: 652c 2077 6b5f 7061 7468 2069 6e20 776f  e, wk_path in wo
-000107d0: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
-000107e0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
-000107f0: 696c 6520 3d20 4e6f 6e65 0a20 2020 2020  ile = None.     
-00010800: 2020 2020 2020 2069 6620 6e61 6d65 2e73         if name.s
-00010810: 7461 7274 7377 6974 6828 6622 7b77 6b5f  tartswith(f"{wk_
-00010820: 6e61 6d65 7d2e 2229 3a0a 2020 2020 2020  name}."):.      
-00010830: 2020 2020 2020 2020 2020 6669 6c65 2c20            file, 
-00010840: 5f72 6573 6f75 7263 6520 3d20 6669 6e64  _resource = find
-00010850: 5f66 696c 655f 6279 5f6e 616d 6528 0a20  _file_by_name(. 
-00010860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010870: 2020 2077 6b5f 7061 7468 2c20 6e61 6d65     wk_path, name
-00010880: 2e72 6570 6c61 6365 2866 227b 776b 5f6e  .replace(f"{wk_n
-00010890: 616d 657d 2e22 2c20 2222 292c 2076 6572  ame}.", ""), ver
-000108a0: 626f 7365 2c20 6973 5f72 6177 2c20 7265  bose, is_raw, re
-000108b0: 736f 7572 6365 3d72 6573 6f75 7263 650a  source=resource.
-000108c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000108e0: 2066 696c 653a 0a20 2020 2020 2020 2020   file:.         
-000108f0: 2020 2020 2020 2072 6574 7572 6e20 6669         return fi
-00010900: 6c65 2c20 5f72 6573 6f75 7263 650a 0a20  le, _resource.. 
-00010910: 2020 2069 6620 6e6f 7420 6973 5f72 6177     if not is_raw
-00010920: 3a0a 2020 2020 2020 2020 662c 2072 6177  :.        f, raw
-00010930: 203d 2066 696e 645f 6669 6c65 5f62 795f   = find_file_by_
-00010940: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
-00010950: 2020 666f 6c64 6572 2c0a 2020 2020 2020    folder,.      
-00010960: 2020 2020 2020 6765 745f 6465 705f 6672        get_dep_fr
-00010970: 6f6d 5f72 6177 5f74 6162 6c65 7328 6e61  om_raw_tables(na
-00010980: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
-00010990: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
-000109a0: 2c0a 2020 2020 2020 2020 2020 2020 6973  ,.            is
-000109b0: 5f72 6177 3d54 7275 652c 0a20 2020 2020  _raw=True,.     
-000109c0: 2020 2020 2020 2077 6f72 6b73 7061 6365         workspace
-000109d0: 5f6c 6962 5f70 6174 6873 3d77 6f72 6b73  _lib_paths=works
-000109e0: 7061 6365 5f6c 6962 5f70 6174 6873 2c0a  pace_lib_paths,.
-000109f0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-00010a00: 7572 6365 3d72 6573 6f75 7263 652c 0a20  urce=resource,. 
-00010a10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010a20: 2072 6574 7572 6e20 662c 2072 6177 0a0a   return f, raw..
-00010a30: 2020 2020 2320 6d61 7465 7269 616c 697a      # materializ
-00010a40: 6564 206e 6f64 6520 7769 7468 2044 4154  ed node with DAT
-00010a50: 4153 4f55 5243 4520 6465 6669 6e69 7469  ASOURCE definiti
-00010a60: 6f6e 0a20 2020 2069 6620 7265 736f 7572  on.    if resour
-00010a70: 6365 2061 6e64 2022 6e6f 6465 7322 2069  ce and "nodes" i
-00010a80: 6e20 7265 736f 7572 6365 3a0a 2020 2020  n resource:.    
-00010a90: 2020 2020 666f 7220 6e6f 6465 2069 6e20      for node in 
-00010aa0: 7265 736f 7572 6365 5b22 6e6f 6465 7322  resource["nodes"
-00010ab0: 5d3a 0a20 2020 2020 2020 2020 2020 2070  ]:.            p
-00010ac0: 6172 616d 7320 3d20 6e6f 6465 2e67 6574  arams = node.get
-00010ad0: 2822 7061 7261 6d73 222c 207b 7d29 0a20  ("params", {}). 
-00010ae0: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
-00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b00: 7061 7261 6d73 2e67 6574 2822 7479 7065  params.get("type
-00010b10: 222c 204e 6f6e 6529 203d 3d20 226d 6174  ", None) == "mat
-00010b20: 6572 6961 6c69 7a65 6422 0a20 2020 2020  erialized".     
-00010b30: 2020 2020 2020 2020 2020 2061 6e64 2070             and p
-00010b40: 6172 616d 732e 6765 7428 2265 6e67 696e  arams.get("engin
-00010b50: 6522 2c20 4e6f 6e65 290a 2020 2020 2020  e", None).      
-00010b60: 2020 2020 2020 2020 2020 616e 6420 7061            and pa
-00010b70: 7261 6d73 2e67 6574 2822 6461 7461 736f  rams.get("dataso
-00010b80: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
-00010b90: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-00010ba0: 2020 2020 2020 2020 2020 2020 7069 7065              pipe
-00010bb0: 203d 2072 6573 6f75 7263 655b 2272 6573   = resource["res
-00010bc0: 6f75 7263 655f 6e61 6d65 225d 202b 2022  ource_name"] + "
-00010bd0: 2e70 6970 6522 0a20 2020 2020 2020 2020  .pipe".         
-00010be0: 2020 2020 2020 2070 6970 655f 6669 6c65         pipe_file
-00010bf0: 5f65 7869 7374 7320 3d20 280a 2020 2020  _exists = (.    
-00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c10: 6f73 2e70 6174 682e 6973 6669 6c65 286f  os.path.isfile(o
-00010c20: 732e 7061 7468 2e6a 6f69 6e28 666f 6c64  s.path.join(fold
-00010c30: 6572 2c20 7069 7065 2929 0a20 2020 2020  er, pipe)).     
-00010c40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00010c50: 7220 6f73 2e70 6174 682e 6973 6669 6c65  r os.path.isfile
-00010c60: 2866 202f 2022 656e 6470 6f69 6e74 7322  (f / "endpoints"
-00010c70: 202f 2070 6970 6529 0a20 2020 2020 2020   / pipe).       
-00010c80: 2020 2020 2020 2020 2020 2020 206f 7220               or 
-00010c90: 6f73 2e70 6174 682e 6973 6669 6c65 2866  os.path.isfile(f
-00010ca0: 202f 2022 7069 7065 7322 202f 2070 6970   / "pipes" / pip
-00010cb0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00010cc0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00010cd0: 2020 2020 2069 735f 7461 7267 6574 5f64       is_target_d
-00010ce0: 6174 6173 6f75 7263 6520 3d20 7061 7261  atasource = para
-00010cf0: 6d73 5b22 6461 7461 736f 7572 6365 225d  ms["datasource"]
-00010d00: 203d 3d20 6e61 6d65 0a20 2020 2020 2020   == name.       
-00010d10: 2020 2020 2020 2020 2069 6620 7069 7065           if pipe
-00010d20: 5f66 696c 655f 6578 6973 7473 2061 6e64  _file_exists and
-00010d30: 2069 735f 7461 7267 6574 5f64 6174 6173   is_target_datas
-00010d40: 6f75 7263 653a 0a20 2020 2020 2020 2020  ource:.         
-00010d50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010d60: 6e20 7069 7065 2c20 7b22 7265 736f 7572  n pipe, {"resour
-00010d70: 6365 5f6e 616d 6522 3a20 7061 7261 6d73  ce_name": params
-00010d80: 2e67 6574 2822 6461 7461 736f 7572 6365  .get("datasource
-00010d90: 2229 7d0a 0a20 2020 2069 6620 7665 7262  ")}..    if verb
-00010da0: 6f73 653a 0a20 2020 2020 2020 2063 6c69  ose:.        cli
-00010db0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-00010dc0: 4d61 6e61 6765 722e 7761 726e 696e 675f  Manager.warning_
-00010dd0: 6669 6c65 5f6e 6f74 5f66 6f75 6e64 5f69  file_not_found_i
-00010de0: 6e73 6964 6528 6e61 6d65 3d6e 616d 652c  nside(name=name,
-00010df0: 2066 6f6c 6465 723d 666f 6c64 6572 2929   folder=folder))
-00010e00: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
-00010e10: 652c 204e 6f6e 650a 0a0a 6465 6620 6472  e, None...def dr
-00010e20: 6f70 5f74 6f6b 656e 2875 726c 3a20 7374  op_token(url: st
-00010e30: 7229 202d 3e20 7374 723a 0a20 2020 2022  r) -> str:.    "
-00010e40: 2222 0a20 2020 2064 726f 7073 2074 6f6b  "".    drops tok
-00010e50: 656e 2070 6172 616d 2066 726f 6d20 7468  en param from th
-00010e60: 6520 7572 6c20 7175 6572 7920 7374 7269  e url query stri
-00010e70: 6e67 0a20 2020 203e 3e3e 2064 726f 705f  ng.    >>> drop_
-00010e80: 746f 6b65 6e28 2768 7474 7073 3a2f 2f61  token('https://a
-00010e90: 7069 2e74 696e 7962 6972 642e 636f 2f76  pi.tinybird.co/v
-00010ea0: 302f 7069 7065 732f 6161 612e 6a73 6f6e  0/pipes/aaa.json
-00010eb0: 3f74 6f6b 656e 3d61 6263 6426 613d 3127  ?token=abcd&a=1'
-00010ec0: 290a 2020 2020 2768 7474 7073 3a2f 2f61  ).    'https://a
-00010ed0: 7069 2e74 696e 7962 6972 642e 636f 2f76  pi.tinybird.co/v
-00010ee0: 302f 7069 7065 732f 6161 612e 6a73 6f6e  0/pipes/aaa.json
-00010ef0: 3f61 3d31 270a 2020 2020 3e3e 3e20 6472  ?a=1'.    >>> dr
-00010f00: 6f70 5f74 6f6b 656e 2827 6874 7470 733a  op_token('https:
-00010f10: 2f2f 6170 692e 7469 6e79 6269 7264 2e63  //api.tinybird.c
-00010f20: 6f2f 7630 2f70 6970 6573 2f61 6161 2e6a  o/v0/pipes/aaa.j
-00010f30: 736f 6e3f 613d 3127 290a 2020 2020 2768  son?a=1').    'h
-00010f40: 7474 7073 3a2f 2f61 7069 2e74 696e 7962  ttps://api.tinyb
-00010f50: 6972 642e 636f 2f76 302f 7069 7065 732f  ird.co/v0/pipes/
-00010f60: 6161 612e 6a73 6f6e 3f61 3d31 270a 2020  aaa.json?a=1'.  
-00010f70: 2020 2222 220a 2020 2020 7061 7273 6564    """.    parsed
-00010f80: 203d 2075 726c 7061 7273 6528 7572 6c29   = urlparse(url)
-00010f90: 0a20 2020 2071 7320 3d20 7061 7273 655f  .    qs = parse_
-00010fa0: 7173 2870 6172 7365 642e 7175 6572 7929  qs(parsed.query)
-00010fb0: 0a20 2020 2071 735f 7369 6d70 6c69 6679  .    qs_simplify
-00010fc0: 203d 207b 6b3a 2076 5b30 5d20 666f 7220   = {k: v[0] for 
-00010fd0: 6b2c 2076 2069 6e20 7173 2e69 7465 6d73  k, v in qs.items
-00010fe0: 2829 7d20 2023 2063 6861 6e67 6520 7365  ()}  # change se
-00010ff0: 7665 7261 6c20 6172 6775 6d65 6e74 7320  veral arguments 
-00011000: 746f 2073 696e 676c 6520 6f6e 650a 2020  to single one.  
-00011010: 2020 6966 2022 746f 6b65 6e22 2069 6e20    if "token" in 
-00011020: 7173 5f73 696d 706c 6966 793a 0a20 2020  qs_simplify:.   
-00011030: 2020 2020 2064 656c 2071 735f 7369 6d70       del qs_simp
-00011040: 6c69 6679 5b22 746f 6b65 6e22 5d0a 2020  lify["token"].  
-00011050: 2020 7265 7475 726e 2066 227b 7061 7273    return f"{pars
-00011060: 6564 2e73 6368 656d 657d 3a2f 2f7b 7061  ed.scheme}://{pa
-00011070: 7273 6564 2e6e 6574 6c6f 637d 7b70 6172  rsed.netloc}{par
-00011080: 7365 642e 7061 7468 7d3f 7b75 726c 656e  sed.path}?{urlen
-00011090: 636f 6465 2871 735f 7369 6d70 6c69 6679  code(qs_simplify
-000110a0: 297d 220a 0a0a 6465 6620 6e6f 726d 616c  )}"...def normal
-000110b0: 697a 655f 6172 7261 7928 6974 656d 733a  ize_array(items:
-000110c0: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
-000110d0: 4f70 7469 6f6e 616c 5b41 6e79 5d5d 5d29  Optional[Any]]])
-000110e0: 202d 3e20 4c69 7374 5b44 6963 745d 3a0a   -> List[Dict]:.
-000110f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00011100: 536f 7274 6564 2829 2064 6f65 736e 2774  Sorted() doesn't
-00011110: 206e 6f74 2073 7570 706f 7274 2076 616c   not support val
-00011120: 7565 7320 7769 7468 2064 6966 6665 7265  ues with differe
-00011130: 6e74 2074 7970 6573 2066 6f72 2074 6865  nt types for the
-00011140: 2073 616d 6520 636f 6c75 6d6e 206c 696b   same column lik
-00011150: 6520 4e6f 6e65 2076 7320 7374 722e 0a20  e None vs str.. 
-00011160: 2020 2020 2020 2053 6f2c 2077 6520 6e65         So, we ne
-00011170: 6564 2074 6f20 6361 7374 2061 6c6c 204e  ed to cast all N
-00011180: 6f6e 6520 746f 2064 6566 6175 6c74 2076  one to default v
-00011190: 616c 7565 206f 6620 7468 6520 7479 7065  alue of the type
-000111a0: 206f 6620 7468 6520 636f 6c75 6d6e 2069   of the column i
-000111b0: 6620 6578 6973 7420 616e 6420 6966 2061  f exist and if a
-000111c0: 6c6c 2074 6865 2076 616c 7565 7320 6172  ll the values ar
-000111d0: 6520 4e6f 6e65 2c20 7765 2063 616e 206c  e None, we can l
-000111e0: 6561 7665 2074 6865 6d20 6173 204e 6f6e  eave them as Non
-000111f0: 650a 2020 2020 3e3e 3e20 6e6f 726d 616c  e.    >>> normal
-00011200: 697a 655f 6172 7261 7928 5b7b 2778 273a  ize_array([{'x':
-00011210: 2027 6865 6c6c 6f20 576f 726c 6427 7d2c   'hello World'},
-00011220: 207b 2778 273a 204e 6f6e 657d 5d29 0a20   {'x': None}]). 
-00011230: 2020 205b 7b27 7827 3a20 2768 656c 6c6f     [{'x': 'hello
-00011240: 2057 6f72 6c64 277d 2c20 7b27 7827 3a20   World'}, {'x': 
-00011250: 2727 7d5d 0a20 2020 203e 3e3e 206e 6f72  ''}].    >>> nor
-00011260: 6d61 6c69 7a65 5f61 7272 6179 285b 7b27  malize_array([{'
-00011270: 7827 3a20 337d 2c20 7b27 7827 3a20 4e6f  x': 3}, {'x': No
-00011280: 6e65 7d5d 290a 2020 2020 5b7b 2778 273a  ne}]).    [{'x':
-00011290: 2033 7d2c 207b 2778 273a 2030 7d5d 0a20   3}, {'x': 0}]. 
-000112a0: 2020 203e 3e3e 206e 6f72 6d61 6c69 7a65     >>> normalize
-000112b0: 5f61 7272 6179 285b 7b27 7827 3a20 7b27  _array([{'x': {'
-000112c0: 7927 3a20 5b31 2c32 2c33 2c34 5d7d 7d2c  y': [1,2,3,4]}},
-000112d0: 207b 2778 273a 207b 277a 273a 2022 4865   {'x': {'z': "He
-000112e0: 6c6c 6f22 207d 7d5d 290a 2020 2020 5b7b  llo" }}]).    [{
-000112f0: 2778 273a 207b 2779 273a 205b 312c 2032  'x': {'y': [1, 2
-00011300: 2c20 332c 2034 5d7d 7d2c 207b 2778 273a  , 3, 4]}}, {'x':
-00011310: 207b 277a 273a 2027 4865 6c6c 6f27 7d7d   {'z': 'Hello'}}
-00011320: 5d0a 2020 2020 2222 220a 2020 2020 7479  ].    """.    ty
-00011330: 7065 733a 2044 6963 745b 7374 722c 2074  pes: Dict[str, t
-00011340: 7970 655d 203d 207b 7d0a 2020 2020 6966  ype] = {}.    if
-00011350: 206c 656e 2869 7465 6d73 2920 3d3d 2030   len(items) == 0
-00011360: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00011370: 2069 7465 6d73 0a0a 2020 2020 636f 6c75   items..    colu
-00011380: 6d6e 7320 3d20 6974 656d 735b 305d 2e6b  mns = items[0].k
-00011390: 6579 7328 290a 2020 2020 666f 7220 636f  eys().    for co
-000113a0: 6c75 6d6e 2069 6e20 636f 6c75 6d6e 733a  lumn in columns:
-000113b0: 0a20 2020 2020 2020 2066 6f72 206f 626a  .        for obj
-000113c0: 6563 7420 696e 2069 7465 6d73 3a0a 2020  ect in items:.  
-000113d0: 2020 2020 2020 2020 2020 6966 206f 626a            if obj
-000113e0: 6563 745b 636f 6c75 6d6e 5d20 6973 206e  ect[column] is n
-000113f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00011400: 2020 2020 2020 2020 2074 7970 6573 5b63           types[c
-00011410: 6f6c 756d 6e5d 203d 2074 7970 6528 6f62  olumn] = type(ob
-00011420: 6a65 6374 5b63 6f6c 756d 6e5d 290a 2020  ject[column]).  
-00011430: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00011440: 6561 6b0a 0a20 2020 2066 6f72 206f 626a  eak..    for obj
-00011450: 6563 7420 696e 2069 7465 6d73 3a0a 2020  ect in items:.  
-00011460: 2020 2020 2020 666f 7220 636f 6c75 6d6e        for column
-00011470: 2069 6e20 636f 6c75 6d6e 733a 0a20 2020   in columns:.   
-00011480: 2020 2020 2020 2020 2069 6620 6f62 6a65           if obje
-00011490: 6374 5b63 6f6c 756d 6e5d 2069 7320 6e6f  ct[column] is no
-000114a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000114b0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000114c0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000114d0: 4966 204e 6f6e 652c 2077 6520 7265 706c  If None, we repl
-000114e0: 6163 6520 6974 2066 6f72 2074 6865 2064  ace it for the d
-000114f0: 6566 6175 6c74 2076 616c 7565 0a20 2020  efault value.   
-00011500: 2020 2020 2020 2020 2069 6620 7479 7065           if type
-00011510: 732e 6765 7428 636f 6c75 6d6e 2c20 4e6f  s.get(column, No
-00011520: 6e65 293a 0a20 2020 2020 2020 2020 2020  ne):.           
-00011530: 2020 2020 206f 626a 6563 745b 636f 6c75       object[colu
-00011540: 6d6e 5d20 3d20 7479 7065 735b 636f 6c75  mn] = types[colu
-00011550: 6d6e 5d28 290a 0a20 2020 2072 6574 7572  mn]()..    retur
-00011560: 6e20 6974 656d 730a 0a0a 636c 6173 7320  n items...class 
-00011570: 5069 7065 4368 6563 6b65 7228 756e 6974  PipeChecker(unit
-00011580: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-00011590: 2020 2020 5245 5452 4945 535f 4c49 4d49      RETRIES_LIMI
-000115a0: 5420 3d20 5049 5045 5f43 4845 434b 4552  T = PIPE_CHECKER
-000115b0: 5f52 4554 5249 4553 0a0a 2020 2020 6375  _RETRIES..    cu
-000115c0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
-000115d0: 696d 653a 2066 6c6f 6174 203d 2030 0a20  ime: float = 0. 
-000115e0: 2020 2063 6865 636b 6572 5f72 6573 706f     checker_respo
-000115f0: 6e73 655f 7469 6d65 3a20 666c 6f61 7420  nse_time: float 
-00011600: 3d20 300a 0a20 2020 2063 7572 7265 6e74  = 0..    current
-00011610: 5f72 6561 645f 6279 7465 733a 2069 6e74  _read_bytes: int
-00011620: 203d 2030 0a20 2020 2063 6865 636b 6572   = 0.    checker
-00011630: 5f72 6561 645f 6279 7465 733a 2069 6e74  _read_bytes: int
-00011640: 203d 2030 0a0a 2020 2020 6465 6620 5f5f   = 0..    def __
-00011650: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-00011660: 7365 6c66 2c0a 2020 2020 2020 2020 7265  self,.        re
-00011670: 7175 6573 743a 2044 6963 745b 7374 722c  quest: Dict[str,
-00011680: 2041 6e79 5d2c 0a20 2020 2020 2020 2070   Any],.        p
-00011690: 6970 655f 6e61 6d65 3a20 7374 722c 0a20  ipe_name: str,. 
-000116a0: 2020 2020 2020 2063 6865 636b 6572 5f70         checker_p
-000116b0: 6970 655f 6e61 6d65 3a20 7374 722c 0a20  ipe_name: str,. 
-000116c0: 2020 2020 2020 2074 6f6b 656e 3a20 7374         token: st
-000116d0: 722c 0a20 2020 2020 2020 206f 6e6c 795f  r,.        only_
-000116e0: 7265 7370 6f6e 7365 5f74 696d 6573 3a20  response_times: 
-000116f0: 626f 6f6c 2c0a 2020 2020 2020 2020 6967  bool,.        ig
-00011700: 6e6f 7265 5f6f 7264 6572 3a20 626f 6f6c  nore_order: bool
-00011710: 2c0a 2020 2020 2020 2020 7661 6c69 6461  ,.        valida
-00011720: 7465 5f70 726f 6365 7373 6564 5f62 7974  te_processed_byt
-00011730: 6573 3a20 626f 6f6c 2c0a 2020 2020 2020  es: bool,.      
-00011740: 2020 2a61 7267 732c 0a20 2020 2020 2020    *args,.       
-00011750: 202a 2a6b 7761 7267 732c 0a20 2020 2029   **kwargs,.    )
-00011760: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00011770: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-00011780: 5f5f 282a 6172 6773 2c20 2a2a 6b77 6172  __(*args, **kwar
-00011790: 6773 290a 2020 2020 2020 2020 6966 2072  gs).        if r
-000117a0: 6571 7565 7374 2e67 6574 2822 6874 7470  equest.get("http
-000117b0: 5f6d 6574 686f 6422 2920 3d3d 2022 504f  _method") == "PO
-000117c0: 5354 223a 0a20 2020 2020 2020 2020 2020  ST":.           
-000117d0: 2073 656c 662e 6874 7470 5f6d 6574 686f   self.http_metho
-000117e0: 6420 3d20 2250 4f53 5422 0a20 2020 2020  d = "POST".     
-000117f0: 2020 2020 2020 2073 656c 662e 6375 7272         self.curr
-00011800: 656e 745f 7069 7065 5f75 726c 2c20 7365  ent_pipe_url, se
-00011810: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
-00011820: 7061 7261 6d73 203d 2073 656c 662e 5f70  params = self._p
-00011830: 7265 7061 7265 5f63 7572 7265 6e74 5f70  repare_current_p
-00011840: 6970 655f 666f 725f 706f 7374 5f72 6571  ipe_for_post_req
-00011850: 7565 7374 2872 6571 7565 7374 290a 2020  uest(request).  
-00011860: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00011870: 2020 2020 2020 2020 7365 6c66 2e68 7474          self.htt
-00011880: 705f 6d65 7468 6f64 203d 2022 4745 5422  p_method = "GET"
-00011890: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000118a0: 662e 6375 7272 656e 745f 7069 7065 5f75  f.current_pipe_u
-000118b0: 726c 2c20 7365 6c66 2e70 6970 655f 7265  rl, self.pipe_re
-000118c0: 7175 6573 745f 7061 7261 6d73 203d 2073  quest_params = s
-000118d0: 656c 662e 5f70 7265 7061 7265 5f63 7572  elf._prepare_cur
-000118e0: 7265 6e74 5f70 6970 655f 7572 6c5f 666f  rent_pipe_url_fo
-000118f0: 725f 6765 745f 7265 7175 6573 7428 7265  r_get_request(re
-00011900: 7175 6573 7429 0a0a 2020 2020 2020 2020  quest)..        
-00011910: 7365 6c66 2e5f 7072 6f63 6573 735f 7061  self._process_pa
-00011920: 7261 6d73 2829 0a20 2020 2020 2020 2073  rams().        s
-00011930: 656c 662e 6368 6563 6b65 725f 7069 7065  elf.checker_pipe
-00011940: 5f6e 616d 6520 3d20 6368 6563 6b65 725f  _name = checker_
-00011950: 7069 7065 5f6e 616d 650a 2020 2020 2020  pipe_name.      
-00011960: 2020 7365 6c66 2e70 6970 655f 6e61 6d65    self.pipe_name
-00011970: 203d 2070 6970 655f 6e61 6d65 0a20 2020   = pipe_name.   
-00011980: 2020 2020 2073 656c 662e 746f 6b65 6e20       self.token 
-00011990: 3d20 746f 6b65 6e0a 2020 2020 2020 2020  = token.        
-000119a0: 7365 6c66 2e6f 6e6c 795f 7265 7370 6f6e  self.only_respon
-000119b0: 7365 5f74 696d 6573 203d 206f 6e6c 795f  se_times = only_
-000119c0: 7265 7370 6f6e 7365 5f74 696d 6573 0a20  response_times. 
-000119d0: 2020 2020 2020 2073 656c 662e 6967 6e6f         self.igno
-000119e0: 7265 5f6f 7264 6572 203d 2069 676e 6f72  re_order = ignor
-000119f0: 655f 6f72 6465 720a 2020 2020 2020 2020  e_order.        
-00011a00: 7365 6c66 2e76 616c 6964 6174 655f 7072  self.validate_pr
-00011a10: 6f63 6573 7365 645f 6279 7465 7320 3d20  ocessed_bytes = 
-00011a20: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
-00011a30: 6564 5f62 7974 6573 0a0a 2020 2020 2020  ed_bytes..      
-00011a40: 2020 7061 7273 6564 203d 2075 726c 7061    parsed = urlpa
-00011a50: 7273 6528 7365 6c66 2e63 7572 7265 6e74  rse(self.current
-00011a60: 5f70 6970 655f 7572 6c29 0a20 2020 2020  _pipe_url).     
-00011a70: 2020 2073 656c 662e 6368 6563 6b65 725f     self.checker_
-00011a80: 7069 7065 5f75 726c 203d 2066 227b 7061  pipe_url = f"{pa
-00011a90: 7273 6564 2e73 6368 656d 657d 3a2f 2f7b  rsed.scheme}://{
-00011aa0: 7061 7273 6564 2e6e 6574 6c6f 637d 2f76  parsed.netloc}/v
-00011ab0: 302f 7069 7065 732f 7b73 656c 662e 6368  0/pipes/{self.ch
-00011ac0: 6563 6b65 725f 7069 7065 5f6e 616d 657d  ecker_pipe_name}
-00011ad0: 2e6a 736f 6e22 0a20 2020 2020 2020 2073  .json".        s
-00011ae0: 656c 662e 6368 6563 6b65 725f 7069 7065  elf.checker_pipe
-00011af0: 5f75 726c 202b 3d20 6622 3f7b 7061 7273  _url += f"?{pars
-00011b00: 6564 2e71 7565 7279 7d22 2069 6620 7061  ed.query}" if pa
-00011b10: 7273 6564 2e71 7565 7279 2069 7320 6e6f  rsed.query is no
-00011b20: 7420 4e6f 6e65 2061 6e64 2070 6172 7365  t None and parse
-00011b30: 642e 7175 6572 7920 213d 2022 2220 656c  d.query != "" el
-00011b40: 7365 2022 220a 0a20 2020 2064 6566 205f  se ""..    def _
-00011b50: 7072 6f63 6573 735f 7061 7261 6d73 2873  process_params(s
-00011b60: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-00011b70: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-00011b80: 2073 656c 662e 7069 7065 5f72 6571 7565   self.pipe_reque
-00011b90: 7374 5f70 6172 616d 732e 6b65 7973 2829  st_params.keys()
-00011ba0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00011bb0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00011bc0: 2020 2073 656c 662e 7069 7065 5f72 6571     self.pipe_req
-00011bd0: 7565 7374 5f70 6172 616d 735b 6b65 795d  uest_params[key]
-00011be0: 203d 206a 736f 6e2e 6c6f 6164 7328 7365   = json.loads(se
-00011bf0: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
-00011c00: 7061 7261 6d73 5b6b 6579 5d29 0a20 2020  params[key]).   
-00011c10: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00011c20: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00011c30: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00011c40: 0a20 2020 2064 6566 205f 7072 6570 6172  .    def _prepar
-00011c50: 655f 6375 7272 656e 745f 7069 7065 5f75  e_current_pipe_u
-00011c60: 726c 5f66 6f72 5f67 6574 5f72 6571 7565  rl_for_get_reque
-00011c70: 7374 2873 656c 662c 2072 6571 7565 7374  st(self, request
-00011c80: 2920 2d3e 2054 7570 6c65 5b73 7472 2c20  ) -> Tuple[str, 
-00011c90: 4469 6374 5b73 7472 2c20 7374 725d 5d3a  Dict[str, str]]:
-00011ca0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
-00011cb0: 5f70 6970 655f 7572 6c20 3d20 7265 7175  _pipe_url = requ
-00011cc0: 6573 742e 6765 7428 2265 6e64 706f 696e  est.get("endpoin
-00011cd0: 745f 7572 6c22 2c20 2222 290a 2020 2020  t_url", "").    
-00011ce0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
-00011cf0: 5f75 726c 203d 2028 0a20 2020 2020 2020  _url = (.       
-00011d00: 2020 2020 2063 7572 7265 6e74 5f70 6970       current_pip
-00011d10: 655f 7572 6c2e 7265 706c 6163 6528 222e  e_url.replace(".
-00011d20: 6e64 6a73 6f6e 222c 2022 2e6a 736f 6e22  ndjson", ".json"
-00011d30: 292e 7265 706c 6163 6528 222e 6373 7622  ).replace(".csv"
-00011d40: 2c20 222e 6a73 6f6e 2229 2e72 6570 6c61  , ".json").repla
-00011d50: 6365 2822 2e70 6172 7175 6574 222c 2022  ce(".parquet", "
-00011d60: 2e6a 736f 6e22 290a 2020 2020 2020 2020  .json").        
-00011d70: 290a 2020 2020 2020 2020 6375 7272 656e  ).        curren
-00011d80: 745f 7069 7065 5f75 726c 203d 2064 726f  t_pipe_url = dro
-00011d90: 705f 746f 6b65 6e28 6375 7272 656e 745f  p_token(current_
-00011da0: 7069 7065 5f75 726c 290a 2020 2020 2020  pipe_url).      
-00011db0: 2020 6375 7272 656e 745f 7069 7065 5f75    current_pipe_u
-00011dc0: 726c 202b 3d20 2822 2622 2069 6620 223f  rl += ("&" if "?
-00011dd0: 2220 696e 2063 7572 7265 6e74 5f70 6970  " in current_pip
-00011de0: 655f 7572 6c20 656c 7365 2022 3f22 2920  e_url else "?") 
-00011df0: 2b20 2270 6970 655f 6368 6563 6b65 723d  + "pipe_checker=
-00011e00: 7472 7565 220a 2020 2020 2020 2020 7265  true".        re
-00011e10: 7475 726e 2063 7572 7265 6e74 5f70 6970  turn current_pip
-00011e20: 655f 7572 6c2c 2072 6571 7565 7374 2e67  e_url, request.g
-00011e30: 6574 2822 7069 7065 5f72 6571 7565 7374  et("pipe_request
-00011e40: 5f70 6172 616d 7322 2c20 7b7d 290a 0a20  _params", {}).. 
-00011e50: 2020 2064 6566 205f 7072 6570 6172 655f     def _prepare_
-00011e60: 6375 7272 656e 745f 7069 7065 5f66 6f72  current_pipe_for
-00011e70: 5f70 6f73 745f 7265 7175 6573 7428 7365  _post_request(se
-00011e80: 6c66 2c20 7265 7175 6573 7429 202d 3e20  lf, request) -> 
-00011e90: 5475 706c 655b 7374 722c 2044 6963 745b  Tuple[str, Dict[
-00011ea0: 7374 722c 2073 7472 5d5d 3a0a 2020 2020  str, str]]:.    
-00011eb0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
-00011ec0: 5f75 726c 203d 2072 6571 7565 7374 2e67  _url = request.g
-00011ed0: 6574 2822 656e 6470 6f69 6e74 5f75 726c  et("endpoint_url
-00011ee0: 222c 2022 2229 0a20 2020 2020 2020 2063  ", "").        c
-00011ef0: 7572 7265 6e74 5f70 6970 655f 7572 6c20  urrent_pipe_url 
-00011f00: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00011f10: 6375 7272 656e 745f 7069 7065 5f75 726c  current_pipe_url
-00011f20: 2e72 6570 6c61 6365 2822 2e6e 646a 736f  .replace(".ndjso
-00011f30: 6e22 2c20 222e 6a73 6f6e 2229 2e72 6570  n", ".json").rep
-00011f40: 6c61 6365 2822 2e63 7376 222c 2022 2e6a  lace(".csv", ".j
-00011f50: 736f 6e22 292e 7265 706c 6163 6528 222e  son").replace(".
-00011f60: 7061 7271 7565 7422 2c20 222e 6a73 6f6e  parquet", ".json
-00011f70: 2229 0a20 2020 2020 2020 2029 0a20 2020  ").        ).   
-00011f80: 2020 2020 2061 6c6c 5f70 6172 616d 6574       all_paramet
-00011f90: 6572 7320 3d20 7265 7175 6573 742e 6765  ers = request.ge
-00011fa0: 7428 2270 6970 655f 7265 7175 6573 745f  t("pipe_request_
-00011fb0: 7061 7261 6d73 2229 0a20 2020 2020 2020  params").       
-00011fc0: 2061 6c6c 5f70 6172 616d 6574 6572 732e   all_parameters.
-00011fd0: 706f 7028 2274 6f6b 656e 222c 204e 6f6e  pop("token", Non
-00011fe0: 6529 0a20 2020 2020 2020 2061 6c6c 5f70  e).        all_p
-00011ff0: 6172 616d 6574 6572 735b 2270 6970 655f  arameters["pipe_
-00012000: 6368 6563 6b65 7222 5d20 3d20 2274 7275  checker"] = "tru
-00012010: 6522 0a0a 2020 2020 2020 2020 7265 7475  e"..        retu
-00012020: 726e 2063 7572 7265 6e74 5f70 6970 655f  rn current_pipe_
-00012030: 7572 6c2c 2061 6c6c 5f70 6172 616d 6574  url, all_paramet
-00012040: 6572 730a 0a20 2020 2064 6566 205f 5f73  ers..    def __s
-00012050: 7472 5f5f 2873 656c 6629 3a0a 2020 2020  tr__(self):.    
-00012060: 2020 2020 706f 7374 5f76 616c 7565 7320      post_values 
-00012070: 3d20 6622 202d 2050 4f53 5420 426f 6479  = f" - POST Body
-00012080: 3a20 7b73 656c 662e 7069 7065 5f72 6571  : {self.pipe_req
-00012090: 7565 7374 5f70 6172 616d 737d 2220 6966  uest_params}" if
-000120a0: 2073 656c 662e 6874 7470 5f6d 6574 686f   self.http_metho
-000120b0: 6420 3d3d 2022 504f 5354 2220 656c 7365  d == "POST" else
-000120c0: 2022 220a 0a20 2020 2020 2020 2072 6574   ""..        ret
-000120d0: 7572 6e20 6622 6375 7272 656e 7420 7b73  urn f"current {s
-000120e0: 656c 662e 6375 7272 656e 745f 7069 7065  elf.current_pipe
-000120f0: 5f75 726c 7d7b 706f 7374 5f76 616c 7565  _url}{post_value
-00012100: 737d 5c6e 2020 2020 6e65 7720 7b73 656c  s}\n    new {sel
-00012110: 662e 6368 6563 6b65 725f 7069 7065 5f75  f.checker_pipe_u
-00012120: 726c 7d7b 706f 7374 5f76 616c 7565 737d  rl}{post_values}
-00012130: 220a 0a20 2020 2064 6566 2064 6966 6628  "..    def diff(
-00012140: 7365 6c66 2c20 613a 2044 6963 745b 7374  self, a: Dict[st
-00012150: 722c 2041 6e79 5d2c 2062 3a20 4469 6374  r, Any], b: Dict
-00012160: 5b73 7472 2c20 416e 795d 2920 2d3e 2073  [str, Any]) -> s
-00012170: 7472 3a0a 2020 2020 2020 2020 615f 7072  tr:.        a_pr
-00012180: 6f70 6572 7469 6573 203d 206c 6973 7428  operties = list(
-00012190: 6d61 7028 6c61 6d62 6461 2078 3a20 6622  map(lambda x: f"
-000121a0: 7b78 7d3a 7b61 5b78 5d7d 5c6e 222c 2061  {x}:{a[x]}\n", a
-000121b0: 2e6b 6579 7328 2929 290a 2020 2020 2020  .keys())).      
-000121c0: 2020 625f 7072 6f70 6572 7469 6573 203d    b_properties =
-000121d0: 206c 6973 7428 6d61 7028 6c61 6d62 6461   list(map(lambda
-000121e0: 2078 3a20 6622 7b78 7d3a 7b62 5b78 5d7d   x: f"{x}:{b[x]}
-000121f0: 5c6e 222c 2062 2e6b 6579 7328 2929 290a  \n", b.keys())).
-00012200: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012210: 2222 2e6a 6f69 6e28 6469 6666 6c69 622e  "".join(difflib.
-00012220: 636f 6e74 6578 745f 6469 6666 2861 5f70  context_diff(a_p
-00012230: 726f 7065 7274 6965 732c 2062 5f70 726f  roperties, b_pro
-00012240: 7065 7274 6965 732c 2073 656c 662e 7069  perties, self.pi
-00012250: 7065 5f6e 616d 652c 2073 656c 662e 6368  pe_name, self.ch
-00012260: 6563 6b65 725f 7069 7065 5f6e 616d 6529  ecker_pipe_name)
-00012270: 290a 0a20 2020 2064 6566 205f 646f 5f72  )..    def _do_r
-00012280: 6571 7565 7374 5f74 6f5f 7069 7065 2873  equest_to_pipe(s
-00012290: 656c 662c 2070 6970 655f 7572 6c3a 2073  elf, pipe_url: s
-000122a0: 7472 2920 2d3e 2052 6573 706f 6e73 653a  tr) -> Response:
-000122b0: 0a20 2020 2020 2020 2068 6561 6465 7273  .        headers
-000122c0: 203d 207b 2241 7574 686f 7269 7a61 7469   = {"Authorizati
-000122d0: 6f6e 223a 2066 2242 6561 7265 7220 7b73  on": f"Bearer {s
-000122e0: 656c 662e 746f 6b65 6e7d 227d 0a20 2020  elf.token}"}.   
-000122f0: 2020 2020 2069 6620 7365 6c66 2e68 7474       if self.htt
-00012300: 705f 6d65 7468 6f64 203d 3d20 2247 4554  p_method == "GET
-00012310: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-00012320: 6574 7572 6e20 7265 7175 6573 7473 2e67  eturn requests.g
-00012330: 6574 2870 6970 655f 7572 6c2c 2068 6561  et(pipe_url, hea
-00012340: 6465 7273 3d68 6561 6465 7273 2c20 7665  ders=headers, ve
-00012350: 7269 6679 3d6e 6f74 2067 6574 656e 765f  rify=not getenv_
-00012360: 626f 6f6c 2822 5442 5f44 4953 4142 4c45  bool("TB_DISABLE
-00012370: 5f53 534c 5f43 4845 434b 5322 2c20 4661  _SSL_CHECKS", Fa
-00012380: 6c73 6529 290a 2020 2020 2020 2020 656c  lse)).        el
-00012390: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000123a0: 7265 7475 726e 2072 6571 7565 7374 732e  return requests.
-000123b0: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
-000123c0: 2020 2020 2020 7069 7065 5f75 726c 2c0a        pipe_url,.
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 6865 6164 6572 733d 6865 6164 6572 732c  headers=headers,
-000123f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012400: 2076 6572 6966 793d 6e6f 7420 6765 7465   verify=not gete
-00012410: 6e76 5f62 6f6f 6c28 2254 425f 4449 5341  nv_bool("TB_DISA
-00012420: 424c 455f 5353 4c5f 4348 4543 4b53 222c  BLE_SSL_CHECKS",
-00012430: 2046 616c 7365 292c 0a20 2020 2020 2020   False),.       
-00012440: 2020 2020 2020 2020 2064 6174 613d 7365           data=se
-00012450: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
-00012460: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00012470: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
-00012480: 7772 6974 655f 7065 7266 6f72 6d61 6e63  write_performanc
-00012490: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-000124a0: 2072 6574 7572 6e20 2222 0a0a 2020 2020   return ""..    
-000124b0: 6465 6620 5f72 756e 5465 7374 2873 656c  def _runTest(sel
-000124c0: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-000124d0: 2020 2020 6375 7272 656e 745f 7220 3d20      current_r = 
-000124e0: 7365 6c66 2e5f 646f 5f72 6571 7565 7374  self._do_request
-000124f0: 5f74 6f5f 7069 7065 2873 656c 662e 6375  _to_pipe(self.cu
-00012500: 7272 656e 745f 7069 7065 5f75 726c 290a  rrent_pipe_url).
-00012510: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
-00012520: 7220 3d20 7365 6c66 2e5f 646f 5f72 6571  r = self._do_req
-00012530: 7565 7374 5f74 6f5f 7069 7065 2873 656c  uest_to_pipe(sel
-00012540: 662e 6368 6563 6b65 725f 7069 7065 5f75  f.checker_pipe_u
-00012550: 726c 290a 0a20 2020 2020 2020 2074 7279  rl)..        try
-00012560: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00012570: 6c66 2e63 7572 7265 6e74 5f72 6573 706f  lf.current_respo
-00012580: 6e73 655f 7469 6d65 203d 2063 7572 7265  nse_time = curre
-00012590: 6e74 5f72 2e65 6c61 7073 6564 2e74 6f74  nt_r.elapsed.tot
-000125a0: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
-000125b0: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
-000125c0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-000125d0: 696d 6520 3d20 6368 6563 6b65 725f 722e  ime = checker_r.
-000125e0: 656c 6170 7365 642e 746f 7461 6c5f 7365  elapsed.total_se
-000125f0: 636f 6e64 7328 290a 2020 2020 2020 2020  conds().        
-00012600: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00012610: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00012620: 7373 0a0a 2020 2020 2020 2020 6375 7272  ss..        curr
-00012630: 656e 745f 7265 7370 6f6e 7365 3a20 4469  ent_response: Di
-00012640: 6374 5b73 7472 2c20 416e 795d 203d 2063  ct[str, Any] = c
-00012650: 7572 7265 6e74 5f72 2e6a 736f 6e28 290a  urrent_r.json().
-00012660: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
-00012670: 7265 7370 6f6e 7365 3a20 4469 6374 5b73  response: Dict[s
-00012680: 7472 2c20 416e 795d 203d 2063 6865 636b  tr, Any] = check
-00012690: 6572 5f72 2e6a 736f 6e28 290a 0a20 2020  er_r.json()..   
-000126a0: 2020 2020 2063 7572 7265 6e74 5f64 6174       current_dat
-000126b0: 613a 204c 6973 745b 4469 6374 5b73 7472  a: List[Dict[str
-000126c0: 2c20 416e 795d 5d20 3d20 6375 7272 656e  , Any]] = curren
-000126d0: 745f 7265 7370 6f6e 7365 2e67 6574 2822  t_response.get("
-000126e0: 6461 7461 222c 205b 5d29 0a20 2020 2020  data", []).     
-000126f0: 2020 2063 6865 636b 6572 5f64 6174 613a     checker_data:
-00012700: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
-00012710: 416e 795d 5d20 3d20 6368 6563 6b65 725f  Any]] = checker_
-00012720: 7265 7370 6f6e 7365 2e67 6574 2822 6461  response.get("da
-00012730: 7461 222c 205b 5d29 0a0a 2020 2020 2020  ta", [])..      
-00012740: 2020 7365 6c66 2e63 7572 7265 6e74 5f72    self.current_r
-00012750: 6561 645f 6279 7465 7320 3d20 6375 7272  ead_bytes = curr
-00012760: 656e 745f 7265 7370 6f6e 7365 2e67 6574  ent_response.get
-00012770: 2822 7374 6174 6973 7469 6373 222c 207b  ("statistics", {
-00012780: 7d29 2e67 6574 2822 6279 7465 735f 7265  }).get("bytes_re
-00012790: 6164 222c 2030 290a 2020 2020 2020 2020  ad", 0).        
-000127a0: 7365 6c66 2e63 6865 636b 6572 5f72 6561  self.checker_rea
-000127b0: 645f 6279 7465 7320 3d20 6368 6563 6b65  d_bytes = checke
-000127c0: 725f 7265 7370 6f6e 7365 2e67 6574 2822  r_response.get("
-000127d0: 7374 6174 6973 7469 6373 222c 207b 7d29  statistics", {})
-000127e0: 2e67 6574 2822 6279 7465 735f 7265 6164  .get("bytes_read
-000127f0: 222c 2030 290a 0a20 2020 2020 2020 2065  ", 0)..        e
-00012800: 7272 6f72 5f63 6865 636b 5f66 6978 7475  rror_check_fixtu
-00012810: 7265 735f 6461 7461 3a20 4f70 7469 6f6e  res_data: Option
-00012820: 616c 5b73 7472 5d20 3d20 6368 6563 6b65  al[str] = checke
-00012830: 725f 7265 7370 6f6e 7365 2e67 6574 2822  r_response.get("
-00012840: 6572 726f 7222 2c20 4e6f 6e65 290a 2020  error", None).  
-00012850: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012860: 7449 734e 6f6e 6528 0a20 2020 2020 2020  tIsNone(.       
-00012870: 2020 2020 2065 7272 6f72 5f63 6865 636b       error_check
-00012880: 5f66 6978 7475 7265 735f 6461 7461 2c0a  _fixtures_data,.
-00012890: 2020 2020 2020 2020 2020 2020 2259 6f75              "You
-000128a0: 2061 7265 2074 7279 696e 6720 746f 2070   are trying to p
-000128b0: 7573 6820 6120 7069 7065 2077 6974 6820  ush a pipe with 
-000128c0: 6572 726f 7273 2c20 706c 6561 7365 2063  errors, please c
-000128d0: 6865 636b 2074 6865 206f 7574 7075 7420  heck the output 
-000128e0: 6f72 2072 756e 2077 6974 6820 2d2d 6e6f  or run with --no
-000128f0: 2d63 6865 636b 222c 0a20 2020 2020 2020  -check",.       
-00012900: 2029 0a0a 2020 2020 2020 2020 696e 6372   )..        incr
-00012910: 6561 7365 5f72 6573 706f 6e73 655f 7469  ease_response_ti
-00012920: 6d65 203d 2028 0a20 2020 2020 2020 2020  me = (.         
-00012930: 2020 2063 6865 636b 6572 5f72 2e65 6c61     checker_r.ela
-00012940: 7073 6564 2e74 6f74 616c 5f73 6563 6f6e  psed.total_secon
-00012950: 6473 2829 202d 2063 7572 7265 6e74 5f72  ds() - current_r
-00012960: 2e65 6c61 7073 6564 2e74 6f74 616c 5f73  .elapsed.total_s
-00012970: 6563 6f6e 6473 2829 0a20 2020 2020 2020  econds().       
-00012980: 2029 202f 2063 7572 7265 6e74 5f72 2e65   ) / current_r.e
-00012990: 6c61 7073 6564 2e74 6f74 616c 5f73 6563  lapsed.total_sec
-000129a0: 6f6e 6473 2829 0a20 2020 2020 2020 2069  onds().        i
-000129b0: 6620 7365 6c66 2e6f 6e6c 795f 7265 7370  f self.only_resp
-000129c0: 6f6e 7365 5f74 696d 6573 3a0a 2020 2020  onse_times:.    
-000129d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000129e0: 6572 744c 6573 7328 0a20 2020 2020 2020  ertLess(.       
-000129f0: 2020 2020 2020 2020 2069 6e63 7265 6173           increas
-00012a00: 655f 7265 7370 6f6e 7365 5f74 696d 652c  e_response_time,
-00012a10: 2030 2e32 352c 206d 7367 3d66 2272 6573   0.25, msg=f"res
-00012a20: 706f 6e73 6520 7469 6d65 2068 6173 2069  ponse time has i
-00012a30: 6e63 7265 6173 6564 207b 726f 756e 6428  ncreased {round(
-00012a40: 696e 6372 6561 7365 5f72 6573 706f 6e73  increase_respons
-00012a50: 655f 7469 6d65 202a 2031 3030 297d 2522  e_time * 100)}%"
-00012a60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00012a70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012a80: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
-00012a90: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-00012aa0: 6375 7272 656e 745f 6461 7461 292c 206c  current_data), l
-00012ab0: 656e 2863 6865 636b 6572 5f64 6174 6129  en(checker_data)
-00012ac0: 2c20 224e 756d 6265 7220 6f66 2065 6c65  , "Number of ele
-00012ad0: 6d65 6e74 7320 646f 6573 206e 6f74 206d  ments does not m
-00012ae0: 6174 6368 2229 0a0a 2020 2020 2020 2020  atch")..        
-00012af0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00012b00: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
-00012b10: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00012b20: 6372 6561 7365 5f72 6561 645f 6279 7465  crease_read_byte
-00012b30: 7320 3d20 2873 656c 662e 6368 6563 6b65  s = (self.checke
-00012b40: 725f 7265 6164 5f62 7974 6573 202d 2073  r_read_bytes - s
-00012b50: 656c 662e 6375 7272 656e 745f 7265 6164  elf.current_read
-00012b60: 5f62 7974 6573 2920 2f20 7365 6c66 2e63  _bytes) / self.c
-00012b70: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
-00012b80: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
-00012b90: 6c66 2e61 7373 6572 744c 6573 7328 0a20  lf.assertLess(. 
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012bb0: 6f75 6e64 2869 6e63 7265 6173 655f 7265  ound(increase_re
-00012bc0: 6164 5f62 7974 6573 2c20 3229 2c0a 2020  ad_bytes, 2),.  
-00012bd0: 2020 2020 2020 2020 2020 2020 2020 302e                0.
-00012be0: 3235 2c0a 2020 2020 2020 2020 2020 2020  25,.            
-00012bf0: 2020 2020 6d73 673d 6622 5468 6520 6e75      msg=f"The nu
-00012c00: 6d62 6572 206f 6620 7072 6f63 6573 7365  mber of processe
-00012c10: 6420 6279 7465 7320 6861 7320 696e 6372  d bytes has incr
-00012c20: 6561 7365 6420 7b72 6f75 6e64 2869 6e63  eased {round(inc
-00012c30: 7265 6173 655f 7265 6164 5f62 7974 6573  rease_read_bytes
-00012c40: 202a 2031 3030 297d 2522 2c0a 2020 2020   * 100)}%",.    
-00012c50: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00012c60: 2020 2069 6620 7365 6c66 2e69 676e 6f72     if self.ignor
-00012c70: 655f 6f72 6465 723a 0a20 2020 2020 2020  e_order:.       
-00012c80: 2020 2020 2063 7572 7265 6e74 5f64 6174       current_dat
-00012c90: 6120 3d20 280a 2020 2020 2020 2020 2020  a = (.          
-00012ca0: 2020 2020 2020 736f 7274 6564 286e 6f72        sorted(nor
-00012cb0: 6d61 6c69 7a65 5f61 7272 6179 2863 7572  malize_array(cur
-00012cc0: 7265 6e74 5f64 6174 6129 2c20 6b65 793d  rent_data), key=
-00012cd0: 6974 656d 6765 7474 6572 282a 5b6b 2066  itemgetter(*[k f
-00012ce0: 6f72 206b 2069 6e20 6375 7272 656e 745f  or k in current_
-00012cf0: 6461 7461 5b30 5d2e 6b65 7973 2829 5d29  data[0].keys()])
-00012d00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012d10: 2020 6966 206c 656e 2863 7572 7265 6e74    if len(current
-00012d20: 5f64 6174 6129 203e 2030 0a20 2020 2020  _data) > 0.     
-00012d30: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-00012d40: 6375 7272 656e 745f 6461 7461 0a20 2020  current_data.   
-00012d50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012d60: 2020 2020 2020 2063 6865 636b 6572 5f64         checker_d
-00012d70: 6174 6120 3d20 280a 2020 2020 2020 2020  ata = (.        
-00012d80: 2020 2020 2020 2020 736f 7274 6564 286e          sorted(n
-00012d90: 6f72 6d61 6c69 7a65 5f61 7272 6179 2863  ormalize_array(c
-00012da0: 6865 636b 6572 5f64 6174 6129 2c20 6b65  hecker_data), ke
-00012db0: 793d 6974 656d 6765 7474 6572 282a 5b6b  y=itemgetter(*[k
-00012dc0: 2066 6f72 206b 2069 6e20 6368 6563 6b65   for k in checke
-00012dd0: 725f 6461 7461 5b30 5d2e 6b65 7973 2829  r_data[0].keys()
-00012de0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-00012df0: 2020 2020 6966 206c 656e 2863 6865 636b      if len(check
-00012e00: 6572 5f64 6174 6129 203e 2030 0a20 2020  er_data) > 0.   
-00012e10: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00012e20: 6520 6368 6563 6b65 725f 6461 7461 0a20  e checker_data. 
-00012e30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00012e40: 2020 2020 2020 666f 7220 5f2c 2028 6375        for _, (cu
-00012e50: 7272 656e 745f 6461 7461 5f65 2c20 6368  rrent_data_e, ch
-00012e60: 6563 6b5f 6669 7874 7572 6573 5f64 6174  eck_fixtures_dat
-00012e70: 615f 6529 2069 6e20 656e 756d 6572 6174  a_e) in enumerat
-00012e80: 6528 7a69 7028 6375 7272 656e 745f 6461  e(zip(current_da
-00012e90: 7461 2c20 6368 6563 6b65 725f 6461 7461  ta, checker_data
-00012ea0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00012eb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00012ec0: 286c 6973 7428 6375 7272 656e 745f 6461  (list(current_da
-00012ed0: 7461 5f65 2e6b 6579 7328 2929 2c20 6c69  ta_e.keys()), li
-00012ee0: 7374 2863 6865 636b 5f66 6978 7475 7265  st(check_fixture
-00012ef0: 735f 6461 7461 5f65 2e6b 6579 7328 2929  s_data_e.keys())
-00012f00: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00012f10: 7220 7820 696e 2063 7572 7265 6e74 5f64  r x in current_d
-00012f20: 6174 615f 652e 6b65 7973 2829 3a0a 2020  ata_e.keys():.  
-00012f30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00012f40: 2069 7369 6e73 7461 6e63 6528 6375 7272   isinstance(curr
-00012f50: 656e 745f 6461 7461 5f65 5b78 5d2c 2066  ent_data_e[x], f
-00012f60: 6c6f 6174 293a 0a20 2020 2020 2020 2020  loat):.         
-00012f70: 2020 2020 2020 2020 2020 2064 203d 2061             d = a
-00012f80: 6273 2863 7572 7265 6e74 5f64 6174 615f  bs(current_data_
-00012f90: 655b 785d 202d 2063 6865 636b 5f66 6978  e[x] - check_fix
-00012fa0: 7475 7265 735f 6461 7461 5f65 5b78 5d29  tures_data_e[x])
-00012fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012fc0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00005e70: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00005e80: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00005e90: 6c66 2e63 6c69 5f67 6974 5f72 656c 6561  lf.cli_git_relea
+00005ea0: 7365 203d 2073 656c 662e 636c 695f 6769  se = self.cli_gi
+00005eb0: 745f 7265 6c65 6173 6520 6f72 2043 4c49  t_release or CLI
+00005ec0: 4769 7452 656c 6561 7365 2829 0a20 2020  GitRelease().   
+00005ed0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00005ee0: 7365 6c66 2e63 7572 7265 6e74 5f72 656c  self.current_rel
+00005ef0: 6561 7365 3a0a 2020 2020 2020 2020 2020  ease:.          
+00005f00: 2020 2020 2020 2020 2020 7265 6c65 6173            releas
+00005f10: 6520 3d20 6177 6169 7420 7365 6c66 2e63  e = await self.c
+00005f20: 6c69 5f67 6974 5f72 656c 6561 7365 2e75  li_git_release.u
+00005f30: 7064 6174 655f 7265 6c65 6173 6528 7365  pdate_release(se
+00005f40: 6c66 2e74 625f 636c 6965 6e74 2c20 7365  lf.tb_client, se
+00005f50: 6c66 2e63 7572 7265 6e74 5f77 732c 2063  lf.current_ws, c
+00005f60: 6f6d 6d69 7429 0a20 2020 2020 2020 2020  ommit).         
+00005f70: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+00005f80: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+00005f90: 6e61 6765 722e 7375 6363 6573 735f 6769  nager.success_gi
+00005fa0: 745f 7265 6c65 6173 6528 7265 6c65 6173  t_release(releas
+00005fb0: 655f 636f 6d6d 6974 3d72 656c 6561 7365  e_commit=release
+00005fc0: 5b22 636f 6d6d 6974 225d 2929 0a20 2020  ["commit"])).   
+00005fd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00005fe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005ff0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+00006000: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
+00006010: 722e 7761 726e 696e 675f 6e6f 5f72 656c  r.warning_no_rel
+00006020: 6561 7365 2829 290a 2020 2020 2020 2020  ease()).        
+00006030: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00006040: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00006050: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00006060: 6c66 2e6f 6e6c 795f 6368 616e 6765 733a  lf.only_changes:
+00006070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006080: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00006090: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+000060a0: 7761 726e 696e 675f 6e6f 5f72 656c 6561  warning_no_relea
+000060b0: 7365 2829 290a 2020 2020 2020 2020 2020  se()).          
+000060c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000060d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060e0: 7261 6973 6520 650a 0a20 2020 2061 7379  raise e..    asy
+000060f0: 6e63 2064 6566 2064 656c 6574 655f 7265  nc def delete_re
+00006100: 736f 7572 6365 7328 7365 6c66 2c20 6465  sources(self, de
+00006110: 6c65 7465 643a 204c 6973 745b 7374 725d  leted: List[str]
+00006120: 2c20 7265 6d6f 7465 5f70 6970 6573 3a20  , remote_pipes: 
+00006130: 4c69 7374 5b44 6963 745b 7374 722c 2041  List[Dict[str, A
+00006140: 6e79 5d5d 2c20 6472 795f 7275 6e3a 2062  ny]], dry_run: b
+00006150: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+00006160: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+00006170: 6465 6c65 7465 5f70 6970 6528 7265 736f  delete_pipe(reso
+00006180: 7572 6365 5f6e 616d 655f 6f72 5f69 643a  urce_name_or_id:
+00006190: 2073 7472 2c20 6472 795f 7275 6e3a 2062   str, dry_run: b
+000061a0: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+000061b0: 2020 2020 2020 2020 2020 6966 2064 7279            if dry
+000061c0: 5f72 756e 3a0a 2020 2020 2020 2020 2020  _run:.          
+000061d0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+000061e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000061f0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+00006200: 6e61 6765 722e 696e 666f 5f64 656c 6574  nager.info_delet
+00006210: 696e 675f 7265 736f 7572 6365 2864 7279  ing_resource(dry
+00006220: 5f72 756e 3d22 5b44 5259 2052 554e 5d20  _run="[DRY RUN] 
+00006230: 222c 2072 6573 6f75 7263 655f 6e61 6d65  ", resource_name
+00006240: 3d72 6573 6f75 7263 655f 6e61 6d65 5f6f  =resource_name_o
+00006250: 725f 6964 290a 2020 2020 2020 2020 2020  r_id).          
+00006260: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006270: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00006280: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+00006290: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+000062a0: 6167 6572 2e69 6e66 6f5f 6465 6c65 7469  ager.info_deleti
+000062b0: 6e67 5f72 6573 6f75 7263 6528 6472 795f  ng_resource(dry_
+000062c0: 7275 6e3d 2222 2c20 7265 736f 7572 6365  run="", resource
+000062d0: 5f6e 616d 653d 7265 736f 7572 6365 5f6e  _name=resource_n
+000062e0: 616d 655f 6f72 5f69 6429 290a 2020 2020  ame_or_id)).    
+000062f0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00006300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006310: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00006320: 7462 5f63 6c69 656e 742e 7069 7065 5f64  tb_client.pipe_d
+00006330: 656c 6574 6528 7265 736f 7572 6365 5f6e  elete(resource_n
+00006340: 616d 655f 6f72 5f69 6429 0a20 2020 2020  ame_or_id).     
+00006350: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00006360: 7420 4175 7468 4578 6365 7074 696f 6e20  t AuthException 
+00006370: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00006380: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00006390: 434c 4947 6974 5265 6c65 6173 6545 7863  CLIGitReleaseExc
+000063a0: 6570 7469 6f6e 2873 7472 2865 2929 0a20  eption(str(e)). 
+000063b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000063c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000063d0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+000063e0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
+000063f0: 6765 722e 7375 6363 6573 735f 6465 6c65  ger.success_dele
+00006400: 7465 286e 616d 653d 7265 736f 7572 6365  te(name=resource
+00006410: 5f6e 616d 655f 6f72 5f69 6429 290a 0a20  _name_or_id)).. 
+00006420: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+00006430: 2064 656c 6574 655f 6461 7461 736f 7572   delete_datasour
+00006440: 6365 2872 6573 6f75 7263 655f 6e61 6d65  ce(resource_name
+00006450: 5f6f 725f 6964 3a20 7374 722c 2064 7279  _or_id: str, dry
+00006460: 5f72 756e 3a20 626f 6f6c 203d 2046 616c  _run: bool = Fal
+00006470: 7365 293a 0a20 2020 2020 2020 2020 2020  se):.           
+00006480: 2069 6620 6472 795f 7275 6e3a 0a20 2020   if dry_run:.   
+00006490: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+000064a0: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
+000064b0: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
+000064c0: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+000064d0: 6f5f 6465 6c65 7469 6e67 5f72 6573 6f75  o_deleting_resou
+000064e0: 7263 6528 6472 795f 7275 6e3d 225b 4452  rce(dry_run="[DR
+000064f0: 5920 5255 4e5d 2022 2c20 7265 736f 7572  Y RUN] ", resour
+00006500: 6365 5f6e 616d 653d 7265 736f 7572 6365  ce_name=resource
+00006510: 5f6e 616d 655f 6f72 5f69 6429 0a20 2020  _name_or_id).   
+00006520: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00006530: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00006540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006550: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+00006560: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
+00006570: 5f64 656c 6574 696e 675f 7265 736f 7572  _deleting_resour
+00006580: 6365 2864 7279 5f72 756e 3d22 222c 2072  ce(dry_run="", r
+00006590: 6573 6f75 7263 655f 6e61 6d65 3d72 6573  esource_name=res
+000065a0: 6f75 7263 655f 6e61 6d65 5f6f 725f 6964  ource_name_or_id
+000065b0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000065c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000065d0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000065e0: 7420 7365 6c66 2e74 625f 636c 6965 6e74  t self.tb_client
+000065f0: 2e64 6174 6173 6f75 7263 655f 6465 6c65  .datasource_dele
+00006600: 7465 2872 6573 6f75 7263 655f 6e61 6d65  te(resource_name
+00006610: 5f6f 725f 6964 290a 2020 2020 2020 2020  _or_id).        
+00006620: 2020 2020 2020 2020 6578 6365 7074 2043          except C
+00006630: 616e 4e6f 7442 6544 656c 6574 6564 4578  anNotBeDeletedEx
+00006640: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00006650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006660: 2020 7261 6973 6520 434c 4947 6974 5265    raise CLIGitRe
+00006670: 6c65 6173 6545 7863 6570 7469 6f6e 2873  leaseException(s
+00006680: 7472 2865 2929 0a20 2020 2020 2020 2020  tr(e)).         
+00006690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000066a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000066b0: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+000066c0: 6261 636b 4d61 6e61 6765 722e 7375 6363  backManager.succ
+000066d0: 6573 735f 6465 6c65 7465 286e 616d 653d  ess_delete(name=
+000066e0: 7265 736f 7572 6365 5f6e 616d 655f 6f72  resource_name_or
+000066f0: 5f69 6429 290a 0a20 2020 2020 2020 2072  _id))..        r
+00006700: 6573 6f75 7263 655f 6578 7465 6e73 696f  esource_extensio
+00006710: 6e5f 7072 6f63 6573 736f 7220 3d20 7b22  n_processor = {"
+00006720: 2e64 6174 6173 6f75 7263 6522 3a20 6465  .datasource": de
+00006730: 6c65 7465 5f64 6174 6173 6f75 7263 652c  lete_datasource,
+00006740: 2022 2e70 6970 6522 3a20 6465 6c65 7465   ".pipe": delete
+00006750: 5f70 6970 657d 0a0a 2020 2020 2020 2020  _pipe}..        
+00006760: 2320 6275 696c 6473 2070 6970 6573 2064  # builds pipes d
+00006770: 6570 7320 7468 6520 6f74 6865 7220 7761  eps the other wa
+00006780: 7920 6172 6f75 6e64 2066 726f 6d20 4150  y around from AP
+00006790: 4920 746f 2075 7365 2077 6974 6820 746f  I to use with to
+000067a0: 706f 736f 7274 0a20 2020 2020 2020 2023  posort.        #
+000067b0: 2069 2e65 207b 2761 6e61 6c79 7469 6373   i.e {'analytics
+000067c0: 5f68 6974 7327 3a20 5b27 616e 616c 7974  _hits': ['analyt
+000067d0: 6963 735f 7061 6765 7327 2c20 2774 7265  ics_pages', 'tre
+000067e0: 6e64 272c 2027 616e 616c 7974 6963 735f  nd', 'analytics_
+000067f0: 736f 7572 6365 7327 2c20 2761 6e61 6c79  sources', 'analy
+00006800: 7469 6373 5f73 6573 7369 6f6e 7327 5d7d  tics_sessions']}
+00006810: 0a20 2020 2020 2020 2070 6970 6573 5f64  .        pipes_d
+00006820: 6570 733a 2044 6963 745b 7374 722c 204c  eps: Dict[str, L
+00006830: 6973 745b 7374 725d 5d20 3d20 7b7d 0a20  ist[str]] = {}. 
+00006840: 2020 2020 2020 2072 656d 6f74 655f 7069         remote_pi
+00006850: 7065 735f 7479 7065 3a20 4469 6374 5b73  pes_type: Dict[s
+00006860: 7472 2c20 7374 725d 203d 207b 7d0a 2020  tr, str] = {}.  
+00006870: 2020 2020 2020 666f 7220 7069 7065 2069        for pipe i
+00006880: 6e20 7265 6d6f 7465 5f70 6970 6573 3a0a  n remote_pipes:.
+00006890: 2020 2020 2020 2020 2020 2020 7069 7065              pipe
+000068a0: 735f 6465 7073 5b70 6970 655b 226e 616d  s_deps[pipe["nam
+000068b0: 6522 5d5d 203d 205b 5d0a 2020 2020 2020  e"]] = [].      
+000068c0: 2020 2020 2020 7265 6d6f 7465 5f70 6970        remote_pip
+000068d0: 6573 5f74 7970 655b 7069 7065 5b22 6e61  es_type[pipe["na
+000068e0: 6d65 225d 5d20 3d20 7069 7065 5b22 7479  me"]] = pipe["ty
+000068f0: 7065 225d 0a20 2020 2020 2020 2020 2020  pe"].           
+00006900: 2066 6f72 206e 6f64 6520 696e 2070 6970   for node in pip
+00006910: 655b 226e 6f64 6573 225d 3a0a 2020 2020  e["nodes"]:.    
+00006920: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00006930: 6465 7020 696e 206e 6f64 655b 2264 6570  dep in node["dep
+00006940: 656e 6465 6e63 6965 7322 5d3a 0a20 2020  endencies"]:.   
+00006950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006960: 2069 6620 6465 7020 696e 205b 7069 7065   if dep in [pipe
+00006970: 5b22 6e61 6d65 225d 2066 6f72 2070 6970  ["name"] for pip
+00006980: 6520 696e 2072 656d 6f74 655f 7069 7065  e in remote_pipe
+00006990: 735d 3a0a 2020 2020 2020 2020 2020 2020  s]:.            
+000069a0: 2020 2020 2020 2020 2020 2020 7069 7065              pipe
+000069b0: 735f 6465 7073 2e73 6574 6465 6661 756c  s_deps.setdefaul
+000069c0: 7428 6465 702c 205b 5d29 2e61 7070 656e  t(dep, []).appen
+000069d0: 6428 7069 7065 5b22 6e61 6d65 225d 290a  d(pipe["name"]).
+000069e0: 2020 2020 2020 2020 6465 6c65 7465 645f          deleted_
+000069f0: 7265 736f 7572 6365 733a 2044 6963 745b  resources: Dict[
+00006a00: 7374 722c 2073 7472 5d20 3d20 7b0a 2020  str, str] = {.  
+00006a10: 2020 2020 2020 2020 2020 5061 7468 2872            Path(r
+00006a20: 6573 6f75 7263 6529 2e72 6573 6f6c 7665  esource).resolve
+00006a30: 2829 2e73 7465 6d3a 2072 6573 6f75 7263  ().stem: resourc
+00006a40: 6520 666f 7220 7265 736f 7572 6365 2069  e for resource i
+00006a50: 6e20 6465 6c65 7465 6420 6966 2022 2e69  n deleted if ".i
+00006a60: 6e63 6c22 206e 6f74 2069 6e20 7265 736f  ncl" not in reso
+00006a70: 7572 6365 0a20 2020 2020 2020 207d 0a0a  urce.        }..
+00006a80: 2020 2020 2020 2020 666f 7220 6772 6f75          for grou
+00006a90: 7020 696e 2074 6f70 6f73 6f72 7428 7069  p in toposort(pi
+00006aa0: 7065 735f 6465 7073 293a 0a20 2020 2020  pes_deps):.     
+00006ab0: 2020 2020 2020 2023 2066 6f72 2065 6163         # for eac
+00006ac0: 6820 6c65 7665 6c20 6b65 6570 206d 6174  h level keep mat
+00006ad0: 6572 6961 6c69 7a65 6420 666f 7220 7468  erialized for th
+00006ae0: 6520 656e 640a 2020 2020 2020 2020 2020  e end.          
+00006af0: 2020 666f 7220 7069 7065 5f6e 616d 6520    for pipe_name 
+00006b00: 696e 2073 6f72 7465 6428 6772 6f75 702c  in sorted(group,
+00006b10: 206b 6579 3d6c 616d 6264 6120 783a 2072   key=lambda x: r
+00006b20: 656d 6f74 655f 7069 7065 735f 7479 7065  emote_pipes_type
+00006b30: 5b78 5d20 3d3d 2022 6d61 7465 7269 616c  [x] == "material
+00006b40: 697a 6564 2229 3a0a 2020 2020 2020 2020  ized"):.        
+00006b50: 2020 2020 2020 2020 6966 2070 6970 655f          if pipe_
+00006b60: 6e61 6d65 2069 6e20 6465 6c65 7465 645f  name in deleted_
+00006b70: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+00006b80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006b90: 6573 6f75 7263 655f 7061 7468 203d 2064  esource_path = d
+00006ba0: 656c 6574 6564 5f72 6573 6f75 7263 6573  eleted_resources
+00006bb0: 2e70 6f70 2870 6970 655f 6e61 6d65 290a  .pop(pipe_name).
+00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00006be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bf0: 2061 7761 6974 2072 6573 6f75 7263 655f   await resource_
+00006c00: 6578 7465 6e73 696f 6e5f 7072 6f63 6573  extension_proces
+00006c10: 736f 725b 5061 7468 2872 6573 6f75 7263  sor[Path(resourc
+00006c20: 655f 7061 7468 292e 7375 6666 6978 5d28  e_path).suffix](
+00006c30: 7069 7065 5f6e 616d 652c 2064 7279 5f72  pipe_name, dry_r
+00006c40: 756e 290a 2020 2020 2020 2020 2020 2020  un).            
+00006c50: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00006c60: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c80: 2072 6169 7365 2043 4c49 4769 7452 656c   raise CLIGitRel
+00006c90: 6561 7365 4578 6365 7074 696f 6e28 4665  easeException(Fe
+00006ca0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
+00006cb0: 726f 725f 6669 6c65 5f65 7874 656e 7369  ror_file_extensi
+00006cc0: 6f6e 2866 696c 656e 616d 653d 7265 736f  on(filename=reso
+00006cd0: 7572 6365 5f70 6174 6829 290a 0a20 2020  urce_path))..   
+00006ce0: 2020 2020 2023 2044 656c 6574 6520 7065       # Delete pe
+00006cf0: 6e64 696e 6720 7265 736f 7572 6365 7320  nding resources 
+00006d00: 2864 6174 6173 6f75 7263 6573 290a 2020  (datasources).  
+00006d10: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
+00006d20: 7061 7468 2069 6e20 6465 6c65 7465 645f  path in deleted_
+00006d30: 7265 736f 7572 6365 732e 6974 656d 7328  resources.items(
+00006d40: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00006d50: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00006d60: 2020 2020 6177 6169 7420 7265 736f 7572      await resour
+00006d70: 6365 5f65 7874 656e 7369 6f6e 5f70 726f  ce_extension_pro
+00006d80: 6365 7373 6f72 5b50 6174 6828 7061 7468  cessor[Path(path
+00006d90: 292e 7375 6666 6978 5d28 6e61 6d65 2c20  ).suffix](name, 
+00006da0: 6472 795f 7275 6e29 0a20 2020 2020 2020  dry_run).       
+00006db0: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+00006dc0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00006dd0: 2020 2020 2020 7261 6973 6520 434c 4947        raise CLIG
+00006de0: 6974 5265 6c65 6173 6545 7863 6570 7469  itReleaseExcepti
+00006df0: 6f6e 2846 6565 6462 6163 6b4d 616e 6167  on(FeedbackManag
+00006e00: 6572 2e65 7272 6f72 5f66 696c 655f 6578  er.error_file_ex
+00006e10: 7465 6e73 696f 6e28 6669 6c65 6e61 6d65  tension(filename
+00006e20: 3d70 6174 6829 290a 0a0a 636c 6173 7320  =path))...class 
+00006e30: 4461 7461 6669 6c65 3a0a 2020 2020 6465  Datafile:.    de
+00006e40: 6620 5f5f 696e 6974 5f5f 2873 656c 6629  f __init__(self)
+00006e50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006e60: 2020 7365 6c66 2e6d 6169 6e74 6169 6e65    self.maintaine
+00006e70: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+00006e80: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00006e90: 7365 6c66 2e73 6f75 7263 6573 3a20 4c69  self.sources: Li
+00006ea0: 7374 5b73 7472 5d20 3d20 5b5d 0a20 2020  st[str] = [].   
+00006eb0: 2020 2020 2073 656c 662e 6e6f 6465 733a       self.nodes:
+00006ec0: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+00006ed0: 416e 795d 5d20 3d20 5b5d 0a20 2020 2020  Any]] = [].     
+00006ee0: 2020 2073 656c 662e 746f 6b65 6e73 3a20     self.tokens: 
+00006ef0: 4c69 7374 5b44 6963 745b 7374 722c 2041  List[Dict[str, A
+00006f00: 6e79 5d5d 203d 205b 5d0a 2020 2020 2020  ny]] = [].      
+00006f10: 2020 7365 6c66 2e76 6572 7369 6f6e 3a20    self.version: 
+00006f20: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
+00006f30: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00006f40: 662e 6465 7363 7269 7074 696f 6e3a 204f  f.description: O
+00006f50: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00006f60: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00006f70: 2e72 6177 3a20 4f70 7469 6f6e 616c 5b4c  .raw: Optional[L
+00006f80: 6973 745b 7374 725d 5d20 3d20 4e6f 6e65  ist[str]] = None
+00006f90: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+00006fa0: 636c 7564 6573 3a20 4469 6374 5b73 7472  cludes: Dict[str
+00006fb0: 2c20 416e 795d 203d 207b 7d0a 2020 2020  , Any] = {}.    
+00006fc0: 2020 2020 7365 6c66 2e73 6861 7265 645f      self.shared_
+00006fd0: 7769 7468 3a20 4c69 7374 5b73 7472 5d20  with: List[str] 
+00006fe0: 3d20 5b5d 0a0a 2020 2020 6465 6620 7661  = []..    def va
+00006ff0: 6c69 6461 7465 2873 656c 6629 202d 3e20  lidate(self) -> 
+00007000: 4e6f 6e65 3a0a 2020 2020 2020 2020 666f  None:.        fo
+00007010: 7220 7820 696e 2073 656c 662e 6e6f 6465  r x in self.node
+00007020: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00007030: 6620 6e6f 7420 785b 226e 616d 6522 5d2e  f not x["name"].
+00007040: 7374 7269 7028 293a 0a20 2020 2020 2020  strip():.       
+00007050: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00007060: 616c 6964 6174 696f 6e45 7863 6570 7469  alidationExcepti
+00007070: 6f6e 2822 696e 7661 6c69 6420 6e6f 6465  on("invalid node
+00007080: 206e 616d 652c 2063 616e 2774 2062 6520   name, can't be 
+00007090: 656d 7074 7922 290a 2020 2020 2020 2020  empty").        
+000070a0: 2020 2020 6966 2022 7371 6c22 206e 6f74      if "sql" not
+000070b0: 2069 6e20 783a 0a20 2020 2020 2020 2020   in x:.         
+000070c0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000070d0: 6964 6174 696f 6e45 7863 6570 7469 6f6e  idationException
+000070e0: 2822 6e6f 6465 2025 7320 6d75 7374 2068  ("node %s must h
+000070f0: 6176 6520 6120 5351 4c20 7175 6572 7922  ave a SQL query"
+00007100: 2025 2078 5b22 6e61 6d65 225d 290a 2020   % x["name"]).  
+00007110: 2020 2020 2020 6966 2073 656c 662e 7665        if self.ve
+00007120: 7273 696f 6e20 6973 206e 6f74 204e 6f6e  rsion is not Non
+00007130: 6520 616e 6420 286e 6f74 2069 7369 6e73  e and (not isins
+00007140: 7461 6e63 6528 7365 6c66 2e76 6572 7369  tance(self.versi
+00007150: 6f6e 2c20 696e 7429 206f 7220 7365 6c66  on, int) or self
+00007160: 2e76 6572 7369 6f6e 203c 2030 293a 0a20  .version < 0):. 
+00007170: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007180: 2056 616c 6964 6174 696f 6e45 7863 6570   ValidationExcep
+00007190: 7469 6f6e 2822 7665 7273 696f 6e20 6d75  tion("version mu
+000071a0: 7374 2062 6520 6120 706f 7369 7469 7665  st be a positive
+000071b0: 2069 6e74 6567 6572 2229 0a0a 2020 2020   integer")..    
+000071c0: 6465 6620 6973 5f65 7175 616c 2873 656c  def is_equal(sel
+000071d0: 662c 206f 7468 6572 293a 0a20 2020 2020  f, other):.     
+000071e0: 2020 2069 6620 6c65 6e28 7365 6c66 2e6e     if len(self.n
+000071f0: 6f64 6573 2920 213d 206c 656e 286f 7468  odes) != len(oth
+00007200: 6572 2e6e 6f64 6573 293a 0a20 2020 2020  er.nodes):.     
+00007210: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00007220: 6c73 650a 0a20 2020 2020 2020 2066 6f72  lse..        for
+00007230: 2069 2c20 5f20 696e 2065 6e75 6d65 7261   i, _ in enumera
+00007240: 7465 2873 656c 662e 6e6f 6465 7329 3a0a  te(self.nodes):.
+00007250: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00007260: 656c 662e 6e6f 6465 735b 695d 2021 3d20  elf.nodes[i] != 
+00007270: 6f74 6865 722e 6e6f 6465 735b 695d 3a0a  other.nodes[i]:.
+00007280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007290: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+000072a0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+000072b0: 650a 0a0a 6465 6620 7061 7273 655f 6461  e...def parse_da
+000072c0: 7461 736f 7572 6365 280a 2020 2020 6669  tasource(.    fi
+000072d0: 6c65 6e61 6d65 3a20 7374 722c 2072 6570  lename: str, rep
+000072e0: 6c61 6365 5f69 6e63 6c75 6465 733a 2062  lace_includes: b
+000072f0: 6f6f 6c20 3d20 5472 7565 2c20 636f 6e74  ool = True, cont
+00007300: 656e 743a 204f 7074 696f 6e61 6c5b 7374  ent: Optional[st
+00007310: 725d 203d 204e 6f6e 652c 2073 6b69 705f  r] = None, skip_
+00007320: 6576 616c 3a20 626f 6f6c 203d 2046 616c  eval: bool = Fal
+00007330: 7365 0a29 202d 3e20 4461 7461 6669 6c65  se.) -> Datafile
+00007340: 3a0a 2020 2020 6261 7365 7061 7468 203d  :.    basepath =
+00007350: 2022 220a 2020 2020 6966 206e 6f74 2063   "".    if not c
+00007360: 6f6e 7465 6e74 3a0a 2020 2020 2020 2020  ontent:.        
+00007370: 7769 7468 206f 7065 6e28 6669 6c65 6e61  with open(filena
+00007380: 6d65 2920 6173 2066 696c 653a 0a20 2020  me) as file:.   
+00007390: 2020 2020 2020 2020 2073 203d 2066 696c           s = fil
+000073a0: 652e 7265 6164 2829 0a20 2020 2020 2020  e.read().       
+000073b0: 2062 6173 6570 6174 6820 3d20 6f73 2e70   basepath = os.p
+000073c0: 6174 682e 6469 726e 616d 6528 6669 6c65  ath.dirname(file
+000073d0: 6e61 6d65 290a 2020 2020 656c 7365 3a0a  name).    else:.
+000073e0: 2020 2020 2020 2020 7320 3d20 636f 6e74          s = cont
+000073f0: 656e 740a 0a20 2020 2074 7279 3a0a 2020  ent..    try:.  
+00007400: 2020 2020 2020 646f 6320 3d20 7061 7273        doc = pars
+00007410: 6528 732c 2022 6465 6661 756c 7422 2c20  e(s, "default", 
+00007420: 6261 7365 7061 7468 2c20 7265 706c 6163  basepath, replac
+00007430: 655f 696e 636c 7564 6573 3d72 6570 6c61  e_includes=repla
+00007440: 6365 5f69 6e63 6c75 6465 732c 2073 6b69  ce_includes, ski
+00007450: 705f 6576 616c 3d73 6b69 705f 6576 616c  p_eval=skip_eval
+00007460: 290a 2020 2020 6578 6365 7074 2050 6172  ).    except Par
+00007470: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
+00007480: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007490: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+000074a0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+000074b0: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
+000074c0: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
+000074d0: 6669 6c65 2866 696c 656e 616d 653d 6669  file(filename=fi
+000074e0: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d65  lename, lineno=e
+000074f0: 2e6c 696e 656e 6f2c 2065 7272 6f72 3d65  .lineno, error=e
+00007500: 290a 2020 2020 2020 2020 2920 6672 6f6d  ).        ) from
+00007510: 204e 6f6e 650a 0a20 2020 2069 6620 6c65   None..    if le
+00007520: 6e28 646f 632e 6e6f 6465 7329 203e 2031  n(doc.nodes) > 1
+00007530: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007540: 5661 6c75 6545 7272 6f72 2866 227b 6669  ValueError(f"{fi
+00007550: 6c65 6e61 6d65 7d3a 2064 6174 6173 6f75  lename}: datasou
+00007560: 7263 6573 2063 616e 2774 2068 6176 6520  rces can't have 
+00007570: 6d6f 7265 2074 6861 6e20 6f6e 6520 6e6f  more than one no
+00007580: 6465 2229 0a0a 2020 2020 7265 7475 726e  de")..    return
+00007590: 2064 6f63 0a0a 0a64 6566 2070 6172 7365   doc...def parse
+000075a0: 5f70 6970 6528 0a20 2020 2066 696c 656e  _pipe(.    filen
+000075b0: 616d 653a 2073 7472 2c20 7265 706c 6163  ame: str, replac
+000075c0: 655f 696e 636c 7564 6573 3a20 626f 6f6c  e_includes: bool
+000075d0: 203d 2054 7275 652c 2063 6f6e 7465 6e74   = True, content
+000075e0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+000075f0: 3d20 4e6f 6e65 2c20 736b 6970 5f65 7661  = None, skip_eva
+00007600: 6c3a 2062 6f6f 6c20 3d20 4661 6c73 650a  l: bool = False.
+00007610: 2920 2d3e 2044 6174 6166 696c 653a 0a20  ) -> Datafile:. 
+00007620: 2020 2062 6173 6570 6174 6820 3d20 2222     basepath = ""
+00007630: 0a20 2020 2069 6620 6e6f 7420 636f 6e74  .    if not cont
+00007640: 656e 743a 0a20 2020 2020 2020 2077 6974  ent:.        wit
+00007650: 6820 6f70 656e 2866 696c 656e 616d 6529  h open(filename)
+00007660: 2061 7320 6669 6c65 3a0a 2020 2020 2020   as file:.      
+00007670: 2020 2020 2020 7320 3d20 6669 6c65 2e72        s = file.r
+00007680: 6561 6428 290a 2020 2020 2020 2020 6261  ead().        ba
+00007690: 7365 7061 7468 203d 206f 732e 7061 7468  sepath = os.path
+000076a0: 2e64 6972 6e61 6d65 2866 696c 656e 616d  .dirname(filenam
+000076b0: 6529 0a20 2020 2065 6c73 653a 0a20 2020  e).    else:.   
+000076c0: 2020 2020 2073 203d 2063 6f6e 7465 6e74       s = content
+000076d0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+000076e0: 2020 2073 716c 203d 2022 220a 2020 2020     sql = "".    
+000076f0: 2020 2020 646f 6320 3d20 7061 7273 6528      doc = parse(
+00007700: 732c 2062 6173 6570 6174 683d 6261 7365  s, basepath=base
+00007710: 7061 7468 2c20 7265 706c 6163 655f 696e  path, replace_in
+00007720: 636c 7564 6573 3d72 6570 6c61 6365 5f69  cludes=replace_i
+00007730: 6e63 6c75 6465 732c 2073 6b69 705f 6576  ncludes, skip_ev
+00007740: 616c 3d73 6b69 705f 6576 616c 290a 2020  al=skip_eval).  
+00007750: 2020 2020 2020 666f 7220 6e6f 6465 2069        for node i
+00007760: 6e20 646f 632e 6e6f 6465 733a 0a20 2020  n doc.nodes:.   
+00007770: 2020 2020 2020 2020 2073 716c 203d 206e           sql = n
+00007780: 6f64 652e 6765 7428 2273 716c 222c 2022  ode.get("sql", "
+00007790: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
+000077a0: 6620 7371 6c2e 7374 7269 7028 295b 305d  f sql.strip()[0]
+000077b0: 203d 3d20 2225 223a 0a20 2020 2020 2020   == "%":.       
+000077c0: 2020 2020 2020 2020 2073 716c 2c20 5f20           sql, _ 
+000077d0: 3d20 7265 6e64 6572 5f73 716c 5f74 656d  = render_sql_tem
+000077e0: 706c 6174 6528 7371 6c5b 313a 5d2c 2074  plate(sql[1:], t
+000077f0: 6573 745f 6d6f 6465 3d54 7275 652c 206e  est_mode=True, n
+00007800: 616d 653d 6e6f 6465 5b22 6e61 6d65 225d  ame=node["name"]
+00007810: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00007820: 6974 276c 6c20 6661 696c 2077 6974 6820  it'll fail with 
+00007830: 6120 4d6f 6475 6c65 4e6f 7446 6f75 6e64  a ModuleNotFound
+00007840: 4572 726f 7220 7768 656e 2074 6865 2074  Error when the t
+00007850: 6f6f 6c73 6574 2069 7320 6e6f 7420 6176  oolset is not av
+00007860: 6169 6c61 626c 6520 6275 7420 6974 2072  ailable but it r
+00007870: 6574 7572 6e73 2074 6865 2070 6172 7365  eturns the parse
+00007880: 6420 646f 630a 2020 2020 2020 2020 2020  d doc.          
+00007890: 2020 6672 6f6d 2074 696e 7962 6972 642e    from tinybird.
+000078a0: 7371 6c5f 746f 6f6c 7365 7420 696d 706f  sql_toolset impo
+000078b0: 7274 2066 6f72 6d61 745f 7371 6c20 6173  rt format_sql as
+000078c0: 2074 6f6f 6c73 6574 5f66 6f72 6d61 745f   toolset_format_
+000078d0: 7371 6c0a 0a20 2020 2020 2020 2020 2020  sql..           
+000078e0: 2074 6f6f 6c73 6574 5f66 6f72 6d61 745f   toolset_format_
+000078f0: 7371 6c28 7371 6c29 0a20 2020 2065 7863  sql(sql).    exc
+00007900: 6570 7420 5061 7273 6545 7863 6570 7469  ept ParseExcepti
+00007910: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00007920: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+00007930: 636b 4578 6365 7074 696f 6e28 0a20 2020  ckException(.   
+00007940: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
+00007950: 6b4d 616e 6167 6572 2e65 7272 6f72 5f70  kManager.error_p
+00007960: 6172 7369 6e67 5f66 696c 6528 0a20 2020  arsing_file(.   
+00007970: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00007980: 656e 616d 653d 6669 6c65 6e61 6d65 2c20  ename=filename, 
+00007990: 6c69 6e65 6e6f 3d65 2e6c 696e 656e 6f2c  lineno=e.lineno,
+000079a0: 2065 7272 6f72 3d66 227b 7374 7228 6529   error=f"{str(e)
+000079b0: 7d20 2b20 5351 4c28 7061 7273 6520 6578  } + SQL(parse ex
+000079c0: 6365 7074 696f 6e29 3a20 7b73 716c 7d22  ception): {sql}"
+000079d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000079e0: 2020 2020 2020 2029 0a20 2020 2065 7863         ).    exc
+000079f0: 6570 7420 5661 6c75 6545 7272 6f72 2061  ept ValueError a
+00007a00: 7320 653a 0a20 2020 2020 2020 2074 2c20  s e:.        t, 
+00007a10: 7465 6d70 6c61 7465 5f76 6172 6961 626c  template_variabl
+00007a20: 6573 203d 2067 6574 5f74 656d 706c 6174  es = get_templat
+00007a30: 655f 616e 645f 7661 7269 6162 6c65 7328  e_and_variables(
+00007a40: 7371 6c2c 206e 616d 653d 6e6f 6465 5b22  sql, name=node["
+00007a50: 6e61 6d65 225d 290a 0a20 2020 2020 2020  name"])..       
+00007a60: 2069 6620 7371 6c2e 7374 7269 7028 295b   if sql.strip()[
+00007a70: 305d 2021 3d20 2225 2220 616e 6420 6c65  0] != "%" and le
+00007a80: 6e28 7465 6d70 6c61 7465 5f76 6172 6961  n(template_varia
+00007a90: 626c 6573 2920 3e20 303a 0a20 2020 2020  bles) > 0:.     
+00007aa0: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
+00007ab0: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
+00007ac0: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
+00007ad0: 722e 6572 726f 725f 7465 6d70 6c61 7465  r.error_template
+00007ae0: 5f73 7461 7274 2866 696c 656e 616d 653d  _start(filename=
+00007af0: 6669 6c65 6e61 6d65 2929 0a20 2020 2020  filename)).     
+00007b00: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
+00007b10: 6c69 636b 4578 6365 7074 696f 6e28 0a20  lickException(. 
+00007b20: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
+00007b30: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+00007b40: 5f70 6172 7369 6e67 5f66 696c 6528 0a20  _parsing_file(. 
+00007b50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007b60: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
+00007b70: 2c20 6c69 6e65 6e6f 3d22 222c 2065 7272  , lineno="", err
+00007b80: 6f72 3d66 227b 7374 7228 6529 7d20 2b20  or=f"{str(e)} + 
+00007b90: 5351 4c28 7661 6c75 6520 6572 726f 7229  SQL(value error)
+00007ba0: 3a20 7b73 716c 7d22 0a20 2020 2020 2020  : {sql}".       
+00007bb0: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
+00007bc0: 0a20 2020 2065 7863 6570 7420 556e 436c  .    except UnCl
+00007bd0: 6f73 6564 4966 4572 726f 7220 6173 2065  osedIfError as e
+00007be0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007bf0: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+00007c00: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00007c10: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
+00007c20: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
+00007c30: 6e6f 6465 5f77 6974 685f 756e 636c 6f73  node_with_unclos
+00007c40: 6564 5f69 6628 6e6f 6465 3d65 2e6e 6f64  ed_if(node=e.nod
+00007c50: 652c 2070 6970 653d 6669 6c65 6e61 6d65  e, pipe=filename
+00007c60: 2c20 6c69 6e65 6e6f 3d65 2e6c 696e 656e  , lineno=e.linen
+00007c70: 6f2c 2073 716c 3d65 2e73 716c 290a 2020  o, sql=e.sql).  
+00007c80: 2020 2020 2020 290a 2020 2020 6578 6365        ).    exce
+00007c90: 7074 204d 6f64 756c 654e 6f74 466f 756e  pt ModuleNotFoun
+00007ca0: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
+00007cb0: 7061 7373 0a0a 2020 2020 7265 7475 726e  pass..    return
+00007cc0: 2064 6f63 0a0a 0a64 6566 2070 6172 7365   doc...def parse
+00007cd0: 5f74 6f6b 656e 280a 2020 2020 6669 6c65  _token(.    file
+00007ce0: 6e61 6d65 3a20 7374 722c 2072 6570 6c61  name: str, repla
+00007cf0: 6365 5f69 6e63 6c75 6465 733a 2062 6f6f  ce_includes: boo
+00007d00: 6c20 3d20 5472 7565 2c20 636f 6e74 656e  l = True, conten
+00007d10: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
+00007d20: 203d 204e 6f6e 652c 2073 6b69 705f 6576   = None, skip_ev
+00007d30: 616c 3a20 626f 6f6c 203d 2046 616c 7365  al: bool = False
+00007d40: 0a29 202d 3e20 4461 7461 6669 6c65 3a0a  .) -> Datafile:.
+00007d50: 2020 2020 6966 206e 6f74 2063 6f6e 7465      if not conte
+00007d60: 6e74 3a0a 2020 2020 2020 2020 7769 7468  nt:.        with
+00007d70: 206f 7065 6e28 6669 6c65 6e61 6d65 2920   open(filename) 
+00007d80: 6173 2066 696c 653a 0a20 2020 2020 2020  as file:.       
+00007d90: 2020 2020 2073 203d 2066 696c 652e 7265       s = file.re
+00007da0: 6164 2829 0a20 2020 2020 2020 2062 6173  ad().        bas
+00007db0: 6570 6174 6820 3d20 6f73 2e70 6174 682e  epath = os.path.
+00007dc0: 6469 726e 616d 6528 6669 6c65 6e61 6d65  dirname(filename
+00007dd0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00007de0: 2020 2020 7320 3d20 636f 6e74 656e 740a      s = content.
+00007df0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00007e00: 2020 7371 6c20 3d20 2222 0a20 2020 2020    sql = "".     
+00007e10: 2020 2064 6f63 203d 2070 6172 7365 2873     doc = parse(s
+00007e20: 2c20 6261 7365 7061 7468 3d62 6173 6570  , basepath=basep
+00007e30: 6174 682c 2072 6570 6c61 6365 5f69 6e63  ath, replace_inc
+00007e40: 6c75 6465 733d 7265 706c 6163 655f 696e  ludes=replace_in
+00007e50: 636c 7564 6573 2c20 736b 6970 5f65 7661  cludes, skip_eva
+00007e60: 6c3d 736b 6970 5f65 7661 6c29 0a20 2020  l=skip_eval).   
+00007e70: 2065 7863 6570 7420 5061 7273 6545 7863   except ParseExc
+00007e80: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00007e90: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
+00007ea0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
+00007eb0: 0a20 2020 2020 2020 2020 2020 2046 6565  .            Fee
+00007ec0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+00007ed0: 6f72 5f70 6172 7369 6e67 5f66 696c 6528  or_parsing_file(
+00007ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007ef0: 2066 696c 656e 616d 653d 6669 6c65 6e61   filename=filena
+00007f00: 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c 696e  me, lineno=e.lin
+00007f10: 656e 6f2c 2065 7272 6f72 3d66 227b 7374  eno, error=f"{st
+00007f20: 7228 6529 7d20 2b20 5351 4c28 7061 7273  r(e)} + SQL(pars
+00007f30: 6520 6578 6365 7074 696f 6e29 3a20 7b73  e exception): {s
+00007f40: 716c 7d22 0a20 2020 2020 2020 2020 2020  ql}".           
+00007f50: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
+00007f60: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+00007f70: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+00007f80: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+00007f90: 636b 4578 6365 7074 696f 6e28 0a20 2020  ckException(.   
+00007fa0: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
+00007fb0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f70  kManager.error_p
+00007fc0: 6172 7369 6e67 5f66 696c 6528 0a20 2020  arsing_file(.   
+00007fd0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00007fe0: 656e 616d 653d 6669 6c65 6e61 6d65 2c20  ename=filename, 
+00007ff0: 6c69 6e65 6e6f 3d22 222c 2065 7272 6f72  lineno="", error
+00008000: 3d66 227b 7374 7228 6529 7d20 2b20 5351  =f"{str(e)} + SQ
+00008010: 4c28 7661 6c75 6520 6572 726f 7229 3a20  L(value error): 
+00008020: 7b73 716c 7d22 0a20 2020 2020 2020 2020  {sql}".         
+00008030: 2020 2029 0a20 2020 2020 2020 2029 0a20     ).        ). 
+00008040: 2020 2065 7863 6570 7420 556e 436c 6f73     except UnClos
+00008050: 6564 4966 4572 726f 7220 6173 2065 3a0a  edIfError as e:.
+00008060: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
+00008070: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
+00008080: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00008090: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+000080a0: 6572 726f 725f 7061 7273 696e 675f 6e6f  error_parsing_no
+000080b0: 6465 5f77 6974 685f 756e 636c 6f73 6564  de_with_unclosed
+000080c0: 5f69 6628 6e6f 6465 3d65 2e6e 6f64 652c  _if(node=e.node,
+000080d0: 2070 6970 653d 6669 6c65 6e61 6d65 2c20   pipe=filename, 
+000080e0: 6c69 6e65 6e6f 3d65 2e6c 696e 656e 6f2c  lineno=e.lineno,
+000080f0: 2073 716c 3d65 2e73 716c 290a 2020 2020   sql=e.sql).    
+00008100: 2020 2020 290a 2020 2020 6578 6365 7074      ).    except
+00008110: 204d 6f64 756c 654e 6f74 466f 756e 6445   ModuleNotFoundE
+00008120: 7272 6f72 3a0a 2020 2020 2020 2020 7061  rror:.        pa
+00008130: 7373 0a0a 2020 2020 7265 7475 726e 2064  ss..    return d
+00008140: 6f63 0a0a 0a64 6566 205f 756e 7175 6f74  oc...def _unquot
+00008150: 6528 783a 2073 7472 293a 0a20 2020 2051  e(x: str):.    Q
+00008160: 554f 5445 5320 3d20 2827 2227 2c20 2227  UOTES = ('"', "'
+00008170: 2229 0a20 2020 2069 6620 785b 305d 2069  ").    if x[0] i
+00008180: 6e20 5155 4f54 4553 2061 6e64 2078 5b2d  n QUOTES and x[-
+00008190: 315d 2069 6e20 5155 4f54 4553 3a0a 2020  1] in QUOTES:.  
+000081a0: 2020 2020 2020 7820 3d20 785b 313a 2d31        x = x[1:-1
+000081b0: 5d0a 2020 2020 7265 7475 726e 2078 0a0a  ].    return x..
+000081c0: 0a64 6566 2065 7661 6c5f 7661 7228 733a  .def eval_var(s:
+000081d0: 2073 7472 2c20 736b 6970 3a20 626f 6f6c   str, skip: bool
+000081e0: 203d 2046 616c 7365 2920 2d3e 2073 7472   = False) -> str
+000081f0: 3a0a 2020 2020 6966 2073 6b69 703a 0a20  :.    if skip:. 
+00008200: 2020 2020 2020 2072 6574 7572 6e20 730a         return s.
+00008210: 2020 2020 2320 7265 706c 6163 6520 454e      # replace EN
+00008220: 5620 7661 7269 6162 6c65 730a 2020 2020  V variables.    
+00008230: 2320 6974 2773 2070 726f 6261 626c 7920  # it's probably 
+00008240: 6120 6261 6420 6964 6561 2074 6f20 616c  a bad idea to al
+00008250: 6c6f 7720 746f 2067 6574 2061 6e79 2065  low to get any e
+00008260: 6e76 2076 6172 0a20 2020 2072 6574 7572  nv var.    retur
+00008270: 6e20 5465 6d70 6c61 7465 2873 292e 7361  n Template(s).sa
+00008280: 6665 5f73 7562 7374 6974 7574 6528 6f73  fe_substitute(os
+00008290: 2e65 6e76 6972 6f6e 290a 0a0a 6465 6620  .environ)...def 
+000082a0: 7061 7273 6528 0a20 2020 2073 3a20 7374  parse(.    s: st
+000082b0: 722c 0a20 2020 2064 6566 6175 6c74 5f6e  r,.    default_n
+000082c0: 6f64 653a 204f 7074 696f 6e61 6c5b 7374  ode: Optional[st
+000082d0: 725d 203d 204e 6f6e 652c 0a20 2020 2062  r] = None,.    b
+000082e0: 6173 6570 6174 683a 2073 7472 203d 2022  asepath: str = "
+000082f0: 2e22 2c0a 2020 2020 7265 706c 6163 655f  .",.    replace_
+00008300: 696e 636c 7564 6573 3a20 626f 6f6c 203d  includes: bool =
+00008310: 2054 7275 652c 0a20 2020 2073 6b69 705f   True,.    skip_
+00008320: 6576 616c 3a20 626f 6f6c 203d 2046 616c  eval: bool = Fal
+00008330: 7365 2c0a 2920 2d3e 2044 6174 6166 696c  se,.) -> Datafil
+00008340: 653a 2020 2320 6e6f 7161 3a20 4339 3031  e:  # noqa: C901
+00008350: 0a20 2020 2022 2222 0a20 2020 2050 6172  .    """.    Par
+00008360: 7365 7320 6073 6020 7374 7269 6e67 2069  ses `s` string i
+00008370: 6e74 6f20 6120 646f 6375 6d65 6e74 0a20  nto a document. 
+00008380: 2020 203e 3e3e 2064 203d 2070 6172 7365     >>> d = parse
+00008390: 2822 4652 4f4d 2053 4352 4154 4348 5c5c  ("FROM SCRATCH\\
+000083a0: 6e53 4f55 5243 4520 2768 7474 7073 3a2f  nSOURCE 'https:/
+000083b0: 2f65 7861 6d70 6c65 2e63 6f6d 275c 5c6e  /example.com'\\n
+000083c0: 2374 6869 7320 6973 2061 2063 6f6d 6d65  #this is a comme
+000083d0: 6e74 5c5c 6e4d 4149 4e54 4149 4e45 5220  nt\\nMAINTAINER 
+000083e0: 2772 616d 626f 2720 2374 6869 7320 6973  'rambo' #this is
+000083f0: 206d 655c 5c6e 4e4f 4445 205c 5c22 7465   me\\nNODE \\"te
+00008400: 7374 5f30 315c 5c22 5c5c 6e20 2020 2044  st_01\\"\\n    D
+00008410: 4553 4352 4950 5449 4f4e 2074 6869 7320  ESCRIPTION this 
+00008420: 6973 2061 206e 6f64 6520 7468 6174 2064  is a node that d
+00008430: 6f65 7320 7768 6174 6576 6572 5c5c 6e53  oes whatever\\nS
+00008440: 514c 203e 5c5c 6e5c 5c6e 2020 2020 2020  QL >\\n\\n      
+00008450: 2020 5345 4c45 4354 202a 2066 726f 6d20    SELECT * from 
+00008460: 7465 7374 5f30 305c 5c6e 5c5c 6e5c 5c6e  test_00\\n\\n\\n
+00008470: 4e4f 4445 205c 5c22 7465 7374 5f30 325c  NODE \\"test_02\
+00008480: 5c22 5c5c 6e20 2020 2044 4553 4352 4950  \"\\n    DESCRIP
+00008490: 5449 4f4e 2074 6869 7320 6973 2061 206e  TION this is a n
+000084a0: 6f64 6520 7468 6174 2064 6f65 7320 7768  ode that does wh
+000084b0: 6174 6576 6572 5c5c 6e53 514c 203e 5c5c  atever\\nSQL >\\
+000084c0: 6e5c 5c6e 2020 2020 5345 4c45 4354 202a  n\\n    SELECT *
+000084d0: 2066 726f 6d20 7465 7374 5f30 315c 5c6e   from test_01\\n
+000084e0: 2020 2020 5748 4552 4520 6120 3e20 315c      WHERE a > 1\
+000084f0: 5c6e 2020 2020 4752 4f55 5020 6279 2061  \n    GROUP by a
+00008500: 5c5c 6e22 290a 2020 2020 3e3e 3e20 642e  \\n").    >>> d.
+00008510: 6d61 696e 7461 696e 6572 0a20 2020 2027  maintainer.    '
+00008520: 7261 6d62 6f27 0a20 2020 203e 3e3e 2064  rambo'.    >>> d
+00008530: 2e73 6f75 7263 6573 0a20 2020 205b 2768  .sources.    ['h
+00008540: 7474 7073 3a2f 2f65 7861 6d70 6c65 2e63  ttps://example.c
+00008550: 6f6d 275d 0a20 2020 203e 3e3e 206c 656e  om'].    >>> len
+00008560: 2864 2e6e 6f64 6573 290a 2020 2020 320a  (d.nodes).    2.
+00008570: 2020 2020 3e3e 3e20 642e 6e6f 6465 735b      >>> d.nodes[
+00008580: 305d 0a20 2020 207b 276e 616d 6527 3a20  0].    {'name': 
+00008590: 2774 6573 745f 3031 272c 2027 6465 7363  'test_01', 'desc
+000085a0: 7269 7074 696f 6e27 3a20 2774 6869 7320  ription': 'this 
+000085b0: 6973 2061 206e 6f64 6520 7468 6174 2064  is a node that d
+000085c0: 6f65 7320 7768 6174 6576 6572 272c 2027  oes whatever', '
+000085d0: 7371 6c27 3a20 2753 454c 4543 5420 2a20  sql': 'SELECT * 
+000085e0: 6672 6f6d 2074 6573 745f 3030 277d 0a20  from test_00'}. 
+000085f0: 2020 203e 3e3e 2064 2e6e 6f64 6573 5b31     >>> d.nodes[1
+00008600: 5d0a 2020 2020 7b27 6e61 6d65 273a 2027  ].    {'name': '
+00008610: 7465 7374 5f30 3227 2c20 2764 6573 6372  test_02', 'descr
+00008620: 6970 7469 6f6e 273a 2027 7468 6973 2069  iption': 'this i
+00008630: 7320 6120 6e6f 6465 2074 6861 7420 646f  s a node that do
+00008640: 6573 2077 6861 7465 7665 7227 2c20 2773  es whatever', 's
+00008650: 716c 273a 2027 5345 4c45 4354 202a 2066  ql': 'SELECT * f
+00008660: 726f 6d20 7465 7374 5f30 315c 5c6e 5748  rom test_01\\nWH
+00008670: 4552 4520 6120 3e20 315c 5c6e 4752 4f55  ERE a > 1\\nGROU
+00008680: 5020 6279 2061 277d 0a20 2020 2022 2222  P by a'}.    """
+00008690: 0a20 2020 206c 696e 6573 203d 206c 6973  .    lines = lis
+000086a0: 7428 5374 7269 6e67 494f 2873 2c20 6e65  t(StringIO(s, ne
+000086b0: 776c 696e 653d 4e6f 6e65 2929 0a0a 2020  wline=None))..  
+000086c0: 2020 646f 6320 3d20 4461 7461 6669 6c65    doc = Datafile
+000086d0: 2829 0a20 2020 2064 6f63 2e72 6177 203d  ().    doc.raw =
+000086e0: 206c 6973 7428 5374 7269 6e67 494f 2873   list(StringIO(s
+000086f0: 2c20 6e65 776c 696e 653d 4e6f 6e65 2929  , newline=None))
+00008700: 0a0a 2020 2020 7061 7273 6572 5f73 7461  ..    parser_sta
+00008710: 7465 203d 206e 616d 6564 7475 706c 6528  te = namedtuple(
+00008720: 2270 6172 7365 725f 7374 6174 6522 2c20  "parser_state", 
+00008730: 5b22 6d75 6c74 696c 696e 6522 2c20 2263  ["multiline", "c
+00008740: 7572 7265 6e74 5f6e 6f64 6522 2c20 2263  urrent_node", "c
+00008750: 6f6d 6d61 6e64 222c 2022 6d75 6c74 696c  ommand", "multil
+00008760: 696e 655f 7374 7269 6e67 222c 2022 6973  ine_string", "is
+00008770: 5f73 716c 225d 290a 0a20 2020 2070 6172  _sql"])..    par
+00008780: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
+00008790: 696e 6520 3d20 4661 6c73 650a 2020 2020  ine = False.    
+000087a0: 7061 7273 6572 5f73 7461 7465 2e63 7572  parser_state.cur
+000087b0: 7265 6e74 5f6e 6f64 6520 3d20 4661 6c73  rent_node = Fals
+000087c0: 650a 0a20 2020 2064 6566 2061 7373 6967  e..    def assig
+000087d0: 6e28 6174 7472 293a 0a20 2020 2020 2020  n(attr):.       
+000087e0: 2064 6566 205f 666e 2878 2c20 2a2a 6b77   def _fn(x, **kw
+000087f0: 6172 6773 293a 0a20 2020 2020 2020 2020  args):.         
+00008800: 2020 2073 6574 6174 7472 2864 6f63 2c20     setattr(doc, 
+00008810: 6174 7472 2c20 5f75 6e71 756f 7465 2878  attr, _unquote(x
+00008820: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
+00008830: 726e 205f 666e 0a0a 2020 2020 6465 6620  rn _fn..    def 
+00008840: 7363 6865 6d61 282a 6172 6773 2c20 2a2a  schema(*args, **
+00008850: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00008860: 2073 203d 205f 756e 7175 6f74 6528 2222   s = _unquote(""
+00008870: 2e6a 6f69 6e28 6172 6773 2929 0a20 2020  .join(args)).   
+00008880: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00008890: 2020 2020 2020 7368 203d 2070 6172 7365        sh = parse
+000088a0: 5f74 6162 6c65 5f73 7472 7563 7475 7265  _table_structure
+000088b0: 2873 290a 2020 2020 2020 2020 6578 6365  (s).        exce
+000088c0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+000088d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+000088e0: 6169 7365 2050 6172 7365 4578 6365 7074  aise ParseExcept
+000088f0: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+00008900: 6765 722e 6572 726f 725f 7061 7273 696e  ger.error_parsin
+00008910: 675f 7363 6865 6d61 286c 696e 653d 6b77  g_schema(line=kw
+00008920: 6172 6773 5b22 6c69 6e65 6e6f 225d 2c20  args["lineno"], 
+00008930: 6572 726f 723d 6529 290a 0a20 2020 2020  error=e))..     
+00008940: 2020 2070 6172 7365 725f 7374 6174 652e     parser_state.
+00008950: 6375 7272 656e 745f 6e6f 6465 5b22 7363  current_node["sc
+00008960: 6865 6d61 225d 203d 2022 2c22 2e6a 6f69  hema"] = ",".joi
+00008970: 6e28 7363 6865 6d61 5f74 6f5f 7371 6c5f  n(schema_to_sql_
+00008980: 636f 6c75 6d6e 7328 7368 2929 0a20 2020  columns(sh)).   
+00008990: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
+000089a0: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
+000089b0: 636f 6c75 6d6e 7322 5d20 3d20 7368 0a0a  columns"] = sh..
+000089c0: 2020 2020 6465 6620 696e 6465 7865 7328      def indexes(
+000089d0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+000089e0: 3a0a 2020 2020 2020 2020 7320 3d20 5f75  :.        s = _u
+000089f0: 6e71 756f 7465 2822 222e 6a6f 696e 2861  nquote("".join(a
+00008a00: 7267 7329 290a 2020 2020 2020 2020 6966  rgs)).        if
+00008a10: 206e 6f74 2073 3a0a 2020 2020 2020 2020   not s:.        
+00008a20: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+00008a30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00008a40: 2020 2020 696e 6465 7865 7320 3d20 7061      indexes = pa
+00008a50: 7273 655f 696e 6465 7865 735f 7374 7275  rse_indexes_stru
+00008a60: 6374 7572 6528 732e 7370 6c69 746c 696e  cture(s.splitlin
+00008a70: 6573 2829 290a 2020 2020 2020 2020 6578  es()).        ex
+00008a80: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00008a90: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00008aa0: 2072 6169 7365 2050 6172 7365 4578 6365   raise ParseExce
+00008ab0: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+00008ac0: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
+00008ad0: 696e 675f 696e 6469 6365 7328 6c69 6e65  ing_indices(line
+00008ae0: 3d6b 7761 7267 735b 226c 696e 656e 6f22  =kwargs["lineno"
+00008af0: 5d2c 2065 7272 6f72 3d65 2929 0a0a 2020  ], error=e))..  
+00008b00: 2020 2020 2020 7061 7273 6572 5f73 7461        parser_sta
+00008b10: 7465 2e63 7572 7265 6e74 5f6e 6f64 655b  te.current_node[
+00008b20: 2269 6e64 6578 6573 225d 203d 2069 6e64  "indexes"] = ind
+00008b30: 6578 6573 0a0a 2020 2020 6465 6620 6173  exes..    def as
+00008b40: 7369 676e 5f76 6172 2876 3a20 7374 7229  sign_var(v: str)
+00008b50: 202d 3e20 4361 6c6c 6162 6c65 5b5b 5661   -> Callable[[Va
+00008b60: 7241 7267 2873 7472 292c 204b 7741 7267  rArg(str), KwArg
+00008b70: 2841 6e79 295d 2c20 4e6f 6e65 5d3a 0a20  (Any)], None]:. 
+00008b80: 2020 2020 2020 2064 6566 205f 6628 2a61         def _f(*a
+00008b90: 7267 733a 2073 7472 2c20 2a2a 6b77 6172  rgs: str, **kwar
+00008ba0: 6773 3a20 416e 7929 3a0a 2020 2020 2020  gs: Any):.      
+00008bb0: 2020 2020 2020 7320 3d20 5f75 6e71 756f        s = _unquo
+00008bc0: 7465 2828 2220 222e 6a6f 696e 2861 7267  te((" ".join(arg
+00008bd0: 7329 292e 7374 7269 7028 2929 0a20 2020  s)).strip()).   
+00008be0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
+00008bf0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
+00008c00: 6465 5b76 2e6c 6f77 6572 2829 5d20 3d20  de[v.lower()] = 
+00008c10: 6576 616c 5f76 6172 2873 2c20 736b 6970  eval_var(s, skip
+00008c20: 3d73 6b69 705f 6576 616c 290a 0a20 2020  =skip_eval)..   
+00008c30: 2020 2020 2072 6574 7572 6e20 5f66 0a0a       return _f..
+00008c40: 2020 2020 6465 6620 736f 7572 6365 7328      def sources(
+00008c50: 783a 2073 7472 2c20 2a2a 6b77 6172 6773  x: str, **kwargs
+00008c60: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
+00008c70: 2020 2020 2020 2020 646f 632e 736f 7572          doc.sour
+00008c80: 6365 732e 6170 7065 6e64 285f 756e 7175  ces.append(_unqu
+00008c90: 6f74 6528 7829 290a 0a20 2020 2064 6566  ote(x))..    def
+00008ca0: 206e 6f64 6528 2a61 7267 733a 2073 7472   node(*args: str
+00008cb0: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+00008cc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00008cd0: 2020 6e6f 6465 203d 207b 226e 616d 6522    node = {"name"
+00008ce0: 3a20 6576 616c 5f76 6172 285f 756e 7175  : eval_var(_unqu
+00008cf0: 6f74 6528 6172 6773 5b30 5d29 297d 0a20  ote(args[0]))}. 
+00008d00: 2020 2020 2020 2064 6f63 2e6e 6f64 6573         doc.nodes
+00008d10: 2e61 7070 656e 6428 6e6f 6465 290a 2020  .append(node).  
+00008d20: 2020 2020 2020 7061 7273 6572 5f73 7461        parser_sta
+00008d30: 7465 2e63 7572 7265 6e74 5f6e 6f64 6520  te.current_node 
+00008d40: 3d20 6e6f 6465 0a0a 2020 2020 6465 6620  = node..    def 
+00008d50: 7363 6f70 6528 2a61 7267 733a 2073 7472  scope(*args: str
+00008d60: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+00008d70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00008d80: 2020 7363 6f70 6520 3d20 7b22 6e61 6d65    scope = {"name
+00008d90: 223a 2065 7661 6c5f 7661 7228 5f75 6e71  ": eval_var(_unq
+00008da0: 756f 7465 2861 7267 735b 305d 2929 7d0a  uote(args[0]))}.
+00008db0: 2020 2020 2020 2020 646f 632e 6e6f 6465          doc.node
+00008dc0: 732e 6170 7065 6e64 2873 636f 7065 290a  s.append(scope).
+00008dd0: 2020 2020 2020 2020 7061 7273 6572 5f73          parser_s
+00008de0: 7461 7465 2e63 7572 7265 6e74 5f6e 6f64  tate.current_nod
+00008df0: 6520 3d20 7363 6f70 650a 0a20 2020 2064  e = scope..    d
+00008e00: 6566 2064 6573 6372 6970 7469 6f6e 282a  ef description(*
+00008e10: 6172 6773 3a20 7374 722c 202a 2a6b 7761  args: str, **kwa
+00008e20: 7267 733a 2041 6e79 2920 2d3e 204e 6f6e  rgs: Any) -> Non
+00008e30: 653a 0a20 2020 2020 2020 2064 6573 6372  e:.        descr
+00008e40: 6970 7469 6f6e 203d 2028 2220 222e 6a6f  iption = (" ".jo
+00008e50: 696e 2861 7267 7329 292e 7374 7269 7028  in(args)).strip(
+00008e60: 290a 0a20 2020 2020 2020 2069 6620 7061  )..        if pa
+00008e70: 7273 6572 5f73 7461 7465 2e63 7572 7265  rser_state.curre
+00008e80: 6e74 5f6e 6f64 653a 0a20 2020 2020 2020  nt_node:.       
+00008e90: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
+00008ea0: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
+00008eb0: 6465 7363 7269 7074 696f 6e22 5d20 3d20  description"] = 
+00008ec0: 6465 7363 7269 7074 696f 6e0a 2020 2020  description.    
+00008ed0: 2020 2020 2020 2020 6966 2070 6172 7365          if parse
+00008ee0: 725f 7374 6174 652e 6375 7272 656e 745f  r_state.current_
+00008ef0: 6e6f 6465 2e67 6574 2822 6e61 6d65 222c  node.get("name",
+00008f00: 2022 2229 203d 3d20 2264 6566 6175 6c74   "") == "default
+00008f10: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00008f20: 2020 2064 6f63 2e64 6573 6372 6970 7469     doc.descripti
+00008f30: 6f6e 203d 2064 6573 6372 6970 7469 6f6e  on = description
+00008f40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00008f50: 2020 2020 2020 2020 2020 2064 6f63 2e64             doc.d
+00008f60: 6573 6372 6970 7469 6f6e 203d 2064 6573  escription = des
+00008f70: 6372 6970 7469 6f6e 0a0a 2020 2020 6465  cription..    de
+00008f80: 6620 7371 6c28 7661 725f 6e61 6d65 3a20  f sql(var_name: 
+00008f90: 7374 722c 202a 2a6b 7761 7267 733a 2041  str, **kwargs: A
+00008fa0: 6e79 2920 2d3e 2043 616c 6c61 626c 655b  ny) -> Callable[
+00008fb0: 5b73 7472 2c20 4b77 4172 6728 416e 7929  [str, KwArg(Any)
+00008fc0: 5d2c 204e 6f6e 655d 3a0a 2020 2020 2020  ], None]:.      
+00008fd0: 2020 6465 6620 5f66 2873 716c 3a20 7374    def _f(sql: st
+00008fe0: 722c 202a 2a6b 7761 7267 733a 2041 6e79  r, **kwargs: Any
+00008ff0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00009000: 2020 2020 2020 2069 6620 6e6f 7420 7061         if not pa
+00009010: 7273 6572 5f73 7461 7465 2e63 7572 7265  rser_state.curre
+00009020: 6e74 5f6e 6f64 653a 0a20 2020 2020 2020  nt_node:.       
+00009030: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+00009040: 6172 7365 4578 6365 7074 696f 6e28 2253  arseException("S
+00009050: 514c 206d 7573 7420 6265 2063 616c 6c65  QL must be calle
+00009060: 6420 6166 7465 7220 6120 4e4f 4445 2063  d after a NODE c
+00009070: 6f6d 6d61 6e64 2229 0a20 2020 2020 2020  ommand").       
+00009080: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
+00009090: 652e 6375 7272 656e 745f 6e6f 6465 5b76  e.current_node[v
+000090a0: 6172 5f6e 616d 655d 203d 2028 0a20 2020  ar_name] = (.   
+000090b0: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+000090c0: 7477 7261 702e 6465 6465 6e74 2873 716c  twrap.dedent(sql
+000090d0: 292e 7273 7472 6970 2829 2069 6620 2225  ).rstrip() if "%
+000090e0: 2220 6e6f 7420 696e 2073 716c 2e73 7472  " not in sql.str
+000090f0: 6970 2829 5b30 5d20 656c 7365 2073 716c  ip()[0] else sql
+00009100: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+00009110: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009120: 2320 4841 434b 2074 6869 7320 6361 7374  # HACK this cast
+00009130: 2069 7320 6e65 6564 6564 2062 6563 6175   is needed becau
+00009140: 7365 204d 7970 790a 2020 2020 2020 2020  se Mypy.        
+00009150: 7265 7475 726e 2063 6173 7428 4361 6c6c  return cast(Call
+00009160: 6162 6c65 5b5b 7374 722c 204b 7741 7267  able[[str, KwArg
+00009170: 2841 6e79 295d 2c20 4e6f 6e65 5d2c 205f  (Any)], None], _
+00009180: 6629 0a0a 2020 2020 6465 6620 6173 7369  f)..    def assi
+00009190: 676e 5f6e 6f64 655f 7661 7228 763a 2073  gn_node_var(v: s
+000091a0: 7472 2920 2d3e 2043 616c 6c61 626c 655b  tr) -> Callable[
+000091b0: 5b56 6172 4172 6728 7374 7229 2c20 4b77  [VarArg(str), Kw
+000091c0: 4172 6728 416e 7929 5d2c 204e 6f6e 655d  Arg(Any)], None]
+000091d0: 3a0a 2020 2020 2020 2020 6465 6620 5f66  :.        def _f
+000091e0: 282a 6172 6773 3a20 7374 722c 202a 2a6b  (*args: str, **k
+000091f0: 7761 7267 733a 2041 6e79 2920 2d3e 204e  wargs: Any) -> N
+00009200: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00009210: 2069 6620 6e6f 7420 7061 7273 6572 5f73   if not parser_s
+00009220: 7461 7465 2e63 7572 7265 6e74 5f6e 6f64  tate.current_nod
+00009230: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00009240: 2020 2072 6169 7365 2050 6172 7365 4578     raise ParseEx
+00009250: 6365 7074 696f 6e28 2225 7320 6d75 7374  ception("%s must
+00009260: 2062 6520 6361 6c6c 6564 2061 6674 6572   be called after
+00009270: 2061 204e 4f44 4520 636f 6d6d 616e 6422   a NODE command"
+00009280: 2025 2076 290a 2020 2020 2020 2020 2020   % v).          
+00009290: 2020 7265 7475 726e 2061 7373 6967 6e5f    return assign_
+000092a0: 7661 7228 7629 282a 6172 6773 2c20 2a2a  var(v)(*args, **
+000092b0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
+000092c0: 2072 6574 7572 6e20 5f66 0a0a 2020 2020   return _f..    
+000092d0: 6465 6620 6164 645f 746f 6b65 6e28 2a61  def add_token(*a
+000092e0: 7267 733a 2073 7472 2c20 2a2a 6b77 6172  rgs: str, **kwar
+000092f0: 6773 3a20 416e 7929 202d 3e20 4e6f 6e65  gs: Any) -> None
+00009300: 3a20 2023 2074 6f6b 656e 5f6e 616d 652c  :  # token_name,
+00009310: 2070 6572 6d69 7373 696f 6e73 293a 0a20   permissions):. 
+00009320: 2020 2020 2020 2069 6620 6c65 6e28 6172         if len(ar
+00009330: 6773 2920 3c20 323a 0a20 2020 2020 2020  gs) < 2:.       
+00009340: 2020 2020 2072 6169 7365 2050 6172 7365       raise Parse
+00009350: 4578 6365 7074 696f 6e28 2754 4f4b 454e  Exception('TOKEN
+00009360: 2067 6574 7320 7477 6f20 7061 7261 6d73   gets two params
+00009370: 2c20 746f 6b65 6e20 6e61 6d65 2061 6e64  , token name and
+00009380: 2070 6572 6d69 7373 696f 6e73 2065 2e67   permissions e.g
+00009390: 2054 4f4b 454e 2022 7265 6164 2061 7069   TOKEN "read api
+000093a0: 2074 6f6b 656e 2220 5245 4144 2729 0a20   token" READ'). 
+000093b0: 2020 2020 2020 2064 6f63 2e74 6f6b 656e         doc.token
+000093c0: 732e 6170 7065 6e64 287b 2274 6f6b 656e  s.append({"token
+000093d0: 5f6e 616d 6522 3a20 5f75 6e71 756f 7465  _name": _unquote
+000093e0: 2861 7267 735b 305d 292c 2022 7065 726d  (args[0]), "perm
+000093f0: 6973 7369 6f6e 7322 3a20 6172 6773 5b31  issions": args[1
+00009400: 5d7d 290a 0a20 2020 2064 6566 2074 6573  ]})..    def tes
+00009410: 7428 2a61 7267 733a 2073 7472 2c20 2a2a  t(*args: str, **
+00009420: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
+00009430: 4e6f 6e65 3a0a 2020 2020 2020 2020 7072  None:.        pr
+00009440: 696e 7428 2274 6573 7422 2c20 6172 6773  int("test", args
+00009450: 2c20 6b77 6172 6773 290a 0a20 2020 2064  , kwargs)..    d
+00009460: 6566 2069 6e63 6c75 6465 282a 6172 6773  ef include(*args
+00009470: 3a20 7374 722c 202a 2a6b 7761 7267 733a  : str, **kwargs:
+00009480: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
+00009490: 2020 2020 2020 2066 203d 205f 756e 7175         f = _unqu
+000094a0: 6f74 6528 6172 6773 5b30 5d29 0a20 2020  ote(args[0]).   
+000094b0: 2020 2020 2066 203d 2065 7661 6c5f 7661       f = eval_va
+000094c0: 7228 6629 0a20 2020 2020 2020 2061 7474  r(f).        att
+000094d0: 7273 203d 2064 6963 7428 5f75 6e71 756f  rs = dict(_unquo
+000094e0: 7465 2878 292e 7370 6c69 7428 223d 222c  te(x).split("=",
+000094f0: 2031 2920 666f 7220 7820 696e 2061 7267   1) for x in arg
+00009500: 735b 313a 5d29 0a20 2020 2020 2020 206e  s[1:]).        n
+00009510: 6f6e 6c6f 6361 6c20 6c69 6e65 730a 2020  onlocal lines.  
+00009520: 2020 2020 2020 6c69 6e65 6e6f 203d 206b        lineno = k
+00009530: 7761 7267 735b 226c 696e 656e 6f22 5d0a  wargs["lineno"].
+00009540: 2020 2020 2020 2020 7265 706c 6163 655f          replace_
+00009550: 696e 636c 7564 6573 203d 206b 7761 7267  includes = kwarg
+00009560: 735b 2272 6570 6c61 6365 5f69 6e63 6c75  s["replace_inclu
+00009570: 6465 7322 5d0a 2020 2020 2020 2020 6e20  des"].        n 
+00009580: 3d20 6c69 6e65 6e6f 0a20 2020 2020 2020  = lineno.       
+00009590: 2061 7267 735f 7769 7468 5f61 7474 7273   args_with_attrs
+000095a0: 203d 2022 2022 2e6a 6f69 6e28 6172 6773   = " ".join(args
+000095b0: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
+000095c0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+000095d0: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+000095e0: 2020 2020 2020 2020 6e20 2b3d 2031 0a20          n += 1. 
+000095f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00009600: 6620 6c65 6e28 6c69 6e65 7329 203c 3d20  f len(lines) <= 
+00009610: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00009620: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+00009630: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00009640: 224e 4f44 4522 2069 6e20 6c69 6e65 735b  "NODE" in lines[
+00009650: 6e5d 3a0a 2020 2020 2020 2020 2020 2020  n]:.            
+00009660: 2020 2020 2020 2020 646f 632e 696e 636c          doc.incl
+00009670: 7564 6573 5b61 7267 735f 7769 7468 5f61  udes[args_with_a
+00009680: 7474 7273 5d20 3d20 6c69 6e65 735b 6e5d  ttrs] = lines[n]
+00009690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000096a0: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+000096b0: 2020 2020 2020 2069 6620 6172 6773 5f77         if args_w
+000096c0: 6974 685f 6174 7472 7320 6e6f 7420 696e  ith_attrs not in
+000096d0: 2064 6f63 2e69 6e63 6c75 6465 733a 0a20   doc.includes:. 
+000096e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000096f0: 6f63 2e69 6e63 6c75 6465 735b 6172 6773  oc.includes[args
+00009700: 5f77 6974 685f 6174 7472 735d 203d 2022  _with_attrs] = "
+00009710: 220a 2020 2020 2020 2020 6578 6365 7074  ".        except
+00009720: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00009730: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00009740: 2020 2020 2020 2320 4966 2074 6869 7320        # If this 
+00009750: 7061 7273 6520 7761 7320 7472 6967 6765  parse was trigge
+00009760: 7265 6420 6279 2066 6f72 6d61 742c 2077  red by format, w
+00009770: 6520 646f 6e27 7420 7761 6e74 2074 6f20  e don't want to 
+00009780: 7265 706c 6163 6520 7468 6520 6669 6c65  replace the file
+00009790: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000097a0: 7265 706c 6163 655f 696e 636c 7564 6573  replace_includes
+000097b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000097c0: 7475 726e 0a0a 2020 2020 2020 2020 2320  turn..        # 
+000097d0: 6265 2073 7572 6520 746f 2072 6570 6c61  be sure to repla
+000097e0: 6365 2074 6865 2069 6e63 6c75 6465 206c  ce the include l
+000097f0: 696e 650a 2020 2020 2020 2020 7020 3d20  ine.        p = 
+00009800: 5061 7468 2862 6173 6570 6174 6829 0a0a  Path(basepath)..
+00009810: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00009820: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
+00009830: 656e 2870 202f 2066 2920 6173 2066 696c  en(p / f) as fil
+00009840: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00009850: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00009860: 2020 2020 2020 2020 2020 2020 6c6c 203d              ll =
+00009870: 206c 6973 7428 5374 7269 6e67 494f 2866   list(StringIO(f
+00009880: 696c 652e 7265 6164 2829 2c20 6e65 776c  ile.read(), newl
+00009890: 696e 653d 4e6f 6e65 2929 0a20 2020 2020  ine=None)).     
+000098a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000098b0: 6f64 655f 6c69 6e65 203d 205b 6c69 6e65  ode_line = [line
+000098c0: 2066 6f72 206c 696e 6520 696e 206c 6c20   for line in ll 
+000098d0: 6966 2022 4e4f 4445 2220 696e 206c 696e  if "NODE" in lin
+000098e0: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
+000098f0: 2020 2020 2020 2069 6620 6e6f 6465 5f6c         if node_l
+00009900: 696e 6520 616e 6420 646f 632e 696e 636c  ine and doc.incl
+00009910: 7564 6573 5b61 7267 735f 7769 7468 5f61  udes[args_with_a
+00009920: 7474 7273 5d3a 0a20 2020 2020 2020 2020  ttrs]:.         
+00009930: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00009940: 6f63 2e69 6e63 6c75 6465 735b 6e6f 6465  oc.includes[node
+00009950: 5f6c 696e 655b 305d 2e73 706c 6974 2822  _line[0].split("
+00009960: 4e4f 4445 2229 5b2d 315d 2e73 706c 6974  NODE")[-1].split
+00009970: 2822 5c6e 2229 5b30 5d2e 7374 7269 7028  ("\n")[0].strip(
+00009980: 295d 203d 2022 220a 2020 2020 2020 2020  )] = "".        
+00009990: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+000099a0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+000099b0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000099c0: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+000099d0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+000099e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099f0: 6669 6c65 2e73 6565 6b28 3029 0a20 2020  file.seek(0).   
+00009a00: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+00009a10: 6573 5b6c 696e 656e 6f20 3a20 6c69 6e65  es[lineno : line
+00009a20: 6e6f 202b 2031 5d20 3d20 5b22 225d 202b  no + 1] = [""] +
+00009a30: 206c 6973 7428 0a20 2020 2020 2020 2020   list(.         
+00009a40: 2020 2020 2020 2020 2020 2053 7472 696e             Strin
+00009a50: 6749 4f28 5465 6d70 6c61 7465 2866 696c  gIO(Template(fil
+00009a60: 652e 7265 6164 2829 292e 7361 6665 5f73  e.read()).safe_s
+00009a70: 7562 7374 6974 7574 6528 6174 7472 7329  ubstitute(attrs)
+00009a80: 2c20 6e65 776c 696e 653d 4e6f 6e65 290a  , newline=None).
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009aa0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00009ab0: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
+00009ac0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00009ad0: 7261 6973 6520 496e 636c 7564 6546 696c  raise IncludeFil
+00009ae0: 654e 6f74 466f 756e 6445 7863 6570 7469  eNotFoundExcepti
+00009af0: 6f6e 2866 290a 0a20 2020 2064 6566 2076  on(f)..    def v
+00009b00: 6572 7369 6f6e 282a 6172 6773 3a20 7374  ersion(*args: st
+00009b10: 722c 202a 2a6b 7761 7267 733a 2041 6e79  r, **kwargs: Any
+00009b20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00009b30: 2020 2069 6620 6c65 6e28 6172 6773 2920     if len(args) 
+00009b40: 3c20 313a 0a20 2020 2020 2020 2020 2020  < 1:.           
+00009b50: 2072 6169 7365 2050 6172 7365 4578 6365   raise ParseExce
+00009b60: 7074 696f 6e28 2256 4552 5349 4f4e 2067  ption("VERSION g
+00009b70: 6574 7320 6f6e 6520 706f 7369 7469 7665  ets one positive
+00009b80: 2069 6e74 6567 6572 2070 6172 616d 2229   integer param")
+00009b90: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00009ba0: 2020 2020 2020 2020 2020 7665 7273 696f            versio
+00009bb0: 6e20 3d20 696e 7428 6172 6773 5b30 5d29  n = int(args[0])
+00009bc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009bd0: 7665 7273 696f 6e20 3c20 303a 0a20 2020  version < 0:.   
+00009be0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00009bf0: 7365 2056 616c 6964 6174 696f 6e45 7863  se ValidationExc
+00009c00: 6570 7469 6f6e 2822 7665 7273 696f 6e20  eption("version 
+00009c10: 6d75 7374 2062 6520 6120 706f 7369 7469  must be a positi
+00009c20: 7665 2069 6e74 6567 6572 2065 2e67 2056  ve integer e.g V
+00009c30: 4552 5349 4f4e 2032 2229 0a20 2020 2020  ERSION 2").     
+00009c40: 2020 2020 2020 2064 6f63 2e76 6572 7369         doc.versi
+00009c50: 6f6e 203d 2076 6572 7369 6f6e 0a20 2020  on = version.   
+00009c60: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+00009c70: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00009c80: 2020 2020 7261 6973 6520 5661 6c69 6461      raise Valida
+00009c90: 7469 6f6e 4578 6365 7074 696f 6e28 2276  tionException("v
+00009ca0: 6572 7369 6f6e 206d 7573 7420 6265 2061  ersion must be a
+00009cb0: 2070 6f73 6974 6976 6520 696e 7465 6765   positive intege
+00009cc0: 7220 652e 6720 5645 5253 494f 4e20 3222  r e.g VERSION 2"
+00009cd0: 290a 0a20 2020 2064 6566 2073 6861 7265  )..    def share
+00009ce0: 645f 7769 7468 282a 6172 6773 3a20 7374  d_with(*args: st
+00009cf0: 722c 202a 2a6b 7761 7267 733a 2041 6e79  r, **kwargs: Any
+00009d00: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00009d10: 2020 2066 6f72 2065 6e74 7269 6573 2069     for entries i
+00009d20: 6e20 6172 6773 3a0a 2020 2020 2020 2020  n args:.        
+00009d30: 2020 2020 2320 496e 2063 6173 6520 7468      # In case th
+00009d40: 6579 2073 7065 6369 6679 206d 756c 7469  ey specify multi
+00009d50: 706c 6520 776f 726b 7370 6163 6573 0a20  ple workspaces. 
+00009d60: 2020 2020 2020 2020 2020 2064 6f63 2e73             doc.s
+00009d70: 6861 7265 645f 7769 7468 202b 3d20 5b77  hared_with += [w
+00009d80: 6f72 6b73 7061 6365 2e73 7472 6970 2829  orkspace.strip()
+00009d90: 2066 6f72 2077 6f72 6b73 7061 6365 2069   for workspace i
+00009da0: 6e20 656e 7472 6965 732e 7370 6c69 746c  n entries.splitl
+00009db0: 696e 6573 2829 5d0a 0a20 2020 2064 6566  ines()]..    def
+00009dc0: 205f 5f69 6e69 745f 656e 6769 6e65 2876   __init_engine(v
+00009dd0: 3a20 7374 7229 3a0a 2020 2020 2020 2020  : str):.        
+00009de0: 6966 206e 6f74 2070 6172 7365 725f 7374  if not parser_st
+00009df0: 6174 652e 6375 7272 656e 745f 6e6f 6465  ate.current_node
+00009e00: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00009e10: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
+00009e20: 7b76 7d20 6d75 7374 2062 6520 6361 6c6c  {v} must be call
+00009e30: 6564 2061 6674 6572 2061 204e 4f44 4520  ed after a NODE 
+00009e40: 636f 6d6d 616e 6422 290a 2020 2020 2020  command").      
+00009e50: 2020 6966 2022 656e 6769 6e65 2220 6e6f    if "engine" no
+00009e60: 7420 696e 2070 6172 7365 725f 7374 6174  t in parser_stat
+00009e70: 652e 6375 7272 656e 745f 6e6f 6465 3a0a  e.current_node:.
+00009e80: 2020 2020 2020 2020 2020 2020 7061 7273              pars
+00009e90: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
+00009ea0: 5f6e 6f64 655b 2265 6e67 696e 6522 5d20  _node["engine"] 
+00009eb0: 3d20 7b22 7479 7065 223a 204e 6f6e 652c  = {"type": None,
+00009ec0: 2022 6172 6773 223a 205b 5d7d 0a0a 2020   "args": []}..  
+00009ed0: 2020 6465 6620 7365 745f 656e 6769 6e65    def set_engine
+00009ee0: 282a 6172 6773 3a20 7374 722c 202a 2a6b  (*args: str, **k
+00009ef0: 7761 7267 733a 2041 6e79 2920 2d3e 204e  wargs: Any) -> N
+00009f00: 6f6e 653a 0a20 2020 2020 2020 205f 5f69  one:.        __i
+00009f10: 6e69 745f 656e 6769 6e65 2822 454e 4749  nit_engine("ENGI
+00009f20: 4e45 2229 0a20 2020 2020 2020 2065 6e67  NE").        eng
+00009f30: 696e 655f 7479 7065 203d 205f 756e 7175  ine_type = _unqu
+00009f40: 6f74 6528 2822 2022 2e6a 6f69 6e28 6172  ote((" ".join(ar
+00009f50: 6773 2929 2e73 7472 6970 2829 290a 2020  gs)).strip()).  
+00009f60: 2020 2020 2020 7061 7273 6572 5f73 7461        parser_sta
+00009f70: 7465 2e63 7572 7265 6e74 5f6e 6f64 655b  te.current_node[
+00009f80: 2265 6e67 696e 6522 5d5b 2274 7970 6522  "engine"]["type"
+00009f90: 5d20 3d20 6576 616c 5f76 6172 2865 6e67  ] = eval_var(eng
+00009fa0: 696e 655f 7479 7065 2c20 736b 6970 3d73  ine_type, skip=s
+00009fb0: 6b69 705f 6576 616c 290a 0a20 2020 2064  kip_eval)..    d
+00009fc0: 6566 2061 6464 5f65 6e67 696e 655f 7661  ef add_engine_va
+00009fd0: 7228 763a 2073 7472 2920 2d3e 2043 616c  r(v: str) -> Cal
+00009fe0: 6c61 626c 655b 5b56 6172 4172 6728 7374  lable[[VarArg(st
+00009ff0: 7229 2c20 4b77 4172 6728 416e 7929 5d2c  r), KwArg(Any)],
+0000a000: 204e 6f6e 655d 3a0a 2020 2020 2020 2020   None]:.        
+0000a010: 6465 6620 5f66 282a 6172 6773 3a20 7374  def _f(*args: st
+0000a020: 722c 202a 2a6b 7761 7267 733a 2041 6e79  r, **kwargs: Any
+0000a030: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
+0000a040: 5f69 6e69 745f 656e 6769 6e65 2866 2245  _init_engine(f"E
+0000a050: 4e47 494e 455f 7b76 7d22 2e75 7070 6572  NGINE_{v}".upper
+0000a060: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+0000a070: 656e 6769 6e65 5f61 7267 203d 2065 7661  engine_arg = eva
+0000a080: 6c5f 7661 7228 5f75 6e71 756f 7465 2828  l_var(_unquote((
+0000a090: 2220 222e 6a6f 696e 2861 7267 7329 292e  " ".join(args)).
+0000a0a0: 7374 7269 7028 2929 2c20 736b 6970 3d73  strip()), skip=s
+0000a0b0: 6b69 705f 6576 616c 290a 2020 2020 2020  kip_eval).      
+0000a0c0: 2020 2020 2020 7061 7273 6572 5f73 7461        parser_sta
+0000a0d0: 7465 2e63 7572 7265 6e74 5f6e 6f64 655b  te.current_node[
+0000a0e0: 2265 6e67 696e 6522 5d5b 2261 7267 7322  "engine"]["args"
+0000a0f0: 5d2e 6170 7065 6e64 2828 762c 2065 6e67  ].append((v, eng
+0000a100: 696e 655f 6172 6729 290a 0a20 2020 2020  ine_arg))..     
+0000a110: 2020 2072 6574 7572 6e20 5f66 0a0a 2020     return _f..  
+0000a120: 2020 636d 6473 203d 207b 0a20 2020 2020    cmds = {.     
+0000a130: 2020 2022 6672 6f6d 223a 2061 7373 6967     "from": assig
+0000a140: 6e28 2266 726f 6d22 292c 0a20 2020 2020  n("from"),.     
+0000a150: 2020 2022 736f 7572 6365 223a 2073 6f75     "source": sou
+0000a160: 7263 6573 2c0a 2020 2020 2020 2020 226d  rces,.        "m
+0000a170: 6169 6e74 6169 6e65 7222 3a20 6173 7369  aintainer": assi
+0000a180: 676e 2822 6d61 696e 7461 696e 6572 2229  gn("maintainer")
+0000a190: 2c0a 2020 2020 2020 2020 2273 6368 656d  ,.        "schem
+0000a1a0: 6122 3a20 7363 6865 6d61 2c0a 2020 2020  a": schema,.    
+0000a1b0: 2020 2020 2269 6e64 6578 6573 223a 2069      "indexes": i
+0000a1c0: 6e64 6578 6573 2c0a 2020 2020 2020 2020  ndexes,.        
+0000a1d0: 2320 544f 444f 3a20 4164 6465 6420 746f  # TODO: Added to
+0000a1e0: 2062 6520 6162 6c65 2074 6f20 6d65 7267   be able to merg
+0000a1f0: 6520 4d52 2031 3133 3437 2c20 6c65 7427  e MR 11347, let'
+0000a200: 7320 7265 6d6f 7665 2069 7420 6166 7465  s remove it afte
+0000a210: 7277 6172 6473 0a20 2020 2020 2020 2022  rwards.        "
+0000a220: 696e 6469 6365 7322 3a20 696e 6465 7865  indices": indexe
+0000a230: 732c 0a20 2020 2020 2020 2022 656e 6769  s,.        "engi
+0000a240: 6e65 223a 2073 6574 5f65 6e67 696e 652c  ne": set_engine,
+0000a250: 0a20 2020 2020 2020 2022 7061 7274 6974  .        "partit
+0000a260: 696f 6e5f 6b65 7922 3a20 6173 7369 676e  ion_key": assign
+0000a270: 5f76 6172 2822 7061 7274 6974 696f 6e5f  _var("partition_
+0000a280: 6b65 7922 292c 0a20 2020 2020 2020 2022  key"),.        "
+0000a290: 736f 7274 696e 675f 6b65 7922 3a20 6173  sorting_key": as
+0000a2a0: 7369 676e 5f76 6172 2822 736f 7274 696e  sign_var("sortin
+0000a2b0: 675f 6b65 7922 292c 0a20 2020 2020 2020  g_key"),.       
+0000a2c0: 2022 7072 696d 6172 795f 6b65 7922 3a20   "primary_key": 
+0000a2d0: 6173 7369 676e 5f76 6172 2822 7072 696d  assign_var("prim
+0000a2e0: 6172 795f 6b65 7922 292c 0a20 2020 2020  ary_key"),.     
+0000a2f0: 2020 2022 7361 6d70 6c69 6e67 5f6b 6579     "sampling_key
+0000a300: 223a 2061 7373 6967 6e5f 7661 7228 2273  ": assign_var("s
+0000a310: 616d 706c 696e 675f 6b65 7922 292c 0a20  ampling_key"),. 
+0000a320: 2020 2020 2020 2022 7474 6c22 3a20 6173         "ttl": as
+0000a330: 7369 676e 5f76 6172 2822 7474 6c22 292c  sign_var("ttl"),
+0000a340: 0a20 2020 2020 2020 2022 7365 7474 696e  .        "settin
+0000a350: 6773 223a 2061 7373 6967 6e5f 7661 7228  gs": assign_var(
+0000a360: 2273 6574 7469 6e67 7322 292c 0a20 2020  "settings"),.   
+0000a370: 2020 2020 2022 6e6f 6465 223a 206e 6f64       "node": nod
+0000a380: 652c 0a20 2020 2020 2020 2022 7363 6f70  e,.        "scop
+0000a390: 6522 3a20 7363 6f70 652c 0a20 2020 2020  e": scope,.     
+0000a3a0: 2020 2022 6465 7363 7269 7074 696f 6e22     "description"
+0000a3b0: 3a20 6465 7363 7269 7074 696f 6e2c 0a20  : description,. 
+0000a3c0: 2020 2020 2020 2022 7479 7065 223a 2061         "type": a
+0000a3d0: 7373 6967 6e5f 6e6f 6465 5f76 6172 2822  ssign_node_var("
+0000a3e0: 7479 7065 2229 2c0a 2020 2020 2020 2020  type"),.        
+0000a3f0: 2264 6174 6173 6f75 7263 6522 3a20 6173  "datasource": as
+0000a400: 7369 676e 5f6e 6f64 655f 7661 7228 2264  sign_node_var("d
+0000a410: 6174 6173 6f75 7263 6522 292c 0a20 2020  atasource"),.   
+0000a420: 2020 2020 2022 7461 6773 223a 2061 7373       "tags": ass
+0000a430: 6967 6e5f 6e6f 6465 5f76 6172 2822 7461  ign_node_var("ta
+0000a440: 6773 2229 2c0a 2020 2020 2020 2020 2274  gs"),.        "t
+0000a450: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
+0000a460: 223a 2061 7373 6967 6e5f 6e6f 6465 5f76  ": assign_node_v
+0000a470: 6172 2822 7461 7267 6574 5f64 6174 6173  ar("target_datas
+0000a480: 6f75 7263 6522 292c 0a20 2020 2020 2020  ource"),.       
+0000a490: 2022 636f 7079 5f73 6368 6564 756c 6522   "copy_schedule"
+0000a4a0: 3a20 6173 7369 676e 5f6e 6f64 655f 7661  : assign_node_va
+0000a4b0: 7228 436f 7079 5061 7261 6d65 7465 7273  r(CopyParameters
+0000a4c0: 2e43 4f50 595f 5343 4845 4455 4c45 292c  .COPY_SCHEDULE),
+0000a4d0: 0a20 2020 2020 2020 2022 7265 736f 7572  .        "resour
+0000a4e0: 6365 223a 2061 7373 6967 6e5f 6e6f 6465  ce": assign_node
+0000a4f0: 5f76 6172 2822 7265 736f 7572 6365 2229  _var("resource")
+0000a500: 2c0a 2020 2020 2020 2020 2266 696c 7465  ,.        "filte
+0000a510: 7222 3a20 6173 7369 676e 5f6e 6f64 655f  r": assign_node_
+0000a520: 7661 7228 2266 696c 7465 7222 292c 0a20  var("filter"),. 
+0000a530: 2020 2020 2020 2022 746f 6b65 6e22 3a20         "token": 
+0000a540: 6164 645f 746f 6b65 6e2c 0a20 2020 2020  add_token,.     
+0000a550: 2020 2022 7465 7374 223a 2074 6573 742c     "test": test,
+0000a560: 0a20 2020 2020 2020 2022 696e 636c 7564  .        "includ
+0000a570: 6522 3a20 696e 636c 7564 652c 0a20 2020  e": include,.   
+0000a580: 2020 2020 2022 7371 6c22 3a20 7371 6c28       "sql": sql(
+0000a590: 2273 716c 2229 2c0a 2020 2020 2020 2020  "sql"),.        
+0000a5a0: 2276 6572 7369 6f6e 223a 2076 6572 7369  "version": versi
+0000a5b0: 6f6e 2c0a 2020 2020 2020 2020 226b 6166  on,.        "kaf
+0000a5c0: 6b61 5f63 6f6e 6e65 6374 696f 6e5f 6e61  ka_connection_na
+0000a5d0: 6d65 223a 2061 7373 6967 6e5f 7661 7228  me": assign_var(
+0000a5e0: 226b 6166 6b61 5f63 6f6e 6e65 6374 696f  "kafka_connectio
+0000a5f0: 6e5f 6e61 6d65 2229 2c0a 2020 2020 2020  n_name"),.      
+0000a600: 2020 226b 6166 6b61 5f74 6f70 6963 223a    "kafka_topic":
+0000a610: 2061 7373 6967 6e5f 7661 7228 226b 6166   assign_var("kaf
+0000a620: 6b61 5f74 6f70 6963 2229 2c0a 2020 2020  ka_topic"),.    
+0000a630: 2020 2020 226b 6166 6b61 5f67 726f 7570      "kafka_group
+0000a640: 5f69 6422 3a20 6173 7369 676e 5f76 6172  _id": assign_var
+0000a650: 2822 6b61 666b 615f 6772 6f75 705f 6964  ("kafka_group_id
+0000a660: 2229 2c0a 2020 2020 2020 2020 226b 6166  "),.        "kaf
+0000a670: 6b61 5f62 6f6f 7473 7472 6170 5f73 6572  ka_bootstrap_ser
+0000a680: 7665 7273 223a 2061 7373 6967 6e5f 7661  vers": assign_va
+0000a690: 7228 226b 6166 6b61 5f62 6f6f 7473 7472  r("kafka_bootstr
+0000a6a0: 6170 5f73 6572 7665 7273 2229 2c0a 2020  ap_servers"),.  
+0000a6b0: 2020 2020 2020 226b 6166 6b61 5f6b 6579        "kafka_key
+0000a6c0: 223a 2061 7373 6967 6e5f 7661 7228 226b  ": assign_var("k
+0000a6d0: 6166 6b61 5f6b 6579 2229 2c0a 2020 2020  afka_key"),.    
+0000a6e0: 2020 2020 226b 6166 6b61 5f73 6563 7265      "kafka_secre
+0000a6f0: 7422 3a20 6173 7369 676e 5f76 6172 2822  t": assign_var("
+0000a700: 6b61 666b 615f 7365 6372 6574 2229 2c0a  kafka_secret"),.
+0000a710: 2020 2020 2020 2020 226b 6166 6b61 5f73          "kafka_s
+0000a720: 6368 656d 615f 7265 6769 7374 7279 5f75  chema_registry_u
+0000a730: 726c 223a 2061 7373 6967 6e5f 7661 7228  rl": assign_var(
+0000a740: 226b 6166 6b61 5f73 6368 656d 615f 7265  "kafka_schema_re
+0000a750: 6769 7374 7279 5f75 726c 2229 2c0a 2020  gistry_url"),.  
+0000a760: 2020 2020 2020 226b 6166 6b61 5f74 6172        "kafka_tar
+0000a770: 6765 745f 7061 7274 6974 696f 6e73 223a  get_partitions":
+0000a780: 2061 7373 6967 6e5f 7661 7228 226b 6166   assign_var("kaf
+0000a790: 6b61 5f74 6172 6765 745f 7061 7274 6974  ka_target_partit
+0000a7a0: 696f 6e73 2229 2c0a 2020 2020 2020 2020  ions"),.        
+0000a7b0: 226b 6166 6b61 5f61 7574 6f5f 6f66 6673  "kafka_auto_offs
+0000a7c0: 6574 5f72 6573 6574 223a 2061 7373 6967  et_reset": assig
+0000a7d0: 6e5f 7661 7228 226b 6166 6b61 5f61 7574  n_var("kafka_aut
+0000a7e0: 6f5f 6f66 6673 6574 5f72 6573 6574 2229  o_offset_reset")
+0000a7f0: 2c0a 2020 2020 2020 2020 226b 6166 6b61  ,.        "kafka
+0000a800: 5f73 746f 7265 5f72 6177 5f76 616c 7565  _store_raw_value
+0000a810: 223a 2061 7373 6967 6e5f 7661 7228 226b  ": assign_var("k
+0000a820: 6166 6b61 5f73 746f 7265 5f72 6177 5f76  afka_store_raw_v
+0000a830: 616c 7565 2229 2c0a 2020 2020 2020 2020  alue"),.        
+0000a840: 226b 6166 6b61 5f73 746f 7265 5f68 6561  "kafka_store_hea
+0000a850: 6465 7273 223a 2061 7373 6967 6e5f 7661  ders": assign_va
+0000a860: 7228 226b 6166 6b61 5f73 746f 7265 5f68  r("kafka_store_h
+0000a870: 6561 6465 7273 2229 2c0a 2020 2020 2020  eaders"),.      
+0000a880: 2020 226b 6166 6b61 5f73 746f 7265 5f62    "kafka_store_b
+0000a890: 696e 6172 795f 6865 6164 6572 7322 3a20  inary_headers": 
+0000a8a0: 6173 7369 676e 5f76 6172 2822 6b61 666b  assign_var("kafk
+0000a8b0: 615f 7374 6f72 655f 6269 6e61 7279 5f68  a_store_binary_h
+0000a8c0: 6561 6465 7273 2229 2c0a 2020 2020 2020  eaders"),.      
+0000a8d0: 2020 226b 6166 6b61 5f6b 6579 5f61 7672    "kafka_key_avr
+0000a8e0: 6f5f 6465 7365 7269 616c 697a 6174 696f  o_deserializatio
+0000a8f0: 6e22 3a20 6173 7369 676e 5f76 6172 2822  n": assign_var("
+0000a900: 6b61 666b 615f 6b65 795f 6176 726f 5f64  kafka_key_avro_d
+0000a910: 6573 6572 6961 6c69 7a61 7469 6f6e 2229  eserialization")
+0000a920: 2c0a 2020 2020 2020 2020 2269 6d70 6f72  ,.        "impor
+0000a930: 745f 7365 7276 6963 6522 3a20 6173 7369  t_service": assi
+0000a940: 676e 5f76 6172 2822 696d 706f 7274 5f73  gn_var("import_s
+0000a950: 6572 7669 6365 2229 2c0a 2020 2020 2020  ervice"),.      
+0000a960: 2020 2269 6d70 6f72 745f 636f 6e6e 6563    "import_connec
+0000a970: 7469 6f6e 5f6e 616d 6522 3a20 6173 7369  tion_name": assi
+0000a980: 676e 5f76 6172 2822 696d 706f 7274 5f63  gn_var("import_c
+0000a990: 6f6e 6e65 6374 696f 6e5f 6e61 6d65 2229  onnection_name")
+0000a9a0: 2c0a 2020 2020 2020 2020 2269 6d70 6f72  ,.        "impor
+0000a9b0: 745f 7363 6865 6475 6c65 223a 2061 7373  t_schedule": ass
+0000a9c0: 6967 6e5f 7661 7228 2269 6d70 6f72 745f  ign_var("import_
+0000a9d0: 7363 6865 6475 6c65 2229 2c0a 2020 2020  schedule"),.    
+0000a9e0: 2020 2020 2269 6d70 6f72 745f 7374 7261      "import_stra
+0000a9f0: 7465 6779 223a 2061 7373 6967 6e5f 7661  tegy": assign_va
+0000aa00: 7228 2269 6d70 6f72 745f 7374 7261 7465  r("import_strate
+0000aa10: 6779 2229 2c0a 2020 2020 2020 2020 2269  gy"),.        "i
+0000aa20: 6d70 6f72 745f 6578 7465 726e 616c 5f64  mport_external_d
+0000aa30: 6174 6173 6f75 7263 6522 3a20 6173 7369  atasource": assi
+0000aa40: 676e 5f76 6172 2822 696d 706f 7274 5f65  gn_var("import_e
+0000aa50: 7874 6572 6e61 6c5f 6461 7461 736f 7572  xternal_datasour
+0000aa60: 6365 2229 2c0a 2020 2020 2020 2020 2269  ce"),.        "i
+0000aa70: 6d70 6f72 745f 6275 636b 6574 5f75 7269  mport_bucket_uri
+0000aa80: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
+0000aa90: 6d70 6f72 745f 6275 636b 6574 5f75 7269  mport_bucket_uri
+0000aaa0: 2229 2c0a 2020 2020 2020 2020 2269 6d70  "),.        "imp
+0000aab0: 6f72 745f 7175 6572 7922 3a20 6173 7369  ort_query": assi
+0000aac0: 676e 5f76 6172 2822 696d 706f 7274 5f71  gn_var("import_q
+0000aad0: 7565 7279 2229 2c0a 2020 2020 2020 2020  uery"),.        
+0000aae0: 2273 6861 7265 645f 7769 7468 223a 2073  "shared_with": s
+0000aaf0: 6861 7265 645f 7769 7468 2c0a 2020 2020  hared_with,.    
+0000ab00: 2020 2020 2265 7870 6f72 745f 7365 7276      "export_serv
+0000ab10: 6963 6522 3a20 6173 7369 676e 5f76 6172  ice": assign_var
+0000ab20: 2822 6578 706f 7274 5f73 6572 7669 6365  ("export_service
+0000ab30: 2229 2c0a 2020 2020 2020 2020 2265 7870  "),.        "exp
+0000ab40: 6f72 745f 636f 6e6e 6563 7469 6f6e 5f6e  ort_connection_n
+0000ab50: 616d 6522 3a20 6173 7369 676e 5f76 6172  ame": assign_var
+0000ab60: 2822 6578 706f 7274 5f63 6f6e 6e65 6374  ("export_connect
+0000ab70: 696f 6e5f 6e61 6d65 2229 2c0a 2020 2020  ion_name"),.    
+0000ab80: 2020 2020 2265 7870 6f72 745f 7363 6865      "export_sche
+0000ab90: 6475 6c65 223a 2061 7373 6967 6e5f 7661  dule": assign_va
+0000aba0: 7228 2265 7870 6f72 745f 7363 6865 6475  r("export_schedu
+0000abb0: 6c65 2229 2c0a 2020 2020 2020 2020 2265  le"),.        "e
+0000abc0: 7870 6f72 745f 6275 636b 6574 5f75 7269  xport_bucket_uri
+0000abd0: 223a 2061 7373 6967 6e5f 7661 7228 2265  ": assign_var("e
+0000abe0: 7870 6f72 745f 6275 636b 6574 5f75 7269  xport_bucket_uri
+0000abf0: 2229 2c0a 2020 2020 2020 2020 2265 7870  "),.        "exp
+0000ac00: 6f72 745f 6669 6c65 5f74 656d 706c 6174  ort_file_templat
+0000ac10: 6522 3a20 6173 7369 676e 5f76 6172 2822  e": assign_var("
+0000ac20: 6578 706f 7274 5f66 696c 655f 7465 6d70  export_file_temp
+0000ac30: 6c61 7465 2229 2c0a 2020 2020 2020 2020  late"),.        
+0000ac40: 2265 7870 6f72 745f 666f 726d 6174 223a  "export_format":
+0000ac50: 2061 7373 6967 6e5f 7661 7228 2265 7870   assign_var("exp
+0000ac60: 6f72 745f 666f 726d 6174 2229 2c0a 2020  ort_format"),.  
+0000ac70: 2020 2020 2020 2265 7870 6f72 745f 7374        "export_st
+0000ac80: 7261 7465 6779 223a 2061 7373 6967 6e5f  rategy": assign_
+0000ac90: 7661 7228 2265 7870 6f72 745f 7374 7261  var("export_stra
+0000aca0: 7465 6779 2229 2c0a 2020 2020 2020 2020  tegy"),.        
+0000acb0: 2265 7870 6f72 745f 636f 6d70 7265 7373  "export_compress
+0000acc0: 696f 6e22 3a20 6173 7369 676e 5f76 6172  ion": assign_var
+0000acd0: 2822 6578 706f 7274 5f63 6f6d 7072 6573  ("export_compres
+0000ace0: 7369 6f6e 2229 2c0a 2020 2020 7d0a 0a20  sion"),.    }.. 
+0000acf0: 2020 2065 6e67 696e 655f 7661 7273 203d     engine_vars =
+0000ad00: 2073 6574 2829 0a0a 2020 2020 666f 7220   set()..    for 
+0000ad10: 5f65 6e67 696e 652c 2028 7061 7261 6d73  _engine, (params
+0000ad20: 2c20 6f70 7469 6f6e 7329 2069 6e20 454e  , options) in EN
+0000ad30: 4142 4c45 445f 454e 4749 4e45 533a 0a20  ABLED_ENGINES:. 
+0000ad40: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
+0000ad50: 7061 7261 6d73 3a0a 2020 2020 2020 2020  params:.        
+0000ad60: 2020 2020 656e 6769 6e65 5f76 6172 732e      engine_vars.
+0000ad70: 6164 6428 702e 6e61 6d65 290a 2020 2020  add(p.name).    
+0000ad80: 2020 2020 666f 7220 6f20 696e 206f 7074      for o in opt
+0000ad90: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+0000ada0: 2020 656e 6769 6e65 5f76 6172 732e 6164    engine_vars.ad
+0000adb0: 6428 6f2e 6e61 6d65 290a 2020 2020 666f  d(o.name).    fo
+0000adc0: 7220 7620 696e 2065 6e67 696e 655f 7661  r v in engine_va
+0000add0: 7273 3a0a 2020 2020 2020 2020 636d 6473  rs:.        cmds
+0000ade0: 5b66 2265 6e67 696e 655f 7b76 7d22 5d20  [f"engine_{v}"] 
+0000adf0: 3d20 6164 645f 656e 6769 6e65 5f76 6172  = add_engine_var
+0000ae00: 2876 290a 0a20 2020 2069 6620 6465 6661  (v)..    if defa
+0000ae10: 756c 745f 6e6f 6465 3a0a 2020 2020 2020  ult_node:.      
+0000ae20: 2020 6e6f 6465 2864 6566 6175 6c74 5f6e    node(default_n
+0000ae30: 6f64 6529 0a0a 2020 2020 6c69 6e65 6e6f  ode)..    lineno
+0000ae40: 203d 2030 0a20 2020 2074 7279 3a0a 2020   = 0.    try:.  
+0000ae50: 2020 2020 2020 7768 696c 6520 6c69 6e65        while line
+0000ae60: 6e6f 203c 206c 656e 286c 696e 6573 293a  no < len(lines):
+0000ae70: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0000ae80: 6520 3d20 6c69 6e65 735b 6c69 6e65 6e6f  e = lines[lineno
+0000ae90: 5d0a 2020 2020 2020 2020 2020 2020 7472  ].            tr
+0000aea0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000aeb0: 2020 2073 6120 3d20 7368 6c65 782e 7368     sa = shlex.sh
+0000aec0: 6c65 7828 6c69 6e65 290a 2020 2020 2020  lex(line).      
+0000aed0: 2020 2020 2020 2020 2020 7361 2e77 6869            sa.whi
+0000aee0: 7465 7370 6163 655f 7370 6c69 7420 3d20  tespace_split = 
+0000aef0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0000af00: 2020 2020 206c 6578 6572 203d 206c 6973       lexer = lis
+0000af10: 7428 7361 290a 2020 2020 2020 2020 2020  t(sa).          
+0000af20: 2020 6578 6365 7074 2056 616c 7565 4572    except ValueEr
+0000af30: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000af40: 2020 2020 2073 6120 3d20 7368 6c65 782e       sa = shlex.
+0000af50: 7368 6c65 7828 7368 6c65 782e 7175 6f74  shlex(shlex.quot
+0000af60: 6528 6c69 6e65 2929 0a20 2020 2020 2020  e(line)).       
+0000af70: 2020 2020 2020 2020 2073 612e 7768 6974           sa.whit
+0000af80: 6573 7061 6365 5f73 706c 6974 203d 2054  espace_split = T
+0000af90: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000afa0: 2020 2020 6c65 7865 7220 3d20 6c69 7374      lexer = list
+0000afb0: 2873 6129 0a20 2020 2020 2020 2020 2020  (sa).           
+0000afc0: 2069 6620 6c65 7865 723a 0a20 2020 2020   if lexer:.     
+0000afd0: 2020 2020 2020 2020 2020 2063 6d64 2c20             cmd, 
+0000afe0: 6172 6773 203d 206c 6578 6572 5b30 5d2c  args = lexer[0],
+0000aff0: 206c 6578 6572 5b31 3a5d 0a20 2020 2020   lexer[1:].     
+0000b000: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b020: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
+0000b030: 2e6d 756c 7469 6c69 6e65 0a20 2020 2020  .multiline.     
+0000b040: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b050: 6e64 2063 6d64 2e6c 6f77 6572 2829 2069  nd cmd.lower() i
+0000b060: 6e20 636d 6473 0a20 2020 2020 2020 2020  n cmds.         
+0000b070: 2020 2020 2020 2020 2020 2061 6e64 206e             and n
+0000b080: 6f74 2028 6c69 6e65 2e73 7461 7274 7377  ot (line.startsw
+0000b090: 6974 6828 2220 2229 206f 7220 6c69 6e65  ith(" ") or line
+0000b0a0: 2e73 7461 7274 7377 6974 6828 225c 7422  .startswith("\t"
+0000b0b0: 2920 6f72 206c 696e 652e 6c6f 7765 7228  ) or line.lower(
+0000b0c0: 292e 7374 6172 7473 7769 7468 2822 6672  ).startswith("fr
+0000b0d0: 6f6d 2229 290a 2020 2020 2020 2020 2020  om")).          
+0000b0e0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0000b0f0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0000b100: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
+0000b110: 696e 6520 3d20 4661 6c73 650a 2020 2020  ine = False.    
+0000b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b130: 636d 6473 5b70 6172 7365 725f 7374 6174  cmds[parser_stat
+0000b140: 652e 636f 6d6d 616e 645d 280a 2020 2020  e.command](.    
+0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b160: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
+0000b170: 2e6d 756c 7469 6c69 6e65 5f73 7472 696e  .multiline_strin
+0000b180: 672c 206c 696e 656e 6f3d 6c69 6e65 6e6f  g, lineno=lineno
+0000b190: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
+0000b1a0: 6573 3d72 6570 6c61 6365 5f69 6e63 6c75  es=replace_inclu
+0000b1b0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
+0000b1c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000b1d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000b1e0: 7420 7061 7273 6572 5f73 7461 7465 2e6d  t parser_state.m
+0000b1f0: 756c 7469 6c69 6e65 3a0a 2020 2020 2020  ultiline:.      
+0000b200: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b210: 206c 656e 2861 7267 7329 203e 3d20 3120   len(args) >= 1 
+0000b220: 616e 6420 6172 6773 5b30 5d20 3d3d 2022  and args[0] == "
+0000b230: 3e22 3a0a 2020 2020 2020 2020 2020 2020  >":.            
+0000b240: 2020 2020 2020 2020 2020 2020 7061 7273              pars
+0000b250: 6572 5f73 7461 7465 2e6d 756c 7469 6c69  er_state.multili
+0000b260: 6e65 203d 2054 7275 650a 2020 2020 2020  ne = True.      
+0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b280: 2020 7061 7273 6572 5f73 7461 7465 2e63    parser_state.c
+0000b290: 6f6d 6d61 6e64 203d 2063 6d64 2e6c 6f77  ommand = cmd.low
+0000b2a0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0000b2b0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0000b2c0: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
+0000b2d0: 696e 655f 7374 7269 6e67 203d 2022 220a  ine_string = "".
+0000b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b310: 2020 6966 2063 6d64 2e6c 6f77 6572 2829    if cmd.lower()
+0000b320: 2069 6e20 636d 6473 3a0a 2020 2020 2020   in cmds:.      
+0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b340: 2020 2020 2020 636d 6473 5b63 6d64 2e6c        cmds[cmd.l
+0000b350: 6f77 6572 2829 5d28 2a61 7267 732c 206c  ower()](*args, l
+0000b360: 696e 656e 6f3d 6c69 6e65 6e6f 2c20 7265  ineno=lineno, re
+0000b370: 706c 6163 655f 696e 636c 7564 6573 3d72  place_includes=r
+0000b380: 6570 6c61 6365 5f69 6e63 6c75 6465 7329  eplace_includes)
+0000b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000b3d0: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0000b3e0: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+0000b3f0: 6e61 6765 722e 6572 726f 725f 6f70 7469  nager.error_opti
+0000b400: 6f6e 286f 7074 696f 6e3d 636d 642e 7570  on(option=cmd.up
+0000b410: 7065 7228 2929 290a 2020 2020 2020 2020  per())).        
+0000b420: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b440: 2020 7061 7273 6572 5f73 7461 7465 2e6d    parser_state.m
+0000b450: 756c 7469 6c69 6e65 5f73 7472 696e 6720  ultiline_string 
+0000b460: 2b3d 206c 696e 650a 2020 2020 2020 2020  += line.        
+0000b470: 2020 2020 6c69 6e65 6e6f 202b 3d20 310a      lineno += 1.
+0000b480: 2020 2020 2020 2020 2320 636c 6f73 6520          # close 
+0000b490: 6669 6e61 6c20 7374 6174 650a 2020 2020  final state.    
+0000b4a0: 2020 2020 6966 2070 6172 7365 725f 7374      if parser_st
+0000b4b0: 6174 652e 6d75 6c74 696c 696e 653a 0a20  ate.multiline:. 
+0000b4c0: 2020 2020 2020 2020 2020 2063 6d64 735b             cmds[
+0000b4d0: 7061 7273 6572 5f73 7461 7465 2e63 6f6d  parser_state.com
+0000b4e0: 6d61 6e64 5d28 7061 7273 6572 5f73 7461  mand](parser_sta
+0000b4f0: 7465 2e6d 756c 7469 6c69 6e65 5f73 7472  te.multiline_str
+0000b500: 696e 672c 206c 696e 656e 6f3d 6c69 6e65  ing, lineno=line
+0000b510: 6e6f 2c20 7265 706c 6163 655f 696e 636c  no, replace_incl
+0000b520: 7564 6573 3d72 6570 6c61 6365 5f69 6e63  udes=replace_inc
+0000b530: 6c75 6465 7329 0a20 2020 2065 7863 6570  ludes).    excep
+0000b540: 7420 5061 7273 6545 7863 6570 7469 6f6e  t ParseException
+0000b550: 2061 7320 653a 0a20 2020 2020 2020 2072   as e:.        r
+0000b560: 6169 7365 2050 6172 7365 4578 6365 7074  aise ParseExcept
+0000b570: 696f 6e28 7374 7228 6529 2c20 6c69 6e65  ion(str(e), line
+0000b580: 6e6f 3d6c 696e 656e 6f29 0a20 2020 2065  no=lineno).    e
+0000b590: 7863 6570 7420 5661 6c69 6461 7469 6f6e  xcept Validation
+0000b5a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0000b5b0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000b5c0: 6c69 6461 7469 6f6e 4578 6365 7074 696f  lidationExceptio
+0000b5d0: 6e28 7374 7228 6529 2c20 6c69 6e65 6e6f  n(str(e), lineno
+0000b5e0: 3d6c 696e 656e 6f29 0a20 2020 2065 7863  =lineno).    exc
+0000b5f0: 6570 7420 496e 6465 7845 7272 6f72 2061  ept IndexError a
+0000b600: 7320 653a 0a20 2020 2020 2020 2069 6620  s e:.        if 
+0000b610: 226e 6f64 6522 2069 6e20 6c69 6e65 2e6c  "node" in line.l
+0000b620: 6f77 6572 2829 3a0a 2020 2020 2020 2020  ower():.        
+0000b630: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+0000b640: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
+0000b650: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+0000b660: 7272 6f72 5f6d 6973 7369 6e67 5f6e 6f64  rror_missing_nod
+0000b670: 655f 6e61 6d65 2829 290a 2020 2020 2020  e_name()).      
+0000b680: 2020 656c 6966 2022 7371 6c22 2069 6e20    elif "sql" in 
+0000b690: 6c69 6e65 2e6c 6f77 6572 2829 3a0a 2020  line.lower():.  
+0000b6a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000b6b0: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+0000b6c0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+0000b6d0: 6167 6572 2e65 7272 6f72 5f6d 6973 7369  ager.error_missi
+0000b6e0: 6e67 5f73 716c 5f63 6f6d 6d61 6e64 2829  ng_sql_command()
+0000b6f0: 290a 2020 2020 2020 2020 656c 6966 2022  ).        elif "
+0000b700: 6461 7461 736f 7572 6365 2220 696e 206c  datasource" in l
+0000b710: 696e 652e 6c6f 7765 7228 293a 0a20 2020  ine.lower():.   
+0000b720: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+0000b730: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0000b740: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+0000b750: 6765 722e 6572 726f 725f 6d69 7373 696e  ger.error_missin
+0000b760: 675f 6461 7461 736f 7572 6365 5f6e 616d  g_datasource_nam
+0000b770: 6528 2929 0a20 2020 2020 2020 2065 6c73  e()).        els
+0000b780: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000b790: 6169 7365 2056 616c 6964 6174 696f 6e45  aise ValidationE
+0000b7a0: 7863 6570 7469 6f6e 2866 2256 616c 6964  xception(f"Valid
+0000b7b0: 6174 696f 6e20 6572 726f 722c 2066 6f75  ation error, fou
+0000b7c0: 6e64 207b 6c69 6e65 7d20 696e 206c 696e  nd {line} in lin
+0000b7d0: 6520 7b73 7472 286c 696e 656e 6f29 7d3a  e {str(lineno)}:
+0000b7e0: 207b 7374 7228 6529 7d22 2c20 6c69 6e65   {str(e)}", line
+0000b7f0: 6e6f 3d6c 696e 656e 6f29 0a20 2020 2065  no=lineno).    e
+0000b800: 7863 6570 7420 496e 636c 7564 6546 696c  xcept IncludeFil
+0000b810: 654e 6f74 466f 756e 6445 7863 6570 7469  eNotFoundExcepti
+0000b820: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0000b830: 2072 6169 7365 2065 0a20 2020 2065 7863   raise e.    exc
+0000b840: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000b850: 2065 3a0a 2020 2020 2020 2020 7472 6163   e:.        trac
+0000b860: 6562 6163 6b2e 7072 696e 745f 7462 2865  eback.print_tb(e
+0000b870: 2e5f 5f74 7261 6365 6261 636b 5f5f 290a  .__traceback__).
+0000b880: 2020 2020 2020 2020 7261 6973 6520 5061          raise Pa
+0000b890: 7273 6545 7863 6570 7469 6f6e 2866 2255  rseException(f"U
+0000b8a0: 6e65 7870 6563 7465 6420 6572 726f 723a  nexpected error:
+0000b8b0: 207b 657d 222c 206c 696e 656e 6f3d 6c69   {e}", lineno=li
+0000b8c0: 6e65 6e6f 290a 0a20 2020 2072 6574 7572  neno)..    retur
+0000b8d0: 6e20 646f 630a 0a0a 6173 796e 6320 6465  n doc...async de
+0000b8e0: 6620 7072 6f63 6573 735f 6669 6c65 280a  f process_file(.
+0000b8f0: 2020 2020 6669 6c65 6e61 6d65 3a20 7374      filename: st
+0000b900: 722c 0a20 2020 2074 625f 636c 6965 6e74  r,.    tb_client
+0000b910: 3a20 5469 6e79 422c 0a20 2020 2072 6573  : TinyB,.    res
+0000b920: 6f75 7263 655f 7665 7273 696f 6e73 3a20  ource_versions: 
+0000b930: 4f70 7469 6f6e 616c 5b44 6963 745d 203d  Optional[Dict] =
+0000b940: 204e 6f6e 652c 0a20 2020 2073 6b69 705f   None,.    skip_
+0000b950: 636f 6e6e 6563 746f 7273 3a20 626f 6f6c  connectors: bool
+0000b960: 203d 2046 616c 7365 2c0a 2020 2020 776f   = False,.    wo
+0000b970: 726b 7370 6163 655f 6d61 703a 204f 7074  rkspace_map: Opt
+0000b980: 696f 6e61 6c5b 4469 6374 5d20 3d20 4e6f  ional[Dict] = No
+0000b990: 6e65 2c0a 2020 2020 776f 726b 7370 6163  ne,.    workspac
+0000b9a0: 655f 6c69 625f 7061 7468 733a 204f 7074  e_lib_paths: Opt
+0000b9b0: 696f 6e61 6c5b 4c69 7374 5b54 7570 6c65  ional[List[Tuple
+0000b9c0: 5b73 7472 2c20 7374 725d 5d5d 203d 204e  [str, str]]] = N
+0000b9d0: 6f6e 652c 0a20 2020 2063 7572 7265 6e74  one,.    current
+0000b9e0: 5f77 733a 204f 7074 696f 6e61 6c5b 4469  _ws: Optional[Di
+0000b9f0: 6374 5b73 7472 2c20 416e 795d 5d20 3d20  ct[str, Any]] = 
+0000ba00: 4e6f 6e65 2c0a 293a 2020 2320 6e6f 7161  None,.):  # noqa
+0000ba10: 3a20 4339 3031 2042 3030 360a 2020 2020  : C901 B006.    
+0000ba20: 6966 2077 6f72 6b73 7061 6365 5f6d 6170  if workspace_map
+0000ba30: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000ba40: 2020 776f 726b 7370 6163 655f 6d61 7020    workspace_map 
+0000ba50: 3d20 7b7d 0a0a 2020 2020 6966 2072 6573  = {}..    if res
+0000ba60: 6f75 7263 655f 7665 7273 696f 6e73 2069  ource_versions i
+0000ba70: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000ba80: 7265 736f 7572 6365 5f76 6572 7369 6f6e  resource_version
+0000ba90: 7320 3d20 7b7d 0a20 2020 2072 6573 6f75  s = {}.    resou
+0000baa0: 7263 655f 7665 7273 696f 6e73 5f73 7472  rce_versions_str
+0000bab0: 696e 6720 3d20 7b6b 3a20 6622 5f5f 767b  ing = {k: f"__v{
+0000bac0: 767d 2220 666f 7220 6b2c 2076 2069 6e20  v}" for k, v in 
+0000bad0: 7265 736f 7572 6365 5f76 6572 7369 6f6e  resource_version
+0000bae0: 732e 6974 656d 7328 2920 6966 2076 203e  s.items() if v >
+0000baf0: 3d20 307d 0a0a 2020 2020 6465 6620 6765  = 0}..    def ge
+0000bb00: 745f 656e 6769 6e65 5f70 6172 616d 7328  t_engine_params(
+0000bb10: 6e6f 6465 3a20 4469 6374 5b73 7472 2c20  node: Dict[str, 
+0000bb20: 416e 795d 2920 2d3e 2044 6963 745b 7374  Any]) -> Dict[st
+0000bb30: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+0000bb40: 2070 6172 616d 7320 3d20 7b7d 0a0a 2020   params = {}..  
+0000bb50: 2020 2020 2020 6966 2022 656e 6769 6e65        if "engine
+0000bb60: 2220 696e 206e 6f64 653a 0a20 2020 2020  " in node:.     
+0000bb70: 2020 2020 2020 2065 6e67 696e 6520 3d20         engine = 
+0000bb80: 6e6f 6465 5b22 656e 6769 6e65 225d 5b22  node["engine"]["
+0000bb90: 7479 7065 225d 0a20 2020 2020 2020 2020  type"].         
+0000bba0: 2020 2070 6172 616d 735b 2265 6e67 696e     params["engin
+0000bbb0: 6522 5d20 3d20 656e 6769 6e65 0a20 2020  e"] = engine.   
+0000bbc0: 2020 2020 2020 2020 2061 7267 7320 3d20           args = 
+0000bbd0: 6e6f 6465 5b22 656e 6769 6e65 225d 5b22  node["engine"]["
+0000bbe0: 6172 6773 225d 0a20 2020 2020 2020 2020  args"].         
+0000bbf0: 2020 2066 6f72 206b 2c20 7620 696e 2061     for k, v in a
+0000bc00: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+0000bc10: 2020 2020 2070 6172 616d 735b 6622 656e       params[f"en
+0000bc20: 6769 6e65 5f7b 6b7d 225d 203d 2076 0a20  gine_{k}"] = v. 
+0000bc30: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000bc40: 7261 6d73 0a0a 2020 2020 6173 796e 6320  rams..    async 
+0000bc50: 6465 6620 6765 745f 6b61 666b 615f 7061  def get_kafka_pa
+0000bc60: 7261 6d73 286e 6f64 653a 2044 6963 745b  rams(node: Dict[
+0000bc70: 7374 722c 2041 6e79 5d29 3a0a 2020 2020  str, Any]):.    
+0000bc80: 2020 2020 7061 7261 6d73 203d 207b 6b65      params = {ke
+0000bc90: 793a 2076 616c 7565 2066 6f72 206b 6579  y: value for key
+0000bca0: 2c20 7661 6c75 6520 696e 206e 6f64 652e  , value in node.
+0000bcb0: 6974 656d 7328 2920 6966 206b 6579 2e73  items() if key.s
+0000bcc0: 7461 7274 7377 6974 6828 226b 6166 6b61  tartswith("kafka
+0000bcd0: 2229 7d0a 0a20 2020 2020 2020 2069 6620  ")}..        if 
+0000bce0: 6e6f 7420 736b 6970 5f63 6f6e 6e65 6374  not skip_connect
+0000bcf0: 6f72 733a 0a20 2020 2020 2020 2020 2020  ors:.           
+0000bd00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000bd10: 2020 2020 2020 636f 6e6e 6563 746f 725f        connector_
+0000bd20: 7061 7261 6d73 203d 207b 0a20 2020 2020  params = {.     
+0000bd30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000bd40: 6b61 666b 615f 626f 6f74 7374 7261 705f  kafka_bootstrap_
+0000bd50: 7365 7276 6572 7322 3a20 7061 7261 6d73  servers": params
+0000bd60: 2e67 6574 2822 6b61 666b 615f 626f 6f74  .get("kafka_boot
+0000bd70: 7374 7261 705f 7365 7276 6572 7322 2c20  strap_servers", 
+0000bd80: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000bd90: 2020 2020 2020 2020 2020 2022 6b61 666b             "kafk
+0000bda0: 615f 6b65 7922 3a20 7061 7261 6d73 2e67  a_key": params.g
+0000bdb0: 6574 2822 6b61 666b 615f 6b65 7922 2c20  et("kafka_key", 
+0000bdc0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000bdd0: 2020 2020 2020 2020 2020 2022 6b61 666b             "kafk
+0000bde0: 615f 7365 6372 6574 223a 2070 6172 616d  a_secret": param
+0000bdf0: 732e 6765 7428 226b 6166 6b61 5f73 6563  s.get("kafka_sec
+0000be00: 7265 7422 2c20 4e6f 6e65 292c 0a20 2020  ret", None),.   
+0000be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be20: 2022 6b61 666b 615f 636f 6e6e 6563 7469   "kafka_connecti
+0000be30: 6f6e 5f6e 616d 6522 3a20 7061 7261 6d73  on_name": params
+0000be40: 2e67 6574 2822 6b61 666b 615f 636f 6e6e  .get("kafka_conn
+0000be50: 6563 7469 6f6e 5f6e 616d 6522 2c20 4e6f  ection_name", No
+0000be60: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
+0000be70: 2020 2020 2020 2020 2022 6b61 666b 615f           "kafka_
+0000be80: 6175 746f 5f6f 6666 7365 745f 7265 7365  auto_offset_rese
+0000be90: 7422 3a20 7061 7261 6d73 2e67 6574 2822  t": params.get("
+0000bea0: 6b61 666b 615f 6175 746f 5f6f 6666 7365  kafka_auto_offse
+0000beb0: 745f 7265 7365 7422 2c20 4e6f 6e65 292c  t_reset", None),
+0000bec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bed0: 2020 2020 2022 6b61 666b 615f 7363 6865       "kafka_sche
+0000bee0: 6d61 5f72 6567 6973 7472 795f 7572 6c22  ma_registry_url"
+0000bef0: 3a20 7061 7261 6d73 2e67 6574 2822 6b61  : params.get("ka
+0000bf00: 666b 615f 7363 6865 6d61 5f72 6567 6973  fka_schema_regis
+0000bf10: 7472 795f 7572 6c22 2c20 4e6f 6e65 292c  try_url", None),
+0000bf20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bf30: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0000bf40: 2020 2020 636f 6e6e 6563 746f 7220 3d20      connector = 
+0000bf50: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
+0000bf60: 6765 745f 636f 6e6e 6563 7469 6f6e 282a  get_connection(*
+0000bf70: 2a63 6f6e 6e65 6374 6f72 5f70 6172 616d  *connector_param
+0000bf80: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000bf90: 2020 2069 6620 6e6f 7420 636f 6e6e 6563     if not connec
+0000bfa0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+0000bfb0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+0000bfc0: 6368 6f28 0a20 2020 2020 2020 2020 2020  cho(.           
+0000bfd0: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
+0000bfe0: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+0000bff0: 6f5f 6372 6561 7469 6e67 5f6b 6166 6b61  o_creating_kafka
+0000c000: 5f63 6f6e 6e65 6374 696f 6e28 636f 6e6e  _connection(conn
+0000c010: 6563 7469 6f6e 5f6e 616d 653d 7061 7261  ection_name=para
+0000c020: 6d73 5b22 6b61 666b 615f 636f 6e6e 6563  ms["kafka_connec
+0000c030: 7469 6f6e 5f6e 616d 6522 5d29 0a20 2020  tion_name"]).   
+0000c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c050: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000c060: 2020 2020 2020 2072 6571 7569 7265 645f         required_
+0000c070: 7061 7261 6d73 203d 205b 0a20 2020 2020  params = [.     
+0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c090: 2020 2063 6f6e 6e65 6374 6f72 5f70 6172     connector_par
+0000c0a0: 616d 735b 226b 6166 6b61 5f62 6f6f 7473  ams["kafka_boots
+0000c0b0: 7472 6170 5f73 6572 7665 7273 225d 2c0a  trap_servers"],.
+0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0d0: 2020 2020 2020 2020 636f 6e6e 6563 746f          connecto
+0000c0e0: 725f 7061 7261 6d73 5b22 6b61 666b 615f  r_params["kafka_
+0000c0f0: 6b65 7922 5d2c 0a20 2020 2020 2020 2020  key"],.         
+0000c100: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c110: 6f6e 6e65 6374 6f72 5f70 6172 616d 735b  onnector_params[
+0000c120: 226b 6166 6b61 5f73 6563 7265 7422 5d2c  "kafka_secret"],
+0000c130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c140: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+0000c150: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000c160: 6f74 2061 6c6c 2872 6571 7569 7265 645f  ot all(required_
+0000c170: 7061 7261 6d73 293a 0a20 2020 2020 2020  params):.       
+0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c190: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+0000c1a0: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+0000c1b0: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0000c1c0: 725f 756e 6b6e 6f77 6e5f 6b61 666b 615f  r_unknown_kafka_
+0000c1d0: 636f 6e6e 6563 7469 6f6e 2864 6174 6173  connection(datas
+0000c1e0: 6f75 7263 653d 6e61 6d65 2929 0a0a 2020  ource=name))..  
+0000c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c200: 2020 636f 6e6e 6563 746f 7220 3d20 6177    connector = aw
+0000c210: 6169 7420 7462 5f63 6c69 656e 742e 636f  ait tb_client.co
+0000c220: 6e6e 6563 7469 6f6e 5f63 7265 6174 655f  nnection_create_
+0000c230: 6b61 666b 6128 2a2a 636f 6e6e 6563 746f  kafka(**connecto
+0000c240: 725f 7061 7261 6d73 290a 2020 2020 2020  r_params).      
+0000c250: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0000c260: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0000c270: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000c280: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+0000c290: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+0000c2a0: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
+0000c2b0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0000c2c0: 6f72 5f63 6f6e 6e65 6374 696f 6e5f 6372  or_connection_cr
+0000c2d0: 6561 7465 280a 2020 2020 2020 2020 2020  eate(.          
+0000c2e0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000c2f0: 6e6e 6563 7469 6f6e 5f6e 616d 653d 7061  nnection_name=pa
+0000c300: 7261 6d73 5b22 6b61 666b 615f 636f 6e6e  rams["kafka_conn
+0000c310: 6563 7469 6f6e 5f6e 616d 6522 5d2c 2065  ection_name"], e
+0000c320: 7272 6f72 3d73 7472 2865 290a 2020 2020  rror=str(e).    
+0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c340: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c350: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000c360: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+0000c370: 6261 636b 4d61 6e61 6765 722e 7375 6363  backManager.succ
+0000c380: 6573 735f 636f 6e6e 6563 7469 6f6e 5f75  ess_connection_u
+0000c390: 7369 6e67 2863 6f6e 6e65 6374 696f 6e5f  sing(connection_
+0000c3a0: 6e61 6d65 3d63 6f6e 6e65 6374 6f72 5b22  name=connector["
+0000c3b0: 6e61 6d65 225d 2929 0a0a 2020 2020 2020  name"]))..      
+0000c3c0: 2020 2020 2020 7061 7261 6d73 2e75 7064        params.upd
+0000c3d0: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+0000c3e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0000c3f0: 2020 2020 2020 2020 2020 2022 636f 6e6e             "conn
+0000c400: 6563 746f 7222 3a20 636f 6e6e 6563 746f  ector": connecto
+0000c410: 725b 2269 6422 5d2c 0a20 2020 2020 2020  r["id"],.       
+0000c420: 2020 2020 2020 2020 2020 2020 2022 7365               "se
+0000c430: 7276 6963 6522 3a20 226b 6166 6b61 222c  rvice": "kafka",
+0000c440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c450: 207d 0a20 2020 2020 2020 2020 2020 2029   }.            )
+0000c460: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000c470: 2070 6172 616d 730a 0a20 2020 2061 7379   params..    asy
+0000c480: 6e63 2064 6566 2067 6574 5f69 6d70 6f72  nc def get_impor
+0000c490: 745f 7061 7261 6d73 2864 6174 6173 6f75  t_params(datasou
+0000c4a0: 7263 653a 2044 6963 745b 7374 722c 2041  rce: Dict[str, A
+0000c4b0: 6e79 5d2c 206e 6f64 653a 2044 6963 745b  ny], node: Dict[
+0000c4c0: 7374 722c 2041 6e79 5d29 202d 3e20 4469  str, Any]) -> Di
+0000c4d0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+0000c4e0: 2020 2020 2020 7061 7261 6d73 3a20 4469        params: Di
+0000c4f0: 6374 5b73 7472 2c20 416e 795d 203d 207b  ct[str, Any] = {
+0000c500: 6b65 793a 2076 616c 7565 2066 6f72 206b  key: value for k
+0000c510: 6579 2c20 7661 6c75 6520 696e 206e 6f64  ey, value in nod
+0000c520: 652e 6974 656d 7328 2920 6966 206b 6579  e.items() if key
+0000c530: 2e73 7461 7274 7377 6974 6828 2269 6d70  .startswith("imp
+0000c540: 6f72 745f 2229 7d0a 0a20 2020 2020 2020  ort_")}..       
+0000c550: 2069 6620 6c65 6e28 7061 7261 6d73 2920   if len(params) 
+0000c560: 3d3d 2030 206f 7220 736b 6970 5f63 6f6e  == 0 or skip_con
+0000c570: 6e65 6374 6f72 733a 0a20 2020 2020 2020  nectors:.       
+0000c580: 2020 2020 2072 6574 7572 6e20 7061 7261       return para
+0000c590: 6d73 0a0a 2020 2020 2020 2020 7365 7276  ms..        serv
+0000c5a0: 6963 653a 204f 7074 696f 6e61 6c5b 7374  ice: Optional[st
+0000c5b0: 725d 203d 206e 6f64 652e 6765 7428 2269  r] = node.get("i
+0000c5c0: 6d70 6f72 745f 7365 7276 6963 6522 2c20  mport_service", 
+0000c5d0: 4e6f 6e65 290a 0a20 2020 2020 2020 2069  None)..        i
+0000c5e0: 6620 7365 7276 6963 6520 616e 6420 7365  f service and se
+0000c5f0: 7276 6963 652e 6c6f 7765 7228 2920 3d3d  rvice.lower() ==
+0000c600: 2022 6269 6771 7565 7279 223a 0a20 2020   "bigquery":.   
+0000c610: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000c620: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
+0000c630: 6368 6563 6b5f 6763 705f 7265 6164 5f70  check_gcp_read_p
+0000c640: 6572 6d69 7373 696f 6e73 2829 3a0a 2020  ermissions():.  
+0000c650: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000c660: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0000c670: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0000c680: 6b4d 616e 6167 6572 2e65 7272 6f72 5f75  kManager.error_u
+0000c690: 6e6b 6e6f 776e 5f62 715f 636f 6e6e 6563  nknown_bq_connec
+0000c6a0: 7469 6f6e 2864 6174 6173 6f75 7263 653d  tion(datasource=
+0000c6b0: 6461 7461 736f 7572 6365 5b22 6e61 6d65  datasource["name
+0000c6c0: 225d 2929 0a0a 2020 2020 2020 2020 2020  "]))..          
+0000c6d0: 2020 2320 4269 6771 7565 7279 2064 6f65    # Bigquery doe
+0000c6e0: 736e 2774 2068 6176 6520 6120 6461 7461  sn't have a data
+0000c6f0: 6c69 6e6b 2c20 736f 2077 6520 6361 6e20  link, so we can 
+0000c700: 7374 6f70 2068 6572 650a 2020 2020 2020  stop here.      
+0000c710: 2020 2020 2020 7265 7475 726e 2070 6172        return par
+0000c720: 616d 730a 0a20 2020 2020 2020 2023 2052  ams..        # R
+0000c730: 6573 7420 6f66 2063 6f6e 6e65 6374 6f72  est of connector
+0000c740: 730a 0a20 2020 2020 2020 2063 6f6e 6e65  s..        conne
+0000c750: 6374 6f72 5f69 643a 204f 7074 696f 6e61  ctor_id: Optiona
+0000c760: 6c5b 7374 725d 203d 206e 6f64 652e 6765  l[str] = node.ge
+0000c770: 7428 2269 6d70 6f72 745f 636f 6e6e 6563  t("import_connec
+0000c780: 746f 7222 2c20 4e6f 6e65 290a 2020 2020  tor", None).    
+0000c790: 2020 2020 636f 6e6e 6563 746f 725f 6e61      connector_na
+0000c7a0: 6d65 3a20 4f70 7469 6f6e 616c 5b73 7472  me: Optional[str
+0000c7b0: 5d20 3d20 6e6f 6465 2e67 6574 2822 696d  ] = node.get("im
+0000c7c0: 706f 7274 5f63 6f6e 6e65 6374 696f 6e5f  port_connection_
+0000c7d0: 6e61 6d65 222c 204e 6f6e 6529 0a20 2020  name", None).   
+0000c7e0: 2020 2020 2069 6620 6e6f 7420 636f 6e6e       if not conn
+0000c7f0: 6563 746f 725f 6e61 6d65 2061 6e64 206e  ector_name and n
+0000c800: 6f74 2063 6f6e 6e65 6374 6f72 5f69 643a  ot connector_id:
+0000c810: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000c820: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+0000c830: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
+0000c840: 4d61 6e61 6765 722e 6572 726f 725f 6d69  Manager.error_mi
+0000c850: 7373 696e 675f 636f 6e6e 6563 7469 6f6e  ssing_connection
+0000c860: 5f6e 616d 6528 6461 7461 736f 7572 6365  _name(datasource
+0000c870: 3d64 6174 6173 6f75 7263 655b 226e 616d  =datasource["nam
+0000c880: 6522 5d29 290a 0a20 2020 2020 2020 2069  e"]))..        i
+0000c890: 6620 6e6f 7420 636f 6e6e 6563 746f 725f  f not connector_
+0000c8a0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+0000c8b0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000c8c0: 6528 636f 6e6e 6563 746f 725f 6e61 6d65  e(connector_name
+0000c8d0: 2c20 7374 7229 0a0a 2020 2020 2020 2020  , str)..        
+0000c8e0: 2020 2020 636f 6e6e 6563 746f 723a 204f      connector: O
+0000c8f0: 7074 696f 6e61 6c5b 4469 6374 5b73 7472  ptional[Dict[str
+0000c900: 2c20 416e 795d 5d20 3d20 6177 6169 7420  , Any]] = await 
+0000c910: 7462 5f63 6c69 656e 742e 6765 745f 636f  tb_client.get_co
+0000c920: 6e6e 6563 746f 7228 636f 6e6e 6563 746f  nnector(connecto
+0000c930: 725f 6e61 6d65 2c20 7365 7276 6963 6529  r_name, service)
+0000c940: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000c950: 206e 6f74 2063 6f6e 6e65 6374 6f72 3a0a   not connector:.
+0000c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c970: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0000c980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c990: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
+0000c9a0: 6167 6572 2e65 7272 6f72 5f75 6e6b 6e6f  ager.error_unkno
+0000c9b0: 776e 5f63 6f6e 6e65 6374 696f 6e28 6461  wn_connection(da
+0000c9c0: 7461 736f 7572 6365 3d64 6174 6173 6f75  tasource=datasou
+0000c9d0: 7263 655b 226e 616d 6522 5d2c 2063 6f6e  rce["name"], con
+0000c9e0: 6e65 6374 696f 6e3d 636f 6e6e 6563 746f  nection=connecto
+0000c9f0: 725f 6e61 6d65 290a 2020 2020 2020 2020  r_name).        
+0000ca00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000ca10: 2020 2020 2020 636f 6e6e 6563 746f 725f        connector_
+0000ca20: 6964 203d 2063 6f6e 6e65 6374 6f72 5b22  id = connector["
+0000ca30: 6964 225d 0a20 2020 2020 2020 2020 2020  id"].           
+0000ca40: 2073 6572 7669 6365 203d 2063 6f6e 6e65   service = conne
+0000ca50: 6374 6f72 5b22 7365 7276 6963 6522 5d0a  ctor["service"].
+0000ca60: 0a20 2020 2020 2020 2023 2054 6865 2041  .        # The A
+0000ca70: 5049 206e 6565 6473 2074 6865 2063 6f6e  PI needs the con
+0000ca80: 6e65 6374 6f72 2049 4420 746f 2063 7265  nector ID to cre
+0000ca90: 6174 6520 7468 6520 6461 7461 736f 7572  ate the datasour
+0000caa0: 6365 2e0a 2020 2020 2020 2020 7061 7261  ce..        para
+0000cab0: 6d73 5b22 696d 706f 7274 5f63 6f6e 6e65  ms["import_conne
+0000cac0: 6374 6f72 225d 203d 2063 6f6e 6e65 6374  ctor"] = connect
+0000cad0: 6f72 5f69 640a 2020 2020 2020 2020 6966  or_id.        if
+0000cae0: 2073 6572 7669 6365 3a0a 2020 2020 2020   service:.      
+0000caf0: 2020 2020 2020 7061 7261 6d73 5b22 696d        params["im
+0000cb00: 706f 7274 5f73 6572 7669 6365 225d 203d  port_service"] =
+0000cb10: 2073 6572 7669 6365 0a0a 2020 2020 2020   service..      
+0000cb20: 2020 6966 2073 6572 7669 6365 2069 6e20    if service in 
+0000cb30: 5052 4556 4945 575f 434f 4e4e 4543 544f  PREVIEW_CONNECTO
+0000cb40: 525f 5345 5256 4943 4553 3a0a 2020 2020  R_SERVICES:.    
+0000cb50: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+0000cb60: 6172 616d 732e 6765 7428 2269 6d70 6f72  arams.get("impor
+0000cb70: 745f 6275 636b 6574 5f75 7269 222c 204e  t_bucket_uri", N
+0000cb80: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
+0000cb90: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
+0000cba0: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
+0000cbb0: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+0000cbc0: 2e65 7272 6f72 5f6d 6973 7369 6e67 5f62  .error_missing_b
+0000cbd0: 7563 6b65 745f 7572 6928 6461 7461 736f  ucket_uri(dataso
+0000cbe0: 7572 6365 3d64 6174 6173 6f75 7263 655b  urce=datasource[
+0000cbf0: 226e 616d 6522 5d29 290a 2020 2020 2020  "name"])).      
+0000cc00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000cc10: 2020 2020 6966 206e 6f74 2070 6172 616d      if not param
+0000cc20: 732e 6765 7428 2269 6d70 6f72 745f 6578  s.get("import_ex
+0000cc30: 7465 726e 616c 5f64 6174 6173 6f75 7263  ternal_datasourc
+0000cc40: 6522 2c20 4e6f 6e65 293a 0a20 2020 2020  e", None):.     
+0000cc50: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000cc60: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0000cc70: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+0000cc80: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
+0000cc90: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+0000cca0: 5f6d 6973 7369 6e67 5f65 7874 6572 6e61  _missing_externa
+0000ccb0: 6c5f 6461 7461 736f 7572 6365 2864 6174  l_datasource(dat
+0000ccc0: 6173 6f75 7263 653d 6461 7461 736f 7572  asource=datasour
+0000ccd0: 6365 5b22 6e61 6d65 225d 290a 2020 2020  ce["name"]).    
+0000cce0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000ccf0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000cd00: 7261 6d73 0a0a 2020 2020 6966 2044 6174  rams..    if Dat
+0000cd10: 6146 696c 6545 7874 656e 7369 6f6e 732e  aFileExtensions.
+0000cd20: 4441 5441 534f 5552 4345 2069 6e20 6669  DATASOURCE in fi
+0000cd30: 6c65 6e61 6d65 3a0a 2020 2020 2020 2020  lename:.        
+0000cd40: 646f 6320 3d20 7061 7273 655f 6461 7461  doc = parse_data
+0000cd50: 736f 7572 6365 2866 696c 656e 616d 6529  source(filename)
+0000cd60: 0a20 2020 2020 2020 206e 6f64 6520 3d20  .        node = 
+0000cd70: 646f 632e 6e6f 6465 735b 305d 0a20 2020  doc.nodes[0].   
+0000cd80: 2020 2020 2064 6570 733a 204c 6973 745b       deps: List[
+0000cd90: 7374 725d 203d 205b 5d0a 2020 2020 2020  str] = [].      
+0000cda0: 2020 2320 7265 656d 706c 6163 6520 7461    # reemplace ta
+0000cdb0: 626c 6573 206f 6e20 6d61 7465 7269 616c  bles on material
+0000cdc0: 697a 6564 2063 6f6c 756d 6e73 0a20 2020  ized columns.   
+0000cdd0: 2020 2020 2063 6f6c 756d 6e73 203d 2070       columns = p
+0000cde0: 6172 7365 5f74 6162 6c65 5f73 7472 7563  arse_table_struc
+0000cdf0: 7475 7265 286e 6f64 655b 2273 6368 656d  ture(node["schem
+0000ce00: 6122 5d29 0a0a 2020 2020 2020 2020 5f66  a"])..        _f
+0000ce10: 6f72 6d61 7420 3d20 2263 7376 220a 2020  ormat = "csv".  
+0000ce20: 2020 2020 2020 666f 7220 7820 696e 2063        for x in c
+0000ce30: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+0000ce40: 2020 2020 6966 2078 5b22 6465 6661 756c      if x["defaul
+0000ce50: 745f 7661 6c75 6522 5d20 616e 6420 785b  t_value"] and x[
+0000ce60: 2264 6566 6175 6c74 5f76 616c 7565 225d  "default_value"]
+0000ce70: 2e6c 6f77 6572 2829 2e73 7461 7274 7377  .lower().startsw
+0000ce80: 6974 6828 226d 6174 6572 6961 6c69 7a65  ith("materialize
+0000ce90: 6422 293a 0a20 2020 2020 2020 2020 2020  d"):.           
+0000cea0: 2020 2020 2023 2074 7572 6e20 6578 7072       # turn expr
+0000ceb0: 6573 7369 6f6e 2074 6f20 6120 7365 6c65  ession to a sele
+0000cec0: 6374 2071 7565 7279 2074 6f20 7371 6c5f  ct query to sql_
+0000ced0: 6765 745f 7573 6564 5f74 6162 6c65 7320  get_used_tables 
+0000cee0: 6361 6e20 6765 7420 7468 6520 7573 6564  can get the used
+0000cef0: 2074 6162 6c65 730a 2020 2020 2020 2020   tables.        
+0000cf00: 2020 2020 2020 2020 7120 3d20 2273 656c          q = "sel
+0000cf10: 6563 7420 2220 2b20 785b 2264 6566 6175  ect " + x["defau
+0000cf20: 6c74 5f76 616c 7565 225d 5b6c 656e 2822  lt_value"][len("
+0000cf30: 6d61 7465 7269 616c 697a 6564 2229 203a  materialized") :
+0000cf40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000cf50: 2020 7461 626c 6573 203d 2061 7761 6974    tables = await
+0000cf60: 2074 625f 636c 6965 6e74 2e73 716c 5f67   tb_client.sql_g
+0000cf70: 6574 5f75 7365 645f 7461 626c 6573 2871  et_used_tables(q
+0000cf80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000cf90: 2020 2320 6d61 7465 7269 616c 697a 6564    # materialized
+0000cfa0: 2063 6f6c 756d 6e73 2065 7870 7265 7373   columns express
+0000cfb0: 696f 6e73 2063 6f75 6c64 2068 6176 6520  ions could have 
+0000cfc0: 6a6f 696e 7320 736f 2077 6520 6e65 6564  joins so we need
+0000cfd0: 2074 6f20 6164 6420 7468 656d 2061 7320   to add them as 
+0000cfe0: 6120 6465 700a 2020 2020 2020 2020 2020  a dep.          
+0000cff0: 2020 2020 2020 6465 7073 202b 3d20 7461        deps += ta
+0000d000: 626c 6573 0a20 2020 2020 2020 2020 2020  bles.           
+0000d010: 2020 2020 2023 2067 656e 6572 6174 6520       # generate 
+0000d020: 7265 706c 6163 656d 656e 7473 2061 6e64  replacements and
+0000d030: 2072 6570 6c61 6365 2074 6865 2071 7565   replace the que
+0000d040: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
+0000d050: 2020 2072 6570 6c61 6365 6d65 6e74 7320     replacements 
+0000d060: 3d20 7b74 3a20 7420 2b20 7265 736f 7572  = {t: t + resour
+0000d070: 6365 5f76 6572 7369 6f6e 735f 7374 7269  ce_versions_stri
+0000d080: 6e67 2e67 6574 2874 2c20 2222 2920 666f  ng.get(t, "") fo
+0000d090: 7220 7420 696e 2074 6162 6c65 737d 0a0a  r t in tables}..
+0000d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0b0: 7265 706c 6163 6564 5f72 6573 756c 7473  replaced_results
+0000d0c0: 203d 2061 7761 6974 2074 625f 636c 6965   = await tb_clie
+0000d0d0: 6e74 2e72 6570 6c61 6365 5f74 6162 6c65  nt.replace_table
+0000d0e0: 7328 712c 2072 6570 6c61 6365 6d65 6e74  s(q, replacement
+0000d0f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000d100: 2020 2078 5b22 6465 6661 756c 745f 7661     x["default_va
+0000d110: 6c75 6522 5d20 3d20 7265 706c 6163 6564  lue"] = replaced
+0000d120: 5f72 6573 756c 7473 2e72 6570 6c61 6365  _results.replace
+0000d130: 2822 5345 4c45 4354 222c 2022 6d61 7465  ("SELECT", "mate
+0000d140: 7269 616c 697a 6564 222c 2031 290a 2020  rialized", 1).  
+0000d150: 2020 2020 2020 2020 2020 6966 2078 2e67            if x.g
+0000d160: 6574 2822 6a73 6f6e 7061 7468 222c 204e  et("jsonpath", N
+0000d170: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
+0000d180: 2020 2020 2020 5f66 6f72 6d61 7420 3d20        _format = 
+0000d190: 226e 646a 736f 6e22 0a0a 2020 2020 2020  "ndjson"..      
+0000d1a0: 2020 7363 6865 6d61 203d 2022 2c22 2e6a    schema = ",".j
+0000d1b0: 6f69 6e28 7363 6865 6d61 5f74 6f5f 7371  oin(schema_to_sq
+0000d1c0: 6c5f 636f 6c75 6d6e 7328 636f 6c75 6d6e  l_columns(column
+0000d1d0: 7329 290a 0a20 2020 2020 2020 206e 616d  s))..        nam
+0000d1e0: 6520 3d20 6f73 2e70 6174 682e 6261 7365  e = os.path.base
+0000d1f0: 6e61 6d65 2866 696c 656e 616d 6529 2e72  name(filename).r
+0000d200: 7370 6c69 7428 222e 222c 2031 295b 305d  split(".", 1)[0]
+0000d210: 0a0a 2020 2020 2020 2020 6966 2077 6f72  ..        if wor
+0000d220: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
+0000d230: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0000d240: 7220 776b 5f6e 616d 652c 2077 6b5f 7061  r wk_name, wk_pa
+0000d250: 7468 2069 6e20 776f 726b 7370 6163 655f  th in workspace_
+0000d260: 6c69 625f 7061 7468 733a 0a20 2020 2020  lib_paths:.     
+0000d270: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d290: 2020 2020 5061 7468 2866 696c 656e 616d      Path(filenam
+0000d2a0: 6529 2e72 656c 6174 6976 655f 746f 2877  e).relative_to(w
+0000d2b0: 6b5f 7061 7468 290a 2020 2020 2020 2020  k_path).        
+0000d2c0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000d2d0: 203d 2066 227b 776f 726b 7370 6163 655f   = f"{workspace_
+0000d2e0: 6d61 702e 6765 7428 776b 5f6e 616d 652c  map.get(wk_name,
+0000d2f0: 2077 6b5f 6e61 6d65 297d 2e7b 6e61 6d65   wk_name)}.{name
+0000d300: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0000d310: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
+0000d320: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0000d330: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
+0000d340: 7061 7468 2077 6173 206e 6f74 2072 656c  path was not rel
+0000d350: 6174 6976 652c 206e 6f74 2069 6e73 6964  ative, not insid
+0000d360: 6520 776f 726b 7370 6163 650a 2020 2020  e workspace.    
+0000d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d380: 7061 7373 0a0a 2020 2020 2020 2020 7665  pass..        ve
+0000d390: 7273 696f 6e20 3d20 6622 5f5f 767b 646f  rsion = f"__v{do
+0000d3a0: 632e 7665 7273 696f 6e7d 2220 6966 2064  c.version}" if d
+0000d3b0: 6f63 2e76 6572 7369 6f6e 2069 7320 6e6f  oc.version is no
+0000d3c0: 7420 4e6f 6e65 2065 6c73 6520 2222 0a0a  t None else ""..
+0000d3d0: 2020 2020 2020 2020 6465 6620 6170 7065          def appe
+0000d3e0: 6e64 5f76 6572 7369 6f6e 5f74 6f5f 6e61  nd_version_to_na
+0000d3f0: 6d65 286e 616d 653a 2073 7472 2c20 7665  me(name: str, ve
+0000d400: 7273 696f 6e3a 2073 7472 2920 2d3e 2073  rsion: str) -> s
+0000d410: 7472 3a0a 2020 2020 2020 2020 2020 2020  tr:.            
+0000d420: 6966 2076 6572 7369 6f6e 2021 3d20 2222  if version != ""
+0000d430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d440: 2020 6e61 6d65 203d 206e 616d 652e 7265    name = name.re
+0000d450: 706c 6163 6528 222e 222c 2022 5f22 290a  place(".", "_").
+0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d470: 7265 7475 726e 206e 616d 6520 2b20 7665  return name + ve
+0000d480: 7273 696f 6e0a 2020 2020 2020 2020 2020  rsion.          
+0000d490: 2020 7265 7475 726e 206e 616d 650a 0a20    return name.. 
+0000d4a0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
+0000d4b0: 6f6e 203d 206e 6f64 652e 6765 7428 2264  on = node.get("d
+0000d4c0: 6573 6372 6970 7469 6f6e 222c 2022 2229  escription", "")
+0000d4d0: 0a20 2020 2020 2020 2069 6e64 6578 6573  .        indexes
+0000d4e0: 5f6c 6973 7420 3d20 6e6f 6465 2e67 6574  _list = node.get
+0000d4f0: 2822 696e 6465 7865 7322 2c20 5b5d 290a  ("indexes", []).
+0000d500: 2020 2020 2020 2020 696e 6465 7865 7320          indexes 
+0000d510: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
+0000d520: 6620 696e 6465 7865 735f 6c69 7374 3a0a  f indexes_list:.
+0000d530: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+0000d540: 7865 7320 3d20 225c 6e22 2e6a 6f69 6e28  xes = "\n".join(
+0000d550: 5b69 6e64 6578 2e74 6f5f 7371 6c28 2920  [index.to_sql() 
+0000d560: 666f 7220 696e 6465 7820 696e 2069 6e64  for index in ind
+0000d570: 6578 6573 5f6c 6973 745d 290a 2020 2020  exes_list]).    
+0000d580: 2020 2020 7061 7261 6d73 203d 207b 0a20      params = {. 
+0000d590: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+0000d5a0: 223a 2061 7070 656e 645f 7665 7273 696f  ": append_versio
+0000d5b0: 6e5f 746f 5f6e 616d 6528 6e61 6d65 2c20  n_to_name(name, 
+0000d5c0: 7665 7273 696f 6e29 2c0a 2020 2020 2020  version),.      
+0000d5d0: 2020 2020 2020 2264 6573 6372 6970 7469        "descripti
+0000d5e0: 6f6e 223a 2064 6573 6372 6970 7469 6f6e  on": description
+0000d5f0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000d600: 6368 656d 6122 3a20 7363 6865 6d61 2c0a  chema": schema,.
+0000d610: 2020 2020 2020 2020 2020 2020 2269 6e64              "ind
+0000d620: 6578 6573 223a 2069 6e64 6578 6573 2c0a  exes": indexes,.
+0000d630: 2020 2020 2020 2020 2020 2020 2269 6e64              "ind
+0000d640: 6578 6573 5f6c 6973 7422 3a20 696e 6465  exes_list": inde
+0000d650: 7865 735f 6c69 7374 2c0a 2020 2020 2020  xes_list,.      
+0000d660: 2020 2020 2020 2266 6f72 6d61 7422 3a20        "format": 
+0000d670: 5f66 6f72 6d61 742c 0a20 2020 2020 2020  _format,.       
+0000d680: 207d 0a0a 2020 2020 2020 2020 7061 7261   }..        para
+0000d690: 6d73 2e75 7064 6174 6528 6765 745f 656e  ms.update(get_en
+0000d6a0: 6769 6e65 5f70 6172 616d 7328 6e6f 6465  gine_params(node
+0000d6b0: 2929 0a0a 2020 2020 2020 2020 6966 2022  ))..        if "
+0000d6c0: 696d 706f 7274 5f73 6572 7669 6365 2220  import_service" 
+0000d6d0: 696e 206e 6f64 6520 6f72 2022 696d 706f  in node or "impo
+0000d6e0: 7274 5f63 6f6e 6e65 6374 696f 6e5f 6e61  rt_connection_na
+0000d6f0: 6d65 2220 696e 206e 6f64 653a 0a20 2020  me" in node:.   
+0000d700: 2020 2020 2020 2020 2056 414c 4944 5f53           VALID_S
+0000d710: 4552 5649 4345 533a 2054 7570 6c65 5b73  ERVICES: Tuple[s
+0000d720: 7472 2c20 2e2e 2e5d 203d 2028 2262 6967  tr, ...] = ("big
+0000d730: 7175 6572 7922 2c20 2273 6e6f 7766 6c61  query", "snowfla
+0000d740: 6b65 222c 2022 7333 222c 2022 7333 5f69  ke", "s3", "s3_i
+0000d750: 616d 726f 6c65 222c 2022 6763 7322 290a  amrole", "gcs").
+0000d760: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
+0000d770: 6f72 745f 7061 7261 6d73 203d 2061 7761  ort_params = awa
+0000d780: 6974 2067 6574 5f69 6d70 6f72 745f 7061  it get_import_pa
+0000d790: 7261 6d73 2870 6172 616d 732c 206e 6f64  rams(params, nod
+0000d7a0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0000d7b0: 7365 7276 6963 6520 3d20 696d 706f 7274  service = import
+0000d7c0: 5f70 6172 616d 732e 6765 7428 2269 6d70  _params.get("imp
+0000d7d0: 6f72 745f 7365 7276 6963 6522 2c20 4e6f  ort_service", No
+0000d7e0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+0000d7f0: 6966 2073 6572 7669 6365 2061 6e64 2073  if service and s
+0000d800: 6572 7669 6365 206e 6f74 2069 6e20 5641  ervice not in VA
+0000d810: 4c49 445f 5345 5256 4943 4553 3a0a 2020  LID_SERVICES:.  
+0000d820: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000d830: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
+0000d840: 556e 6b6e 6f77 6e20 696d 706f 7274 2073  Unknown import s
+0000d850: 6572 7669 6365 3a20 7b73 6572 7669 6365  ervice: {service
+0000d860: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
+0000d870: 2069 6620 7365 7276 6963 6520 696e 2050   if service in P
+0000d880: 5245 5649 4557 5f43 4f4e 4e45 4354 4f52  REVIEW_CONNECTOR
+0000d890: 5f53 4552 5649 4345 533a 0a20 2020 2020  _SERVICES:.     
+0000d8a0: 2020 2020 2020 2020 2020 204f 4e5f 4445             ON_DE
+0000d8b0: 4d41 4e44 5f43 524f 4e20 3d20 4f4e 5f44  MAND_CRON = ON_D
+0000d8c0: 454d 414e 440a 2020 2020 2020 2020 2020  EMAND.          
+0000d8d0: 2020 2020 2020 4155 544f 5f43 524f 4e20        AUTO_CRON 
+0000d8e0: 3d20 2240 6175 746f 220a 2020 2020 2020  = "@auto".      
+0000d8f0: 2020 2020 2020 2020 2020 4f4e 5f44 454d            ON_DEM
+0000d900: 414e 445f 4352 4f4e 5f45 5850 4543 5445  AND_CRON_EXPECTE
+0000d910: 445f 4259 5f54 4845 5f41 5049 203d 2022  D_BY_THE_API = "
+0000d920: 406f 6e63 6522 0a20 2020 2020 2020 2020  @once".         
+0000d930: 2020 2020 2020 2056 414c 4944 5f43 524f         VALID_CRO
+0000d940: 4e53 3a20 5475 706c 655b 7374 722c 202e  NS: Tuple[str, .
+0000d950: 2e2e 5d20 3d20 284f 4e5f 4445 4d41 4e44  ..] = (ON_DEMAND
+0000d960: 5f43 524f 4e2c 2041 5554 4f5f 4352 4f4e  _CRON, AUTO_CRON
+0000d970: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d980: 2020 6372 6f6e 203d 206e 6f64 652e 6765    cron = node.ge
+0000d990: 7428 2269 6d70 6f72 745f 7363 6865 6475  t("import_schedu
+0000d9a0: 6c65 222c 204f 4e5f 4445 4d41 4e44 5f43  le", ON_DEMAND_C
+0000d9b0: 524f 4e29 0a0a 2020 2020 2020 2020 2020  RON)..          
+0000d9c0: 2020 2020 2020 6966 2063 726f 6e20 6e6f        if cron no
+0000d9d0: 7420 696e 2056 414c 4944 5f43 524f 4e53  t in VALID_CRONS
+0000d9e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d9f0: 2020 2020 2020 7661 6c69 645f 7661 6c75        valid_valu
+0000da00: 6573 203d 2022 2c20 222e 6a6f 696e 2856  es = ", ".join(V
+0000da10: 414c 4944 5f43 524f 4e53 290a 2020 2020  ALID_CRONS).    
+0000da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da30: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0000da40: 6622 496e 7661 6c69 6420 696d 706f 7274  f"Invalid import
+0000da50: 2073 6368 6564 756c 653a 2027 7b63 726f   schedule: '{cro
+0000da60: 6e7d 272e 2056 616c 6964 2076 616c 7565  n}'. Valid value
+0000da70: 7320 6172 653a 207b 7661 6c69 645f 7661  s are: {valid_va
+0000da80: 6c75 6573 7d22 290a 0a20 2020 2020 2020  lues}")..       
+0000da90: 2020 2020 2020 2020 2069 6620 6372 6f6e           if cron
+0000daa0: 203d 3d20 4f4e 5f44 454d 414e 445f 4352   == ON_DEMAND_CR
+0000dab0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+0000dac0: 2020 2020 2020 2020 696d 706f 7274 5f70          import_p
+0000dad0: 6172 616d 735b 2269 6d70 6f72 745f 7363  arams["import_sc
+0000dae0: 6865 6475 6c65 225d 203d 204f 4e5f 4445  hedule"] = ON_DE
+0000daf0: 4d41 4e44 5f43 524f 4e5f 4558 5045 4354  MAND_CRON_EXPECT
+0000db00: 4544 5f42 595f 5448 455f 4150 490a 2020  ED_BY_THE_API.  
+0000db10: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000db20: 2063 726f 6e20 3d3d 2041 5554 4f5f 4352   cron == AUTO_CR
+0000db30: 4f4e 2061 6e64 2063 7572 7265 6e74 5f77  ON and current_w
+0000db40: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000db50: 2020 2020 2020 2077 6f72 6b73 7061 6365         workspace
+0000db60: 7320 3d20 2861 7761 6974 2074 625f 636c  s = (await tb_cl
+0000db70: 6965 6e74 2e75 7365 725f 776f 726b 7370  ient.user_worksp
+0000db80: 6163 6573 2829 292e 6765 7428 2277 6f72  aces()).get("wor
+0000db90: 6b73 7061 6365 7322 2c20 5b5d 290a 2020  kspaces", []).  
+0000dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbb0: 2020 7261 7465 5f6c 696d 6974 733a 2044    rate_limits: D
+0000dbc0: 6963 745b 7374 722c 2044 6963 745b 7374  ict[str, Dict[st
+0000dbd0: 722c 2069 6e74 5d5d 203d 206e 6578 7428  r, int]] = next(
+0000dbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dbf0: 2020 2020 2020 2020 2028 772e 6765 7428           (w.get(
+0000dc00: 2272 6174 655f 6c69 6d69 7473 222c 207b  "rate_limits", {
+0000dc10: 7d29 2066 6f72 2077 2069 6e20 776f 726b  }) for w in work
+0000dc20: 7370 6163 6573 2069 6620 775b 2269 6422  spaces if w["id"
+0000dc30: 5d20 3d3d 2063 7572 7265 6e74 5f77 735b  ] == current_ws[
+0000dc40: 2269 6422 5d29 2c20 7b7d 0a20 2020 2020  "id"]), {}.     
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000dc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc70: 2020 2020 2070 6572 696f 643a 2069 6e74       period: int
+0000dc80: 203d 2072 6174 655f 6c69 6d69 7473 2e67   = rate_limits.g
+0000dc90: 6574 2822 6170 695f 6461 7461 736f 7572  et("api_datasour
+0000dca0: 6365 735f 6372 6561 7465 5f61 7070 656e  ces_create_appen
+0000dcb0: 645f 7265 706c 6163 6522 2c20 7b7d 292e  d_replace", {}).
+0000dcc0: 6765 7428 2270 6572 696f 6422 2c20 3630  get("period", 60
+0000dcd0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000dce0: 2020 2020 2020 2064 6566 2073 6563 6f6e         def secon
+0000dcf0: 6473 5f74 6f5f 6372 6f6e 5f65 7870 7265  ds_to_cron_expre
+0000dd00: 7373 696f 6e28 7365 636f 6e64 733a 2069  ssion(seconds: i
+0000dd10: 6e74 2920 2d3e 2073 7472 3a0a 2020 2020  nt) -> str:.    
+0000dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd30: 2020 2020 6d69 6e75 7465 7320 3d20 7365      minutes = se
+0000dd40: 636f 6e64 7320 2f2f 2036 300a 2020 2020  conds // 60.    
+0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd60: 2020 2020 686f 7572 7320 3d20 6d69 6e75      hours = minu
+0000dd70: 7465 7320 2f2f 2036 300a 2020 2020 2020  tes // 60.      
+0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd90: 2020 6461 7973 203d 2068 6f75 7273 202f    days = hours /
+0000dda0: 2f20 3234 0a20 2020 2020 2020 2020 2020  / 24.           
+0000ddb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000ddc0: 6461 7973 203e 2030 3a0a 2020 2020 2020  days > 0:.      
+0000ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dde0: 2020 2020 2020 7265 7475 726e 2066 2230        return f"0
+0000ddf0: 2030 202a 2f7b 6461 7973 7d20 2a20 2a22   0 */{days} * *"
+0000de00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000de10: 2020 2020 2020 2020 2069 6620 686f 7572           if hour
+0000de20: 7320 3e20 303a 0a20 2020 2020 2020 2020  s > 0:.         
+0000de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de40: 2020 2072 6574 7572 6e20 6622 3020 2a2f     return f"0 */
+0000de50: 7b68 6f75 7273 7d20 2a20 2a20 2a22 0a20  {hours} * * *". 
+0000de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de70: 2020 2020 2020 2069 6620 6d69 6e75 7465         if minute
+0000de80: 7320 3e20 303a 0a20 2020 2020 2020 2020  s > 0:.         
+0000de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dea0: 2020 2072 6574 7572 6e20 6622 2a2f 7b6d     return f"*/{m
+0000deb0: 696e 7574 6573 7d20 2a20 2a20 2a20 2a22  inutes} * * * *"
+0000dec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ded0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000dee0: 6622 2a2f 7b73 6563 6f6e 6473 7d20 2a20  f"*/{seconds} * 
+0000def0: 2a20 2a20 2a22 0a0a 2020 2020 2020 2020  * * *"..        
+0000df00: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+0000df10: 7274 5f70 6172 616d 735b 2269 6d70 6f72  rt_params["impor
+0000df20: 745f 7363 6865 6475 6c65 225d 203d 2073  t_schedule"] = s
+0000df30: 6563 6f6e 6473 5f74 6f5f 6372 6f6e 5f65  econds_to_cron_e
+0000df40: 7870 7265 7373 696f 6e28 7065 7269 6f64  xpression(period
+0000df50: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000df60: 2049 6e63 6c75 6465 2061 6c6c 2069 6d70   Include all imp
+0000df70: 6f72 745f 2070 6172 616d 6574 6572 7320  ort_ parameters 
+0000df80: 696e 2074 6865 2064 6174 6173 6f75 7263  in the datasourc
+0000df90: 6520 7061 7261 6d73 0a20 2020 2020 2020  e params.       
+0000dfa0: 2020 2020 2070 6172 616d 732e 7570 6461       params.upda
+0000dfb0: 7465 2869 6d70 6f72 745f 7061 7261 6d73  te(import_params
+0000dfc0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000dfd0: 2053 7562 7374 6974 7574 6520 7468 6520   Substitute the 
+0000dfe0: 696d 706f 7274 2070 6172 616d 6574 6572  import parameter
+0000dff0: 7320 7769 7468 2074 6865 206f 6e65 7320  s with the ones 
+0000e000: 7573 6564 2062 7920 7468 650a 2020 2020  used by the.    
+0000e010: 2020 2020 2020 2020 2320 696d 706f 7274          # import
+0000e020: 2041 5049 3a0a 2020 2020 2020 2020 2020   API:.          
+0000e030: 2020 2320 2d20 4966 2061 6e20 696d 706f    # - If an impo
+0000e040: 7274 2070 6172 616d 6574 6572 2069 7320  rt parameter is 
+0000e050: 6e6f 7420 7072 6573 656e 7420 616e 6420  not present and 
+0000e060: 7468 6572 6527 7320 6120 6465 6661 756c  there's a defaul
+0000e070: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0000e080: 2020 7661 6c75 652c 2075 7365 2074 6865    value, use the
+0000e090: 2064 6566 6175 6c74 2076 616c 7565 2e0a   default value..
+0000e0a0: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
+0000e0b0: 4966 2074 6865 2072 6573 756c 7469 6e67  If the resulting
+0000e0c0: 2076 616c 7565 2069 7320 4e6f 6e65 2c20   value is None, 
+0000e0d0: 646f 206e 6f74 2061 6464 2074 6865 2070  do not add the p
+0000e0e0: 6172 616d 6574 6572 2e0a 2020 2020 2020  arameter..      
+0000e0f0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+0000e100: 2020 2020 2320 4e6f 7465 3a20 616e 7920      # Note: any 
+0000e110: 756e 6b6e 6f77 6e20 696d 706f 7274 5f20  unknown import_ 
+0000e120: 7061 7261 6d65 7465 7220 6973 206c 6561  parameter is lea
+0000e130: 7665 6420 6173 2069 732e 0a20 2020 2020  ved as is..     
+0000e140: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0000e150: 6e20 496d 706f 7274 5265 706c 6163 656d  n ImportReplacem
+0000e160: 656e 7473 2e67 6574 5f64 6174 6166 696c  ents.get_datafil
+0000e170: 655f 7061 7261 6d65 7465 725f 6b65 7973  e_parameter_keys
+0000e180: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000e190: 2020 2020 7265 706c 6163 656d 656e 742c      replacement,
+0000e1a0: 2064 6566 6175 6c74 5f76 616c 7565 203d   default_value =
+0000e1b0: 2049 6d70 6f72 7452 6570 6c61 6365 6d65   ImportReplaceme
+0000e1c0: 6e74 732e 6765 745f 6170 695f 7061 7261  nts.get_api_para
+0000e1d0: 6d5f 666f 725f 6461 7461 6669 6c65 5f70  m_for_datafile_p
+0000e1e0: 6172 616d 2873 6572 7669 6365 2c20 6b65  aram(service, ke
+0000e1f0: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
+0000e200: 2020 2069 6620 6e6f 7420 7265 706c 6163     if not replac
+0000e210: 656d 656e 743a 0a20 2020 2020 2020 2020  ement:.         
+0000e220: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0000e230: 6e75 6520 2023 2057 6520 7368 6f75 6c64  nue  # We should
+0000e240: 206e 6f74 2072 6561 6368 2074 6869 7320   not reach this 
+0000e250: 6e65 7665 722c 2062 7574 206a 7573 7420  never, but just 
+0000e260: 696e 2063 6173 652e 2e2e 0a0a 2020 2020  in case.....    
+0000e270: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0000e280: 653a 2041 6e79 0a20 2020 2020 2020 2020  e: Any.         
+0000e290: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2b0: 7661 6c75 6520 3d20 7061 7261 6d73 5b6b  value = params[k
+0000e2c0: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
+0000e2d0: 2020 2020 2020 2020 6465 6c20 7061 7261          del para
+0000e2e0: 6d73 5b6b 6579 5d0a 2020 2020 2020 2020  ms[key].        
+0000e2f0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+0000e300: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+0000e310: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0000e320: 7565 203d 2064 6566 6175 6c74 5f76 616c  ue = default_val
+0000e330: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+0000e340: 2020 2020 6966 2076 616c 7565 3a0a 2020      if value:.  
+0000e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e360: 2020 7061 7261 6d73 5b72 6570 6c61 6365    params[replace
+0000e370: 6d65 6e74 5d20 3d20 7661 6c75 650a 0a20  ment] = value.. 
+0000e380: 2020 2020 2020 2069 6620 226b 6166 6b61         if "kafka
+0000e390: 5f63 6f6e 6e65 6374 696f 6e5f 6e61 6d65  _connection_name
+0000e3a0: 2220 696e 206e 6f64 653a 0a20 2020 2020  " in node:.     
+0000e3b0: 2020 2020 2020 206b 6166 6b61 5f70 6172         kafka_par
+0000e3c0: 616d 7320 3d20 6177 6169 7420 6765 745f  ams = await get_
+0000e3d0: 6b61 666b 615f 7061 7261 6d73 286e 6f64  kafka_params(nod
+0000e3e0: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
+0000e3f0: 6172 616d 732e 7570 6461 7465 286b 6166  arams.update(kaf
+0000e400: 6b61 5f70 6172 616d 7329 0a20 2020 2020  ka_params).     
+0000e410: 2020 2020 2020 2064 656c 2070 6172 616d         del param
+0000e420: 735b 2266 6f72 6d61 7422 5d0a 0a20 2020  s["format"]..   
+0000e430: 2020 2020 2069 6620 2274 6167 7322 2069       if "tags" i
+0000e440: 6e20 6e6f 6465 3a0a 2020 2020 2020 2020  n node:.        
+0000e450: 2020 2020 7461 6773 203d 207b 6b3a 2076      tags = {k: v
+0000e460: 5b30 5d20 666f 7220 6b2c 2076 2069 6e20  [0] for k, v in 
+0000e470: 7572 6c6c 6962 2e70 6172 7365 2e70 6172  urllib.parse.par
+0000e480: 7365 5f71 7328 6e6f 6465 5b22 7461 6773  se_qs(node["tags
+0000e490: 225d 292e 6974 656d 7328 297d 0a20 2020  "]).items()}.   
+0000e4a0: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+0000e4b0: 7570 6461 7465 2874 6167 7329 0a0a 2020  update(tags)..  
+0000e4c0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
+0000e4d0: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+0000e4e0: 416e 795d 5d20 3d20 5b5d 0a0a 2020 2020  Any]] = []..    
+0000e4f0: 2020 2020 7265 736f 7572 6365 732e 6170      resources.ap
+0000e500: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+0000e510: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0000e520: 2020 2020 2272 6573 6f75 7263 6522 3a20      "resource": 
+0000e530: 2264 6174 6173 6f75 7263 6573 222c 0a20  "datasources",. 
+0000e540: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000e550: 7265 736f 7572 6365 5f6e 616d 6522 3a20  resource_name": 
+0000e560: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0000e570: 2020 2020 2020 2276 6572 7369 6f6e 223a        "version":
+0000e580: 2064 6f63 2e76 6572 7369 6f6e 2c0a 2020   doc.version,.  
+0000e590: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+0000e5a0: 6172 616d 7322 3a20 7061 7261 6d73 2c0a  arams": params,.
+0000e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5c0: 2266 696c 656e 616d 6522 3a20 6669 6c65  "filename": file
+0000e5d0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0000e5e0: 2020 2020 2020 2264 6570 7322 3a20 6465        "deps": de
+0000e5f0: 7073 2c0a 2020 2020 2020 2020 2020 2020  ps,.            
+0000e600: 2020 2020 2274 6f6b 656e 7322 3a20 646f      "tokens": do
+0000e610: 632e 746f 6b65 6e73 2c0a 2020 2020 2020  c.tokens,.      
+0000e620: 2020 2020 2020 2020 2020 2273 6861 7265            "share
+0000e630: 645f 7769 7468 223a 2064 6f63 2e73 6861  d_with": doc.sha
+0000e640: 7265 645f 7769 7468 2c0a 2020 2020 2020  red_with,.      
+0000e650: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000e660: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0000e670: 6e20 7265 736f 7572 6365 730a 0a20 2020  n resources..   
+0000e680: 2065 6c69 6620 4461 7461 4669 6c65 4578   elif DataFileEx
+0000e690: 7465 6e73 696f 6e73 2e50 4950 4520 696e  tensions.PIPE in
+0000e6a0: 2066 696c 656e 616d 653a 0a20 2020 2020   filename:.     
+0000e6b0: 2020 2064 6f63 203d 2070 6172 7365 5f70     doc = parse_p
+0000e6c0: 6970 6528 6669 6c65 6e61 6d65 290a 2020  ipe(filename).  
+0000e6d0: 2020 2020 2020 7665 7273 696f 6e20 3d20        version = 
+0000e6e0: 6622 5f5f 767b 646f 632e 7665 7273 696f  f"__v{doc.versio
+0000e6f0: 6e7d 2220 6966 2064 6f63 2e76 6572 7369  n}" if doc.versi
+0000e700: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 2065  on is not None e
+0000e710: 6c73 6520 2222 0a20 2020 2020 2020 206e  lse "".        n
+0000e720: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
+0000e730: 7365 6e61 6d65 2866 696c 656e 616d 6529  sename(filename)
+0000e740: 2e73 706c 6974 2822 2e22 295b 305d 0a20  .split(".")[0]. 
+0000e750: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
+0000e760: 6f6e 203d 2064 6f63 2e64 6573 6372 6970  on = doc.descrip
+0000e770: 7469 6f6e 2069 6620 646f 632e 6465 7363  tion if doc.desc
+0000e780: 7269 7074 696f 6e20 6973 206e 6f74 204e  ription is not N
+0000e790: 6f6e 6520 656c 7365 2022 220a 0a20 2020  one else ""..   
+0000e7a0: 2020 2020 2064 6570 7320 3d20 5b5d 0a20       deps = []. 
+0000e7b0: 2020 2020 2020 206e 6f64 6573 3a20 4c69         nodes: Li
+0000e7c0: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
+0000e7d0: 5d5d 203d 205b 5d0a 0a20 2020 2020 2020  ]] = []..       
+0000e7e0: 2066 6f72 206e 6f64 6520 696e 2064 6f63   for node in doc
+0000e7f0: 2e6e 6f64 6573 3a0a 2020 2020 2020 2020  .nodes:.        
+0000e800: 2020 2020 7371 6c20 3d20 6e6f 6465 5b22      sql = node["
+0000e810: 7371 6c22 5d0a 2020 2020 2020 2020 2020  sql"].          
+0000e820: 2020 6e6f 6465 5f74 7970 6520 3d20 6e6f    node_type = no
+0000e830: 6465 2e67 6574 2822 7479 7065 222c 2022  de.get("type", "
+0000e840: 7374 616e 6461 7264 2229 2e6c 6f77 6572  standard").lower
+0000e850: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
+0000e860: 6172 616d 7320 3d20 7b0a 2020 2020 2020  arams = {.      
+0000e870: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+0000e880: 3a20 6e6f 6465 5b22 6e61 6d65 225d 2c0a  : node["name"],.
+0000e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8a0: 2274 7970 6522 3a20 6e6f 6465 5f74 7970  "type": node_typ
+0000e8b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000e8c0: 2020 2022 6465 7363 7269 7074 696f 6e22     "description"
+0000e8d0: 3a20 6e6f 6465 2e67 6574 2822 6465 7363  : node.get("desc
+0000e8e0: 7269 7074 696f 6e22 2c20 2222 292c 0a20  ription", ""),. 
+0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000e900: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
+0000e910: 6522 3a20 6e6f 6465 2e67 6574 2822 7461  e": node.get("ta
+0000e920: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
+0000e930: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0000e940: 2020 2020 2020 2020 2022 636f 7079 5f73           "copy_s
+0000e950: 6368 6564 756c 6522 3a20 6e6f 6465 2e67  chedule": node.g
+0000e960: 6574 2843 6f70 7950 6172 616d 6574 6572  et(CopyParameter
+0000e970: 732e 434f 5059 5f53 4348 4544 554c 452c  s.COPY_SCHEDULE,
+0000e980: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000e990: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0000e9a0: 2020 2069 735f 6578 706f 7274 5f6e 6f64     is_export_nod
+0000e9b0: 6520 3d20 4578 706f 7274 5265 706c 6163  e = ExportReplac
+0000e9c0: 656d 656e 7473 2e69 735f 6578 706f 7274  ements.is_export
+0000e9d0: 5f6e 6f64 6528 6e6f 6465 290a 2020 2020  _node(node).    
+0000e9e0: 2020 2020 2020 2020 6578 706f 7274 5f70          export_p
+0000e9f0: 6172 616d 7320 3d20 4578 706f 7274 5265  arams = ExportRe
+0000ea00: 706c 6163 656d 656e 7473 2e67 6574 5f70  placements.get_p
+0000ea10: 6172 616d 735f 6672 6f6d 5f64 6174 6166  arams_from_dataf
+0000ea20: 696c 6528 6e6f 6465 2920 6966 2069 735f  ile(node) if is_
+0000ea30: 6578 706f 7274 5f6e 6f64 6520 656c 7365  export_node else
+0000ea40: 204e 6f6e 650a 0a20 2020 2020 2020 2020   None..         
+0000ea50: 2020 2073 716c 203d 2073 716c 2e73 7472     sql = sql.str
+0000ea60: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
+0000ea70: 2069 735f 7465 6d70 6c61 7465 203d 2046   is_template = F
+0000ea80: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0000ea90: 2069 6620 7371 6c5b 305d 203d 3d20 2225   if sql[0] == "%
+0000eaa0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0000eab0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000eac0: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
+0000ead0: 7265 6e64 6572 6564 2c20 5f20 3d20 7265  rendered, _ = re
+0000eae0: 6e64 6572 5f73 716c 5f74 656d 706c 6174  nder_sql_templat
+0000eaf0: 6528 7371 6c5b 313a 5d2c 2074 6573 745f  e(sql[1:], test_
+0000eb00: 6d6f 6465 3d54 7275 6529 0a20 2020 2020  mode=True).     
+0000eb10: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000eb20: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0000eb30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000eb40: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
+0000eb50: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
+0000eb60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000eb70: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0000eb80: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0000eb90: 7061 7273 696e 675f 6e6f 6465 286e 6f64  parsing_node(nod
+0000eba0: 653d 6e6f 6465 5b22 6e61 6d65 225d 2c20  e=node["name"], 
+0000ebb0: 7069 7065 3d6e 616d 652c 2065 7272 6f72  pipe=name, error
+0000ebc0: 3d73 7472 2865 2929 0a20 2020 2020 2020  =str(e)).       
+0000ebd0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000ebf0: 735f 7465 6d70 6c61 7465 203d 2054 7275  s_template = Tru
+0000ec00: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+0000ec10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000ec20: 2020 2020 7371 6c5f 7265 6e64 6572 6564      sql_rendered
+0000ec30: 203d 2073 716c 0a0a 2020 2020 2020 2020   = sql..        
+0000ec40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000ec50: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+0000ec60: 6e63 6965 7320 3d20 6177 6169 7420 7462  ncies = await tb
+0000ec70: 5f63 6c69 656e 742e 7371 6c5f 6765 745f  _client.sql_get_
+0000ec80: 7573 6564 5f74 6162 6c65 7328 7371 6c5f  used_tables(sql_
+0000ec90: 7265 6e64 6572 6564 2c20 7261 6973 696e  rendered, raisin
+0000eca0: 673d 5472 7565 290a 2020 2020 2020 2020  g=True).        
+0000ecb0: 2020 2020 2020 2020 6465 7073 202b 3d20          deps += 
+0000ecc0: 5b74 2066 6f72 2074 2069 6e20 6465 7065  [t for t in depe
+0000ecd0: 6e64 656e 6369 6573 2069 6620 7420 6e6f  ndencies if t no
+0000ece0: 7420 696e 205b 6e5b 226e 616d 6522 5d20  t in [n["name"] 
+0000ecf0: 666f 7220 6e20 696e 2064 6f63 2e6e 6f64  for n in doc.nod
+0000ed00: 6573 5d5d 0a0a 2020 2020 2020 2020 2020  es]]..          
+0000ed10: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0000ed20: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0000ed30: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+0000ed40: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0000ed50: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+0000ed60: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
+0000ed70: 6b4d 616e 6167 6572 2e65 7272 6f72 5f70  kManager.error_p
+0000ed80: 6172 7369 6e67 5f6e 6f64 6528 6e6f 6465  arsing_node(node
+0000ed90: 3d6e 6f64 655b 226e 616d 6522 5d2c 2070  =node["name"], p
+0000eda0: 6970 653d 6e61 6d65 2c20 6572 726f 723d  ipe=name, error=
+0000edb0: 7374 7228 6529 290a 2020 2020 2020 2020  str(e)).        
+0000edc0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000edd0: 2020 2020 2020 2069 6620 6973 5f74 656d         if is_tem
+0000ede0: 706c 6174 653a 0a20 2020 2020 2020 2020  plate:.         
+0000edf0: 2020 2020 2020 2064 6570 7320 2b3d 2067         deps += g
+0000ee00: 6574 5f75 7365 645f 7461 626c 6573 5f69  et_used_tables_i
+0000ee10: 6e5f 7465 6d70 6c61 7465 2873 716c 5b31  n_template(sql[1
+0000ee20: 3a5d 290a 0a20 2020 2020 2020 2020 2020  :])..           
+0000ee30: 2069 735f 6e65 6974 6865 725f 636f 7079   is_neither_copy
+0000ee40: 5f6e 6f72 5f6d 6174 6572 6961 6c69 7a65  _nor_materialize
+0000ee50: 6420 3d20 2264 6174 6173 6f75 7263 6522  d = "datasource"
+0000ee60: 206e 6f74 2069 6e20 6e6f 6465 2061 6e64   not in node and
+0000ee70: 2022 7461 7267 6574 5f64 6174 6173 6f75   "target_datasou
+0000ee80: 7263 6522 206e 6f74 2069 6e20 6e6f 6465  rce" not in node
+0000ee90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000eea0: 2265 6e67 696e 6522 2069 6e20 6e6f 6465  "engine" in node
+0000eeb0: 2061 6e64 2069 735f 6e65 6974 6865 725f   and is_neither_
+0000eec0: 636f 7079 5f6e 6f72 5f6d 6174 6572 6961  copy_nor_materia
+0000eed0: 6c69 7a65 643a 0a20 2020 2020 2020 2020  lized:.         
+0000eee0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000eef0: 7565 4572 726f 7228 2244 6566 696e 696e  ueError("Definin
+0000ef00: 6720 454e 4749 4e45 206f 7074 696f 6e73  g ENGINE options
+0000ef10: 2069 6e20 6120 6e6f 6465 2072 6571 7569   in a node requi
+0000ef20: 7265 7320 6120 4441 5441 534f 5552 4345  res a DATASOURCE
+0000ef30: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+0000ef40: 6966 2022 6461 7461 736f 7572 6365 2220  if "datasource" 
+0000ef50: 696e 206e 6f64 653a 0a20 2020 2020 2020  in node:.       
+0000ef60: 2020 2020 2020 2020 2070 6172 616d 735b           params[
+0000ef70: 2264 6174 6173 6f75 7263 6522 5d20 3d20  "datasource"] = 
+0000ef80: 6e6f 6465 5b22 6461 7461 736f 7572 6365  node["datasource
+0000ef90: 225d 202b 2072 6573 6f75 7263 655f 7665  "] + resource_ve
+0000efa0: 7273 696f 6e73 5f73 7472 696e 672e 6765  rsions_string.ge
+0000efb0: 7428 6e6f 6465 5b22 6461 7461 736f 7572  t(node["datasour
+0000efc0: 6365 225d 2c20 2222 290a 2020 2020 2020  ce"], "").      
+0000efd0: 2020 2020 2020 2020 2020 6465 7073 202b            deps +
+0000efe0: 3d20 5b6e 6f64 655b 2264 6174 6173 6f75  = [node["datasou
+0000eff0: 7263 6522 5d5d 0a0a 2020 2020 2020 2020  rce"]]..        
+0000f000: 2020 2020 6966 2022 7461 7267 6574 5f64      if "target_d
+0000f010: 6174 6173 6f75 7263 6522 2069 6e20 6e6f  atasource" in no
+0000f020: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+0000f030: 2020 2020 7061 7261 6d73 5b22 7461 7267      params["targ
+0000f040: 6574 5f64 6174 6173 6f75 7263 6522 5d20  et_datasource"] 
+0000f050: 3d20 6e6f 6465 5b22 7461 7267 6574 5f64  = node["target_d
+0000f060: 6174 6173 6f75 7263 6522 5d20 2b20 7265  atasource"] + re
+0000f070: 736f 7572 6365 5f76 6572 7369 6f6e 735f  source_versions_
+0000f080: 7374 7269 6e67 2e67 6574 280a 2020 2020  string.get(.    
+0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0a0: 6e6f 6465 5b22 7461 7267 6574 5f64 6174  node["target_dat
+0000f0b0: 6173 6f75 7263 6522 5d2c 2022 220a 2020  asource"], "".  
+0000f0c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0e0: 6465 7073 202b 3d20 5b6e 6f64 655b 2274  deps += [node["t
+0000f0f0: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
+0000f100: 225d 5d0a 0a20 2020 2020 2020 2020 2020  "]]..           
+0000f110: 2070 6172 616d 732e 7570 6461 7465 2867   params.update(g
+0000f120: 6574 5f65 6e67 696e 655f 7061 7261 6d73  et_engine_params
+0000f130: 286e 6f64 6529 290a 0a20 2020 2020 2020  (node))..       
+0000f140: 2020 2020 2064 6566 2063 7265 6174 655f       def create_
+0000f150: 7265 706c 6163 656d 656e 745f 666f 725f  replacement_for_
+0000f160: 7265 736f 7572 6365 286e 616d 653a 2073  resource(name: s
+0000f170: 7472 2920 2d3e 2073 7472 3a0a 2020 2020  tr) -> str:.    
+0000f180: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000f190: 6f6c 645f 7773 2c20 6e65 775f 7773 2069  old_ws, new_ws i
+0000f1a0: 6e20 776f 726b 7370 6163 655f 6d61 702e  n workspace_map.
+0000f1b0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0000f1c0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+0000f1d0: 6520 3d20 6e61 6d65 2e72 6570 6c61 6365  e = name.replace
+0000f1e0: 2866 227b 6f6c 645f 7773 7d2e 222c 2066  (f"{old_ws}.", f
+0000f1f0: 227b 6e65 775f 7773 7d2e 2229 0a20 2020  "{new_ws}.").   
+0000f200: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000f210: 7572 6e20 6e61 6d65 202b 2072 6573 6f75  urn name + resou
+0000f220: 7263 655f 7665 7273 696f 6e73 5f73 7472  rce_versions_str
+0000f230: 696e 672e 6765 7428 6e61 6d65 2c20 2222  ing.get(name, ""
+0000f240: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+0000f250: 6570 6c61 6365 6d65 6e74 7320 3d20 7b0a  eplacements = {.
+0000f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f270: 783a 2063 7265 6174 655f 7265 706c 6163  x: create_replac
+0000f280: 656d 656e 745f 666f 725f 7265 736f 7572  ement_for_resour
+0000f290: 6365 2878 2920 666f 7220 7820 696e 2064  ce(x) for x in d
+0000f2a0: 6570 7320 6966 2078 206e 6f74 2069 6e20  eps if x not in 
+0000f2b0: 5b6e 5b22 6e61 6d65 225d 2066 6f72 206e  [n["name"] for n
+0000f2c0: 2069 6e20 646f 632e 6e6f 6465 735d 0a20   in doc.nodes]. 
+0000f2d0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+0000f2e0: 2020 2020 2020 2020 2020 2320 4649 584d            # FIXM
+0000f2f0: 453a 2049 6465 616c 6c79 2077 6520 7368  E: Ideally we sh
+0000f300: 6f75 6c64 2075 7365 2061 7761 6974 2074  ould use await t
+0000f310: 625f 636c 6965 6e74 2e72 6570 6c61 6365  b_client.replace
+0000f320: 5f74 6162 6c65 7328 7371 6c2c 2072 6570  _tables(sql, rep
+0000f330: 6c61 6365 6d65 6e74 7329 0a20 2020 2020  lacements).     
+0000f340: 2020 2020 2020 2066 6f72 206f 6c64 2c20         for old, 
+0000f350: 6e65 7720 696e 2072 6570 6c61 6365 6d65  new in replaceme
+0000f360: 6e74 732e 6974 656d 7328 293a 0a20 2020  nts.items():.   
+0000f370: 2020 2020 2020 2020 2020 2020 2073 716c               sql
+0000f380: 203d 2072 652e 7375 6228 2228 5b5c 7420   = re.sub("([\t 
+0000f390: 5c5c 6e27 5d2b 7c5e 2922 202b 206f 6c64  \\n']+|^)" + old
+0000f3a0: 202b 2022 285b 5c74 205c 5c6e 275c 5c29   + "([\t \\n'\\)
+0000f3b0: 5d2b 7c24 2922 2c20 225c 5c31 2220 2b20  ]+|$)", "\\1" + 
+0000f3c0: 6e65 7720 2b20 225c 5c32 222c 2073 716c  new + "\\2", sql
+0000f3d0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000f3e0: 6620 2274 6167 7322 2069 6e20 6e6f 6465  f "tags" in node
+0000f3f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f400: 2020 7461 6773 203d 207b 6b3a 2076 5b30    tags = {k: v[0
+0000f410: 5d20 666f 7220 6b2c 2076 2069 6e20 7572  ] for k, v in ur
+0000f420: 6c6c 6962 2e70 6172 7365 2e70 6172 7365  llib.parse.parse
+0000f430: 5f71 7328 6e6f 6465 5b22 7461 6773 225d  _qs(node["tags"]
+0000f440: 292e 6974 656d 7328 297d 0a20 2020 2020  ).items()}.     
+0000f450: 2020 2020 2020 2020 2020 2070 6172 616d             param
+0000f460: 732e 7570 6461 7465 2874 6167 7329 0a0a  s.update(tags)..
+0000f470: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0000f480: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
+0000f490: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0000f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4b0: 2273 716c 223a 2073 716c 2c0a 2020 2020  "sql": sql,.    
+0000f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4d0: 2270 6172 616d 7322 3a20 7061 7261 6d73  "params": params
+0000f4e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f4f0: 2020 2020 2020 2265 7870 6f72 745f 7061        "export_pa
+0000f500: 7261 6d73 223a 2065 7870 6f72 745f 7061  rams": export_pa
+0000f510: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
+0000f520: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000f530: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+0000f540: 6574 7572 6e20 5b0a 2020 2020 2020 2020  eturn [.        
+0000f550: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0000f560: 2020 2020 2020 2272 6573 6f75 7263 6522        "resource"
+0000f570: 3a20 2270 6970 6573 222c 0a20 2020 2020  : "pipes",.     
+0000f580: 2020 2020 2020 2020 2020 2022 7265 736f             "reso
+0000f590: 7572 6365 5f6e 616d 6522 3a20 6e61 6d65  urce_name": name
+0000f5a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f5b0: 2020 2276 6572 7369 6f6e 223a 2064 6f63    "version": doc
+0000f5c0: 2e76 6572 7369 6f6e 2c0a 2020 2020 2020  .version,.      
+0000f5d0: 2020 2020 2020 2020 2020 2266 696c 656e            "filen
+0000f5e0: 616d 6522 3a20 6669 6c65 6e61 6d65 2c0a  ame": filename,.
+0000f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f600: 226e 616d 6522 3a20 6e61 6d65 202b 2076  "name": name + v
+0000f610: 6572 7369 6f6e 2c0a 2020 2020 2020 2020  ersion,.        
+0000f620: 2020 2020 2020 2020 226e 6f64 6573 223a          "nodes":
+0000f630: 206e 6f64 6573 2c0a 2020 2020 2020 2020   nodes,.        
+0000f640: 2020 2020 2020 2020 2264 6570 7322 3a20          "deps": 
+0000f650: 5b78 2066 6f72 2078 2069 6e20 7365 7428  [x for x in set(
+0000f660: 6465 7073 295d 2c0a 2020 2020 2020 2020  deps)],.        
+0000f670: 2020 2020 2020 2020 2274 6f6b 656e 7322          "tokens"
+0000f680: 3a20 646f 632e 746f 6b65 6e73 2c0a 2020  : doc.tokens,.  
+0000f690: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+0000f6a0: 6573 6372 6970 7469 6f6e 223a 2064 6573  escription": des
+0000f6b0: 6372 6970 7469 6f6e 2c0a 2020 2020 2020  cription,.      
+0000f6c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000f6d0: 5d0a 2020 2020 656c 6966 2044 6174 6146  ].    elif DataF
+0000f6e0: 696c 6545 7874 656e 7369 6f6e 732e 544f  ileExtensions.TO
+0000f6f0: 4b45 4e20 696e 2066 696c 656e 616d 653a  KEN in filename:
+0000f700: 0a20 2020 2020 2020 2064 6f63 203d 2070  .        doc = p
+0000f710: 6172 7365 5f74 6f6b 656e 2866 696c 656e  arse_token(filen
+0000f720: 616d 6529 0a20 2020 2020 2020 206e 616d  ame).        nam
+0000f730: 6520 3d20 6f73 2e70 6174 682e 6261 7365  e = os.path.base
+0000f740: 6e61 6d65 2866 696c 656e 616d 6529 2e73  name(filename).s
+0000f750: 706c 6974 2844 6174 6146 696c 6545 7874  plit(DataFileExt
+0000f760: 656e 7369 6f6e 732e 544f 4b45 4e29 5b30  ensions.TOKEN)[0
+0000f770: 5d0a 2020 2020 2020 2020 6465 7363 7269  ].        descri
+0000f780: 7074 696f 6e20 3d20 646f 632e 6465 7363  ption = doc.desc
+0000f790: 7269 7074 696f 6e20 6f72 2022 220a 2020  ription or "".  
+0000f7a0: 2020 2020 2020 7665 7273 696f 6e20 3d20        version = 
+0000f7b0: 6622 5f5f 767b 646f 632e 7665 7273 696f  f"__v{doc.versio
+0000f7c0: 6e7d 2220 6966 2064 6f63 2e76 6572 7369  n}" if doc.versi
+0000f7d0: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 2065  on is not None e
+0000f7e0: 6c73 6520 2222 0a20 2020 2020 2020 2073  lse "".        s
+0000f7f0: 636f 7065 7320 3d20 646f 632e 6e6f 6465  copes = doc.node
+0000f800: 7320 6f72 205b 5d0a 2020 2020 2020 2020  s or [].        
+0000f810: 7265 7475 726e 205b 0a20 2020 2020 2020  return [.       
+0000f820: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0000f830: 2020 2020 2020 2022 7265 736f 7572 6365         "resource
+0000f840: 223a 2022 746f 6b65 6e73 222c 0a20 2020  ": "tokens",.   
+0000f850: 2020 2020 2020 2020 2020 2020 2022 7265               "re
+0000f860: 736f 7572 6365 5f6e 616d 6522 3a20 6e61  source_name": na
+0000f870: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0000f880: 2020 2020 2276 6572 7369 6f6e 223a 2064      "version": d
+0000f890: 6f63 2e76 6572 7369 6f6e 2c0a 2020 2020  oc.version,.    
+0000f8a0: 2020 2020 2020 2020 2020 2020 2266 696c              "fil
+0000f8b0: 656e 616d 6522 3a20 6669 6c65 6e61 6d65  ename": filename
+0000f8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f8d0: 2020 226e 616d 6522 3a20 6e61 6d65 202b    "name": name +
+0000f8e0: 2076 6572 7369 6f6e 2c0a 2020 2020 2020   version,.      
+0000f8f0: 2020 2020 2020 2020 2020 2273 636f 7065            "scope
+0000f900: 7322 3a20 7363 6f70 6573 2c0a 2020 2020  s": scopes,.    
+0000f910: 2020 2020 2020 2020 2020 2020 2264 6573              "des
+0000f920: 6372 6970 7469 6f6e 223a 2064 6573 6372  cription": descr
+0000f930: 6970 7469 6f6e 2c0a 2020 2020 2020 2020  iption,.        
+0000f940: 2020 2020 7d0a 2020 2020 2020 2020 5d0a      }.        ].
+0000f950: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f960: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0000f970: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+0000f980: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0000f990: 6f72 5f66 696c 655f 6578 7465 6e73 696f  or_file_extensio
+0000f9a0: 6e28 6669 6c65 6e61 6d65 3d66 696c 656e  n(filename=filen
+0000f9b0: 616d 6529 290a 0a0a 6465 6620 6675 6c6c  ame))...def full
+0000f9c0: 5f70 6174 685f 6279 5f6e 616d 6528 0a20  _path_by_name(. 
+0000f9d0: 2020 2066 6f6c 6465 723a 2073 7472 2c20     folder: str, 
+0000f9e0: 6e61 6d65 3a20 7374 722c 2077 6f72 6b73  name: str, works
+0000f9f0: 7061 6365 5f6c 6962 5f70 6174 6873 3a20  pace_lib_paths: 
+0000fa00: 4f70 7469 6f6e 616c 5b4c 6973 745b 5475  Optional[List[Tu
+0000fa10: 706c 655b 7374 722c 2073 7472 5d5d 5d20  ple[str, str]]] 
+0000fa20: 3d20 4e6f 6e65 0a29 202d 3e20 4f70 7469  = None.) -> Opti
+0000fa30: 6f6e 616c 5b50 6174 685d 3a0a 2020 2020  onal[Path]:.    
+0000fa40: 6620 3d20 5061 7468 2866 6f6c 6465 7229  f = Path(folder)
+0000fa50: 0a20 2020 2064 7320 3d20 6e61 6d65 202b  .    ds = name +
+0000fa60: 2022 2e64 6174 6173 6f75 7263 6522 0a20   ".datasource". 
+0000fa70: 2020 2069 6620 6f73 2e70 6174 682e 6973     if os.path.is
+0000fa80: 6669 6c65 286f 732e 7061 7468 2e6a 6f69  file(os.path.joi
+0000fa90: 6e28 666f 6c64 6572 2c20 6473 2929 3a0a  n(folder, ds)):.
+0000faa0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0000fab0: 202f 2064 730a 2020 2020 6966 206f 732e   / ds.    if os.
+0000fac0: 7061 7468 2e69 7366 696c 6528 6620 2f20  path.isfile(f / 
+0000fad0: 2264 6174 6173 6f75 7263 6573 2220 2f20  "datasources" / 
+0000fae0: 6473 293a 0a20 2020 2020 2020 2072 6574  ds):.        ret
+0000faf0: 7572 6e20 6620 2f20 2264 6174 6173 6f75  urn f / "datasou
+0000fb00: 7263 6573 2220 2f20 6473 0a0a 2020 2020  rces" / ds..    
+0000fb10: 7069 7065 203d 206e 616d 6520 2b20 222e  pipe = name + ".
+0000fb20: 7069 7065 220a 2020 2020 6966 206f 732e  pipe".    if os.
+0000fb30: 7061 7468 2e69 7366 696c 6528 6f73 2e70  path.isfile(os.p
+0000fb40: 6174 682e 6a6f 696e 2866 6f6c 6465 722c  ath.join(folder,
+0000fb50: 2070 6970 6529 293a 0a20 2020 2020 2020   pipe)):.       
+0000fb60: 2072 6574 7572 6e20 6620 2f20 7069 7065   return f / pipe
+0000fb70: 0a0a 2020 2020 6966 206f 732e 7061 7468  ..    if os.path
+0000fb80: 2e69 7366 696c 6528 6620 2f20 2265 6e64  .isfile(f / "end
+0000fb90: 706f 696e 7473 2220 2f20 7069 7065 293a  points" / pipe):
+0000fba0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000fbb0: 6620 2f20 2265 6e64 706f 696e 7473 2220  f / "endpoints" 
+0000fbc0: 2f20 7069 7065 0a0a 2020 2020 6966 206f  / pipe..    if o
+0000fbd0: 732e 7061 7468 2e69 7366 696c 6528 6620  s.path.isfile(f 
+0000fbe0: 2f20 2270 6970 6573 2220 2f20 7069 7065  / "pipes" / pipe
+0000fbf0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000fc00: 6e20 6620 2f20 2270 6970 6573 2220 2f20  n f / "pipes" / 
+0000fc10: 7069 7065 0a0a 2020 2020 746f 6b65 6e20  pipe..    token 
+0000fc20: 3d20 6e61 6d65 202b 2022 2e74 6f6b 656e  = name + ".token
+0000fc30: 220a 2020 2020 6966 206f 732e 7061 7468  ".    if os.path
+0000fc40: 2e69 7366 696c 6528 6620 2f20 2274 6f6b  .isfile(f / "tok
+0000fc50: 656e 7322 202f 2074 6f6b 656e 293a 0a20  ens" / token):. 
+0000fc60: 2020 2020 2020 2072 6574 7572 6e20 6620         return f 
+0000fc70: 2f20 2274 6f6b 656e 7322 202f 2074 6f6b  / "tokens" / tok
+0000fc80: 656e 0a0a 2020 2020 6966 2077 6f72 6b73  en..    if works
+0000fc90: 7061 6365 5f6c 6962 5f70 6174 6873 3a0a  pace_lib_paths:.
+0000fca0: 2020 2020 2020 2020 666f 7220 776b 5f6e          for wk_n
+0000fcb0: 616d 652c 2077 6b5f 7061 7468 2069 6e20  ame, wk_path in 
+0000fcc0: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+0000fcd0: 7468 733a 0a20 2020 2020 2020 2020 2020  ths:.           
+0000fce0: 2069 6620 6e61 6d65 2e73 7461 7274 7377   if name.startsw
+0000fcf0: 6974 6828 6622 7b77 6b5f 6e61 6d65 7d2e  ith(f"{wk_name}.
+0000fd00: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+0000fd10: 2020 2020 7220 3d20 6675 6c6c 5f70 6174      r = full_pat
+0000fd20: 685f 6279 5f6e 616d 6528 776b 5f70 6174  h_by_name(wk_pat
+0000fd30: 682c 206e 616d 652e 7265 706c 6163 6528  h, name.replace(
+0000fd40: 6622 7b77 6b5f 6e61 6d65 7d2e 222c 2022  f"{wk_name}.", "
+0000fd50: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+0000fd60: 2020 2020 6966 2072 3a0a 2020 2020 2020      if r:.      
+0000fd70: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000fd80: 7475 726e 2072 0a20 2020 2072 6574 7572  turn r.    retur
+0000fd90: 6e20 4e6f 6e65 0a0a 0a64 6566 2066 696e  n None...def fin
+0000fda0: 645f 6669 6c65 5f62 795f 6e61 6d65 280a  d_file_by_name(.
+0000fdb0: 2020 2020 666f 6c64 6572 3a20 7374 722c      folder: str,
+0000fdc0: 0a20 2020 206e 616d 653a 2073 7472 2c0a  .    name: str,.
+0000fdd0: 2020 2020 7665 7262 6f73 653a 2062 6f6f      verbose: boo
+0000fde0: 6c20 3d20 4661 6c73 652c 0a20 2020 2069  l = False,.    i
+0000fdf0: 735f 7261 773a 2062 6f6f 6c20 3d20 4661  s_raw: bool = Fa
+0000fe00: 6c73 652c 0a20 2020 2077 6f72 6b73 7061  lse,.    workspa
+0000fe10: 6365 5f6c 6962 5f70 6174 6873 3a20 4f70  ce_lib_paths: Op
+0000fe20: 7469 6f6e 616c 5b4c 6973 745b 5475 706c  tional[List[Tupl
+0000fe30: 655b 7374 722c 2073 7472 5d5d 5d20 3d20  e[str, str]]] = 
+0000fe40: 4e6f 6e65 2c0a 2020 2020 7265 736f 7572  None,.    resour
+0000fe50: 6365 3a20 4f70 7469 6f6e 616c 5b44 6963  ce: Optional[Dic
+0000fe60: 745d 203d 204e 6f6e 652c 0a29 3a0a 2020  t] = None,.):.  
+0000fe70: 2020 6620 3d20 5061 7468 2866 6f6c 6465    f = Path(folde
+0000fe80: 7229 0a20 2020 2064 7320 3d20 6e61 6d65  r).    ds = name
+0000fe90: 202b 2022 2e64 6174 6173 6f75 7263 6522   + ".datasource"
+0000fea0: 0a20 2020 2069 6620 6f73 2e70 6174 682e  .    if os.path.
+0000feb0: 6973 6669 6c65 286f 732e 7061 7468 2e6a  isfile(os.path.j
+0000fec0: 6f69 6e28 666f 6c64 6572 2c20 6473 2929  oin(folder, ds))
+0000fed0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000fee0: 2064 732c 204e 6f6e 650a 2020 2020 6966   ds, None.    if
+0000fef0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000ff00: 6620 2f20 2264 6174 6173 6f75 7263 6573  f / "datasources
+0000ff10: 2220 2f20 6473 293a 0a20 2020 2020 2020  " / ds):.       
+0000ff20: 2072 6574 7572 6e20 6473 2c20 4e6f 6e65   return ds, None
+0000ff30: 0a0a 2020 2020 7069 7065 203d 206e 616d  ..    pipe = nam
+0000ff40: 6520 2b20 222e 7069 7065 220a 2020 2020  e + ".pipe".    
+0000ff50: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
+0000ff60: 6528 6f73 2e70 6174 682e 6a6f 696e 2866  e(os.path.join(f
+0000ff70: 6f6c 6465 722c 2070 6970 6529 293a 0a20  older, pipe)):. 
+0000ff80: 2020 2020 2020 2072 6574 7572 6e20 7069         return pi
+0000ff90: 7065 2c20 4e6f 6e65 0a0a 2020 2020 6966  pe, None..    if
+0000ffa0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000ffb0: 6620 2f20 2265 6e64 706f 696e 7473 2220  f / "endpoints" 
+0000ffc0: 2f20 7069 7065 293a 0a20 2020 2020 2020  / pipe):.       
+0000ffd0: 2072 6574 7572 6e20 7069 7065 2c20 4e6f   return pipe, No
+0000ffe0: 6e65 0a0a 2020 2020 6966 206f 732e 7061  ne..    if os.pa
+0000fff0: 7468 2e69 7366 696c 6528 6620 2f20 2270  th.isfile(f / "p
+00010000: 6970 6573 2220 2f20 7069 7065 293a 0a20  ipes" / pipe):. 
+00010010: 2020 2020 2020 2072 6574 7572 6e20 7069         return pi
+00010020: 7065 2c20 4e6f 6e65 0a0a 2020 2020 746f  pe, None..    to
+00010030: 6b65 6e20 3d20 6e61 6d65 202b 2022 2e74  ken = name + ".t
+00010040: 6f6b 656e 220a 2020 2020 6966 206f 732e  oken".    if os.
+00010050: 7061 7468 2e69 7366 696c 6528 6620 2f20  path.isfile(f / 
+00010060: 2274 6f6b 656e 7322 202f 2074 6f6b 656e  "tokens" / token
+00010070: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00010080: 6e20 746f 6b65 6e2c 204e 6f6e 650a 0a20  n token, None.. 
+00010090: 2020 2023 206c 6f6f 6b20 666f 7220 7468     # look for th
+000100a0: 6520 6669 6c65 2069 6e20 7375 6264 6972  e file in subdir
+000100b0: 6563 746f 7269 6573 2069 6620 6974 2773  ectories if it's
+000100c0: 206e 6f74 2066 6f75 6e64 2069 6e20 6461   not found in da
+000100d0: 7461 736f 7572 6365 7320 666f 6c64 6572  tasources folder
+000100e0: 0a20 2020 2069 6620 776f 726b 7370 6163  .    if workspac
+000100f0: 655f 6c69 625f 7061 7468 733a 0a20 2020  e_lib_paths:.   
+00010100: 2020 2020 205f 7265 736f 7572 6365 203d       _resource =
+00010110: 204e 6f6e 650a 2020 2020 2020 2020 666f   None.        fo
+00010120: 7220 776b 5f6e 616d 652c 2077 6b5f 7061  r wk_name, wk_pa
+00010130: 7468 2069 6e20 776f 726b 7370 6163 655f  th in workspace_
+00010140: 6c69 625f 7061 7468 733a 0a20 2020 2020  lib_paths:.     
+00010150: 2020 2020 2020 2066 696c 6520 3d20 4e6f         file = No
+00010160: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
+00010170: 6620 6e61 6d65 2e73 7461 7274 7377 6974  f name.startswit
+00010180: 6828 6622 7b77 6b5f 6e61 6d65 7d2e 2229  h(f"{wk_name}.")
+00010190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000101a0: 2020 6669 6c65 2c20 5f72 6573 6f75 7263    file, _resourc
+000101b0: 6520 3d20 6669 6e64 5f66 696c 655f 6279  e = find_file_by
+000101c0: 5f6e 616d 6528 0a20 2020 2020 2020 2020  _name(.         
+000101d0: 2020 2020 2020 2020 2020 2077 6b5f 7061             wk_pa
+000101e0: 7468 2c20 6e61 6d65 2e72 6570 6c61 6365  th, name.replace
+000101f0: 2866 227b 776b 5f6e 616d 657d 2e22 2c20  (f"{wk_name}.", 
+00010200: 2222 292c 2076 6572 626f 7365 2c20 6973  ""), verbose, is
+00010210: 5f72 6177 2c20 7265 736f 7572 6365 3d72  _raw, resource=r
+00010220: 6573 6f75 7263 650a 2020 2020 2020 2020  esource.        
+00010230: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010240: 2020 2020 2020 6966 2066 696c 653a 0a20        if file:. 
+00010250: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010260: 6574 7572 6e20 6669 6c65 2c20 5f72 6573  eturn file, _res
+00010270: 6f75 7263 650a 0a20 2020 2069 6620 6e6f  ource..    if no
+00010280: 7420 6973 5f72 6177 3a0a 2020 2020 2020  t is_raw:.      
+00010290: 2020 662c 2072 6177 203d 2066 696e 645f    f, raw = find_
+000102a0: 6669 6c65 5f62 795f 6e61 6d65 280a 2020  file_by_name(.  
+000102b0: 2020 2020 2020 2020 2020 666f 6c64 6572            folder
+000102c0: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
+000102d0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+000102e0: 7665 7262 6f73 653d 7665 7262 6f73 652c  verbose=verbose,
+000102f0: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
+00010300: 7261 773d 5472 7565 2c0a 2020 2020 2020  raw=True,.      
+00010310: 2020 2020 2020 776f 726b 7370 6163 655f        workspace_
+00010320: 6c69 625f 7061 7468 733d 776f 726b 7370  lib_paths=worksp
+00010330: 6163 655f 6c69 625f 7061 7468 732c 0a20  ace_lib_paths,. 
+00010340: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+00010350: 7263 653d 7265 736f 7572 6365 2c0a 2020  rce=resource,.  
+00010360: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010370: 7265 7475 726e 2066 2c20 7261 770a 0a20  return f, raw.. 
+00010380: 2020 2023 206d 6174 6572 6961 6c69 7a65     # materialize
+00010390: 6420 6e6f 6465 2077 6974 6820 4441 5441  d node with DATA
+000103a0: 534f 5552 4345 2064 6566 696e 6974 696f  SOURCE definitio
+000103b0: 6e0a 2020 2020 6966 2072 6573 6f75 7263  n.    if resourc
+000103c0: 6520 616e 6420 226e 6f64 6573 2220 696e  e and "nodes" in
+000103d0: 2072 6573 6f75 7263 653a 0a20 2020 2020   resource:.     
+000103e0: 2020 2066 6f72 206e 6f64 6520 696e 2072     for node in r
+000103f0: 6573 6f75 7263 655b 226e 6f64 6573 225d  esource["nodes"]
+00010400: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00010410: 7261 6d73 203d 206e 6f64 652e 6765 7428  rams = node.get(
+00010420: 2270 6172 616d 7322 2c20 7b7d 290a 2020  "params", {}).  
+00010430: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+00010440: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00010450: 6172 616d 732e 6765 7428 2274 7970 6522  arams.get("type"
+00010460: 2c20 4e6f 6e65 2920 3d3d 2022 6d61 7465  , None) == "mate
+00010470: 7269 616c 697a 6564 220a 2020 2020 2020  rialized".      
+00010480: 2020 2020 2020 2020 2020 616e 6420 7061            and pa
+00010490: 7261 6d73 2e67 6574 2822 656e 6769 6e65  rams.get("engine
+000104a0: 222c 204e 6f6e 6529 0a20 2020 2020 2020  ", None).       
+000104b0: 2020 2020 2020 2020 2061 6e64 2070 6172           and par
+000104c0: 616d 732e 6765 7428 2264 6174 6173 6f75  ams.get("datasou
+000104d0: 7263 6522 2c20 4e6f 6e65 290a 2020 2020  rce", None).    
+000104e0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+000104f0: 2020 2020 2020 2020 2020 2070 6970 6520             pipe 
+00010500: 3d20 7265 736f 7572 6365 5b22 7265 736f  = resource["reso
+00010510: 7572 6365 5f6e 616d 6522 5d20 2b20 222e  urce_name"] + ".
+00010520: 7069 7065 220a 2020 2020 2020 2020 2020  pipe".          
+00010530: 2020 2020 2020 7069 7065 5f66 696c 655f        pipe_file_
+00010540: 6578 6973 7473 203d 2028 0a20 2020 2020  exists = (.     
+00010550: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00010560: 732e 7061 7468 2e69 7366 696c 6528 6f73  s.path.isfile(os
+00010570: 2e70 6174 682e 6a6f 696e 2866 6f6c 6465  .path.join(folde
+00010580: 722c 2070 6970 6529 290a 2020 2020 2020  r, pipe)).      
+00010590: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+000105a0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+000105b0: 6620 2f20 2265 6e64 706f 696e 7473 2220  f / "endpoints" 
+000105c0: 2f20 7069 7065 290a 2020 2020 2020 2020  / pipe).        
+000105d0: 2020 2020 2020 2020 2020 2020 6f72 206f              or o
+000105e0: 732e 7061 7468 2e69 7366 696c 6528 6620  s.path.isfile(f 
+000105f0: 2f20 2270 6970 6573 2220 2f20 7069 7065  / "pipes" / pipe
+00010600: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010610: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010620: 2020 2020 6973 5f74 6172 6765 745f 6461      is_target_da
+00010630: 7461 736f 7572 6365 203d 2070 6172 616d  tasource = param
+00010640: 735b 2264 6174 6173 6f75 7263 6522 5d20  s["datasource"] 
+00010650: 3d3d 206e 616d 650a 2020 2020 2020 2020  == name.        
+00010660: 2020 2020 2020 2020 6966 2070 6970 655f          if pipe_
+00010670: 6669 6c65 5f65 7869 7374 7320 616e 6420  file_exists and 
+00010680: 6973 5f74 6172 6765 745f 6461 7461 736f  is_target_dataso
+00010690: 7572 6365 3a0a 2020 2020 2020 2020 2020  urce:.          
+000106a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000106b0: 2070 6970 652c 207b 2272 6573 6f75 7263   pipe, {"resourc
+000106c0: 655f 6e61 6d65 223a 2070 6172 616d 732e  e_name": params.
+000106d0: 6765 7428 2264 6174 6173 6f75 7263 6522  get("datasource"
+000106e0: 297d 0a0a 2020 2020 6966 2076 6572 626f  )}..    if verbo
+000106f0: 7365 3a0a 2020 2020 2020 2020 636c 6963  se:.        clic
+00010700: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
+00010710: 616e 6167 6572 2e77 6172 6e69 6e67 5f66  anager.warning_f
+00010720: 696c 655f 6e6f 745f 666f 756e 645f 696e  ile_not_found_in
+00010730: 7369 6465 286e 616d 653d 6e61 6d65 2c20  side(name=name, 
+00010740: 666f 6c64 6572 3d66 6f6c 6465 7229 290a  folder=folder)).
+00010750: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
+00010760: 2c20 4e6f 6e65 0a0a 0a64 6566 2064 726f  , None...def dro
+00010770: 705f 746f 6b65 6e28 7572 6c3a 2073 7472  p_token(url: str
+00010780: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
+00010790: 220a 2020 2020 6472 6f70 7320 746f 6b65  ".    drops toke
+000107a0: 6e20 7061 7261 6d20 6672 6f6d 2074 6865  n param from the
+000107b0: 2075 726c 2071 7565 7279 2073 7472 696e   url query strin
+000107c0: 670a 2020 2020 3e3e 3e20 6472 6f70 5f74  g.    >>> drop_t
+000107d0: 6f6b 656e 2827 6874 7470 733a 2f2f 6170  oken('https://ap
+000107e0: 692e 7469 6e79 6269 7264 2e63 6f2f 7630  i.tinybird.co/v0
+000107f0: 2f70 6970 6573 2f61 6161 2e6a 736f 6e3f  /pipes/aaa.json?
+00010800: 746f 6b65 6e3d 6162 6364 2661 3d31 2729  token=abcd&a=1')
+00010810: 0a20 2020 2027 6874 7470 733a 2f2f 6170  .    'https://ap
+00010820: 692e 7469 6e79 6269 7264 2e63 6f2f 7630  i.tinybird.co/v0
+00010830: 2f70 6970 6573 2f61 6161 2e6a 736f 6e3f  /pipes/aaa.json?
+00010840: 613d 3127 0a20 2020 203e 3e3e 2064 726f  a=1'.    >>> dro
+00010850: 705f 746f 6b65 6e28 2768 7474 7073 3a2f  p_token('https:/
+00010860: 2f61 7069 2e74 696e 7962 6972 642e 636f  /api.tinybird.co
+00010870: 2f76 302f 7069 7065 732f 6161 612e 6a73  /v0/pipes/aaa.js
+00010880: 6f6e 3f61 3d31 2729 0a20 2020 2027 6874  on?a=1').    'ht
+00010890: 7470 733a 2f2f 6170 692e 7469 6e79 6269  tps://api.tinybi
+000108a0: 7264 2e63 6f2f 7630 2f70 6970 6573 2f61  rd.co/v0/pipes/a
+000108b0: 6161 2e6a 736f 6e3f 613d 3127 0a20 2020  aa.json?a=1'.   
+000108c0: 2022 2222 0a20 2020 2070 6172 7365 6420   """.    parsed 
+000108d0: 3d20 7572 6c70 6172 7365 2875 726c 290a  = urlparse(url).
+000108e0: 2020 2020 7173 203d 2070 6172 7365 5f71      qs = parse_q
+000108f0: 7328 7061 7273 6564 2e71 7565 7279 290a  s(parsed.query).
+00010900: 2020 2020 7173 5f73 696d 706c 6966 7920      qs_simplify 
+00010910: 3d20 7b6b 3a20 765b 305d 2066 6f72 206b  = {k: v[0] for k
+00010920: 2c20 7620 696e 2071 732e 6974 656d 7328  , v in qs.items(
+00010930: 297d 2020 2320 6368 616e 6765 2073 6576  )}  # change sev
+00010940: 6572 616c 2061 7267 756d 656e 7473 2074  eral arguments t
+00010950: 6f20 7369 6e67 6c65 206f 6e65 0a20 2020  o single one.   
+00010960: 2069 6620 2274 6f6b 656e 2220 696e 2071   if "token" in q
+00010970: 735f 7369 6d70 6c69 6679 3a0a 2020 2020  s_simplify:.    
+00010980: 2020 2020 6465 6c20 7173 5f73 696d 706c      del qs_simpl
+00010990: 6966 795b 2274 6f6b 656e 225d 0a20 2020  ify["token"].   
+000109a0: 2072 6574 7572 6e20 6622 7b70 6172 7365   return f"{parse
+000109b0: 642e 7363 6865 6d65 7d3a 2f2f 7b70 6172  d.scheme}://{par
+000109c0: 7365 642e 6e65 746c 6f63 7d7b 7061 7273  sed.netloc}{pars
+000109d0: 6564 2e70 6174 687d 3f7b 7572 6c65 6e63  ed.path}?{urlenc
+000109e0: 6f64 6528 7173 5f73 696d 706c 6966 7929  ode(qs_simplify)
+000109f0: 7d22 0a0a 0a64 6566 206e 6f72 6d61 6c69  }"...def normali
+00010a00: 7a65 5f61 7272 6179 2869 7465 6d73 3a20  ze_array(items: 
+00010a10: 4c69 7374 5b44 6963 745b 7374 722c 204f  List[Dict[str, O
+00010a20: 7074 696f 6e61 6c5b 416e 795d 5d5d 2920  ptional[Any]]]) 
+00010a30: 2d3e 204c 6973 745b 4469 6374 5d3a 0a20  -> List[Dict]:. 
+00010a40: 2020 2022 2222 0a20 2020 2020 2020 2053     """.        S
+00010a50: 6f72 7465 6428 2920 646f 6573 6e27 7420  orted() doesn't 
+00010a60: 6e6f 7420 7375 7070 6f72 7420 7661 6c75  not support valu
+00010a70: 6573 2077 6974 6820 6469 6666 6572 656e  es with differen
+00010a80: 7420 7479 7065 7320 666f 7220 7468 6520  t types for the 
+00010a90: 7361 6d65 2063 6f6c 756d 6e20 6c69 6b65  same column like
+00010aa0: 204e 6f6e 6520 7673 2073 7472 2e0a 2020   None vs str..  
+00010ab0: 2020 2020 2020 536f 2c20 7765 206e 6565        So, we nee
+00010ac0: 6420 746f 2063 6173 7420 616c 6c20 4e6f  d to cast all No
+00010ad0: 6e65 2074 6f20 6465 6661 756c 7420 7661  ne to default va
+00010ae0: 6c75 6520 6f66 2074 6865 2074 7970 6520  lue of the type 
+00010af0: 6f66 2074 6865 2063 6f6c 756d 6e20 6966  of the column if
+00010b00: 2065 7869 7374 2061 6e64 2069 6620 616c   exist and if al
+00010b10: 6c20 7468 6520 7661 6c75 6573 2061 7265  l the values are
+00010b20: 204e 6f6e 652c 2077 6520 6361 6e20 6c65   None, we can le
+00010b30: 6176 6520 7468 656d 2061 7320 4e6f 6e65  ave them as None
+00010b40: 0a20 2020 203e 3e3e 206e 6f72 6d61 6c69  .    >>> normali
+00010b50: 7a65 5f61 7272 6179 285b 7b27 7827 3a20  ze_array([{'x': 
+00010b60: 2768 656c 6c6f 2057 6f72 6c64 277d 2c20  'hello World'}, 
+00010b70: 7b27 7827 3a20 4e6f 6e65 7d5d 290a 2020  {'x': None}]).  
+00010b80: 2020 5b7b 2778 273a 2027 6865 6c6c 6f20    [{'x': 'hello 
+00010b90: 576f 726c 6427 7d2c 207b 2778 273a 2027  World'}, {'x': '
+00010ba0: 277d 5d0a 2020 2020 3e3e 3e20 6e6f 726d  '}].    >>> norm
+00010bb0: 616c 697a 655f 6172 7261 7928 5b7b 2778  alize_array([{'x
+00010bc0: 273a 2033 7d2c 207b 2778 273a 204e 6f6e  ': 3}, {'x': Non
+00010bd0: 657d 5d29 0a20 2020 205b 7b27 7827 3a20  e}]).    [{'x': 
+00010be0: 337d 2c20 7b27 7827 3a20 307d 5d0a 2020  3}, {'x': 0}].  
+00010bf0: 2020 3e3e 3e20 6e6f 726d 616c 697a 655f    >>> normalize_
+00010c00: 6172 7261 7928 5b7b 2778 273a 207b 2779  array([{'x': {'y
+00010c10: 273a 205b 312c 322c 332c 345d 7d7d 2c20  ': [1,2,3,4]}}, 
+00010c20: 7b27 7827 3a20 7b27 7a27 3a20 2248 656c  {'x': {'z': "Hel
+00010c30: 6c6f 2220 7d7d 5d29 0a20 2020 205b 7b27  lo" }}]).    [{'
+00010c40: 7827 3a20 7b27 7927 3a20 5b31 2c20 322c  x': {'y': [1, 2,
+00010c50: 2033 2c20 345d 7d7d 2c20 7b27 7827 3a20   3, 4]}}, {'x': 
+00010c60: 7b27 7a27 3a20 2748 656c 6c6f 277d 7d5d  {'z': 'Hello'}}]
+00010c70: 0a20 2020 2022 2222 0a20 2020 2074 7970  .    """.    typ
+00010c80: 6573 3a20 4469 6374 5b73 7472 2c20 7479  es: Dict[str, ty
+00010c90: 7065 5d20 3d20 7b7d 0a20 2020 2069 6620  pe] = {}.    if 
+00010ca0: 6c65 6e28 6974 656d 7329 203d 3d20 303a  len(items) == 0:
+00010cb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010cc0: 6974 656d 730a 0a20 2020 2063 6f6c 756d  items..    colum
+00010cd0: 6e73 203d 2069 7465 6d73 5b30 5d2e 6b65  ns = items[0].ke
+00010ce0: 7973 2829 0a20 2020 2066 6f72 2063 6f6c  ys().    for col
+00010cf0: 756d 6e20 696e 2063 6f6c 756d 6e73 3a0a  umn in columns:.
+00010d00: 2020 2020 2020 2020 666f 7220 6f62 6a65          for obje
+00010d10: 6374 2069 6e20 6974 656d 733a 0a20 2020  ct in items:.   
+00010d20: 2020 2020 2020 2020 2069 6620 6f62 6a65           if obje
+00010d30: 6374 5b63 6f6c 756d 6e5d 2069 7320 6e6f  ct[column] is no
+00010d40: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00010d50: 2020 2020 2020 2020 7479 7065 735b 636f          types[co
+00010d60: 6c75 6d6e 5d20 3d20 7479 7065 286f 626a  lumn] = type(obj
+00010d70: 6563 745b 636f 6c75 6d6e 5d29 0a20 2020  ect[column]).   
+00010d80: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00010d90: 616b 0a0a 2020 2020 666f 7220 6f62 6a65  ak..    for obje
+00010da0: 6374 2069 6e20 6974 656d 733a 0a20 2020  ct in items:.   
+00010db0: 2020 2020 2066 6f72 2063 6f6c 756d 6e20       for column 
+00010dc0: 696e 2063 6f6c 756d 6e73 3a0a 2020 2020  in columns:.    
+00010dd0: 2020 2020 2020 2020 6966 206f 626a 6563          if objec
+00010de0: 745b 636f 6c75 6d6e 5d20 6973 206e 6f74  t[column] is not
+00010df0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00010e00: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00010e10: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00010e20: 6620 4e6f 6e65 2c20 7765 2072 6570 6c61  f None, we repla
+00010e30: 6365 2069 7420 666f 7220 7468 6520 6465  ce it for the de
+00010e40: 6661 756c 7420 7661 6c75 650a 2020 2020  fault value.    
+00010e50: 2020 2020 2020 2020 6966 2074 7970 6573          if types
+00010e60: 2e67 6574 2863 6f6c 756d 6e2c 204e 6f6e  .get(column, Non
+00010e70: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00010e80: 2020 2020 6f62 6a65 6374 5b63 6f6c 756d      object[colum
+00010e90: 6e5d 203d 2074 7970 6573 5b63 6f6c 756d  n] = types[colum
+00010ea0: 6e5d 2829 0a0a 2020 2020 7265 7475 726e  n]()..    return
+00010eb0: 2069 7465 6d73 0a0a 0a63 6c61 7373 2050   items...class P
+00010ec0: 6970 6543 6865 636b 6572 2875 6e69 7474  ipeChecker(unitt
+00010ed0: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+00010ee0: 2020 2052 4554 5249 4553 5f4c 494d 4954     RETRIES_LIMIT
+00010ef0: 203d 2050 4950 455f 4348 4543 4b45 525f   = PIPE_CHECKER_
+00010f00: 5245 5452 4945 530a 0a20 2020 2063 7572  RETRIES..    cur
+00010f10: 7265 6e74 5f72 6573 706f 6e73 655f 7469  rent_response_ti
+00010f20: 6d65 3a20 666c 6f61 7420 3d20 300a 2020  me: float = 0.  
+00010f30: 2020 6368 6563 6b65 725f 7265 7370 6f6e    checker_respon
+00010f40: 7365 5f74 696d 653a 2066 6c6f 6174 203d  se_time: float =
+00010f50: 2030 0a0a 2020 2020 6375 7272 656e 745f   0..    current_
+00010f60: 7265 6164 5f62 7974 6573 3a20 696e 7420  read_bytes: int 
+00010f70: 3d20 300a 2020 2020 6368 6563 6b65 725f  = 0.    checker_
+00010f80: 7265 6164 5f62 7974 6573 3a20 696e 7420  read_bytes: int 
+00010f90: 3d20 300a 0a20 2020 2064 6566 205f 5f69  = 0..    def __i
+00010fa0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00010fb0: 656c 662c 0a20 2020 2020 2020 2072 6571  elf,.        req
+00010fc0: 7565 7374 3a20 4469 6374 5b73 7472 2c20  uest: Dict[str, 
+00010fd0: 416e 795d 2c0a 2020 2020 2020 2020 7069  Any],.        pi
+00010fe0: 7065 5f6e 616d 653a 2073 7472 2c0a 2020  pe_name: str,.  
+00010ff0: 2020 2020 2020 6368 6563 6b65 725f 7069        checker_pi
+00011000: 7065 5f6e 616d 653a 2073 7472 2c0a 2020  pe_name: str,.  
+00011010: 2020 2020 2020 746f 6b65 6e3a 2073 7472        token: str
+00011020: 2c0a 2020 2020 2020 2020 6f6e 6c79 5f72  ,.        only_r
+00011030: 6573 706f 6e73 655f 7469 6d65 733a 2062  esponse_times: b
+00011040: 6f6f 6c2c 0a20 2020 2020 2020 2069 676e  ool,.        ign
+00011050: 6f72 655f 6f72 6465 723a 2062 6f6f 6c2c  ore_order: bool,
+00011060: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
+00011070: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
+00011080: 733a 2062 6f6f 6c2c 0a20 2020 2020 2020  s: bool,.       
+00011090: 202a 6172 6773 2c0a 2020 2020 2020 2020   *args,.        
+000110a0: 2a2a 6b77 6172 6773 2c0a 2020 2020 2920  **kwargs,.    ) 
+000110b0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+000110c0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+000110d0: 5f28 2a61 7267 732c 202a 2a6b 7761 7267  _(*args, **kwarg
+000110e0: 7329 0a20 2020 2020 2020 2069 6620 7265  s).        if re
+000110f0: 7175 6573 742e 6765 7428 2268 7474 705f  quest.get("http_
+00011100: 6d65 7468 6f64 2229 203d 3d20 2250 4f53  method") == "POS
+00011110: 5422 3a0a 2020 2020 2020 2020 2020 2020  T":.            
+00011120: 7365 6c66 2e68 7474 705f 6d65 7468 6f64  self.http_method
+00011130: 203d 2022 504f 5354 220a 2020 2020 2020   = "POST".      
+00011140: 2020 2020 2020 7365 6c66 2e63 7572 7265        self.curre
+00011150: 6e74 5f70 6970 655f 7572 6c2c 2073 656c  nt_pipe_url, sel
+00011160: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
+00011170: 6172 616d 7320 3d20 7365 6c66 2e5f 7072  arams = self._pr
+00011180: 6570 6172 655f 6375 7272 656e 745f 7069  epare_current_pi
+00011190: 7065 5f66 6f72 5f70 6f73 745f 7265 7175  pe_for_post_requ
+000111a0: 6573 7428 7265 7175 6573 7429 0a20 2020  est(request).   
+000111b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000111c0: 2020 2020 2020 2073 656c 662e 6874 7470         self.http
+000111d0: 5f6d 6574 686f 6420 3d20 2247 4554 220a  _method = "GET".
+000111e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000111f0: 2e63 7572 7265 6e74 5f70 6970 655f 7572  .current_pipe_ur
+00011200: 6c2c 2073 656c 662e 7069 7065 5f72 6571  l, self.pipe_req
+00011210: 7565 7374 5f70 6172 616d 7320 3d20 7365  uest_params = se
+00011220: 6c66 2e5f 7072 6570 6172 655f 6375 7272  lf._prepare_curr
+00011230: 656e 745f 7069 7065 5f75 726c 5f66 6f72  ent_pipe_url_for
+00011240: 5f67 6574 5f72 6571 7565 7374 2872 6571  _get_request(req
+00011250: 7565 7374 290a 0a20 2020 2020 2020 2073  uest)..        s
+00011260: 656c 662e 5f70 726f 6365 7373 5f70 6172  elf._process_par
+00011270: 616d 7328 290a 2020 2020 2020 2020 7365  ams().        se
+00011280: 6c66 2e63 6865 636b 6572 5f70 6970 655f  lf.checker_pipe_
+00011290: 6e61 6d65 203d 2063 6865 636b 6572 5f70  name = checker_p
+000112a0: 6970 655f 6e61 6d65 0a20 2020 2020 2020  ipe_name.       
+000112b0: 2073 656c 662e 7069 7065 5f6e 616d 6520   self.pipe_name 
+000112c0: 3d20 7069 7065 5f6e 616d 650a 2020 2020  = pipe_name.    
+000112d0: 2020 2020 7365 6c66 2e74 6f6b 656e 203d      self.token =
+000112e0: 2074 6f6b 656e 0a20 2020 2020 2020 2073   token.        s
+000112f0: 656c 662e 6f6e 6c79 5f72 6573 706f 6e73  elf.only_respons
+00011300: 655f 7469 6d65 7320 3d20 6f6e 6c79 5f72  e_times = only_r
+00011310: 6573 706f 6e73 655f 7469 6d65 730a 2020  esponse_times.  
+00011320: 2020 2020 2020 7365 6c66 2e69 676e 6f72        self.ignor
+00011330: 655f 6f72 6465 7220 3d20 6967 6e6f 7265  e_order = ignore
+00011340: 5f6f 7264 6572 0a20 2020 2020 2020 2073  _order.        s
+00011350: 656c 662e 7661 6c69 6461 7465 5f70 726f  elf.validate_pro
+00011360: 6365 7373 6564 5f62 7974 6573 203d 2076  cessed_bytes = v
+00011370: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
+00011380: 645f 6279 7465 730a 0a20 2020 2020 2020  d_bytes..       
+00011390: 2070 6172 7365 6420 3d20 7572 6c70 6172   parsed = urlpar
+000113a0: 7365 2873 656c 662e 6375 7272 656e 745f  se(self.current_
+000113b0: 7069 7065 5f75 726c 290a 2020 2020 2020  pipe_url).      
+000113c0: 2020 7365 6c66 2e63 6865 636b 6572 5f70    self.checker_p
+000113d0: 6970 655f 7572 6c20 3d20 6622 7b70 6172  ipe_url = f"{par
+000113e0: 7365 642e 7363 6865 6d65 7d3a 2f2f 7b70  sed.scheme}://{p
+000113f0: 6172 7365 642e 6e65 746c 6f63 7d2f 7630  arsed.netloc}/v0
+00011400: 2f70 6970 6573 2f7b 7365 6c66 2e63 6865  /pipes/{self.che
+00011410: 636b 6572 5f70 6970 655f 6e61 6d65 7d2e  cker_pipe_name}.
+00011420: 6a73 6f6e 220a 2020 2020 2020 2020 7365  json".        se
+00011430: 6c66 2e63 6865 636b 6572 5f70 6970 655f  lf.checker_pipe_
+00011440: 7572 6c20 2b3d 2066 223f 7b70 6172 7365  url += f"?{parse
+00011450: 642e 7175 6572 797d 2220 6966 2070 6172  d.query}" if par
+00011460: 7365 642e 7175 6572 7920 6973 206e 6f74  sed.query is not
+00011470: 204e 6f6e 6520 616e 6420 7061 7273 6564   None and parsed
+00011480: 2e71 7565 7279 2021 3d20 2222 2065 6c73  .query != "" els
+00011490: 6520 2222 0a0a 2020 2020 6465 6620 5f70  e ""..    def _p
+000114a0: 726f 6365 7373 5f70 6172 616d 7328 7365  rocess_params(se
+000114b0: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
+000114c0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+000114d0: 7365 6c66 2e70 6970 655f 7265 7175 6573  self.pipe_reques
+000114e0: 745f 7061 7261 6d73 2e6b 6579 7328 293a  t_params.keys():
+000114f0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00011500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011510: 2020 7365 6c66 2e70 6970 655f 7265 7175    self.pipe_requ
+00011520: 6573 745f 7061 7261 6d73 5b6b 6579 5d20  est_params[key] 
+00011530: 3d20 6a73 6f6e 2e6c 6f61 6473 2873 656c  = json.loads(sel
+00011540: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
+00011550: 6172 616d 735b 6b65 795d 290a 2020 2020  arams[key]).    
+00011560: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00011570: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00011580: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+00011590: 2020 2020 6465 6620 5f70 7265 7061 7265      def _prepare
+000115a0: 5f63 7572 7265 6e74 5f70 6970 655f 7572  _current_pipe_ur
+000115b0: 6c5f 666f 725f 6765 745f 7265 7175 6573  l_for_get_reques
+000115c0: 7428 7365 6c66 2c20 7265 7175 6573 7429  t(self, request)
+000115d0: 202d 3e20 5475 706c 655b 7374 722c 2044   -> Tuple[str, D
+000115e0: 6963 745b 7374 722c 2073 7472 5d5d 3a0a  ict[str, str]]:.
+000115f0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00011600: 7069 7065 5f75 726c 203d 2072 6571 7565  pipe_url = reque
+00011610: 7374 2e67 6574 2822 656e 6470 6f69 6e74  st.get("endpoint
+00011620: 5f75 726c 222c 2022 2229 0a20 2020 2020  _url", "").     
+00011630: 2020 2063 7572 7265 6e74 5f70 6970 655f     current_pipe_
+00011640: 7572 6c20 3d20 280a 2020 2020 2020 2020  url = (.        
+00011650: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
+00011660: 5f75 726c 2e72 6570 6c61 6365 2822 2e6e  _url.replace(".n
+00011670: 646a 736f 6e22 2c20 222e 6a73 6f6e 2229  djson", ".json")
+00011680: 2e72 6570 6c61 6365 2822 2e63 7376 222c  .replace(".csv",
+00011690: 2022 2e6a 736f 6e22 292e 7265 706c 6163   ".json").replac
+000116a0: 6528 222e 7061 7271 7565 7422 2c20 222e  e(".parquet", ".
+000116b0: 6a73 6f6e 2229 0a20 2020 2020 2020 2029  json").        )
+000116c0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
+000116d0: 5f70 6970 655f 7572 6c20 3d20 6472 6f70  _pipe_url = drop
+000116e0: 5f74 6f6b 656e 2863 7572 7265 6e74 5f70  _token(current_p
+000116f0: 6970 655f 7572 6c29 0a20 2020 2020 2020  ipe_url).       
+00011700: 2063 7572 7265 6e74 5f70 6970 655f 7572   current_pipe_ur
+00011710: 6c20 2b3d 2028 2226 2220 6966 2022 3f22  l += ("&" if "?"
+00011720: 2069 6e20 6375 7272 656e 745f 7069 7065   in current_pipe
+00011730: 5f75 726c 2065 6c73 6520 223f 2229 202b  _url else "?") +
+00011740: 2022 7069 7065 5f63 6865 636b 6572 3d74   "pipe_checker=t
+00011750: 7275 6522 0a20 2020 2020 2020 2072 6574  rue".        ret
+00011760: 7572 6e20 6375 7272 656e 745f 7069 7065  urn current_pipe
+00011770: 5f75 726c 2c20 7265 7175 6573 742e 6765  _url, request.ge
+00011780: 7428 2270 6970 655f 7265 7175 6573 745f  t("pipe_request_
+00011790: 7061 7261 6d73 222c 207b 7d29 0a0a 2020  params", {})..  
+000117a0: 2020 6465 6620 5f70 7265 7061 7265 5f63    def _prepare_c
+000117b0: 7572 7265 6e74 5f70 6970 655f 666f 725f  urrent_pipe_for_
+000117c0: 706f 7374 5f72 6571 7565 7374 2873 656c  post_request(sel
+000117d0: 662c 2072 6571 7565 7374 2920 2d3e 2054  f, request) -> T
+000117e0: 7570 6c65 5b73 7472 2c20 4469 6374 5b73  uple[str, Dict[s
+000117f0: 7472 2c20 7374 725d 5d3a 0a20 2020 2020  tr, str]]:.     
+00011800: 2020 2063 7572 7265 6e74 5f70 6970 655f     current_pipe_
+00011810: 7572 6c20 3d20 7265 7175 6573 742e 6765  url = request.ge
+00011820: 7428 2265 6e64 706f 696e 745f 7572 6c22  t("endpoint_url"
+00011830: 2c20 2222 290a 2020 2020 2020 2020 6375  , "").        cu
+00011840: 7272 656e 745f 7069 7065 5f75 726c 203d  rrent_pipe_url =
+00011850: 2028 0a20 2020 2020 2020 2020 2020 2063   (.            c
+00011860: 7572 7265 6e74 5f70 6970 655f 7572 6c2e  urrent_pipe_url.
+00011870: 7265 706c 6163 6528 222e 6e64 6a73 6f6e  replace(".ndjson
+00011880: 222c 2022 2e6a 736f 6e22 292e 7265 706c  ", ".json").repl
+00011890: 6163 6528 222e 6373 7622 2c20 222e 6a73  ace(".csv", ".js
+000118a0: 6f6e 2229 2e72 6570 6c61 6365 2822 2e70  on").replace(".p
+000118b0: 6172 7175 6574 222c 2022 2e6a 736f 6e22  arquet", ".json"
+000118c0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+000118d0: 2020 2020 616c 6c5f 7061 7261 6d65 7465      all_paramete
+000118e0: 7273 203d 2072 6571 7565 7374 2e67 6574  rs = request.get
+000118f0: 2822 7069 7065 5f72 6571 7565 7374 5f70  ("pipe_request_p
+00011900: 6172 616d 7322 290a 2020 2020 2020 2020  arams").        
+00011910: 616c 6c5f 7061 7261 6d65 7465 7273 2e70  all_parameters.p
+00011920: 6f70 2822 746f 6b65 6e22 2c20 4e6f 6e65  op("token", None
+00011930: 290a 2020 2020 2020 2020 616c 6c5f 7061  ).        all_pa
+00011940: 7261 6d65 7465 7273 5b22 7069 7065 5f63  rameters["pipe_c
+00011950: 6865 636b 6572 225d 203d 2022 7472 7565  hecker"] = "true
+00011960: 220a 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00011970: 6e20 6375 7272 656e 745f 7069 7065 5f75  n current_pipe_u
+00011980: 726c 2c20 616c 6c5f 7061 7261 6d65 7465  rl, all_paramete
+00011990: 7273 0a0a 2020 2020 6465 6620 5f5f 7374  rs..    def __st
+000119a0: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
+000119b0: 2020 2070 6f73 745f 7661 6c75 6573 203d     post_values =
+000119c0: 2066 2220 2d20 504f 5354 2042 6f64 793a   f" - POST Body:
+000119d0: 207b 7365 6c66 2e70 6970 655f 7265 7175   {self.pipe_requ
+000119e0: 6573 745f 7061 7261 6d73 7d22 2069 6620  est_params}" if 
+000119f0: 7365 6c66 2e68 7474 705f 6d65 7468 6f64  self.http_method
+00011a00: 203d 3d20 2250 4f53 5422 2065 6c73 6520   == "POST" else 
+00011a10: 2222 0a0a 2020 2020 2020 2020 7265 7475  ""..        retu
+00011a20: 726e 2066 2263 7572 7265 6e74 207b 7365  rn f"current {se
+00011a30: 6c66 2e63 7572 7265 6e74 5f70 6970 655f  lf.current_pipe_
+00011a40: 7572 6c7d 7b70 6f73 745f 7661 6c75 6573  url}{post_values
+00011a50: 7d5c 6e20 2020 206e 6577 207b 7365 6c66  }\n    new {self
+00011a60: 2e63 6865 636b 6572 5f70 6970 655f 7572  .checker_pipe_ur
+00011a70: 6c7d 7b70 6f73 745f 7661 6c75 6573 7d22  l}{post_values}"
+00011a80: 0a0a 2020 2020 6465 6620 6469 6666 2873  ..    def diff(s
+00011a90: 656c 662c 2061 3a20 4469 6374 5b73 7472  elf, a: Dict[str
+00011aa0: 2c20 416e 795d 2c20 623a 2044 6963 745b  , Any], b: Dict[
+00011ab0: 7374 722c 2041 6e79 5d29 202d 3e20 7374  str, Any]) -> st
+00011ac0: 723a 0a20 2020 2020 2020 2061 5f70 726f  r:.        a_pro
+00011ad0: 7065 7274 6965 7320 3d20 6c69 7374 286d  perties = list(m
+00011ae0: 6170 286c 616d 6264 6120 783a 2066 227b  ap(lambda x: f"{
+00011af0: 787d 3a7b 615b 785d 7d5c 6e22 2c20 612e  x}:{a[x]}\n", a.
+00011b00: 6b65 7973 2829 2929 0a20 2020 2020 2020  keys())).       
+00011b10: 2062 5f70 726f 7065 7274 6965 7320 3d20   b_properties = 
+00011b20: 6c69 7374 286d 6170 286c 616d 6264 6120  list(map(lambda 
+00011b30: 783a 2066 227b 787d 3a7b 625b 785d 7d5c  x: f"{x}:{b[x]}\
+00011b40: 6e22 2c20 622e 6b65 7973 2829 2929 0a0a  n", b.keys()))..
+00011b50: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00011b60: 222e 6a6f 696e 2864 6966 666c 6962 2e63  ".join(difflib.c
+00011b70: 6f6e 7465 7874 5f64 6966 6628 615f 7072  ontext_diff(a_pr
+00011b80: 6f70 6572 7469 6573 2c20 625f 7072 6f70  operties, b_prop
+00011b90: 6572 7469 6573 2c20 7365 6c66 2e70 6970  erties, self.pip
+00011ba0: 655f 6e61 6d65 2c20 7365 6c66 2e63 6865  e_name, self.che
+00011bb0: 636b 6572 5f70 6970 655f 6e61 6d65 2929  cker_pipe_name))
+00011bc0: 0a0a 2020 2020 6465 6620 5f64 6f5f 7265  ..    def _do_re
+00011bd0: 7175 6573 745f 746f 5f70 6970 6528 7365  quest_to_pipe(se
+00011be0: 6c66 2c20 7069 7065 5f75 726c 3a20 7374  lf, pipe_url: st
+00011bf0: 7229 202d 3e20 5265 7370 6f6e 7365 3a0a  r) -> Response:.
+00011c00: 2020 2020 2020 2020 6865 6164 6572 7320          headers 
+00011c10: 3d20 7b22 4175 7468 6f72 697a 6174 696f  = {"Authorizatio
+00011c20: 6e22 3a20 6622 4265 6172 6572 207b 7365  n": f"Bearer {se
+00011c30: 6c66 2e74 6f6b 656e 7d22 7d0a 2020 2020  lf.token}"}.    
+00011c40: 2020 2020 6966 2073 656c 662e 6874 7470      if self.http
+00011c50: 5f6d 6574 686f 6420 3d3d 2022 4745 5422  _method == "GET"
+00011c60: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00011c70: 7475 726e 2072 6571 7565 7374 732e 6765  turn requests.ge
+00011c80: 7428 7069 7065 5f75 726c 2c20 6865 6164  t(pipe_url, head
+00011c90: 6572 733d 6865 6164 6572 732c 2076 6572  ers=headers, ver
+00011ca0: 6966 793d 6e6f 7420 6765 7465 6e76 5f62  ify=not getenv_b
+00011cb0: 6f6f 6c28 2254 425f 4449 5341 424c 455f  ool("TB_DISABLE_
+00011cc0: 5353 4c5f 4348 4543 4b53 222c 2046 616c  SSL_CHECKS", Fal
+00011cd0: 7365 2929 0a20 2020 2020 2020 2065 6c73  se)).        els
+00011ce0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00011cf0: 6574 7572 6e20 7265 7175 6573 7473 2e70  eturn requests.p
+00011d00: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
+00011d10: 2020 2020 2070 6970 655f 7572 6c2c 0a20       pipe_url,. 
+00011d20: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00011d30: 6561 6465 7273 3d68 6561 6465 7273 2c0a  eaders=headers,.
+00011d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d50: 7665 7269 6679 3d6e 6f74 2067 6574 656e  verify=not geten
+00011d60: 765f 626f 6f6c 2822 5442 5f44 4953 4142  v_bool("TB_DISAB
+00011d70: 4c45 5f53 534c 5f43 4845 434b 5322 2c20  LE_SSL_CHECKS", 
+00011d80: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+00011d90: 2020 2020 2020 2020 6461 7461 3d73 656c          data=sel
+00011da0: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
+00011db0: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
+00011dc0: 2020 2029 0a0a 2020 2020 6465 6620 5f77     )..    def _w
+00011dd0: 7269 7465 5f70 6572 666f 726d 616e 6365  rite_performance
+00011de0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00011df0: 7265 7475 726e 2022 220a 0a20 2020 2064  return ""..    d
+00011e00: 6566 205f 7275 6e54 6573 7428 7365 6c66  ef _runTest(self
+00011e10: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00011e20: 2020 2063 7572 7265 6e74 5f72 203d 2073     current_r = s
+00011e30: 656c 662e 5f64 6f5f 7265 7175 6573 745f  elf._do_request_
+00011e40: 746f 5f70 6970 6528 7365 6c66 2e63 7572  to_pipe(self.cur
+00011e50: 7265 6e74 5f70 6970 655f 7572 6c29 0a20  rent_pipe_url). 
+00011e60: 2020 2020 2020 2063 6865 636b 6572 5f72         checker_r
+00011e70: 203d 2073 656c 662e 5f64 6f5f 7265 7175   = self._do_requ
+00011e80: 6573 745f 746f 5f70 6970 6528 7365 6c66  est_to_pipe(self
+00011e90: 2e63 6865 636b 6572 5f70 6970 655f 7572  .checker_pipe_ur
+00011ea0: 6c29 0a0a 2020 2020 2020 2020 7472 793a  l)..        try:
+00011eb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011ec0: 662e 6375 7272 656e 745f 7265 7370 6f6e  f.current_respon
+00011ed0: 7365 5f74 696d 6520 3d20 6375 7272 656e  se_time = curren
+00011ee0: 745f 722e 656c 6170 7365 642e 746f 7461  t_r.elapsed.tota
+00011ef0: 6c5f 7365 636f 6e64 7328 290a 2020 2020  l_seconds().    
+00011f00: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
+00011f10: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
+00011f20: 6d65 203d 2063 6865 636b 6572 5f72 2e65  me = checker_r.e
+00011f30: 6c61 7073 6564 2e74 6f74 616c 5f73 6563  lapsed.total_sec
+00011f40: 6f6e 6473 2829 0a20 2020 2020 2020 2065  onds().        e
+00011f50: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00011f60: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00011f70: 730a 0a20 2020 2020 2020 2063 7572 7265  s..        curre
+00011f80: 6e74 5f72 6573 706f 6e73 653a 2044 6963  nt_response: Dic
+00011f90: 745b 7374 722c 2041 6e79 5d20 3d20 6375  t[str, Any] = cu
+00011fa0: 7272 656e 745f 722e 6a73 6f6e 2829 0a20  rrent_r.json(). 
+00011fb0: 2020 2020 2020 2063 6865 636b 6572 5f72         checker_r
+00011fc0: 6573 706f 6e73 653a 2044 6963 745b 7374  esponse: Dict[st
+00011fd0: 722c 2041 6e79 5d20 3d20 6368 6563 6b65  r, Any] = checke
+00011fe0: 725f 722e 6a73 6f6e 2829 0a0a 2020 2020  r_r.json()..    
+00011ff0: 2020 2020 6375 7272 656e 745f 6461 7461      current_data
+00012000: 3a20 4c69 7374 5b44 6963 745b 7374 722c  : List[Dict[str,
+00012010: 2041 6e79 5d5d 203d 2063 7572 7265 6e74   Any]] = current
+00012020: 5f72 6573 706f 6e73 652e 6765 7428 2264  _response.get("d
+00012030: 6174 6122 2c20 5b5d 290a 2020 2020 2020  ata", []).      
+00012040: 2020 6368 6563 6b65 725f 6461 7461 3a20    checker_data: 
+00012050: 4c69 7374 5b44 6963 745b 7374 722c 2041  List[Dict[str, A
+00012060: 6e79 5d5d 203d 2063 6865 636b 6572 5f72  ny]] = checker_r
+00012070: 6573 706f 6e73 652e 6765 7428 2264 6174  esponse.get("dat
+00012080: 6122 2c20 5b5d 290a 0a20 2020 2020 2020  a", [])..       
+00012090: 2073 656c 662e 6375 7272 656e 745f 7265   self.current_re
+000120a0: 6164 5f62 7974 6573 203d 2063 7572 7265  ad_bytes = curre
+000120b0: 6e74 5f72 6573 706f 6e73 652e 6765 7428  nt_response.get(
+000120c0: 2273 7461 7469 7374 6963 7322 2c20 7b7d  "statistics", {}
+000120d0: 292e 6765 7428 2262 7974 6573 5f72 6561  ).get("bytes_rea
+000120e0: 6422 2c20 3029 0a20 2020 2020 2020 2073  d", 0).        s
+000120f0: 656c 662e 6368 6563 6b65 725f 7265 6164  elf.checker_read
+00012100: 5f62 7974 6573 203d 2063 6865 636b 6572  _bytes = checker
+00012110: 5f72 6573 706f 6e73 652e 6765 7428 2273  _response.get("s
+00012120: 7461 7469 7374 6963 7322 2c20 7b7d 292e  tatistics", {}).
+00012130: 6765 7428 2262 7974 6573 5f72 6561 6422  get("bytes_read"
+00012140: 2c20 3029 0a0a 2020 2020 2020 2020 6572  , 0)..        er
+00012150: 726f 725f 6368 6563 6b5f 6669 7874 7572  ror_check_fixtur
+00012160: 6573 5f64 6174 613a 204f 7074 696f 6e61  es_data: Optiona
+00012170: 6c5b 7374 725d 203d 2063 6865 636b 6572  l[str] = checker
+00012180: 5f72 6573 706f 6e73 652e 6765 7428 2265  _response.get("e
+00012190: 7272 6f72 222c 204e 6f6e 6529 0a20 2020  rror", None).   
+000121a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000121b0: 4973 4e6f 6e65 280a 2020 2020 2020 2020  IsNone(.        
+000121c0: 2020 2020 6572 726f 725f 6368 6563 6b5f      error_check_
+000121d0: 6669 7874 7572 6573 5f64 6174 612c 0a20  fixtures_data,. 
+000121e0: 2020 2020 2020 2020 2020 2022 596f 7520             "You 
+000121f0: 6172 6520 7472 7969 6e67 2074 6f20 7075  are trying to pu
+00012200: 7368 2061 2070 6970 6520 7769 7468 2065  sh a pipe with e
+00012210: 7272 6f72 732c 2070 6c65 6173 6520 6368  rrors, please ch
+00012220: 6563 6b20 7468 6520 6f75 7470 7574 206f  eck the output o
+00012230: 7220 7275 6e20 7769 7468 202d 2d6e 6f2d  r run with --no-
+00012240: 6368 6563 6b22 2c0a 2020 2020 2020 2020  check",.        
+00012250: 290a 0a20 2020 2020 2020 2069 6e63 7265  )..        incre
+00012260: 6173 655f 7265 7370 6f6e 7365 5f74 696d  ase_response_tim
+00012270: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
+00012280: 2020 6368 6563 6b65 725f 722e 656c 6170    checker_r.elap
+00012290: 7365 642e 746f 7461 6c5f 7365 636f 6e64  sed.total_second
+000122a0: 7328 2920 2d20 6375 7272 656e 745f 722e  s() - current_r.
+000122b0: 656c 6170 7365 642e 746f 7461 6c5f 7365  elapsed.total_se
+000122c0: 636f 6e64 7328 290a 2020 2020 2020 2020  conds().        
+000122d0: 2920 2f20 6375 7272 656e 745f 722e 656c  ) / current_r.el
+000122e0: 6170 7365 642e 746f 7461 6c5f 7365 636f  apsed.total_seco
+000122f0: 6e64 7328 290a 2020 2020 2020 2020 6966  nds().        if
+00012300: 2073 656c 662e 6f6e 6c79 5f72 6573 706f   self.only_respo
+00012310: 6e73 655f 7469 6d65 733a 0a20 2020 2020  nse_times:.     
+00012320: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012330: 7274 4c65 7373 280a 2020 2020 2020 2020  rtLess(.        
+00012340: 2020 2020 2020 2020 696e 6372 6561 7365          increase
+00012350: 5f72 6573 706f 6e73 655f 7469 6d65 2c20  _response_time, 
+00012360: 302e 3235 2c20 6d73 673d 6622 7265 7370  0.25, msg=f"resp
+00012370: 6f6e 7365 2074 696d 6520 6861 7320 696e  onse time has in
+00012380: 6372 6561 7365 6420 7b72 6f75 6e64 2869  creased {round(i
+00012390: 6e63 7265 6173 655f 7265 7370 6f6e 7365  ncrease_response
+000123a0: 5f74 696d 6520 2a20 3130 3029 7d25 220a  _time * 100)}%".
+000123b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000123c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000123d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000123e0: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
+000123f0: 7572 7265 6e74 5f64 6174 6129 2c20 6c65  urrent_data), le
+00012400: 6e28 6368 6563 6b65 725f 6461 7461 292c  n(checker_data),
+00012410: 2022 4e75 6d62 6572 206f 6620 656c 656d   "Number of elem
+00012420: 656e 7473 2064 6f65 7320 6e6f 7420 6d61  ents does not ma
+00012430: 7463 6822 290a 0a20 2020 2020 2020 2069  tch")..        i
+00012440: 6620 7365 6c66 2e76 616c 6964 6174 655f  f self.validate_
+00012450: 7072 6f63 6573 7365 645f 6279 7465 733a  processed_bytes:
+00012460: 0a20 2020 2020 2020 2020 2020 2069 6e63  .            inc
+00012470: 7265 6173 655f 7265 6164 5f62 7974 6573  rease_read_bytes
+00012480: 203d 2028 7365 6c66 2e63 6865 636b 6572   = (self.checker
+00012490: 5f72 6561 645f 6279 7465 7320 2d20 7365  _read_bytes - se
+000124a0: 6c66 2e63 7572 7265 6e74 5f72 6561 645f  lf.current_read_
+000124b0: 6279 7465 7329 202f 2073 656c 662e 6375  bytes) / self.cu
+000124c0: 7272 656e 745f 7265 6164 5f62 7974 6573  rrent_read_bytes
+000124d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000124e0: 662e 6173 7365 7274 4c65 7373 280a 2020  f.assertLess(.  
+000124f0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+00012500: 756e 6428 696e 6372 6561 7365 5f72 6561  und(increase_rea
+00012510: 645f 6279 7465 732c 2032 292c 0a20 2020  d_bytes, 2),.   
+00012520: 2020 2020 2020 2020 2020 2020 2030 2e32               0.2
+00012530: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
+00012540: 2020 206d 7367 3d66 2254 6865 206e 756d     msg=f"The num
+00012550: 6265 7220 6f66 2070 726f 6365 7373 6564  ber of processed
+00012560: 2062 7974 6573 2068 6173 2069 6e63 7265   bytes has incre
+00012570: 6173 6564 207b 726f 756e 6428 696e 6372  ased {round(incr
+00012580: 6561 7365 5f72 6561 645f 6279 7465 7320  ease_read_bytes 
+00012590: 2a20 3130 3029 7d25 222c 0a20 2020 2020  * 100)}%",.     
+000125a0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000125b0: 2020 6966 2073 656c 662e 6967 6e6f 7265    if self.ignore
+000125c0: 5f6f 7264 6572 3a0a 2020 2020 2020 2020  _order:.        
+000125d0: 2020 2020 6375 7272 656e 745f 6461 7461      current_data
+000125e0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000125f0: 2020 2020 2073 6f72 7465 6428 6e6f 726d       sorted(norm
+00012600: 616c 697a 655f 6172 7261 7928 6375 7272  alize_array(curr
+00012610: 656e 745f 6461 7461 292c 206b 6579 3d69  ent_data), key=i
+00012620: 7465 6d67 6574 7465 7228 2a5b 6b20 666f  temgetter(*[k fo
+00012630: 7220 6b20 696e 2063 7572 7265 6e74 5f64  r k in current_d
+00012640: 6174 615b 305d 2e6b 6579 7328 295d 2929  ata[0].keys()]))
+00012650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012660: 2069 6620 6c65 6e28 6375 7272 656e 745f   if len(current_
+00012670: 6461 7461 2920 3e20 300a 2020 2020 2020  data) > 0.      
+00012680: 2020 2020 2020 2020 2020 656c 7365 2063            else c
+00012690: 7572 7265 6e74 5f64 6174 610a 2020 2020  urrent_data.    
+000126a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000126b0: 2020 2020 2020 6368 6563 6b65 725f 6461        checker_da
+000126c0: 7461 203d 2028 0a20 2020 2020 2020 2020  ta = (.         
+000126d0: 2020 2020 2020 2073 6f72 7465 6428 6e6f         sorted(no
+000126e0: 726d 616c 697a 655f 6172 7261 7928 6368  rmalize_array(ch
+000126f0: 6563 6b65 725f 6461 7461 292c 206b 6579  ecker_data), key
+00012700: 3d69 7465 6d67 6574 7465 7228 2a5b 6b20  =itemgetter(*[k 
+00012710: 666f 7220 6b20 696e 2063 6865 636b 6572  for k in checker
+00012720: 5f64 6174 615b 305d 2e6b 6579 7328 295d  _data[0].keys()]
+00012730: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00012740: 2020 2069 6620 6c65 6e28 6368 6563 6b65     if len(checke
+00012750: 725f 6461 7461 2920 3e20 300a 2020 2020  r_data) > 0.    
+00012760: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00012770: 2063 6865 636b 6572 5f64 6174 610a 2020   checker_data.  
+00012780: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00012790: 2020 2020 2066 6f72 205f 2c20 2863 7572       for _, (cur
+000127a0: 7265 6e74 5f64 6174 615f 652c 2063 6865  rent_data_e, che
+000127b0: 636b 5f66 6978 7475 7265 735f 6461 7461  ck_fixtures_data
+000127c0: 5f65 2920 696e 2065 6e75 6d65 7261 7465  _e) in enumerate
+000127d0: 287a 6970 2863 7572 7265 6e74 5f64 6174  (zip(current_dat
+000127e0: 612c 2063 6865 636b 6572 5f64 6174 6129  a, checker_data)
+000127f0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00012800: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012810: 6c69 7374 2863 7572 7265 6e74 5f64 6174  list(current_dat
+00012820: 615f 652e 6b65 7973 2829 292c 206c 6973  a_e.keys()), lis
+00012830: 7428 6368 6563 6b5f 6669 7874 7572 6573  t(check_fixtures
+00012840: 5f64 6174 615f 652e 6b65 7973 2829 2929  _data_e.keys()))
+00012850: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00012860: 2078 2069 6e20 6375 7272 656e 745f 6461   x in current_da
+00012870: 7461 5f65 2e6b 6579 7328 293a 0a20 2020  ta_e.keys():.   
+00012880: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012890: 6973 696e 7374 616e 6365 2863 7572 7265  isinstance(curre
+000128a0: 6e74 5f64 6174 615f 655b 785d 2c20 666c  nt_data_e[x], fl
+000128b0: 6f61 7429 3a0a 2020 2020 2020 2020 2020  oat):.          
+000128c0: 2020 2020 2020 2020 2020 6420 3d20 6162            d = ab
+000128d0: 7328 6375 7272 656e 745f 6461 7461 5f65  s(current_data_e
+000128e0: 5b78 5d20 2d20 6368 6563 6b5f 6669 7874  [x] - check_fixt
+000128f0: 7572 6573 5f64 6174 615f 655b 785d 290a  ures_data_e[x]).
+00012900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012910: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00012920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012930: 2073 656c 662e 6173 7365 7274 4c65 7373   self.assertLess
+00012940: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
+00012950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012960: 2020 2064 202f 2063 7572 7265 6e74 5f64     d / current_d
+00012970: 6174 615f 655b 785d 2c0a 2020 2020 2020  ata_e[x],.      
+00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012990: 2020 2020 2020 302e 3031 2c0a 2020 2020        0.01,.    
+000129a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129b0: 2020 2020 2020 2020 6622 6b65 7920 7b78          f"key {x
+000129c0: 7d2e 206f 6c64 2076 616c 7565 3a20 7b63  }. old value: {c
+000129d0: 7572 7265 6e74 5f64 6174 615f 655b 785d  urrent_data_e[x]
+000129e0: 7d2c 206e 6577 2076 616c 7565 3a20 7b63  }, new value: {c
+000129f0: 6865 636b 5f66 6978 7475 7265 735f 6461  heck_fixtures_da
+00012a00: 7461 5f65 5b78 5d7d 5c6e 7b73 656c 662e  ta_e[x]}\n{self.
+00012a10: 6469 6666 2863 7572 7265 6e74 5f64 6174  diff(current_dat
+00012a20: 615f 652c 2063 6865 636b 5f66 6978 7475  a_e, check_fixtu
+00012a30: 7265 735f 6461 7461 5f65 297d 222c 0a20  res_data_e)}",. 
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012a60: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00012a70: 6570 7420 5a65 726f 4469 7669 7369 6f6e  ept ZeroDivision
+00012a80: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00012a90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012aa0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012ac0: 2020 2020 2020 2020 2020 2020 2064 2c0a               d,.
+00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ae0: 2020 2020 2020 2020 2020 2020 302c 0a20              0,. 
+00012af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b00: 2020 2020 2020 2020 2020 2066 226b 6579             f"key
+00012b10: 207b 787d 2e20 6f6c 6420 7661 6c75 653a   {x}. old value:
+00012b20: 207b 6375 7272 656e 745f 6461 7461 5f65   {current_data_e
+00012b30: 5b78 5d7d 2c20 6e65 7720 7661 6c75 653a  [x]}, new value:
+00012b40: 207b 6368 6563 6b5f 6669 7874 7572 6573   {check_fixtures
+00012b50: 5f64 6174 615f 655b 785d 7d5c 6e7b 7365  _data_e[x]}\n{se
+00012b60: 6c66 2e64 6966 6628 6375 7272 656e 745f  lf.diff(current_
+00012b70: 6461 7461 5f65 2c20 6368 6563 6b5f 6669  data_e, check_fi
+00012b80: 7874 7572 6573 5f64 6174 615f 6529 7d22  xtures_data_e)}"
+00012b90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012ba0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00012bb0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00012bc0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00012bd0: 2020 2020 2020 206e 6f74 2069 7369 6e73         not isins
+00012be0: 7461 6e63 6528 6375 7272 656e 745f 6461  tance(current_da
+00012bf0: 7461 5f65 5b78 5d2c 2028 7374 722c 2062  ta_e[x], (str, b
+00012c00: 7974 6573 2929 0a20 2020 2020 2020 2020  ytes)).         
+00012c10: 2020 2020 2020 2020 2020 2061 6e64 2069             and i
+00012c20: 7369 6e73 7461 6e63 6528 6375 7272 656e  sinstance(curren
+00012c30: 745f 6461 7461 5f65 5b78 5d2c 2049 7465  t_data_e[x], Ite
+00012c40: 7261 626c 6529 0a20 2020 2020 2020 2020  rable).         
+00012c50: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
+00012c60: 656c 662e 6967 6e6f 7265 5f6f 7264 6572  elf.ignore_order
+00012c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c80: 2029 3a0a 0a20 2020 2020 2020 2020 2020   ):..           
+00012c90: 2020 2020 2020 2020 2064 6566 2066 6c61           def fla
+00012ca0: 7474 656e 2869 7465 6d73 293a 0a20 2020  tten(items):.   
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 2020 2020 2022 2222 5969 656c 6420 6974       """Yield it
+00012cd0: 656d 7320 6672 6f6d 2061 6e79 206e 6573  ems from any nes
+00012ce0: 7465 6420 6974 6572 6162 6c65 3b20 7365  ted iterable; se
+00012cf0: 6520 5265 6665 7265 6e63 652e 2222 220a  e Reference.""".
+00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d10: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00012d20: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00012d30: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00012d40: 7820 696e 2069 7465 6d73 3a0a 2020 2020  x in items:.    
+00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d60: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00012d70: 7461 6e63 6528 782c 2049 7465 7261 626c  tance(x, Iterabl
+00012d80: 6529 2061 6e64 206e 6f74 2069 7369 6e73  e) and not isins
+00012d90: 7461 6e63 6528 782c 2028 7374 722c 2062  tance(x, (str, b
+00012da0: 7974 6573 2929 3a0a 2020 2020 2020 2020  ytes)):.        
+00012db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012dc0: 2020 2020 2020 2020 6f75 7470 7574 2e65          output.e
+00012dd0: 7874 656e 6428 666c 6174 7465 6e28 7829  xtend(flatten(x)
+00012de0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012df0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00012e00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00012e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e20: 2020 2020 6f75 7470 7574 2e61 7070 656e      output.appen
+00012e30: 6428 7829 0a20 2020 2020 2020 2020 2020  d(x).           
+00012e40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00012e50: 7572 6e20 6f75 7470 7574 0a0a 2020 2020  urn output..    
+00012e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012e80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012e90: 2020 2020 2020 2020 2020 666c 6174 7465            flatte
+00012ea0: 6e28 6375 7272 656e 745f 6461 7461 5f65  n(current_data_e
+00012eb0: 5b78 5d29 2e73 6f72 7428 292c 0a20 2020  [x]).sort(),.   
+00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ed0: 2020 2020 2066 6c61 7474 656e 2863 6865       flatten(che
+00012ee0: 636b 5f66 6978 7475 7265 735f 6461 7461  ck_fixtures_data
+00012ef0: 5f65 5b78 5d29 2e73 6f72 7428 292c 0a20  _e[x]).sort(),. 
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f10: 2020 2020 2020 2022 5c6e 2220 2b20 7365         "\n" + se
+00012f20: 6c66 2e64 6966 6628 6375 7272 656e 745f  lf.diff(current_
+00012f30: 6461 7461 5f65 2c20 6368 6563 6b5f 6669  data_e, check_fi
+00012f40: 7874 7572 6573 5f64 6174 615f 6529 2c0a  xtures_data_e),.
+00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00012f70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012fa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012fb0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
+00012fc0: 745f 6461 7461 5f65 5b78 5d2c 0a20 2020  t_data_e[x],.   
 00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 7365 6c66 2e61 7373 6572 744c 6573    self.assertLes
-00012ff0: 7345 7175 616c 280a 2020 2020 2020 2020  sEqual(.        
+00012fe0: 2020 2020 2063 6865 636b 5f66 6978 7475       check_fixtu
+00012ff0: 7265 735f 6461 7461 5f65 5b78 5d2c 0a20  res_data_e[x],. 
 00013000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013010: 2020 2020 6420 2f20 6375 7272 656e 745f      d / current_
-00013020: 6461 7461 5f65 5b78 5d2c 0a20 2020 2020  data_e[x],.     
-00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013040: 2020 2020 2020 2030 2e30 312c 0a20 2020         0.01,.   
+00013010: 2020 2020 2020 2022 5c6e 2220 2b20 7365         "\n" + se
+00013020: 6c66 2e64 6966 6628 6375 7272 656e 745f  lf.diff(current_
+00013030: 6461 7461 5f65 2c20 6368 6563 6b5f 6669  data_e, check_fi
+00013040: 7874 7572 6573 5f64 6174 615f 6529 2c0a  xtures_data_e),.
 00013050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013060: 2020 2020 2020 2020 2066 226b 6579 207b           f"key {
-00013070: 787d 2e20 6f6c 6420 7661 6c75 653a 207b  x}. old value: {
-00013080: 6375 7272 656e 745f 6461 7461 5f65 5b78  current_data_e[x
-00013090: 5d7d 2c20 6e65 7720 7661 6c75 653a 207b  ]}, new value: {
-000130a0: 6368 6563 6b5f 6669 7874 7572 6573 5f64  check_fixtures_d
-000130b0: 6174 615f 655b 785d 7d5c 6e7b 7365 6c66  ata_e[x]}\n{self
-000130c0: 2e64 6966 6628 6375 7272 656e 745f 6461  .diff(current_da
-000130d0: 7461 5f65 2c20 6368 6563 6b5f 6669 7874  ta_e, check_fixt
-000130e0: 7572 6573 5f64 6174 615f 6529 7d22 2c0a  ures_data_e)}",.
-000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013100: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00013110: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00013120: 6365 7074 205a 6572 6f44 6976 6973 696f  cept ZeroDivisio
-00013130: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
-00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013150: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013160: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00013170: 2020 2020 2020 2020 2020 2020 2020 642c                d,
-00013180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013190: 2020 2020 2020 2020 2020 2020 2030 2c0a               0,.
-000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131b0: 2020 2020 2020 2020 2020 2020 6622 6b65              f"ke
-000131c0: 7920 7b78 7d2e 206f 6c64 2076 616c 7565  y {x}. old value
-000131d0: 3a20 7b63 7572 7265 6e74 5f64 6174 615f  : {current_data_
-000131e0: 655b 785d 7d2c 206e 6577 2076 616c 7565  e[x]}, new value
-000131f0: 3a20 7b63 6865 636b 5f66 6978 7475 7265  : {check_fixture
-00013200: 735f 6461 7461 5f65 5b78 5d7d 5c6e 7b73  s_data_e[x]}\n{s
-00013210: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
-00013220: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
-00013230: 6978 7475 7265 735f 6461 7461 5f65 297d  ixtures_data_e)}
-00013240: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00013250: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00013260: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00013270: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00013280: 2020 2020 2020 2020 6e6f 7420 6973 696e          not isin
-00013290: 7374 616e 6365 2863 7572 7265 6e74 5f64  stance(current_d
-000132a0: 6174 615f 655b 785d 2c20 2873 7472 2c20  ata_e[x], (str, 
-000132b0: 6279 7465 7329 290a 2020 2020 2020 2020  bytes)).        
-000132c0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-000132d0: 6973 696e 7374 616e 6365 2863 7572 7265  isinstance(curre
-000132e0: 6e74 5f64 6174 615f 655b 785d 2c20 4974  nt_data_e[x], It
-000132f0: 6572 6162 6c65 290a 2020 2020 2020 2020  erable).        
-00013300: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00013310: 7365 6c66 2e69 676e 6f72 655f 6f72 6465  self.ignore_orde
-00013320: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00013330: 2020 293a 0a0a 2020 2020 2020 2020 2020    ):..          
-00013340: 2020 2020 2020 2020 2020 6465 6620 666c            def fl
-00013350: 6174 7465 6e28 6974 656d 7329 3a0a 2020  atten(items):.  
-00013360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013370: 2020 2020 2020 2222 2259 6965 6c64 2069        """Yield i
-00013380: 7465 6d73 2066 726f 6d20 616e 7920 6e65  tems from any ne
-00013390: 7374 6564 2069 7465 7261 626c 653b 2073  sted iterable; s
-000133a0: 6565 2052 6566 6572 656e 6365 2e22 2222  ee Reference."""
-000133b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000133c0: 2020 2020 2020 2020 206f 7574 7075 7420           output 
-000133d0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-000133e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000133f0: 2078 2069 6e20 6974 656d 733a 0a20 2020   x in items:.   
-00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013410: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00013420: 7374 616e 6365 2878 2c20 4974 6572 6162  stance(x, Iterab
-00013430: 6c65 2920 616e 6420 6e6f 7420 6973 696e  le) and not isin
-00013440: 7374 616e 6365 2878 2c20 2873 7472 2c20  stance(x, (str, 
-00013450: 6279 7465 7329 293a 0a20 2020 2020 2020  bytes)):.       
-00013460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013470: 2020 2020 2020 2020 206f 7574 7075 742e           output.
-00013480: 6578 7465 6e64 2866 6c61 7474 656e 2878  extend(flatten(x
-00013490: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000134a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000134b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000134c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134d0: 2020 2020 206f 7574 7075 742e 6170 7065       output.appe
-000134e0: 6e64 2878 290a 2020 2020 2020 2020 2020  nd(x).          
-000134f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013500: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
-00013510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013520: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00013530: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00013540: 2020 2020 2020 2020 2020 2066 6c61 7474             flatt
-00013550: 656e 2863 7572 7265 6e74 5f64 6174 615f  en(current_data_
-00013560: 655b 785d 292e 736f 7274 2829 2c0a 2020  e[x]).sort(),.  
-00013570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013580: 2020 2020 2020 666c 6174 7465 6e28 6368        flatten(ch
-00013590: 6563 6b5f 6669 7874 7572 6573 5f64 6174  eck_fixtures_dat
-000135a0: 615f 655b 785d 292e 736f 7274 2829 2c0a  a_e[x]).sort(),.
-000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135c0: 2020 2020 2020 2020 225c 6e22 202b 2073          "\n" + s
-000135d0: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
-000135e0: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
-000135f0: 6978 7475 7265 735f 6461 7461 5f65 292c  ixtures_data_e),
-00013600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013610: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00013620: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013640: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00013650: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00013660: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00013670: 6e74 5f64 6174 615f 655b 785d 2c0a 2020  nt_data_e[x],.  
-00013680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013690: 2020 2020 2020 6368 6563 6b5f 6669 7874        check_fixt
-000136a0: 7572 6573 5f64 6174 615f 655b 785d 2c0a  ures_data_e[x],.
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136c0: 2020 2020 2020 2020 225c 6e22 202b 2073          "\n" + s
-000136d0: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
-000136e0: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
-000136f0: 6978 7475 7265 735f 6461 7461 5f65 292c  ixtures_data_e),
-00013700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013710: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00013720: 7275 6e54 6573 7428 7365 6c66 2920 2d3e  runTest(self) ->
-00013730: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00013740: 6620 2264 6562 7567 2220 696e 2073 656c  f "debug" in sel
-00013750: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
-00013760: 6172 616d 7320 6f72 2028 0a20 2020 2020  arams or (.     
-00013770: 2020 2020 2020 2022 6672 6f6d 2220 696e         "from" in
-00013780: 2073 656c 662e 7069 7065 5f72 6571 7565   self.pipe_reque
-00013790: 7374 5f70 6172 616d 7320 616e 6420 7365  st_params and se
-000137a0: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
-000137b0: 7061 7261 6d73 5b22 6672 6f6d 225d 203d  params["from"] =
-000137c0: 3d20 2275 6922 0a20 2020 2020 2020 2029  = "ui".        )
-000137d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000137e0: 6c66 2e73 6b69 7054 6573 7428 2266 6f75  lf.skipTest("fou
-000137f0: 6e64 2064 6562 7567 2070 6172 616d 2229  nd debug param")
-00013800: 0a0a 2020 2020 2020 2020 2320 4c65 7427  ..        # Let'
-00013810: 7320 7265 7472 7920 7468 6520 7661 6c69  s retry the vali
-00013820: 6461 7469 6f6e 2074 6f20 6176 6f69 6420  dation to avoid 
-00013830: 6661 6c73 6520 616c 6572 7473 2077 6865  false alerts whe
-00013840: 6e20 6465 616c 696e 6720 7769 7468 2065  n dealing with e
-00013850: 6e64 706f 696e 7473 2074 6861 7420 6861  ndpoints that ha
-00013860: 7665 2063 6f6e 7469 6e75 6f73 2069 6e67  ve continuos ing
-00013870: 6573 7469 6f6e 0a20 2020 2020 2020 2072  estion.        r
-00013880: 6574 7269 6573 203d 2030 0a20 2020 2020  etries = 0.     
-00013890: 2020 2077 6869 6c65 2072 6574 7269 6573     while retries
-000138a0: 203c 2073 656c 662e 5245 5452 4945 535f   < self.RETRIES_
-000138b0: 4c49 4d49 543a 0a20 2020 2020 2020 2020  LIMIT:.         
-000138c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000138d0: 2020 2020 2020 2020 7365 6c66 2e5f 7275          self._ru
-000138e0: 6e54 6573 7428 290a 2020 2020 2020 2020  nTest().        
-000138f0: 2020 2020 6578 6365 7074 2041 7373 6572      except Asser
-00013900: 7469 6f6e 4572 726f 7220 6173 2065 3a0a  tionError as e:.
-00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013920: 7265 7472 6965 7320 2b3d 2031 0a20 2020  retries += 1.   
-00013930: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00013940: 7265 7472 6965 7320 3e3d 2073 656c 662e  retries >= self.
-00013950: 5245 5452 4945 535f 4c49 4d49 543a 0a20  RETRIES_LIMIT:. 
-00013960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013970: 2020 2072 6169 7365 2065 0a20 2020 2020     raise e.     
-00013980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013990: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-000139a0: 616b 0a0a 0a40 6461 7461 636c 6173 730a  ak...@dataclass.
-000139b0: 636c 6173 7320 5069 7065 4368 6563 6b65  class PipeChecke
-000139c0: 7252 756e 6e65 7252 6573 706f 6e73 653a  rRunnerResponse:
-000139d0: 0a20 2020 2070 6970 655f 6e61 6d65 3a20  .    pipe_name: 
-000139e0: 7374 720a 2020 2020 7465 7374 5f74 7970  str.    test_typ
-000139f0: 653a 2073 7472 0a20 2020 206f 7574 7075  e: str.    outpu
-00013a00: 743a 2073 7472 0a20 2020 206d 6574 7269  t: str.    metri
-00013a10: 6373 5f73 756d 6d61 7279 3a20 4f70 7469  cs_summary: Opti
-00013a20: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
-00013a30: 6e79 5d5d 0a20 2020 206d 6574 7269 6373  ny]].    metrics
-00013a40: 5f74 696d 696e 673a 2044 6963 745b 7374  _timing: Dict[st
-00013a50: 722c 2054 7570 6c65 5b66 6c6f 6174 2c20  r, Tuple[float, 
-00013a60: 666c 6f61 742c 2066 6c6f 6174 5d5d 0a20  float, float]]. 
-00013a70: 2020 2066 6169 6c65 643a 204c 6973 745b     failed: List[
-00013a80: 4469 6374 5b73 7472 2c20 7374 725d 5d0a  Dict[str, str]].
-00013a90: 2020 2020 7761 735f 7375 6363 6573 7366      was_successf
-00013aa0: 756c 6c3a 2062 6f6f 6c0a 0a0a 636c 6173  ull: bool...clas
-00013ab0: 7320 5069 7065 4368 6563 6b65 7252 756e  s PipeCheckerRun
-00013ac0: 6e65 723a 0a20 2020 2063 6865 636b 6572  ner:.    checker
-00013ad0: 5f73 7472 6561 6d5f 7265 7375 6c74 5f63  _stream_result_c
-00013ae0: 6c61 7373 203d 2075 6e69 7474 6573 742e  lass = unittest.
-00013af0: 7275 6e6e 6572 2e5f 5772 6974 656c 6e44  runner._WritelnD
-00013b00: 6563 6f72 6174 6f72 2020 2320 7479 7065  ecorator  # type
-00013b10: 3a20 6967 6e6f 7265 0a0a 2020 2020 6465  : ignore..    de
-00013b20: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00013b30: 2070 6970 655f 6e61 6d65 3a20 7374 722c   pipe_name: str,
-00013b40: 2068 6f73 743a 2073 7472 293a 0a20 2020   host: str):.   
-00013b50: 2020 2020 2073 656c 662e 7069 7065 5f6e       self.pipe_n
-00013b60: 616d 6520 3d20 7069 7065 5f6e 616d 650a  ame = pipe_name.
-00013b70: 2020 2020 2020 2020 7365 6c66 2e68 6f73          self.hos
-00013b80: 7420 3d20 686f 7374 0a0a 2020 2020 6465  t = host..    de
-00013b90: 6620 6765 745f 7371 6c73 5f66 6f72 5f72  f get_sqls_for_r
-00013ba0: 6571 7565 7374 735f 746f 5f63 6865 636b  equests_to_check
-00013bb0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00013bc0: 2020 2020 2020 2020 6d61 7463 6865 733a          matches:
-00013bd0: 204c 6973 745b 7374 725d 2c0a 2020 2020   List[str],.    
-00013be0: 2020 2020 7361 6d70 6c65 5f62 795f 7061      sample_by_pa
-00013bf0: 7261 6d73 3a20 696e 742c 0a20 2020 2020  rams: int,.     
-00013c00: 2020 206c 696d 6974 3a20 696e 742c 0a20     limit: int,. 
-00013c10: 2020 2020 2020 2070 6970 655f 7374 6174         pipe_stat
-00013c20: 735f 7274 5f74 6162 6c65 3a20 7374 7220  s_rt_table: str 
-00013c30: 3d20 2222 2c0a 2020 2020 2020 2020 6578  = "",.        ex
-00013c40: 7472 615f 7768 6572 655f 636c 6175 7365  tra_where_clause
-00013c50: 3a20 7374 7220 3d20 2222 2c0a 2020 2020  : str = "",.    
-00013c60: 293a 0a20 2020 2020 2020 2070 6970 655f  ):.        pipe_
-00013c70: 7374 6174 735f 7274 203d 2070 6970 655f  stats_rt = pipe_
-00013c80: 7374 6174 735f 7274 5f74 6162 6c65 206f  stats_rt_table o
-00013c90: 7220 2274 696e 7962 6972 642e 7069 7065  r "tinybird.pipe
-00013ca0: 5f73 7461 7473 5f72 7422 0a20 2020 2020  _stats_rt".     
-00013cb0: 2020 2023 2054 4f44 4f20 6974 206d 6179     # TODO it may
-00013cc0: 206e 6f74 2062 6520 6e65 6564 6564 2074   not be needed t
-00013cd0: 6f20 6578 7472 6163 7420 746f 6b65 6e2c  o extract token,
-00013ce0: 2070 6970 655f 6368 6563 6b65 722c 2066   pipe_checker, f
-00013cf0: 6f72 6d20 6f72 2064 6562 7567 2e20 5468  orm or debug. Th
-00013d00: 6579 206d 6179 2062 6520 7573 6564 2069  ey may be used i
-00013d10: 6e20 6e65 7874 2073 7465 7073 0a20 2020  n next steps.   
-00013d20: 2020 2020 2023 2054 4f44 4f20 6578 7472       # TODO extr
-00013d30: 6163 7455 524c 5061 7261 6d65 7465 7228  actURLParameter(
-00013d40: 6173 7375 6d65 4e6f 744e 756c 6c28 7572  assumeNotNull(ur
-00013d50: 6c29 2c20 2766 726f 6d27 2920 3c3e 2027  l), 'from') <> '
-00013d60: 7569 2720 7368 6f75 6c64 2072 6561 6420  ui' should read 
-00013d70: 6672 6f6d 2072 6571 7565 7374 5f70 6172  from request_par
-00013d80: 616d 5f6e 616d 6573 2e0a 2020 2020 2020  am_names..      
-00013d90: 2020 7371 6c5f 666f 725f 636f 7665 7261    sql_for_covera
-00013da0: 6765 203d 2066 2222 220a 2020 2020 2020  ge = f""".      
-00013db0: 2020 2020 2020 2020 2020 2020 2020 5345                SE
-00013dc0: 4c45 4354 0a20 2020 2020 2020 2020 2020  LECT.           
-00013dd0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00013de0: 7570 4172 7261 7953 616d 706c 6528 7b73  upArraySample({s
-00013df0: 616d 706c 655f 6279 5f70 6172 616d 7320  ample_by_params 
-00013e00: 6966 2073 616d 706c 655f 6279 5f70 6172  if sample_by_par
-00013e10: 616d 7320 3e20 3020 656c 7365 2031 7d29  ams > 0 else 1})
-00013e20: 2875 726c 2920 6173 2065 6e64 706f 696e  (url) as endpoin
-00013e30: 745f 7572 6c2c 0a20 2020 2020 2020 2020  t_url,.         
-00013e40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00013e50: 726f 7570 4172 7261 7953 616d 706c 6528  roupArraySample(
-00013e60: 7b73 616d 706c 655f 6279 5f70 6172 616d  {sample_by_param
-00013e70: 7320 6966 2073 616d 706c 655f 6279 5f70  s if sample_by_p
-00013e80: 6172 616d 7320 3e20 3020 656c 7365 2031  arams > 0 else 1
-00013e90: 7d29 2870 6970 655f 7265 7175 6573 745f  })(pipe_request_
-00013ea0: 7061 7261 6d73 2920 6173 2070 6970 655f  params) as pipe_
-00013eb0: 7265 7175 6573 745f 7061 7261 6d73 2c0a  request_params,.
+00013060: 2020 2020 290a 0a20 2020 2064 6566 2072      )..    def r
+00013070: 756e 5465 7374 2873 656c 6629 202d 3e20  unTest(self) -> 
+00013080: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+00013090: 2022 6465 6275 6722 2069 6e20 7365 6c66   "debug" in self
+000130a0: 2e70 6970 655f 7265 7175 6573 745f 7061  .pipe_request_pa
+000130b0: 7261 6d73 206f 7220 280a 2020 2020 2020  rams or (.      
+000130c0: 2020 2020 2020 2266 726f 6d22 2069 6e20        "from" in 
+000130d0: 7365 6c66 2e70 6970 655f 7265 7175 6573  self.pipe_reques
+000130e0: 745f 7061 7261 6d73 2061 6e64 2073 656c  t_params and sel
+000130f0: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
+00013100: 6172 616d 735b 2266 726f 6d22 5d20 3d3d  arams["from"] ==
+00013110: 2022 7569 220a 2020 2020 2020 2020 293a   "ui".        ):
+00013120: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013130: 662e 736b 6970 5465 7374 2822 666f 756e  f.skipTest("foun
+00013140: 6420 6465 6275 6720 7061 7261 6d22 290a  d debug param").
+00013150: 0a20 2020 2020 2020 2023 204c 6574 2773  .        # Let's
+00013160: 2072 6574 7279 2074 6865 2076 616c 6964   retry the valid
+00013170: 6174 696f 6e20 746f 2061 766f 6964 2066  ation to avoid f
+00013180: 616c 7365 2061 6c65 7274 7320 7768 656e  alse alerts when
+00013190: 2064 6561 6c69 6e67 2077 6974 6820 656e   dealing with en
+000131a0: 6470 6f69 6e74 7320 7468 6174 2068 6176  dpoints that hav
+000131b0: 6520 636f 6e74 696e 756f 7320 696e 6765  e continuos inge
+000131c0: 7374 696f 6e0a 2020 2020 2020 2020 7265  stion.        re
+000131d0: 7472 6965 7320 3d20 300a 2020 2020 2020  tries = 0.      
+000131e0: 2020 7768 696c 6520 7265 7472 6965 7320    while retries 
+000131f0: 3c20 7365 6c66 2e52 4554 5249 4553 5f4c  < self.RETRIES_L
+00013200: 494d 4954 3a0a 2020 2020 2020 2020 2020  IMIT:.          
+00013210: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00013220: 2020 2020 2020 2073 656c 662e 5f72 756e         self._run
+00013230: 5465 7374 2829 0a20 2020 2020 2020 2020  Test().         
+00013240: 2020 2065 7863 6570 7420 4173 7365 7274     except Assert
+00013250: 696f 6e45 7272 6f72 2061 7320 653a 0a20  ionError as e:. 
+00013260: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013270: 6574 7269 6573 202b 3d20 310a 2020 2020  etries += 1.    
+00013280: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00013290: 6574 7269 6573 203e 3d20 7365 6c66 2e52  etries >= self.R
+000132a0: 4554 5249 4553 5f4c 494d 4954 3a0a 2020  ETRIES_LIMIT:.  
+000132b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132c0: 2020 7261 6973 6520 650a 2020 2020 2020    raise e.      
+000132d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000132e0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000132f0: 6b0a 0a0a 4064 6174 6163 6c61 7373 0a63  k...@dataclass.c
+00013300: 6c61 7373 2050 6970 6543 6865 636b 6572  lass PipeChecker
+00013310: 5275 6e6e 6572 5265 7370 6f6e 7365 3a0a  RunnerResponse:.
+00013320: 2020 2020 7069 7065 5f6e 616d 653a 2073      pipe_name: s
+00013330: 7472 0a20 2020 2074 6573 745f 7479 7065  tr.    test_type
+00013340: 3a20 7374 720a 2020 2020 6f75 7470 7574  : str.    output
+00013350: 3a20 7374 720a 2020 2020 6d65 7472 6963  : str.    metric
+00013360: 735f 7375 6d6d 6172 793a 204f 7074 696f  s_summary: Optio
+00013370: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
+00013380: 795d 5d0a 2020 2020 6d65 7472 6963 735f  y]].    metrics_
+00013390: 7469 6d69 6e67 3a20 4469 6374 5b73 7472  timing: Dict[str
+000133a0: 2c20 5475 706c 655b 666c 6f61 742c 2066  , Tuple[float, f
+000133b0: 6c6f 6174 2c20 666c 6f61 745d 5d0a 2020  loat, float]].  
+000133c0: 2020 6661 696c 6564 3a20 4c69 7374 5b44    failed: List[D
+000133d0: 6963 745b 7374 722c 2073 7472 5d5d 0a20  ict[str, str]]. 
+000133e0: 2020 2077 6173 5f73 7563 6365 7373 6675     was_successfu
+000133f0: 6c6c 3a20 626f 6f6c 0a0a 0a63 6c61 7373  ll: bool...class
+00013400: 2050 6970 6543 6865 636b 6572 5275 6e6e   PipeCheckerRunn
+00013410: 6572 3a0a 2020 2020 6368 6563 6b65 725f  er:.    checker_
+00013420: 7374 7265 616d 5f72 6573 756c 745f 636c  stream_result_cl
+00013430: 6173 7320 3d20 756e 6974 7465 7374 2e72  ass = unittest.r
+00013440: 756e 6e65 722e 5f57 7269 7465 6c6e 4465  unner._WritelnDe
+00013450: 636f 7261 746f 7220 2023 2074 7970 653a  corator  # type:
+00013460: 2069 676e 6f72 650a 0a20 2020 2064 6566   ignore..    def
+00013470: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00013480: 7069 7065 5f6e 616d 653a 2073 7472 2c20  pipe_name: str, 
+00013490: 686f 7374 3a20 7374 7229 3a0a 2020 2020  host: str):.    
+000134a0: 2020 2020 7365 6c66 2e70 6970 655f 6e61      self.pipe_na
+000134b0: 6d65 203d 2070 6970 655f 6e61 6d65 0a20  me = pipe_name. 
+000134c0: 2020 2020 2020 2073 656c 662e 686f 7374         self.host
+000134d0: 203d 2068 6f73 740a 0a20 2020 2064 6566   = host..    def
+000134e0: 2067 6574 5f73 716c 735f 666f 725f 7265   get_sqls_for_re
+000134f0: 7175 6573 7473 5f74 6f5f 6368 6563 6b28  quests_to_check(
+00013500: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00013510: 2020 2020 2020 206d 6174 6368 6573 3a20         matches: 
+00013520: 4c69 7374 5b73 7472 5d2c 0a20 2020 2020  List[str],.     
+00013530: 2020 2073 616d 706c 655f 6279 5f70 6172     sample_by_par
+00013540: 616d 733a 2069 6e74 2c0a 2020 2020 2020  ams: int,.      
+00013550: 2020 6c69 6d69 743a 2069 6e74 2c0a 2020    limit: int,.  
+00013560: 2020 2020 2020 7069 7065 5f73 7461 7473        pipe_stats
+00013570: 5f72 745f 7461 626c 653a 2073 7472 203d  _rt_table: str =
+00013580: 2022 222c 0a20 2020 2020 2020 2065 7874   "",.        ext
+00013590: 7261 5f77 6865 7265 5f63 6c61 7573 653a  ra_where_clause:
+000135a0: 2073 7472 203d 2022 222c 0a20 2020 2029   str = "",.    )
+000135b0: 3a0a 2020 2020 2020 2020 7069 7065 5f73  :.        pipe_s
+000135c0: 7461 7473 5f72 7420 3d20 7069 7065 5f73  tats_rt = pipe_s
+000135d0: 7461 7473 5f72 745f 7461 626c 6520 6f72  tats_rt_table or
+000135e0: 2022 7469 6e79 6269 7264 2e70 6970 655f   "tinybird.pipe_
+000135f0: 7374 6174 735f 7274 220a 2020 2020 2020  stats_rt".      
+00013600: 2020 2320 544f 444f 2069 7420 6d61 7920    # TODO it may 
+00013610: 6e6f 7420 6265 206e 6565 6465 6420 746f  not be needed to
+00013620: 2065 7874 7261 6374 2074 6f6b 656e 2c20   extract token, 
+00013630: 7069 7065 5f63 6865 636b 6572 2c20 666f  pipe_checker, fo
+00013640: 726d 206f 7220 6465 6275 672e 2054 6865  rm or debug. The
+00013650: 7920 6d61 7920 6265 2075 7365 6420 696e  y may be used in
+00013660: 206e 6578 7420 7374 6570 730a 2020 2020   next steps.    
+00013670: 2020 2020 2320 544f 444f 2065 7874 7261      # TODO extra
+00013680: 6374 5552 4c50 6172 616d 6574 6572 2861  ctURLParameter(a
+00013690: 7373 756d 654e 6f74 4e75 6c6c 2875 726c  ssumeNotNull(url
+000136a0: 292c 2027 6672 6f6d 2729 203c 3e20 2775  ), 'from') <> 'u
+000136b0: 6927 2073 686f 756c 6420 7265 6164 2066  i' should read f
+000136c0: 726f 6d20 7265 7175 6573 745f 7061 7261  rom request_para
+000136d0: 6d5f 6e61 6d65 732e 0a20 2020 2020 2020  m_names..       
+000136e0: 2073 716c 5f66 6f72 5f63 6f76 6572 6167   sql_for_coverag
+000136f0: 6520 3d20 6622 2222 0a20 2020 2020 2020  e = f""".       
+00013700: 2020 2020 2020 2020 2020 2020 2053 454c               SEL
+00013710: 4543 540a 2020 2020 2020 2020 2020 2020  ECT.            
+00013720: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00013730: 7041 7272 6179 5361 6d70 6c65 287b 7361  pArraySample({sa
+00013740: 6d70 6c65 5f62 795f 7061 7261 6d73 2069  mple_by_params i
+00013750: 6620 7361 6d70 6c65 5f62 795f 7061 7261  f sample_by_para
+00013760: 6d73 203e 2030 2065 6c73 6520 317d 2928  ms > 0 else 1})(
+00013770: 7572 6c29 2061 7320 656e 6470 6f69 6e74  url) as endpoint
+00013780: 5f75 726c 2c0a 2020 2020 2020 2020 2020  _url,.          
+00013790: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+000137a0: 6f75 7041 7272 6179 5361 6d70 6c65 287b  oupArraySample({
+000137b0: 7361 6d70 6c65 5f62 795f 7061 7261 6d73  sample_by_params
+000137c0: 2069 6620 7361 6d70 6c65 5f62 795f 7061   if sample_by_pa
+000137d0: 7261 6d73 203e 2030 2065 6c73 6520 317d  rams > 0 else 1}
+000137e0: 2928 7069 7065 5f72 6571 7565 7374 5f70  )(pipe_request_p
+000137f0: 6172 616d 7329 2061 7320 7069 7065 5f72  arams) as pipe_r
+00013800: 6571 7565 7374 5f70 6172 616d 732c 0a20  equest_params,. 
+00013810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013820: 2020 2020 2020 2068 7474 705f 6d65 7468         http_meth
+00013830: 6f64 0a20 2020 2020 2020 2020 2020 2020  od.             
+00013840: 2020 2020 2020 2046 524f 4d0a 2020 2020         FROM.    
+00013850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013860: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+00013870: 2020 2020 2020 2020 2020 2020 2020 5365                Se
+00013880: 6c65 6374 0a20 2020 2020 2020 2020 2020  lect.           
+00013890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138a0: 2075 726c 2c0a 2020 2020 2020 2020 2020   url,.          
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138c0: 2020 6d61 7046 696c 7465 7228 286b 2c20    mapFilter((k, 
+000138d0: 7629 202d 3e20 286b 206e 6f74 2049 4e20  v) -> (k not IN 
+000138e0: 2827 746f 6b65 6e27 2c20 2770 6970 655f  ('token', 'pipe_
+000138f0: 6368 6563 6b65 7227 2c20 2766 726f 6d27  checker', 'from'
+00013900: 2c20 2764 6562 7567 2729 292c 2070 6172  , 'debug')), par
+00013910: 616d 6574 6572 7329 2041 5320 7069 7065  ameters) AS pipe
+00013920: 5f72 6571 7565 7374 5f70 6172 616d 732c  _request_params,
+00013930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013940: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00013950: 4b65 7973 2870 6970 655f 7265 7175 6573  Keys(pipe_reques
+00013960: 745f 7061 7261 6d73 2920 7265 7175 6573  t_params) reques
+00013970: 745f 7061 7261 6d5f 6e61 6d65 732c 0a20  t_param_names,. 
+00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013990: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+000139a0: 6374 5552 4c50 6172 616d 6574 6572 4e61  ctURLParameterNa
+000139b0: 6d65 7328 6173 7375 6d65 4e6f 744e 756c  mes(assumeNotNul
+000139c0: 6c28 7572 6c29 2920 6173 2075 726c 5f70  l(url)) as url_p
+000139d0: 6172 616d 5f6e 616d 6573 2c0a 2020 2020  aram_names,.    
+000139e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139f0: 2020 2020 2020 2020 6d65 7468 6f64 2061          method a
+00013a00: 7320 6874 7470 5f6d 6574 686f 640a 2020  s http_method.  
+00013a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a20: 2020 2020 2020 4652 4f4d 207b 7069 7065        FROM {pipe
+00013a30: 5f73 7461 7473 5f72 747d 0a20 2020 2020  _stats_rt}.     
+00013a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a50: 2020 2057 4845 5245 0a20 2020 2020 2020     WHERE.       
+00013a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a70: 2020 2020 2070 6970 655f 6e61 6d65 203d       pipe_name =
+00013a80: 2027 7b73 656c 662e 7069 7065 5f6e 616d   '{self.pipe_nam
+00013a90: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ab0: 414e 4420 7572 6c20 4953 204e 4f54 204e  AND url IS NOT N
+00013ac0: 554c 4c0a 2020 2020 2020 2020 2020 2020  ULL.            
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ae0: 414e 4420 6578 7472 6163 7455 524c 5061  AND extractURLPa
+00013af0: 7261 6d65 7465 7228 6173 7375 6d65 4e6f  rameter(assumeNo
+00013b00: 744e 756c 6c28 7572 6c29 2c20 2766 726f  tNull(url), 'fro
+00013b10: 6d27 2920 3c3e 2027 7569 270a 2020 2020  m') <> 'ui'.    
+00013b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b30: 2020 2020 2020 2020 414e 4420 6578 7472          AND extr
+00013b40: 6163 7455 524c 5061 7261 6d65 7465 7228  actURLParameter(
+00013b50: 6173 7375 6d65 4e6f 744e 756c 6c28 7572  assumeNotNull(ur
+00013b60: 6c29 2c20 2770 6970 655f 6368 6563 6b65  l), 'pipe_checke
+00013b70: 7227 2920 3c3e 2027 7472 7565 270a 2020  r') <> 'true'.  
+00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b90: 2020 2020 2020 2020 2020 414e 4420 6578            AND ex
+00013ba0: 7472 6163 7455 524c 5061 7261 6d65 7465  tractURLParamete
+00013bb0: 7228 6173 7375 6d65 4e6f 744e 756c 6c28  r(assumeNotNull(
+00013bc0: 7572 6c29 2c20 2764 6562 7567 2729 203c  url), 'debug') <
+00013bd0: 3e20 2771 7565 7279 270a 2020 2020 2020  > 'query'.      
+00013be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bf0: 2020 2020 2020 414e 4420 6572 726f 7220        AND error 
+00013c00: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+00013c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c20: 414e 4420 6e6f 7420 6d61 7043 6f6e 7461  AND not mapConta
+00013c30: 696e 7328 7061 7261 6d65 7465 7273 2c20  ins(parameters, 
+00013c40: 275f 5f74 625f 5f73 656d 7665 7227 290a  '__tb__semver').
+00013c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c60: 2020 2020 2020 2020 2020 2020 7b22 2041              {" A
+00013c70: 4e44 2022 202b 2022 2041 4e44 2022 2e6a  ND " + " AND ".j
+00013c80: 6f69 6e28 5b66 226d 6170 436f 6e74 6169  oin([f"mapContai
+00013c90: 6e73 2870 6970 655f 7265 7175 6573 745f  ns(pipe_request_
+00013ca0: 7061 7261 6d73 2c20 277b 6d61 7463 687d  params, '{match}
+00013cb0: 2729 2220 666f 7220 6d61 7463 6820 696e  ')" for match in
+00013cc0: 206d 6174 6368 6573 5d29 2069 6620 6d61   matches]) if ma
+00013cd0: 7463 6865 7320 616e 6420 6c65 6e28 6d61  tches and len(ma
+00013ce0: 7463 6865 7329 203e 2030 2065 6c73 6520  tches) > 0 else 
+00013cf0: 2727 7d0a 2020 2020 2020 2020 2020 2020  ''}.            
+00013d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d10: 7b20 6578 7472 615f 7768 6572 655f 636c  { extra_where_cl
+00013d20: 6175 7365 207d 0a20 2020 2020 2020 2020  ause }.         
+00013d30: 2020 2020 2020 2020 2020 2020 2020 204c                 L
+00013d40: 696d 6974 2035 3030 3030 3030 202d 2d20  imit 5000000 -- 
+00013d50: 456e 6f75 6768 2074 6f20 6272 696e 6720  Enough to bring 
+00013d60: 6461 7461 2077 6869 6c65 206e 6f74 2070  data while not p
+00013d70: 726f 6365 7373 696e 6720 616c 6c20 7265  rocessing all re
+00013d80: 7175 6573 7473 2066 726f 6d20 6869 6768  quests from high
+00013d90: 6c79 2075 7365 6420 7069 7065 730a 2020  ly used pipes.  
+00013da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013db0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013dc0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00013dd0: 7020 6279 2072 6571 7565 7374 5f70 6172  p by request_par
+00013de0: 616d 5f6e 616d 6573 2c20 6874 7470 5f6d  am_names, http_m
+00013df0: 6574 686f 640a 2020 2020 2020 2020 2020  ethod.          
+00013e00: 2020 2020 2020 2020 2020 464f 524d 4154            FORMAT
+00013e10: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
+00013e20: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+00013e30: 2020 2020 2020 7371 6c5f 6c61 7465 7374        sql_latest
+00013e40: 5f72 6571 7565 7374 7320 3d20 6622 2222  _requests = f"""
+00013e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e70: 2053 454c 4543 540a 2020 2020 2020 2020   SELECT.        
+00013e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e90: 2020 2020 2020 2020 2020 2020 5b66 6972              [fir
+00013ea0: 7374 5f76 616c 7565 2875 726c 295d 2061  st_value(url)] a
+00013eb0: 7320 656e 6470 6f69 6e74 5f75 726c 2c0a  s endpoint_url,.
 00013ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ed0: 2020 2020 2020 2020 6874 7470 5f6d 6574          http_met
-00013ee0: 686f 640a 2020 2020 2020 2020 2020 2020  hod.            
-00013ef0: 2020 2020 2020 2020 4652 4f4d 0a20 2020          FROM.   
-00013f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f10: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-00013f20: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-00013f30: 656c 6563 740a 2020 2020 2020 2020 2020  elect.          
-00013f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f50: 2020 7572 6c2c 0a20 2020 2020 2020 2020    url,.         
-00013f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f70: 2020 206d 6170 4669 6c74 6572 2828 6b2c     mapFilter((k,
-00013f80: 2076 2920 2d3e 2028 6b20 6e6f 7420 494e   v) -> (k not IN
-00013f90: 2028 2774 6f6b 656e 272c 2027 7069 7065   ('token', 'pipe
-00013fa0: 5f63 6865 636b 6572 272c 2027 6672 6f6d  _checker', 'from
-00013fb0: 272c 2027 6465 6275 6727 2929 2c20 7061  ', 'debug')), pa
-00013fc0: 7261 6d65 7465 7273 2920 4153 2070 6970  rameters) AS pip
-00013fd0: 655f 7265 7175 6573 745f 7061 7261 6d73  e_request_params
-00013fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013ff0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00014000: 704b 6579 7328 7069 7065 5f72 6571 7565  pKeys(pipe_reque
-00014010: 7374 5f70 6172 616d 7329 2072 6571 7565  st_params) reque
-00014020: 7374 5f70 6172 616d 5f6e 616d 6573 2c0a  st_param_names,.
-00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014040: 2020 2020 2020 2020 2020 2020 6578 7472              extr
-00014050: 6163 7455 524c 5061 7261 6d65 7465 724e  actURLParameterN
-00014060: 616d 6573 2861 7373 756d 654e 6f74 4e75  ames(assumeNotNu
-00014070: 6c6c 2875 726c 2929 2061 7320 7572 6c5f  ll(url)) as url_
-00014080: 7061 7261 6d5f 6e61 6d65 732c 0a20 2020  param_names,.   
-00014090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140a0: 2020 2020 2020 2020 206d 6574 686f 6420           method 
-000140b0: 6173 2068 7474 705f 6d65 7468 6f64 0a20  as http_method. 
-000140c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140d0: 2020 2020 2020 2046 524f 4d20 7b70 6970         FROM {pip
-000140e0: 655f 7374 6174 735f 7274 7d0a 2020 2020  e_stats_rt}.    
-000140f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014100: 2020 2020 5748 4552 450a 2020 2020 2020      WHERE.      
+00013ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ee0: 2020 2020 5b70 6970 655f 7265 7175 6573      [pipe_reques
+00013ef0: 745f 7061 7261 6d73 5d20 6173 2070 6970  t_params] as pip
+00013f00: 655f 7265 7175 6573 745f 7061 7261 6d73  e_request_params
+00013f10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f30: 2020 2020 2020 6874 7470 5f6d 6574 686f        http_metho
+00013f40: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00013f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f60: 2020 4652 4f4d 2028 0a20 2020 2020 2020    FROM (.       
+00013f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f80: 2020 2020 2020 2020 2020 2020 2053 454c               SEL
+00013f90: 4543 5420 6173 7375 6d65 4e6f 744e 756c  ECT assumeNotNul
+00013fa0: 6c28 7572 6c29 2061 7320 7572 6c2c 0a20  l(url) as url,. 
+00013fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fd0: 2020 2020 2020 206d 6170 4669 6c74 6572         mapFilter
+00013fe0: 2828 6b2c 2076 2920 2d3e 2028 6b20 6e6f  ((k, v) -> (k no
+00013ff0: 7420 494e 2028 2774 6f6b 656e 272c 2027  t IN ('token', '
+00014000: 7069 7065 5f63 6865 636b 6572 272c 2027  pipe_checker', '
+00014010: 6672 6f6d 272c 2027 6465 6275 6727 2929  from', 'debug'))
+00014020: 2c20 7061 7261 6d65 7465 7273 2920 4153  , parameters) AS
+00014030: 2070 6970 655f 7265 7175 6573 745f 7061   pipe_request_pa
+00014040: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
+00014050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014060: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00014070: 704b 6579 7328 7069 7065 5f72 6571 7565  pKeys(pipe_reque
+00014080: 7374 5f70 6172 616d 7329 2072 6571 7565  st_params) reque
+00014090: 7374 5f70 6172 616d 5f6e 616d 6573 2c0a  st_param_names,.
+000140a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140c0: 2020 2020 2020 2020 6578 7472 6163 7455          extractU
+000140d0: 524c 5061 7261 6d65 7465 724e 616d 6573  RLParameterNames
+000140e0: 2861 7373 756d 654e 6f74 4e75 6c6c 2875  (assumeNotNull(u
+000140f0: 726c 2929 2061 7320 7572 6c5f 7061 7261  rl)) as url_para
+00014100: 6d5f 6e61 6d65 732c 0a20 2020 2020 2020  m_names,.       
 00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014120: 2020 2020 2020 7069 7065 5f6e 616d 6520        pipe_name 
-00014130: 3d20 277b 7365 6c66 2e70 6970 655f 6e61  = '{self.pipe_na
-00014140: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+00014120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014130: 206d 6574 686f 6420 6173 2068 7474 705f   method as http_
+00014140: 6d65 7468 6f64 0a20 2020 2020 2020 2020  method.         
 00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014160: 2041 4e44 2075 726c 2049 5320 4e4f 5420   AND url IS NOT 
-00014170: 4e55 4c4c 0a20 2020 2020 2020 2020 2020  NULL.           
+00014160: 2020 2020 2020 2020 2020 2046 524f 4d20             FROM 
+00014170: 7b70 6970 655f 7374 6174 735f 7274 7d0a  {pipe_stats_rt}.
 00014180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014190: 2041 4e44 2065 7874 7261 6374 5552 4c50   AND extractURLP
-000141a0: 6172 616d 6574 6572 2861 7373 756d 654e  arameter(assumeN
-000141b0: 6f74 4e75 6c6c 2875 726c 292c 2027 6672  otNull(url), 'fr
-000141c0: 6f6d 2729 203c 3e20 2775 6927 0a20 2020  om') <> 'ui'.   
-000141d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141e0: 2020 2020 2020 2020 2041 4e44 2065 7874           AND ext
-000141f0: 7261 6374 5552 4c50 6172 616d 6574 6572  ractURLParameter
-00014200: 2861 7373 756d 654e 6f74 4e75 6c6c 2875  (assumeNotNull(u
-00014210: 726c 292c 2027 7069 7065 5f63 6865 636b  rl), 'pipe_check
-00014220: 6572 2729 203c 3e20 2774 7275 6527 0a20  er') <> 'true'. 
+00014190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141a0: 2020 2020 5748 4552 450a 2020 2020 2020      WHERE.      
+000141b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141d0: 2020 7069 7065 5f6e 616d 6520 3d20 277b    pipe_name = '{
+000141e0: 7365 6c66 2e70 6970 655f 6e61 6d65 7d27  self.pipe_name}'
+000141f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014210: 2020 2020 2020 2020 2041 4e44 2075 726c           AND url
+00014220: 2049 5320 4e4f 5420 4e55 4c4c 0a20 2020   IS NOT NULL.   
 00014230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014240: 2020 2020 2020 2020 2020 2041 4e44 2065             AND e
-00014250: 7874 7261 6374 5552 4c50 6172 616d 6574  xtractURLParamet
-00014260: 6572 2861 7373 756d 654e 6f74 4e75 6c6c  er(assumeNotNull
-00014270: 2875 726c 292c 2027 6465 6275 6727 2920  (url), 'debug') 
-00014280: 3c3e 2027 7175 6572 7927 0a20 2020 2020  <> 'query'.     
-00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142a0: 2020 2020 2020 2041 4e44 2065 7272 6f72         AND error
-000142b0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142d0: 2041 4e44 206e 6f74 206d 6170 436f 6e74   AND not mapCont
-000142e0: 6169 6e73 2870 6172 616d 6574 6572 732c  ains(parameters,
-000142f0: 2027 5f5f 7462 5f5f 7365 6d76 6572 2729   '__tb__semver')
-00014300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014310: 2020 2020 2020 2020 2020 2020 207b 2220               {" 
-00014320: 414e 4420 2220 2b20 2220 414e 4420 222e  AND " + " AND ".
-00014330: 6a6f 696e 285b 6622 6d61 7043 6f6e 7461  join([f"mapConta
-00014340: 696e 7328 7069 7065 5f72 6571 7565 7374  ins(pipe_request
-00014350: 5f70 6172 616d 732c 2027 7b6d 6174 6368  _params, '{match
-00014360: 7d27 2922 2066 6f72 206d 6174 6368 2069  }')" for match i
-00014370: 6e20 6d61 7463 6865 735d 2920 6966 206d  n matches]) if m
-00014380: 6174 6368 6573 2061 6e64 206c 656e 286d  atches and len(m
-00014390: 6174 6368 6573 2920 3e20 3020 656c 7365  atches) > 0 else
-000143a0: 2027 277d 0a20 2020 2020 2020 2020 2020   ''}.           
+00014240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014250: 2020 2020 2041 4e44 2065 7874 7261 6374       AND extract
+00014260: 5552 4c50 6172 616d 6574 6572 2861 7373  URLParameter(ass
+00014270: 756d 654e 6f74 4e75 6c6c 2875 726c 292c  umeNotNull(url),
+00014280: 2027 6672 6f6d 2729 203c 3e20 2775 6927   'from') <> 'ui'
+00014290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142b0: 2020 2020 2020 2020 2041 4e44 2065 7874           AND ext
+000142c0: 7261 6374 5552 4c50 6172 616d 6574 6572  ractURLParameter
+000142d0: 2861 7373 756d 654e 6f74 4e75 6c6c 2875  (assumeNotNull(u
+000142e0: 726c 292c 2027 7069 7065 5f63 6865 636b  rl), 'pipe_check
+000142f0: 6572 2729 203c 3e20 2774 7275 6527 0a20  er') <> 'true'. 
+00014300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014320: 2020 2020 2020 2041 4e44 2065 7874 7261         AND extra
+00014330: 6374 5552 4c50 6172 616d 6574 6572 2861  ctURLParameter(a
+00014340: 7373 756d 654e 6f74 4e75 6c6c 2875 726c  ssumeNotNull(url
+00014350: 292c 2027 6465 6275 6727 2920 3c3e 2027  ), 'debug') <> '
+00014360: 7175 6572 7927 0a20 2020 2020 2020 2020  query'.         
+00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014380: 2020 2020 2020 2020 2020 2020 2020 2041                 A
+00014390: 4e44 2065 7272 6f72 203d 2030 0a20 2020  ND error = 0.   
+000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 207b 2065 7874 7261 5f77 6865 7265 5f63   { extra_where_c
-000143d0: 6c61 7573 6520 7d0a 2020 2020 2020 2020  lause }.        
-000143e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143f0: 4c69 6d69 7420 3530 3030 3030 3020 2d2d  Limit 5000000 --
-00014400: 2045 6e6f 7567 6820 746f 2062 7269 6e67   Enough to bring
-00014410: 2064 6174 6120 7768 696c 6520 6e6f 7420   data while not 
-00014420: 7072 6f63 6573 7369 6e67 2061 6c6c 2072  processing all r
-00014430: 6571 7565 7374 7320 6672 6f6d 2068 6967  equests from hig
-00014440: 686c 7920 7573 6564 2070 6970 6573 0a20  hly used pipes. 
-00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014460: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00014470: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00014480: 7570 2062 7920 7265 7175 6573 745f 7061  up by request_pa
-00014490: 7261 6d5f 6e61 6d65 732c 2068 7474 705f  ram_names, http_
-000144a0: 6d65 7468 6f64 0a20 2020 2020 2020 2020  method.         
-000144b0: 2020 2020 2020 2020 2020 2046 4f52 4d41             FORMA
-000144c0: 5420 4a53 4f4e 0a20 2020 2020 2020 2020  T JSON.         
-000144d0: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
-000144e0: 2020 2020 2020 2073 716c 5f6c 6174 6573         sql_lates
-000144f0: 745f 7265 7175 6573 7473 203d 2066 2222  t_requests = f""
-00014500: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014520: 2020 5345 4c45 4354 0a20 2020 2020 2020    SELECT.       
-00014530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014540: 2020 2020 2020 2020 2020 2020 205b 6669               [fi
-00014550: 7273 745f 7661 6c75 6528 7572 6c29 5d20  rst_value(url)] 
-00014560: 6173 2065 6e64 706f 696e 745f 7572 6c2c  as endpoint_url,
-00014570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000143c0: 2020 2020 2041 4e44 206e 6f74 206d 6170       AND not map
+000143d0: 436f 6e74 6169 6e73 2870 6172 616d 6574  Contains(paramet
+000143e0: 6572 732c 2027 5f5f 7462 5f5f 7365 6d76  ers, '__tb__semv
+000143f0: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
+00014400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014410: 2020 2020 2020 2020 2020 2020 207b 2220               {" 
+00014420: 414e 4420 2220 2b20 2220 414e 4420 222e  AND " + " AND ".
+00014430: 6a6f 696e 285b 6622 6d61 7043 6f6e 7461  join([f"mapConta
+00014440: 696e 7328 7069 7065 5f72 6571 7565 7374  ins(pipe_request
+00014450: 5f70 6172 616d 732c 2027 7b6d 6174 6368  _params, '{match
+00014460: 7d27 2922 2066 6f72 206d 6174 6368 2069  }')" for match i
+00014470: 6e20 6d61 7463 6865 735d 2920 6966 206d  n matches]) if m
+00014480: 6174 6368 6573 2061 6e64 206c 656e 286d  atches and len(m
+00014490: 6174 6368 6573 2920 3e20 3020 656c 7365  atches) > 0 else
+000144a0: 2027 277d 0a20 2020 2020 2020 2020 2020   ''}.           
+000144b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144c0: 2020 2020 2020 2020 2020 2020 207b 6578               {ex
+000144d0: 7472 615f 7768 6572 655f 636c 6175 7365  tra_where_clause
+000144e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000144f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014500: 2020 2020 2020 4c49 4d49 5420 7b6c 696d        LIMIT {lim
+00014510: 6974 7d0a 2020 2020 2020 2020 2020 2020  it}.            
+00014520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014530: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00014540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014550: 2020 2020 2020 4752 4f55 5020 4259 2070        GROUP BY p
+00014560: 6970 655f 7265 7175 6573 745f 7061 7261  ipe_request_para
+00014570: 6d73 2c20 6874 7470 5f6d 6574 686f 640a  ms, http_method.
 00014580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014590: 2020 2020 205b 7069 7065 5f72 6571 7565       [pipe_reque
-000145a0: 7374 5f70 6172 616d 735d 2061 7320 7069  st_params] as pi
-000145b0: 7065 5f72 6571 7565 7374 5f70 6172 616d  pe_request_param
-000145c0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145e0: 2020 2020 2020 2068 7474 705f 6d65 7468         http_meth
-000145f0: 6f64 0a20 2020 2020 2020 2020 2020 2020  od.             
-00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014610: 2020 2046 524f 4d20 280a 2020 2020 2020     FROM (.      
-00014620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014630: 2020 2020 2020 2020 2020 2020 2020 5345                SE
-00014640: 4c45 4354 2061 7373 756d 654e 6f74 4e75  LECT assumeNotNu
-00014650: 6c6c 2875 726c 2920 6173 2075 726c 2c0a  ll(url) as url,.
-00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014680: 2020 2020 2020 2020 6d61 7046 696c 7465          mapFilte
-00014690: 7228 286b 2c20 7629 202d 3e20 286b 206e  r((k, v) -> (k n
-000146a0: 6f74 2049 4e20 2827 746f 6b65 6e27 2c20  ot IN ('token', 
-000146b0: 2770 6970 655f 6368 6563 6b65 7227 2c20  'pipe_checker', 
-000146c0: 2766 726f 6d27 2c20 2764 6562 7567 2729  'from', 'debug')
-000146d0: 292c 2070 6172 616d 6574 6572 7329 2041  ), parameters) A
-000146e0: 5320 7069 7065 5f72 6571 7565 7374 5f70  S pipe_request_p
-000146f0: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
-00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014710: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00014720: 6170 4b65 7973 2870 6970 655f 7265 7175  apKeys(pipe_requ
-00014730: 6573 745f 7061 7261 6d73 2920 7265 7175  est_params) requ
-00014740: 6573 745f 7061 7261 6d5f 6e61 6d65 732c  est_param_names,
-00014750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014770: 2020 2020 2020 2020 2065 7874 7261 6374           extract
-00014780: 5552 4c50 6172 616d 6574 6572 4e61 6d65  URLParameterName
-00014790: 7328 6173 7375 6d65 4e6f 744e 756c 6c28  s(assumeNotNull(
-000147a0: 7572 6c29 2920 6173 2075 726c 5f70 6172  url)) as url_par
-000147b0: 616d 5f6e 616d 6573 2c0a 2020 2020 2020  am_names,.      
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147e0: 2020 6d65 7468 6f64 2061 7320 6874 7470    method as http
-000147f0: 5f6d 6574 686f 640a 2020 2020 2020 2020  _method.        
-00014800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014810: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
-00014820: 207b 7069 7065 5f73 7461 7473 5f72 747d   {pipe_stats_rt}
-00014830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014850: 2020 2020 2057 4845 5245 0a20 2020 2020       WHERE.     
-00014860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014880: 2020 2070 6970 655f 6e61 6d65 203d 2027     pipe_name = '
-00014890: 7b73 656c 662e 7069 7065 5f6e 616d 657d  {self.pipe_name}
-000148a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148c0: 2020 2020 2020 2020 2020 414e 4420 7572            AND ur
-000148d0: 6c20 4953 204e 4f54 204e 554c 4c0a 2020  l IS NOT NULL.  
-000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 2020 2020 2020 414e 4420 6578 7472 6163        AND extrac
-00014910: 7455 524c 5061 7261 6d65 7465 7228 6173  tURLParameter(as
-00014920: 7375 6d65 4e6f 744e 756c 6c28 7572 6c29  sumeNotNull(url)
-00014930: 2c20 2766 726f 6d27 2920 3c3e 2027 7569  , 'from') <> 'ui
-00014940: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014960: 2020 2020 2020 2020 2020 414e 4420 6578            AND ex
-00014970: 7472 6163 7455 524c 5061 7261 6d65 7465  tractURLParamete
-00014980: 7228 6173 7375 6d65 4e6f 744e 756c 6c28  r(assumeNotNull(
-00014990: 7572 6c29 2c20 2770 6970 655f 6368 6563  url), 'pipe_chec
-000149a0: 6b65 7227 2920 3c3e 2027 7472 7565 270a  ker') <> 'true'.
-000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 2020 2020 2020 2020 414e 4420 6578 7472          AND extr
-000149e0: 6163 7455 524c 5061 7261 6d65 7465 7228  actURLParameter(
-000149f0: 6173 7375 6d65 4e6f 744e 756c 6c28 7572  assumeNotNull(ur
-00014a00: 6c29 2c20 2764 6562 7567 2729 203c 3e20  l), 'debug') <> 
-00014a10: 2771 7565 7279 270a 2020 2020 2020 2020  'query'.        
-00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a40: 414e 4420 6572 726f 7220 3d20 300a 2020  AND error = 0.  
-00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a70: 2020 2020 2020 414e 4420 6e6f 7420 6d61        AND not ma
-00014a80: 7043 6f6e 7461 696e 7328 7061 7261 6d65  pContains(parame
-00014a90: 7465 7273 2c20 275f 5f74 625f 5f73 656d  ters, '__tb__sem
-00014aa0: 7665 7227 290a 2020 2020 2020 2020 2020  ver').          
-00014ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ac0: 2020 2020 2020 2020 2020 2020 2020 7b22                {"
-00014ad0: 2041 4e44 2022 202b 2022 2041 4e44 2022   AND " + " AND "
-00014ae0: 2e6a 6f69 6e28 5b66 226d 6170 436f 6e74  .join([f"mapCont
-00014af0: 6169 6e73 2870 6970 655f 7265 7175 6573  ains(pipe_reques
-00014b00: 745f 7061 7261 6d73 2c20 277b 6d61 7463  t_params, '{matc
-00014b10: 687d 2729 2220 666f 7220 6d61 7463 6820  h}')" for match 
-00014b20: 696e 206d 6174 6368 6573 5d29 2069 6620  in matches]) if 
-00014b30: 6d61 7463 6865 7320 616e 6420 6c65 6e28  matches and len(
-00014b40: 6d61 7463 6865 7329 203e 2030 2065 6c73  matches) > 0 els
-00014b50: 6520 2727 7d0a 2020 2020 2020 2020 2020  e ''}.          
-00014b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b70: 2020 2020 2020 2020 2020 2020 2020 7b65                {e
-00014b80: 7874 7261 5f77 6865 7265 5f63 6c61 7573  xtra_where_claus
-00014b90: 657d 0a20 2020 2020 2020 2020 2020 2020  e}.             
-00014ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bb0: 2020 2020 2020 204c 494d 4954 207b 6c69         LIMIT {li
-00014bc0: 6d69 747d 0a20 2020 2020 2020 2020 2020  mit}.           
-00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014be0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00014bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c00: 2020 2020 2020 2047 524f 5550 2042 5920         GROUP BY 
-00014c10: 7069 7065 5f72 6571 7565 7374 5f70 6172  pipe_request_par
-00014c20: 616d 732c 2068 7474 705f 6d65 7468 6f64  ams, http_method
-00014c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c50: 2046 4f52 4d41 5420 4a53 4f4e 0a20 2020   FORMAT JSON.   
-00014c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c70: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
-00014c80: 2020 2020 2072 6574 7572 6e20 7371 6c5f       return sql_
-00014c90: 666f 725f 636f 7665 7261 6765 2c20 7371  for_coverage, sq
-00014ca0: 6c5f 6c61 7465 7374 5f72 6571 7565 7374  l_latest_request
-00014cb0: 730a 0a20 2020 2064 6566 205f 6765 745f  s..    def _get_
-00014cc0: 6368 6563 6b65 7228 0a20 2020 2020 2020  checker(.       
-00014cd0: 2073 656c 662c 0a20 2020 2020 2020 2072   self,.        r
-00014ce0: 6571 7565 7374 3a20 4469 6374 5b73 7472  equest: Dict[str
-00014cf0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00014d00: 6368 6563 6b65 725f 7069 7065 5f6e 616d  checker_pipe_nam
-00014d10: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
-00014d20: 746f 6b65 6e3a 2073 7472 2c0a 2020 2020  token: str,.    
-00014d30: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
-00014d40: 655f 7469 6d65 733a 2062 6f6f 6c2c 0a20  e_times: bool,. 
-00014d50: 2020 2020 2020 2069 676e 6f72 655f 6f72         ignore_or
-00014d60: 6465 723a 2062 6f6f 6c2c 0a20 2020 2020  der: bool,.     
-00014d70: 2020 2076 616c 6964 6174 655f 7072 6f63     validate_proc
-00014d80: 6573 7365 645f 6279 7465 733a 2062 6f6f  essed_bytes: boo
-00014d90: 6c2c 0a20 2020 2029 202d 3e20 5069 7065  l,.    ) -> Pipe
-00014da0: 4368 6563 6b65 723a 0a20 2020 2020 2020  Checker:.       
-00014db0: 2072 6574 7572 6e20 5069 7065 4368 6563   return PipeChec
-00014dc0: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-00014dd0: 2072 6571 7565 7374 2c0a 2020 2020 2020   request,.      
-00014de0: 2020 2020 2020 7365 6c66 2e70 6970 655f        self.pipe_
-00014df0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00014e00: 2020 6368 6563 6b65 725f 7069 7065 5f6e    checker_pipe_n
-00014e10: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00014e20: 2074 6f6b 656e 2c0a 2020 2020 2020 2020   token,.        
-00014e30: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
-00014e40: 655f 7469 6d65 732c 0a20 2020 2020 2020  e_times,.       
-00014e50: 2020 2020 2069 676e 6f72 655f 6f72 6465       ignore_orde
-00014e60: 722c 0a20 2020 2020 2020 2020 2020 2076  r,.            v
-00014e70: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
-00014e80: 645f 6279 7465 732c 0a20 2020 2020 2020  d_bytes,.       
-00014e90: 2029 0a0a 2020 2020 6465 6620 5f64 656c   )..    def _del
-00014ea0: 7461 5f70 6572 6365 6e74 6167 6528 7365  ta_percentage(se
-00014eb0: 6c66 2c20 6368 6563 6b65 723a 2066 6c6f  lf, checker: flo
-00014ec0: 6174 2c20 6375 7272 656e 743a 2066 6c6f  at, current: flo
-00014ed0: 6174 2920 2d3e 2066 6c6f 6174 3a0a 2020  at) -> float:.  
-00014ee0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00014ef0: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
-00014f00: 7420 3d3d 2030 2e30 3a0a 2020 2020 2020  t == 0.0:.      
-00014f10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00014f20: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
-00014f30: 2072 6574 7572 6e20 726f 756e 6428 2828   return round(((
-00014f40: 6368 6563 6b65 7220 2d20 6375 7272 656e  checker - curren
-00014f50: 7429 202f 2063 7572 7265 6e74 2920 2a20  t) / current) * 
-00014f60: 3130 302c 2032 290a 2020 2020 2020 2020  100, 2).        
-00014f70: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00014f80: 2061 7320 6578 633a 0a20 2020 2020 2020   as exc:.       
-00014f90: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
-00014fa0: 6e69 6e67 2866 2245 7272 6f72 2063 616c  ning(f"Error cal
-00014fb0: 6375 6c61 7469 6e67 2064 656c 7461 3a20  culating delta: 
-00014fc0: 7b65 7863 7d22 290a 2020 2020 2020 2020  {exc}").        
-00014fd0: 2020 2020 7265 7475 726e 2030 2e30 0a0a      return 0.0..
-00014fe0: 2020 2020 6465 6620 7275 6e5f 7069 7065      def run_pipe
-00014ff0: 5f63 6865 636b 6572 280a 2020 2020 2020  _checker(.      
-00015000: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00015010: 7069 7065 5f72 6571 7565 7374 735f 746f  pipe_requests_to
-00015020: 5f63 6865 636b 3a20 4c69 7374 5b44 6963  _check: List[Dic
-00015030: 745b 7374 722c 2041 6e79 5d5d 2c0a 2020  t[str, Any]],.  
-00015040: 2020 2020 2020 6368 6563 6b65 725f 7069        checker_pi
-00015050: 7065 5f6e 616d 653a 2073 7472 2c0a 2020  pe_name: str,.  
-00015060: 2020 2020 2020 746f 6b65 6e3a 2073 7472        token: str
-00015070: 2c0a 2020 2020 2020 2020 6f6e 6c79 5f72  ,.        only_r
-00015080: 6573 706f 6e73 655f 7469 6d65 733a 2062  esponse_times: b
-00015090: 6f6f 6c2c 0a20 2020 2020 2020 2069 676e  ool,.        ign
-000150a0: 6f72 655f 6f72 6465 723a 2062 6f6f 6c2c  ore_order: bool,
-000150b0: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
-000150c0: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
-000150d0: 733a 2062 6f6f 6c2c 0a20 2020 2020 2020  s: bool,.       
-000150e0: 2066 6169 6c66 6173 743a 2062 6f6f 6c2c   failfast: bool,
-000150f0: 0a20 2020 2020 2020 2063 7573 746f 6d5f  .        custom_
-00015100: 6f75 7470 7574 3a20 626f 6f6c 203d 2046  output: bool = F
-00015110: 616c 7365 2c0a 2020 2020 2020 2020 6465  alse,.        de
-00015120: 6275 673a 2062 6f6f 6c20 3d20 4661 6c73  bug: bool = Fals
-00015130: 652c 0a20 2020 2029 202d 3e20 5069 7065  e,.    ) -> Pipe
-00015140: 4368 6563 6b65 7252 756e 6e65 7252 6573  CheckerRunnerRes
-00015150: 706f 6e73 653a 0a20 2020 2020 2020 2063  ponse:.        c
-00015160: 6c61 7373 2050 6970 6543 6865 636b 6572  lass PipeChecker
-00015170: 5465 7874 5465 7374 5265 7375 6c74 2875  TextTestResult(u
-00015180: 6e69 7474 6573 742e 5465 7874 5465 7374  nittest.TextTest
-00015190: 5265 7375 6c74 293a 0a20 2020 2020 2020  Result):.       
-000151a0: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
-000151b0: 5f28 7365 6c66 2c20 2a61 7267 733a 2041  _(self, *args: A
-000151c0: 6e79 2c20 2a2a 6b77 6172 6773 3a20 416e  ny, **kwargs: An
-000151d0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
-000151e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000151f0: 2e63 7573 746f 6d5f 6f75 7470 7574 203d  .custom_output =
-00015200: 206b 7761 7267 732e 706f 7028 2263 7573   kwargs.pop("cus
-00015210: 746f 6d5f 6f75 7470 7574 222c 2046 616c  tom_output", Fal
-00015220: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-00015230: 2020 2020 7375 7065 7228 5069 7065 4368      super(PipeCh
-00015240: 6563 6b65 7254 6578 7454 6573 7452 6573  eckerTextTestRes
-00015250: 756c 742c 2073 656c 6629 2e5f 5f69 6e69  ult, self).__ini
-00015260: 745f 5f28 2a61 7267 732c 202a 2a6b 7761  t__(*args, **kwa
-00015270: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00015280: 2020 2020 2073 656c 662e 7375 6363 6573       self.succes
-00015290: 733a 204c 6973 745b 5069 7065 4368 6563  s: List[PipeChec
-000152a0: 6b65 725d 203d 205b 5d0a 0a20 2020 2020  ker] = []..     
-000152b0: 2020 2020 2020 2064 6566 2061 6464 5375         def addSu
-000152c0: 6363 6573 7328 7365 6c66 2c20 7465 7374  ccess(self, test
-000152d0: 3a20 5069 7065 4368 6563 6b65 7229 3a20  : PipeChecker): 
-000152e0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015300: 7375 7065 7228 5069 7065 4368 6563 6b65  super(PipeChecke
-00015310: 7254 6578 7454 6573 7452 6573 756c 742c  rTextTestResult,
-00015320: 2073 656c 6629 2e61 6464 5375 6363 6573   self).addSucces
-00015330: 7328 7465 7374 290a 2020 2020 2020 2020  s(test).        
-00015340: 2020 2020 2020 2020 7365 6c66 2e73 7563          self.suc
-00015350: 6365 7373 2e61 7070 656e 6428 7465 7374  cess.append(test
-00015360: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
-00015370: 6566 2073 7461 7274 5465 7374 2873 656c  ef startTest(sel
-00015380: 662c 2074 6573 7429 3a0a 2020 2020 2020  f, test):.      
-00015390: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000153a0: 2073 656c 662e 6375 7374 6f6d 5f6f 7574   self.custom_out
-000153b0: 7075 743a 0a20 2020 2020 2020 2020 2020  put:.           
-000153c0: 2020 2020 2020 2020 2073 7570 6572 2850           super(P
-000153d0: 6970 6543 6865 636b 6572 5465 7874 5465  ipeCheckerTextTe
-000153e0: 7374 5265 7375 6c74 2c20 7365 6c66 292e  stResult, self).
-000153f0: 7374 6172 7454 6573 7428 7465 7374 290a  startTest(test).
-00015400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015410: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00015420: 2020 2020 2020 2020 2020 7375 7065 7228            super(
-00015430: 756e 6974 7465 7374 2e54 6578 7454 6573  unittest.TextTes
-00015440: 7452 6573 756c 742c 2073 656c 6629 2e73  tResult, self).s
-00015450: 7461 7274 5465 7374 2874 6573 7429 0a0a  tartTest(test)..
-00015460: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-00015470: 5f77 7269 7465 5f73 7461 7475 7328 7365  _write_status(se
-00015480: 6c66 2c20 7465 7374 2c20 7374 6174 7573  lf, test, status
-00015490: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000154a0: 2020 2069 6620 7365 6c66 2e63 7573 746f     if self.custo
-000154b0: 6d5f 6f75 7470 7574 3a0a 2020 2020 2020  m_output:.      
-000154c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000154d0: 6c66 2e73 7472 6561 6d2e 7772 6974 6528  lf.stream.write(
-000154e0: 7374 6174 7573 2e75 7070 6572 2829 290a  status.upper()).
-000154f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015500: 2020 2020 7365 6c66 2e73 7472 6561 6d2e      self.stream.
-00015510: 7772 6974 6528 2220 2d20 2229 0a20 2020  write(" - ").   
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 2073 656c 662e 7374 7265 616d 2e77 7269   self.stream.wri
-00015540: 7465 2873 7472 2874 6573 7429 290a 2020  te(str(test)).  
-00015550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015560: 2020 7365 6c66 2e73 7472 6561 6d2e 7772    self.stream.wr
-00015570: 6974 6528 2220 2d20 2229 0a20 2020 2020  ite(" - ").     
-00015580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00015590: 656c 662e 7374 7265 616d 2e77 7269 7465  elf.stream.write
-000155a0: 6c6e 2874 6573 742e 5f77 7269 7465 5f70  ln(test._write_p
-000155b0: 6572 666f 726d 616e 6365 2829 290a 0a20  erformance()).. 
-000155c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000155d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000155e0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-000155f0: 7265 616d 2e77 7269 7465 6c6e 2873 7461  ream.writeln(sta
-00015600: 7475 7329 0a20 2020 2020 2020 2020 2020  tus).           
-00015610: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
-00015620: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
-00015630: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
-00015640: 6577 6c69 6e65 203d 2054 7275 650a 0a20  ewline = True.. 
-00015650: 2020 2020 2020 2073 7569 7465 203d 2075         suite = u
-00015660: 6e69 7474 6573 742e 5465 7374 5375 6974  nittest.TestSuit
-00015670: 6528 290a 0a20 2020 2020 2020 2066 6f72  e()..        for
-00015680: 205f 2c20 7265 7175 6573 7420 696e 2065   _, request in e
-00015690: 6e75 6d65 7261 7465 2870 6970 655f 7265  numerate(pipe_re
-000156a0: 7175 6573 7473 5f74 6f5f 6368 6563 6b29  quests_to_check)
-000156b0: 3a0a 2020 2020 2020 2020 2020 2020 7375  :.            su
-000156c0: 6974 652e 6164 6454 6573 7428 0a20 2020  ite.addTest(.   
-000156d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000156e0: 662e 5f67 6574 5f63 6865 636b 6572 280a  f._get_checker(.
-000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015700: 2020 2020 7265 7175 6573 742c 2063 6865      request, che
-00015710: 636b 6572 5f70 6970 655f 6e61 6d65 2c20  cker_pipe_name, 
-00015720: 746f 6b65 6e2c 206f 6e6c 795f 7265 7370  token, only_resp
-00015730: 6f6e 7365 5f74 696d 6573 2c20 6967 6e6f  onse_times, igno
-00015740: 7265 5f6f 7264 6572 2c20 7661 6c69 6461  re_order, valida
-00015750: 7465 5f70 726f 6365 7373 6564 5f62 7974  te_processed_byt
-00015760: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00015770: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00015780: 2029 0a0a 2020 2020 2020 2020 7265 7375   )..        resu
-00015790: 6c74 203d 2050 6970 6543 6865 636b 6572  lt = PipeChecker
-000157a0: 5465 7874 5465 7374 5265 7375 6c74 280a  TextTestResult(.
-000157b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000157c0: 2e63 6865 636b 6572 5f73 7472 6561 6d5f  .checker_stream_
-000157d0: 7265 7375 6c74 5f63 6c61 7373 2873 7973  result_class(sys
-000157e0: 2e73 7464 6f75 7429 2c20 6465 7363 7269  .stdout), descri
-000157f0: 7074 696f 6e73 3d54 7275 652c 2076 6572  ptions=True, ver
-00015800: 626f 7369 7479 3d32 2c20 6375 7374 6f6d  bosity=2, custom
-00015810: 5f6f 7574 7075 743d 6375 7374 6f6d 5f6f  _output=custom_o
-00015820: 7574 7075 740a 2020 2020 2020 2020 290a  utput.        ).
-00015830: 2020 2020 2020 2020 7265 7375 6c74 2e66          result.f
-00015840: 6169 6c66 6173 7420 3d20 6661 696c 6661  ailfast = failfa
-00015850: 7374 0a20 2020 2020 2020 2073 7569 7465  st.        suite
-00015860: 2e72 756e 2872 6573 756c 7429 0a0a 2020  .run(result)..  
-00015870: 2020 2020 2020 6d65 7472 6963 735f 7375        metrics_su
-00015880: 6d6d 6172 793a 204f 7074 696f 6e61 6c5b  mmary: Optional[
-00015890: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
-000158a0: 3d20 4e6f 6e65 0a20 2020 2020 2020 206d  = None.        m
-000158b0: 6574 7269 6373 5f74 696d 696e 673a 2044  etrics_timing: D
-000158c0: 6963 745b 7374 722c 2054 7570 6c65 5b66  ict[str, Tuple[f
-000158d0: 6c6f 6174 2c20 666c 6f61 742c 2066 6c6f  loat, float, flo
-000158e0: 6174 5d5d 203d 207b 7d0a 0a20 2020 2020  at]] = {}..     
-000158f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00015900: 2020 2020 6375 7272 656e 745f 7265 7370      current_resp
-00015910: 6f6e 7365 5f74 696d 6573 3a20 4c69 7374  onse_times: List
-00015920: 5b66 6c6f 6174 5d20 3d20 5b5d 0a20 2020  [float] = [].   
-00015930: 2020 2020 2020 2020 2063 6865 636b 6572           checker
-00015940: 5f72 6573 706f 6e73 655f 7469 6d65 733a  _response_times:
-00015950: 204c 6973 745b 666c 6f61 745d 203d 205b   List[float] = [
-00015960: 5d0a 0a20 2020 2020 2020 2020 2020 2063  ]..            c
-00015970: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
-00015980: 733a 204c 6973 745b 696e 745d 203d 205b  s: List[int] = [
-00015990: 5d0a 2020 2020 2020 2020 2020 2020 6368  ].            ch
-000159a0: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
-000159b0: 3a20 4c69 7374 5b69 6e74 5d20 3d20 5b5d  : List[int] = []
-000159c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000159d0: 7265 7375 6c74 2e73 7563 6365 7373 3a0a  result.success:.
-000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159f0: 666f 7220 7465 7374 2069 6e20 7265 7375  for test in resu
-00015a00: 6c74 2e73 7563 6365 7373 3a0a 2020 2020  lt.success:.    
-00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a20: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
-00015a30: 5f74 696d 6573 2e61 7070 656e 6428 7465  _times.append(te
-00015a40: 7374 2e63 7572 7265 6e74 5f72 6573 706f  st.current_respo
-00015a50: 6e73 655f 7469 6d65 290a 2020 2020 2020  nse_time).      
-00015a60: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00015a70: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-00015a80: 696d 6573 2e61 7070 656e 6428 7465 7374  imes.append(test
-00015a90: 2e63 6865 636b 6572 5f72 6573 706f 6e73  .checker_respons
-00015aa0: 655f 7469 6d65 290a 0a20 2020 2020 2020  e_time)..       
-00015ab0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00015ac0: 7265 6e74 5f72 6561 645f 6279 7465 732e  rent_read_bytes.
-00015ad0: 6170 7065 6e64 2874 6573 742e 6375 7272  append(test.curr
-00015ae0: 656e 745f 7265 6164 5f62 7974 6573 290a  ent_read_bytes).
-00015af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b00: 2020 2020 6368 6563 6b65 725f 7265 6164      checker_read
-00015b10: 5f62 7974 6573 2e61 7070 656e 6428 7465  _bytes.append(te
-00015b20: 7374 2e63 6865 636b 6572 5f72 6561 645f  st.checker_read_
-00015b30: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
-00015b40: 2020 2020 2020 2020 666f 7220 7465 7374          for test
-00015b50: 2c20 5f20 696e 2072 6573 756c 742e 6661  , _ in result.fa
-00015b60: 696c 7572 6573 3a20 2023 2074 7970 653a  ilures:  # type:
-00015b70: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-00015b80: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-00015b90: 656e 745f 7265 7370 6f6e 7365 5f74 696d  ent_response_tim
-00015ba0: 6573 2e61 7070 656e 6428 7465 7374 2e63  es.append(test.c
-00015bb0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
-00015bc0: 7469 6d65 290a 2020 2020 2020 2020 2020  time).          
-00015bd0: 2020 2020 2020 2020 2020 6368 6563 6b65            checke
-00015be0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
-00015bf0: 2e61 7070 656e 6428 7465 7374 2e63 6865  .append(test.che
-00015c00: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
-00015c10: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
-00015c20: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00015c30: 5f72 6561 645f 6279 7465 732e 6170 7065  _read_bytes.appe
-00015c40: 6e64 2874 6573 742e 6375 7272 656e 745f  nd(test.current_
-00015c50: 7265 6164 5f62 7974 6573 290a 2020 2020  read_bytes).    
-00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c70: 6368 6563 6b65 725f 7265 6164 5f62 7974  checker_read_byt
-00015c80: 6573 2e61 7070 656e 6428 7465 7374 2e63  es.append(test.c
-00015c90: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
-00015ca0: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-00015cb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00015cc0: 2020 2020 2023 2069 6620 7765 2064 6f20       # if we do 
-00015cd0: 6e6f 7420 6861 7665 2061 6e79 2073 7563  not have any suc
-00015ce0: 6365 7373 6675 6c20 6578 6563 7574 696f  cessful executio
-00015cf0: 6e2c 206c 6574 2773 206a 7573 7420 7265  n, let's just re
-00015d00: 7475 726e 2061 2074 6162 6c65 2077 6974  turn a table wit
-00015d10: 6820 6475 6d6d 7920 6d65 7472 6963 7320  h dummy metrics 
-00015d20: 6874 7470 733a 2f2f 6769 746c 6162 2e63  https://gitlab.c
-00015d30: 6f6d 2f74 696e 7962 6972 642f 616e 616c  om/tinybird/anal
-00015d40: 7974 6963 732f 2d2f 6973 7375 6573 2f31  ytics/-/issues/1
-00015d50: 3038 3735 0a20 2020 2020 2020 2020 2020  0875.           
-00015d60: 2020 2020 2063 7572 7265 6e74 5f72 6573       current_res
-00015d70: 706f 6e73 655f 7469 6d65 7320 3d20 5b30  ponse_times = [0
-00015d80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00015d90: 2020 6368 6563 6b65 725f 7265 7370 6f6e    checker_respon
-00015da0: 7365 5f74 696d 6573 203d 205b 305d 0a0a  se_times = [0]..
+00014590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145a0: 464f 524d 4154 204a 534f 4e0a 2020 2020  FORMAT JSON.    
+000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000145d0: 2020 2020 7265 7475 726e 2073 716c 5f66      return sql_f
+000145e0: 6f72 5f63 6f76 6572 6167 652c 2073 716c  or_coverage, sql
+000145f0: 5f6c 6174 6573 745f 7265 7175 6573 7473  _latest_requests
+00014600: 0a0a 2020 2020 6465 6620 5f67 6574 5f63  ..    def _get_c
+00014610: 6865 636b 6572 280a 2020 2020 2020 2020  hecker(.        
+00014620: 7365 6c66 2c0a 2020 2020 2020 2020 7265  self,.        re
+00014630: 7175 6573 743a 2044 6963 745b 7374 722c  quest: Dict[str,
+00014640: 2041 6e79 5d2c 0a20 2020 2020 2020 2063   Any],.        c
+00014650: 6865 636b 6572 5f70 6970 655f 6e61 6d65  hecker_pipe_name
+00014660: 3a20 7374 722c 0a20 2020 2020 2020 2074  : str,.        t
+00014670: 6f6b 656e 3a20 7374 722c 0a20 2020 2020  oken: str,.     
+00014680: 2020 206f 6e6c 795f 7265 7370 6f6e 7365     only_response
+00014690: 5f74 696d 6573 3a20 626f 6f6c 2c0a 2020  _times: bool,.  
+000146a0: 2020 2020 2020 6967 6e6f 7265 5f6f 7264        ignore_ord
+000146b0: 6572 3a20 626f 6f6c 2c0a 2020 2020 2020  er: bool,.      
+000146c0: 2020 7661 6c69 6461 7465 5f70 726f 6365    validate_proce
+000146d0: 7373 6564 5f62 7974 6573 3a20 626f 6f6c  ssed_bytes: bool
+000146e0: 2c0a 2020 2020 2920 2d3e 2050 6970 6543  ,.    ) -> PipeC
+000146f0: 6865 636b 6572 3a0a 2020 2020 2020 2020  hecker:.        
+00014700: 7265 7475 726e 2050 6970 6543 6865 636b  return PipeCheck
+00014710: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00014720: 7265 7175 6573 742c 0a20 2020 2020 2020  request,.       
+00014730: 2020 2020 2073 656c 662e 7069 7065 5f6e       self.pipe_n
+00014740: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00014750: 2063 6865 636b 6572 5f70 6970 655f 6e61   checker_pipe_na
+00014760: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00014770: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
+00014780: 2020 206f 6e6c 795f 7265 7370 6f6e 7365     only_response
+00014790: 5f74 696d 6573 2c0a 2020 2020 2020 2020  _times,.        
+000147a0: 2020 2020 6967 6e6f 7265 5f6f 7264 6572      ignore_order
+000147b0: 2c0a 2020 2020 2020 2020 2020 2020 7661  ,.            va
+000147c0: 6c69 6461 7465 5f70 726f 6365 7373 6564  lidate_processed
+000147d0: 5f62 7974 6573 2c0a 2020 2020 2020 2020  _bytes,.        
+000147e0: 290a 0a20 2020 2064 6566 205f 6465 6c74  )..    def _delt
+000147f0: 615f 7065 7263 656e 7461 6765 2873 656c  a_percentage(sel
+00014800: 662c 2063 6865 636b 6572 3a20 666c 6f61  f, checker: floa
+00014810: 742c 2063 7572 7265 6e74 3a20 666c 6f61  t, current: floa
+00014820: 7429 202d 3e20 666c 6f61 743a 0a20 2020  t) -> float:.   
+00014830: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00014840: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
+00014850: 203d 3d20 302e 303a 0a20 2020 2020 2020   == 0.0:.       
+00014860: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00014870: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+00014880: 7265 7475 726e 2072 6f75 6e64 2828 2863  return round(((c
+00014890: 6865 636b 6572 202d 2063 7572 7265 6e74  hecker - current
+000148a0: 2920 2f20 6375 7272 656e 7429 202a 2031  ) / current) * 1
+000148b0: 3030 2c20 3229 0a20 2020 2020 2020 2065  00, 2).        e
+000148c0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+000148d0: 6173 2065 7863 3a0a 2020 2020 2020 2020  as exc:.        
+000148e0: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+000148f0: 696e 6728 6622 4572 726f 7220 6361 6c63  ing(f"Error calc
+00014900: 756c 6174 696e 6720 6465 6c74 613a 207b  ulating delta: {
+00014910: 6578 637d 2229 0a20 2020 2020 2020 2020  exc}").         
+00014920: 2020 2072 6574 7572 6e20 302e 300a 0a20     return 0.0.. 
+00014930: 2020 2064 6566 2072 756e 5f70 6970 655f     def run_pipe_
+00014940: 6368 6563 6b65 7228 0a20 2020 2020 2020  checker(.       
+00014950: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+00014960: 6970 655f 7265 7175 6573 7473 5f74 6f5f  ipe_requests_to_
+00014970: 6368 6563 6b3a 204c 6973 745b 4469 6374  check: List[Dict
+00014980: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
+00014990: 2020 2020 2063 6865 636b 6572 5f70 6970       checker_pip
+000149a0: 655f 6e61 6d65 3a20 7374 722c 0a20 2020  e_name: str,.   
+000149b0: 2020 2020 2074 6f6b 656e 3a20 7374 722c       token: str,
+000149c0: 0a20 2020 2020 2020 206f 6e6c 795f 7265  .        only_re
+000149d0: 7370 6f6e 7365 5f74 696d 6573 3a20 626f  sponse_times: bo
+000149e0: 6f6c 2c0a 2020 2020 2020 2020 6967 6e6f  ol,.        igno
+000149f0: 7265 5f6f 7264 6572 3a20 626f 6f6c 2c0a  re_order: bool,.
+00014a00: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+00014a10: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
+00014a20: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+00014a30: 6661 696c 6661 7374 3a20 626f 6f6c 2c0a  failfast: bool,.
+00014a40: 2020 2020 2020 2020 6375 7374 6f6d 5f6f          custom_o
+00014a50: 7574 7075 743a 2062 6f6f 6c20 3d20 4661  utput: bool = Fa
+00014a60: 6c73 652c 0a20 2020 2020 2020 2064 6562  lse,.        deb
+00014a70: 7567 3a20 626f 6f6c 203d 2046 616c 7365  ug: bool = False
+00014a80: 2c0a 2020 2020 2920 2d3e 2050 6970 6543  ,.    ) -> PipeC
+00014a90: 6865 636b 6572 5275 6e6e 6572 5265 7370  heckerRunnerResp
+00014aa0: 6f6e 7365 3a0a 2020 2020 2020 2020 636c  onse:.        cl
+00014ab0: 6173 7320 5069 7065 4368 6563 6b65 7254  ass PipeCheckerT
+00014ac0: 6578 7454 6573 7452 6573 756c 7428 756e  extTestResult(un
+00014ad0: 6974 7465 7374 2e54 6578 7454 6573 7452  ittest.TextTestR
+00014ae0: 6573 756c 7429 3a0a 2020 2020 2020 2020  esult):.        
+00014af0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00014b00: 2873 656c 662c 202a 6172 6773 3a20 416e  (self, *args: An
+00014b10: 792c 202a 2a6b 7761 7267 733a 2041 6e79  y, **kwargs: Any
+00014b20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014b30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00014b40: 6375 7374 6f6d 5f6f 7574 7075 7420 3d20  custom_output = 
+00014b50: 6b77 6172 6773 2e70 6f70 2822 6375 7374  kwargs.pop("cust
+00014b60: 6f6d 5f6f 7574 7075 7422 2c20 4661 6c73  om_output", Fals
+00014b70: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00014b80: 2020 2073 7570 6572 2850 6970 6543 6865     super(PipeChe
+00014b90: 636b 6572 5465 7874 5465 7374 5265 7375  ckerTextTestResu
+00014ba0: 6c74 2c20 7365 6c66 292e 5f5f 696e 6974  lt, self).__init
+00014bb0: 5f5f 282a 6172 6773 2c20 2a2a 6b77 6172  __(*args, **kwar
+00014bc0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00014bd0: 2020 2020 7365 6c66 2e73 7563 6365 7373      self.success
+00014be0: 3a20 4c69 7374 5b50 6970 6543 6865 636b  : List[PipeCheck
+00014bf0: 6572 5d20 3d20 5b5d 0a0a 2020 2020 2020  er] = []..      
+00014c00: 2020 2020 2020 6465 6620 6164 6453 7563        def addSuc
+00014c10: 6365 7373 2873 656c 662c 2074 6573 743a  cess(self, test:
+00014c20: 2050 6970 6543 6865 636b 6572 293a 2020   PipeChecker):  
+00014c30: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00014c40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014c50: 7570 6572 2850 6970 6543 6865 636b 6572  uper(PipeChecker
+00014c60: 5465 7874 5465 7374 5265 7375 6c74 2c20  TextTestResult, 
+00014c70: 7365 6c66 292e 6164 6453 7563 6365 7373  self).addSuccess
+00014c80: 2874 6573 7429 0a20 2020 2020 2020 2020  (test).         
+00014c90: 2020 2020 2020 2073 656c 662e 7375 6363         self.succ
+00014ca0: 6573 732e 6170 7065 6e64 2874 6573 7429  ess.append(test)
+00014cb0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00014cc0: 6620 7374 6172 7454 6573 7428 7365 6c66  f startTest(self
+00014cd0: 2c20 7465 7374 293a 0a20 2020 2020 2020  , test):.       
+00014ce0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00014cf0: 7365 6c66 2e63 7573 746f 6d5f 6f75 7470  self.custom_outp
+00014d00: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00014d10: 2020 2020 2020 2020 7375 7065 7228 5069          super(Pi
+00014d20: 7065 4368 6563 6b65 7254 6578 7454 6573  peCheckerTextTes
+00014d30: 7452 6573 756c 742c 2073 656c 6629 2e73  tResult, self).s
+00014d40: 7461 7274 5465 7374 2874 6573 7429 0a20  tartTest(test). 
+00014d50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00014d60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00014d70: 2020 2020 2020 2020 2073 7570 6572 2875           super(u
+00014d80: 6e69 7474 6573 742e 5465 7874 5465 7374  nittest.TextTest
+00014d90: 5265 7375 6c74 2c20 7365 6c66 292e 7374  Result, self).st
+00014da0: 6172 7454 6573 7428 7465 7374 290a 0a20  artTest(test).. 
+00014db0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
+00014dc0: 7772 6974 655f 7374 6174 7573 2873 656c  write_status(sel
+00014dd0: 662c 2074 6573 742c 2073 7461 7475 7329  f, test, status)
+00014de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014df0: 2020 6966 2073 656c 662e 6375 7374 6f6d    if self.custom
+00014e00: 5f6f 7574 7075 743a 0a20 2020 2020 2020  _output:.       
+00014e10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00014e20: 662e 7374 7265 616d 2e77 7269 7465 2873  f.stream.write(s
+00014e30: 7461 7475 732e 7570 7065 7228 2929 0a20  tatus.upper()). 
+00014e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e50: 2020 2073 656c 662e 7374 7265 616d 2e77     self.stream.w
+00014e60: 7269 7465 2822 202d 2022 290a 2020 2020  rite(" - ").    
+00014e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e80: 7365 6c66 2e73 7472 6561 6d2e 7772 6974  self.stream.writ
+00014e90: 6528 7374 7228 7465 7374 2929 0a20 2020  e(str(test)).   
+00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014eb0: 2073 656c 662e 7374 7265 616d 2e77 7269   self.stream.wri
+00014ec0: 7465 2822 202d 2022 290a 2020 2020 2020  te(" - ").      
+00014ed0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00014ee0: 6c66 2e73 7472 6561 6d2e 7772 6974 656c  lf.stream.writel
+00014ef0: 6e28 7465 7374 2e5f 7772 6974 655f 7065  n(test._write_pe
+00014f00: 7266 6f72 6d61 6e63 6528 2929 0a0a 2020  rformance())..  
+00014f10: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00014f20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014f30: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
+00014f40: 6561 6d2e 7772 6974 656c 6e28 7374 6174  eam.writeln(stat
+00014f50: 7573 290a 2020 2020 2020 2020 2020 2020  us).            
+00014f60: 2020 2020 7365 6c66 2e73 7472 6561 6d2e      self.stream.
+00014f70: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
+00014f80: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
+00014f90: 776c 696e 6520 3d20 5472 7565 0a0a 2020  wline = True..  
+00014fa0: 2020 2020 2020 7375 6974 6520 3d20 756e        suite = un
+00014fb0: 6974 7465 7374 2e54 6573 7453 7569 7465  ittest.TestSuite
+00014fc0: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
+00014fd0: 5f2c 2072 6571 7565 7374 2069 6e20 656e  _, request in en
+00014fe0: 756d 6572 6174 6528 7069 7065 5f72 6571  umerate(pipe_req
+00014ff0: 7565 7374 735f 746f 5f63 6865 636b 293a  uests_to_check):
+00015000: 0a20 2020 2020 2020 2020 2020 2073 7569  .            sui
+00015010: 7465 2e61 6464 5465 7374 280a 2020 2020  te.addTest(.    
+00015020: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015030: 2e5f 6765 745f 6368 6563 6b65 7228 0a20  ._get_checker(. 
+00015040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015050: 2020 2072 6571 7565 7374 2c20 6368 6563     request, chec
+00015060: 6b65 725f 7069 7065 5f6e 616d 652c 2074  ker_pipe_name, t
+00015070: 6f6b 656e 2c20 6f6e 6c79 5f72 6573 706f  oken, only_respo
+00015080: 6e73 655f 7469 6d65 732c 2069 676e 6f72  nse_times, ignor
+00015090: 655f 6f72 6465 722c 2076 616c 6964 6174  e_order, validat
+000150a0: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
+000150b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000150c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000150d0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+000150e0: 7420 3d20 5069 7065 4368 6563 6b65 7254  t = PipeCheckerT
+000150f0: 6578 7454 6573 7452 6573 756c 7428 0a20  extTestResult(. 
+00015100: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015110: 6368 6563 6b65 725f 7374 7265 616d 5f72  checker_stream_r
+00015120: 6573 756c 745f 636c 6173 7328 7379 732e  esult_class(sys.
+00015130: 7374 646f 7574 292c 2064 6573 6372 6970  stdout), descrip
+00015140: 7469 6f6e 733d 5472 7565 2c20 7665 7262  tions=True, verb
+00015150: 6f73 6974 793d 322c 2063 7573 746f 6d5f  osity=2, custom_
+00015160: 6f75 7470 7574 3d63 7573 746f 6d5f 6f75  output=custom_ou
+00015170: 7470 7574 0a20 2020 2020 2020 2029 0a20  tput.        ). 
+00015180: 2020 2020 2020 2072 6573 756c 742e 6661         result.fa
+00015190: 696c 6661 7374 203d 2066 6169 6c66 6173  ilfast = failfas
+000151a0: 740a 2020 2020 2020 2020 7375 6974 652e  t.        suite.
+000151b0: 7275 6e28 7265 7375 6c74 290a 0a20 2020  run(result)..   
+000151c0: 2020 2020 206d 6574 7269 6373 5f73 756d       metrics_sum
+000151d0: 6d61 7279 3a20 4f70 7469 6f6e 616c 5b44  mary: Optional[D
+000151e0: 6963 745b 7374 722c 2041 6e79 5d5d 203d  ict[str, Any]] =
+000151f0: 204e 6f6e 650a 2020 2020 2020 2020 6d65   None.        me
+00015200: 7472 6963 735f 7469 6d69 6e67 3a20 4469  trics_timing: Di
+00015210: 6374 5b73 7472 2c20 5475 706c 655b 666c  ct[str, Tuple[fl
+00015220: 6f61 742c 2066 6c6f 6174 2c20 666c 6f61  oat, float, floa
+00015230: 745d 5d20 3d20 7b7d 0a0a 2020 2020 2020  t]] = {}..      
+00015240: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00015250: 2020 2063 7572 7265 6e74 5f72 6573 706f     current_respo
+00015260: 6e73 655f 7469 6d65 733a 204c 6973 745b  nse_times: List[
+00015270: 666c 6f61 745d 203d 205b 5d0a 2020 2020  float] = [].    
+00015280: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00015290: 7265 7370 6f6e 7365 5f74 696d 6573 3a20  response_times: 
+000152a0: 4c69 7374 5b66 6c6f 6174 5d20 3d20 5b5d  List[float] = []
+000152b0: 0a0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
+000152c0: 7272 656e 745f 7265 6164 5f62 7974 6573  rrent_read_bytes
+000152d0: 3a20 4c69 7374 5b69 6e74 5d20 3d20 5b5d  : List[int] = []
+000152e0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
+000152f0: 636b 6572 5f72 6561 645f 6279 7465 733a  cker_read_bytes:
+00015300: 204c 6973 745b 696e 745d 203d 205b 5d0a   List[int] = [].
+00015310: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00015320: 6573 756c 742e 7375 6363 6573 733a 0a20  esult.success:. 
+00015330: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00015340: 6f72 2074 6573 7420 696e 2072 6573 756c  or test in resul
+00015350: 742e 7375 6363 6573 733a 0a20 2020 2020  t.success:.     
+00015360: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00015370: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
+00015380: 7469 6d65 732e 6170 7065 6e64 2874 6573  times.append(tes
+00015390: 742e 6375 7272 656e 745f 7265 7370 6f6e  t.current_respon
+000153a0: 7365 5f74 696d 6529 0a20 2020 2020 2020  se_time).       
+000153b0: 2020 2020 2020 2020 2020 2020 2063 6865               che
+000153c0: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
+000153d0: 6d65 732e 6170 7065 6e64 2874 6573 742e  mes.append(test.
+000153e0: 6368 6563 6b65 725f 7265 7370 6f6e 7365  checker_response
+000153f0: 5f74 696d 6529 0a0a 2020 2020 2020 2020  _time)..        
+00015400: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00015410: 656e 745f 7265 6164 5f62 7974 6573 2e61  ent_read_bytes.a
+00015420: 7070 656e 6428 7465 7374 2e63 7572 7265  ppend(test.curre
+00015430: 6e74 5f72 6561 645f 6279 7465 7329 0a20  nt_read_bytes). 
+00015440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015450: 2020 2063 6865 636b 6572 5f72 6561 645f     checker_read_
+00015460: 6279 7465 732e 6170 7065 6e64 2874 6573  bytes.append(tes
+00015470: 742e 6368 6563 6b65 725f 7265 6164 5f62  t.checker_read_b
+00015480: 7974 6573 290a 0a20 2020 2020 2020 2020  ytes)..         
+00015490: 2020 2020 2020 2066 6f72 2074 6573 742c         for test,
+000154a0: 205f 2069 6e20 7265 7375 6c74 2e66 6169   _ in result.fai
+000154b0: 6c75 7265 733a 2020 2320 7479 7065 3a20  lures:  # type: 
+000154c0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+000154d0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+000154e0: 6e74 5f72 6573 706f 6e73 655f 7469 6d65  nt_response_time
+000154f0: 732e 6170 7065 6e64 2874 6573 742e 6375  s.append(test.cu
+00015500: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
+00015510: 696d 6529 0a20 2020 2020 2020 2020 2020  ime).           
+00015520: 2020 2020 2020 2020 2063 6865 636b 6572           checker
+00015530: 5f72 6573 706f 6e73 655f 7469 6d65 732e  _response_times.
+00015540: 6170 7065 6e64 2874 6573 742e 6368 6563  append(test.chec
+00015550: 6b65 725f 7265 7370 6f6e 7365 5f74 696d  ker_response_tim
+00015560: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00015570: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00015580: 7265 6164 5f62 7974 6573 2e61 7070 656e  read_bytes.appen
+00015590: 6428 7465 7374 2e63 7572 7265 6e74 5f72  d(test.current_r
+000155a0: 6561 645f 6279 7465 7329 0a20 2020 2020  ead_bytes).     
+000155b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000155c0: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
+000155d0: 732e 6170 7065 6e64 2874 6573 742e 6368  s.append(test.ch
+000155e0: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
+000155f0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00015600: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015610: 2020 2020 2320 6966 2077 6520 646f 206e      # if we do n
+00015620: 6f74 2068 6176 6520 616e 7920 7375 6363  ot have any succ
+00015630: 6573 7366 756c 2065 7865 6375 7469 6f6e  essful execution
+00015640: 2c20 6c65 7427 7320 6a75 7374 2072 6574  , let's just ret
+00015650: 7572 6e20 6120 7461 626c 6520 7769 7468  urn a table with
+00015660: 2064 756d 6d79 206d 6574 7269 6373 2068   dummy metrics h
+00015670: 7474 7073 3a2f 2f67 6974 6c61 622e 636f  ttps://gitlab.co
+00015680: 6d2f 7469 6e79 6269 7264 2f61 6e61 6c79  m/tinybird/analy
+00015690: 7469 6373 2f2d 2f69 7373 7565 732f 3130  tics/-/issues/10
+000156a0: 3837 350a 2020 2020 2020 2020 2020 2020  875.            
+000156b0: 2020 2020 6375 7272 656e 745f 7265 7370      current_resp
+000156c0: 6f6e 7365 5f74 696d 6573 203d 205b 305d  onse_times = [0]
+000156d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000156e0: 2063 6865 636b 6572 5f72 6573 706f 6e73   checker_respons
+000156f0: 655f 7469 6d65 7320 3d20 5b30 5d0a 0a20  e_times = [0].. 
+00015700: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00015710: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
+00015720: 7320 3d20 5b30 5d0a 2020 2020 2020 2020  s = [0].        
+00015730: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00015740: 7265 6164 5f62 7974 6573 203d 205b 305d  read_bytes = [0]
+00015750: 0a0a 2020 2020 2020 2020 2020 2020 6d65  ..            me
+00015760: 7472 6963 735f 7375 6d6d 6172 7920 3d20  trics_summary = 
+00015770: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00015780: 2020 2272 756e 223a 2072 6573 756c 742e    "run": result.
+00015790: 7465 7374 7352 756e 2c0a 2020 2020 2020  testsRun,.      
+000157a0: 2020 2020 2020 2020 2020 2270 6173 7365            "passe
+000157b0: 6422 3a20 6c65 6e28 7265 7375 6c74 2e73  d": len(result.s
+000157c0: 7563 6365 7373 292c 0a20 2020 2020 2020  uccess),.       
+000157d0: 2020 2020 2020 2020 2022 6661 696c 6564           "failed
+000157e0: 223a 206c 656e 2872 6573 756c 742e 6661  ": len(result.fa
+000157f0: 696c 7572 6573 292c 0a20 2020 2020 2020  ilures),.       
+00015800: 2020 2020 2020 2020 2022 7065 7263 656e           "percen
+00015810: 7461 6765 5f70 6173 7365 6422 3a20 6c65  tage_passed": le
+00015820: 6e28 7265 7375 6c74 2e73 7563 6365 7373  n(result.success
+00015830: 2920 2a20 3130 3020 2f20 7265 7375 6c74  ) * 100 / result
+00015840: 2e74 6573 7473 5275 6e2c 0a20 2020 2020  .testsRun,.     
+00015850: 2020 2020 2020 2020 2020 2022 7065 7263             "perc
+00015860: 656e 7461 6765 5f66 6169 6c65 6422 3a20  entage_failed": 
+00015870: 6c65 6e28 7265 7375 6c74 2e66 6169 6c75  len(result.failu
+00015880: 7265 7329 202a 2031 3030 202f 2072 6573  res) * 100 / res
+00015890: 756c 742e 7465 7374 7352 756e 2c0a 2020  ult.testsRun,.  
+000158a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000158b0: 2020 2020 2020 2020 6d65 7472 6963 735f          metrics_
+000158c0: 7469 6d69 6e67 203d 207b 0a20 2020 2020  timing = {.     
+000158d0: 2020 2020 2020 2020 2020 2022 6d69 6e20             "min 
+000158e0: 7265 7370 6f6e 7365 2074 696d 6522 3a20  response time": 
+000158f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00015900: 2020 2020 2020 6d69 6e28 6375 7272 656e        min(curren
+00015910: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
+00015920: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015930: 2020 2020 2020 206d 696e 2863 6865 636b         min(check
+00015940: 6572 5f72 6573 706f 6e73 655f 7469 6d65  er_response_time
+00015950: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00015960: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
+00015970: 6c74 615f 7065 7263 656e 7461 6765 286d  lta_percentage(m
+00015980: 696e 2863 6865 636b 6572 5f72 6573 706f  in(checker_respo
+00015990: 6e73 655f 7469 6d65 7329 2c20 6d69 6e28  nse_times), min(
+000159a0: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
+000159b0: 5f74 696d 6573 2929 2c0a 2020 2020 2020  _times)),.      
+000159c0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+000159d0: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
+000159e0: 7820 7265 7370 6f6e 7365 2074 696d 6522  x response time"
+000159f0: 3a20 280a 2020 2020 2020 2020 2020 2020  : (.            
+00015a00: 2020 2020 2020 2020 6d61 7828 6375 7272          max(curr
+00015a10: 656e 745f 7265 7370 6f6e 7365 5f74 696d  ent_response_tim
+00015a20: 6573 292c 0a20 2020 2020 2020 2020 2020  es),.           
+00015a30: 2020 2020 2020 2020 206d 6178 2863 6865           max(che
+00015a40: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
+00015a50: 6d65 7329 2c0a 2020 2020 2020 2020 2020  mes),.          
+00015a60: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00015a70: 6465 6c74 615f 7065 7263 656e 7461 6765  delta_percentage
+00015a80: 286d 6178 2863 6865 636b 6572 5f72 6573  (max(checker_res
+00015a90: 706f 6e73 655f 7469 6d65 7329 2c20 6d61  ponse_times), ma
+00015aa0: 7828 6375 7272 656e 745f 7265 7370 6f6e  x(current_respon
+00015ab0: 7365 5f74 696d 6573 2929 2c0a 2020 2020  se_times)),.    
+00015ac0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00015ad0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015ae0: 6d65 616e 2072 6573 706f 6e73 6520 7469  mean response ti
+00015af0: 6d65 223a 2028 0a20 2020 2020 2020 2020  me": (.         
+00015b00: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00015b10: 2866 6f72 6d61 7428 6d65 616e 2863 7572  (format(mean(cur
+00015b20: 7265 6e74 5f72 6573 706f 6e73 655f 7469  rent_response_ti
+00015b30: 6d65 7329 2c20 222e 3666 2229 292c 0a20  mes), ".6f")),. 
+00015b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b50: 2020 2066 6c6f 6174 2866 6f72 6d61 7428     float(format(
+00015b60: 6d65 616e 2863 6865 636b 6572 5f72 6573  mean(checker_res
+00015b70: 706f 6e73 655f 7469 6d65 7329 2c20 222e  ponse_times), ".
+00015b80: 3666 2229 292c 0a20 2020 2020 2020 2020  6f")),.         
+00015b90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015ba0: 5f64 656c 7461 5f70 6572 6365 6e74 6167  _delta_percentag
+00015bb0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00015bc0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00015bd0: 2866 6f72 6d61 7428 6d65 616e 2863 6865  (format(mean(che
+00015be0: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
+00015bf0: 6d65 7329 2c20 222e 3666 2229 292c 0a20  mes), ".6f")),. 
+00015c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c10: 2020 2020 2020 2066 6c6f 6174 2866 6f72         float(for
+00015c20: 6d61 7428 6d65 616e 2863 7572 7265 6e74  mat(mean(current
+00015c30: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
+00015c40: 2c20 222e 3666 2229 292c 0a20 2020 2020  , ".6f")),.     
+00015c50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00015c60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015c70: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00015c80: 2020 2020 2022 6d65 6469 616e 2072 6573       "median res
+00015c90: 706f 6e73 6520 7469 6d65 223a 2028 0a20  ponse time": (. 
+00015ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cb0: 2020 206d 6564 6961 6e28 6375 7272 656e     median(curren
+00015cc0: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
+00015cd0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015ce0: 2020 2020 2020 206d 6564 6961 6e28 6368         median(ch
+00015cf0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+00015d00: 696d 6573 292c 0a20 2020 2020 2020 2020  imes),.         
+00015d10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015d20: 5f64 656c 7461 5f70 6572 6365 6e74 6167  _delta_percentag
+00015d30: 6528 6d65 6469 616e 2863 6865 636b 6572  e(median(checker
+00015d40: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
+00015d50: 2c20 6d65 6469 616e 2863 7572 7265 6e74  , median(current
+00015d60: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
+00015d70: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015d80: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00015d90: 2020 2020 2020 2270 3930 2072 6573 706f        "p90 respo
+00015da0: 6e73 6520 7469 6d65 223a 2028 0a20 2020  nse time": (.   
 00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dc0: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
-00015dd0: 6573 203d 205b 305d 0a20 2020 2020 2020  es = [0].       
-00015de0: 2020 2020 2020 2020 2063 6865 636b 6572           checker
-00015df0: 5f72 6561 645f 6279 7465 7320 3d20 5b30  _read_bytes = [0
-00015e00: 5d0a 0a20 2020 2020 2020 2020 2020 206d  ]..            m
-00015e10: 6574 7269 6373 5f73 756d 6d61 7279 203d  etrics_summary =
-00015e20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00015e30: 2020 2022 7275 6e22 3a20 7265 7375 6c74     "run": result
-00015e40: 2e74 6573 7473 5275 6e2c 0a20 2020 2020  .testsRun,.     
-00015e50: 2020 2020 2020 2020 2020 2022 7061 7373             "pass
-00015e60: 6564 223a 206c 656e 2872 6573 756c 742e  ed": len(result.
-00015e70: 7375 6363 6573 7329 2c0a 2020 2020 2020  success),.      
-00015e80: 2020 2020 2020 2020 2020 2266 6169 6c65            "faile
-00015e90: 6422 3a20 6c65 6e28 7265 7375 6c74 2e66  d": len(result.f
-00015ea0: 6169 6c75 7265 7329 2c0a 2020 2020 2020  ailures),.      
-00015eb0: 2020 2020 2020 2020 2020 2270 6572 6365            "perce
-00015ec0: 6e74 6167 655f 7061 7373 6564 223a 206c  ntage_passed": l
-00015ed0: 656e 2872 6573 756c 742e 7375 6363 6573  en(result.succes
-00015ee0: 7329 202a 2031 3030 202f 2072 6573 756c  s) * 100 / resul
-00015ef0: 742e 7465 7374 7352 756e 2c0a 2020 2020  t.testsRun,.    
-00015f00: 2020 2020 2020 2020 2020 2020 2270 6572              "per
-00015f10: 6365 6e74 6167 655f 6661 696c 6564 223a  centage_failed":
-00015f20: 206c 656e 2872 6573 756c 742e 6661 696c   len(result.fail
-00015f30: 7572 6573 2920 2a20 3130 3020 2f20 7265  ures) * 100 / re
-00015f40: 7375 6c74 2e74 6573 7473 5275 6e2c 0a20  sult.testsRun,. 
-00015f50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00015f60: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
-00015f70: 5f74 696d 696e 6720 3d20 7b0a 2020 2020  _timing = {.    
-00015f80: 2020 2020 2020 2020 2020 2020 226d 696e              "min
-00015f90: 2072 6573 706f 6e73 6520 7469 6d65 223a   response time":
-00015fa0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00015fb0: 2020 2020 2020 206d 696e 2863 7572 7265         min(curre
-00015fc0: 6e74 5f72 6573 706f 6e73 655f 7469 6d65  nt_response_time
-00015fd0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00015fe0: 2020 2020 2020 2020 6d69 6e28 6368 6563          min(chec
-00015ff0: 6b65 725f 7265 7370 6f6e 7365 5f74 696d  ker_response_tim
-00016000: 6573 292c 0a20 2020 2020 2020 2020 2020  es),.           
-00016010: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-00016020: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
-00016030: 6d69 6e28 6368 6563 6b65 725f 7265 7370  min(checker_resp
-00016040: 6f6e 7365 5f74 696d 6573 292c 206d 696e  onse_times), min
-00016050: 2863 7572 7265 6e74 5f72 6573 706f 6e73  (current_respons
-00016060: 655f 7469 6d65 7329 292c 0a20 2020 2020  e_times)),.     
-00016070: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00016080: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00016090: 6178 2072 6573 706f 6e73 6520 7469 6d65  ax response time
-000160a0: 223a 2028 0a20 2020 2020 2020 2020 2020  ": (.           
-000160b0: 2020 2020 2020 2020 206d 6178 2863 7572           max(cur
-000160c0: 7265 6e74 5f72 6573 706f 6e73 655f 7469  rent_response_ti
-000160d0: 6d65 7329 2c0a 2020 2020 2020 2020 2020  mes),.          
-000160e0: 2020 2020 2020 2020 2020 6d61 7828 6368            max(ch
-000160f0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-00016100: 696d 6573 292c 0a20 2020 2020 2020 2020  imes),.         
-00016110: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016120: 5f64 656c 7461 5f70 6572 6365 6e74 6167  _delta_percentag
-00016130: 6528 6d61 7828 6368 6563 6b65 725f 7265  e(max(checker_re
-00016140: 7370 6f6e 7365 5f74 696d 6573 292c 206d  sponse_times), m
-00016150: 6178 2863 7572 7265 6e74 5f72 6573 706f  ax(current_respo
-00016160: 6e73 655f 7469 6d65 7329 292c 0a20 2020  nse_times)),.   
-00016170: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00016180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016190: 226d 6561 6e20 7265 7370 6f6e 7365 2074  "mean response t
-000161a0: 696d 6522 3a20 280a 2020 2020 2020 2020  ime": (.        
-000161b0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-000161c0: 7428 666f 726d 6174 286d 6561 6e28 6375  t(format(mean(cu
-000161d0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
-000161e0: 696d 6573 292c 2022 2e36 6622 2929 2c0a  imes), ".6f")),.
-000161f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016200: 2020 2020 666c 6f61 7428 666f 726d 6174      float(format
-00016210: 286d 6561 6e28 6368 6563 6b65 725f 7265  (mean(checker_re
-00016220: 7370 6f6e 7365 5f74 696d 6573 292c 2022  sponse_times), "
-00016230: 2e36 6622 2929 2c0a 2020 2020 2020 2020  .6f")),.        
-00016240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016250: 2e5f 6465 6c74 615f 7065 7263 656e 7461  ._delta_percenta
-00016260: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-00016270: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00016280: 7428 666f 726d 6174 286d 6561 6e28 6368  t(format(mean(ch
-00016290: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-000162a0: 696d 6573 292c 2022 2e36 6622 2929 2c0a  imes), ".6f")),.
+00015dc0: 2073 6f72 7465 6428 6375 7272 656e 745f   sorted(current_
+00015dd0: 7265 7370 6f6e 7365 5f74 696d 6573 295b  response_times)[
+00015de0: 6d61 7468 2e63 6569 6c28 6c65 6e28 6375  math.ceil(len(cu
+00015df0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
+00015e00: 696d 6573 2920 2a20 302e 3929 202d 2031  imes) * 0.9) - 1
+00015e10: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00015e20: 2020 2020 2020 2073 6f72 7465 6428 6368         sorted(ch
+00015e30: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+00015e40: 696d 6573 295b 6d61 7468 2e63 6569 6c28  imes)[math.ceil(
+00015e50: 6c65 6e28 6368 6563 6b65 725f 7265 7370  len(checker_resp
+00015e60: 6f6e 7365 5f74 696d 6573 2920 2a20 302e  onse_times) * 0.
+00015e70: 3929 202d 2031 5d2c 0a20 2020 2020 2020  9) - 1],.       
+00015e80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00015e90: 662e 5f64 656c 7461 5f70 6572 6365 6e74  f._delta_percent
+00015ea0: 6167 6528 0a20 2020 2020 2020 2020 2020  age(.           
+00015eb0: 2020 2020 2020 2020 2020 2020 2073 6f72               sor
+00015ec0: 7465 6428 6368 6563 6b65 725f 7265 7370  ted(checker_resp
+00015ed0: 6f6e 7365 5f74 696d 6573 295b 6d61 7468  onse_times)[math
+00015ee0: 2e63 6569 6c28 6c65 6e28 6368 6563 6b65  .ceil(len(checke
+00015ef0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
+00015f00: 2920 2a20 302e 3929 202d 2031 5d2c 0a20  ) * 0.9) - 1],. 
+00015f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f20: 2020 2020 2020 2073 6f72 7465 6428 6375         sorted(cu
+00015f30: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
+00015f40: 696d 6573 295b 6d61 7468 2e63 6569 6c28  imes)[math.ceil(
+00015f50: 6c65 6e28 6375 7272 656e 745f 7265 7370  len(current_resp
+00015f60: 6f6e 7365 5f74 696d 6573 2920 2a20 302e  onse_times) * 0.
+00015f70: 3929 202d 2031 5d2c 0a20 2020 2020 2020  9) - 1],.       
+00015f80: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00015f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fa0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015fb0: 2020 2022 6d69 6e20 7265 6164 2062 7974     "min read byt
+00015fc0: 6573 223a 2028 0a20 2020 2020 2020 2020  es": (.         
+00015fd0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00015fe0: 745f 7369 7a65 286d 696e 2863 7572 7265  t_size(min(curre
+00015ff0: 6e74 5f72 6561 645f 6279 7465 7329 292c  nt_read_bytes)),
+00016000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016010: 2020 2020 2066 6f72 6d61 745f 7369 7a65       format_size
+00016020: 286d 696e 2863 6865 636b 6572 5f72 6561  (min(checker_rea
+00016030: 645f 6279 7465 7329 292c 0a20 2020 2020  d_bytes)),.     
+00016040: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016050: 656c 662e 5f64 656c 7461 5f70 6572 6365  elf._delta_perce
+00016060: 6e74 6167 6528 6d69 6e28 6368 6563 6b65  ntage(min(checke
+00016070: 725f 7265 6164 5f62 7974 6573 292c 206d  r_read_bytes), m
+00016080: 696e 2863 7572 7265 6e74 5f72 6561 645f  in(current_read_
+00016090: 6279 7465 7329 292c 0a20 2020 2020 2020  bytes)),.       
+000160a0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+000160b0: 2020 2020 2020 2020 2020 2020 226d 6178              "max
+000160c0: 2072 6561 6420 6279 7465 7322 3a20 280a   read bytes": (.
+000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160e0: 2020 2020 666f 726d 6174 5f73 697a 6528      format_size(
+000160f0: 6d61 7828 6375 7272 656e 745f 7265 6164  max(current_read
+00016100: 5f62 7974 6573 2929 2c0a 2020 2020 2020  _bytes)),.      
+00016110: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00016120: 726d 6174 5f73 697a 6528 6d61 7828 6368  rmat_size(max(ch
+00016130: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
+00016140: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00016150: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
+00016160: 6c74 615f 7065 7263 656e 7461 6765 286d  lta_percentage(m
+00016170: 6178 2863 6865 636b 6572 5f72 6561 645f  ax(checker_read_
+00016180: 6279 7465 7329 2c20 6d61 7828 6375 7272  bytes), max(curr
+00016190: 656e 745f 7265 6164 5f62 7974 6573 2929  ent_read_bytes))
+000161a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000161b0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+000161c0: 2020 2020 2022 6d65 616e 2072 6561 6420       "mean read 
+000161d0: 6279 7465 7322 3a20 280a 2020 2020 2020  bytes": (.      
+000161e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000161f0: 726d 6174 5f73 697a 6528 6d65 616e 2863  rmat_size(mean(c
+00016200: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
+00016210: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
+00016220: 2020 2020 2020 2020 2066 6f72 6d61 745f           format_
+00016230: 7369 7a65 286d 6561 6e28 6368 6563 6b65  size(mean(checke
+00016240: 725f 7265 6164 5f62 7974 6573 2929 2c0a  r_read_bytes)),.
+00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016260: 2020 2020 7365 6c66 2e5f 6465 6c74 615f      self._delta_
+00016270: 7065 7263 656e 7461 6765 286d 6561 6e28  percentage(mean(
+00016280: 6368 6563 6b65 725f 7265 6164 5f62 7974  checker_read_byt
+00016290: 6573 292c 206d 6561 6e28 6375 7272 656e  es), mean(curren
+000162a0: 745f 7265 6164 5f62 7974 6573 2929 2c0a  t_read_bytes)),.
 000162b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162c0: 2020 2020 2020 2020 666c 6f61 7428 666f          float(fo
-000162d0: 726d 6174 286d 6561 6e28 6375 7272 656e  rmat(mean(curren
-000162e0: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
-000162f0: 292c 2022 2e36 6622 2929 2c0a 2020 2020  ), ".6f")),.    
-00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016310: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00016320: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00016330: 2020 2020 2020 226d 6564 6961 6e20 7265        "median re
-00016340: 7370 6f6e 7365 2074 696d 6522 3a20 280a  sponse time": (.
-00016350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016360: 2020 2020 6d65 6469 616e 2863 7572 7265      median(curre
-00016370: 6e74 5f72 6573 706f 6e73 655f 7469 6d65  nt_response_time
-00016380: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00016390: 2020 2020 2020 2020 6d65 6469 616e 2863          median(c
-000163a0: 6865 636b 6572 5f72 6573 706f 6e73 655f  hecker_response_
-000163b0: 7469 6d65 7329 2c0a 2020 2020 2020 2020  times),.        
-000163c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000163d0: 2e5f 6465 6c74 615f 7065 7263 656e 7461  ._delta_percenta
-000163e0: 6765 286d 6564 6961 6e28 6368 6563 6b65  ge(median(checke
-000163f0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
-00016400: 292c 206d 6564 6961 6e28 6375 7272 656e  ), median(curren
-00016410: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
-00016420: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00016430: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00016440: 2020 2020 2020 2022 7039 3020 7265 7370         "p90 resp
-00016450: 6f6e 7365 2074 696d 6522 3a20 280a 2020  onse time": (.  
-00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016470: 2020 736f 7274 6564 2863 7572 7265 6e74    sorted(current
-00016480: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
-00016490: 5b6d 6174 682e 6365 696c 286c 656e 2863  [math.ceil(len(c
-000164a0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
-000164b0: 7469 6d65 7329 202a 2030 2e39 2920 2d20  times) * 0.9) - 
-000164c0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-000164d0: 2020 2020 2020 2020 736f 7274 6564 2863          sorted(c
-000164e0: 6865 636b 6572 5f72 6573 706f 6e73 655f  hecker_response_
-000164f0: 7469 6d65 7329 5b6d 6174 682e 6365 696c  times)[math.ceil
-00016500: 286c 656e 2863 6865 636b 6572 5f72 6573  (len(checker_res
-00016510: 706f 6e73 655f 7469 6d65 7329 202a 2030  ponse_times) * 0
-00016520: 2e39 2920 2d20 315d 2c0a 2020 2020 2020  .9) - 1],.      
-00016530: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00016540: 6c66 2e5f 6465 6c74 615f 7065 7263 656e  lf._delta_percen
-00016550: 7461 6765 280a 2020 2020 2020 2020 2020  tage(.          
-00016560: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00016570: 7274 6564 2863 6865 636b 6572 5f72 6573  rted(checker_res
-00016580: 706f 6e73 655f 7469 6d65 7329 5b6d 6174  ponse_times)[mat
-00016590: 682e 6365 696c 286c 656e 2863 6865 636b  h.ceil(len(check
-000165a0: 6572 5f72 6573 706f 6e73 655f 7469 6d65  er_response_time
-000165b0: 7329 202a 2030 2e39 2920 2d20 315d 2c0a  s) * 0.9) - 1],.
-000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165d0: 2020 2020 2020 2020 736f 7274 6564 2863          sorted(c
-000165e0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
-000165f0: 7469 6d65 7329 5b6d 6174 682e 6365 696c  times)[math.ceil
-00016600: 286c 656e 2863 7572 7265 6e74 5f72 6573  (len(current_res
-00016610: 706f 6e73 655f 7469 6d65 7329 202a 2030  ponse_times) * 0
-00016620: 2e39 2920 2d20 315d 2c0a 2020 2020 2020  .9) - 1],.      
-00016630: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00016640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016650: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00016660: 2020 2020 226d 696e 2072 6561 6420 6279      "min read by
-00016670: 7465 7322 3a20 280a 2020 2020 2020 2020  tes": (.        
-00016680: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00016690: 6174 5f73 697a 6528 6d69 6e28 6375 7272  at_size(min(curr
-000166a0: 656e 745f 7265 6164 5f62 7974 6573 2929  ent_read_bytes))
-000166b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000166c0: 2020 2020 2020 666f 726d 6174 5f73 697a        format_siz
-000166d0: 6528 6d69 6e28 6368 6563 6b65 725f 7265  e(min(checker_re
-000166e0: 6164 5f62 7974 6573 2929 2c0a 2020 2020  ad_bytes)),.    
-000166f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016700: 7365 6c66 2e5f 6465 6c74 615f 7065 7263  self._delta_perc
-00016710: 656e 7461 6765 286d 696e 2863 6865 636b  entage(min(check
-00016720: 6572 5f72 6561 645f 6279 7465 7329 2c20  er_read_bytes), 
-00016730: 6d69 6e28 6375 7272 656e 745f 7265 6164  min(current_read
-00016740: 5f62 7974 6573 2929 2c0a 2020 2020 2020  _bytes)),.      
-00016750: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00016760: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
-00016770: 7820 7265 6164 2062 7974 6573 223a 2028  x read bytes": (
-00016780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016790: 2020 2020 2066 6f72 6d61 745f 7369 7a65       format_size
-000167a0: 286d 6178 2863 7572 7265 6e74 5f72 6561  (max(current_rea
-000167b0: 645f 6279 7465 7329 292c 0a20 2020 2020  d_bytes)),.     
-000167c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000167d0: 6f72 6d61 745f 7369 7a65 286d 6178 2863  ormat_size(max(c
-000167e0: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
-000167f0: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
-00016800: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-00016810: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
-00016820: 6d61 7828 6368 6563 6b65 725f 7265 6164  max(checker_read
-00016830: 5f62 7974 6573 292c 206d 6178 2863 7572  _bytes), max(cur
-00016840: 7265 6e74 5f72 6561 645f 6279 7465 7329  rent_read_bytes)
-00016850: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00016860: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00016870: 2020 2020 2020 226d 6561 6e20 7265 6164        "mean read
-00016880: 2062 7974 6573 223a 2028 0a20 2020 2020   bytes": (.     
-00016890: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000168a0: 6f72 6d61 745f 7369 7a65 286d 6561 6e28  ormat_size(mean(
-000168b0: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
-000168c0: 6573 2929 2c0a 2020 2020 2020 2020 2020  es)),.          
-000168d0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-000168e0: 5f73 697a 6528 6d65 616e 2863 6865 636b  _size(mean(check
-000168f0: 6572 5f72 6561 645f 6279 7465 7329 292c  er_read_bytes)),
-00016900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016910: 2020 2020 2073 656c 662e 5f64 656c 7461       self._delta
-00016920: 5f70 6572 6365 6e74 6167 6528 6d65 616e  _percentage(mean
-00016930: 2863 6865 636b 6572 5f72 6561 645f 6279  (checker_read_by
-00016940: 7465 7329 2c20 6d65 616e 2863 7572 7265  tes), mean(curre
-00016950: 6e74 5f72 6561 645f 6279 7465 7329 292c  nt_read_bytes)),
-00016960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016970: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00016980: 2020 2020 226d 6564 6961 6e20 7265 6164      "median read
-00016990: 2062 7974 6573 223a 2028 0a20 2020 2020   bytes": (.     
-000169a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000169b0: 6f72 6d61 745f 7369 7a65 286d 6564 6961  ormat_size(media
-000169c0: 6e28 6375 7272 656e 745f 7265 6164 5f62  n(current_read_b
-000169d0: 7974 6573 2929 2c0a 2020 2020 2020 2020  ytes)),.        
-000169e0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-000169f0: 6174 5f73 697a 6528 6d65 6469 616e 2863  at_size(median(c
-00016a00: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
-00016a10: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
-00016a20: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-00016a30: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
-00016a40: 6d65 6469 616e 2863 6865 636b 6572 5f72  median(checker_r
-00016a50: 6561 645f 6279 7465 7329 2c20 6d65 6469  ead_bytes), medi
-00016a60: 616e 2863 7572 7265 6e74 5f72 6561 645f  an(current_read_
-00016a70: 6279 7465 7329 292c 0a20 2020 2020 2020  bytes)),.       
-00016a80: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00016a90: 2020 2020 2020 2020 2020 2020 2270 3930              "p90
-00016aa0: 2072 6561 6420 6279 7465 7322 3a20 280a   read bytes": (.
-00016ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ac0: 2020 2020 666f 726d 6174 5f73 697a 6528      format_size(
-00016ad0: 736f 7274 6564 2863 7572 7265 6e74 5f72  sorted(current_r
-00016ae0: 6561 645f 6279 7465 7329 5b6d 6174 682e  ead_bytes)[math.
-00016af0: 6365 696c 286c 656e 2863 7572 7265 6e74  ceil(len(current
-00016b00: 5f72 6561 645f 6279 7465 7329 202a 2030  _read_bytes) * 0
-00016b10: 2e39 2920 2d20 315d 292c 0a20 2020 2020  .9) - 1]),.     
-00016b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00016b30: 6f72 6d61 745f 7369 7a65 2873 6f72 7465  ormat_size(sorte
-00016b40: 6428 6368 6563 6b65 725f 7265 6164 5f62  d(checker_read_b
-00016b50: 7974 6573 295b 6d61 7468 2e63 6569 6c28  ytes)[math.ceil(
-00016b60: 6c65 6e28 6368 6563 6b65 725f 7265 6164  len(checker_read
-00016b70: 5f62 7974 6573 2920 2a20 302e 3929 202d  _bytes) * 0.9) -
-00016b80: 2031 5d29 2c0a 2020 2020 2020 2020 2020   1]),.          
-00016b90: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00016ba0: 6465 6c74 615f 7065 7263 656e 7461 6765  delta_percentage
-00016bb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016bc0: 2020 2020 2020 2020 2020 736f 7274 6564            sorted
-00016bd0: 2863 6865 636b 6572 5f72 6561 645f 6279  (checker_read_by
-00016be0: 7465 7329 5b6d 6174 682e 6365 696c 286c  tes)[math.ceil(l
-00016bf0: 656e 2863 6865 636b 6572 5f72 6561 645f  en(checker_read_
-00016c00: 6279 7465 7329 202a 2030 2e39 2920 2d20  bytes) * 0.9) - 
-00016c10: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00016c20: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-00016c30: 6564 2863 7572 7265 6e74 5f72 6561 645f  ed(current_read_
-00016c40: 6279 7465 7329 5b6d 6174 682e 6365 696c  bytes)[math.ceil
-00016c50: 286c 656e 2863 7572 7265 6e74 5f72 6561  (len(current_rea
-00016c60: 645f 6279 7465 7329 202a 2030 2e39 2920  d_bytes) * 0.9) 
-00016c70: 2d20 315d 2c0a 2020 2020 2020 2020 2020  - 1],.          
-00016c80: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00016c90: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00016ca0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00016cb0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00016cc0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00016cd0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-00016ce0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00016cf0: 2020 206c 6f67 6769 6e67 2e65 7863 6570     logging.excep
-00016d00: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
-00016d10: 2066 6169 6c75 7265 7320 3d20 5b5d 0a20   failures = []. 
-00016d20: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
-00016d30: 7375 6c74 2e77 6173 5375 6363 6573 7366  sult.wasSuccessf
-00016d40: 756c 2829 3a0a 2020 2020 2020 2020 2020  ul():.          
-00016d50: 2020 666f 7220 5f74 6573 742c 2065 7272    for _test, err
-00016d60: 2069 6e20 7265 7375 6c74 2e66 6169 6c75   in result.failu
-00016d70: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-00016d80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00016d90: 2020 2020 2020 2020 2020 2020 2020 6920                i 
-00016da0: 3d20 6572 722e 696e 6465 7828 2241 7373  = err.index("Ass
-00016db0: 6572 7469 6f6e 4572 726f 7222 2920 2b20  ertionError") + 
-00016dc0: 6c65 6e28 2241 7373 6572 7469 6f6e 4572  len("AssertionEr
-00016dd0: 726f 7220 3a22 290a 2020 2020 2020 2020  ror :").        
-00016de0: 2020 2020 2020 2020 2020 2020 6661 696c              fail
-00016df0: 7572 6573 2e61 7070 656e 6428 7b22 6e61  ures.append({"na
-00016e00: 6d65 223a 2073 7472 285f 7465 7374 292c  me": str(_test),
-00016e10: 2022 6572 726f 7222 3a20 6572 725b 693a   "error": err[i:
-00016e20: 5d7d 290a 2020 2020 2020 2020 2020 2020  ]}).            
-00016e30: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00016e40: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00016e50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016e60: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e80: 206c 6f67 6769 6e67 2e65 7863 6570 7469   logging.excepti
-00016e90: 6f6e 2865 290a 0a20 2020 2020 2020 2072  on(e)..        r
-00016ea0: 6574 7572 6e20 5069 7065 4368 6563 6b65  eturn PipeChecke
-00016eb0: 7252 756e 6e65 7252 6573 706f 6e73 6528  rRunnerResponse(
-00016ec0: 0a20 2020 2020 2020 2020 2020 2070 6970  .            pip
-00016ed0: 655f 6e61 6d65 3d63 6865 636b 6572 5f70  e_name=checker_p
-00016ee0: 6970 655f 6e61 6d65 2c0a 2020 2020 2020  ipe_name,.      
-00016ef0: 2020 2020 2020 7465 7374 5f74 7970 653d        test_type=
-00016f00: 6765 7461 7474 7228 7365 6c66 2c20 2274  getattr(self, "t
-00016f10: 6573 745f 7479 7065 222c 2022 2229 2c0a  est_type", ""),.
-00016f20: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-00016f30: 7574 3d67 6574 6174 7472 2872 6573 756c  ut=getattr(resul
-00016f40: 742e 7374 7265 616d 2c20 225f 6275 6666  t.stream, "_buff
-00016f50: 6572 222c 2022 2229 2c0a 2020 2020 2020  er", ""),.      
-00016f60: 2020 2020 2020 6d65 7472 6963 735f 7375        metrics_su
-00016f70: 6d6d 6172 793d 6d65 7472 6963 735f 7375  mmary=metrics_su
-00016f80: 6d6d 6172 792c 0a20 2020 2020 2020 2020  mmary,.         
-00016f90: 2020 206d 6574 7269 6373 5f74 696d 696e     metrics_timin
-00016fa0: 673d 6d65 7472 6963 735f 7469 6d69 6e67  g=metrics_timing
-00016fb0: 2c0a 2020 2020 2020 2020 2020 2020 6661  ,.            fa
-00016fc0: 696c 6564 3d66 6169 6c75 7265 732c 0a20  iled=failures,. 
-00016fd0: 2020 2020 2020 2020 2020 2077 6173 5f73             was_s
-00016fe0: 7563 6365 7373 6675 6c6c 3d72 6573 756c  uccessfull=resul
-00016ff0: 742e 7761 7353 7563 6365 7373 6675 6c28  t.wasSuccessful(
-00017000: 292c 0a20 2020 2020 2020 2029 0a0a 0a61  ),.        )...a
-00017010: 7379 6e63 2064 6566 2063 6865 636b 5f70  sync def check_p
-00017020: 6970 6528 0a20 2020 2070 6970 652c 0a20  ipe(.    pipe,. 
-00017030: 2020 2068 6f73 743a 2073 7472 2c0a 2020     host: str,.  
-00017040: 2020 746f 6b65 6e3a 2073 7472 2c0a 2020    token: str,.  
-00017050: 2020 706f 7075 6c61 7465 3a20 626f 6f6c    populate: bool
-00017060: 2c0a 2020 2020 636c 3a20 5469 6e79 422c  ,.    cl: TinyB,
-00017070: 0a20 2020 206c 696d 6974 3a20 696e 7420  .    limit: int 
-00017080: 3d20 302c 0a20 2020 2073 616d 706c 655f  = 0,.    sample_
-00017090: 6279 5f70 6172 616d 733a 2069 6e74 203d  by_params: int =
-000170a0: 2030 2c0a 2020 2020 6f6e 6c79 5f72 6573   0,.    only_res
-000170b0: 706f 6e73 655f 7469 6d65 733d 4661 6c73  ponse_times=Fals
-000170c0: 652c 0a20 2020 206d 6174 6368 6573 3a20  e,.    matches: 
-000170d0: 4f70 7469 6f6e 616c 5b4c 6973 745b 7374  Optional[List[st
-000170e0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-000170f0: 6661 696c 6661 7374 3a20 626f 6f6c 203d  failfast: bool =
-00017100: 2046 616c 7365 2c0a 2020 2020 7661 6c69   False,.    vali
-00017110: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
-00017120: 7974 6573 3a20 626f 6f6c 203d 2046 616c  ytes: bool = Fal
-00017130: 7365 2c0a 2020 2020 6967 6e6f 7265 5f6f  se,.    ignore_o
-00017140: 7264 6572 3a20 626f 6f6c 203d 2046 616c  rder: bool = Fal
-00017150: 7365 2c0a 2020 2020 746f 6b65 6e5f 666f  se,.    token_fo
-00017160: 725f 7265 7175 6573 7473 5f74 6f5f 6368  r_requests_to_ch
-00017170: 6563 6b3a 204f 7074 696f 6e61 6c5b 7374  eck: Optional[st
-00017180: 725d 203d 204e 6f6e 652c 0a20 2020 2063  r] = None,.    c
-00017190: 7572 7265 6e74 5f70 6970 653a 204f 7074  urrent_pipe: Opt
-000171a0: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
-000171b0: 416e 795d 5d20 3d20 4e6f 6e65 2c0a 293a  Any]] = None,.):
-000171c0: 0a20 2020 2063 6865 636b 6572 5f70 6970  .    checker_pip
-000171d0: 6520 3d20 6465 6570 636f 7079 2870 6970  e = deepcopy(pip
-000171e0: 6529 0a20 2020 2063 6865 636b 6572 5f70  e).    checker_p
-000171f0: 6970 655b 226e 616d 6522 5d20 3d20 6622  ipe["name"] = f"
-00017200: 7b63 6865 636b 6572 5f70 6970 655b 276e  {checker_pipe['n
-00017210: 616d 6527 5d7d 5f5f 6368 6563 6b65 7222  ame']}__checker"
-00017220: 0a0a 2020 2020 6966 2063 7572 7265 6e74  ..    if current
-00017230: 5f70 6970 653a 0a20 2020 2020 2020 2070  _pipe:.        p
-00017240: 6970 655f 7479 7065 203d 2063 7572 7265  ipe_type = curre
-00017250: 6e74 5f70 6970 655b 2274 7970 6522 5d0a  nt_pipe["type"].
-00017260: 2020 2020 2020 2020 6966 2070 6970 655f          if pipe_
-00017270: 7479 7065 203d 3d20 5069 7065 5479 7065  type == PipeType
-00017280: 732e 434f 5059 3a0a 2020 2020 2020 2020  s.COPY:.        
-00017290: 2020 2020 6177 6169 7420 636c 2e70 6970      await cl.pip
-000172a0: 655f 7265 6d6f 7665 5f63 6f70 7928 6375  e_remove_copy(cu
-000172b0: 7272 656e 745f 7069 7065 5b22 6964 225d  rrent_pipe["id"]
-000172c0: 2c20 6375 7272 656e 745f 7069 7065 5b22  , current_pipe["
-000172d0: 636f 7079 5f6e 6f64 6522 5d29 0a20 2020  copy_node"]).   
-000172e0: 2020 2020 2069 6620 7069 7065 5f74 7970       if pipe_typ
-000172f0: 6520 3d3d 2050 6970 6554 7970 6573 2e44  e == PipeTypes.D
-00017300: 4154 415f 5349 4e4b 3a0a 2020 2020 2020  ATA_SINK:.      
-00017310: 2020 2020 2020 6177 6169 7420 636c 2e70        await cl.p
-00017320: 6970 655f 7265 6d6f 7665 5f73 696e 6b28  ipe_remove_sink(
-00017330: 6375 7272 656e 745f 7069 7065 5b22 6964  current_pipe["id
-00017340: 225d 2c20 6375 7272 656e 745f 7069 7065  "], current_pipe
-00017350: 5b22 7369 6e6b 5f6e 6f64 6522 5d29 0a0a  ["sink_node"])..
-00017360: 2020 2020 2320 496e 2063 6173 6520 6f66      # In case of
-00017370: 2064 6f69 6e67 202d 2d66 6f72 6365 2066   doing --force f
-00017380: 6f72 2061 206d 6174 6572 6961 6c69 7a65  or a materialize
-00017390: 6420 7669 6577 2c20 6368 6563 6b65 7220  d view, checker 
-000173a0: 6973 2062 6569 6e67 2063 7265 6174 6564  is being created
-000173b0: 2061 7320 7374 616e 6461 7264 2070 6970   as standard pip
-000173c0: 650a 2020 2020 666f 7220 6e6f 6465 2069  e.    for node i
-000173d0: 6e20 6368 6563 6b65 725f 7069 7065 5b22  n checker_pipe["
-000173e0: 6e6f 6465 7322 5d3a 0a20 2020 2020 2020  nodes"]:.       
-000173f0: 206e 6f64 655b 2270 6172 616d 7322 5d5b   node["params"][
-00017400: 2274 7970 6522 5d20 3d20 5069 7065 4e6f  "type"] = PipeNo
-00017410: 6465 5479 7065 732e 5354 414e 4441 5244  deTypes.STANDARD
-00017420: 0a0a 2020 2020 6966 2070 6f70 756c 6174  ..    if populat
-00017430: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
-00017440: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-00017450: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-00017460: 6e61 6765 722e 6572 726f 725f 6368 6563  nager.error_chec
-00017470: 6b5f 7069 7065 735f 706f 7075 6c61 7465  k_pipes_populate
-00017480: 2829 290a 0a20 2020 2072 756e 6e65 7220  ())..    runner 
-00017490: 3d20 5069 7065 4368 6563 6b65 7252 756e  = PipeCheckerRun
-000174a0: 6e65 7228 7069 7065 5b22 6e61 6d65 225d  ner(pipe["name"]
-000174b0: 2c20 686f 7374 290a 2020 2020 6865 6164  , host).    head
-000174c0: 6572 7320 3d20 280a 2020 2020 2020 2020  ers = (.        
-000174d0: 7b22 4175 7468 6f72 697a 6174 696f 6e22  {"Authorization"
-000174e0: 3a20 6622 4265 6172 6572 207b 746f 6b65  : f"Bearer {toke
-000174f0: 6e5f 666f 725f 7265 7175 6573 7473 5f74  n_for_requests_t
-00017500: 6f5f 6368 6563 6b7d 227d 0a20 2020 2020  o_check}"}.     
-00017510: 2020 2069 6620 746f 6b65 6e5f 666f 725f     if token_for_
-00017520: 7265 7175 6573 7473 5f74 6f5f 6368 6563  requests_to_chec
-00017530: 6b0a 2020 2020 2020 2020 656c 7365 207b  k.        else {
-00017540: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
-00017550: 2066 2242 6561 7265 7220 7b74 6f6b 656e   f"Bearer {token
-00017560: 7d22 7d0a 2020 2020 290a 0a20 2020 2073  }"}.    )..    s
-00017570: 716c 5f66 6f72 5f63 6f76 6572 6167 652c  ql_for_coverage,
-00017580: 2073 716c 5f6c 6174 6573 745f 7265 7175   sql_latest_requ
-00017590: 6573 7473 203d 2072 756e 6e65 722e 6765  ests = runner.ge
-000175a0: 745f 7371 6c73 5f66 6f72 5f72 6571 7565  t_sqls_for_reque
-000175b0: 7374 735f 746f 5f63 6865 636b 280a 2020  sts_to_check(.  
-000175c0: 2020 2020 2020 6d61 7463 6865 7320 6f72        matches or
-000175d0: 205b 5d2c 2073 616d 706c 655f 6279 5f70   [], sample_by_p
-000175e0: 6172 616d 732c 206c 696d 6974 0a20 2020  arams, limit.   
-000175f0: 2029 0a0a 2020 2020 7061 7261 6d73 203d   )..    params =
-00017600: 207b 2271 223a 2073 716c 5f66 6f72 5f63   {"q": sql_for_c
-00017610: 6f76 6572 6167 6520 6966 206c 696d 6974  overage if limit
-00017620: 203d 3d20 3020 616e 6420 7361 6d70 6c65   == 0 and sample
-00017630: 5f62 795f 7061 7261 6d73 203e 2030 2065  _by_params > 0 e
-00017640: 6c73 6520 7371 6c5f 6c61 7465 7374 5f72  lse sql_latest_r
-00017650: 6571 7565 7374 737d 0a20 2020 2072 3a20  equests}.    r: 
-00017660: 7265 7175 6573 7473 2e52 6573 706f 6e73  requests.Respons
-00017670: 6520 3d20 6177 6169 7420 7265 7175 6573  e = await reques
-00017680: 7473 5f67 6574 280a 2020 2020 2020 2020  ts_get(.        
-00017690: 6622 7b68 6f73 747d 2f76 302f 7371 6c3f  f"{host}/v0/sql?
-000176a0: 7b75 726c 656e 636f 6465 2870 6172 616d  {urlencode(param
-000176b0: 7329 7d22 2c20 6865 6164 6572 733d 6865  s)}", headers=he
-000176c0: 6164 6572 732c 2076 6572 6966 793d 6e6f  aders, verify=no
-000176d0: 7420 6765 7465 6e76 5f62 6f6f 6c28 2254  t getenv_bool("T
-000176e0: 425f 4449 5341 424c 455f 5353 4c5f 4348  B_DISABLE_SSL_CH
-000176f0: 4543 4b53 222c 2046 616c 7365 290a 2020  ECKS", False).  
-00017700: 2020 290a 0a20 2020 2023 2049 6620 7765    )..    # If we
-00017710: 2067 6574 2061 2074 696d 656f 7574 2c20   get a timeout, 
-00017720: 6661 6c6c 6261 636b 2074 6f20 6a75 7374  fallback to just
-00017730: 2074 6865 206c 6173 7420 7265 7175 6573   the last reques
-00017740: 7473 0a0a 2020 2020 6966 206e 6f74 2072  ts..    if not r
-00017750: 206f 7220 722e 7374 6174 7573 5f63 6f64   or r.status_cod
-00017760: 6520 3d3d 2034 3038 3a0a 2020 2020 2020  e == 408:.      
-00017770: 2020 7061 7261 6d73 203d 207b 2271 223a    params = {"q":
-00017780: 2073 716c 5f6c 6174 6573 745f 7265 7175   sql_latest_requ
-00017790: 6573 7473 7d0a 2020 2020 2020 2020 7220  ests}.        r 
-000177a0: 3d20 6177 6169 7420 7265 7175 6573 7473  = await requests
-000177b0: 5f67 6574 280a 2020 2020 2020 2020 2020  _get(.          
-000177c0: 2020 6622 7b68 6f73 747d 2f76 302f 7371    f"{host}/v0/sq
-000177d0: 6c3f 7b75 726c 656e 636f 6465 2870 6172  l?{urlencode(par
-000177e0: 616d 7329 7d22 2c0a 2020 2020 2020 2020  ams)}",.        
-000177f0: 2020 2020 6865 6164 6572 733d 6865 6164      headers=head
-00017800: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-00017810: 2076 6572 6966 793d 6e6f 7420 6765 7465   verify=not gete
-00017820: 6e76 5f62 6f6f 6c28 2254 425f 4449 5341  nv_bool("TB_DISA
-00017830: 424c 455f 5353 4c5f 4348 4543 4b53 222c  BLE_SSL_CHECKS",
-00017840: 2046 616c 7365 292c 0a20 2020 2020 2020   False),.       
-00017850: 2029 0a0a 2020 2020 6966 206e 6f74 2072   )..    if not r
-00017860: 206f 7220 722e 7374 6174 7573 5f63 6f64   or r.status_cod
-00017870: 6520 213d 2032 3030 3a0a 2020 2020 2020  e != 200:.      
-00017880: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-00017890: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
-000178a0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-000178b0: 6f72 5f63 6865 636b 5f70 6970 6573 5f61  or_check_pipes_a
-000178c0: 7069 2870 6970 653d 7069 7065 5b22 6e61  pi(pipe=pipe["na
-000178d0: 6d65 225d 2929 0a0a 2020 2020 7069 7065  me"]))..    pipe
-000178e0: 5f72 6571 7565 7374 735f 746f 5f63 6865  _requests_to_che
-000178f0: 636b 3a20 4c69 7374 5b44 6963 745b 7374  ck: List[Dict[st
-00017900: 722c 2041 6e79 5d5d 203d 205b 5d0a 2020  r, Any]] = [].  
-00017910: 2020 666f 7220 726f 7720 696e 2072 2e6a    for row in r.j
-00017920: 736f 6e28 292e 6765 7428 2264 6174 6122  son().get("data"
-00017930: 2c20 5b5d 293a 0a20 2020 2020 2020 2066  , []):.        f
-00017940: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-00017950: 6e28 726f 775b 2265 6e64 706f 696e 745f  n(row["endpoint_
-00017960: 7572 6c22 5d29 293a 0a20 2020 2020 2020  url"])):.       
-00017970: 2020 2020 2070 6970 655f 7265 7175 6573       pipe_reques
-00017980: 7473 5f74 6f5f 6368 6563 6b20 2b3d 205b  ts_to_check += [
-00017990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000179a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000179b0: 2020 2020 2020 2022 656e 6470 6f69 6e74         "endpoint
-000179c0: 5f75 726c 223a 2066 227b 686f 7374 7d7b  _url": f"{host}{
-000179d0: 726f 775b 2765 6e64 706f 696e 745f 7572  row['endpoint_ur
-000179e0: 6c27 5d5b 695d 7d22 2c0a 2020 2020 2020  l'][i]}",.      
-000179f0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-00017a00: 6970 655f 7265 7175 6573 745f 7061 7261  ipe_request_para
-00017a10: 6d73 223a 2072 6f77 5b22 7069 7065 5f72  ms": row["pipe_r
-00017a20: 6571 7565 7374 5f70 6172 616d 7322 5d5b  equest_params"][
-00017a30: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
-00017a40: 2020 2020 2020 2020 2268 7474 705f 6d65          "http_me
-00017a50: 7468 6f64 223a 2072 6f77 5b22 6874 7470  thod": row["http
-00017a60: 5f6d 6574 686f 6422 5d2c 0a20 2020 2020  _method"],.     
-00017a70: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00017a80: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-00017a90: 6966 206e 6f74 2070 6970 655f 7265 7175  if not pipe_requ
-00017aa0: 6573 7473 5f74 6f5f 6368 6563 6b3a 0a20  ests_to_check:. 
-00017ab0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00017ac0: 2020 2061 7761 6974 206e 6577 5f70 6970     await new_pip
-00017ad0: 6528 6368 6563 6b65 725f 7069 7065 2c20  e(checker_pipe, 
-00017ae0: 636c 2c20 666f 7263 653d 5472 7565 2c20  cl, force=True, 
-00017af0: 6368 6563 6b3d 4661 6c73 652c 2070 6f70  check=False, pop
-00017b00: 756c 6174 653d 706f 7075 6c61 7465 290a  ulate=populate).
-00017b10: 0a20 2020 2072 756e 6e65 725f 7265 7370  .    runner_resp
-00017b20: 6f6e 7365 203d 2072 756e 6e65 722e 7275  onse = runner.ru
-00017b30: 6e5f 7069 7065 5f63 6865 636b 6572 280a  n_pipe_checker(.
-00017b40: 2020 2020 2020 2020 7069 7065 5f72 6571          pipe_req
-00017b50: 7565 7374 735f 746f 5f63 6865 636b 2c0a  uests_to_check,.
-00017b60: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
-00017b70: 7069 7065 5b22 6e61 6d65 225d 2c0a 2020  pipe["name"],.  
-00017b80: 2020 2020 2020 746f 6b65 6e2c 0a20 2020        token,.   
-00017b90: 2020 2020 206f 6e6c 795f 7265 7370 6f6e       only_respon
-00017ba0: 7365 5f74 696d 6573 2c0a 2020 2020 2020  se_times,.      
-00017bb0: 2020 6967 6e6f 7265 5f6f 7264 6572 2c0a    ignore_order,.
-00017bc0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-00017bd0: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
-00017be0: 2c0a 2020 2020 2020 2020 6661 696c 6661  ,.        failfa
-00017bf0: 7374 2c0a 2020 2020 290a 0a20 2020 2074  st,.    )..    t
-00017c00: 7279 3a0a 2020 2020 2020 2020 6966 2072  ry:.        if r
-00017c10: 756e 6e65 725f 7265 7370 6f6e 7365 2e6d  unner_response.m
-00017c20: 6574 7269 6373 5f73 756d 6d61 7279 2061  etrics_summary a
-00017c30: 6e64 2072 756e 6e65 725f 7265 7370 6f6e  nd runner_respon
-00017c40: 7365 2e6d 6574 7269 6373 5f74 696d 696e  se.metrics_timin
-00017c50: 673a 0a20 2020 2020 2020 2020 2020 2063  g:.            c
-00017c60: 6f6c 756d 6e5f 6e61 6d65 735f 7465 7374  olumn_names_test
-00017c70: 7320 3d20 5b22 5465 7374 2052 756e 222c  s = ["Test Run",
-00017c80: 2022 5465 7374 2050 6173 7365 6422 2c20   "Test Passed", 
-00017c90: 2254 6573 7420 4661 696c 6564 222c 2022  "Test Failed", "
-00017ca0: 2520 5465 7374 2050 6173 7365 6422 2c20  % Test Passed", 
-00017cb0: 2225 2054 6573 7420 4661 696c 6564 225d  "% Test Failed"]
-00017cc0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00017cd0: 636b 2e65 6368 6f28 225c 6e3d 3d3d 3d20  ck.echo("\n==== 
-00017ce0: 5465 7374 204d 6574 7269 6373 203d 3d3d  Test Metrics ===
-00017cf0: 3d5c 6e22 290a 2020 2020 2020 2020 2020  =\n").          
-00017d00: 2020 636c 6963 6b2e 6563 686f 280a 2020    click.echo(.  
-00017d10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00017d20: 726d 6174 5f70 7265 7474 795f 7461 626c  rmat_pretty_tabl
-00017d30: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00017d40: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00017d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d60: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00017d70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00017d80: 756e 6e65 725f 7265 7370 6f6e 7365 2e6d  unner_response.m
-00017d90: 6574 7269 6373 5f73 756d 6d61 7279 5b22  etrics_summary["
-00017da0: 7275 6e22 5d2c 0a20 2020 2020 2020 2020  run"],.         
-00017db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017dc0: 2020 2072 756e 6e65 725f 7265 7370 6f6e     runner_respon
-00017dd0: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
-00017de0: 7279 5b22 7061 7373 6564 225d 2c0a 2020  ry["passed"],.  
-00017df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e00: 2020 2020 2020 2020 2020 7275 6e6e 6572            runner
-00017e10: 5f72 6573 706f 6e73 652e 6d65 7472 6963  _response.metric
-00017e20: 735f 7375 6d6d 6172 795b 2266 6169 6c65  s_summary["faile
-00017e30: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
-00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e50: 2072 756e 6e65 725f 7265 7370 6f6e 7365   runner_response
-00017e60: 2e6d 6574 7269 6373 5f73 756d 6d61 7279  .metrics_summary
-00017e70: 5b22 7065 7263 656e 7461 6765 5f70 6173  ["percentage_pas
-00017e80: 7365 6422 5d2c 0a20 2020 2020 2020 2020  sed"],.         
-00017e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ea0: 2020 2072 756e 6e65 725f 7265 7370 6f6e     runner_respon
-00017eb0: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
-00017ec0: 7279 5b22 7065 7263 656e 7461 6765 5f66  ry["percentage_f
-00017ed0: 6169 6c65 6422 5d2c 0a20 2020 2020 2020  ailed"],.       
-00017ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ef0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-00017f00: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00017f10: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00017f20: 6c75 6d6e 5f6e 616d 6573 3d63 6f6c 756d  lumn_names=colum
-00017f30: 6e5f 6e61 6d65 735f 7465 7374 732c 0a20  n_names_tests,. 
-00017f40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00017f50: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00017f60: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-00017f70: 6d6e 5f6e 616d 6573 5f74 696d 696e 6720  mn_names_timing 
-00017f80: 3d20 5b22 5469 6d69 6e67 204d 6574 7269  = ["Timing Metri
-00017f90: 6320 2873 2922 2c20 2243 7572 7265 6e74  c (s)", "Current
-00017fa0: 222c 2022 4e65 7722 5d0a 2020 2020 2020  ", "New"].      
-00017fb0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00017fc0: 2822 5c6e 3d3d 3d3d 2052 6573 706f 6e73  ("\n==== Respons
-00017fd0: 6520 5469 6d65 204d 6574 7269 6373 203d  e Time Metrics =
-00017fe0: 3d3d 3d5c 6e22 290a 2020 2020 2020 2020  ===\n").        
-00017ff0: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
-00018000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018010: 666f 726d 6174 5f70 7265 7474 795f 7461  format_pretty_ta
-00018020: 626c 6528 0a20 2020 2020 2020 2020 2020  ble(.           
-00018030: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018050: 2020 205b 6d65 7472 6963 2c20 7275 6e6e     [metric, runn
-00018060: 6572 5f72 6573 706f 6e73 652e 6d65 7472  er_response.metr
-00018070: 6963 735f 7469 6d69 6e67 5b6d 6574 7269  ics_timing[metri
-00018080: 635d 5b30 5d2c 2072 756e 6e65 725f 7265  c][0], runner_re
-00018090: 7370 6f6e 7365 2e6d 6574 7269 6373 5f74  sponse.metrics_t
-000180a0: 696d 696e 675b 6d65 7472 6963 5d5b 315d  iming[metric][1]
-000180b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000180c0: 2020 2020 2020 2020 2020 666f 7220 6d65            for me
-000180d0: 7472 6963 2069 6e20 5b0a 2020 2020 2020  tric in [.      
-000180e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180f0: 2020 2020 2020 226d 696e 2072 6573 706f        "min respo
-00018100: 6e73 6520 7469 6d65 222c 0a20 2020 2020  nse time",.     
-00018110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018120: 2020 2020 2020 2022 6d61 7820 7265 7370         "max resp
-00018130: 6f6e 7365 2074 696d 6522 2c0a 2020 2020  onse time",.    
-00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018150: 2020 2020 2020 2020 226d 6561 6e20 7265          "mean re
-00018160: 7370 6f6e 7365 2074 696d 6522 2c0a 2020  sponse time",.  
-00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018180: 2020 2020 2020 2020 2020 226d 6564 6961            "media
-00018190: 6e20 7265 7370 6f6e 7365 2074 696d 6522  n response time"
-000181a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000181b0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-000181c0: 3930 2072 6573 706f 6e73 6520 7469 6d65  90 response time
-000181d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000181e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000181f0: 6d69 6e20 7265 6164 2062 7974 6573 222c  min read bytes",
-00018200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018210: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
-00018220: 7820 7265 6164 2062 7974 6573 222c 0a20  x read bytes",. 
-00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018240: 2020 2020 2020 2020 2020 2022 6d65 616e             "mean
-00018250: 2072 6561 6420 6279 7465 7322 2c0a 2020   read bytes",.  
-00018260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018270: 2020 2020 2020 2020 2020 226d 6564 6961            "media
-00018280: 6e20 7265 6164 2062 7974 6573 222c 0a20  n read bytes",. 
-00018290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182a0: 2020 2020 2020 2020 2020 2022 7039 3020             "p90 
-000182b0: 7265 6164 2062 7974 6573 222c 0a20 2020  read bytes",.   
-000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182d0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-000182e0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-000182f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018300: 2020 636f 6c75 6d6e 5f6e 616d 6573 3d63    column_names=c
-00018310: 6f6c 756d 6e5f 6e61 6d65 735f 7469 6d69  olumn_names_timi
-00018320: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-00018330: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00018340: 2020 290a 2020 2020 6578 6365 7074 2045    ).    except E
-00018350: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-00018360: 2020 7061 7373 0a0a 2020 2020 6966 206e    pass..    if n
-00018370: 6f74 2072 756e 6e65 725f 7265 7370 6f6e  ot runner_respon
-00018380: 7365 2e77 6173 5f73 7563 6365 7373 6675  se.was_successfu
-00018390: 6c6c 3a0a 2020 2020 2020 2020 666f 7220  ll:.        for 
-000183a0: 6661 696c 7572 6520 696e 2072 756e 6e65  failure in runne
-000183b0: 725f 7265 7370 6f6e 7365 2e66 6169 6c65  r_response.faile
-000183c0: 643a 0a20 2020 2020 2020 2020 2020 2074  d:.            t
-000183d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000183e0: 2020 2020 636c 6963 6b2e 6563 686f 2822      click.echo("
-000183f0: 3d3d 3d3d 2054 6573 7420 4641 494c 4544  ==== Test FAILED
-00018400: 203d 3d3d 3d5c 6e22 290a 2020 2020 2020   ====\n").      
-00018410: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-00018420: 6563 686f 2866 6169 6c75 7265 5b22 6e61  echo(failure["na
-00018430: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
-00018440: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00018450: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00018460: 2e65 7272 6f72 5f63 6865 636b 5f70 6970  .error_check_pip
-00018470: 6528 6572 726f 723d 6661 696c 7572 655b  e(error=failure[
-00018480: 2265 7272 6f72 225d 2929 0a20 2020 2020  "error"])).     
-00018490: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-000184a0: 2e65 6368 6f28 223d 3d3d 3d3d 3d3d 3d3d  .echo("=========
-000184b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 5c6e 5c6e  ============\n\n
-000184c0: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
-000184d0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-000184e0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-000184f0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00018500: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00018510: 6f72 2822 496e 7661 6c69 6420 7265 7375  or("Invalid resu
-00018520: 6c74 732c 2079 6f75 2063 616e 2062 7970  lts, you can byp
-00018530: 6173 7320 6368 6563 6b73 2062 7920 7275  ass checks by ru
-00018540: 6e6e 696e 6720 7075 7368 2077 6974 6820  nning push with 
-00018550: 7468 6520 2d2d 6e6f 2d63 6865 636b 2066  the --no-check f
-00018560: 6c61 6722 290a 0a20 2020 2023 204f 6e6c  lag")..    # Onl
-00018570: 7920 6465 6c65 7465 2069 6620 6e6f 2065  y delete if no e
-00018580: 7272 6f72 732c 2073 6f20 7765 2063 616e  rrors, so we can
-00018590: 2063 6865 636b 2072 6573 756c 7473 2061   check results a
-000185a0: 6674 6572 2066 6169 6c75 7265 0a20 2020  fter failure.   
-000185b0: 2068 6561 6465 7273 203d 207b 2241 7574   headers = {"Aut
-000185c0: 686f 7269 7a61 7469 6f6e 223a 2066 2242  horization": f"B
-000185d0: 6561 7265 7220 7b74 6f6b 656e 7d22 7d0a  earer {token}"}.
-000185e0: 2020 2020 7220 3d20 6177 6169 7420 7265      r = await re
-000185f0: 7175 6573 7473 5f64 656c 6574 6528 6622  quests_delete(f"
-00018600: 7b68 6f73 747d 2f76 302f 7069 7065 732f  {host}/v0/pipes/
-00018610: 7b63 6865 636b 6572 5f70 6970 655b 276e  {checker_pipe['n
-00018620: 616d 6527 5d7d 222c 2068 6561 6465 7273  ame']}", headers
-00018630: 3d68 6561 6465 7273 290a 2020 2020 6966  =headers).    if
-00018640: 2072 2e73 7461 7475 735f 636f 6465 2021   r.status_code !
-00018650: 3d20 3230 343a 0a20 2020 2020 2020 2063  = 204:.        c
-00018660: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-00018670: 636b 4d61 6e61 6765 722e 7761 726e 696e  ckManager.warnin
-00018680: 675f 6368 6563 6b5f 7069 7065 2863 6f6e  g_check_pipe(con
-00018690: 7465 6e74 3d72 2e63 6f6e 7465 6e74 2929  tent=r.content))
-000186a0: 0a0a 0a61 7379 6e63 2064 6566 2063 6865  ...async def che
-000186b0: 636b 5f6d 6174 6572 6961 6c69 7a65 6428  ck_materialized(
-000186c0: 7069 7065 2c20 686f 7374 2c20 746f 6b65  pipe, host, toke
-000186d0: 6e2c 2063 6c2c 206f 7665 7272 6964 655f  n, cl, override_
-000186e0: 6461 7461 736f 7572 6365 3d46 616c 7365  datasource=False
-000186f0: 2c20 6375 7272 656e 745f 7069 7065 3d4e  , current_pipe=N
-00018700: 6f6e 6529 3a0a 2020 2020 6368 6563 6b65  one):.    checke
-00018710: 725f 7069 7065 203d 2064 6565 7063 6f70  r_pipe = deepcop
-00018720: 7928 7069 7065 290a 2020 2020 6368 6563  y(pipe).    chec
-00018730: 6b65 725f 7069 7065 5b22 6e61 6d65 225d  ker_pipe["name"]
-00018740: 203d 2066 227b 6368 6563 6b65 725f 7069   = f"{checker_pi
-00018750: 7065 5b27 6e61 6d65 275d 7d5f 5f63 6865  pe['name']}__che
-00018760: 636b 6572 220a 2020 2020 6865 6164 6572  cker".    header
-00018770: 7320 3d20 7b22 4175 7468 6f72 697a 6174  s = {"Authorizat
-00018780: 696f 6e22 3a20 6622 4265 6172 6572 207b  ion": f"Bearer {
-00018790: 746f 6b65 6e7d 227d 0a0a 2020 2020 6966  token}"}..    if
-000187a0: 2063 7572 7265 6e74 5f70 6970 653a 0a20   current_pipe:. 
-000187b0: 2020 2020 2020 2066 726f 6d5f 636f 7079         from_copy
-000187c0: 5f74 6f5f 6d61 7465 7269 616c 697a 6564  _to_materialized
-000187d0: 203d 2063 7572 7265 6e74 5f70 6970 655b   = current_pipe[
-000187e0: 2274 7970 6522 5d20 3d3d 2022 636f 7079  "type"] == "copy
-000187f0: 220a 2020 2020 2020 2020 6966 2066 726f  ".        if fro
-00018800: 6d5f 636f 7079 5f74 6f5f 6d61 7465 7269  m_copy_to_materi
-00018810: 616c 697a 6564 3a0a 2020 2020 2020 2020  alized:.        
-00018820: 2020 2020 6177 6169 7420 636c 2e70 6970      await cl.pip
-00018830: 655f 7265 6d6f 7665 5f63 6f70 7928 6375  e_remove_copy(cu
-00018840: 7272 656e 745f 7069 7065 5b22 6964 225d  rrent_pipe["id"]
-00018850: 2c20 6375 7272 656e 745f 7069 7065 5b22  , current_pipe["
-00018860: 636f 7079 5f6e 6f64 6522 5d29 0a0a 2020  copy_node"])..  
-00018870: 2020 6d61 7465 7269 616c 697a 6564 5f6e    materialized_n
-00018880: 6f64 6520 3d20 4e6f 6e65 0a20 2020 2066  ode = None.    f
-00018890: 6f72 206e 6f64 6520 696e 2063 6865 636b  or node in check
-000188a0: 6572 5f70 6970 655b 226e 6f64 6573 225d  er_pipe["nodes"]
-000188b0: 3a0a 2020 2020 2020 2020 6966 206e 6f64  :.        if nod
-000188c0: 655b 2270 6172 616d 7322 5d5b 2274 7970  e["params"]["typ
-000188d0: 6522 5d20 3d3d 2022 6d61 7465 7269 616c  e"] == "material
-000188e0: 697a 6564 223a 0a20 2020 2020 2020 2020  ized":.         
-000188f0: 2020 206d 6174 6572 6961 6c69 7a65 645f     materialized_
-00018900: 6e6f 6465 203d 2064 6565 7063 6f70 7928  node = deepcopy(
-00018910: 6e6f 6465 290a 2020 2020 2020 2020 2020  node).          
-00018920: 2020 6d61 7465 7269 616c 697a 6564 5f6e    materialized_n
-00018930: 6f64 655b 2270 6172 616d 7322 5d5b 226f  ode["params"]["o
-00018940: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
-00018950: 6365 225d 203d 2022 7472 7565 2220 6966  ce"] = "true" if
-00018960: 206f 7665 7272 6964 655f 6461 7461 736f   override_dataso
-00018970: 7572 6365 2065 6c73 6520 2266 616c 7365  urce else "false
-00018980: 220a 2020 2020 2020 2020 6e6f 6465 5b22  ".        node["
-00018990: 7061 7261 6d73 225d 5b22 7479 7065 225d  params"]["type"]
-000189a0: 203d 2022 7374 616e 6461 7264 220a 0a20   = "standard".. 
-000189b0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000189c0: 7069 7065 5f63 7265 6174 6564 203d 2046  pipe_created = F
-000189d0: 616c 7365 0a20 2020 2020 2020 2061 7761  alse.        awa
-000189e0: 6974 206e 6577 5f70 6970 6528 0a20 2020  it new_pipe(.   
-000189f0: 2020 2020 2020 2020 2063 6865 636b 6572           checker
-00018a00: 5f70 6970 652c 2063 6c2c 2066 6f72 6365  _pipe, cl, force
-00018a10: 3d54 7275 652c 2063 6865 636b 3d46 616c  =True, check=Fal
-00018a20: 7365 2c20 706f 7075 6c61 7465 3d46 616c  se, populate=Fal
-00018a30: 7365 2c20 736b 6970 5f74 6f6b 656e 733d  se, skip_tokens=
-00018a40: 5472 7565 2c20 6967 6e6f 7265 5f73 716c  True, ignore_sql
-00018a50: 5f65 7272 6f72 733d 4661 6c73 650a 2020  _errors=False.  
-00018a60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00018a70: 7069 7065 5f63 7265 6174 6564 203d 2054  pipe_created = T
-00018a80: 7275 650a 2020 2020 2020 2020 7265 7370  rue.        resp
-00018a90: 6f6e 7365 203d 2061 7761 6974 2063 6c2e  onse = await cl.
-00018aa0: 616e 616c 797a 655f 7069 7065 5f6e 6f64  analyze_pipe_nod
-00018ab0: 6528 6368 6563 6b65 725f 7069 7065 5b22  e(checker_pipe["
-00018ac0: 6e61 6d65 225d 2c20 6d61 7465 7269 616c  name"], material
-00018ad0: 697a 6564 5f6e 6f64 652c 2064 7279 5f72  ized_node, dry_r
-00018ae0: 756e 3d22 7472 7565 2229 0a20 2020 2020  un="true").     
-00018af0: 2020 2069 6620 7265 7370 6f6e 7365 2e67     if response.g
-00018b00: 6574 2822 7761 726e 696e 6773 2229 3a0a  et("warnings"):.
-00018b10: 2020 2020 2020 2020 2020 2020 7368 6f77              show
-00018b20: 5f6d 6174 6572 6961 6c69 7a65 645f 7669  _materialized_vi
-00018b30: 6577 5f77 6172 6e69 6e67 7328 7265 7370  ew_warnings(resp
-00018b40: 6f6e 7365 5b22 7761 726e 696e 6773 225d  onse["warnings"]
-00018b50: 290a 0a20 2020 2065 7863 6570 7420 4578  )..    except Ex
-00018b60: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00018b70: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-00018b80: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-00018b90: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00018ba0: 2e65 7272 6f72 5f77 6869 6c65 5f63 6865  .error_while_che
-00018bb0: 636b 5f6d 6174 6572 6961 6c69 7a65 6428  ck_materialized(
-00018bc0: 6572 726f 723d 7374 7228 6529 2929 0a20  error=str(e))). 
-00018bd0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00018be0: 2020 2020 6966 2070 6970 655f 6372 6561      if pipe_crea
-00018bf0: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-00018c00: 2072 203d 2061 7761 6974 2072 6571 7565   r = await reque
-00018c10: 7374 735f 6465 6c65 7465 2866 227b 686f  sts_delete(f"{ho
-00018c20: 7374 7d2f 7630 2f70 6970 6573 2f7b 6368  st}/v0/pipes/{ch
-00018c30: 6563 6b65 725f 7069 7065 5b27 6e61 6d65  ecker_pipe['name
-00018c40: 275d 7d22 2c20 6865 6164 6572 733d 6865  ']}", headers=he
-00018c50: 6164 6572 7329 0a20 2020 2020 2020 2020  aders).         
-00018c60: 2020 2069 6620 722e 7374 6174 7573 5f63     if r.status_c
-00018c70: 6f64 6520 213d 2032 3034 3a0a 2020 2020  ode != 204:.    
-00018c80: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-00018c90: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-00018ca0: 616e 6167 6572 2e77 6172 6e69 6e67 5f63  anager.warning_c
-00018cb0: 6865 636b 5f70 6970 6528 636f 6e74 656e  heck_pipe(conten
-00018cc0: 743d 722e 636f 6e74 656e 7429 290a 0a0a  t=r.content))...
-00018cd0: 6173 796e 6320 6465 6620 6368 6563 6b5f  async def check_
-00018ce0: 636f 7079 5f70 6970 6528 7069 7065 2c20  copy_pipe(pipe, 
-00018cf0: 636f 7079 5f6e 6f64 652c 2074 625f 636c  copy_node, tb_cl
-00018d00: 6965 6e74 3a20 5469 6e79 4229 3a0a 2020  ient: TinyB):.  
-00018d10: 2020 7461 7267 6574 5f64 6174 6173 6f75    target_datasou
-00018d20: 7263 6520 3d20 636f 7079 5f6e 6f64 655b  rce = copy_node[
-00018d30: 2270 6172 616d 7322 5d2e 6765 7428 2274  "params"].get("t
-00018d40: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
-00018d50: 222c 204e 6f6e 6529 0a20 2020 2069 6620  ", None).    if 
-00018d60: 6e6f 7420 7461 7267 6574 5f64 6174 6173  not target_datas
-00018d70: 6f75 7263 653a 0a20 2020 2020 2020 2072  ource:.        r
-00018d80: 6169 7365 2043 4c49 5069 7065 4578 6365  aise CLIPipeExce
-00018d90: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-00018da0: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
-00018db0: 7469 6e67 5f63 6f70 795f 7069 7065 5f74  ting_copy_pipe_t
-00018dc0: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
-00018dd0: 5f72 6571 7569 7265 6428 2929 0a0a 2020  _required())..  
-00018de0: 2020 7472 793a 0a20 2020 2020 2020 2061    try:.        a
-00018df0: 7761 6974 2074 625f 636c 6965 6e74 2e67  wait tb_client.g
-00018e00: 6574 5f64 6174 6173 6f75 7263 6528 7461  et_datasource(ta
-00018e10: 7267 6574 5f64 6174 6173 6f75 7263 6529  rget_datasource)
-00018e20: 0a20 2020 2065 7863 6570 7420 446f 6573  .    except Does
-00018e30: 4e6f 7445 7869 7374 4578 6365 7074 696f  NotExistExceptio
-00018e40: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
-00018e50: 2043 4c49 5069 7065 4578 6365 7074 696f   CLIPipeExceptio
-00018e60: 6e28 0a20 2020 2020 2020 2020 2020 2046  n(.            F
-00018e70: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
-00018e80: 7272 6f72 5f63 7265 6174 696e 675f 636f  rror_creating_co
-00018e90: 7079 5f70 6970 655f 7461 7267 6574 5f64  py_pipe_target_d
-00018ea0: 6174 6173 6f75 7263 655f 6e6f 745f 666f  atasource_not_fo
-00018eb0: 756e 6428 7461 7267 6574 5f64 6174 6173  und(target_datas
-00018ec0: 6f75 7263 653d 7461 7267 6574 5f64 6174  ource=target_dat
-00018ed0: 6173 6f75 7263 6529 0a20 2020 2020 2020  asource).       
-00018ee0: 2029 0a20 2020 2065 7863 6570 7420 4578   ).    except Ex
-00018ef0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00018f00: 2020 2020 2020 7261 6973 6520 434c 4950        raise CLIP
-00018f10: 6970 6545 7863 6570 7469 6f6e 2846 6565  ipeException(Fee
-00018f20: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-00018f30: 6f72 5f65 7863 6570 7469 6f6e 2865 7272  or_exception(err
-00018f40: 6f72 3d65 2929 0a0a 2020 2020 7363 6865  or=e))..    sche
-00018f50: 6475 6c65 5f63 726f 6e20 3d20 636f 7079  dule_cron = copy
-00018f60: 5f6e 6f64 655b 2270 6172 616d 7322 5d2e  _node["params"].
-00018f70: 6765 7428 436f 7079 5061 7261 6d65 7465  get(CopyParamete
-00018f80: 7273 2e43 4f50 595f 5343 4845 4455 4c45  rs.COPY_SCHEDULE
-00018f90: 2c20 4e6f 6e65 290a 2020 2020 6973 5f76  , None).    is_v
-00018fa0: 616c 6964 5f63 726f 6e20 3d20 6e6f 7420  alid_cron = not 
-00018fb0: 7363 6865 6475 6c65 5f63 726f 6e20 6f72  schedule_cron or
-00018fc0: 2028 0a20 2020 2020 2020 2073 6368 6564   (.        sched
-00018fd0: 756c 655f 6372 6f6e 2061 6e64 2028 7363  ule_cron and (sc
-00018fe0: 6865 6475 6c65 5f63 726f 6e20 3d3d 204f  hedule_cron == O
-00018ff0: 4e5f 4445 4d41 4e44 206f 7220 6372 6f6e  N_DEMAND or cron
-00019000: 6974 6572 2e69 735f 7661 6c69 6428 7363  iter.is_valid(sc
-00019010: 6865 6475 6c65 5f63 726f 6e29 290a 2020  hedule_cron)).  
-00019020: 2020 290a 0a20 2020 2069 6620 6e6f 7420    )..    if not 
-00019030: 6973 5f76 616c 6964 5f63 726f 6e3a 0a20  is_valid_cron:. 
-00019040: 2020 2020 2020 2072 6169 7365 2043 4c49         raise CLI
-00019050: 5069 7065 4578 6365 7074 696f 6e28 4665  PipeException(Fe
-00019060: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-00019070: 726f 725f 6372 6561 7469 6e67 5f63 6f70  ror_creating_cop
-00019080: 795f 7069 7065 5f69 6e76 616c 6964 5f63  y_pipe_invalid_c
-00019090: 726f 6e28 7363 6865 6475 6c65 5f63 726f  ron(schedule_cro
-000190a0: 6e3d 7363 6865 6475 6c65 5f63 726f 6e29  n=schedule_cron)
-000190b0: 290a 0a20 2020 2069 6620 6e6f 7420 7069  )..    if not pi
-000190c0: 7065 3a0a 2020 2020 2020 2020 7265 7475  pe:.        retu
-000190d0: 726e 0a0a 2020 2020 7069 7065 5f6e 616d  rn..    pipe_nam
-000190e0: 6520 3d20 7069 7065 5b22 6e61 6d65 225d  e = pipe["name"]
-000190f0: 0a20 2020 2070 6970 655f 7479 7065 203d  .    pipe_type =
-00019100: 2070 6970 655b 2274 7970 6522 5d0a 0a20   pipe["type"].. 
-00019110: 2020 2069 6620 7069 7065 5f74 7970 6520     if pipe_type 
-00019120: 3d3d 2050 6970 6554 7970 6573 2e45 4e44  == PipeTypes.END
-00019130: 504f 494e 543a 0a20 2020 2020 2020 2061  POINT:.        a
-00019140: 7761 6974 2074 625f 636c 6965 6e74 2e70  wait tb_client.p
-00019150: 6970 655f 7265 6d6f 7665 5f65 6e64 706f  ipe_remove_endpo
-00019160: 696e 7428 7069 7065 5f6e 616d 652c 2070  int(pipe_name, p
-00019170: 6970 655b 2265 6e64 706f 696e 7422 5d29  ipe["endpoint"])
-00019180: 0a0a 2020 2020 6966 2070 6970 655f 7479  ..    if pipe_ty
-00019190: 7065 203d 3d20 5069 7065 5479 7065 732e  pe == PipeTypes.
-000191a0: 4441 5441 5f53 494e 4b3a 0a20 2020 2020  DATA_SINK:.     
-000191b0: 2020 2061 7761 6974 2074 625f 636c 6965     await tb_clie
-000191c0: 6e74 2e70 6970 655f 7265 6d6f 7665 5f73  nt.pipe_remove_s
-000191d0: 696e 6b28 7069 7065 5f6e 616d 652c 2070  ink(pipe_name, p
-000191e0: 6970 655b 2273 696e 6b5f 6e6f 6465 225d  ipe["sink_node"]
-000191f0: 290a 0a0a 6173 796e 6320 6465 6620 6368  )...async def ch
-00019200: 6563 6b5f 7369 6e6b 5f70 6970 6528 7069  eck_sink_pipe(pi
-00019210: 7065 2c20 7369 6e6b 5f6e 6f64 652c 2074  pe, sink_node, t
-00019220: 625f 636c 6965 6e74 3a20 5469 6e79 4229  b_client: TinyB)
-00019230: 3a0a 2020 2020 6966 206e 6f74 2073 696e  :.    if not sin
-00019240: 6b5f 6e6f 6465 5b22 6578 706f 7274 5f70  k_node["export_p
-00019250: 6172 616d 7322 5d3a 0a20 2020 2020 2020  arams"]:.       
-00019260: 2072 6574 7572 6e0a 0a20 2020 2069 6620   return..    if 
-00019270: 6e6f 7420 7069 7065 3a0a 2020 2020 2020  not pipe:.      
-00019280: 2020 7265 7475 726e 0a0a 2020 2020 7069    return..    pi
-00019290: 7065 5f6e 616d 6520 3d20 7069 7065 5b22  pe_name = pipe["
-000192a0: 6e61 6d65 225d 0a20 2020 2070 6970 655f  name"].    pipe_
-000192b0: 7479 7065 203d 2070 6970 655b 2274 7970  type = pipe["typ
-000192c0: 6522 5d0a 0a20 2020 2073 6368 6564 756c  e"]..    schedul
-000192d0: 655f 6372 6f6e 203d 2073 696e 6b5f 6e6f  e_cron = sink_no
-000192e0: 6465 5b22 6578 706f 7274 5f70 6172 616d  de["export_param
-000192f0: 7322 5d2e 6765 7428 2273 6368 6564 756c  s"].get("schedul
-00019300: 655f 6372 6f6e 222c 2022 2229 0a20 2020  e_cron", "").   
-00019310: 2069 735f 7661 6c69 645f 6372 6f6e 203d   is_valid_cron =
-00019320: 206e 6f74 2073 6368 6564 756c 655f 6372   not schedule_cr
-00019330: 6f6e 206f 7220 2873 6368 6564 756c 655f  on or (schedule_
-00019340: 6372 6f6e 2061 6e64 2063 726f 6e69 7465  cron and cronite
-00019350: 722e 6973 5f76 616c 6964 2873 6368 6564  r.is_valid(sched
-00019360: 756c 655f 6372 6f6e 2929 0a0a 2020 2020  ule_cron))..    
-00019370: 6966 206e 6f74 2069 735f 7661 6c69 645f  if not is_valid_
-00019380: 6372 6f6e 3a0a 2020 2020 2020 2020 7261  cron:.        ra
-00019390: 6973 6520 434c 4950 6970 6545 7863 6570  ise CLIPipeExcep
-000193a0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-000193b0: 6167 6572 2e65 7272 6f72 5f63 7265 6174  ager.error_creat
-000193c0: 696e 675f 7369 6e6b 5f70 6970 655f 696e  ing_sink_pipe_in
-000193d0: 7661 6c69 645f 6372 6f6e 2873 6368 6564  valid_cron(sched
-000193e0: 756c 655f 6372 6f6e 3d73 6368 6564 756c  ule_cron=schedul
-000193f0: 655f 6372 6f6e 2929 0a0a 2020 2020 6966  e_cron))..    if
-00019400: 2070 6970 655f 7479 7065 203d 3d20 5069   pipe_type == Pi
-00019410: 7065 5479 7065 732e 454e 4450 4f49 4e54  peTypes.ENDPOINT
-00019420: 3a0a 2020 2020 2020 2020 6177 6169 7420  :.        await 
-00019430: 7462 5f63 6c69 656e 742e 7069 7065 5f72  tb_client.pipe_r
-00019440: 656d 6f76 655f 656e 6470 6f69 6e74 2870  emove_endpoint(p
-00019450: 6970 655f 6e61 6d65 2c20 7069 7065 5b22  ipe_name, pipe["
-00019460: 656e 6470 6f69 6e74 225d 290a 0a20 2020  endpoint"])..   
-00019470: 2069 6620 7069 7065 5f74 7970 6520 3d3d   if pipe_type ==
-00019480: 2050 6970 6554 7970 6573 2e43 4f50 593a   PipeTypes.COPY:
-00019490: 0a20 2020 2020 2020 2061 7761 6974 2074  .        await t
-000194a0: 625f 636c 6965 6e74 2e70 6970 655f 7265  b_client.pipe_re
-000194b0: 6d6f 7665 5f63 6f70 7928 7069 7065 5f6e  move_copy(pipe_n
-000194c0: 616d 652c 2070 6970 655b 2263 6f70 795f  ame, pipe["copy_
-000194d0: 6e6f 6465 225d 290a 0a0a 6465 6620 7368  node"])...def sh
-000194e0: 6f77 5f6d 6174 6572 6961 6c69 7a65 645f  ow_materialized_
-000194f0: 7669 6577 5f77 6172 6e69 6e67 7328 7761  view_warnings(wa
-00019500: 726e 696e 6773 293a 0a20 2020 2022 2222  rnings):.    """
-00019510: 0a20 2020 203e 3e3e 2073 686f 775f 6d61  .    >>> show_ma
-00019520: 7465 7269 616c 697a 6564 5f76 6965 775f  terialized_view_
-00019530: 7761 726e 696e 6773 285b 7b27 636f 6465  warnings([{'code
-00019540: 273a 2027 5349 4d27 2c20 2777 6569 6768  ': 'SIM', 'weigh
-00019550: 7427 3a20 317d 5d29 0a0a 2020 2020 3e3e  t': 1}])..    >>
-00019560: 3e20 7368 6f77 5f6d 6174 6572 6961 6c69  > show_materiali
-00019570: 7a65 645f 7669 6577 5f77 6172 6e69 6e67  zed_view_warning
-00019580: 7328 5b7b 2763 6f64 6527 3a20 2753 494d  s([{'code': 'SIM
-00019590: 272c 2027 7765 6967 6874 273a 2031 7d2c  ', 'weight': 1},
-000195a0: 207b 2763 6f64 6527 3a20 2748 5547 455f   {'code': 'HUGE_
-000195b0: 4a4f 494e 272c 2027 7765 6967 6874 273a  JOIN', 'weight':
-000195c0: 2032 7d2c 207b 2774 6578 7427 3a20 2243   2}, {'text': "C
-000195d0: 6f6c 756d 6e20 276e 756d 6265 7227 2069  olumn 'number' i
-000195e0: 7320 7072 6573 656e 7420 696e 2074 6865  s present in the
-000195f0: 2047 524f 5550 2042 5920 6275 7420 6e6f   GROUP BY but no
-00019600: 7420 696e 2074 6865 2053 454c 4543 5420  t in the SELECT 
-00019610: 636c 6175 7365 2e20 5468 6973 206d 6967  clause. This mig
-00019620: 6874 2069 6e64 6963 6174 6520 6120 6e6f  ht indicate a no
-00019630: 7420 7661 6c69 6420 4d61 7465 7269 616c  t valid Material
-00019640: 697a 6564 2056 6965 772c 2070 6c65 6173  ized View, pleas
-00019650: 6520 6d61 6b65 2073 7572 6520 796f 7520  e make sure you 
-00019660: 6167 6772 6567 6174 6520 616e 6420 4752  aggregate and GR
-00019670: 4f55 5020 4259 2069 6e20 7468 6520 746f  OUP BY in the to
-00019680: 706d 6f73 7420 7175 6572 792e 222c 2027  pmost query.", '
-00019690: 636f 6465 273a 2027 4752 4f55 505f 4259  code': 'GROUP_BY
-000196a0: 272c 2027 7765 6967 6874 273a 2031 3030  ', 'weight': 100
-000196b0: 2c20 2764 6f63 756d 656e 7461 7469 6f6e  , 'documentation
-000196c0: 273a 2027 6874 7470 733a 2f2f 7469 6e79  ': 'https://tiny
-000196d0: 6269 7264 2e63 6f2f 646f 6373 2f67 7569  bird.co/docs/gui
-000196e0: 6465 732f 6d61 7465 7269 616c 697a 6564  des/materialized
-000196f0: 2d76 6965 7773 2e68 746d 6c23 7573 652d  -views.html#use-
-00019700: 7468 652d 7361 6d65 2d61 6c69 6173 2d69  the-same-alias-i
-00019710: 6e2d 7365 6c65 6374 2d61 6e64 2d67 726f  n-select-and-gro
-00019720: 7570 2d62 7927 7d5d 290a 2020 2020 e29a  up-by'}]).    ..
-00019730: a0ef b88f 2020 436f 6c75 6d6e 2027 6e75  ....  Column 'nu
-00019740: 6d62 6572 2720 6973 2070 7265 7365 6e74  mber' is present
-00019750: 2069 6e20 7468 6520 4752 4f55 5020 4259   in the GROUP BY
-00019760: 2062 7574 206e 6f74 2069 6e20 7468 6520   but not in the 
-00019770: 5345 4c45 4354 2063 6c61 7573 652e 2054  SELECT clause. T
-00019780: 6869 7320 6d69 6768 7420 696e 6469 6361  his might indica
-00019790: 7465 2061 206e 6f74 2076 616c 6964 204d  te a not valid M
-000197a0: 6174 6572 6961 6c69 7a65 6420 5669 6577  aterialized View
-000197b0: 2c20 706c 6561 7365 206d 616b 6520 7375  , please make su
-000197c0: 7265 2079 6f75 2061 6767 7265 6761 7465  re you aggregate
-000197d0: 2061 6e64 2047 524f 5550 2042 5920 696e   and GROUP BY in
-000197e0: 2074 6865 2074 6f70 6d6f 7374 2071 7565   the topmost que
-000197f0: 7279 2e20 466f 7220 6d6f 7265 2069 6e66  ry. For more inf
-00019800: 6f72 6d61 7469 6f6e 2072 6561 6420 6874  ormation read ht
-00019810: 7470 733a 2f2f 7469 6e79 6269 7264 2e63  tps://tinybird.c
-00019820: 6f2f 646f 6373 2f67 7569 6465 732f 6d61  o/docs/guides/ma
-00019830: 7465 7269 616c 697a 6564 2d76 6965 7773  terialized-views
-00019840: 2e68 746d 6c23 7573 652d 7468 652d 7361  .html#use-the-sa
-00019850: 6d65 2d61 6c69 6173 2d69 6e2d 7365 6c65  me-alias-in-sele
-00019860: 6374 2d61 6e64 2d67 726f 7570 2d62 7920  ct-and-group-by 
-00019870: 6f72 2063 6f6e 7461 6374 2075 7320 6174  or contact us at
-00019880: 2073 7570 706f 7274 4074 696e 7962 6972   support@tinybir
-00019890: 642e 636f 0a20 2020 203e 3e3e 2073 686f  d.co.    >>> sho
-000198a0: 775f 6d61 7465 7269 616c 697a 6564 5f76  w_materialized_v
-000198b0: 6965 775f 7761 726e 696e 6773 285b 7b27  iew_warnings([{'
-000198c0: 636f 6465 273a 2027 5349 4e47 4c45 5f4a  code': 'SINGLE_J
-000198d0: 4f49 4e27 2c20 2777 6569 6768 7427 3a20  OIN', 'weight': 
-000198e0: 3330 307d 2c20 7b27 7465 7874 273a 2022  300}, {'text': "
-000198f0: 436f 6c75 6d6e 2027 6e75 6d62 6572 2720  Column 'number' 
-00019900: 6973 2070 7265 7365 6e74 2069 6e20 7468  is present in th
-00019910: 6520 4752 4f55 5020 4259 2062 7574 206e  e GROUP BY but n
-00019920: 6f74 2069 6e20 7468 6520 5345 4c45 4354  ot in the SELECT
-00019930: 2063 6c61 7573 652e 2054 6869 7320 6d69   clause. This mi
-00019940: 6768 7420 696e 6469 6361 7465 2061 206e  ght indicate a n
-00019950: 6f74 2076 616c 6964 204d 6174 6572 6961  ot valid Materia
-00019960: 6c69 7a65 6420 5669 6577 2c20 706c 6561  lized View, plea
-00019970: 7365 206d 616b 6520 7375 7265 2079 6f75  se make sure you
-00019980: 2061 6767 7265 6761 7465 2061 6e64 2047   aggregate and G
-00019990: 524f 5550 2042 5920 696e 2074 6865 2074  ROUP BY in the t
-000199a0: 6f70 6d6f 7374 2071 7565 7279 2e22 2c20  opmost query.", 
-000199b0: 2763 6f64 6527 3a20 2747 524f 5550 5f42  'code': 'GROUP_B
-000199c0: 5927 2c20 2777 6569 6768 7427 3a20 3130  Y', 'weight': 10
-000199d0: 302c 2027 646f 6375 6d65 6e74 6174 696f  0, 'documentatio
-000199e0: 6e27 3a20 2768 7474 7073 3a2f 2f74 696e  n': 'https://tin
-000199f0: 7962 6972 642e 636f 2f64 6f63 732f 6775  ybird.co/docs/gu
-00019a00: 6964 6573 2f6d 6174 6572 6961 6c69 7a65  ides/materialize
-00019a10: 642d 7669 6577 732e 6874 6d6c 2375 7365  d-views.html#use
-00019a20: 2d74 6865 2d73 616d 652d 616c 6961 732d  -the-same-alias-
-00019a30: 696e 2d73 656c 6563 742d 616e 642d 6772  in-select-and-gr
-00019a40: 6f75 702d 6279 277d 5d29 0a20 2020 20e2  oup-by'}]).    .
-00019a50: 9aa0 efb8 8f20 2043 6f6c 756d 6e20 276e  .....  Column 'n
-00019a60: 756d 6265 7227 2069 7320 7072 6573 656e  umber' is presen
-00019a70: 7420 696e 2074 6865 2047 524f 5550 2042  t in the GROUP B
-00019a80: 5920 6275 7420 6e6f 7420 696e 2074 6865  Y but not in the
-00019a90: 2053 454c 4543 5420 636c 6175 7365 2e20   SELECT clause. 
-00019aa0: 5468 6973 206d 6967 6874 2069 6e64 6963  This might indic
-00019ab0: 6174 6520 6120 6e6f 7420 7661 6c69 6420  ate a not valid 
-00019ac0: 4d61 7465 7269 616c 697a 6564 2056 6965  Materialized Vie
-00019ad0: 772c 2070 6c65 6173 6520 6d61 6b65 2073  w, please make s
-00019ae0: 7572 6520 796f 7520 6167 6772 6567 6174  ure you aggregat
-00019af0: 6520 616e 6420 4752 4f55 5020 4259 2069  e and GROUP BY i
-00019b00: 6e20 7468 6520 746f 706d 6f73 7420 7175  n the topmost qu
-00019b10: 6572 792e 2046 6f72 206d 6f72 6520 696e  ery. For more in
-00019b20: 666f 726d 6174 696f 6e20 7265 6164 2068  formation read h
-00019b30: 7474 7073 3a2f 2f74 696e 7962 6972 642e  ttps://tinybird.
-00019b40: 636f 2f64 6f63 732f 6775 6964 6573 2f6d  co/docs/guides/m
-00019b50: 6174 6572 6961 6c69 7a65 642d 7669 6577  aterialized-view
-00019b60: 732e 6874 6d6c 2375 7365 2d74 6865 2d73  s.html#use-the-s
-00019b70: 616d 652d 616c 6961 732d 696e 2d73 656c  ame-alias-in-sel
-00019b80: 6563 742d 616e 642d 6772 6f75 702d 6279  ect-and-group-by
-00019b90: 206f 7220 636f 6e74 6163 7420 7573 2061   or contact us a
-00019ba0: 7420 7375 7070 6f72 7440 7469 6e79 6269  t support@tinybi
-00019bb0: 7264 2e63 6f0a 2020 2020 2222 220a 2020  rd.co.    """.  
-00019bc0: 2020 6578 636c 7564 6564 5f77 6172 6e69    excluded_warni
-00019bd0: 6e67 7320 3d20 5b22 5349 4d22 2c20 2253  ngs = ["SIM", "S
-00019be0: 494d 5f55 4e4b 4e4f 574e 222c 2022 4855  IM_UNKNOWN", "HU
-00019bf0: 4745 5f4a 4f49 4e22 5d0a 2020 2020 736f  GE_JOIN"].    so
-00019c00: 7274 6564 5f77 6172 6e69 6e67 7320 3d20  rted_warnings = 
-00019c10: 736f 7274 6564 2877 6172 6e69 6e67 732c  sorted(warnings,
-00019c20: 206b 6579 3d6c 616d 6264 6120 7761 726e   key=lambda warn
-00019c30: 696e 673a 2077 6172 6e69 6e67 5b22 7765  ing: warning["we
-00019c40: 6967 6874 225d 290a 2020 2020 6d6f 7374  ight"]).    most
-00019c50: 5f69 6d70 6f72 7461 6e74 5f77 6172 6e69  _important_warni
-00019c60: 6e67 203d 207b 7d0a 2020 2020 666f 7220  ng = {}.    for 
-00019c70: 7761 726e 696e 6720 696e 2073 6f72 7465  warning in sorte
-00019c80: 645f 7761 726e 696e 6773 3a0a 2020 2020  d_warnings:.    
-00019c90: 2020 2020 6966 2077 6172 6e69 6e67 2e67      if warning.g
-00019ca0: 6574 2822 636f 6465 2229 2061 6e64 2077  et("code") and w
-00019cb0: 6172 6e69 6e67 5b22 636f 6465 225d 206e  arning["code"] n
-00019cc0: 6f74 2069 6e20 6578 636c 7564 6564 5f77  ot in excluded_w
-00019cd0: 6172 6e69 6e67 733a 0a20 2020 2020 2020  arnings:.       
-00019ce0: 2020 2020 206d 6f73 745f 696d 706f 7274       most_import
-00019cf0: 616e 745f 7761 726e 696e 6720 3d20 7761  ant_warning = wa
-00019d00: 726e 696e 670a 2020 2020 2020 2020 2020  rning.          
-00019d10: 2020 6272 6561 6b0a 2020 2020 6966 206d    break.    if m
-00019d20: 6f73 745f 696d 706f 7274 616e 745f 7761  ost_important_wa
-00019d30: 726e 696e 673a 0a20 2020 2020 2020 2063  rning:.        c
-00019d40: 6c69 636b 2e65 6368 6f28 0a20 2020 2020  lick.echo(.     
-00019d50: 2020 2020 2020 2046 6565 6462 6163 6b4d         FeedbackM
-00019d60: 616e 6167 6572 2e73 696e 676c 655f 7761  anager.single_wa
-00019d70: 726e 696e 675f 6d61 7465 7269 616c 697a  rning_materializ
-00019d80: 6564 5f70 6970 6528 0a20 2020 2020 2020  ed_pipe(.       
-00019d90: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-00019da0: 3d6d 6f73 745f 696d 706f 7274 616e 745f  =most_important_
-00019db0: 7761 726e 696e 675b 2274 6578 7422 5d2c  warning["text"],
-00019dc0: 2064 6f63 735f 7572 6c3d 6d6f 7374 5f69   docs_url=most_i
-00019dd0: 6d70 6f72 7461 6e74 5f77 6172 6e69 6e67  mportant_warning
-00019de0: 5b22 646f 6375 6d65 6e74 6174 696f 6e22  ["documentation"
-00019df0: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
-00019e00: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
-00019e10: 6320 6465 6620 6765 745f 746f 6b65 6e5f  c def get_token_
-00019e20: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
-00019e30: 2862 7261 6e63 685f 7462 5f63 6c69 656e  (branch_tb_clien
-00019e40: 743a 2054 696e 7942 2920 2d3e 204f 7074  t: TinyB) -> Opt
-00019e50: 696f 6e61 6c5b 7374 725d 3a0a 2020 2020  ional[str]:.    
-00019e60: 746f 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f  token_from_main_
-00019e70: 6272 616e 6368 203d 204e 6f6e 650a 2020  branch = None.  
-00019e80: 2020 6375 7272 656e 745f 776f 726b 7370    current_worksp
-00019e90: 6163 6520 3d20 6177 6169 7420 6272 616e  ace = await bran
-00019ea0: 6368 5f74 625f 636c 6965 6e74 2e77 6f72  ch_tb_client.wor
-00019eb0: 6b73 7061 6365 5f69 6e66 6f28 290a 2020  kspace_info().  
-00019ec0: 2020 2320 6375 7272 656e 7420 776f 726b    # current work
-00019ed0: 7370 6163 6520 6973 2061 2062 7261 6e63  space is a branc
-00019ee0: 680a 2020 2020 6966 2063 7572 7265 6e74  h.    if current
-00019ef0: 5f77 6f72 6b73 7061 6365 2e67 6574 2822  _workspace.get("
-00019f00: 6d61 696e 2229 3a0a 2020 2020 2020 2020  main"):.        
-00019f10: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00019f20: 2062 7261 6e63 685f 7462 5f63 6c69 656e   branch_tb_clien
-00019f30: 742e 7573 6572 5f77 6f72 6b73 7061 6365  t.user_workspace
-00019f40: 7328 290a 2020 2020 2020 2020 776f 726b  s().        work
-00019f50: 7370 6163 6573 203d 2072 6573 706f 6e73  spaces = respons
-00019f60: 655b 2277 6f72 6b73 7061 6365 7322 5d0a  e["workspaces"].
-00019f70: 2020 2020 2020 2020 7072 6f64 5f77 6f72          prod_wor
-00019f80: 6b73 7061 6365 203d 206e 6578 7428 0a20  kspace = next(. 
-00019f90: 2020 2020 2020 2020 2020 2028 776f 726b             (work
-00019fa0: 7370 6163 6520 666f 7220 776f 726b 7370  space for worksp
-00019fb0: 6163 6520 696e 2077 6f72 6b73 7061 6365  ace in workspace
-00019fc0: 7320 6966 2077 6f72 6b73 7061 6365 5b22  s if workspace["
-00019fd0: 6964 225d 203d 3d20 6375 7272 656e 745f  id"] == current_
-00019fe0: 776f 726b 7370 6163 655b 226d 6169 6e22  workspace["main"
-00019ff0: 5d29 2c20 4e6f 6e65 0a20 2020 2020 2020  ]), None.       
-0001a000: 2029 0a20 2020 2020 2020 2069 6620 7072   ).        if pr
-0001a010: 6f64 5f77 6f72 6b73 7061 6365 3a0a 2020  od_workspace:.  
-0001a020: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0001a030: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
-0001a040: 203d 2070 726f 645f 776f 726b 7370 6163   = prod_workspac
-0001a050: 652e 6765 7428 2274 6f6b 656e 2229 0a20  e.get("token"). 
-0001a060: 2020 2072 6574 7572 6e20 746f 6b65 6e5f     return token_
-0001a070: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
-0001a080: 0a0a 0a61 7379 6e63 2064 6566 206e 6577  ...async def new
-0001a090: 5f70 6970 6528 0a20 2020 2070 2c0a 2020  _pipe(.    p,.  
-0001a0a0: 2020 7462 5f63 6c69 656e 743a 2054 696e    tb_client: Tin
-0001a0b0: 7942 2c0a 2020 2020 666f 7263 653a 2062  yB,.    force: b
-0001a0c0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0001a0d0: 2063 6865 636b 3a20 626f 6f6c 203d 2054   check: bool = T
-0001a0e0: 7275 652c 0a20 2020 2070 6f70 756c 6174  rue,.    populat
-0001a0f0: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
-0001a100: 0a20 2020 2070 6f70 756c 6174 655f 7375  .    populate_su
-0001a110: 6273 6574 3d4e 6f6e 652c 0a20 2020 2070  bset=None,.    p
-0001a120: 6f70 756c 6174 655f 636f 6e64 6974 696f  opulate_conditio
-0001a130: 6e3d 4e6f 6e65 2c0a 2020 2020 756e 6c69  n=None,.    unli
-0001a140: 6e6b 5f6f 6e5f 706f 7075 6c61 7465 5f65  nk_on_populate_e
-0001a150: 7272 6f72 3a20 626f 6f6c 203d 2046 616c  rror: bool = Fal
-0001a160: 7365 2c0a 2020 2020 7761 6974 5f70 6f70  se,.    wait_pop
-0001a170: 756c 6174 653a 2062 6f6f 6c20 3d20 4661  ulate: bool = Fa
-0001a180: 6c73 652c 0a20 2020 2073 6b69 705f 746f  lse,.    skip_to
-0001a190: 6b65 6e73 3a20 626f 6f6c 203d 2046 616c  kens: bool = Fal
-0001a1a0: 7365 2c0a 2020 2020 6967 6e6f 7265 5f73  se,.    ignore_s
-0001a1b0: 716c 5f65 7272 6f72 733a 2062 6f6f 6c20  ql_errors: bool 
-0001a1c0: 3d20 4661 6c73 652c 0a20 2020 206f 6e6c  = False,.    onl
-0001a1d0: 795f 7265 7370 6f6e 7365 5f74 696d 6573  y_response_times
-0001a1e0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-0001a1f0: 2020 2020 7469 6d65 6f75 743d 4e6f 6e65      timeout=None
-0001a200: 2c0a 2020 2020 7275 6e5f 7465 7374 733a  ,.    run_tests:
-0001a210: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-0001a220: 2020 2061 735f 7374 616e 6461 7264 3a20     as_standard: 
-0001a230: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-0001a240: 2020 7465 7374 735f 746f 5f72 756e 3a20    tests_to_run: 
-0001a250: 696e 7420 3d20 302c 0a20 2020 2074 6573  int = 0,.    tes
-0001a260: 7473 5f74 6f5f 7361 6d70 6c65 5f62 795f  ts_to_sample_by_
-0001a270: 7061 7261 6d73 3a20 696e 7420 3d20 302c  params: int = 0,
-0001a280: 0a20 2020 2074 6573 7473 5f66 696c 7465  .    tests_filte
-0001a290: 725f 6279 3a20 4f70 7469 6f6e 616c 5b4c  r_by: Optional[L
-0001a2a0: 6973 745b 7374 725d 5d20 3d20 4e6f 6e65  ist[str]] = None
-0001a2b0: 2c0a 2020 2020 7465 7374 735f 6661 696c  ,.    tests_fail
-0001a2c0: 6661 7374 3a20 626f 6f6c 203d 2046 616c  fast: bool = Fal
-0001a2d0: 7365 2c0a 2020 2020 7465 7374 735f 6967  se,.    tests_ig
-0001a2e0: 6e6f 7265 5f6f 7264 6572 3a20 626f 6f6c  nore_order: bool
-0001a2f0: 203d 2046 616c 7365 2c0a 2020 2020 7465   = False,.    te
-0001a300: 7374 735f 7661 6c69 6461 7465 5f70 726f  sts_validate_pro
-0001a310: 6365 7373 6564 5f62 7974 6573 3a20 626f  cessed_bytes: bo
-0001a320: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-0001a330: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
-0001a340: 7263 653a 2062 6f6f 6c20 3d20 4661 6c73  rce: bool = Fals
-0001a350: 652c 0a20 2020 2074 6573 7473 5f63 6865  e,.    tests_che
-0001a360: 636b 5f72 6571 7565 7374 735f 6672 6f6d  ck_requests_from
-0001a370: 5f62 7261 6e63 683a 2062 6f6f 6c20 3d20  _branch: bool = 
-0001a380: 4661 6c73 652c 0a20 2020 2063 6f6e 6669  False,.    confi
-0001a390: 673a 2041 6e79 203d 204e 6f6e 652c 0a20  g: Any = None,. 
-0001a3a0: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
-0001a3b0: 616d 3a20 4f70 7469 6f6e 616c 5b62 6f6f  am: Optional[boo
-0001a3c0: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
-0001a3d0: 666f 726b 3a20 4f70 7469 6f6e 616c 5b62  fork: Optional[b
-0001a3e0: 6f6f 6c5d 203d 2046 616c 7365 2c0a 293a  ool] = False,.):
-0001a3f0: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
-0001a400: 2020 2023 2054 4f44 4f20 7573 6520 7462     # TODO use tb
-0001a410: 5f63 6c69 656e 7420 696e 7374 6561 6420  _client instead 
-0001a420: 6f66 2063 616c 6c69 6e67 2074 6865 2075  of calling the u
-0001a430: 726c 7320 6469 7265 6374 6c79 2e0a 2020  rls directly..  
-0001a440: 2020 686f 7374 203d 2074 625f 636c 6965    host = tb_clie
-0001a450: 6e74 2e68 6f73 740a 2020 2020 746f 6b65  nt.host.    toke
-0001a460: 6e20 3d20 7462 5f63 6c69 656e 742e 746f  n = tb_client.to
-0001a470: 6b65 6e0a 0a20 2020 2068 6561 6465 7273  ken..    headers
-0001a480: 203d 207b 2241 7574 686f 7269 7a61 7469   = {"Authorizati
-0001a490: 6f6e 223a 2066 2242 6561 7265 7220 7b74  on": f"Bearer {t
-0001a4a0: 6f6b 656e 7d22 7d0a 0a20 2020 2063 6c69  oken}"}..    cli
-0001a4b0: 5f70 6172 616d 7320 3d20 7b7d 0a20 2020  _params = {}.   
-0001a4c0: 2063 6c69 5f70 6172 616d 735b 2263 6c69   cli_params["cli
-0001a4d0: 5f76 6572 7369 6f6e 225d 203d 2074 625f  _version"] = tb_
-0001a4e0: 636c 6965 6e74 2e76 6572 7369 6f6e 0a20  client.version. 
-0001a4f0: 2020 2063 6c69 5f70 6172 616d 735b 2264     cli_params["d
-0001a500: 6573 6372 6970 7469 6f6e 225d 203d 2070  escription"] = p
-0001a510: 2e67 6574 2822 6465 7363 7269 7074 696f  .get("descriptio
-0001a520: 6e22 2c20 2222 290a 2020 2020 636c 695f  n", "").    cli_
-0001a530: 7061 7261 6d73 5b22 6967 6e6f 7265 5f73  params["ignore_s
-0001a540: 716c 5f65 7272 6f72 7322 5d20 3d20 2274  ql_errors"] = "t
-0001a550: 7275 6522 2069 6620 6967 6e6f 7265 5f73  rue" if ignore_s
-0001a560: 716c 5f65 7272 6f72 7320 656c 7365 2022  ql_errors else "
-0001a570: 6661 6c73 6522 0a0a 2020 2020 723a 2072  false"..    r: r
-0001a580: 6571 7565 7374 732e 5265 7370 6f6e 7365  equests.Response
-0001a590: 203d 2061 7761 6974 2072 6571 7565 7374   = await request
-0001a5a0: 735f 6765 7428 6622 7b68 6f73 747d 2f76  s_get(f"{host}/v
-0001a5b0: 302f 7069 7065 732f 7b70 5b27 6e61 6d65  0/pipes/{p['name
-0001a5c0: 275d 7d3f 7b75 726c 656e 636f 6465 2863  ']}?{urlencode(c
-0001a5d0: 6c69 5f70 6172 616d 7329 7d22 2c20 6865  li_params)}", he
-0001a5e0: 6164 6572 733d 6865 6164 6572 7329 0a0a  aders=headers)..
-0001a5f0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
-0001a600: 203d 2072 2e6a 736f 6e28 2920 6966 2072   = r.json() if r
-0001a610: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-0001a620: 3230 3020 656c 7365 204e 6f6e 650a 2020  200 else None.  
-0001a630: 2020 7069 7065 5f65 7869 7374 7320 3d20    pipe_exists = 
-0001a640: 6375 7272 656e 745f 7069 7065 2069 7320  current_pipe is 
-0001a650: 6e6f 7420 4e6f 6e65 0a0a 2020 2020 6973  not None..    is
-0001a660: 5f6d 6174 6572 6961 6c69 7a65 6420 3d20  _materialized = 
-0001a670: 616e 7928 5b6e 6f64 652e 6765 7428 2270  any([node.get("p
-0001a680: 6172 616d 7322 2c20 7b7d 292e 6765 7428  arams", {}).get(
-0001a690: 2274 7970 6522 2c20 4e6f 6e65 2920 3d3d  "type", None) ==
-0001a6a0: 2022 6d61 7465 7269 616c 697a 6564 2220   "materialized" 
-0001a6b0: 666f 7220 6e6f 6465 2069 6e20 705b 226e  for node in p["n
-0001a6c0: 6f64 6573 225d 5d29 0a20 2020 2063 6f70  odes"]]).    cop
-0001a6d0: 795f 6e6f 6465 203d 206e 6578 7428 286e  y_node = next((n
-0001a6e0: 6f64 6520 666f 7220 6e6f 6465 2069 6e20  ode for node in 
-0001a6f0: 705b 226e 6f64 6573 225d 2069 6620 6e6f  p["nodes"] if no
-0001a700: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
-0001a710: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
-0001a720: 204e 6f6e 6529 203d 3d20 2263 6f70 7922   None) == "copy"
-0001a730: 292c 204e 6f6e 6529 0a20 2020 2073 696e  ), None).    sin
-0001a740: 6b5f 6e6f 6465 203d 206e 6578 7428 286e  k_node = next((n
-0001a750: 6f64 6520 666f 7220 6e6f 6465 2069 6e20  ode for node in 
-0001a760: 705b 226e 6f64 6573 225d 2069 6620 6e6f  p["nodes"] if no
-0001a770: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
-0001a780: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
-0001a790: 204e 6f6e 6529 203d 3d20 2273 696e 6b22   None) == "sink"
-0001a7a0: 292c 204e 6f6e 6529 0a0a 2020 2020 6966  ), None)..    if
-0001a7b0: 2070 6970 655f 6578 6973 7473 3a0a 2020   pipe_exists:.  
-0001a7c0: 2020 2020 2020 6966 2066 6f72 6365 206f        if force o
-0001a7d0: 7220 7275 6e5f 7465 7374 733a 0a20 2020  r run_tests:.   
-0001a7e0: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-0001a7f0: 2074 6869 7320 7368 6f75 6c64 2063 7265   this should cre
-0001a800: 6174 6520 6120 6469 6666 6572 656e 7420  ate a different 
-0001a810: 6e6f 6465 2061 6e64 2072 656e 616d 6520  node and rename 
-0001a820: 6974 2074 6f20 7468 6520 6669 6e61 6c20  it to the final 
-0001a830: 6f6e 6520 6f6e 2073 7563 6365 7373 0a20  one on success. 
-0001a840: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
-0001a850: 6563 6b20 616e 6420 6e6f 7420 706f 7075  eck and not popu
-0001a860: 6c61 7465 3a0a 2020 2020 2020 2020 2020  late:.          
-0001a870: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
-0001a880: 6d61 7465 7269 616c 697a 6564 2061 6e64  materialized and
-0001a890: 206e 6f74 2063 6f70 795f 6e6f 6465 2061   not copy_node a
-0001a8a0: 6e64 206e 6f74 2073 696e 6b5f 6e6f 6465  nd not sink_node
-0001a8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a8c0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
-0001a8d0: 6b5f 7069 7065 280a 2020 2020 2020 2020  k_pipe(.        
-0001a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8f0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
-0001a900: 2020 2020 2020 2020 2020 2068 6f73 742c             host,
-0001a910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a920: 2020 2020 2020 2020 2074 6f6b 656e 2c0a           token,.
-0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a940: 2020 2020 2020 2020 706f 7075 6c61 7465          populate
-0001a950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001a960: 2020 2020 2020 2020 2020 7462 5f63 6c69            tb_cli
-0001a970: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0001a980: 2020 2020 2020 2020 2020 2020 206f 6e6c               onl
-0001a990: 795f 7265 7370 6f6e 7365 5f74 696d 6573  y_response_times
-0001a9a0: 3d6f 6e6c 795f 7265 7370 6f6e 7365 5f74  =only_response_t
-0001a9b0: 696d 6573 2c0a 2020 2020 2020 2020 2020  imes,.          
-0001a9c0: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-0001a9d0: 6d69 743d 7465 7374 735f 746f 5f72 756e  mit=tests_to_run
-0001a9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001a9f0: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
-0001aa00: 5f62 795f 7061 7261 6d73 3d74 6573 7473  _by_params=tests
-0001aa10: 5f74 6f5f 7361 6d70 6c65 5f62 795f 7061  _to_sample_by_pa
-0001aa20: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
-0001aa30: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0001aa40: 7463 6865 733d 7465 7374 735f 6669 6c74  tches=tests_filt
-0001aa50: 6572 5f62 792c 0a20 2020 2020 2020 2020  er_by,.         
-0001aa60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001aa70: 6169 6c66 6173 743d 7465 7374 735f 6661  ailfast=tests_fa
-0001aa80: 696c 6661 7374 2c0a 2020 2020 2020 2020  ilfast,.        
-0001aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaa0: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
-0001aab0: 6564 5f62 7974 6573 3d74 6573 7473 5f76  ed_bytes=tests_v
-0001aac0: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
-0001aad0: 645f 6279 7465 732c 0a20 2020 2020 2020  d_bytes,.       
-0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaf0: 2069 676e 6f72 655f 6f72 6465 723d 7465   ignore_order=te
-0001ab00: 7374 735f 6967 6e6f 7265 5f6f 7264 6572  sts_ignore_order
-0001ab10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ab20: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0001ab30: 666f 725f 7265 7175 6573 7473 5f74 6f5f  for_requests_to_
-0001ab40: 6368 6563 6b3d 280a 2020 2020 2020 2020  check=(.        
-0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab60: 2020 2020 6177 6169 7420 6765 745f 746f      await get_to
-0001ab70: 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f 6272  ken_from_main_br
-0001ab80: 616e 6368 2874 625f 636c 6965 6e74 290a  anch(tb_client).
-0001ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aba0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001abb0: 6f74 2074 6573 7473 5f63 6865 636b 5f72  ot tests_check_r
-0001abc0: 6571 7565 7374 735f 6672 6f6d 5f62 7261  equests_from_bra
-0001abd0: 6e63 680a 2020 2020 2020 2020 2020 2020  nch.            
-0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abf0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-0001ac20: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-0001ac30: 7265 6e74 5f70 6970 653d 6375 7272 656e  rent_pipe=curren
-0001ac40: 745f 7069 7065 2c0a 2020 2020 2020 2020  t_pipe,.        
-0001ac50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001ac60: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0001ac70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001ac80: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
-0001ac90: 7465 7269 616c 697a 6564 3a0a 2020 2020  terialized:.    
-0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acb0: 2020 2020 6177 6169 7420 6368 6563 6b5f      await check_
-0001acc0: 6d61 7465 7269 616c 697a 6564 280a 2020  materialized(.  
-0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ace0: 2020 2020 2020 2020 2020 702c 0a20 2020            p,.   
-0001acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad00: 2020 2020 2020 2020 2068 6f73 742c 0a20           host,. 
-0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad20: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-0001ad30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ad40: 2020 2020 2020 2020 2020 2020 2020 7462                tb
-0001ad50: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
-0001ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad70: 2020 2020 206f 7665 7272 6964 655f 6461       override_da
-0001ad80: 7461 736f 7572 6365 3d6f 7665 7272 6964  tasource=overrid
-0001ad90: 655f 6461 7461 736f 7572 6365 2c0a 2020  e_datasource,.  
-0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adb0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
-0001adc0: 745f 7069 7065 3d63 7572 7265 6e74 5f70  t_pipe=current_p
-0001add0: 6970 652c 0a20 2020 2020 2020 2020 2020  ipe,.           
-0001ade0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0001adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae00: 2020 2069 6620 636f 7079 5f6e 6f64 653a     if copy_node:
-0001ae10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ae20: 2020 2020 2020 2020 2061 7761 6974 2063           await c
-0001ae30: 6865 636b 5f63 6f70 795f 7069 7065 2870  heck_copy_pipe(p
-0001ae40: 6970 653d 6375 7272 656e 745f 7069 7065  ipe=current_pipe
-0001ae50: 2c20 636f 7079 5f6e 6f64 653d 636f 7079  , copy_node=copy
-0001ae60: 5f6e 6f64 652c 2074 625f 636c 6965 6e74  _node, tb_client
-0001ae70: 3d74 625f 636c 6965 6e74 290a 2020 2020  =tb_client).    
-0001ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae90: 6966 2073 696e 6b5f 6e6f 6465 3a0a 2020  if sink_node:.  
-0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aeb0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
-0001aec0: 6b5f 7369 6e6b 5f70 6970 6528 7069 7065  k_sink_pipe(pipe
-0001aed0: 3d63 7572 7265 6e74 5f70 6970 652c 2073  =current_pipe, s
-0001aee0: 696e 6b5f 6e6f 6465 3d73 696e 6b5f 6e6f  ink_node=sink_no
-0001aef0: 6465 2c20 7462 5f63 6c69 656e 743d 7462  de, tb_client=tb
-0001af00: 5f63 6c69 656e 7429 0a20 2020 2020 2020  _client).       
-0001af10: 2020 2020 2069 6620 7275 6e5f 7465 7374       if run_test
-0001af20: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001af30: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-0001af40: 6622 736b 6970 7069 6e67 2066 6f72 6365  f"skipping force
-0001af50: 206f 7665 7272 6964 6520 6f66 207b 705b   override of {p[
-0001af60: 276e 616d 6527 5d7d 2229 0a20 2020 2020  'name']}").     
-0001af70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001af80: 6e0a 2020 2020 2020 2020 656c 7365 3a0a  n.        else:.
-0001af90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001afa0: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-0001afb0: 6570 7469 6f6e 2846 6565 6462 6163 6b4d  eption(FeedbackM
-0001afc0: 616e 6167 6572 2e65 7272 6f72 5f70 6970  anager.error_pip
-0001afd0: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
-0001afe0: 2870 6970 653d 705b 226e 616d 6522 5d29  (pipe=p["name"])
-0001aff0: 290a 2020 2020 656c 6966 206e 6f74 2070  ).    elif not p
-0001b000: 6970 655f 6578 6973 7473 2061 6e64 2063  ipe_exists and c
-0001b010: 6865 636b 3a0a 2020 2020 2020 2020 6966  heck:.        if
-0001b020: 2069 735f 6d61 7465 7269 616c 697a 6564   is_materialized
-0001b030: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-0001b040: 6169 7420 6368 6563 6b5f 6d61 7465 7269  ait check_materi
-0001b050: 616c 697a 6564 280a 2020 2020 2020 2020  alized(.        
-0001b060: 2020 2020 2020 2020 702c 2068 6f73 742c          p, host,
-0001b070: 2074 6f6b 656e 2c20 7462 5f63 6c69 656e   token, tb_clien
-0001b080: 742c 206f 7665 7272 6964 655f 6461 7461  t, override_data
-0001b090: 736f 7572 6365 3d6f 7665 7272 6964 655f  source=override_
-0001b0a0: 6461 7461 736f 7572 6365 2c20 6375 7272  datasource, curr
-0001b0b0: 656e 745f 7069 7065 3d63 7572 7265 6e74  ent_pipe=current
-0001b0c0: 5f70 6970 650a 2020 2020 2020 2020 2020  _pipe.          
-0001b0d0: 2020 290a 2020 2020 2020 2020 6966 2063    ).        if c
-0001b0e0: 6f70 795f 6e6f 6465 3a0a 2020 2020 2020  opy_node:.      
-0001b0f0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
-0001b100: 6b5f 636f 7079 5f70 6970 6528 7069 7065  k_copy_pipe(pipe
-0001b110: 3d63 7572 7265 6e74 5f70 6970 652c 2063  =current_pipe, c
-0001b120: 6f70 795f 6e6f 6465 3d63 6f70 795f 6e6f  opy_node=copy_no
-0001b130: 6465 2c20 7462 5f63 6c69 656e 743d 7462  de, tb_client=tb
-0001b140: 5f63 6c69 656e 7429 0a0a 2020 2020 7061  _client)..    pa
-0001b150: 7261 6d73 203d 207b 7d0a 2020 2020 7061  rams = {}.    pa
-0001b160: 7261 6d73 2e75 7064 6174 6528 636c 695f  rams.update(cli_
-0001b170: 7061 7261 6d73 290a 2020 2020 6966 2066  params).    if f
-0001b180: 6f72 6365 3a0a 2020 2020 2020 2020 7061  orce:.        pa
-0001b190: 7261 6d73 5b22 666f 7263 6522 5d20 3d20  rams["force"] = 
-0001b1a0: 2274 7275 6522 0a20 2020 2069 6620 706f  "true".    if po
-0001b1b0: 7075 6c61 7465 3a0a 2020 2020 2020 2020  pulate:.        
-0001b1c0: 7061 7261 6d73 5b22 706f 7075 6c61 7465  params["populate
-0001b1d0: 225d 203d 2022 7472 7565 220a 2020 2020  "] = "true".    
-0001b1e0: 6966 2070 6f70 756c 6174 655f 636f 6e64  if populate_cond
-0001b1f0: 6974 696f 6e3a 0a20 2020 2020 2020 2070  ition:.        p
-0001b200: 6172 616d 735b 2270 6f70 756c 6174 655f  arams["populate_
-0001b210: 636f 6e64 6974 696f 6e22 5d20 3d20 706f  condition"] = po
-0001b220: 7075 6c61 7465 5f63 6f6e 6469 7469 6f6e  pulate_condition
-0001b230: 0a20 2020 2069 6620 706f 7075 6c61 7465  .    if populate
-0001b240: 5f73 7562 7365 743a 0a20 2020 2020 2020  _subset:.       
-0001b250: 2070 6172 616d 735b 2270 6f70 756c 6174   params["populat
-0001b260: 655f 7375 6273 6574 225d 203d 2070 6f70  e_subset"] = pop
-0001b270: 756c 6174 655f 7375 6273 6574 0a20 2020  ulate_subset.   
-0001b280: 2070 6172 616d 735b 2275 6e6c 696e 6b5f   params["unlink_
-0001b290: 6f6e 5f70 6f70 756c 6174 655f 6572 726f  on_populate_erro
-0001b2a0: 7222 5d20 3d20 2274 7275 6522 2069 6620  r"] = "true" if 
-0001b2b0: 756e 6c69 6e6b 5f6f 6e5f 706f 7075 6c61  unlink_on_popula
-0001b2c0: 7465 5f65 7272 6f72 2065 6c73 6520 2266  te_error else "f
-0001b2d0: 616c 7365 220a 2020 2020 7061 7261 6d73  alse".    params
-0001b2e0: 5b22 6272 616e 6368 5f6d 6f64 6522 5d20  ["branch_mode"] 
-0001b2f0: 3d20 2266 6f72 6b22 2069 6620 666f 726b  = "fork" if fork
-0001b300: 5f64 6f77 6e73 7472 6561 6d20 6f72 2066  _downstream or f
-0001b310: 6f72 6b20 656c 7365 2022 4e6f 6e65 220a  ork else "None".
-0001b320: 0a20 2020 2062 6f64 7920 3d20 7b22 6e61  .    body = {"na
-0001b330: 6d65 223a 2070 5b22 6e61 6d65 225d 2c20  me": p["name"], 
-0001b340: 2264 6573 6372 6970 7469 6f6e 223a 2070  "description": p
-0001b350: 2e67 6574 2822 6465 7363 7269 7074 696f  .get("descriptio
-0001b360: 6e22 2c20 2222 297d 0a0a 2020 2020 6465  n", "")}..    de
-0001b370: 6620 7061 7273 655f 6e6f 6465 286e 6f64  f parse_node(nod
-0001b380: 6529 3a0a 2020 2020 2020 2020 6966 2022  e):.        if "
-0001b390: 7061 7261 6d73 2220 696e 206e 6f64 653a  params" in node:
-0001b3a0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-0001b3b0: 652e 7570 6461 7465 286e 6f64 655b 2270  e.update(node["p
-0001b3c0: 6172 616d 7322 5d29 0a20 2020 2020 2020  arams"]).       
-0001b3d0: 2020 2020 2069 6620 6e6f 6465 2e67 6574       if node.get
-0001b3e0: 2822 7479 7065 222c 2022 2229 203d 3d20  ("type", "") == 
-0001b3f0: 226d 6174 6572 6961 6c69 7a65 6422 2061  "materialized" a
-0001b400: 6e64 206f 7665 7272 6964 655f 6461 7461  nd override_data
-0001b410: 736f 7572 6365 3a0a 2020 2020 2020 2020  source:.        
-0001b420: 2020 2020 2020 2020 6e6f 6465 5b22 6f76          node["ov
-0001b430: 6572 7269 6465 5f64 6174 6173 6f75 7263  erride_datasourc
-0001b440: 6522 5d20 3d20 2274 7275 6522 0a20 2020  e"] = "true".   
-0001b450: 2020 2020 2020 2020 2064 656c 206e 6f64           del nod
-0001b460: 655b 2270 6172 616d 7322 5d0a 2020 2020  e["params"].    
-0001b470: 2020 2020 7265 7475 726e 206e 6f64 650a      return node.
-0001b480: 0a20 2020 2069 6620 705b 226e 6f64 6573  .    if p["nodes
-0001b490: 225d 3a0a 2020 2020 2020 2020 626f 6479  "]:.        body
-0001b4a0: 5b22 6e6f 6465 7322 5d20 3d20 5b70 6172  ["nodes"] = [par
-0001b4b0: 7365 5f6e 6f64 6528 6e29 2066 6f72 206e  se_node(n) for n
-0001b4c0: 2069 6e20 705b 226e 6f64 6573 225d 5d0a   in p["nodes"]].
-0001b4d0: 0a20 2020 2069 6620 636f 7079 5f6e 6f64  .    if copy_nod
-0001b4e0: 653a 0a20 2020 2020 2020 2062 6f64 795b  e:.        body[
-0001b4f0: 2274 6172 6765 745f 6461 7461 736f 7572  "target_datasour
-0001b500: 6365 225d 203d 2063 6f70 795f 6e6f 6465  ce"] = copy_node
-0001b510: 2e67 6574 2822 7461 7267 6574 5f64 6174  .get("target_dat
-0001b520: 6173 6f75 7263 6522 2c20 4e6f 6e65 290a  asource", None).
-0001b530: 2020 2020 2020 2020 2320 5765 2077 696c          # We wil
-0001b540: 6c20 7570 6461 7465 2074 6865 2073 6368  l update the sch
-0001b550: 6564 756c 6520 6372 6f6e 206c 6174 6572  edule cron later
-0001b560: 0a20 2020 2020 2020 2062 6f64 795b 2273  .        body["s
-0001b570: 6368 6564 756c 655f 6372 6f6e 225d 203d  chedule_cron"] =
-0001b580: 204e 6f6e 650a 0a20 2020 2069 6620 7369   None..    if si
-0001b590: 6e6b 5f6e 6f64 653a 0a20 2020 2020 2020  nk_node:.       
-0001b5a0: 2062 6f64 792e 7570 6461 7465 2873 696e   body.update(sin
-0001b5b0: 6b5f 6e6f 6465 2e67 6574 2822 6578 706f  k_node.get("expo
-0001b5c0: 7274 5f70 6172 616d 7322 2c20 7b7d 2929  rt_params", {}))
-0001b5d0: 0a0a 2020 2020 706f 7374 5f68 6561 6465  ..    post_heade
-0001b5e0: 7273 203d 207b 2243 6f6e 7465 6e74 2d54  rs = {"Content-T
-0001b5f0: 7970 6522 3a20 2261 7070 6c69 6361 7469  ype": "applicati
-0001b600: 6f6e 2f6a 736f 6e22 7d0a 0a20 2020 2070  on/json"}..    p
-0001b610: 6f73 745f 6865 6164 6572 732e 7570 6461  ost_headers.upda
-0001b620: 7465 2868 6561 6465 7273 290a 0a20 2020  te(headers)..   
-0001b630: 2074 7279 3a0a 2020 2020 2020 2020 6461   try:.        da
-0001b640: 7461 203d 2061 7761 6974 2074 625f 636c  ta = await tb_cl
-0001b650: 6965 6e74 2e5f 7265 7128 0a20 2020 2020  ient._req(.     
-0001b660: 2020 2020 2020 2066 222f 7630 2f70 6970         f"/v0/pip
-0001b670: 6573 3f7b 7572 6c65 6e63 6f64 6528 7061  es?{urlencode(pa
-0001b680: 7261 6d73 297d 222c 206d 6574 686f 643d  rams)}", method=
-0001b690: 2250 4f53 5422 2c20 6865 6164 6572 733d  "POST", headers=
-0001b6a0: 706f 7374 5f68 6561 6465 7273 2c20 6461  post_headers, da
-0001b6b0: 7461 3d6a 736f 6e2e 6475 6d70 7328 626f  ta=json.dumps(bo
-0001b6c0: 6479 290a 2020 2020 2020 2020 290a 2020  dy).        ).  
-0001b6d0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0001b6e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0001b6f0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-0001b700: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-0001b710: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-0001b720: 725f 7075 7368 696e 675f 7069 7065 2870  r_pushing_pipe(p
-0001b730: 6970 653d 705b 226e 616d 6522 5d2c 2065  ipe=p["name"], e
-0001b740: 7272 6f72 3d73 7472 2865 2929 290a 0a20  rror=str(e))).. 
-0001b750: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-0001b760: 6461 7461 2e67 6574 2822 6461 7461 736f  data.get("dataso
-0001b770: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
-0001b780: 2063 7265 6174 6564 5f64 6174 6173 6f75   created_datasou
-0001b790: 7263 6520 3d20 6461 7461 2e67 6574 2822  rce = data.get("
-0001b7a0: 6372 6561 7465 645f 6461 7461 736f 7572  created_datasour
-0001b7b0: 6365 222c 204e 6f6e 6529 0a0a 2020 2020  ce", None)..    
-0001b7c0: 6966 2064 6174 6173 6f75 7263 6520 616e  if datasource an
-0001b7d0: 6420 6372 6561 7465 645f 6461 7461 736f  d created_dataso
-0001b7e0: 7572 6365 3a0a 2020 2020 2020 2020 6966  urce:.        if
-0001b7f0: 2063 6f70 795f 6e6f 6465 3a0a 2020 2020   copy_node:.    
-0001b800: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001b810: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-0001b820: 6572 2e69 6e66 6f5f 636f 7079 5f64 6174  er.info_copy_dat
-0001b830: 6173 6f75 7263 655f 6372 6561 7465 6428  asource_created(
-0001b840: 7069 7065 3d70 5b22 6e61 6d65 225d 2c20  pipe=p["name"], 
-0001b850: 6461 7461 736f 7572 6365 3d64 6174 6173  datasource=datas
-0001b860: 6f75 7263 655b 226e 616d 6522 5d29 290a  ource["name"])).
-0001b870: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b880: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0001b890: 6563 686f 280a 2020 2020 2020 2020 2020  echo(.          
-0001b8a0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0001b8b0: 6e61 6765 722e 696e 666f 5f6d 6174 6572  nager.info_mater
-0001b8c0: 6961 6c69 7a65 645f 6461 7461 736f 7572  ialized_datasour
-0001b8d0: 6365 5f63 7265 6174 6564 2870 6970 653d  ce_created(pipe=
-0001b8e0: 705b 226e 616d 6522 5d2c 2064 6174 6173  p["name"], datas
-0001b8f0: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
-0001b900: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-0001b910: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0001b920: 2064 6174 6173 6f75 7263 6520 616e 6420   datasource and 
-0001b930: 6e6f 7420 6372 6561 7465 645f 6461 7461  not created_data
-0001b940: 736f 7572 6365 3a0a 2020 2020 2020 2020  source:.        
-0001b950: 6966 2063 6f70 795f 6e6f 6465 3a0a 2020  if copy_node:.  
-0001b960: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0001b970: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-0001b980: 6167 6572 2e69 6e66 6f5f 636f 7079 5f64  ager.info_copy_d
-0001b990: 6174 6173 6f75 7263 655f 7573 6564 2870  atasource_used(p
-0001b9a0: 6970 653d 705b 226e 616d 6522 5d2c 2064  ipe=p["name"], d
-0001b9b0: 6174 6173 6f75 7263 653d 6461 7461 736f  atasource=dataso
-0001b9c0: 7572 6365 5b22 6e61 6d65 225d 2929 0a20  urce["name"])). 
-0001b9d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001b9e0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-0001b9f0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001ba00: 6765 722e 696e 666f 5f6d 6174 6572 6961  ger.info_materia
-0001ba10: 6c69 7a65 645f 6461 7461 736f 7572 6365  lized_datasource
-0001ba20: 5f75 7365 6428 7069 7065 3d70 5b22 6e61  _used(pipe=p["na
-0001ba30: 6d65 225d 2c20 6461 7461 736f 7572 6365  me"], datasource
-0001ba40: 3d64 6174 6173 6f75 7263 655b 226e 616d  =datasource["nam
-0001ba50: 6522 5d29 290a 0a20 2020 2069 6620 6461  e"]))..    if da
-0001ba60: 7461 736f 7572 6365 2061 6e64 2070 6f70  tasource and pop
-0001ba70: 756c 6174 6520 616e 6420 6e6f 7420 636f  ulate and not co
-0001ba80: 7079 5f6e 6f64 653a 0a20 2020 2020 2020  py_node:.       
-0001ba90: 206a 6f62 5f75 726c 203d 2064 6174 612e   job_url = data.
-0001baa0: 6765 7428 226a 6f62 222c 207b 7d29 2e67  get("job", {}).g
-0001bab0: 6574 2822 6a6f 625f 7572 6c22 2c20 4e6f  et("job_url", No
-0001bac0: 6e65 290a 2020 2020 2020 2020 6a6f 625f  ne).        job_
-0001bad0: 6964 203d 2064 6174 612e 6765 7428 226a  id = data.get("j
-0001bae0: 6f62 222c 207b 7d29 2e67 6574 2822 6a6f  ob", {}).get("jo
-0001baf0: 625f 6964 222c 204e 6f6e 6529 0a20 2020  b_id", None).   
-0001bb00: 2020 2020 2069 6620 706f 7075 6c61 7465       if populate
-0001bb10: 5f73 7562 7365 743a 0a20 2020 2020 2020  _subset:.       
-0001bb20: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-0001bb30: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001bb40: 696e 666f 5f70 6f70 756c 6174 655f 7375  info_populate_su
-0001bb50: 6273 6574 5f6a 6f62 5f75 726c 2875 726c  bset_job_url(url
-0001bb60: 3d6a 6f62 5f75 726c 2c20 7375 6273 6574  =job_url, subset
-0001bb70: 3d70 6f70 756c 6174 655f 7375 6273 6574  =populate_subset
-0001bb80: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-0001bb90: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
-0001bba0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0001bbb0: 636c 6963 6b2e 6563 686f 280a 2020 2020  click.echo(.    
-0001bbc0: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
-0001bbd0: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
-0001bbe0: 5f70 6f70 756c 6174 655f 636f 6e64 6974  _populate_condit
-0001bbf0: 696f 6e5f 6a6f 625f 7572 6c28 7572 6c3d  ion_job_url(url=
-0001bc00: 6a6f 625f 7572 6c2c 2070 6f70 756c 6174  job_url, populat
-0001bc10: 655f 636f 6e64 6974 696f 6e3d 706f 7075  e_condition=popu
-0001bc20: 6c61 7465 5f63 6f6e 6469 7469 6f6e 290a  late_condition).
-0001bc30: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001bc40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001bc50: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001bc60: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-0001bc70: 6572 2e69 6e66 6f5f 706f 7075 6c61 7465  er.info_populate
-0001bc80: 5f6a 6f62 5f75 726c 2875 726c 3d6a 6f62  _job_url(url=job
-0001bc90: 5f75 726c 2929 0a0a 2020 2020 2020 2020  _url))..        
-0001bca0: 6966 2077 6169 745f 706f 7075 6c61 7465  if wait_populate
-0001bcb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001bcc0: 7375 6c74 203d 2061 7761 6974 2077 6169  sult = await wai
-0001bcd0: 745f 6a6f 6228 7462 5f63 6c69 656e 742c  t_job(tb_client,
-0001bce0: 206a 6f62 5f69 642c 206a 6f62 5f75 726c   job_id, job_url
-0001bcf0: 2c20 2250 6f70 756c 6174 696e 6722 2c20  , "Populating", 
-0001bd00: 7469 6d65 6f75 7429 0a20 2020 2020 2020  timeout).       
-0001bd10: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-0001bd20: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001bd30: 696e 666f 5f70 6f70 756c 6174 655f 6a6f  info_populate_jo
-0001bd40: 625f 7265 7375 6c74 2872 6573 756c 743d  b_result(result=
-0001bd50: 7265 7375 6c74 2929 0a20 2020 2065 6c73  result)).    els
-0001bd60: 653a 0a20 2020 2020 2020 2069 6620 6461  e:.        if da
-0001bd70: 7461 2e67 6574 2822 7479 7065 2229 203d  ta.get("type") =
-0001bd80: 3d20 2264 6566 6175 6c74 2220 616e 6420  = "default" and 
-0001bd90: 6e6f 7420 736b 6970 5f74 6f6b 656e 7320  not skip_tokens 
-0001bda0: 616e 6420 6e6f 7420 6173 5f73 7461 6e64  and not as_stand
-0001bdb0: 6172 6420 616e 6420 6e6f 7420 636f 7079  ard and not copy
-0001bdc0: 5f6e 6f64 6520 616e 6420 6e6f 7420 7369  _node and not si
-0001bdd0: 6e6b 5f6e 6f64 653a 0a20 2020 2020 2020  nk_node:.       
-0001bde0: 2020 2020 2023 2046 4958 4d45 3a20 7365       # FIXME: se
-0001bdf0: 7420 6f70 7469 6f6e 2074 6f20 6164 6420  t option to add 
-0001be00: 6c61 7374 206e 6f64 6520 6173 2065 6e64  last node as end
-0001be10: 706f 696e 7420 696e 2074 6865 2041 5049  point in the API
-0001be20: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-0001be30: 706f 696e 745f 6e6f 6465 203d 206e 6578  point_node = nex
-0001be40: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0001be50: 2020 2028 6e6f 6465 2066 6f72 206e 6f64     (node for nod
-0001be60: 6520 696e 2064 6174 612e 6765 7428 226e  e in data.get("n
-0001be70: 6f64 6573 222c 205b 5d29 2069 6620 6e6f  odes", []) if no
-0001be80: 6465 2e67 6574 2822 7479 7065 2229 203d  de.get("type") =
-0001be90: 3d20 2265 6e64 706f 696e 7422 292c 2064  = "endpoint"), d
-0001bea0: 6174 612e 6765 7428 226e 6f64 6573 222c  ata.get("nodes",
-0001beb0: 205b 5d29 5b2d 315d 0a20 2020 2020 2020   [])[-1].       
-0001bec0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001bed0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001bee0: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-0001bef0: 7761 6974 2074 625f 636c 6965 6e74 2e5f  wait tb_client._
-0001bf00: 7265 7128 0a20 2020 2020 2020 2020 2020  req(.           
-0001bf10: 2020 2020 2020 2020 2066 222f 7630 2f70           f"/v0/p
-0001bf20: 6970 6573 2f7b 705b 276e 616d 6527 5d7d  ipes/{p['name']}
-0001bf30: 2f6e 6f64 6573 2f7b 656e 6470 6f69 6e74  /nodes/{endpoint
-0001bf40: 5f6e 6f64 652e 6765 7428 2769 6427 297d  _node.get('id')}
-0001bf50: 2f65 6e64 706f 696e 743f 7b75 726c 656e  /endpoint?{urlen
-0001bf60: 636f 6465 2863 6c69 5f70 6172 616d 7329  code(cli_params)
-0001bf70: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-0001bf80: 2020 2020 2020 2020 6d65 7468 6f64 3d22          method="
-0001bf90: 504f 5354 222c 0a20 2020 2020 2020 2020  POST",.         
-0001bfa0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-0001bfb0: 7273 3d68 6561 6465 7273 2c0a 2020 2020  rs=headers,.    
-0001bfc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001bfd0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001bfe0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0001bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c000: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0001c010: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001c020: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0001c030: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
-0001c040: 7469 6e67 5f65 6e64 706f 696e 7428 0a20  ting_endpoint(. 
+000162c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000162d0: 2020 2022 6d65 6469 616e 2072 6561 6420     "median read 
+000162e0: 6279 7465 7322 3a20 280a 2020 2020 2020  bytes": (.      
+000162f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00016300: 726d 6174 5f73 697a 6528 6d65 6469 616e  rmat_size(median
+00016310: 2863 7572 7265 6e74 5f72 6561 645f 6279  (current_read_by
+00016320: 7465 7329 292c 0a20 2020 2020 2020 2020  tes)),.         
+00016330: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00016340: 745f 7369 7a65 286d 6564 6961 6e28 6368  t_size(median(ch
+00016350: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
+00016360: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00016370: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
+00016380: 6c74 615f 7065 7263 656e 7461 6765 286d  lta_percentage(m
+00016390: 6564 6961 6e28 6368 6563 6b65 725f 7265  edian(checker_re
+000163a0: 6164 5f62 7974 6573 292c 206d 6564 6961  ad_bytes), media
+000163b0: 6e28 6375 7272 656e 745f 7265 6164 5f62  n(current_read_b
+000163c0: 7974 6573 2929 2c0a 2020 2020 2020 2020  ytes)),.        
+000163d0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+000163e0: 2020 2020 2020 2020 2020 2022 7039 3020             "p90 
+000163f0: 7265 6164 2062 7974 6573 223a 2028 0a20  read bytes": (. 
+00016400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016410: 2020 2066 6f72 6d61 745f 7369 7a65 2873     format_size(s
+00016420: 6f72 7465 6428 6375 7272 656e 745f 7265  orted(current_re
+00016430: 6164 5f62 7974 6573 295b 6d61 7468 2e63  ad_bytes)[math.c
+00016440: 6569 6c28 6c65 6e28 6375 7272 656e 745f  eil(len(current_
+00016450: 7265 6164 5f62 7974 6573 2920 2a20 302e  read_bytes) * 0.
+00016460: 3929 202d 2031 5d29 2c0a 2020 2020 2020  9) - 1]),.      
+00016470: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00016480: 726d 6174 5f73 697a 6528 736f 7274 6564  rmat_size(sorted
+00016490: 2863 6865 636b 6572 5f72 6561 645f 6279  (checker_read_by
+000164a0: 7465 7329 5b6d 6174 682e 6365 696c 286c  tes)[math.ceil(l
+000164b0: 656e 2863 6865 636b 6572 5f72 6561 645f  en(checker_read_
+000164c0: 6279 7465 7329 202a 2030 2e39 2920 2d20  bytes) * 0.9) - 
+000164d0: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
+000164e0: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
+000164f0: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
+00016500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016510: 2020 2020 2020 2020 2073 6f72 7465 6428           sorted(
+00016520: 6368 6563 6b65 725f 7265 6164 5f62 7974  checker_read_byt
+00016530: 6573 295b 6d61 7468 2e63 6569 6c28 6c65  es)[math.ceil(le
+00016540: 6e28 6368 6563 6b65 725f 7265 6164 5f62  n(checker_read_b
+00016550: 7974 6573 2920 2a20 302e 3929 202d 2031  ytes) * 0.9) - 1
+00016560: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00016570: 2020 2020 2020 2020 2020 2073 6f72 7465             sorte
+00016580: 6428 6375 7272 656e 745f 7265 6164 5f62  d(current_read_b
+00016590: 7974 6573 295b 6d61 7468 2e63 6569 6c28  ytes)[math.ceil(
+000165a0: 6c65 6e28 6375 7272 656e 745f 7265 6164  len(current_read
+000165b0: 5f62 7974 6573 2920 2a20 302e 3929 202d  _bytes) * 0.9) -
+000165c0: 2031 5d2c 0a20 2020 2020 2020 2020 2020   1],.           
+000165d0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+000165e0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+000165f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00016600: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00016610: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00016620: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00016630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016640: 2020 6c6f 6767 696e 672e 6578 6365 7074    logging.except
+00016650: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
+00016660: 6661 696c 7572 6573 203d 205b 5d0a 2020  failures = [].  
+00016670: 2020 2020 2020 6966 206e 6f74 2072 6573        if not res
+00016680: 756c 742e 7761 7353 7563 6365 7373 6675  ult.wasSuccessfu
+00016690: 6c28 293a 0a20 2020 2020 2020 2020 2020  l():.           
+000166a0: 2066 6f72 205f 7465 7374 2c20 6572 7220   for _test, err 
+000166b0: 696e 2072 6573 756c 742e 6661 696c 7572  in result.failur
+000166c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000166d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000166e0: 2020 2020 2020 2020 2020 2020 2069 203d               i =
+000166f0: 2065 7272 2e69 6e64 6578 2822 4173 7365   err.index("Asse
+00016700: 7274 696f 6e45 7272 6f72 2229 202b 206c  rtionError") + l
+00016710: 656e 2822 4173 7365 7274 696f 6e45 7272  en("AssertionErr
+00016720: 6f72 203a 2229 0a20 2020 2020 2020 2020  or :").         
+00016730: 2020 2020 2020 2020 2020 2066 6169 6c75             failu
+00016740: 7265 732e 6170 7065 6e64 287b 226e 616d  res.append({"nam
+00016750: 6522 3a20 7374 7228 5f74 6573 7429 2c20  e": str(_test), 
+00016760: 2265 7272 6f72 223a 2065 7272 5b69 3a5d  "error": err[i:]
+00016770: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00016780: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00016790: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+000167a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000167b0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+000167c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167d0: 6c6f 6767 696e 672e 6578 6365 7074 696f  logging.exceptio
+000167e0: 6e28 6529 0a0a 2020 2020 2020 2020 7265  n(e)..        re
+000167f0: 7475 726e 2050 6970 6543 6865 636b 6572  turn PipeChecker
+00016800: 5275 6e6e 6572 5265 7370 6f6e 7365 280a  RunnerResponse(.
+00016810: 2020 2020 2020 2020 2020 2020 7069 7065              pipe
+00016820: 5f6e 616d 653d 6368 6563 6b65 725f 7069  _name=checker_pi
+00016830: 7065 5f6e 616d 652c 0a20 2020 2020 2020  pe_name,.       
+00016840: 2020 2020 2074 6573 745f 7479 7065 3d67       test_type=g
+00016850: 6574 6174 7472 2873 656c 662c 2022 7465  etattr(self, "te
+00016860: 7374 5f74 7970 6522 2c20 2222 292c 0a20  st_type", ""),. 
+00016870: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00016880: 743d 6765 7461 7474 7228 7265 7375 6c74  t=getattr(result
+00016890: 2e73 7472 6561 6d2c 2022 5f62 7566 6665  .stream, "_buffe
+000168a0: 7222 2c20 2222 292c 0a20 2020 2020 2020  r", ""),.       
+000168b0: 2020 2020 206d 6574 7269 6373 5f73 756d       metrics_sum
+000168c0: 6d61 7279 3d6d 6574 7269 6373 5f73 756d  mary=metrics_sum
+000168d0: 6d61 7279 2c0a 2020 2020 2020 2020 2020  mary,.          
+000168e0: 2020 6d65 7472 6963 735f 7469 6d69 6e67    metrics_timing
+000168f0: 3d6d 6574 7269 6373 5f74 696d 696e 672c  =metrics_timing,
+00016900: 0a20 2020 2020 2020 2020 2020 2066 6169  .            fai
+00016910: 6c65 643d 6661 696c 7572 6573 2c0a 2020  led=failures,.  
+00016920: 2020 2020 2020 2020 2020 7761 735f 7375            was_su
+00016930: 6363 6573 7366 756c 6c3d 7265 7375 6c74  ccessfull=result
+00016940: 2e77 6173 5375 6363 6573 7366 756c 2829  .wasSuccessful()
+00016950: 2c0a 2020 2020 2020 2020 290a 0a0a 6173  ,.        )...as
+00016960: 796e 6320 6465 6620 6368 6563 6b5f 7069  ync def check_pi
+00016970: 7065 280a 2020 2020 7069 7065 2c0a 2020  pe(.    pipe,.  
+00016980: 2020 686f 7374 3a20 7374 722c 0a20 2020    host: str,.   
+00016990: 2074 6f6b 656e 3a20 7374 722c 0a20 2020   token: str,.   
+000169a0: 2070 6f70 756c 6174 653a 2062 6f6f 6c2c   populate: bool,
+000169b0: 0a20 2020 2063 6c3a 2054 696e 7942 2c0a  .    cl: TinyB,.
+000169c0: 2020 2020 6c69 6d69 743a 2069 6e74 203d      limit: int =
+000169d0: 2030 2c0a 2020 2020 7361 6d70 6c65 5f62   0,.    sample_b
+000169e0: 795f 7061 7261 6d73 3a20 696e 7420 3d20  y_params: int = 
+000169f0: 302c 0a20 2020 206f 6e6c 795f 7265 7370  0,.    only_resp
+00016a00: 6f6e 7365 5f74 696d 6573 3d46 616c 7365  onse_times=False
+00016a10: 2c0a 2020 2020 6d61 7463 6865 733a 204f  ,.    matches: O
+00016a20: 7074 696f 6e61 6c5b 4c69 7374 5b73 7472  ptional[List[str
+00016a30: 5d5d 203d 204e 6f6e 652c 0a20 2020 2066  ]] = None,.    f
+00016a40: 6169 6c66 6173 743a 2062 6f6f 6c20 3d20  ailfast: bool = 
+00016a50: 4661 6c73 652c 0a20 2020 2076 616c 6964  False,.    valid
+00016a60: 6174 655f 7072 6f63 6573 7365 645f 6279  ate_processed_by
+00016a70: 7465 733a 2062 6f6f 6c20 3d20 4661 6c73  tes: bool = Fals
+00016a80: 652c 0a20 2020 2069 676e 6f72 655f 6f72  e,.    ignore_or
+00016a90: 6465 723a 2062 6f6f 6c20 3d20 4661 6c73  der: bool = Fals
+00016aa0: 652c 0a20 2020 2074 6f6b 656e 5f66 6f72  e,.    token_for
+00016ab0: 5f72 6571 7565 7374 735f 746f 5f63 6865  _requests_to_che
+00016ac0: 636b 3a20 4f70 7469 6f6e 616c 5b73 7472  ck: Optional[str
+00016ad0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6375  ] = None,.    cu
+00016ae0: 7272 656e 745f 7069 7065 3a20 4f70 7469  rrent_pipe: Opti
+00016af0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+00016b00: 6e79 5d5d 203d 204e 6f6e 652c 0a29 3a0a  ny]] = None,.):.
+00016b10: 2020 2020 6368 6563 6b65 725f 7069 7065      checker_pipe
+00016b20: 203d 2064 6565 7063 6f70 7928 7069 7065   = deepcopy(pipe
+00016b30: 290a 2020 2020 6368 6563 6b65 725f 7069  ).    checker_pi
+00016b40: 7065 5b22 6e61 6d65 225d 203d 2066 227b  pe["name"] = f"{
+00016b50: 6368 6563 6b65 725f 7069 7065 5b27 6e61  checker_pipe['na
+00016b60: 6d65 275d 7d5f 5f63 6865 636b 6572 220a  me']}__checker".
+00016b70: 0a20 2020 2069 6620 6375 7272 656e 745f  .    if current_
+00016b80: 7069 7065 3a0a 2020 2020 2020 2020 7069  pipe:.        pi
+00016b90: 7065 5f74 7970 6520 3d20 6375 7272 656e  pe_type = curren
+00016ba0: 745f 7069 7065 5b22 7479 7065 225d 0a20  t_pipe["type"]. 
+00016bb0: 2020 2020 2020 2069 6620 7069 7065 5f74         if pipe_t
+00016bc0: 7970 6520 3d3d 2050 6970 6554 7970 6573  ype == PipeTypes
+00016bd0: 2e43 4f50 593a 0a20 2020 2020 2020 2020  .COPY:.         
+00016be0: 2020 2061 7761 6974 2063 6c2e 7069 7065     await cl.pipe
+00016bf0: 5f72 656d 6f76 655f 636f 7079 2863 7572  _remove_copy(cur
+00016c00: 7265 6e74 5f70 6970 655b 2269 6422 5d2c  rent_pipe["id"],
+00016c10: 2063 7572 7265 6e74 5f70 6970 655b 2263   current_pipe["c
+00016c20: 6f70 795f 6e6f 6465 225d 290a 2020 2020  opy_node"]).    
+00016c30: 2020 2020 6966 2070 6970 655f 7479 7065      if pipe_type
+00016c40: 203d 3d20 5069 7065 5479 7065 732e 4441   == PipeTypes.DA
+00016c50: 5441 5f53 494e 4b3a 0a20 2020 2020 2020  TA_SINK:.       
+00016c60: 2020 2020 2061 7761 6974 2063 6c2e 7069       await cl.pi
+00016c70: 7065 5f72 656d 6f76 655f 7369 6e6b 2863  pe_remove_sink(c
+00016c80: 7572 7265 6e74 5f70 6970 655b 2269 6422  urrent_pipe["id"
+00016c90: 5d2c 2063 7572 7265 6e74 5f70 6970 655b  ], current_pipe[
+00016ca0: 2273 696e 6b5f 6e6f 6465 225d 290a 0a20  "sink_node"]).. 
+00016cb0: 2020 2023 2049 6e20 6361 7365 206f 6620     # In case of 
+00016cc0: 646f 696e 6720 2d2d 666f 7263 6520 666f  doing --force fo
+00016cd0: 7220 6120 6d61 7465 7269 616c 697a 6564  r a materialized
+00016ce0: 2076 6965 772c 2063 6865 636b 6572 2069   view, checker i
+00016cf0: 7320 6265 696e 6720 6372 6561 7465 6420  s being created 
+00016d00: 6173 2073 7461 6e64 6172 6420 7069 7065  as standard pipe
+00016d10: 0a20 2020 2066 6f72 206e 6f64 6520 696e  .    for node in
+00016d20: 2063 6865 636b 6572 5f70 6970 655b 226e   checker_pipe["n
+00016d30: 6f64 6573 225d 3a0a 2020 2020 2020 2020  odes"]:.        
+00016d40: 6e6f 6465 5b22 7061 7261 6d73 225d 5b22  node["params"]["
+00016d50: 7479 7065 225d 203d 2050 6970 654e 6f64  type"] = PipeNod
+00016d60: 6554 7970 6573 2e53 5441 4e44 4152 440a  eTypes.STANDARD.
+00016d70: 0a20 2020 2069 6620 706f 7075 6c61 7465  .    if populate
+00016d80: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00016d90: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+00016da0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+00016db0: 6167 6572 2e65 7272 6f72 5f63 6865 636b  ager.error_check
+00016dc0: 5f70 6970 6573 5f70 6f70 756c 6174 6528  _pipes_populate(
+00016dd0: 2929 0a0a 2020 2020 7275 6e6e 6572 203d  ))..    runner =
+00016de0: 2050 6970 6543 6865 636b 6572 5275 6e6e   PipeCheckerRunn
+00016df0: 6572 2870 6970 655b 226e 616d 6522 5d2c  er(pipe["name"],
+00016e00: 2068 6f73 7429 0a20 2020 2068 6561 6465   host).    heade
+00016e10: 7273 203d 2028 0a20 2020 2020 2020 207b  rs = (.        {
+00016e20: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
+00016e30: 2066 2242 6561 7265 7220 7b74 6f6b 656e   f"Bearer {token
+00016e40: 5f66 6f72 5f72 6571 7565 7374 735f 746f  _for_requests_to
+00016e50: 5f63 6865 636b 7d22 7d0a 2020 2020 2020  _check}"}.      
+00016e60: 2020 6966 2074 6f6b 656e 5f66 6f72 5f72    if token_for_r
+00016e70: 6571 7565 7374 735f 746f 5f63 6865 636b  equests_to_check
+00016e80: 0a20 2020 2020 2020 2065 6c73 6520 7b22  .        else {"
+00016e90: 4175 7468 6f72 697a 6174 696f 6e22 3a20  Authorization": 
+00016ea0: 6622 4265 6172 6572 207b 746f 6b65 6e7d  f"Bearer {token}
+00016eb0: 227d 0a20 2020 2029 0a0a 2020 2020 7371  "}.    )..    sq
+00016ec0: 6c5f 666f 725f 636f 7665 7261 6765 2c20  l_for_coverage, 
+00016ed0: 7371 6c5f 6c61 7465 7374 5f72 6571 7565  sql_latest_reque
+00016ee0: 7374 7320 3d20 7275 6e6e 6572 2e67 6574  sts = runner.get
+00016ef0: 5f73 716c 735f 666f 725f 7265 7175 6573  _sqls_for_reques
+00016f00: 7473 5f74 6f5f 6368 6563 6b28 0a20 2020  ts_to_check(.   
+00016f10: 2020 2020 206d 6174 6368 6573 206f 7220       matches or 
+00016f20: 5b5d 2c20 7361 6d70 6c65 5f62 795f 7061  [], sample_by_pa
+00016f30: 7261 6d73 2c20 6c69 6d69 740a 2020 2020  rams, limit.    
+00016f40: 290a 0a20 2020 2070 6172 616d 7320 3d20  )..    params = 
+00016f50: 7b22 7122 3a20 7371 6c5f 666f 725f 636f  {"q": sql_for_co
+00016f60: 7665 7261 6765 2069 6620 6c69 6d69 7420  verage if limit 
+00016f70: 3d3d 2030 2061 6e64 2073 616d 706c 655f  == 0 and sample_
+00016f80: 6279 5f70 6172 616d 7320 3e20 3020 656c  by_params > 0 el
+00016f90: 7365 2073 716c 5f6c 6174 6573 745f 7265  se sql_latest_re
+00016fa0: 7175 6573 7473 7d0a 2020 2020 723a 2072  quests}.    r: r
+00016fb0: 6571 7565 7374 732e 5265 7370 6f6e 7365  equests.Response
+00016fc0: 203d 2061 7761 6974 2072 6571 7565 7374   = await request
+00016fd0: 735f 6765 7428 0a20 2020 2020 2020 2066  s_get(.        f
+00016fe0: 227b 686f 7374 7d2f 7630 2f73 716c 3f7b  "{host}/v0/sql?{
+00016ff0: 7572 6c65 6e63 6f64 6528 7061 7261 6d73  urlencode(params
+00017000: 297d 222c 2068 6561 6465 7273 3d68 6561  )}", headers=hea
+00017010: 6465 7273 2c20 7665 7269 6679 3d6e 6f74  ders, verify=not
+00017020: 2067 6574 656e 765f 626f 6f6c 2822 5442   getenv_bool("TB
+00017030: 5f44 4953 4142 4c45 5f53 534c 5f43 4845  _DISABLE_SSL_CHE
+00017040: 434b 5322 2c20 4661 6c73 6529 0a20 2020  CKS", False).   
+00017050: 2029 0a0a 2020 2020 2320 4966 2077 6520   )..    # If we 
+00017060: 6765 7420 6120 7469 6d65 6f75 742c 2066  get a timeout, f
+00017070: 616c 6c62 6163 6b20 746f 206a 7573 7420  allback to just 
+00017080: 7468 6520 6c61 7374 2072 6571 7565 7374  the last request
+00017090: 730a 0a20 2020 2069 6620 6e6f 7420 7220  s..    if not r 
+000170a0: 6f72 2072 2e73 7461 7475 735f 636f 6465  or r.status_code
+000170b0: 203d 3d20 3430 383a 0a20 2020 2020 2020   == 408:.       
+000170c0: 2070 6172 616d 7320 3d20 7b22 7122 3a20   params = {"q": 
+000170d0: 7371 6c5f 6c61 7465 7374 5f72 6571 7565  sql_latest_reque
+000170e0: 7374 737d 0a20 2020 2020 2020 2072 203d  sts}.        r =
+000170f0: 2061 7761 6974 2072 6571 7565 7374 735f   await requests_
+00017100: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00017110: 2066 227b 686f 7374 7d2f 7630 2f73 716c   f"{host}/v0/sql
+00017120: 3f7b 7572 6c65 6e63 6f64 6528 7061 7261  ?{urlencode(para
+00017130: 6d73 297d 222c 0a20 2020 2020 2020 2020  ms)}",.         
+00017140: 2020 2068 6561 6465 7273 3d68 6561 6465     headers=heade
+00017150: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00017160: 7665 7269 6679 3d6e 6f74 2067 6574 656e  verify=not geten
+00017170: 765f 626f 6f6c 2822 5442 5f44 4953 4142  v_bool("TB_DISAB
+00017180: 4c45 5f53 534c 5f43 4845 434b 5322 2c20  LE_SSL_CHECKS", 
+00017190: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000171a0: 290a 0a20 2020 2069 6620 6e6f 7420 7220  )..    if not r 
+000171b0: 6f72 2072 2e73 7461 7475 735f 636f 6465  or r.status_code
+000171c0: 2021 3d20 3230 303a 0a20 2020 2020 2020   != 200:.       
+000171d0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+000171e0: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+000171f0: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+00017200: 725f 6368 6563 6b5f 7069 7065 735f 6170  r_check_pipes_ap
+00017210: 6928 7069 7065 3d70 6970 655b 226e 616d  i(pipe=pipe["nam
+00017220: 6522 5d29 290a 0a20 2020 2070 6970 655f  e"]))..    pipe_
+00017230: 7265 7175 6573 7473 5f74 6f5f 6368 6563  requests_to_chec
+00017240: 6b3a 204c 6973 745b 4469 6374 5b73 7472  k: List[Dict[str
+00017250: 2c20 416e 795d 5d20 3d20 5b5d 0a20 2020  , Any]] = [].   
+00017260: 2066 6f72 2072 6f77 2069 6e20 722e 6a73   for row in r.js
+00017270: 6f6e 2829 2e67 6574 2822 6461 7461 222c  on().get("data",
+00017280: 205b 5d29 3a0a 2020 2020 2020 2020 666f   []):.        fo
+00017290: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+000172a0: 2872 6f77 5b22 656e 6470 6f69 6e74 5f75  (row["endpoint_u
+000172b0: 726c 225d 2929 3a0a 2020 2020 2020 2020  rl"])):.        
+000172c0: 2020 2020 7069 7065 5f72 6571 7565 7374      pipe_request
+000172d0: 735f 746f 5f63 6865 636b 202b 3d20 5b0a  s_to_check += [.
+000172e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00017300: 2020 2020 2020 2265 6e64 706f 696e 745f        "endpoint_
+00017310: 7572 6c22 3a20 6622 7b68 6f73 747d 7b72  url": f"{host}{r
+00017320: 6f77 5b27 656e 6470 6f69 6e74 5f75 726c  ow['endpoint_url
+00017330: 275d 5b69 5d7d 222c 0a20 2020 2020 2020  '][i]}",.       
+00017340: 2020 2020 2020 2020 2020 2020 2022 7069               "pi
+00017350: 7065 5f72 6571 7565 7374 5f70 6172 616d  pe_request_param
+00017360: 7322 3a20 726f 775b 2270 6970 655f 7265  s": row["pipe_re
+00017370: 7175 6573 745f 7061 7261 6d73 225d 5b69  quest_params"][i
+00017380: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00017390: 2020 2020 2020 2022 6874 7470 5f6d 6574         "http_met
+000173a0: 686f 6422 3a20 726f 775b 2268 7474 705f  hod": row["http_
+000173b0: 6d65 7468 6f64 225d 2c0a 2020 2020 2020  method"],.      
+000173c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000173d0: 2020 2020 2020 2020 5d0a 0a20 2020 2069          ]..    i
+000173e0: 6620 6e6f 7420 7069 7065 5f72 6571 7565  f not pipe_reque
+000173f0: 7374 735f 746f 5f63 6865 636b 3a0a 2020  sts_to_check:.  
+00017400: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00017410: 2020 6177 6169 7420 6e65 775f 7069 7065    await new_pipe
+00017420: 2863 6865 636b 6572 5f70 6970 652c 2063  (checker_pipe, c
+00017430: 6c2c 2066 6f72 6365 3d54 7275 652c 2063  l, force=True, c
+00017440: 6865 636b 3d46 616c 7365 2c20 706f 7075  heck=False, popu
+00017450: 6c61 7465 3d70 6f70 756c 6174 6529 0a0a  late=populate)..
+00017460: 2020 2020 7275 6e6e 6572 5f72 6573 706f      runner_respo
+00017470: 6e73 6520 3d20 7275 6e6e 6572 2e72 756e  nse = runner.run
+00017480: 5f70 6970 655f 6368 6563 6b65 7228 0a20  _pipe_checker(. 
+00017490: 2020 2020 2020 2070 6970 655f 7265 7175         pipe_requ
+000174a0: 6573 7473 5f74 6f5f 6368 6563 6b2c 0a20  ests_to_check,. 
+000174b0: 2020 2020 2020 2063 6865 636b 6572 5f70         checker_p
+000174c0: 6970 655b 226e 616d 6522 5d2c 0a20 2020  ipe["name"],.   
+000174d0: 2020 2020 2074 6f6b 656e 2c0a 2020 2020       token,.    
+000174e0: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
+000174f0: 655f 7469 6d65 732c 0a20 2020 2020 2020  e_times,.       
+00017500: 2069 676e 6f72 655f 6f72 6465 722c 0a20   ignore_order,. 
+00017510: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
+00017520: 7072 6f63 6573 7365 645f 6279 7465 732c  processed_bytes,
+00017530: 0a20 2020 2020 2020 2066 6169 6c66 6173  .        failfas
+00017540: 742c 0a20 2020 2029 0a0a 2020 2020 7472  t,.    )..    tr
+00017550: 793a 0a20 2020 2020 2020 2069 6620 7275  y:.        if ru
+00017560: 6e6e 6572 5f72 6573 706f 6e73 652e 6d65  nner_response.me
+00017570: 7472 6963 735f 7375 6d6d 6172 7920 616e  trics_summary an
+00017580: 6420 7275 6e6e 6572 5f72 6573 706f 6e73  d runner_respons
+00017590: 652e 6d65 7472 6963 735f 7469 6d69 6e67  e.metrics_timing
+000175a0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000175b0: 6c75 6d6e 5f6e 616d 6573 5f74 6573 7473  lumn_names_tests
+000175c0: 203d 205b 2254 6573 7420 5275 6e22 2c20   = ["Test Run", 
+000175d0: 2254 6573 7420 5061 7373 6564 222c 2022  "Test Passed", "
+000175e0: 5465 7374 2046 6169 6c65 6422 2c20 2225  Test Failed", "%
+000175f0: 2054 6573 7420 5061 7373 6564 222c 2022   Test Passed", "
+00017600: 2520 5465 7374 2046 6169 6c65 6422 5d0a  % Test Failed"].
+00017610: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+00017620: 6b2e 6563 686f 2822 5c6e 3d3d 3d3d 2054  k.echo("\n==== T
+00017630: 6573 7420 4d65 7472 6963 7320 3d3d 3d3d  est Metrics ====
+00017640: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
+00017650: 2063 6c69 636b 2e65 6368 6f28 0a20 2020   click.echo(.   
+00017660: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00017670: 6d61 745f 7072 6574 7479 5f74 6162 6c65  mat_pretty_table
+00017680: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00017690: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176b0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000176c0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
+000176d0: 6e6e 6572 5f72 6573 706f 6e73 652e 6d65  nner_response.me
+000176e0: 7472 6963 735f 7375 6d6d 6172 795b 2272  trics_summary["r
+000176f0: 756e 225d 2c0a 2020 2020 2020 2020 2020  un"],.          
+00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017710: 2020 7275 6e6e 6572 5f72 6573 706f 6e73    runner_respons
+00017720: 652e 6d65 7472 6963 735f 7375 6d6d 6172  e.metrics_summar
+00017730: 795b 2270 6173 7365 6422 5d2c 0a20 2020  y["passed"],.   
+00017740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017750: 2020 2020 2020 2020 2072 756e 6e65 725f           runner_
+00017760: 7265 7370 6f6e 7365 2e6d 6574 7269 6373  response.metrics
+00017770: 5f73 756d 6d61 7279 5b22 6661 696c 6564  _summary["failed
+00017780: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00017790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177a0: 7275 6e6e 6572 5f72 6573 706f 6e73 652e  runner_response.
+000177b0: 6d65 7472 6963 735f 7375 6d6d 6172 795b  metrics_summary[
+000177c0: 2270 6572 6365 6e74 6167 655f 7061 7373  "percentage_pass
+000177d0: 6564 225d 2c0a 2020 2020 2020 2020 2020  ed"],.          
+000177e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177f0: 2020 7275 6e6e 6572 5f72 6573 706f 6e73    runner_respons
+00017800: 652e 6d65 7472 6963 735f 7375 6d6d 6172  e.metrics_summar
+00017810: 795b 2270 6572 6365 6e74 6167 655f 6661  y["percentage_fa
+00017820: 696c 6564 225d 2c0a 2020 2020 2020 2020  iled"],.        
+00017830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017840: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00017850: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00017860: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00017870: 756d 6e5f 6e61 6d65 733d 636f 6c75 6d6e  umn_names=column
+00017880: 5f6e 616d 6573 5f74 6573 7473 2c0a 2020  _names_tests,.  
+00017890: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000178a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000178b0: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+000178c0: 6e5f 6e61 6d65 735f 7469 6d69 6e67 203d  n_names_timing =
+000178d0: 205b 2254 696d 696e 6720 4d65 7472 6963   ["Timing Metric
+000178e0: 2028 7329 222c 2022 4375 7272 656e 7422   (s)", "Current"
+000178f0: 2c20 224e 6577 225d 0a20 2020 2020 2020  , "New"].       
+00017900: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00017910: 225c 6e3d 3d3d 3d20 5265 7370 6f6e 7365  "\n==== Response
+00017920: 2054 696d 6520 4d65 7472 6963 7320 3d3d   Time Metrics ==
+00017930: 3d3d 5c6e 2229 0a20 2020 2020 2020 2020  ==\n").         
+00017940: 2020 2063 6c69 636b 2e65 6368 6f28 0a20     click.echo(. 
+00017950: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017960: 6f72 6d61 745f 7072 6574 7479 5f74 6162  ormat_pretty_tab
+00017970: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00017980: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00017990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179a0: 2020 5b6d 6574 7269 632c 2072 756e 6e65    [metric, runne
+000179b0: 725f 7265 7370 6f6e 7365 2e6d 6574 7269  r_response.metri
+000179c0: 6373 5f74 696d 696e 675b 6d65 7472 6963  cs_timing[metric
+000179d0: 5d5b 305d 2c20 7275 6e6e 6572 5f72 6573  ][0], runner_res
+000179e0: 706f 6e73 652e 6d65 7472 6963 735f 7469  ponse.metrics_ti
+000179f0: 6d69 6e67 5b6d 6574 7269 635d 5b31 5d5d  ming[metric][1]]
+00017a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017a10: 2020 2020 2020 2020 2066 6f72 206d 6574           for met
+00017a20: 7269 6320 696e 205b 0a20 2020 2020 2020  ric in [.       
+00017a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a40: 2020 2020 2022 6d69 6e20 7265 7370 6f6e       "min respon
+00017a50: 7365 2074 696d 6522 2c0a 2020 2020 2020  se time",.      
+00017a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a70: 2020 2020 2020 226d 6178 2072 6573 706f        "max respo
+00017a80: 6e73 6520 7469 6d65 222c 0a20 2020 2020  nse time",.     
+00017a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017aa0: 2020 2020 2020 2022 6d65 616e 2072 6573         "mean res
+00017ab0: 706f 6e73 6520 7469 6d65 222c 0a20 2020  ponse time",.   
+00017ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ad0: 2020 2020 2020 2020 2022 6d65 6469 616e           "median
+00017ae0: 2072 6573 706f 6e73 6520 7469 6d65 222c   response time",
+00017af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017b00: 2020 2020 2020 2020 2020 2020 2022 7039               "p9
+00017b10: 3020 7265 7370 6f6e 7365 2074 696d 6522  0 response time"
+00017b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017b30: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00017b40: 696e 2072 6561 6420 6279 7465 7322 2c0a  in read bytes",.
+00017b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b60: 2020 2020 2020 2020 2020 2020 226d 6178              "max
+00017b70: 2072 6561 6420 6279 7465 7322 2c0a 2020   read bytes",.  
+00017b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b90: 2020 2020 2020 2020 2020 226d 6561 6e20            "mean 
+00017ba0: 7265 6164 2062 7974 6573 222c 0a20 2020  read bytes",.   
+00017bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bc0: 2020 2020 2020 2020 2022 6d65 6469 616e           "median
+00017bd0: 2072 6561 6420 6279 7465 7322 2c0a 2020   read bytes",.  
+00017be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bf0: 2020 2020 2020 2020 2020 2270 3930 2072            "p90 r
+00017c00: 6561 6420 6279 7465 7322 2c0a 2020 2020  ead bytes",.    
+00017c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c20: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00017c30: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00017c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c50: 2063 6f6c 756d 6e5f 6e61 6d65 733d 636f   column_names=co
+00017c60: 6c75 6d6e 5f6e 616d 6573 5f74 696d 696e  lumn_names_timin
+00017c70: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+00017c80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00017c90: 2029 0a20 2020 2065 7863 6570 7420 4578   ).    except Ex
+00017ca0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00017cb0: 2070 6173 730a 0a20 2020 2069 6620 6e6f   pass..    if no
+00017cc0: 7420 7275 6e6e 6572 5f72 6573 706f 6e73  t runner_respons
+00017cd0: 652e 7761 735f 7375 6363 6573 7366 756c  e.was_successful
+00017ce0: 6c3a 0a20 2020 2020 2020 2066 6f72 2066  l:.        for f
+00017cf0: 6169 6c75 7265 2069 6e20 7275 6e6e 6572  ailure in runner
+00017d00: 5f72 6573 706f 6e73 652e 6661 696c 6564  _response.failed
+00017d10: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00017d20: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00017d30: 2020 2063 6c69 636b 2e65 6368 6f28 223d     click.echo("=
+00017d40: 3d3d 3d20 5465 7374 2046 4149 4c45 4420  === Test FAILED 
+00017d50: 3d3d 3d3d 5c6e 2229 0a20 2020 2020 2020  ====\n").       
+00017d60: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00017d70: 6368 6f28 6661 696c 7572 655b 226e 616d  cho(failure["nam
+00017d80: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+00017d90: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00017da0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00017db0: 6572 726f 725f 6368 6563 6b5f 7069 7065  error_check_pipe
+00017dc0: 2865 7272 6f72 3d66 6169 6c75 7265 5b22  (error=failure["
+00017dd0: 6572 726f 7222 5d29 290a 2020 2020 2020  error"])).      
+00017de0: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+00017df0: 6563 686f 2822 3d3d 3d3d 3d3d 3d3d 3d3d  echo("==========
+00017e00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d5c 6e5c 6e5c  ===========\n\n\
+00017e10: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
+00017e20: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00017e30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017e40: 2020 7061 7373 0a20 2020 2020 2020 2072    pass.        r
+00017e50: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00017e60: 7228 2249 6e76 616c 6964 2072 6573 756c  r("Invalid resul
+00017e70: 7473 2c20 796f 7520 6361 6e20 6279 7061  ts, you can bypa
+00017e80: 7373 2063 6865 636b 7320 6279 2072 756e  ss checks by run
+00017e90: 6e69 6e67 2070 7573 6820 7769 7468 2074  ning push with t
+00017ea0: 6865 202d 2d6e 6f2d 6368 6563 6b20 666c  he --no-check fl
+00017eb0: 6167 2229 0a0a 2020 2020 2320 4f6e 6c79  ag")..    # Only
+00017ec0: 2064 656c 6574 6520 6966 206e 6f20 6572   delete if no er
+00017ed0: 726f 7273 2c20 736f 2077 6520 6361 6e20  rors, so we can 
+00017ee0: 6368 6563 6b20 7265 7375 6c74 7320 6166  check results af
+00017ef0: 7465 7220 6661 696c 7572 650a 2020 2020  ter failure.    
+00017f00: 6865 6164 6572 7320 3d20 7b22 4175 7468  headers = {"Auth
+00017f10: 6f72 697a 6174 696f 6e22 3a20 6622 4265  orization": f"Be
+00017f20: 6172 6572 207b 746f 6b65 6e7d 227d 0a20  arer {token}"}. 
+00017f30: 2020 2072 203d 2061 7761 6974 2072 6571     r = await req
+00017f40: 7565 7374 735f 6465 6c65 7465 2866 227b  uests_delete(f"{
+00017f50: 686f 7374 7d2f 7630 2f70 6970 6573 2f7b  host}/v0/pipes/{
+00017f60: 6368 6563 6b65 725f 7069 7065 5b27 6e61  checker_pipe['na
+00017f70: 6d65 275d 7d22 2c20 6865 6164 6572 733d  me']}", headers=
+00017f80: 6865 6164 6572 7329 0a20 2020 2069 6620  headers).    if 
+00017f90: 722e 7374 6174 7573 5f63 6f64 6520 213d  r.status_code !=
+00017fa0: 2032 3034 3a0a 2020 2020 2020 2020 636c   204:.        cl
+00017fb0: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
+00017fc0: 6b4d 616e 6167 6572 2e77 6172 6e69 6e67  kManager.warning
+00017fd0: 5f63 6865 636b 5f70 6970 6528 636f 6e74  _check_pipe(cont
+00017fe0: 656e 743d 722e 636f 6e74 656e 7429 290a  ent=r.content)).
+00017ff0: 0a0a 6173 796e 6320 6465 6620 6368 6563  ..async def chec
+00018000: 6b5f 6d61 7465 7269 616c 697a 6564 2870  k_materialized(p
+00018010: 6970 652c 2068 6f73 742c 2074 6f6b 656e  ipe, host, token
+00018020: 2c20 636c 2c20 6f76 6572 7269 6465 5f64  , cl, override_d
+00018030: 6174 6173 6f75 7263 653d 4661 6c73 652c  atasource=False,
+00018040: 2063 7572 7265 6e74 5f70 6970 653d 4e6f   current_pipe=No
+00018050: 6e65 293a 0a20 2020 2063 6865 636b 6572  ne):.    checker
+00018060: 5f70 6970 6520 3d20 6465 6570 636f 7079  _pipe = deepcopy
+00018070: 2870 6970 6529 0a20 2020 2063 6865 636b  (pipe).    check
+00018080: 6572 5f70 6970 655b 226e 616d 6522 5d20  er_pipe["name"] 
+00018090: 3d20 6622 7b63 6865 636b 6572 5f70 6970  = f"{checker_pip
+000180a0: 655b 276e 616d 6527 5d7d 5f5f 6368 6563  e['name']}__chec
+000180b0: 6b65 7222 0a20 2020 2068 6561 6465 7273  ker".    headers
+000180c0: 203d 207b 2241 7574 686f 7269 7a61 7469   = {"Authorizati
+000180d0: 6f6e 223a 2066 2242 6561 7265 7220 7b74  on": f"Bearer {t
+000180e0: 6f6b 656e 7d22 7d0a 0a20 2020 2069 6620  oken}"}..    if 
+000180f0: 6375 7272 656e 745f 7069 7065 3a0a 2020  current_pipe:.  
+00018100: 2020 2020 2020 6672 6f6d 5f63 6f70 795f        from_copy_
+00018110: 746f 5f6d 6174 6572 6961 6c69 7a65 6420  to_materialized 
+00018120: 3d20 6375 7272 656e 745f 7069 7065 5b22  = current_pipe["
+00018130: 7479 7065 225d 203d 3d20 2263 6f70 7922  type"] == "copy"
+00018140: 0a20 2020 2020 2020 2069 6620 6672 6f6d  .        if from
+00018150: 5f63 6f70 795f 746f 5f6d 6174 6572 6961  _copy_to_materia
+00018160: 6c69 7a65 643a 0a20 2020 2020 2020 2020  lized:.         
+00018170: 2020 2061 7761 6974 2063 6c2e 7069 7065     await cl.pipe
+00018180: 5f72 656d 6f76 655f 636f 7079 2863 7572  _remove_copy(cur
+00018190: 7265 6e74 5f70 6970 655b 2269 6422 5d2c  rent_pipe["id"],
+000181a0: 2063 7572 7265 6e74 5f70 6970 655b 2263   current_pipe["c
+000181b0: 6f70 795f 6e6f 6465 225d 290a 0a20 2020  opy_node"])..   
+000181c0: 206d 6174 6572 6961 6c69 7a65 645f 6e6f   materialized_no
+000181d0: 6465 203d 204e 6f6e 650a 2020 2020 666f  de = None.    fo
+000181e0: 7220 6e6f 6465 2069 6e20 6368 6563 6b65  r node in checke
+000181f0: 725f 7069 7065 5b22 6e6f 6465 7322 5d3a  r_pipe["nodes"]:
+00018200: 0a20 2020 2020 2020 2069 6620 6e6f 6465  .        if node
+00018210: 5b22 7061 7261 6d73 225d 5b22 7479 7065  ["params"]["type
+00018220: 225d 203d 3d20 226d 6174 6572 6961 6c69  "] == "materiali
+00018230: 7a65 6422 3a0a 2020 2020 2020 2020 2020  zed":.          
+00018240: 2020 6d61 7465 7269 616c 697a 6564 5f6e    materialized_n
+00018250: 6f64 6520 3d20 6465 6570 636f 7079 286e  ode = deepcopy(n
+00018260: 6f64 6529 0a20 2020 2020 2020 2020 2020  ode).           
+00018270: 206d 6174 6572 6961 6c69 7a65 645f 6e6f   materialized_no
+00018280: 6465 5b22 7061 7261 6d73 225d 5b22 6f76  de["params"]["ov
+00018290: 6572 7269 6465 5f64 6174 6173 6f75 7263  erride_datasourc
+000182a0: 6522 5d20 3d20 2274 7275 6522 2069 6620  e"] = "true" if 
+000182b0: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
+000182c0: 7263 6520 656c 7365 2022 6661 6c73 6522  rce else "false"
+000182d0: 0a20 2020 2020 2020 206e 6f64 655b 2270  .        node["p
+000182e0: 6172 616d 7322 5d5b 2274 7970 6522 5d20  arams"]["type"] 
+000182f0: 3d20 2273 7461 6e64 6172 6422 0a0a 2020  = "standard"..  
+00018300: 2020 7472 793a 0a20 2020 2020 2020 2070    try:.        p
+00018310: 6970 655f 6372 6561 7465 6420 3d20 4661  ipe_created = Fa
+00018320: 6c73 650a 2020 2020 2020 2020 6177 6169  lse.        awai
+00018330: 7420 6e65 775f 7069 7065 280a 2020 2020  t new_pipe(.    
+00018340: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00018350: 7069 7065 2c20 636c 2c20 666f 7263 653d  pipe, cl, force=
+00018360: 5472 7565 2c20 6368 6563 6b3d 4661 6c73  True, check=Fals
+00018370: 652c 2070 6f70 756c 6174 653d 4661 6c73  e, populate=Fals
+00018380: 652c 2073 6b69 705f 746f 6b65 6e73 3d54  e, skip_tokens=T
+00018390: 7275 652c 2069 676e 6f72 655f 7371 6c5f  rue, ignore_sql_
+000183a0: 6572 726f 7273 3d46 616c 7365 0a20 2020  errors=False.   
+000183b0: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
+000183c0: 6970 655f 6372 6561 7465 6420 3d20 5472  ipe_created = Tr
+000183d0: 7565 0a20 2020 2020 2020 2072 6573 706f  ue.        respo
+000183e0: 6e73 6520 3d20 6177 6169 7420 636c 2e61  nse = await cl.a
+000183f0: 6e61 6c79 7a65 5f70 6970 655f 6e6f 6465  nalyze_pipe_node
+00018400: 2863 6865 636b 6572 5f70 6970 655b 226e  (checker_pipe["n
+00018410: 616d 6522 5d2c 206d 6174 6572 6961 6c69  ame"], materiali
+00018420: 7a65 645f 6e6f 6465 2c20 6472 795f 7275  zed_node, dry_ru
+00018430: 6e3d 2274 7275 6522 290a 2020 2020 2020  n="true").      
+00018440: 2020 6966 2072 6573 706f 6e73 652e 6765    if response.ge
+00018450: 7428 2277 6172 6e69 6e67 7322 293a 0a20  t("warnings"):. 
+00018460: 2020 2020 2020 2020 2020 2073 686f 775f             show_
+00018470: 6d61 7465 7269 616c 697a 6564 5f76 6965  materialized_vie
+00018480: 775f 7761 726e 696e 6773 2872 6573 706f  w_warnings(respo
+00018490: 6e73 655b 2277 6172 6e69 6e67 7322 5d29  nse["warnings"])
+000184a0: 0a0a 2020 2020 6578 6365 7074 2045 7863  ..    except Exc
+000184b0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+000184c0: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
+000184d0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
+000184e0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+000184f0: 6572 726f 725f 7768 696c 655f 6368 6563  error_while_chec
+00018500: 6b5f 6d61 7465 7269 616c 697a 6564 2865  k_materialized(e
+00018510: 7272 6f72 3d73 7472 2865 2929 290a 2020  rror=str(e))).  
+00018520: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+00018530: 2020 2069 6620 7069 7065 5f63 7265 6174     if pipe_creat
+00018540: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+00018550: 7220 3d20 6177 6169 7420 7265 7175 6573  r = await reques
+00018560: 7473 5f64 656c 6574 6528 6622 7b68 6f73  ts_delete(f"{hos
+00018570: 747d 2f76 302f 7069 7065 732f 7b63 6865  t}/v0/pipes/{che
+00018580: 636b 6572 5f70 6970 655b 276e 616d 6527  cker_pipe['name'
+00018590: 5d7d 222c 2068 6561 6465 7273 3d68 6561  ]}", headers=hea
+000185a0: 6465 7273 290a 2020 2020 2020 2020 2020  ders).          
+000185b0: 2020 6966 2072 2e73 7461 7475 735f 636f    if r.status_co
+000185c0: 6465 2021 3d20 3230 343a 0a20 2020 2020  de != 204:.     
+000185d0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+000185e0: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+000185f0: 6e61 6765 722e 7761 726e 696e 675f 6368  nager.warning_ch
+00018600: 6563 6b5f 7069 7065 2863 6f6e 7465 6e74  eck_pipe(content
+00018610: 3d72 2e63 6f6e 7465 6e74 2929 0a0a 0a61  =r.content))...a
+00018620: 7379 6e63 2064 6566 2063 6865 636b 5f63  sync def check_c
+00018630: 6f70 795f 7069 7065 2870 6970 652c 2063  opy_pipe(pipe, c
+00018640: 6f70 795f 6e6f 6465 2c20 7462 5f63 6c69  opy_node, tb_cli
+00018650: 656e 743a 2054 696e 7942 293a 0a20 2020  ent: TinyB):.   
+00018660: 2074 6172 6765 745f 6461 7461 736f 7572   target_datasour
+00018670: 6365 203d 2063 6f70 795f 6e6f 6465 5b22  ce = copy_node["
+00018680: 7061 7261 6d73 225d 2e67 6574 2822 7461  params"].get("ta
+00018690: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
+000186a0: 2c20 4e6f 6e65 290a 2020 2020 6966 206e  , None).    if n
+000186b0: 6f74 2074 6172 6765 745f 6461 7461 736f  ot target_dataso
+000186c0: 7572 6365 3a0a 2020 2020 2020 2020 7261  urce:.        ra
+000186d0: 6973 6520 434c 4950 6970 6545 7863 6570  ise CLIPipeExcep
+000186e0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+000186f0: 6167 6572 2e65 7272 6f72 5f63 7265 6174  ager.error_creat
+00018700: 696e 675f 636f 7079 5f70 6970 655f 7461  ing_copy_pipe_ta
+00018710: 7267 6574 5f64 6174 6173 6f75 7263 655f  rget_datasource_
+00018720: 7265 7175 6972 6564 2829 290a 0a20 2020  required())..   
+00018730: 2074 7279 3a0a 2020 2020 2020 2020 6177   try:.        aw
+00018740: 6169 7420 7462 5f63 6c69 656e 742e 6765  ait tb_client.ge
+00018750: 745f 6461 7461 736f 7572 6365 2874 6172  t_datasource(tar
+00018760: 6765 745f 6461 7461 736f 7572 6365 290a  get_datasource).
+00018770: 2020 2020 6578 6365 7074 2044 6f65 734e      except DoesN
+00018780: 6f74 4578 6973 7445 7863 6570 7469 6f6e  otExistException
+00018790: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+000187a0: 434c 4950 6970 6545 7863 6570 7469 6f6e  CLIPipeException
+000187b0: 280a 2020 2020 2020 2020 2020 2020 4665  (.            Fe
+000187c0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
+000187d0: 726f 725f 6372 6561 7469 6e67 5f63 6f70  ror_creating_cop
+000187e0: 795f 7069 7065 5f74 6172 6765 745f 6461  y_pipe_target_da
+000187f0: 7461 736f 7572 6365 5f6e 6f74 5f66 6f75  tasource_not_fou
+00018800: 6e64 2874 6172 6765 745f 6461 7461 736f  nd(target_dataso
+00018810: 7572 6365 3d74 6172 6765 745f 6461 7461  urce=target_data
+00018820: 736f 7572 6365 290a 2020 2020 2020 2020  source).        
+00018830: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
+00018840: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00018850: 2020 2020 2072 6169 7365 2043 4c49 5069       raise CLIPi
+00018860: 7065 4578 6365 7074 696f 6e28 4665 6564  peException(Feed
+00018870: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+00018880: 725f 6578 6365 7074 696f 6e28 6572 726f  r_exception(erro
+00018890: 723d 6529 290a 0a20 2020 2073 6368 6564  r=e))..    sched
+000188a0: 756c 655f 6372 6f6e 203d 2063 6f70 795f  ule_cron = copy_
+000188b0: 6e6f 6465 5b22 7061 7261 6d73 225d 2e67  node["params"].g
+000188c0: 6574 2843 6f70 7950 6172 616d 6574 6572  et(CopyParameter
+000188d0: 732e 434f 5059 5f53 4348 4544 554c 452c  s.COPY_SCHEDULE,
+000188e0: 204e 6f6e 6529 0a20 2020 2069 735f 7661   None).    is_va
+000188f0: 6c69 645f 6372 6f6e 203d 206e 6f74 2073  lid_cron = not s
+00018900: 6368 6564 756c 655f 6372 6f6e 206f 7220  chedule_cron or 
+00018910: 280a 2020 2020 2020 2020 7363 6865 6475  (.        schedu
+00018920: 6c65 5f63 726f 6e20 616e 6420 2873 6368  le_cron and (sch
+00018930: 6564 756c 655f 6372 6f6e 203d 3d20 4f4e  edule_cron == ON
+00018940: 5f44 454d 414e 4420 6f72 2063 726f 6e69  _DEMAND or croni
+00018950: 7465 722e 6973 5f76 616c 6964 2873 6368  ter.is_valid(sch
+00018960: 6564 756c 655f 6372 6f6e 2929 0a20 2020  edule_cron)).   
+00018970: 2029 0a0a 2020 2020 6966 206e 6f74 2069   )..    if not i
+00018980: 735f 7661 6c69 645f 6372 6f6e 3a0a 2020  s_valid_cron:.  
+00018990: 2020 2020 2020 7261 6973 6520 434c 4950        raise CLIP
+000189a0: 6970 6545 7863 6570 7469 6f6e 2846 6565  ipeException(Fee
+000189b0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+000189c0: 6f72 5f63 7265 6174 696e 675f 636f 7079  or_creating_copy
+000189d0: 5f70 6970 655f 696e 7661 6c69 645f 6372  _pipe_invalid_cr
+000189e0: 6f6e 2873 6368 6564 756c 655f 6372 6f6e  on(schedule_cron
+000189f0: 3d73 6368 6564 756c 655f 6372 6f6e 2929  =schedule_cron))
+00018a00: 0a0a 2020 2020 6966 206e 6f74 2070 6970  ..    if not pip
+00018a10: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00018a20: 6e0a 0a20 2020 2070 6970 655f 6e61 6d65  n..    pipe_name
+00018a30: 203d 2070 6970 655b 226e 616d 6522 5d0a   = pipe["name"].
+00018a40: 2020 2020 7069 7065 5f74 7970 6520 3d20      pipe_type = 
+00018a50: 7069 7065 5b22 7479 7065 225d 0a0a 2020  pipe["type"]..  
+00018a60: 2020 6966 2070 6970 655f 7479 7065 203d    if pipe_type =
+00018a70: 3d20 5069 7065 5479 7065 732e 454e 4450  = PipeTypes.ENDP
+00018a80: 4f49 4e54 3a0a 2020 2020 2020 2020 6177  OINT:.        aw
+00018a90: 6169 7420 7462 5f63 6c69 656e 742e 7069  ait tb_client.pi
+00018aa0: 7065 5f72 656d 6f76 655f 656e 6470 6f69  pe_remove_endpoi
+00018ab0: 6e74 2870 6970 655f 6e61 6d65 2c20 7069  nt(pipe_name, pi
+00018ac0: 7065 5b22 656e 6470 6f69 6e74 225d 290a  pe["endpoint"]).
+00018ad0: 0a20 2020 2069 6620 7069 7065 5f74 7970  .    if pipe_typ
+00018ae0: 6520 3d3d 2050 6970 6554 7970 6573 2e44  e == PipeTypes.D
+00018af0: 4154 415f 5349 4e4b 3a0a 2020 2020 2020  ATA_SINK:.      
+00018b00: 2020 6177 6169 7420 7462 5f63 6c69 656e    await tb_clien
+00018b10: 742e 7069 7065 5f72 656d 6f76 655f 7369  t.pipe_remove_si
+00018b20: 6e6b 2870 6970 655f 6e61 6d65 2c20 7069  nk(pipe_name, pi
+00018b30: 7065 5b22 7369 6e6b 5f6e 6f64 6522 5d29  pe["sink_node"])
+00018b40: 0a0a 0a61 7379 6e63 2064 6566 2063 6865  ...async def che
+00018b50: 636b 5f73 696e 6b5f 7069 7065 2870 6970  ck_sink_pipe(pip
+00018b60: 652c 2073 696e 6b5f 6e6f 6465 2c20 7462  e, sink_node, tb
+00018b70: 5f63 6c69 656e 743a 2054 696e 7942 293a  _client: TinyB):
+00018b80: 0a20 2020 2069 6620 6e6f 7420 7369 6e6b  .    if not sink
+00018b90: 5f6e 6f64 655b 2265 7870 6f72 745f 7061  _node["export_pa
+00018ba0: 7261 6d73 225d 3a0a 2020 2020 2020 2020  rams"]:.        
+00018bb0: 7265 7475 726e 0a0a 2020 2020 6966 206e  return..    if n
+00018bc0: 6f74 2070 6970 653a 0a20 2020 2020 2020  ot pipe:.       
+00018bd0: 2072 6574 7572 6e0a 0a20 2020 2070 6970   return..    pip
+00018be0: 655f 6e61 6d65 203d 2070 6970 655b 226e  e_name = pipe["n
+00018bf0: 616d 6522 5d0a 2020 2020 7069 7065 5f74  ame"].    pipe_t
+00018c00: 7970 6520 3d20 7069 7065 5b22 7479 7065  ype = pipe["type
+00018c10: 225d 0a0a 2020 2020 7363 6865 6475 6c65  "]..    schedule
+00018c20: 5f63 726f 6e20 3d20 7369 6e6b 5f6e 6f64  _cron = sink_nod
+00018c30: 655b 2265 7870 6f72 745f 7061 7261 6d73  e["export_params
+00018c40: 225d 2e67 6574 2822 7363 6865 6475 6c65  "].get("schedule
+00018c50: 5f63 726f 6e22 2c20 2222 290a 2020 2020  _cron", "").    
+00018c60: 6973 5f76 616c 6964 5f63 726f 6e20 3d20  is_valid_cron = 
+00018c70: 6e6f 7420 7363 6865 6475 6c65 5f63 726f  not schedule_cro
+00018c80: 6e20 6f72 2028 7363 6865 6475 6c65 5f63  n or (schedule_c
+00018c90: 726f 6e20 616e 6420 6372 6f6e 6974 6572  ron and croniter
+00018ca0: 2e69 735f 7661 6c69 6428 7363 6865 6475  .is_valid(schedu
+00018cb0: 6c65 5f63 726f 6e29 290a 0a20 2020 2069  le_cron))..    i
+00018cc0: 6620 6e6f 7420 6973 5f76 616c 6964 5f63  f not is_valid_c
+00018cd0: 726f 6e3a 0a20 2020 2020 2020 2072 6169  ron:.        rai
+00018ce0: 7365 2043 4c49 5069 7065 4578 6365 7074  se CLIPipeExcept
+00018cf0: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+00018d00: 6765 722e 6572 726f 725f 6372 6561 7469  ger.error_creati
+00018d10: 6e67 5f73 696e 6b5f 7069 7065 5f69 6e76  ng_sink_pipe_inv
+00018d20: 616c 6964 5f63 726f 6e28 7363 6865 6475  alid_cron(schedu
+00018d30: 6c65 5f63 726f 6e3d 7363 6865 6475 6c65  le_cron=schedule
+00018d40: 5f63 726f 6e29 290a 0a20 2020 2069 6620  _cron))..    if 
+00018d50: 7069 7065 5f74 7970 6520 3d3d 2050 6970  pipe_type == Pip
+00018d60: 6554 7970 6573 2e45 4e44 504f 494e 543a  eTypes.ENDPOINT:
+00018d70: 0a20 2020 2020 2020 2061 7761 6974 2074  .        await t
+00018d80: 625f 636c 6965 6e74 2e70 6970 655f 7265  b_client.pipe_re
+00018d90: 6d6f 7665 5f65 6e64 706f 696e 7428 7069  move_endpoint(pi
+00018da0: 7065 5f6e 616d 652c 2070 6970 655b 2265  pe_name, pipe["e
+00018db0: 6e64 706f 696e 7422 5d29 0a0a 2020 2020  ndpoint"])..    
+00018dc0: 6966 2070 6970 655f 7479 7065 203d 3d20  if pipe_type == 
+00018dd0: 5069 7065 5479 7065 732e 434f 5059 3a0a  PipeTypes.COPY:.
+00018de0: 2020 2020 2020 2020 6177 6169 7420 7462          await tb
+00018df0: 5f63 6c69 656e 742e 7069 7065 5f72 656d  _client.pipe_rem
+00018e00: 6f76 655f 636f 7079 2870 6970 655f 6e61  ove_copy(pipe_na
+00018e10: 6d65 2c20 7069 7065 5b22 636f 7079 5f6e  me, pipe["copy_n
+00018e20: 6f64 6522 5d29 0a0a 0a64 6566 2073 686f  ode"])...def sho
+00018e30: 775f 6d61 7465 7269 616c 697a 6564 5f76  w_materialized_v
+00018e40: 6965 775f 7761 726e 696e 6773 2877 6172  iew_warnings(war
+00018e50: 6e69 6e67 7329 3a0a 2020 2020 2222 220a  nings):.    """.
+00018e60: 2020 2020 3e3e 3e20 7368 6f77 5f6d 6174      >>> show_mat
+00018e70: 6572 6961 6c69 7a65 645f 7669 6577 5f77  erialized_view_w
+00018e80: 6172 6e69 6e67 7328 5b7b 2763 6f64 6527  arnings([{'code'
+00018e90: 3a20 2753 494d 272c 2027 7765 6967 6874  : 'SIM', 'weight
+00018ea0: 273a 2031 7d5d 290a 0a20 2020 203e 3e3e  ': 1}])..    >>>
+00018eb0: 2073 686f 775f 6d61 7465 7269 616c 697a   show_materializ
+00018ec0: 6564 5f76 6965 775f 7761 726e 696e 6773  ed_view_warnings
+00018ed0: 285b 7b27 636f 6465 273a 2027 5349 4d27  ([{'code': 'SIM'
+00018ee0: 2c20 2777 6569 6768 7427 3a20 317d 2c20  , 'weight': 1}, 
+00018ef0: 7b27 636f 6465 273a 2027 4855 4745 5f4a  {'code': 'HUGE_J
+00018f00: 4f49 4e27 2c20 2777 6569 6768 7427 3a20  OIN', 'weight': 
+00018f10: 327d 2c20 7b27 7465 7874 273a 2022 436f  2}, {'text': "Co
+00018f20: 6c75 6d6e 2027 6e75 6d62 6572 2720 6973  lumn 'number' is
+00018f30: 2070 7265 7365 6e74 2069 6e20 7468 6520   present in the 
+00018f40: 4752 4f55 5020 4259 2062 7574 206e 6f74  GROUP BY but not
+00018f50: 2069 6e20 7468 6520 5345 4c45 4354 2063   in the SELECT c
+00018f60: 6c61 7573 652e 2054 6869 7320 6d69 6768  lause. This migh
+00018f70: 7420 696e 6469 6361 7465 2061 206e 6f74  t indicate a not
+00018f80: 2076 616c 6964 204d 6174 6572 6961 6c69   valid Materiali
+00018f90: 7a65 6420 5669 6577 2c20 706c 6561 7365  zed View, please
+00018fa0: 206d 616b 6520 7375 7265 2079 6f75 2061   make sure you a
+00018fb0: 6767 7265 6761 7465 2061 6e64 2047 524f  ggregate and GRO
+00018fc0: 5550 2042 5920 696e 2074 6865 2074 6f70  UP BY in the top
+00018fd0: 6d6f 7374 2071 7565 7279 2e22 2c20 2763  most query.", 'c
+00018fe0: 6f64 6527 3a20 2747 524f 5550 5f42 5927  ode': 'GROUP_BY'
+00018ff0: 2c20 2777 6569 6768 7427 3a20 3130 302c  , 'weight': 100,
+00019000: 2027 646f 6375 6d65 6e74 6174 696f 6e27   'documentation'
+00019010: 3a20 2768 7474 7073 3a2f 2f74 696e 7962  : 'https://tinyb
+00019020: 6972 642e 636f 2f64 6f63 732f 6775 6964  ird.co/docs/guid
+00019030: 6573 2f6d 6174 6572 6961 6c69 7a65 642d  es/materialized-
+00019040: 7669 6577 732e 6874 6d6c 2375 7365 2d74  views.html#use-t
+00019050: 6865 2d73 616d 652d 616c 6961 732d 696e  he-same-alias-in
+00019060: 2d73 656c 6563 742d 616e 642d 6772 6f75  -select-and-grou
+00019070: 702d 6279 277d 5d29 0a20 2020 20e2 9aa0  p-by'}]).    ...
+00019080: efb8 8f20 2043 6f6c 756d 6e20 276e 756d  ...  Column 'num
+00019090: 6265 7227 2069 7320 7072 6573 656e 7420  ber' is present 
+000190a0: 696e 2074 6865 2047 524f 5550 2042 5920  in the GROUP BY 
+000190b0: 6275 7420 6e6f 7420 696e 2074 6865 2053  but not in the S
+000190c0: 454c 4543 5420 636c 6175 7365 2e20 5468  ELECT clause. Th
+000190d0: 6973 206d 6967 6874 2069 6e64 6963 6174  is might indicat
+000190e0: 6520 6120 6e6f 7420 7661 6c69 6420 4d61  e a not valid Ma
+000190f0: 7465 7269 616c 697a 6564 2056 6965 772c  terialized View,
+00019100: 2070 6c65 6173 6520 6d61 6b65 2073 7572   please make sur
+00019110: 6520 796f 7520 6167 6772 6567 6174 6520  e you aggregate 
+00019120: 616e 6420 4752 4f55 5020 4259 2069 6e20  and GROUP BY in 
+00019130: 7468 6520 746f 706d 6f73 7420 7175 6572  the topmost quer
+00019140: 792e 2046 6f72 206d 6f72 6520 696e 666f  y. For more info
+00019150: 726d 6174 696f 6e20 7265 6164 2068 7474  rmation read htt
+00019160: 7073 3a2f 2f74 696e 7962 6972 642e 636f  ps://tinybird.co
+00019170: 2f64 6f63 732f 6775 6964 6573 2f6d 6174  /docs/guides/mat
+00019180: 6572 6961 6c69 7a65 642d 7669 6577 732e  erialized-views.
+00019190: 6874 6d6c 2375 7365 2d74 6865 2d73 616d  html#use-the-sam
+000191a0: 652d 616c 6961 732d 696e 2d73 656c 6563  e-alias-in-selec
+000191b0: 742d 616e 642d 6772 6f75 702d 6279 206f  t-and-group-by o
+000191c0: 7220 636f 6e74 6163 7420 7573 2061 7420  r contact us at 
+000191d0: 7375 7070 6f72 7440 7469 6e79 6269 7264  support@tinybird
+000191e0: 2e63 6f0a 2020 2020 3e3e 3e20 7368 6f77  .co.    >>> show
+000191f0: 5f6d 6174 6572 6961 6c69 7a65 645f 7669  _materialized_vi
+00019200: 6577 5f77 6172 6e69 6e67 7328 5b7b 2763  ew_warnings([{'c
+00019210: 6f64 6527 3a20 2753 494e 474c 455f 4a4f  ode': 'SINGLE_JO
+00019220: 494e 272c 2027 7765 6967 6874 273a 2033  IN', 'weight': 3
+00019230: 3030 7d2c 207b 2774 6578 7427 3a20 2243  00}, {'text': "C
+00019240: 6f6c 756d 6e20 276e 756d 6265 7227 2069  olumn 'number' i
+00019250: 7320 7072 6573 656e 7420 696e 2074 6865  s present in the
+00019260: 2047 524f 5550 2042 5920 6275 7420 6e6f   GROUP BY but no
+00019270: 7420 696e 2074 6865 2053 454c 4543 5420  t in the SELECT 
+00019280: 636c 6175 7365 2e20 5468 6973 206d 6967  clause. This mig
+00019290: 6874 2069 6e64 6963 6174 6520 6120 6e6f  ht indicate a no
+000192a0: 7420 7661 6c69 6420 4d61 7465 7269 616c  t valid Material
+000192b0: 697a 6564 2056 6965 772c 2070 6c65 6173  ized View, pleas
+000192c0: 6520 6d61 6b65 2073 7572 6520 796f 7520  e make sure you 
+000192d0: 6167 6772 6567 6174 6520 616e 6420 4752  aggregate and GR
+000192e0: 4f55 5020 4259 2069 6e20 7468 6520 746f  OUP BY in the to
+000192f0: 706d 6f73 7420 7175 6572 792e 222c 2027  pmost query.", '
+00019300: 636f 6465 273a 2027 4752 4f55 505f 4259  code': 'GROUP_BY
+00019310: 272c 2027 7765 6967 6874 273a 2031 3030  ', 'weight': 100
+00019320: 2c20 2764 6f63 756d 656e 7461 7469 6f6e  , 'documentation
+00019330: 273a 2027 6874 7470 733a 2f2f 7469 6e79  ': 'https://tiny
+00019340: 6269 7264 2e63 6f2f 646f 6373 2f67 7569  bird.co/docs/gui
+00019350: 6465 732f 6d61 7465 7269 616c 697a 6564  des/materialized
+00019360: 2d76 6965 7773 2e68 746d 6c23 7573 652d  -views.html#use-
+00019370: 7468 652d 7361 6d65 2d61 6c69 6173 2d69  the-same-alias-i
+00019380: 6e2d 7365 6c65 6374 2d61 6e64 2d67 726f  n-select-and-gro
+00019390: 7570 2d62 7927 7d5d 290a 2020 2020 e29a  up-by'}]).    ..
+000193a0: a0ef b88f 2020 436f 6c75 6d6e 2027 6e75  ....  Column 'nu
+000193b0: 6d62 6572 2720 6973 2070 7265 7365 6e74  mber' is present
+000193c0: 2069 6e20 7468 6520 4752 4f55 5020 4259   in the GROUP BY
+000193d0: 2062 7574 206e 6f74 2069 6e20 7468 6520   but not in the 
+000193e0: 5345 4c45 4354 2063 6c61 7573 652e 2054  SELECT clause. T
+000193f0: 6869 7320 6d69 6768 7420 696e 6469 6361  his might indica
+00019400: 7465 2061 206e 6f74 2076 616c 6964 204d  te a not valid M
+00019410: 6174 6572 6961 6c69 7a65 6420 5669 6577  aterialized View
+00019420: 2c20 706c 6561 7365 206d 616b 6520 7375  , please make su
+00019430: 7265 2079 6f75 2061 6767 7265 6761 7465  re you aggregate
+00019440: 2061 6e64 2047 524f 5550 2042 5920 696e   and GROUP BY in
+00019450: 2074 6865 2074 6f70 6d6f 7374 2071 7565   the topmost que
+00019460: 7279 2e20 466f 7220 6d6f 7265 2069 6e66  ry. For more inf
+00019470: 6f72 6d61 7469 6f6e 2072 6561 6420 6874  ormation read ht
+00019480: 7470 733a 2f2f 7469 6e79 6269 7264 2e63  tps://tinybird.c
+00019490: 6f2f 646f 6373 2f67 7569 6465 732f 6d61  o/docs/guides/ma
+000194a0: 7465 7269 616c 697a 6564 2d76 6965 7773  terialized-views
+000194b0: 2e68 746d 6c23 7573 652d 7468 652d 7361  .html#use-the-sa
+000194c0: 6d65 2d61 6c69 6173 2d69 6e2d 7365 6c65  me-alias-in-sele
+000194d0: 6374 2d61 6e64 2d67 726f 7570 2d62 7920  ct-and-group-by 
+000194e0: 6f72 2063 6f6e 7461 6374 2075 7320 6174  or contact us at
+000194f0: 2073 7570 706f 7274 4074 696e 7962 6972   support@tinybir
+00019500: 642e 636f 0a20 2020 2022 2222 0a20 2020  d.co.    """.   
+00019510: 2065 7863 6c75 6465 645f 7761 726e 696e   excluded_warnin
+00019520: 6773 203d 205b 2253 494d 222c 2022 5349  gs = ["SIM", "SI
+00019530: 4d5f 554e 4b4e 4f57 4e22 2c20 2248 5547  M_UNKNOWN", "HUG
+00019540: 455f 4a4f 494e 225d 0a20 2020 2073 6f72  E_JOIN"].    sor
+00019550: 7465 645f 7761 726e 696e 6773 203d 2073  ted_warnings = s
+00019560: 6f72 7465 6428 7761 726e 696e 6773 2c20  orted(warnings, 
+00019570: 6b65 793d 6c61 6d62 6461 2077 6172 6e69  key=lambda warni
+00019580: 6e67 3a20 7761 726e 696e 675b 2277 6569  ng: warning["wei
+00019590: 6768 7422 5d29 0a20 2020 206d 6f73 745f  ght"]).    most_
+000195a0: 696d 706f 7274 616e 745f 7761 726e 696e  important_warnin
+000195b0: 6720 3d20 7b7d 0a20 2020 2066 6f72 2077  g = {}.    for w
+000195c0: 6172 6e69 6e67 2069 6e20 736f 7274 6564  arning in sorted
+000195d0: 5f77 6172 6e69 6e67 733a 0a20 2020 2020  _warnings:.     
+000195e0: 2020 2069 6620 7761 726e 696e 672e 6765     if warning.ge
+000195f0: 7428 2263 6f64 6522 2920 616e 6420 7761  t("code") and wa
+00019600: 726e 696e 675b 2263 6f64 6522 5d20 6e6f  rning["code"] no
+00019610: 7420 696e 2065 7863 6c75 6465 645f 7761  t in excluded_wa
+00019620: 726e 696e 6773 3a0a 2020 2020 2020 2020  rnings:.        
+00019630: 2020 2020 6d6f 7374 5f69 6d70 6f72 7461      most_importa
+00019640: 6e74 5f77 6172 6e69 6e67 203d 2077 6172  nt_warning = war
+00019650: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+00019660: 2062 7265 616b 0a20 2020 2069 6620 6d6f   break.    if mo
+00019670: 7374 5f69 6d70 6f72 7461 6e74 5f77 6172  st_important_war
+00019680: 6e69 6e67 3a0a 2020 2020 2020 2020 636c  ning:.        cl
+00019690: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
+000196a0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+000196b0: 6e61 6765 722e 7369 6e67 6c65 5f77 6172  nager.single_war
+000196c0: 6e69 6e67 5f6d 6174 6572 6961 6c69 7a65  ning_materialize
+000196d0: 645f 7069 7065 280a 2020 2020 2020 2020  d_pipe(.        
+000196e0: 2020 2020 2020 2020 636f 6e74 656e 743d          content=
+000196f0: 6d6f 7374 5f69 6d70 6f72 7461 6e74 5f77  most_important_w
+00019700: 6172 6e69 6e67 5b22 7465 7874 225d 2c20  arning["text"], 
+00019710: 646f 6373 5f75 726c 3d6d 6f73 745f 696d  docs_url=most_im
+00019720: 706f 7274 616e 745f 7761 726e 696e 675b  portant_warning[
+00019730: 2264 6f63 756d 656e 7461 7469 6f6e 225d  "documentation"]
+00019740: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00019750: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
+00019760: 2064 6566 2067 6574 5f74 6f6b 656e 5f66   def get_token_f
+00019770: 726f 6d5f 6d61 696e 5f62 7261 6e63 6828  rom_main_branch(
+00019780: 6272 616e 6368 5f74 625f 636c 6965 6e74  branch_tb_client
+00019790: 3a20 5469 6e79 4229 202d 3e20 4f70 7469  : TinyB) -> Opti
+000197a0: 6f6e 616c 5b73 7472 5d3a 0a20 2020 2074  onal[str]:.    t
+000197b0: 6f6b 656e 5f66 726f 6d5f 6d61 696e 5f62  oken_from_main_b
+000197c0: 7261 6e63 6820 3d20 4e6f 6e65 0a20 2020  ranch = None.   
+000197d0: 2063 7572 7265 6e74 5f77 6f72 6b73 7061   current_workspa
+000197e0: 6365 203d 2061 7761 6974 2062 7261 6e63  ce = await branc
+000197f0: 685f 7462 5f63 6c69 656e 742e 776f 726b  h_tb_client.work
+00019800: 7370 6163 655f 696e 666f 2829 0a20 2020  space_info().   
+00019810: 2023 2063 7572 7265 6e74 2077 6f72 6b73   # current works
+00019820: 7061 6365 2069 7320 6120 6272 616e 6368  pace is a branch
+00019830: 0a20 2020 2069 6620 6375 7272 656e 745f  .    if current_
+00019840: 776f 726b 7370 6163 652e 6765 7428 226d  workspace.get("m
+00019850: 6169 6e22 293a 0a20 2020 2020 2020 2072  ain"):.        r
+00019860: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+00019870: 6272 616e 6368 5f74 625f 636c 6965 6e74  branch_tb_client
+00019880: 2e75 7365 725f 776f 726b 7370 6163 6573  .user_workspaces
+00019890: 2829 0a20 2020 2020 2020 2077 6f72 6b73  ().        works
+000198a0: 7061 6365 7320 3d20 7265 7370 6f6e 7365  paces = response
+000198b0: 5b22 776f 726b 7370 6163 6573 225d 0a20  ["workspaces"]. 
+000198c0: 2020 2020 2020 2070 726f 645f 776f 726b         prod_work
+000198d0: 7370 6163 6520 3d20 6e65 7874 280a 2020  space = next(.  
+000198e0: 2020 2020 2020 2020 2020 2877 6f72 6b73            (works
+000198f0: 7061 6365 2066 6f72 2077 6f72 6b73 7061  pace for workspa
+00019900: 6365 2069 6e20 776f 726b 7370 6163 6573  ce in workspaces
+00019910: 2069 6620 776f 726b 7370 6163 655b 2269   if workspace["i
+00019920: 6422 5d20 3d3d 2063 7572 7265 6e74 5f77  d"] == current_w
+00019930: 6f72 6b73 7061 6365 5b22 6d61 696e 225d  orkspace["main"]
+00019940: 292c 204e 6f6e 650a 2020 2020 2020 2020  ), None.        
+00019950: 290a 2020 2020 2020 2020 6966 2070 726f  ).        if pro
+00019960: 645f 776f 726b 7370 6163 653a 0a20 2020  d_workspace:.   
+00019970: 2020 2020 2020 2020 2074 6f6b 656e 5f66           token_f
+00019980: 726f 6d5f 6d61 696e 5f62 7261 6e63 6820  rom_main_branch 
+00019990: 3d20 7072 6f64 5f77 6f72 6b73 7061 6365  = prod_workspace
+000199a0: 2e67 6574 2822 746f 6b65 6e22 290a 2020  .get("token").  
+000199b0: 2020 7265 7475 726e 2074 6f6b 656e 5f66    return token_f
+000199c0: 726f 6d5f 6d61 696e 5f62 7261 6e63 680a  rom_main_branch.
+000199d0: 0a0a 6173 796e 6320 6465 6620 6e65 775f  ..async def new_
+000199e0: 7069 7065 280a 2020 2020 702c 0a20 2020  pipe(.    p,.   
+000199f0: 2074 625f 636c 6965 6e74 3a20 5469 6e79   tb_client: Tiny
+00019a00: 422c 0a20 2020 2066 6f72 6365 3a20 626f  B,.    force: bo
+00019a10: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00019a20: 6368 6563 6b3a 2062 6f6f 6c20 3d20 5472  check: bool = Tr
+00019a30: 7565 2c0a 2020 2020 706f 7075 6c61 7465  ue,.    populate
+00019a40: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00019a50: 2020 2020 706f 7075 6c61 7465 5f73 7562      populate_sub
+00019a60: 7365 743d 4e6f 6e65 2c0a 2020 2020 706f  set=None,.    po
+00019a70: 7075 6c61 7465 5f63 6f6e 6469 7469 6f6e  pulate_condition
+00019a80: 3d4e 6f6e 652c 0a20 2020 2075 6e6c 696e  =None,.    unlin
+00019a90: 6b5f 6f6e 5f70 6f70 756c 6174 655f 6572  k_on_populate_er
+00019aa0: 726f 723a 2062 6f6f 6c20 3d20 4661 6c73  ror: bool = Fals
+00019ab0: 652c 0a20 2020 2077 6169 745f 706f 7075  e,.    wait_popu
+00019ac0: 6c61 7465 3a20 626f 6f6c 203d 2046 616c  late: bool = Fal
+00019ad0: 7365 2c0a 2020 2020 736b 6970 5f74 6f6b  se,.    skip_tok
+00019ae0: 656e 733a 2062 6f6f 6c20 3d20 4661 6c73  ens: bool = Fals
+00019af0: 652c 0a20 2020 2069 676e 6f72 655f 7371  e,.    ignore_sq
+00019b00: 6c5f 6572 726f 7273 3a20 626f 6f6c 203d  l_errors: bool =
+00019b10: 2046 616c 7365 2c0a 2020 2020 6f6e 6c79   False,.    only
+00019b20: 5f72 6573 706f 6e73 655f 7469 6d65 733a  _response_times:
+00019b30: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00019b40: 2020 2072 756e 5f74 6573 7473 3a20 626f     run_tests: bo
+00019b50: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00019b60: 6173 5f73 7461 6e64 6172 643a 2062 6f6f  as_standard: boo
+00019b70: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
+00019b80: 6573 7473 5f74 6f5f 7275 6e3a 2069 6e74  ests_to_run: int
+00019b90: 203d 2030 2c0a 2020 2020 7465 7374 735f   = 0,.    tests_
+00019ba0: 746f 5f73 616d 706c 655f 6279 5f70 6172  to_sample_by_par
+00019bb0: 616d 733a 2069 6e74 203d 2030 2c0a 2020  ams: int = 0,.  
+00019bc0: 2020 7465 7374 735f 6669 6c74 6572 5f62    tests_filter_b
+00019bd0: 793a 204f 7074 696f 6e61 6c5b 4c69 7374  y: Optional[List
+00019be0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00019bf0: 2020 2074 6573 7473 5f66 6169 6c66 6173     tests_failfas
+00019c00: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
+00019c10: 0a20 2020 2074 6573 7473 5f69 676e 6f72  .    tests_ignor
+00019c20: 655f 6f72 6465 723a 2062 6f6f 6c20 3d20  e_order: bool = 
+00019c30: 4661 6c73 652c 0a20 2020 2074 6573 7473  False,.    tests
+00019c40: 5f76 616c 6964 6174 655f 7072 6f63 6573  _validate_proces
+00019c50: 7365 645f 6279 7465 733a 2062 6f6f 6c20  sed_bytes: bool 
+00019c60: 3d20 4661 6c73 652c 0a20 2020 206f 7665  = False,.    ove
+00019c70: 7272 6964 655f 6461 7461 736f 7572 6365  rride_datasource
+00019c80: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00019c90: 2020 2020 7465 7374 735f 6368 6563 6b5f      tests_check_
+00019ca0: 7265 7175 6573 7473 5f66 726f 6d5f 6272  requests_from_br
+00019cb0: 616e 6368 3a20 626f 6f6c 203d 2046 616c  anch: bool = Fal
+00019cc0: 7365 2c0a 2020 2020 636f 6e66 6967 3a20  se,.    config: 
+00019cd0: 416e 7920 3d20 4e6f 6e65 2c0a 2020 2020  Any = None,.    
+00019ce0: 666f 726b 5f64 6f77 6e73 7472 6561 6d3a  fork_downstream:
+00019cf0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00019d00: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
+00019d10: 6b3a 204f 7074 696f 6e61 6c5b 626f 6f6c  k: Optional[bool
+00019d20: 5d20 3d20 4661 6c73 652c 0a29 3a20 2023  ] = False,.):  #
+00019d30: 206e 6f71 613a 2043 3930 310a 2020 2020   noqa: C901.    
+00019d40: 2320 544f 444f 2075 7365 2074 625f 636c  # TODO use tb_cl
+00019d50: 6965 6e74 2069 6e73 7465 6164 206f 6620  ient instead of 
+00019d60: 6361 6c6c 696e 6720 7468 6520 7572 6c73  calling the urls
+00019d70: 2064 6972 6563 746c 792e 0a20 2020 2068   directly..    h
+00019d80: 6f73 7420 3d20 7462 5f63 6c69 656e 742e  ost = tb_client.
+00019d90: 686f 7374 0a20 2020 2074 6f6b 656e 203d  host.    token =
+00019da0: 2074 625f 636c 6965 6e74 2e74 6f6b 656e   tb_client.token
+00019db0: 0a0a 2020 2020 6865 6164 6572 7320 3d20  ..    headers = 
+00019dc0: 7b22 4175 7468 6f72 697a 6174 696f 6e22  {"Authorization"
+00019dd0: 3a20 6622 4265 6172 6572 207b 746f 6b65  : f"Bearer {toke
+00019de0: 6e7d 227d 0a0a 2020 2020 636c 695f 7061  n}"}..    cli_pa
+00019df0: 7261 6d73 203d 207b 7d0a 2020 2020 636c  rams = {}.    cl
+00019e00: 695f 7061 7261 6d73 5b22 636c 695f 7665  i_params["cli_ve
+00019e10: 7273 696f 6e22 5d20 3d20 7462 5f63 6c69  rsion"] = tb_cli
+00019e20: 656e 742e 7665 7273 696f 6e0a 2020 2020  ent.version.    
+00019e30: 636c 695f 7061 7261 6d73 5b22 6465 7363  cli_params["desc
+00019e40: 7269 7074 696f 6e22 5d20 3d20 702e 6765  ription"] = p.ge
+00019e50: 7428 2264 6573 6372 6970 7469 6f6e 222c  t("description",
+00019e60: 2022 2229 0a20 2020 2063 6c69 5f70 6172   "").    cli_par
+00019e70: 616d 735b 2269 676e 6f72 655f 7371 6c5f  ams["ignore_sql_
+00019e80: 6572 726f 7273 225d 203d 2022 7472 7565  errors"] = "true
+00019e90: 2220 6966 2069 676e 6f72 655f 7371 6c5f  " if ignore_sql_
+00019ea0: 6572 726f 7273 2065 6c73 6520 2266 616c  errors else "fal
+00019eb0: 7365 220a 0a20 2020 2072 3a20 7265 7175  se"..    r: requ
+00019ec0: 6573 7473 2e52 6573 706f 6e73 6520 3d20  ests.Response = 
+00019ed0: 6177 6169 7420 7265 7175 6573 7473 5f67  await requests_g
+00019ee0: 6574 2866 227b 686f 7374 7d2f 7630 2f70  et(f"{host}/v0/p
+00019ef0: 6970 6573 2f7b 705b 276e 616d 6527 5d7d  ipes/{p['name']}
+00019f00: 3f7b 7572 6c65 6e63 6f64 6528 636c 695f  ?{urlencode(cli_
+00019f10: 7061 7261 6d73 297d 222c 2068 6561 6465  params)}", heade
+00019f20: 7273 3d68 6561 6465 7273 290a 0a20 2020  rs=headers)..   
+00019f30: 2063 7572 7265 6e74 5f70 6970 6520 3d20   current_pipe = 
+00019f40: 722e 6a73 6f6e 2829 2069 6620 722e 7374  r.json() if r.st
+00019f50: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+00019f60: 2065 6c73 6520 4e6f 6e65 0a20 2020 2070   else None.    p
+00019f70: 6970 655f 6578 6973 7473 203d 2063 7572  ipe_exists = cur
+00019f80: 7265 6e74 5f70 6970 6520 6973 206e 6f74  rent_pipe is not
+00019f90: 204e 6f6e 650a 0a20 2020 2069 735f 6d61   None..    is_ma
+00019fa0: 7465 7269 616c 697a 6564 203d 2061 6e79  terialized = any
+00019fb0: 285b 6e6f 6465 2e67 6574 2822 7061 7261  ([node.get("para
+00019fc0: 6d73 222c 207b 7d29 2e67 6574 2822 7479  ms", {}).get("ty
+00019fd0: 7065 222c 204e 6f6e 6529 203d 3d20 226d  pe", None) == "m
+00019fe0: 6174 6572 6961 6c69 7a65 6422 2066 6f72  aterialized" for
+00019ff0: 206e 6f64 6520 696e 2070 5b22 6e6f 6465   node in p["node
+0001a000: 7322 5d5d 290a 2020 2020 636f 7079 5f6e  s"]]).    copy_n
+0001a010: 6f64 6520 3d20 6e65 7874 2828 6e6f 6465  ode = next((node
+0001a020: 2066 6f72 206e 6f64 6520 696e 2070 5b22   for node in p["
+0001a030: 6e6f 6465 7322 5d20 6966 206e 6f64 652e  nodes"] if node.
+0001a040: 6765 7428 2270 6172 616d 7322 2c20 7b7d  get("params", {}
+0001a050: 292e 6765 7428 2274 7970 6522 2c20 4e6f  ).get("type", No
+0001a060: 6e65 2920 3d3d 2022 636f 7079 2229 2c20  ne) == "copy"), 
+0001a070: 4e6f 6e65 290a 2020 2020 7369 6e6b 5f6e  None).    sink_n
+0001a080: 6f64 6520 3d20 6e65 7874 2828 6e6f 6465  ode = next((node
+0001a090: 2066 6f72 206e 6f64 6520 696e 2070 5b22   for node in p["
+0001a0a0: 6e6f 6465 7322 5d20 6966 206e 6f64 652e  nodes"] if node.
+0001a0b0: 6765 7428 2270 6172 616d 7322 2c20 7b7d  get("params", {}
+0001a0c0: 292e 6765 7428 2274 7970 6522 2c20 4e6f  ).get("type", No
+0001a0d0: 6e65 2920 3d3d 2022 7369 6e6b 2229 2c20  ne) == "sink"), 
+0001a0e0: 4e6f 6e65 290a 0a20 2020 2069 6620 7069  None)..    if pi
+0001a0f0: 7065 5f65 7869 7374 733a 0a20 2020 2020  pe_exists:.     
+0001a100: 2020 2069 6620 666f 7263 6520 6f72 2072     if force or r
+0001a110: 756e 5f74 6573 7473 3a0a 2020 2020 2020  un_tests:.      
+0001a120: 2020 2020 2020 2320 544f 444f 3a20 7468        # TODO: th
+0001a130: 6973 2073 686f 756c 6420 6372 6561 7465  is should create
+0001a140: 2061 2064 6966 6665 7265 6e74 206e 6f64   a different nod
+0001a150: 6520 616e 6420 7265 6e61 6d65 2069 7420  e and rename it 
+0001a160: 746f 2074 6865 2066 696e 616c 206f 6e65  to the final one
+0001a170: 206f 6e20 7375 6363 6573 730a 2020 2020   on success.    
+0001a180: 2020 2020 2020 2020 6966 2063 6865 636b          if check
+0001a190: 2061 6e64 206e 6f74 2070 6f70 756c 6174   and not populat
+0001a1a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001a1b0: 2020 2069 6620 6e6f 7420 6973 5f6d 6174     if not is_mat
+0001a1c0: 6572 6961 6c69 7a65 6420 616e 6420 6e6f  erialized and no
+0001a1d0: 7420 636f 7079 5f6e 6f64 6520 616e 6420  t copy_node and 
+0001a1e0: 6e6f 7420 7369 6e6b 5f6e 6f64 653a 0a20  not sink_node:. 
+0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a200: 2020 2061 7761 6974 2063 6865 636b 5f70     await check_p
+0001a210: 6970 6528 0a20 2020 2020 2020 2020 2020  ipe(.           
+0001a220: 2020 2020 2020 2020 2020 2020 2070 2c0a               p,.
+0001a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a240: 2020 2020 2020 2020 686f 7374 2c0a 2020          host,.  
+0001a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a260: 2020 2020 2020 746f 6b65 6e2c 0a20 2020        token,.   
+0001a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a280: 2020 2020 2070 6f70 756c 6174 652c 0a20       populate,. 
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2020 2020 2074 625f 636c 6965 6e74         tb_client
+0001a2b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a2c0: 2020 2020 2020 2020 2020 6f6e 6c79 5f72            only_r
+0001a2d0: 6573 706f 6e73 655f 7469 6d65 733d 6f6e  esponse_times=on
+0001a2e0: 6c79 5f72 6573 706f 6e73 655f 7469 6d65  ly_response_time
+0001a2f0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0001a300: 2020 2020 2020 2020 2020 206c 696d 6974             limit
+0001a310: 3d74 6573 7473 5f74 6f5f 7275 6e2c 0a20  =tests_to_run,. 
+0001a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a330: 2020 2020 2020 2073 616d 706c 655f 6279         sample_by
+0001a340: 5f70 6172 616d 733d 7465 7374 735f 746f  _params=tests_to
+0001a350: 5f73 616d 706c 655f 6279 5f70 6172 616d  _sample_by_param
+0001a360: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0001a370: 2020 2020 2020 2020 2020 206d 6174 6368             match
+0001a380: 6573 3d74 6573 7473 5f66 696c 7465 725f  es=tests_filter_
+0001a390: 6279 2c0a 2020 2020 2020 2020 2020 2020  by,.            
+0001a3a0: 2020 2020 2020 2020 2020 2020 6661 696c              fail
+0001a3b0: 6661 7374 3d74 6573 7473 5f66 6169 6c66  fast=tests_failf
+0001a3c0: 6173 742c 0a20 2020 2020 2020 2020 2020  ast,.           
+0001a3d0: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0001a3e0: 6964 6174 655f 7072 6f63 6573 7365 645f  idate_processed_
+0001a3f0: 6279 7465 733d 7465 7374 735f 7661 6c69  bytes=tests_vali
+0001a400: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
+0001a410: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
+0001a420: 2020 2020 2020 2020 2020 2020 2020 6967                ig
+0001a430: 6e6f 7265 5f6f 7264 6572 3d74 6573 7473  nore_order=tests
+0001a440: 5f69 676e 6f72 655f 6f72 6465 722c 0a20  _ignore_order,. 
+0001a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a460: 2020 2020 2020 2074 6f6b 656e 5f66 6f72         token_for
+0001a470: 5f72 6571 7565 7374 735f 746f 5f63 6865  _requests_to_che
+0001a480: 636b 3d28 0a20 2020 2020 2020 2020 2020  ck=(.           
+0001a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4a0: 2061 7761 6974 2067 6574 5f74 6f6b 656e   await get_token
+0001a4b0: 5f66 726f 6d5f 6d61 696e 5f62 7261 6e63  _from_main_branc
+0001a4c0: 6828 7462 5f63 6c69 656e 7429 0a20 2020  h(tb_client).   
+0001a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001a4f0: 7465 7374 735f 6368 6563 6b5f 7265 7175  tests_check_requ
+0001a500: 6573 7473 5f66 726f 6d5f 6272 616e 6368  ests_from_branch
+0001a510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a520: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0001a530: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+0001a540: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001a550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a560: 2020 2020 2020 2020 2020 6375 7272 656e            curren
+0001a570: 745f 7069 7065 3d63 7572 7265 6e74 5f70  t_pipe=current_p
+0001a580: 6970 652c 0a20 2020 2020 2020 2020 2020  ipe,.           
+0001a590: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001a5a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001a5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a5c0: 2020 2020 2069 6620 6973 5f6d 6174 6572       if is_mater
+0001a5d0: 6961 6c69 7a65 643a 0a20 2020 2020 2020  ialized:.       
+0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5f0: 2061 7761 6974 2063 6865 636b 5f6d 6174   await check_mat
+0001a600: 6572 6961 6c69 7a65 6428 0a20 2020 2020  erialized(.     
+0001a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a620: 2020 2020 2020 2070 2c0a 2020 2020 2020         p,.      
+0001a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a640: 2020 2020 2020 686f 7374 2c0a 2020 2020        host,.    
+0001a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a660: 2020 2020 2020 2020 746f 6b65 6e2c 0a20          token,. 
+0001a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a680: 2020 2020 2020 2020 2020 2074 625f 636c             tb_cl
+0001a690: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
+0001a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6b0: 2020 6f76 6572 7269 6465 5f64 6174 6173    override_datas
+0001a6c0: 6f75 7263 653d 6f76 6572 7269 6465 5f64  ource=override_d
+0001a6d0: 6174 6173 6f75 7263 652c 0a20 2020 2020  atasource,.     
+0001a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6f0: 2020 2020 2020 2063 7572 7265 6e74 5f70         current_p
+0001a700: 6970 653d 6375 7272 656e 745f 7069 7065  ipe=current_pipe
+0001a710: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a720: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a740: 6966 2063 6f70 795f 6e6f 6465 3a0a 2020  if copy_node:.  
+0001a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a760: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
+0001a770: 6b5f 636f 7079 5f70 6970 6528 7069 7065  k_copy_pipe(pipe
+0001a780: 3d63 7572 7265 6e74 5f70 6970 652c 2063  =current_pipe, c
+0001a790: 6f70 795f 6e6f 6465 3d63 6f70 795f 6e6f  opy_node=copy_no
+0001a7a0: 6465 2c20 7462 5f63 6c69 656e 743d 7462  de, tb_client=tb
+0001a7b0: 5f63 6c69 656e 7429 0a20 2020 2020 2020  _client).       
+0001a7c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001a7d0: 7369 6e6b 5f6e 6f64 653a 0a20 2020 2020  sink_node:.     
+0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7f0: 2020 2061 7761 6974 2063 6865 636b 5f73     await check_s
+0001a800: 696e 6b5f 7069 7065 2870 6970 653d 6375  ink_pipe(pipe=cu
+0001a810: 7272 656e 745f 7069 7065 2c20 7369 6e6b  rrent_pipe, sink
+0001a820: 5f6e 6f64 653d 7369 6e6b 5f6e 6f64 652c  _node=sink_node,
+0001a830: 2074 625f 636c 6965 6e74 3d74 625f 636c   tb_client=tb_cl
+0001a840: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
+0001a850: 2020 6966 2072 756e 5f74 6573 7473 3a0a    if run_tests:.
+0001a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a870: 6c6f 6767 696e 672e 696e 666f 2866 2273  logging.info(f"s
+0001a880: 6b69 7070 696e 6720 666f 7263 6520 6f76  kipping force ov
+0001a890: 6572 7269 6465 206f 6620 7b70 5b27 6e61  erride of {p['na
+0001a8a0: 6d65 275d 7d22 290a 2020 2020 2020 2020  me']}").        
+0001a8b0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0001a8c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001a8d0: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+0001a8e0: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0001a8f0: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+0001a900: 6765 722e 6572 726f 725f 7069 7065 5f61  ger.error_pipe_a
+0001a910: 6c72 6561 6479 5f65 7869 7374 7328 7069  lready_exists(pi
+0001a920: 7065 3d70 5b22 6e61 6d65 225d 2929 0a20  pe=p["name"])). 
+0001a930: 2020 2065 6c69 6620 6e6f 7420 7069 7065     elif not pipe
+0001a940: 5f65 7869 7374 7320 616e 6420 6368 6563  _exists and chec
+0001a950: 6b3a 0a20 2020 2020 2020 2069 6620 6973  k:.        if is
+0001a960: 5f6d 6174 6572 6961 6c69 7a65 643a 0a20  _materialized:. 
+0001a970: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001a980: 2063 6865 636b 5f6d 6174 6572 6961 6c69   check_materiali
+0001a990: 7a65 6428 0a20 2020 2020 2020 2020 2020  zed(.           
+0001a9a0: 2020 2020 2070 2c20 686f 7374 2c20 746f       p, host, to
+0001a9b0: 6b65 6e2c 2074 625f 636c 6965 6e74 2c20  ken, tb_client, 
+0001a9c0: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
+0001a9d0: 7263 653d 6f76 6572 7269 6465 5f64 6174  rce=override_dat
+0001a9e0: 6173 6f75 7263 652c 2063 7572 7265 6e74  asource, current
+0001a9f0: 5f70 6970 653d 6375 7272 656e 745f 7069  _pipe=current_pi
+0001aa00: 7065 0a20 2020 2020 2020 2020 2020 2029  pe.            )
+0001aa10: 0a20 2020 2020 2020 2069 6620 636f 7079  .        if copy
+0001aa20: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
+0001aa30: 2020 2061 7761 6974 2063 6865 636b 5f63     await check_c
+0001aa40: 6f70 795f 7069 7065 2870 6970 653d 6375  opy_pipe(pipe=cu
+0001aa50: 7272 656e 745f 7069 7065 2c20 636f 7079  rrent_pipe, copy
+0001aa60: 5f6e 6f64 653d 636f 7079 5f6e 6f64 652c  _node=copy_node,
+0001aa70: 2074 625f 636c 6965 6e74 3d74 625f 636c   tb_client=tb_cl
+0001aa80: 6965 6e74 290a 0a20 2020 2070 6172 616d  ient)..    param
+0001aa90: 7320 3d20 7b7d 0a20 2020 2070 6172 616d  s = {}.    param
+0001aaa0: 732e 7570 6461 7465 2863 6c69 5f70 6172  s.update(cli_par
+0001aab0: 616d 7329 0a20 2020 2069 6620 666f 7263  ams).    if forc
+0001aac0: 653a 0a20 2020 2020 2020 2070 6172 616d  e:.        param
+0001aad0: 735b 2266 6f72 6365 225d 203d 2022 7472  s["force"] = "tr
+0001aae0: 7565 220a 2020 2020 6966 2070 6f70 756c  ue".    if popul
+0001aaf0: 6174 653a 0a20 2020 2020 2020 2070 6172  ate:.        par
+0001ab00: 616d 735b 2270 6f70 756c 6174 6522 5d20  ams["populate"] 
+0001ab10: 3d20 2274 7275 6522 0a20 2020 2069 6620  = "true".    if 
+0001ab20: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
+0001ab30: 6f6e 3a0a 2020 2020 2020 2020 7061 7261  on:.        para
+0001ab40: 6d73 5b22 706f 7075 6c61 7465 5f63 6f6e  ms["populate_con
+0001ab50: 6469 7469 6f6e 225d 203d 2070 6f70 756c  dition"] = popul
+0001ab60: 6174 655f 636f 6e64 6974 696f 6e0a 2020  ate_condition.  
+0001ab70: 2020 6966 2070 6f70 756c 6174 655f 7375    if populate_su
+0001ab80: 6273 6574 3a0a 2020 2020 2020 2020 7061  bset:.        pa
+0001ab90: 7261 6d73 5b22 706f 7075 6c61 7465 5f73  rams["populate_s
+0001aba0: 7562 7365 7422 5d20 3d20 706f 7075 6c61  ubset"] = popula
+0001abb0: 7465 5f73 7562 7365 740a 2020 2020 7061  te_subset.    pa
+0001abc0: 7261 6d73 5b22 756e 6c69 6e6b 5f6f 6e5f  rams["unlink_on_
+0001abd0: 706f 7075 6c61 7465 5f65 7272 6f72 225d  populate_error"]
+0001abe0: 203d 2022 7472 7565 2220 6966 2075 6e6c   = "true" if unl
+0001abf0: 696e 6b5f 6f6e 5f70 6f70 756c 6174 655f  ink_on_populate_
+0001ac00: 6572 726f 7220 656c 7365 2022 6661 6c73  error else "fals
+0001ac10: 6522 0a20 2020 2070 6172 616d 735b 2262  e".    params["b
+0001ac20: 7261 6e63 685f 6d6f 6465 225d 203d 2022  ranch_mode"] = "
+0001ac30: 666f 726b 2220 6966 2066 6f72 6b5f 646f  fork" if fork_do
+0001ac40: 776e 7374 7265 616d 206f 7220 666f 726b  wnstream or fork
+0001ac50: 2065 6c73 6520 224e 6f6e 6522 0a0a 2020   else "None"..  
+0001ac60: 2020 626f 6479 203d 207b 226e 616d 6522    body = {"name"
+0001ac70: 3a20 705b 226e 616d 6522 5d2c 2022 6465  : p["name"], "de
+0001ac80: 7363 7269 7074 696f 6e22 3a20 702e 6765  scription": p.ge
+0001ac90: 7428 2264 6573 6372 6970 7469 6f6e 222c  t("description",
+0001aca0: 2022 2229 7d0a 0a20 2020 2064 6566 2070   "")}..    def p
+0001acb0: 6172 7365 5f6e 6f64 6528 6e6f 6465 293a  arse_node(node):
+0001acc0: 0a20 2020 2020 2020 2069 6620 2270 6172  .        if "par
+0001acd0: 616d 7322 2069 6e20 6e6f 6465 3a0a 2020  ams" in node:.  
+0001ace0: 2020 2020 2020 2020 2020 6e6f 6465 2e75            node.u
+0001acf0: 7064 6174 6528 6e6f 6465 5b22 7061 7261  pdate(node["para
+0001ad00: 6d73 225d 290a 2020 2020 2020 2020 2020  ms"]).          
+0001ad10: 2020 6966 206e 6f64 652e 6765 7428 2274    if node.get("t
+0001ad20: 7970 6522 2c20 2222 2920 3d3d 2022 6d61  ype", "") == "ma
+0001ad30: 7465 7269 616c 697a 6564 2220 616e 6420  terialized" and 
+0001ad40: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
+0001ad50: 7263 653a 0a20 2020 2020 2020 2020 2020  rce:.           
+0001ad60: 2020 2020 206e 6f64 655b 226f 7665 7272       node["overr
+0001ad70: 6964 655f 6461 7461 736f 7572 6365 225d  ide_datasource"]
+0001ad80: 203d 2022 7472 7565 220a 2020 2020 2020   = "true".      
+0001ad90: 2020 2020 2020 6465 6c20 6e6f 6465 5b22        del node["
+0001ada0: 7061 7261 6d73 225d 0a20 2020 2020 2020  params"].       
+0001adb0: 2072 6574 7572 6e20 6e6f 6465 0a0a 2020   return node..  
+0001adc0: 2020 6966 2070 5b22 6e6f 6465 7322 5d3a    if p["nodes"]:
+0001add0: 0a20 2020 2020 2020 2062 6f64 795b 226e  .        body["n
+0001ade0: 6f64 6573 225d 203d 205b 7061 7273 655f  odes"] = [parse_
+0001adf0: 6e6f 6465 286e 2920 666f 7220 6e20 696e  node(n) for n in
+0001ae00: 2070 5b22 6e6f 6465 7322 5d5d 0a0a 2020   p["nodes"]]..  
+0001ae10: 2020 6966 2063 6f70 795f 6e6f 6465 3a0a    if copy_node:.
+0001ae20: 2020 2020 2020 2020 626f 6479 5b22 7461          body["ta
+0001ae30: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
+0001ae40: 5d20 3d20 636f 7079 5f6e 6f64 652e 6765  ] = copy_node.ge
+0001ae50: 7428 2274 6172 6765 745f 6461 7461 736f  t("target_dataso
+0001ae60: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
+0001ae70: 2020 2020 2023 2057 6520 7769 6c6c 2075       # We will u
+0001ae80: 7064 6174 6520 7468 6520 7363 6865 6475  pdate the schedu
+0001ae90: 6c65 2063 726f 6e20 6c61 7465 720a 2020  le cron later.  
+0001aea0: 2020 2020 2020 626f 6479 5b22 7363 6865        body["sche
+0001aeb0: 6475 6c65 5f63 726f 6e22 5d20 3d20 4e6f  dule_cron"] = No
+0001aec0: 6e65 0a0a 2020 2020 6966 2073 696e 6b5f  ne..    if sink_
+0001aed0: 6e6f 6465 3a0a 2020 2020 2020 2020 626f  node:.        bo
+0001aee0: 6479 2e75 7064 6174 6528 7369 6e6b 5f6e  dy.update(sink_n
+0001aef0: 6f64 652e 6765 7428 2265 7870 6f72 745f  ode.get("export_
+0001af00: 7061 7261 6d73 222c 207b 7d29 290a 0a20  params", {})).. 
+0001af10: 2020 2070 6f73 745f 6865 6164 6572 7320     post_headers 
+0001af20: 3d20 7b22 436f 6e74 656e 742d 5479 7065  = {"Content-Type
+0001af30: 223a 2022 6170 706c 6963 6174 696f 6e2f  ": "application/
+0001af40: 6a73 6f6e 227d 0a0a 2020 2020 706f 7374  json"}..    post
+0001af50: 5f68 6561 6465 7273 2e75 7064 6174 6528  _headers.update(
+0001af60: 6865 6164 6572 7329 0a0a 2020 2020 7472  headers)..    tr
+0001af70: 793a 0a20 2020 2020 2020 2064 6174 6120  y:.        data 
+0001af80: 3d20 6177 6169 7420 7462 5f63 6c69 656e  = await tb_clien
+0001af90: 742e 5f72 6571 280a 2020 2020 2020 2020  t._req(.        
+0001afa0: 2020 2020 6622 2f76 302f 7069 7065 733f      f"/v0/pipes?
+0001afb0: 7b75 726c 656e 636f 6465 2870 6172 616d  {urlencode(param
+0001afc0: 7329 7d22 2c20 6d65 7468 6f64 3d22 504f  s)}", method="PO
+0001afd0: 5354 222c 2068 6561 6465 7273 3d70 6f73  ST", headers=pos
+0001afe0: 745f 6865 6164 6572 732c 2064 6174 613d  t_headers, data=
+0001aff0: 6a73 6f6e 2e64 756d 7073 2862 6f64 7929  json.dumps(body)
+0001b000: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
+0001b010: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+0001b020: 6173 2065 3a0a 2020 2020 2020 2020 7261  as e:.        ra
+0001b030: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0001b040: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0001b050: 6b4d 616e 6167 6572 2e65 7272 6f72 5f70  kManager.error_p
+0001b060: 7573 6869 6e67 5f70 6970 6528 7069 7065  ushing_pipe(pipe
+0001b070: 3d70 5b22 6e61 6d65 225d 2c20 6572 726f  =p["name"], erro
+0001b080: 723d 7374 7228 6529 2929 0a0a 2020 2020  r=str(e)))..    
+0001b090: 6461 7461 736f 7572 6365 203d 2064 6174  datasource = dat
+0001b0a0: 612e 6765 7428 2264 6174 6173 6f75 7263  a.get("datasourc
+0001b0b0: 6522 2c20 4e6f 6e65 290a 2020 2020 6372  e", None).    cr
+0001b0c0: 6561 7465 645f 6461 7461 736f 7572 6365  eated_datasource
+0001b0d0: 203d 2064 6174 612e 6765 7428 2263 7265   = data.get("cre
+0001b0e0: 6174 6564 5f64 6174 6173 6f75 7263 6522  ated_datasource"
+0001b0f0: 2c20 4e6f 6e65 290a 0a20 2020 2069 6620  , None)..    if 
+0001b100: 6461 7461 736f 7572 6365 2061 6e64 2063  datasource and c
+0001b110: 7265 6174 6564 5f64 6174 6173 6f75 7263  reated_datasourc
+0001b120: 653a 0a20 2020 2020 2020 2069 6620 636f  e:.        if co
+0001b130: 7079 5f6e 6f64 653a 0a20 2020 2020 2020  py_node:.       
+0001b140: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001b150: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001b160: 696e 666f 5f63 6f70 795f 6461 7461 736f  info_copy_dataso
+0001b170: 7572 6365 5f63 7265 6174 6564 2870 6970  urce_created(pip
+0001b180: 653d 705b 226e 616d 6522 5d2c 2064 6174  e=p["name"], dat
+0001b190: 6173 6f75 7263 653d 6461 7461 736f 7572  asource=datasour
+0001b1a0: 6365 5b22 6e61 6d65 225d 2929 0a20 2020  ce["name"])).   
+0001b1b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001b1c0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+0001b1d0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0001b1e0: 2020 2046 6565 6462 6163 6b4d 616e 6167     FeedbackManag
+0001b1f0: 6572 2e69 6e66 6f5f 6d61 7465 7269 616c  er.info_material
+0001b200: 697a 6564 5f64 6174 6173 6f75 7263 655f  ized_datasource_
+0001b210: 6372 6561 7465 6428 7069 7065 3d70 5b22  created(pipe=p["
+0001b220: 6e61 6d65 225d 2c20 6461 7461 736f 7572  name"], datasour
+0001b230: 6365 3d64 6174 6173 6f75 7263 655b 226e  ce=datasource["n
+0001b240: 616d 6522 5d29 0a20 2020 2020 2020 2020  ame"]).         
+0001b250: 2020 2029 0a20 2020 2065 6c69 6620 6461     ).    elif da
+0001b260: 7461 736f 7572 6365 2061 6e64 206e 6f74  tasource and not
+0001b270: 2063 7265 6174 6564 5f64 6174 6173 6f75   created_datasou
+0001b280: 7263 653a 0a20 2020 2020 2020 2069 6620  rce:.        if 
+0001b290: 636f 7079 5f6e 6f64 653a 0a20 2020 2020  copy_node:.     
+0001b2a0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+0001b2b0: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
+0001b2c0: 722e 696e 666f 5f63 6f70 795f 6461 7461  r.info_copy_data
+0001b2d0: 736f 7572 6365 5f75 7365 6428 7069 7065  source_used(pipe
+0001b2e0: 3d70 5b22 6e61 6d65 225d 2c20 6461 7461  =p["name"], data
+0001b2f0: 736f 7572 6365 3d64 6174 6173 6f75 7263  source=datasourc
+0001b300: 655b 226e 616d 6522 5d29 290a 2020 2020  e["name"])).    
+0001b310: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b320: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+0001b330: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+0001b340: 2e69 6e66 6f5f 6d61 7465 7269 616c 697a  .info_materializ
+0001b350: 6564 5f64 6174 6173 6f75 7263 655f 7573  ed_datasource_us
+0001b360: 6564 2870 6970 653d 705b 226e 616d 6522  ed(pipe=p["name"
+0001b370: 5d2c 2064 6174 6173 6f75 7263 653d 6461  ], datasource=da
+0001b380: 7461 736f 7572 6365 5b22 6e61 6d65 225d  tasource["name"]
+0001b390: 2929 0a0a 2020 2020 6966 2064 6174 6173  ))..    if datas
+0001b3a0: 6f75 7263 6520 616e 6420 706f 7075 6c61  ource and popula
+0001b3b0: 7465 2061 6e64 206e 6f74 2063 6f70 795f  te and not copy_
+0001b3c0: 6e6f 6465 3a0a 2020 2020 2020 2020 6a6f  node:.        jo
+0001b3d0: 625f 7572 6c20 3d20 6461 7461 2e67 6574  b_url = data.get
+0001b3e0: 2822 6a6f 6222 2c20 7b7d 292e 6765 7428  ("job", {}).get(
+0001b3f0: 226a 6f62 5f75 726c 222c 204e 6f6e 6529  "job_url", None)
+0001b400: 0a20 2020 2020 2020 206a 6f62 5f69 6420  .        job_id 
+0001b410: 3d20 6461 7461 2e67 6574 2822 6a6f 6222  = data.get("job"
+0001b420: 2c20 7b7d 292e 6765 7428 226a 6f62 5f69  , {}).get("job_i
+0001b430: 6422 2c20 4e6f 6e65 290a 2020 2020 2020  d", None).      
+0001b440: 2020 6966 2070 6f70 756c 6174 655f 7375    if populate_su
+0001b450: 6273 6574 3a0a 2020 2020 2020 2020 2020  bset:.          
+0001b460: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
+0001b470: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+0001b480: 6f5f 706f 7075 6c61 7465 5f73 7562 7365  o_populate_subse
+0001b490: 745f 6a6f 625f 7572 6c28 7572 6c3d 6a6f  t_job_url(url=jo
+0001b4a0: 625f 7572 6c2c 2073 7562 7365 743d 706f  b_url, subset=po
+0001b4b0: 7075 6c61 7465 5f73 7562 7365 7429 290a  pulate_subset)).
+0001b4c0: 2020 2020 2020 2020 656c 6966 2070 6f70          elif pop
+0001b4d0: 756c 6174 655f 636f 6e64 6974 696f 6e3a  ulate_condition:
+0001b4e0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001b4f0: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
+0001b500: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
+0001b510: 6b4d 616e 6167 6572 2e69 6e66 6f5f 706f  kManager.info_po
+0001b520: 7075 6c61 7465 5f63 6f6e 6469 7469 6f6e  pulate_condition
+0001b530: 5f6a 6f62 5f75 726c 2875 726c 3d6a 6f62  _job_url(url=job
+0001b540: 5f75 726c 2c20 706f 7075 6c61 7465 5f63  _url, populate_c
+0001b550: 6f6e 6469 7469 6f6e 3d70 6f70 756c 6174  ondition=populat
+0001b560: 655f 636f 6e64 6974 696f 6e29 0a20 2020  e_condition).   
+0001b570: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001b580: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001b590: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001b5a0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001b5b0: 696e 666f 5f70 6f70 756c 6174 655f 6a6f  info_populate_jo
+0001b5c0: 625f 7572 6c28 7572 6c3d 6a6f 625f 7572  b_url(url=job_ur
+0001b5d0: 6c29 290a 0a20 2020 2020 2020 2069 6620  l))..        if 
+0001b5e0: 7761 6974 5f70 6f70 756c 6174 653a 0a20  wait_populate:. 
+0001b5f0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0001b600: 7420 3d20 6177 6169 7420 7761 6974 5f6a  t = await wait_j
+0001b610: 6f62 2874 625f 636c 6965 6e74 2c20 6a6f  ob(tb_client, jo
+0001b620: 625f 6964 2c20 6a6f 625f 7572 6c2c 2022  b_id, job_url, "
+0001b630: 506f 7075 6c61 7469 6e67 2229 0a20 2020  Populating").   
+0001b640: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+0001b650: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
+0001b660: 6765 722e 696e 666f 5f70 6f70 756c 6174  ger.info_populat
+0001b670: 655f 6a6f 625f 7265 7375 6c74 2872 6573  e_job_result(res
+0001b680: 756c 743d 7265 7375 6c74 2929 0a20 2020  ult=result)).   
+0001b690: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
+0001b6a0: 6620 6461 7461 2e67 6574 2822 7479 7065  f data.get("type
+0001b6b0: 2229 203d 3d20 2264 6566 6175 6c74 2220  ") == "default" 
+0001b6c0: 616e 6420 6e6f 7420 736b 6970 5f74 6f6b  and not skip_tok
+0001b6d0: 656e 7320 616e 6420 6e6f 7420 6173 5f73  ens and not as_s
+0001b6e0: 7461 6e64 6172 6420 616e 6420 6e6f 7420  tandard and not 
+0001b6f0: 636f 7079 5f6e 6f64 6520 616e 6420 6e6f  copy_node and no
+0001b700: 7420 7369 6e6b 5f6e 6f64 653a 0a20 2020  t sink_node:.   
+0001b710: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+0001b720: 3a20 7365 7420 6f70 7469 6f6e 2074 6f20  : set option to 
+0001b730: 6164 6420 6c61 7374 206e 6f64 6520 6173  add last node as
+0001b740: 2065 6e64 706f 696e 7420 696e 2074 6865   endpoint in the
+0001b750: 2041 5049 0a20 2020 2020 2020 2020 2020   API.           
+0001b760: 2065 6e64 706f 696e 745f 6e6f 6465 203d   endpoint_node =
+0001b770: 206e 6578 7428 0a20 2020 2020 2020 2020   next(.         
+0001b780: 2020 2020 2020 2028 6e6f 6465 2066 6f72         (node for
+0001b790: 206e 6f64 6520 696e 2064 6174 612e 6765   node in data.ge
+0001b7a0: 7428 226e 6f64 6573 222c 205b 5d29 2069  t("nodes", []) i
+0001b7b0: 6620 6e6f 6465 2e67 6574 2822 7479 7065  f node.get("type
+0001b7c0: 2229 203d 3d20 2265 6e64 706f 696e 7422  ") == "endpoint"
+0001b7d0: 292c 2064 6174 612e 6765 7428 226e 6f64  ), data.get("nod
+0001b7e0: 6573 222c 205b 5d29 5b2d 315d 0a20 2020  es", [])[-1].   
+0001b7f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001b800: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001b810: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0001b820: 203d 2061 7761 6974 2074 625f 636c 6965   = await tb_clie
+0001b830: 6e74 2e5f 7265 7128 0a20 2020 2020 2020  nt._req(.       
+0001b840: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+0001b850: 7630 2f70 6970 6573 2f7b 705b 276e 616d  v0/pipes/{p['nam
+0001b860: 6527 5d7d 2f6e 6f64 6573 2f7b 656e 6470  e']}/nodes/{endp
+0001b870: 6f69 6e74 5f6e 6f64 652e 6765 7428 2769  oint_node.get('i
+0001b880: 6427 297d 2f65 6e64 706f 696e 743f 7b75  d')}/endpoint?{u
+0001b890: 726c 656e 636f 6465 2863 6c69 5f70 6172  rlencode(cli_par
+0001b8a0: 616d 7329 7d22 2c0a 2020 2020 2020 2020  ams)}",.        
+0001b8b0: 2020 2020 2020 2020 2020 2020 6d65 7468              meth
+0001b8c0: 6f64 3d22 504f 5354 222c 0a20 2020 2020  od="POST",.     
+0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0001b8e0: 6561 6465 7273 3d68 6561 6465 7273 2c0a  eaders=headers,.
+0001b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b900: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0001b910: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0001b920: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001b930: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+0001b940: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0001b950: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001b960: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0001b970: 6372 6561 7469 6e67 5f65 6e64 706f 696e  creating_endpoin
+0001b980: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0001b990: 2020 2020 2020 2020 2020 206e 6f64 653d             node=
+0001b9a0: 656e 6470 6f69 6e74 5f6e 6f64 652e 6765  endpoint_node.ge
+0001b9b0: 7428 226e 616d 6522 292c 2070 6970 653d  t("name"), pipe=
+0001b9c0: 705b 226e 616d 6522 5d2c 2065 7272 6f72  p["name"], error
+0001b9d0: 3d73 7472 2865 290a 2020 2020 2020 2020  =str(e).        
+0001b9e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001b9f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001ba00: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001ba10: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
+0001ba20: 4d61 6e61 6765 722e 7375 6363 6573 735f  Manager.success_
+0001ba30: 7465 7374 5f65 6e64 706f 696e 745f 6e6f  test_endpoint_no
+0001ba40: 5f74 6f6b 656e 2868 6f73 743d 686f 7374  _token(host=host
+0001ba50: 2c20 7069 7065 3d70 5b22 6e61 6d65 225d  , pipe=p["name"]
+0001ba60: 2929 0a0a 2020 2020 6966 2063 6f70 795f  ))..    if copy_
+0001ba70: 6e6f 6465 3a0a 2020 2020 2020 2020 7069  node:.        pi
+0001ba80: 7065 5f69 6420 3d20 6461 7461 5b22 6964  pe_id = data["id
+0001ba90: 225d 0a20 2020 2020 2020 206e 6f64 6520  "].        node 
+0001baa0: 3d20 6e65 7874 2828 6e6f 6465 2066 6f72  = next((node for
+0001bab0: 206e 6f64 6520 696e 2064 6174 615b 226e   node in data["n
+0001bac0: 6f64 6573 225d 2069 6620 6e6f 6465 5b22  odes"] if node["
+0001bad0: 6e6f 6465 5f74 7970 6522 5d20 3d3d 2022  node_type"] == "
+0001bae0: 636f 7079 2229 2c20 4e6f 6e65 290a 2020  copy"), None).  
+0001baf0: 2020 2020 2020 6966 206e 6f64 653a 0a20        if node:. 
+0001bb00: 2020 2020 2020 2020 2020 2063 6f70 795f             copy_
+0001bb10: 7061 7261 6d73 203d 207b 2270 6970 655f  params = {"pipe_
+0001bb20: 6e61 6d65 5f6f 725f 6964 223a 2070 6970  name_or_id": pip
+0001bb30: 655f 6964 2c20 226e 6f64 655f 6964 223a  e_id, "node_id":
+0001bb40: 206e 6f64 655b 2269 6422 5d7d 0a20 2020   node["id"]}.   
+0001bb50: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0001bb60: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0001bb70: 7267 6574 5f64 6174 6173 6f75 7263 6520  rget_datasource 
+0001bb80: 3d20 636f 7079 5f6e 6f64 652e 6765 7428  = copy_node.get(
+0001bb90: 436f 7079 5061 7261 6d65 7465 7273 2e54  CopyParameters.T
+0001bba0: 4152 4745 545f 4441 5441 534f 5552 4345  ARGET_DATASOURCE
+0001bbb0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+0001bbc0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+0001bbd0: 5f63 726f 6e20 3d20 636f 7079 5f6e 6f64  _cron = copy_nod
+0001bbe0: 652e 6765 7428 436f 7079 5061 7261 6d65  e.get(CopyParame
+0001bbf0: 7465 7273 2e43 4f50 595f 5343 4845 4455  ters.COPY_SCHEDU
+0001bc00: 4c45 2c20 4e6f 6e65 290a 2020 2020 2020  LE, None).      
+0001bc10: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+0001bc20: 6c65 5f63 726f 6e20 3d20 4e6f 6e65 2069  le_cron = None i
+0001bc30: 6620 7363 6865 6475 6c65 5f63 726f 6e20  f schedule_cron 
+0001bc40: 3d3d 204f 4e5f 4445 4d41 4e44 2065 6c73  == ON_DEMAND els
+0001bc50: 6520 7363 6865 6475 6c65 5f63 726f 6e0a  e schedule_cron.
+0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc70: 6375 7272 656e 745f 7461 7267 6574 5f64  current_target_d
+0001bc80: 6174 6173 6f75 7263 655f 6964 203d 2064  atasource_id = d
+0001bc90: 6174 615b 2263 6f70 795f 7461 7267 6574  ata["copy_target
+0001bca0: 5f64 6174 6173 6f75 7263 6522 5d0a 2020  _datasource"].  
+0001bcb0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0001bcc0: 7267 6574 5f64 6174 6173 6f75 7263 655f  rget_datasource_
+0001bcd0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+0001bce0: 2074 625f 636c 6965 6e74 2e67 6574 5f64   tb_client.get_d
+0001bcf0: 6174 6173 6f75 7263 6528 7461 7267 6574  atasource(target
+0001bd00: 5f64 6174 6173 6f75 7263 6529 0a20 2020  _datasource).   
+0001bd10: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+0001bd20: 6765 745f 6461 7461 736f 7572 6365 5f74  get_datasource_t
+0001bd30: 6f5f 7365 6e64 203d 2028 0a20 2020 2020  o_send = (.     
+0001bd40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001bd50: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
+0001bd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bd70: 2020 2020 2069 6620 7461 7267 6574 5f64       if target_d
+0001bd80: 6174 6173 6f75 7263 655f 7265 7370 6f6e  atasource_respon
+0001bd90: 7365 2e67 6574 2822 6964 222c 2074 6172  se.get("id", tar
+0001bda0: 6765 745f 6461 7461 736f 7572 6365 2920  get_datasource) 
+0001bdb0: 213d 2063 7572 7265 6e74 5f74 6172 6765  != current_targe
+0001bdc0: 745f 6461 7461 736f 7572 6365 5f69 640a  t_datasource_id.
+0001bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bde0: 2020 2020 656c 7365 204e 6f6e 650a 2020      else None.  
+0001bdf0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be10: 636f 7079 5f70 6172 616d 735b 436f 7079  copy_params[Copy
+0001be20: 5061 7261 6d65 7465 7273 2e54 4152 4745  Parameters.TARGE
+0001be30: 545f 4441 5441 534f 5552 4345 5d20 3d20  T_DATASOURCE] = 
+0001be40: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
+0001be50: 655f 746f 5f73 656e 640a 2020 2020 2020  e_to_send.      
+0001be60: 2020 2020 2020 2020 2020 6375 7272 656e            curren
+0001be70: 745f 7363 6865 6475 6c65 203d 2064 6174  t_schedule = dat
+0001be80: 612e 6765 7428 2273 6368 6564 756c 6522  a.get("schedule"
+0001be90: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
+0001bea0: 2020 2020 2020 6375 7272 656e 745f 7363        current_sc
+0001beb0: 6865 6475 6c65 5f63 726f 6e20 3d20 6375  hedule_cron = cu
+0001bec0: 7272 656e 745f 7363 6865 6475 6c65 2e67  rrent_schedule.g
+0001bed0: 6574 2822 6372 6f6e 222c 204e 6f6e 6529  et("cron", None)
+0001bee0: 2069 6620 6375 7272 656e 745f 7363 6865   if current_sche
+0001bef0: 6475 6c65 2065 6c73 6520 4e6f 6e65 0a20  dule else None. 
+0001bf00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001bf10: 6368 6564 756c 655f 6372 6f6e 5f73 686f  chedule_cron_sho
+0001bf20: 756c 645f 6265 5f72 656d 6f76 6564 203d  uld_be_removed =
+0001bf30: 2063 7572 7265 6e74 5f73 6368 6564 756c   current_schedul
+0001bf40: 655f 6372 6f6e 2061 6e64 206e 6f74 2073  e_cron and not s
+0001bf50: 6368 6564 756c 655f 6372 6f6e 0a20 2020  chedule_cron.   
+0001bf60: 2020 2020 2020 2020 2020 2020 2063 6f70               cop
+0001bf70: 795f 7061 7261 6d73 5b22 7363 6865 6475  y_params["schedu
+0001bf80: 6c65 5f63 726f 6e22 5d20 3d20 224e 6f6e  le_cron"] = "Non
+0001bf90: 6522 2069 6620 7363 6865 6475 6c65 5f63  e" if schedule_c
+0001bfa0: 726f 6e5f 7368 6f75 6c64 5f62 655f 7265  ron_should_be_re
+0001bfb0: 6d6f 7665 6420 656c 7365 2073 6368 6564  moved else sched
+0001bfc0: 756c 655f 6372 6f6e 0a20 2020 2020 2020  ule_cron.       
+0001bfd0: 2020 2020 2020 2020 2061 7761 6974 2074           await t
+0001bfe0: 625f 636c 6965 6e74 2e70 6970 655f 7570  b_client.pipe_up
+0001bff0: 6461 7465 5f63 6f70 7928 2a2a 636f 7079  date_copy(**copy
+0001c000: 5f70 6172 616d 7329 0a20 2020 2020 2020  _params).       
+0001c010: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0001c020: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+0001c030: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c040: 6520 4578 6365 7074 696f 6e28 0a20 2020  e Exception(.   
 0001c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c060: 2020 2020 2020 206e 6f64 653d 656e 6470         node=endp
-0001c070: 6f69 6e74 5f6e 6f64 652e 6765 7428 226e  oint_node.get("n
-0001c080: 616d 6522 292c 2070 6970 653d 705b 226e  ame"), pipe=p["n
-0001c090: 616d 6522 5d2c 2065 7272 6f72 3d73 7472  ame"], error=str
-0001c0a0: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-0001c0b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001c0c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001c0d0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-0001c0e0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001c0f0: 6765 722e 7375 6363 6573 735f 7465 7374  ger.success_test
-0001c100: 5f65 6e64 706f 696e 745f 6e6f 5f74 6f6b  _endpoint_no_tok
-0001c110: 656e 2868 6f73 743d 686f 7374 2c20 7069  en(host=host, pi
-0001c120: 7065 3d70 5b22 6e61 6d65 225d 2929 0a0a  pe=p["name"]))..
-0001c130: 2020 2020 6966 2063 6f70 795f 6e6f 6465      if copy_node
-0001c140: 3a0a 2020 2020 2020 2020 7069 7065 5f69  :.        pipe_i
-0001c150: 6420 3d20 6461 7461 5b22 6964 225d 0a20  d = data["id"]. 
-0001c160: 2020 2020 2020 206e 6f64 6520 3d20 6e65         node = ne
-0001c170: 7874 2828 6e6f 6465 2066 6f72 206e 6f64  xt((node for nod
-0001c180: 6520 696e 2064 6174 615b 226e 6f64 6573  e in data["nodes
-0001c190: 225d 2069 6620 6e6f 6465 5b22 6e6f 6465  "] if node["node
-0001c1a0: 5f74 7970 6522 5d20 3d3d 2022 636f 7079  _type"] == "copy
-0001c1b0: 2229 2c20 4e6f 6e65 290a 2020 2020 2020  "), None).      
-0001c1c0: 2020 6966 206e 6f64 653a 0a20 2020 2020    if node:.     
-0001c1d0: 2020 2020 2020 2063 6f70 795f 7061 7261         copy_para
-0001c1e0: 6d73 203d 207b 2270 6970 655f 6e61 6d65  ms = {"pipe_name
-0001c1f0: 5f6f 725f 6964 223a 2070 6970 655f 6964  _or_id": pipe_id
-0001c200: 2c20 226e 6f64 655f 6964 223a 206e 6f64  , "node_id": nod
-0001c210: 655b 2269 6422 5d7d 0a20 2020 2020 2020  e["id"]}.       
-0001c220: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001c230: 2020 2020 2020 2020 2020 7461 7267 6574            target
-0001c240: 5f64 6174 6173 6f75 7263 6520 3d20 636f  _datasource = co
-0001c250: 7079 5f6e 6f64 652e 6765 7428 436f 7079  py_node.get(Copy
-0001c260: 5061 7261 6d65 7465 7273 2e54 4152 4745  Parameters.TARGE
-0001c270: 545f 4441 5441 534f 5552 4345 2c20 4e6f  T_DATASOURCE, No
-0001c280: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-0001c290: 2020 2020 7363 6865 6475 6c65 5f63 726f      schedule_cro
-0001c2a0: 6e20 3d20 636f 7079 5f6e 6f64 652e 6765  n = copy_node.ge
-0001c2b0: 7428 436f 7079 5061 7261 6d65 7465 7273  t(CopyParameters
-0001c2c0: 2e43 4f50 595f 5343 4845 4455 4c45 2c20  .COPY_SCHEDULE, 
-0001c2d0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
-0001c2e0: 2020 2020 2020 7363 6865 6475 6c65 5f63        schedule_c
-0001c2f0: 726f 6e20 3d20 4e6f 6e65 2069 6620 7363  ron = None if sc
-0001c300: 6865 6475 6c65 5f63 726f 6e20 3d3d 204f  hedule_cron == O
-0001c310: 4e5f 4445 4d41 4e44 2065 6c73 6520 7363  N_DEMAND else sc
-0001c320: 6865 6475 6c65 5f63 726f 6e0a 2020 2020  hedule_cron.    
-0001c330: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0001c340: 656e 745f 7461 7267 6574 5f64 6174 6173  ent_target_datas
-0001c350: 6f75 7263 655f 6964 203d 2064 6174 615b  ource_id = data[
-0001c360: 2263 6f70 795f 7461 7267 6574 5f64 6174  "copy_target_dat
-0001c370: 6173 6f75 7263 6522 5d0a 2020 2020 2020  asource"].      
-0001c380: 2020 2020 2020 2020 2020 7461 7267 6574            target
-0001c390: 5f64 6174 6173 6f75 7263 655f 7265 7370  _datasource_resp
-0001c3a0: 6f6e 7365 203d 2061 7761 6974 2074 625f  onse = await tb_
-0001c3b0: 636c 6965 6e74 2e67 6574 5f64 6174 6173  client.get_datas
-0001c3c0: 6f75 7263 6528 7461 7267 6574 5f64 6174  ource(target_dat
-0001c3d0: 6173 6f75 7263 6529 0a20 2020 2020 2020  asource).       
-0001c3e0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
-0001c3f0: 6461 7461 736f 7572 6365 5f74 6f5f 7365  datasource_to_se
-0001c400: 6e64 203d 2028 0a20 2020 2020 2020 2020  nd = (.         
-0001c410: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0001c420: 745f 6461 7461 736f 7572 6365 0a20 2020  t_datasource.   
-0001c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c440: 2069 6620 7461 7267 6574 5f64 6174 6173   if target_datas
-0001c450: 6f75 7263 655f 7265 7370 6f6e 7365 2e67  ource_response.g
-0001c460: 6574 2822 6964 222c 2074 6172 6765 745f  et("id", target_
-0001c470: 6461 7461 736f 7572 6365 2920 213d 2063  datasource) != c
-0001c480: 7572 7265 6e74 5f74 6172 6765 745f 6461  urrent_target_da
-0001c490: 7461 736f 7572 6365 5f69 640a 2020 2020  tasource_id.    
-0001c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4b0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-0001c4c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001c4d0: 2020 2020 2020 2020 2020 2020 636f 7079              copy
-0001c4e0: 5f70 6172 616d 735b 436f 7079 5061 7261  _params[CopyPara
-0001c4f0: 6d65 7465 7273 2e54 4152 4745 545f 4441  meters.TARGET_DA
-0001c500: 5441 534f 5552 4345 5d20 3d20 7461 7267  TASOURCE] = targ
-0001c510: 6574 5f64 6174 6173 6f75 7263 655f 746f  et_datasource_to
-0001c520: 5f73 656e 640a 2020 2020 2020 2020 2020  _send.          
-0001c530: 2020 2020 2020 6375 7272 656e 745f 7363        current_sc
-0001c540: 6865 6475 6c65 203d 2064 6174 612e 6765  hedule = data.ge
-0001c550: 7428 2273 6368 6564 756c 6522 2c20 7b7d  t("schedule", {}
-0001c560: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001c570: 2020 6375 7272 656e 745f 7363 6865 6475    current_schedu
-0001c580: 6c65 5f63 726f 6e20 3d20 6375 7272 656e  le_cron = curren
-0001c590: 745f 7363 6865 6475 6c65 2e67 6574 2822  t_schedule.get("
-0001c5a0: 6372 6f6e 222c 204e 6f6e 6529 2069 6620  cron", None) if 
-0001c5b0: 6375 7272 656e 745f 7363 6865 6475 6c65  current_schedule
-0001c5c0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-0001c5d0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
-0001c5e0: 756c 655f 6372 6f6e 5f73 686f 756c 645f  ule_cron_should_
-0001c5f0: 6265 5f72 656d 6f76 6564 203d 2063 7572  be_removed = cur
-0001c600: 7265 6e74 5f73 6368 6564 756c 655f 6372  rent_schedule_cr
-0001c610: 6f6e 2061 6e64 206e 6f74 2073 6368 6564  on and not sched
-0001c620: 756c 655f 6372 6f6e 0a20 2020 2020 2020  ule_cron.       
-0001c630: 2020 2020 2020 2020 2063 6f70 795f 7061           copy_pa
-0001c640: 7261 6d73 5b22 7363 6865 6475 6c65 5f63  rams["schedule_c
-0001c650: 726f 6e22 5d20 3d20 224e 6f6e 6522 2069  ron"] = "None" i
-0001c660: 6620 7363 6865 6475 6c65 5f63 726f 6e5f  f schedule_cron_
-0001c670: 7368 6f75 6c64 5f62 655f 7265 6d6f 7665  should_be_remove
-0001c680: 6420 656c 7365 2073 6368 6564 756c 655f  d else schedule_
-0001c690: 6372 6f6e 0a20 2020 2020 2020 2020 2020  cron.           
-0001c6a0: 2020 2020 2061 7761 6974 2074 625f 636c       await tb_cl
-0001c6b0: 6965 6e74 2e70 6970 655f 7570 6461 7465  ient.pipe_update
-0001c6c0: 5f63 6f70 7928 2a2a 636f 7079 5f70 6172  _copy(**copy_par
-0001c6d0: 616d 7329 0a20 2020 2020 2020 2020 2020  ams).           
-0001c6e0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0001c6f0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-0001c700: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0001c710: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-0001c720: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
-0001c730: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-0001c740: 6f72 5f73 6574 7469 6e67 5f63 6f70 795f  or_setting_copy_
-0001c750: 6e6f 6465 286e 6f64 653d 636f 7079 5f6e  node(node=copy_n
-0001c760: 6f64 652e 6765 7428 226e 616d 6522 292c  ode.get("name"),
-0001c770: 2070 6970 653d 705b 226e 616d 6522 5d2c   pipe=p["name"],
-0001c780: 2065 7272 6f72 3d73 7472 2865 2929 0a20   error=str(e)). 
-0001c790: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001c7a0: 0a0a 2020 2020 6966 2070 5b22 746f 6b65  ..    if p["toke
-0001c7b0: 6e73 225d 2061 6e64 206e 6f74 2073 6b69  ns"] and not ski
-0001c7c0: 705f 746f 6b65 6e73 2061 6e64 206e 6f74  p_tokens and not
-0001c7d0: 2061 735f 7374 616e 6461 7264 2061 6e64   as_standard and
-0001c7e0: 2064 6174 612e 6765 7428 2274 7970 6522   data.get("type"
-0001c7f0: 2920 696e 205b 2265 6e64 706f 696e 7422  ) in ["endpoint"
-0001c800: 2c20 2263 6f70 7922 5d3a 0a20 2020 2020  , "copy"]:.     
-0001c810: 2020 2023 2073 6561 7263 6820 666f 7220     # search for 
-0001c820: 746f 6b65 6e20 7769 7468 2073 7065 6369  token with speci
-0001c830: 6669 6564 206e 616d 6520 616e 6420 6164  fied name and ad
-0001c840: 6473 2069 7420 6966 206e 6f74 2066 6f75  ds it if not fou
-0001c850: 6e64 206f 7220 6164 6473 2070 6572 6d69  nd or adds permi
-0001c860: 7373 696f 6e73 2074 6f20 6974 0a20 2020  ssions to it.   
-0001c870: 2020 2020 2074 203d 204e 6f6e 650a 2020       t = None.  
-0001c880: 2020 2020 2020 666f 7220 746b 2069 6e20        for tk in 
-0001c890: 705b 2274 6f6b 656e 7322 5d3a 0a20 2020  p["tokens"]:.   
-0001c8a0: 2020 2020 2020 2020 2074 6f6b 656e 5f6e           token_n
-0001c8b0: 616d 6520 3d20 746b 5b22 746f 6b65 6e5f  ame = tk["token_
-0001c8c0: 6e61 6d65 225d 0a20 2020 2020 2020 2020  name"].         
-0001c8d0: 2020 2074 203d 2061 7761 6974 2074 625f     t = await tb_
-0001c8e0: 636c 6965 6e74 2e67 6574 5f74 6f6b 656e  client.get_token
-0001c8f0: 5f62 795f 6e61 6d65 2874 6f6b 656e 5f6e  _by_name(token_n
-0001c900: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0001c910: 2069 6620 743a 0a20 2020 2020 2020 2020   if t:.         
-0001c920: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-0001c930: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-0001c940: 722e 696e 666f 5f63 7265 6174 655f 666f  r.info_create_fo
-0001c950: 756e 645f 746f 6b65 6e28 746f 6b65 6e3d  und_token(token=
-0001c960: 746f 6b65 6e5f 6e61 6d65 2929 0a20 2020  token_name)).   
-0001c970: 2020 2020 2020 2020 2020 2020 2073 636f               sco
-0001c980: 7065 7320 3d20 5b66 2250 4950 4553 3a7b  pes = [f"PIPES:{
-0001c990: 746b 5b27 7065 726d 6973 7369 6f6e 7327  tk['permissions'
-0001c9a0: 5d7d 3a7b 705b 276e 616d 6527 5d7d 225d  ]}:{p['name']}"]
-0001c9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c9c0: 2066 6f72 2078 2069 6e20 745b 2273 636f   for x in t["sco
-0001c9d0: 7065 7322 5d3a 0a20 2020 2020 2020 2020  pes"]:.         
-0001c9e0: 2020 2020 2020 2020 2020 2073 6320 3d20             sc = 
-0001c9f0: 785b 2274 7970 6522 5d20 6966 2022 7265  x["type"] if "re
-0001ca00: 736f 7572 6365 2220 6e6f 7420 696e 2078  source" not in x
-0001ca10: 2065 6c73 6520 6622 7b78 5b27 7479 7065   else f"{x['type
-0001ca20: 275d 7d3a 7b78 5b27 7265 736f 7572 6365  ']}:{x['resource
-0001ca30: 275d 7d22 0a20 2020 2020 2020 2020 2020  ']}".           
-0001ca40: 2020 2020 2020 2020 2073 636f 7065 732e           scopes.
-0001ca50: 6170 7065 6e64 2873 6329 0a20 2020 2020  append(sc).     
-0001ca60: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0001ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca80: 2020 2020 7220 3d20 6177 6169 7420 7462      r = await tb
-0001ca90: 5f63 6c69 656e 742e 616c 7465 725f 746f  _client.alter_to
-0001caa0: 6b65 6e73 2874 6f6b 656e 5f6e 616d 652c  kens(token_name,
-0001cab0: 2073 636f 7065 7329 0a20 2020 2020 2020   scopes).       
-0001cac0: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-0001cad0: 656e 203d 2072 5b22 746f 6b65 6e22 5d20  en = r["token"] 
-0001cae0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0001caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0001cb10: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0001cb20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001cb30: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-0001cb40: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-0001cb50: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
-0001cb60: 7469 6e67 5f70 6970 6528 6572 726f 723d  ting_pipe(error=
-0001cb70: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0001cb80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001cb90: 2020 2020 2020 746f 6b65 6e5f 6e61 6d65        token_name
-0001cba0: 203d 2074 6b5b 2274 6f6b 656e 5f6e 616d   = tk["token_nam
-0001cbb0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-0001cbc0: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
-0001cbd0: 6565 6462 6163 6b4d 616e 6167 6572 2e69  eedbackManager.i
-0001cbe0: 6e66 6f5f 6372 6561 7465 5f6e 6f74 5f66  nfo_create_not_f
-0001cbf0: 6f75 6e64 5f74 6f6b 656e 2874 6f6b 656e  ound_token(token
-0001cc00: 3d74 6f6b 656e 5f6e 616d 6529 290a 2020  =token_name)).  
-0001cc10: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0001cc20: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0001cc30: 2020 2020 2020 2072 203d 2061 7761 6974         r = await
-0001cc40: 2074 625f 636c 6965 6e74 2e63 7265 6174   tb_client.creat
-0001cc50: 655f 746f 6b65 6e28 0a20 2020 2020 2020  e_token(.       
-0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc70: 2074 6f6b 656e 5f6e 616d 652c 2066 2250   token_name, f"P
-0001cc80: 4950 4553 3a7b 746b 5b27 7065 726d 6973  IPES:{tk['permis
-0001cc90: 7369 6f6e 7327 5d7d 3a7b 705b 276e 616d  sions']}:{p['nam
-0001cca0: 6527 5d7d 222c 2022 5022 2c20 705b 226e  e']}", "P", p["n
-0001ccb0: 616d 6522 5d0a 2020 2020 2020 2020 2020  ame"].          
-0001ccc0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cce0: 746f 6b65 6e20 3d20 725b 2274 6f6b 656e  token = r["token
-0001ccf0: 225d 2020 2320 7479 7065 3a20 6967 6e6f  "]  # type: igno
-0001cd00: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
-0001cd10: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0001cd20: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0001cd30: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001cd40: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0001cd50: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
-0001cd60: 6b4d 616e 6167 6572 2e65 7272 6f72 5f63  kManager.error_c
-0001cd70: 7265 6174 696e 675f 7069 7065 2865 7272  reating_pipe(err
-0001cd80: 6f72 3d65 2929 0a0a 2020 2020 2020 2020  or=e))..        
-0001cd90: 6966 2064 6174 612e 6765 7428 2274 7970  if data.get("typ
-0001cda0: 6522 2920 3d3d 2022 656e 6470 6f69 6e74  e") == "endpoint
-0001cdb0: 223a 0a20 2020 2020 2020 2020 2020 2063  ":.            c
-0001cdc0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-0001cdd0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
-0001cde0: 735f 7465 7374 5f65 6e64 706f 696e 7428  s_test_endpoint(
-0001cdf0: 686f 7374 3d68 6f73 742c 2070 6970 653d  host=host, pipe=
-0001ce00: 705b 226e 616d 6522 5d2c 2074 6f6b 656e  p["name"], token
-0001ce10: 3d74 6f6b 656e 2929 0a0a 0a61 7379 6e63  =token))...async
-0001ce20: 2064 6566 2073 6861 7265 5f61 6e64 5f75   def share_and_u
-0001ce30: 6e73 6861 7265 5f64 6174 6173 6f75 7263  nshare_datasourc
-0001ce40: 6528 0a20 2020 2063 6c69 656e 743a 2054  e(.    client: T
-0001ce50: 696e 7942 2c0a 2020 2020 6461 7461 736f  inyB,.    dataso
-0001ce60: 7572 6365 3a20 4469 6374 5b73 7472 2c20  urce: Dict[str, 
-0001ce70: 416e 795d 2c0a 2020 2020 7573 6572 5f74  Any],.    user_t
-0001ce80: 6f6b 656e 3a20 7374 722c 0a20 2020 2077  oken: str,.    w
-0001ce90: 6f72 6b73 7061 6365 735f 6375 7272 656e  orkspaces_curren
-0001cea0: 745f 7368 6172 6564 5f77 6974 683a 204c  t_shared_with: L
-0001ceb0: 6973 745b 7374 725d 2c0a 2020 2020 776f  ist[str],.    wo
-0001cec0: 726b 7370 6163 6573 5f74 6f5f 7368 6172  rkspaces_to_shar
-0001ced0: 653a 204c 6973 745b 7374 725d 2c0a 2020  e: List[str],.  
-0001cee0: 2020 6375 7272 656e 745f 7773 3a20 4f70    current_ws: Op
-0001cef0: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
-0001cf00: 2041 6e79 5d5d 2c0a 2920 2d3e 204e 6f6e   Any]],.) -> Non
-0001cf10: 653a 0a20 2020 2064 6174 6173 6f75 7263  e:.    datasourc
-0001cf20: 655f 6e61 6d65 203d 2064 6174 6173 6f75  e_name = datasou
-0001cf30: 7263 652e 6765 7428 226e 616d 6522 2c20  rce.get("name", 
-0001cf40: 2222 290a 2020 2020 6461 7461 736f 7572  "").    datasour
-0001cf50: 6365 5f69 6420 3d20 6461 7461 736f 7572  ce_id = datasour
-0001cf60: 6365 2e67 6574 2822 6964 222c 2022 2229  ce.get("id", "")
-0001cf70: 0a20 2020 2077 6f72 6b73 7061 6365 733a  .    workspaces:
-0001cf80: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
-0001cf90: 416e 795d 5d0a 0a20 2020 2023 2049 6e20  Any]]..    # In 
-0001cfa0: 6361 7365 2077 6520 6172 6520 7075 7368  case we are push
-0001cfb0: 696e 6720 746f 2061 2062 7261 6e63 682c  ing to a branch,
-0001cfc0: 2077 6520 646f 6e27 7420 7368 6172 6520   we don't share 
-0001cfd0: 7468 6520 6461 7461 736f 7572 6365 0a20  the datasource. 
-0001cfe0: 2020 2023 2046 4958 4d45 3a20 4861 7665     # FIXME: Have
-0001cff0: 206f 6e6c 7920 6f6e 6365 2077 6179 2074   only once way t
-0001d000: 6f20 6765 7420 7468 6520 6375 7272 656e  o get the curren
-0001d010: 7420 776f 726b 7370 6163 650a 2020 2020  t workspace.    
-0001d020: 6966 2063 7572 7265 6e74 5f77 733a 0a20  if current_ws:. 
-0001d030: 2020 2020 2020 2023 2046 6f72 6365 2074         # Force t
-0001d040: 6f20 6765 7420 616c 6c20 7468 6520 776f  o get all the wo
-0001d050: 726b 7370 6163 6573 2074 6865 2075 7365  rkspaces the use
-0001d060: 7220 6361 6e20 6163 6365 7373 0a20 2020  r can access.   
-0001d070: 2020 2020 2077 6f72 6b73 7061 6365 203d       workspace =
-0001d080: 2063 7572 7265 6e74 5f77 730a 2020 2020   current_ws.    
-0001d090: 2020 2020 776f 726b 7370 6163 6573 203d      workspaces =
-0001d0a0: 2028 6177 6169 7420 636c 6965 6e74 2e75   (await client.u
-0001d0b0: 7365 725f 776f 726b 7370 6163 6573 2829  ser_workspaces()
-0001d0c0: 292e 6765 7428 2277 6f72 6b73 7061 6365  ).get("workspace
-0001d0d0: 7322 2c20 5b5d 290a 2020 2020 656c 7365  s", []).    else
-0001d0e0: 3a0a 2020 2020 2020 2020 776f 726b 7370  :.        worksp
-0001d0f0: 6163 6520 3d20 6177 6169 7420 636c 6965  ace = await clie
-0001d100: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
-0001d110: 655f 6272 616e 6368 6573 2829 0a20 2020  e_branches().   
-0001d120: 2020 2020 2077 6f72 6b73 7061 6365 7320       workspaces 
-0001d130: 3d20 776f 726b 7370 6163 652e 6765 7428  = workspace.get(
-0001d140: 2277 6f72 6b73 7061 6365 7322 2c20 5b5d  "workspaces", []
-0001d150: 290a 0a20 2020 2069 6620 776f 726b 7370  )..    if worksp
-0001d160: 6163 652e 6765 7428 2269 735f 6272 616e  ace.get("is_bran
-0001d170: 6368 222c 2046 616c 7365 293a 0a20 2020  ch", False):.   
-0001d180: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-0001d190: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001d1a0: 696e 666f 5f73 6b69 7070 696e 675f 7368  info_skipping_sh
-0001d1b0: 6172 696e 675f 6461 7461 736f 7572 6365  aring_datasource
-0001d1c0: 735f 6272 616e 6368 2864 6174 6173 6f75  s_branch(datasou
-0001d1d0: 7263 653d 6461 7461 736f 7572 6365 5b22  rce=datasource["
-0001d1e0: 6e61 6d65 225d 2929 0a20 2020 2020 2020  name"])).       
-0001d1f0: 2072 6574 7572 6e0a 0a20 2020 2023 2057   return..    # W
-0001d200: 6520 6475 706c 6963 6174 6520 7468 6520  e duplicate the 
-0001d210: 636c 6965 6e74 2074 6f20 7573 6520 7468  client to use th
-0001d220: 6520 7573 6572 5f74 6f6b 656e 0a20 2020  e user_token.   
-0001d230: 2075 7365 725f 636c 6965 6e74 3a20 5469   user_client: Ti
-0001d240: 6e79 4220 3d20 6465 6570 636f 7079 2863  nyB = deepcopy(c
-0001d250: 6c69 656e 7429 0a20 2020 2075 7365 725f  lient).    user_
-0001d260: 636c 6965 6e74 2e74 6f6b 656e 203d 2075  client.token = u
-0001d270: 7365 725f 746f 6b65 6e0a 2020 2020 6966  ser_token.    if
-0001d280: 206e 6f74 2077 6f72 6b73 7061 6365 735f   not workspaces_
-0001d290: 6375 7272 656e 745f 7368 6172 6564 5f77  current_shared_w
-0001d2a0: 6974 683a 0a20 2020 2020 2020 2066 6f72  ith:.        for
-0001d2b0: 2077 6f72 6b73 7061 6365 5f74 6f5f 7368   workspace_to_sh
-0001d2c0: 6172 6520 696e 2077 6f72 6b73 7061 6365  are in workspace
-0001d2d0: 735f 746f 5f73 6861 7265 3a0a 2020 2020  s_to_share:.    
-0001d2e0: 2020 2020 2020 2020 773a 204f 7074 696f          w: Optio
-0001d2f0: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
-0001d300: 795d 5d20 3d20 6e65 7874 2828 7720 666f  y]] = next((w fo
-0001d310: 7220 7720 696e 2077 6f72 6b73 7061 6365  r w in workspace
-0001d320: 7320 6966 2077 5b22 6e61 6d65 225d 203d  s if w["name"] =
-0001d330: 3d20 776f 726b 7370 6163 655f 746f 5f73  = workspace_to_s
-0001d340: 6861 7265 292c 204e 6f6e 6529 0a20 2020  hare), None).   
-0001d350: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001d360: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
-0001d370: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0001d380: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0001d390: 2020 2020 2020 2020 6622 556e 6162 6c65          f"Unable
-0001d3a0: 2074 6f20 7368 6172 6520 6461 7461 736f   to share dataso
-0001d3b0: 7572 6365 2077 6974 6820 7468 6520 776f  urce with the wo
-0001d3c0: 726b 7370 6163 6520 7b77 6f72 6b73 7061  rkspace {workspa
-0001d3d0: 6365 5f74 6f5f 7368 6172 657d 2e20 5265  ce_to_share}. Re
-0001d3e0: 7669 6577 2074 6861 7420 796f 7520 6861  view that you ha
-0001d3f0: 7665 2074 6865 2061 646d 696e 2070 6572  ve the admin per
-0001d400: 6d69 7373 696f 6e73 206f 6e20 7468 6973  missions on this
-0001d410: 2077 6f72 6b73 7061 6365 220a 2020 2020   workspace".    
-0001d420: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0001d430: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0001d440: 2075 7365 725f 636c 6965 6e74 2e64 6174   user_client.dat
-0001d450: 6173 6f75 7263 655f 7368 6172 6528 0a20  asource_share(. 
-0001d460: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001d470: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
-0001d480: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
-0001d490: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0001d4a0: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
-0001d4b0: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
-0001d4c0: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
-0001d4d0: 2020 2020 2020 2020 2020 6465 7374 696e            destin
-0001d4e0: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
-0001d4f0: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
-0001d500: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0001d510: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0001d520: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
-0001d530: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0001d540: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
-0001d550: 735f 6461 7461 736f 7572 6365 5f73 6861  s_datasource_sha
-0001d560: 7265 6428 6461 7461 736f 7572 6365 3d64  red(datasource=d
-0001d570: 6174 6173 6f75 7263 655f 6e61 6d65 2c20  atasource_name, 
-0001d580: 776f 726b 7370 6163 653d 772e 6765 7428  workspace=w.get(
-0001d590: 226e 616d 6522 2c20 2222 2929 0a20 2020  "name", "")).   
-0001d5a0: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
-0001d5b0: 6c73 653a 0a20 2020 2020 2020 2073 6861  lse:.        sha
-0001d5c0: 7265 645f 7769 7468 203d 205b 0a20 2020  red_with = [.   
-0001d5d0: 2020 2020 2020 2020 2077 0a20 2020 2020           w.     
-0001d5e0: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
-0001d5f0: 776f 726b 7370 6163 6573 0a20 2020 2020  workspaces.     
-0001d600: 2020 2020 2020 2069 6620 6e65 7874 2828         if next((
-0001d610: 7773 2066 6f72 2077 7320 696e 2077 6f72  ws for ws in wor
-0001d620: 6b73 7061 6365 735f 6375 7272 656e 745f  kspaces_current_
-0001d630: 7368 6172 6564 5f77 6974 6820 6966 2077  shared_with if w
-0001d640: 7320 3d3d 2077 5b22 6964 225d 206f 7220  s == w["id"] or 
-0001d650: 7773 203d 3d20 775b 226e 616d 6522 5d29  ws == w["name"])
-0001d660: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0001d670: 5d0a 2020 2020 2020 2020 6465 6669 6e65  ].        define
-0001d680: 645f 746f 5f73 6861 7265 5f77 6974 6820  d_to_share_with 
-0001d690: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001d6a0: 7720 666f 7220 7720 696e 2077 6f72 6b73  w for w in works
-0001d6b0: 7061 6365 7320 6966 206e 6578 7428 2877  paces if next((w
-0001d6c0: 7320 666f 7220 7773 2069 6e20 776f 726b  s for ws in work
-0001d6d0: 7370 6163 6573 5f74 6f5f 7368 6172 6520  spaces_to_share 
-0001d6e0: 6966 2077 7320 3d3d 2077 5b22 6964 225d  if ws == w["id"]
-0001d6f0: 206f 7220 7773 203d 3d20 775b 226e 616d   or ws == w["nam
-0001d700: 6522 5d29 2c20 4e6f 6e65 290a 2020 2020  e"]), None).    
-0001d710: 2020 2020 5d0a 2020 2020 2020 2020 776f      ].        wo
-0001d720: 726b 7370 6163 6573 5f6e 6565 645f 746f  rkspaces_need_to
-0001d730: 5f73 6861 7265 203d 205b 7720 666f 7220  _share = [w for 
-0001d740: 7720 696e 2064 6566 696e 6564 5f74 6f5f  w in defined_to_
-0001d750: 7368 6172 655f 7769 7468 2069 6620 7720  share_with if w 
-0001d760: 6e6f 7420 696e 2073 6861 7265 645f 7769  not in shared_wi
-0001d770: 7468 5d0a 2020 2020 2020 2020 776f 726b  th].        work
-0001d780: 7370 6163 6573 5f6e 6565 645f 746f 5f75  spaces_need_to_u
-0001d790: 6e73 6861 7265 203d 205b 7720 666f 7220  nshare = [w for 
-0001d7a0: 7720 696e 2073 6861 7265 645f 7769 7468  w in shared_with
-0001d7b0: 2069 6620 7720 6e6f 7420 696e 2064 6566   if w not in def
-0001d7c0: 696e 6564 5f74 6f5f 7368 6172 655f 7769  ined_to_share_wi
-0001d7d0: 7468 5d0a 0a20 2020 2020 2020 2066 6f72  th]..        for
-0001d7e0: 2077 2069 6e20 776f 726b 7370 6163 6573   w in workspaces
-0001d7f0: 5f6e 6565 645f 746f 5f73 6861 7265 3a0a  _need_to_share:.
-0001d800: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0001d810: 7420 7573 6572 5f63 6c69 656e 742e 6461  t user_client.da
-0001d820: 7461 736f 7572 6365 5f73 6861 7265 280a  tasource_share(.
-0001d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d840: 6461 7461 736f 7572 6365 5f69 643d 6461  datasource_id=da
-0001d850: 7461 736f 7572 6365 5f69 642c 0a20 2020  tasource_id,.   
-0001d860: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-0001d870: 7265 6e74 5f77 6f72 6b73 7061 6365 5f69  rent_workspace_i
-0001d880: 643d 776f 726b 7370 6163 652e 6765 7428  d=workspace.get(
-0001d890: 2269 6422 2c20 2222 292c 0a20 2020 2020  "id", ""),.     
-0001d8a0: 2020 2020 2020 2020 2020 2064 6573 7469             desti
-0001d8b0: 6e61 7469 6f6e 5f77 6f72 6b73 7061 6365  nation_workspace
-0001d8c0: 5f69 643d 772e 6765 7428 2269 6422 2c20  _id=w.get("id", 
-0001d8d0: 2222 292c 0a20 2020 2020 2020 2020 2020  ""),.           
-0001d8e0: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
-0001d8f0: 6c69 636b 2e65 6368 6f28 0a20 2020 2020  lick.echo(.     
-0001d900: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
-0001d910: 6163 6b4d 616e 6167 6572 2e73 7563 6365  ackManager.succe
-0001d920: 7373 5f64 6174 6173 6f75 7263 655f 7368  ss_datasource_sh
-0001d930: 6172 6564 2864 6174 6173 6f75 7263 653d  ared(datasource=
-0001d940: 6461 7461 736f 7572 6365 5b22 6e61 6d65  datasource["name
-0001d950: 225d 2c20 776f 726b 7370 6163 653d 772e  "], workspace=w.
-0001d960: 6765 7428 226e 616d 6522 2c20 2222 2929  get("name", ""))
-0001d970: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0001d980: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
-0001d990: 2077 6f72 6b73 7061 6365 735f 6e65 6564   workspaces_need
-0001d9a0: 5f74 6f5f 756e 7368 6172 653a 0a20 2020  _to_unshare:.   
-0001d9b0: 2020 2020 2020 2020 2061 7761 6974 2075           await u
-0001d9c0: 7365 725f 636c 6965 6e74 2e64 6174 6173  ser_client.datas
-0001d9d0: 6f75 7263 655f 756e 7368 6172 6528 0a20  ource_unshare(. 
-0001d9e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001d9f0: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
-0001da00: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
-0001da10: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0001da20: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
-0001da30: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
-0001da40: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
-0001da50: 2020 2020 2020 2020 2020 6465 7374 696e            destin
-0001da60: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
-0001da70: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
-0001da80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0001da90: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0001daa0: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
-0001dab0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0001dac0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
-0001dad0: 735f 6461 7461 736f 7572 6365 5f75 6e73  s_datasource_uns
-0001dae0: 6861 7265 6428 6461 7461 736f 7572 6365  hared(datasource
-0001daf0: 3d64 6174 6173 6f75 7263 655f 6e61 6d65  =datasource_name
-0001db00: 2c20 776f 726b 7370 6163 653d 772e 6765  , workspace=w.ge
-0001db10: 7428 226e 616d 6522 2c20 2222 2929 0a20  t("name", "")). 
-0001db20: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
-0001db30: 7379 6e63 2064 6566 206e 6577 5f64 7328  sync def new_ds(
-0001db40: 0a20 2020 2064 733a 2044 6963 745b 7374  .    ds: Dict[st
-0001db50: 722c 2041 6e79 5d2c 0a20 2020 2063 6c69  r, Any],.    cli
-0001db60: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
-0001db70: 7573 6572 5f74 6f6b 656e 3a20 4f70 7469  user_token: Opti
-0001db80: 6f6e 616c 5b73 7472 5d2c 0a20 2020 2066  onal[str],.    f
-0001db90: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
-0001dba0: 7365 2c0a 2020 2020 736b 6970 5f63 6f6e  se,.    skip_con
-0001dbb0: 6669 726d 6174 696f 6e3a 2062 6f6f 6c20  firmation: bool 
-0001dbc0: 3d20 4661 6c73 652c 0a20 2020 2063 7572  = False,.    cur
-0001dbd0: 7265 6e74 5f77 733d 4e6f 6e65 2c0a 2020  rent_ws=None,.  
-0001dbe0: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
-0001dbf0: 6d3a 204f 7074 696f 6e61 6c5b 626f 6f6c  m: Optional[bool
-0001dc00: 5d20 3d20 4661 6c73 652c 0a20 2020 2066  ] = False,.    f
-0001dc10: 6f72 6b3a 204f 7074 696f 6e61 6c5b 626f  ork: Optional[bo
-0001dc20: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
-0001dc30: 2067 6974 5f72 656c 6561 7365 3a20 4f70   git_release: Op
-0001dc40: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
-0001dc50: 616c 7365 2c0a 293a 0a20 2020 2064 735f  alse,.):.    ds_
-0001dc60: 6e61 6d65 203d 2064 735b 2270 6172 616d  name = ds["param
-0001dc70: 7322 5d5b 226e 616d 6522 5d0a 0a20 2020  s"]["name"]..   
-0001dc80: 2061 7379 6e63 2064 6566 206d 616e 6167   async def manag
-0001dc90: 655f 746f 6b65 6e73 2829 3a0a 2020 2020  e_tokens():.    
-0001dca0: 2020 2020 2320 7365 6172 6368 2066 6f72      # search for
-0001dcb0: 2074 6f6b 656e 2077 6974 6820 7370 6563   token with spec
-0001dcc0: 6966 6965 6420 6e61 6d65 2061 6e64 2061  ified name and a
-0001dcd0: 6464 7320 6974 2069 6620 6e6f 7420 666f  dds it if not fo
-0001dce0: 756e 6420 6f72 2061 6464 7320 7065 726d  und or adds perm
-0001dcf0: 6973 7369 6f6e 7320 746f 2069 740a 2020  issions to it.  
-0001dd00: 2020 2020 2020 7420 3d20 4e6f 6e65 0a20        t = None. 
-0001dd10: 2020 2020 2020 2066 6f72 2074 6b20 696e         for tk in
-0001dd20: 2064 735b 2274 6f6b 656e 7322 5d3a 0a20   ds["tokens"]:. 
-0001dd30: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-0001dd40: 5f6e 616d 6520 3d20 746b 5b22 746f 6b65  _name = tk["toke
-0001dd50: 6e5f 6e61 6d65 225d 0a20 2020 2020 2020  n_name"].       
-0001dd60: 2020 2020 2074 203d 2061 7761 6974 2063       t = await c
-0001dd70: 6c69 656e 742e 6765 745f 746f 6b65 6e5f  lient.get_token_
-0001dd80: 6279 5f6e 616d 6528 746f 6b65 6e5f 6e61  by_name(token_na
-0001dd90: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0001dda0: 6966 206e 6f74 2074 3a0a 2020 2020 2020  if not t:.      
-0001ddb0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0001ddc0: 6e61 6d65 203d 2074 6b5b 2274 6f6b 656e  name = tk["token
-0001ddd0: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
-0001dde0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001ddf0: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-0001de00: 6572 2e69 6e66 6f5f 6372 6561 7465 5f6e  er.info_create_n
-0001de10: 6f74 5f66 6f75 6e64 5f74 6f6b 656e 2874  ot_found_token(t
-0001de20: 6f6b 656e 3d74 6f6b 656e 5f6e 616d 6529  oken=token_name)
-0001de30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001de40: 2020 2320 4453 203d 3d20 746f 6b65 6e5f    # DS == token_
-0001de50: 6f72 6967 696e 2e4f 7269 6769 6e73 2e44  origin.Origins.D
-0001de60: 4154 4153 4f55 5243 450a 2020 2020 2020  ATASOURCE.      
-0001de70: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0001de80: 636c 6965 6e74 2e63 7265 6174 655f 746f  client.create_to
-0001de90: 6b65 6e28 746f 6b65 6e5f 6e61 6d65 2c20  ken(token_name, 
-0001dea0: 6622 4441 5441 534f 5552 4345 533a 7b74  f"DATASOURCES:{t
-0001deb0: 6b5b 2770 6572 6d69 7373 696f 6e73 275d  k['permissions']
-0001dec0: 7d3a 7b64 735f 6e61 6d65 7d22 2c20 2244  }:{ds_name}", "D
-0001ded0: 5322 2c20 6473 5f6e 616d 6529 0a20 2020  S", ds_name).   
-0001dee0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001def0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001df00: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-0001df10: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
-0001df20: 7265 6174 655f 666f 756e 645f 746f 6b65  reate_found_toke
-0001df30: 6e28 746f 6b65 6e3d 746f 6b65 6e5f 6e61  n(token=token_na
-0001df40: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
-0001df50: 2020 2020 2073 636f 7065 7320 3d20 5b66       scopes = [f
-0001df60: 2244 4154 4153 4f55 5243 4553 3a7b 746b  "DATASOURCES:{tk
-0001df70: 5b27 7065 726d 6973 7369 6f6e 7327 5d7d  ['permissions']}
-0001df80: 3a7b 6473 5f6e 616d 657d 225d 0a20 2020  :{ds_name}"].   
-0001df90: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001dfa0: 2078 2069 6e20 745b 2273 636f 7065 7322   x in t["scopes"
-0001dfb0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001dfc0: 2020 2020 2020 2073 6320 3d20 785b 2274         sc = x["t
-0001dfd0: 7970 6522 5d20 6966 2022 7265 736f 7572  ype"] if "resour
-0001dfe0: 6365 2220 6e6f 7420 696e 2078 2065 6c73  ce" not in x els
-0001dff0: 6520 6622 7b78 5b27 7479 7065 275d 7d3a  e f"{x['type']}:
-0001e000: 7b78 5b27 7265 736f 7572 6365 275d 7d22  {x['resource']}"
-0001e010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e020: 2020 2020 2073 636f 7065 732e 6170 7065       scopes.appe
-0001e030: 6e64 2873 6329 0a20 2020 2020 2020 2020  nd(sc).         
-0001e040: 2020 2020 2020 2061 7761 6974 2063 6c69         await cli
-0001e050: 656e 742e 616c 7465 725f 746f 6b65 6e73  ent.alter_tokens
-0001e060: 2874 6f6b 656e 5f6e 616d 652c 2073 636f  (token_name, sco
-0001e070: 7065 7329 0a0a 2020 2020 7472 793a 0a20  pes)..    try:. 
-0001e080: 2020 2020 2020 2065 7869 7374 696e 675f         existing_
-0001e090: 6473 203d 2061 7761 6974 2063 6c69 656e  ds = await clien
-0001e0a0: 742e 6765 745f 6461 7461 736f 7572 6365  t.get_datasource
-0001e0b0: 2864 735f 6e61 6d65 290a 2020 2020 2020  (ds_name).      
-0001e0c0: 2020 6461 7461 736f 7572 6365 5f65 7869    datasource_exi
-0001e0d0: 7374 7320 3d20 5472 7565 0a20 2020 2065  sts = True.    e
-0001e0e0: 7863 6570 7420 446f 6573 4e6f 7445 7869  xcept DoesNotExi
-0001e0f0: 7374 4578 6365 7074 696f 6e3a 0a20 2020  stException:.   
-0001e100: 2020 2020 2064 6174 6173 6f75 7263 655f       datasource_
-0001e110: 6578 6973 7473 203d 2046 616c 7365 0a0a  exists = False..
-0001e120: 2020 2020 6966 206e 6f74 2064 6174 6173      if not datas
-0001e130: 6f75 7263 655f 6578 6973 7473 206f 7220  ource_exists or 
-0001e140: 666f 726b 5f64 6f77 6e73 7472 6561 6d20  fork_downstream 
-0001e150: 6f72 2066 6f72 6b3a 0a20 2020 2020 2020  or fork:.       
-0001e160: 2070 6172 616d 7320 3d20 6473 5b22 7061   params = ds["pa
-0001e170: 7261 6d73 225d 0a20 2020 2020 2020 2070  rams"].        p
-0001e180: 6172 616d 735b 2262 7261 6e63 685f 6d6f  arams["branch_mo
-0001e190: 6465 225d 203d 2022 666f 726b 2220 6966  de"] = "fork" if
-0001e1a0: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
-0001e1b0: 206f 7220 666f 726b 2065 6c73 6520 224e   or fork else "N
-0001e1c0: 6f6e 6522 0a0a 2020 2020 2020 2020 7472  one"..        tr
-0001e1d0: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
-0001e1e0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-0001e1f0: 2020 2020 7061 7261 6d73 2e67 6574 2822      params.get("
-0001e200: 7365 7276 6963 6522 2920 696e 2050 5245  service") in PRE
-0001e210: 5649 4557 5f43 4f4e 4e45 4354 4f52 5f53  VIEW_CONNECTOR_S
-0001e220: 4552 5649 4345 530a 2020 2020 2020 2020  ERVICES.        
-0001e230: 2020 2020 2020 2020 616e 6420 7061 7261          and para
-0001e240: 6d73 2e67 6574 2822 636f 6e6e 6563 746f  ms.get("connecto
-0001e250: 7222 290a 2020 2020 2020 2020 2020 2020  r").            
-0001e260: 2020 2020 616e 6420 7061 7261 6d73 2e67      and params.g
-0001e270: 6574 2822 6275 636b 6574 5f75 7269 2229  et("bucket_uri")
-0001e280: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
+0001c060: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+0001c070: 2e65 7272 6f72 5f73 6574 7469 6e67 5f63  .error_setting_c
+0001c080: 6f70 795f 6e6f 6465 286e 6f64 653d 636f  opy_node(node=co
+0001c090: 7079 5f6e 6f64 652e 6765 7428 226e 616d  py_node.get("nam
+0001c0a0: 6522 292c 2070 6970 653d 705b 226e 616d  e"), pipe=p["nam
+0001c0b0: 6522 5d2c 2065 7272 6f72 3d73 7472 2865  e"], error=str(e
+0001c0c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0001c0d0: 2020 2029 0a0a 2020 2020 6966 2070 5b22     )..    if p["
+0001c0e0: 746f 6b65 6e73 225d 2061 6e64 206e 6f74  tokens"] and not
+0001c0f0: 2073 6b69 705f 746f 6b65 6e73 2061 6e64   skip_tokens and
+0001c100: 206e 6f74 2061 735f 7374 616e 6461 7264   not as_standard
+0001c110: 2061 6e64 2064 6174 612e 6765 7428 2274   and data.get("t
+0001c120: 7970 6522 2920 696e 205b 2265 6e64 706f  ype") in ["endpo
+0001c130: 696e 7422 2c20 2263 6f70 7922 5d3a 0a20  int", "copy"]:. 
+0001c140: 2020 2020 2020 2023 2073 6561 7263 6820         # search 
+0001c150: 666f 7220 746f 6b65 6e20 7769 7468 2073  for token with s
+0001c160: 7065 6369 6669 6564 206e 616d 6520 616e  pecified name an
+0001c170: 6420 6164 6473 2069 7420 6966 206e 6f74  d adds it if not
+0001c180: 2066 6f75 6e64 206f 7220 6164 6473 2070   found or adds p
+0001c190: 6572 6d69 7373 696f 6e73 2074 6f20 6974  ermissions to it
+0001c1a0: 0a20 2020 2020 2020 2074 203d 204e 6f6e  .        t = Non
+0001c1b0: 650a 2020 2020 2020 2020 666f 7220 746b  e.        for tk
+0001c1c0: 2069 6e20 705b 2274 6f6b 656e 7322 5d3a   in p["tokens"]:
+0001c1d0: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+0001c1e0: 656e 5f6e 616d 6520 3d20 746b 5b22 746f  en_name = tk["to
+0001c1f0: 6b65 6e5f 6e61 6d65 225d 0a20 2020 2020  ken_name"].     
+0001c200: 2020 2020 2020 2074 203d 2061 7761 6974         t = await
+0001c210: 2074 625f 636c 6965 6e74 2e67 6574 5f74   tb_client.get_t
+0001c220: 6f6b 656e 5f62 795f 6e61 6d65 2874 6f6b  oken_by_name(tok
+0001c230: 656e 5f6e 616d 6529 0a20 2020 2020 2020  en_name).       
+0001c240: 2020 2020 2069 6620 743a 0a20 2020 2020       if t:.     
+0001c250: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0001c260: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+0001c270: 6e61 6765 722e 696e 666f 5f63 7265 6174  nager.info_creat
+0001c280: 655f 666f 756e 645f 746f 6b65 6e28 746f  e_found_token(to
+0001c290: 6b65 6e3d 746f 6b65 6e5f 6e61 6d65 2929  ken=token_name))
+0001c2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c2b0: 2073 636f 7065 7320 3d20 5b66 2250 4950   scopes = [f"PIP
+0001c2c0: 4553 3a7b 746b 5b27 7065 726d 6973 7369  ES:{tk['permissi
+0001c2d0: 6f6e 7327 5d7d 3a7b 705b 276e 616d 6527  ons']}:{p['name'
+0001c2e0: 5d7d 225d 0a20 2020 2020 2020 2020 2020  ]}"].           
+0001c2f0: 2020 2020 2066 6f72 2078 2069 6e20 745b       for x in t[
+0001c300: 2273 636f 7065 7322 5d3a 0a20 2020 2020  "scopes"]:.     
+0001c310: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001c320: 6320 3d20 785b 2274 7970 6522 5d20 6966  c = x["type"] if
+0001c330: 2022 7265 736f 7572 6365 2220 6e6f 7420   "resource" not 
+0001c340: 696e 2078 2065 6c73 6520 6622 7b78 5b27  in x else f"{x['
+0001c350: 7479 7065 275d 7d3a 7b78 5b27 7265 736f  type']}:{x['reso
+0001c360: 7572 6365 275d 7d22 0a20 2020 2020 2020  urce']}".       
+0001c370: 2020 2020 2020 2020 2020 2020 2073 636f               sco
+0001c380: 7065 732e 6170 7065 6e64 2873 6329 0a20  pes.append(sc). 
+0001c390: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001c3a0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001c3b0: 2020 2020 2020 2020 7220 3d20 6177 6169          r = awai
+0001c3c0: 7420 7462 5f63 6c69 656e 742e 616c 7465  t tb_client.alte
+0001c3d0: 725f 746f 6b65 6e73 2874 6f6b 656e 5f6e  r_tokens(token_n
+0001c3e0: 616d 652c 2073 636f 7065 7329 0a20 2020  ame, scopes).   
+0001c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c400: 2074 6f6b 656e 203d 2072 5b22 746f 6b65   token = r["toke
+0001c410: 6e22 5d20 2023 2074 7970 653a 2069 676e  n"]  # type: ign
+0001c420: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+0001c430: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0001c440: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0001c450: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001c460: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
+0001c470: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
+0001c480: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0001c490: 6372 6561 7469 6e67 5f70 6970 6528 6572  creating_pipe(er
+0001c4a0: 726f 723d 6529 290a 2020 2020 2020 2020  ror=e)).        
+0001c4b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001c4c0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0001c4d0: 6e61 6d65 203d 2074 6b5b 2274 6f6b 656e  name = tk["token
+0001c4e0: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
+0001c4f0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
+0001c500: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
+0001c510: 6572 2e69 6e66 6f5f 6372 6561 7465 5f6e  er.info_create_n
+0001c520: 6f74 5f66 6f75 6e64 5f74 6f6b 656e 2874  ot_found_token(t
+0001c530: 6f6b 656e 3d74 6f6b 656e 5f6e 616d 6529  oken=token_name)
+0001c540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c550: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001c560: 2020 2020 2020 2020 2020 2072 203d 2061             r = a
+0001c570: 7761 6974 2074 625f 636c 6965 6e74 2e63  wait tb_client.c
+0001c580: 7265 6174 655f 746f 6b65 6e28 0a20 2020  reate_token(.   
+0001c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5a0: 2020 2020 2074 6f6b 656e 5f6e 616d 652c       token_name,
+0001c5b0: 2066 2250 4950 4553 3a7b 746b 5b27 7065   f"PIPES:{tk['pe
+0001c5c0: 726d 6973 7369 6f6e 7327 5d7d 3a7b 705b  rmissions']}:{p[
+0001c5d0: 276e 616d 6527 5d7d 222c 2022 5022 2c20  'name']}", "P", 
+0001c5e0: 705b 226e 616d 6522 5d0a 2020 2020 2020  p["name"].      
+0001c5f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c610: 2020 2020 746f 6b65 6e20 3d20 725b 2274      token = r["t
+0001c620: 6f6b 656e 225d 2020 2320 7479 7065 3a20  oken"]  # type: 
+0001c630: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+0001c640: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0001c650: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0001c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c670: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0001c680: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+0001c690: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0001c6a0: 6f72 5f63 7265 6174 696e 675f 7069 7065  or_creating_pipe
+0001c6b0: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
+0001c6c0: 2020 2020 6966 2064 6174 612e 6765 7428      if data.get(
+0001c6d0: 2274 7970 6522 2920 3d3d 2022 656e 6470  "type") == "endp
+0001c6e0: 6f69 6e74 223a 0a20 2020 2020 2020 2020  oint":.         
+0001c6f0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+0001c700: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
+0001c710: 6363 6573 735f 7465 7374 5f65 6e64 706f  ccess_test_endpo
+0001c720: 696e 745f 6e6f 5f74 6f6b 656e 2868 6f73  int_no_token(hos
+0001c730: 743d 686f 7374 2c20 7069 7065 3d70 5b22  t=host, pipe=p["
+0001c740: 6e61 6d65 225d 2929 0a0a 0a61 7379 6e63  name"]))...async
+0001c750: 2064 6566 2073 6861 7265 5f61 6e64 5f75   def share_and_u
+0001c760: 6e73 6861 7265 5f64 6174 6173 6f75 7263  nshare_datasourc
+0001c770: 6528 0a20 2020 2063 6c69 656e 743a 2054  e(.    client: T
+0001c780: 696e 7942 2c0a 2020 2020 6461 7461 736f  inyB,.    dataso
+0001c790: 7572 6365 3a20 4469 6374 5b73 7472 2c20  urce: Dict[str, 
+0001c7a0: 416e 795d 2c0a 2020 2020 7573 6572 5f74  Any],.    user_t
+0001c7b0: 6f6b 656e 3a20 7374 722c 0a20 2020 2077  oken: str,.    w
+0001c7c0: 6f72 6b73 7061 6365 735f 6375 7272 656e  orkspaces_curren
+0001c7d0: 745f 7368 6172 6564 5f77 6974 683a 204c  t_shared_with: L
+0001c7e0: 6973 745b 7374 725d 2c0a 2020 2020 776f  ist[str],.    wo
+0001c7f0: 726b 7370 6163 6573 5f74 6f5f 7368 6172  rkspaces_to_shar
+0001c800: 653a 204c 6973 745b 7374 725d 2c0a 2020  e: List[str],.  
+0001c810: 2020 6375 7272 656e 745f 7773 3a20 4f70    current_ws: Op
+0001c820: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
+0001c830: 2041 6e79 5d5d 2c0a 2920 2d3e 204e 6f6e   Any]],.) -> Non
+0001c840: 653a 0a20 2020 2064 6174 6173 6f75 7263  e:.    datasourc
+0001c850: 655f 6e61 6d65 203d 2064 6174 6173 6f75  e_name = datasou
+0001c860: 7263 652e 6765 7428 226e 616d 6522 2c20  rce.get("name", 
+0001c870: 2222 290a 2020 2020 6461 7461 736f 7572  "").    datasour
+0001c880: 6365 5f69 6420 3d20 6461 7461 736f 7572  ce_id = datasour
+0001c890: 6365 2e67 6574 2822 6964 222c 2022 2229  ce.get("id", "")
+0001c8a0: 0a20 2020 2077 6f72 6b73 7061 6365 733a  .    workspaces:
+0001c8b0: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+0001c8c0: 416e 795d 5d0a 0a20 2020 2023 2049 6e20  Any]]..    # In 
+0001c8d0: 6361 7365 2077 6520 6172 6520 7075 7368  case we are push
+0001c8e0: 696e 6720 746f 2061 2062 7261 6e63 682c  ing to a branch,
+0001c8f0: 2077 6520 646f 6e27 7420 7368 6172 6520   we don't share 
+0001c900: 7468 6520 6461 7461 736f 7572 6365 0a20  the datasource. 
+0001c910: 2020 2023 2046 4958 4d45 3a20 4861 7665     # FIXME: Have
+0001c920: 206f 6e6c 7920 6f6e 6365 2077 6179 2074   only once way t
+0001c930: 6f20 6765 7420 7468 6520 6375 7272 656e  o get the curren
+0001c940: 7420 776f 726b 7370 6163 650a 2020 2020  t workspace.    
+0001c950: 6966 2063 7572 7265 6e74 5f77 733a 0a20  if current_ws:. 
+0001c960: 2020 2020 2020 2023 2046 6f72 6365 2074         # Force t
+0001c970: 6f20 6765 7420 616c 6c20 7468 6520 776f  o get all the wo
+0001c980: 726b 7370 6163 6573 2074 6865 2075 7365  rkspaces the use
+0001c990: 7220 6361 6e20 6163 6365 7373 0a20 2020  r can access.   
+0001c9a0: 2020 2020 2077 6f72 6b73 7061 6365 203d       workspace =
+0001c9b0: 2063 7572 7265 6e74 5f77 730a 2020 2020   current_ws.    
+0001c9c0: 2020 2020 776f 726b 7370 6163 6573 203d      workspaces =
+0001c9d0: 2028 6177 6169 7420 636c 6965 6e74 2e75   (await client.u
+0001c9e0: 7365 725f 776f 726b 7370 6163 6573 2829  ser_workspaces()
+0001c9f0: 292e 6765 7428 2277 6f72 6b73 7061 6365  ).get("workspace
+0001ca00: 7322 2c20 5b5d 290a 2020 2020 656c 7365  s", []).    else
+0001ca10: 3a0a 2020 2020 2020 2020 776f 726b 7370  :.        worksp
+0001ca20: 6163 6520 3d20 6177 6169 7420 636c 6965  ace = await clie
+0001ca30: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
+0001ca40: 655f 6272 616e 6368 6573 2829 0a20 2020  e_branches().   
+0001ca50: 2020 2020 2077 6f72 6b73 7061 6365 7320       workspaces 
+0001ca60: 3d20 776f 726b 7370 6163 652e 6765 7428  = workspace.get(
+0001ca70: 2277 6f72 6b73 7061 6365 7322 2c20 5b5d  "workspaces", []
+0001ca80: 290a 0a20 2020 2069 6620 776f 726b 7370  )..    if worksp
+0001ca90: 6163 652e 6765 7428 2269 735f 6272 616e  ace.get("is_bran
+0001caa0: 6368 222c 2046 616c 7365 293a 0a20 2020  ch", False):.   
+0001cab0: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001cac0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001cad0: 696e 666f 5f73 6b69 7070 696e 675f 7368  info_skipping_sh
+0001cae0: 6172 696e 675f 6461 7461 736f 7572 6365  aring_datasource
+0001caf0: 735f 6272 616e 6368 2864 6174 6173 6f75  s_branch(datasou
+0001cb00: 7263 653d 6461 7461 736f 7572 6365 5b22  rce=datasource["
+0001cb10: 6e61 6d65 225d 2929 0a20 2020 2020 2020  name"])).       
+0001cb20: 2072 6574 7572 6e0a 0a20 2020 2023 2057   return..    # W
+0001cb30: 6520 6475 706c 6963 6174 6520 7468 6520  e duplicate the 
+0001cb40: 636c 6965 6e74 2074 6f20 7573 6520 7468  client to use th
+0001cb50: 6520 7573 6572 5f74 6f6b 656e 0a20 2020  e user_token.   
+0001cb60: 2075 7365 725f 636c 6965 6e74 3a20 5469   user_client: Ti
+0001cb70: 6e79 4220 3d20 6465 6570 636f 7079 2863  nyB = deepcopy(c
+0001cb80: 6c69 656e 7429 0a20 2020 2075 7365 725f  lient).    user_
+0001cb90: 636c 6965 6e74 2e74 6f6b 656e 203d 2075  client.token = u
+0001cba0: 7365 725f 746f 6b65 6e0a 2020 2020 6966  ser_token.    if
+0001cbb0: 206e 6f74 2077 6f72 6b73 7061 6365 735f   not workspaces_
+0001cbc0: 6375 7272 656e 745f 7368 6172 6564 5f77  current_shared_w
+0001cbd0: 6974 683a 0a20 2020 2020 2020 2066 6f72  ith:.        for
+0001cbe0: 2077 6f72 6b73 7061 6365 5f74 6f5f 7368   workspace_to_sh
+0001cbf0: 6172 6520 696e 2077 6f72 6b73 7061 6365  are in workspace
+0001cc00: 735f 746f 5f73 6861 7265 3a0a 2020 2020  s_to_share:.    
+0001cc10: 2020 2020 2020 2020 773a 204f 7074 696f          w: Optio
+0001cc20: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
+0001cc30: 795d 5d20 3d20 6e65 7874 2828 7720 666f  y]] = next((w fo
+0001cc40: 7220 7720 696e 2077 6f72 6b73 7061 6365  r w in workspace
+0001cc50: 7320 6966 2077 5b22 6e61 6d65 225d 203d  s if w["name"] =
+0001cc60: 3d20 776f 726b 7370 6163 655f 746f 5f73  = workspace_to_s
+0001cc70: 6861 7265 292c 204e 6f6e 6529 0a20 2020  hare), None).   
+0001cc80: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001cc90: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
+0001cca0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0001ccb0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0001ccc0: 2020 2020 2020 2020 6622 556e 6162 6c65          f"Unable
+0001ccd0: 2074 6f20 7368 6172 6520 6461 7461 736f   to share dataso
+0001cce0: 7572 6365 2077 6974 6820 7468 6520 776f  urce with the wo
+0001ccf0: 726b 7370 6163 6520 7b77 6f72 6b73 7061  rkspace {workspa
+0001cd00: 6365 5f74 6f5f 7368 6172 657d 2e20 5265  ce_to_share}. Re
+0001cd10: 7669 6577 2074 6861 7420 796f 7520 6861  view that you ha
+0001cd20: 7665 2074 6865 2061 646d 696e 2070 6572  ve the admin per
+0001cd30: 6d69 7373 696f 6e73 206f 6e20 7468 6973  missions on this
+0001cd40: 2077 6f72 6b73 7061 6365 220a 2020 2020   workspace".    
+0001cd50: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0001cd60: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001cd70: 2075 7365 725f 636c 6965 6e74 2e64 6174   user_client.dat
+0001cd80: 6173 6f75 7263 655f 7368 6172 6528 0a20  asource_share(. 
+0001cd90: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001cda0: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
+0001cdb0: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
+0001cdc0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001cdd0: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
+0001cde0: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
+0001cdf0: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
+0001ce00: 2020 2020 2020 2020 2020 6465 7374 696e            destin
+0001ce10: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
+0001ce20: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
+0001ce30: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001ce40: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0001ce50: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
+0001ce60: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001ce70: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+0001ce80: 735f 6461 7461 736f 7572 6365 5f73 6861  s_datasource_sha
+0001ce90: 7265 6428 6461 7461 736f 7572 6365 3d64  red(datasource=d
+0001cea0: 6174 6173 6f75 7263 655f 6e61 6d65 2c20  atasource_name, 
+0001ceb0: 776f 726b 7370 6163 653d 772e 6765 7428  workspace=w.get(
+0001cec0: 226e 616d 6522 2c20 2222 2929 0a20 2020  "name", "")).   
+0001ced0: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
+0001cee0: 6c73 653a 0a20 2020 2020 2020 2073 6861  lse:.        sha
+0001cef0: 7265 645f 7769 7468 203d 205b 0a20 2020  red_with = [.   
+0001cf00: 2020 2020 2020 2020 2077 0a20 2020 2020           w.     
+0001cf10: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0001cf20: 776f 726b 7370 6163 6573 0a20 2020 2020  workspaces.     
+0001cf30: 2020 2020 2020 2069 6620 6e65 7874 2828         if next((
+0001cf40: 7773 2066 6f72 2077 7320 696e 2077 6f72  ws for ws in wor
+0001cf50: 6b73 7061 6365 735f 6375 7272 656e 745f  kspaces_current_
+0001cf60: 7368 6172 6564 5f77 6974 6820 6966 2077  shared_with if w
+0001cf70: 7320 3d3d 2077 5b22 6964 225d 206f 7220  s == w["id"] or 
+0001cf80: 7773 203d 3d20 775b 226e 616d 6522 5d29  ws == w["name"])
+0001cf90: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+0001cfa0: 5d0a 2020 2020 2020 2020 6465 6669 6e65  ].        define
+0001cfb0: 645f 746f 5f73 6861 7265 5f77 6974 6820  d_to_share_with 
+0001cfc0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001cfd0: 7720 666f 7220 7720 696e 2077 6f72 6b73  w for w in works
+0001cfe0: 7061 6365 7320 6966 206e 6578 7428 2877  paces if next((w
+0001cff0: 7320 666f 7220 7773 2069 6e20 776f 726b  s for ws in work
+0001d000: 7370 6163 6573 5f74 6f5f 7368 6172 6520  spaces_to_share 
+0001d010: 6966 2077 7320 3d3d 2077 5b22 6964 225d  if ws == w["id"]
+0001d020: 206f 7220 7773 203d 3d20 775b 226e 616d   or ws == w["nam
+0001d030: 6522 5d29 2c20 4e6f 6e65 290a 2020 2020  e"]), None).    
+0001d040: 2020 2020 5d0a 2020 2020 2020 2020 776f      ].        wo
+0001d050: 726b 7370 6163 6573 5f6e 6565 645f 746f  rkspaces_need_to
+0001d060: 5f73 6861 7265 203d 205b 7720 666f 7220  _share = [w for 
+0001d070: 7720 696e 2064 6566 696e 6564 5f74 6f5f  w in defined_to_
+0001d080: 7368 6172 655f 7769 7468 2069 6620 7720  share_with if w 
+0001d090: 6e6f 7420 696e 2073 6861 7265 645f 7769  not in shared_wi
+0001d0a0: 7468 5d0a 2020 2020 2020 2020 776f 726b  th].        work
+0001d0b0: 7370 6163 6573 5f6e 6565 645f 746f 5f75  spaces_need_to_u
+0001d0c0: 6e73 6861 7265 203d 205b 7720 666f 7220  nshare = [w for 
+0001d0d0: 7720 696e 2073 6861 7265 645f 7769 7468  w in shared_with
+0001d0e0: 2069 6620 7720 6e6f 7420 696e 2064 6566   if w not in def
+0001d0f0: 696e 6564 5f74 6f5f 7368 6172 655f 7769  ined_to_share_wi
+0001d100: 7468 5d0a 0a20 2020 2020 2020 2066 6f72  th]..        for
+0001d110: 2077 2069 6e20 776f 726b 7370 6163 6573   w in workspaces
+0001d120: 5f6e 6565 645f 746f 5f73 6861 7265 3a0a  _need_to_share:.
+0001d130: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001d140: 7420 7573 6572 5f63 6c69 656e 742e 6461  t user_client.da
+0001d150: 7461 736f 7572 6365 5f73 6861 7265 280a  tasource_share(.
+0001d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d170: 6461 7461 736f 7572 6365 5f69 643d 6461  datasource_id=da
+0001d180: 7461 736f 7572 6365 5f69 642c 0a20 2020  tasource_id,.   
+0001d190: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+0001d1a0: 7265 6e74 5f77 6f72 6b73 7061 6365 5f69  rent_workspace_i
+0001d1b0: 643d 776f 726b 7370 6163 652e 6765 7428  d=workspace.get(
+0001d1c0: 2269 6422 2c20 2222 292c 0a20 2020 2020  "id", ""),.     
+0001d1d0: 2020 2020 2020 2020 2020 2064 6573 7469             desti
+0001d1e0: 6e61 7469 6f6e 5f77 6f72 6b73 7061 6365  nation_workspace
+0001d1f0: 5f69 643d 772e 6765 7428 2269 6422 2c20  _id=w.get("id", 
+0001d200: 2222 292c 0a20 2020 2020 2020 2020 2020  ""),.           
+0001d210: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
+0001d220: 6c69 636b 2e65 6368 6f28 0a20 2020 2020  lick.echo(.     
+0001d230: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
+0001d240: 6163 6b4d 616e 6167 6572 2e73 7563 6365  ackManager.succe
+0001d250: 7373 5f64 6174 6173 6f75 7263 655f 7368  ss_datasource_sh
+0001d260: 6172 6564 2864 6174 6173 6f75 7263 653d  ared(datasource=
+0001d270: 6461 7461 736f 7572 6365 5b22 6e61 6d65  datasource["name
+0001d280: 225d 2c20 776f 726b 7370 6163 653d 772e  "], workspace=w.
+0001d290: 6765 7428 226e 616d 6522 2c20 2222 2929  get("name", ""))
+0001d2a0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0001d2b0: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
+0001d2c0: 2077 6f72 6b73 7061 6365 735f 6e65 6564   workspaces_need
+0001d2d0: 5f74 6f5f 756e 7368 6172 653a 0a20 2020  _to_unshare:.   
+0001d2e0: 2020 2020 2020 2020 2061 7761 6974 2075           await u
+0001d2f0: 7365 725f 636c 6965 6e74 2e64 6174 6173  ser_client.datas
+0001d300: 6f75 7263 655f 756e 7368 6172 6528 0a20  ource_unshare(. 
+0001d310: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001d320: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
+0001d330: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
+0001d340: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001d350: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
+0001d360: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
+0001d370: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
+0001d380: 2020 2020 2020 2020 2020 6465 7374 696e            destin
+0001d390: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
+0001d3a0: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
+0001d3b0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001d3c0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0001d3d0: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
+0001d3e0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001d3f0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+0001d400: 735f 6461 7461 736f 7572 6365 5f75 6e73  s_datasource_uns
+0001d410: 6861 7265 6428 6461 7461 736f 7572 6365  hared(datasource
+0001d420: 3d64 6174 6173 6f75 7263 655f 6e61 6d65  =datasource_name
+0001d430: 2c20 776f 726b 7370 6163 653d 772e 6765  , workspace=w.ge
+0001d440: 7428 226e 616d 6522 2c20 2222 2929 0a20  t("name", "")). 
+0001d450: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+0001d460: 7379 6e63 2064 6566 206e 6577 5f64 7328  sync def new_ds(
+0001d470: 0a20 2020 2064 733a 2044 6963 745b 7374  .    ds: Dict[st
+0001d480: 722c 2041 6e79 5d2c 0a20 2020 2063 6c69  r, Any],.    cli
+0001d490: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
+0001d4a0: 7573 6572 5f74 6f6b 656e 3a20 4f70 7469  user_token: Opti
+0001d4b0: 6f6e 616c 5b73 7472 5d2c 0a20 2020 2066  onal[str],.    f
+0001d4c0: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
+0001d4d0: 7365 2c0a 2020 2020 736b 6970 5f63 6f6e  se,.    skip_con
+0001d4e0: 6669 726d 6174 696f 6e3a 2062 6f6f 6c20  firmation: bool 
+0001d4f0: 3d20 4661 6c73 652c 0a20 2020 2063 7572  = False,.    cur
+0001d500: 7265 6e74 5f77 733d 4e6f 6e65 2c0a 2020  rent_ws=None,.  
+0001d510: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
+0001d520: 6d3a 204f 7074 696f 6e61 6c5b 626f 6f6c  m: Optional[bool
+0001d530: 5d20 3d20 4661 6c73 652c 0a20 2020 2066  ] = False,.    f
+0001d540: 6f72 6b3a 204f 7074 696f 6e61 6c5b 626f  ork: Optional[bo
+0001d550: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+0001d560: 2067 6974 5f72 656c 6561 7365 3a20 4f70   git_release: Op
+0001d570: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
+0001d580: 616c 7365 2c0a 293a 0a20 2020 2064 735f  alse,.):.    ds_
+0001d590: 6e61 6d65 203d 2064 735b 2270 6172 616d  name = ds["param
+0001d5a0: 7322 5d5b 226e 616d 6522 5d0a 0a20 2020  s"]["name"]..   
+0001d5b0: 2061 7379 6e63 2064 6566 206d 616e 6167   async def manag
+0001d5c0: 655f 746f 6b65 6e73 2829 3a0a 2020 2020  e_tokens():.    
+0001d5d0: 2020 2020 2320 7365 6172 6368 2066 6f72      # search for
+0001d5e0: 2074 6f6b 656e 2077 6974 6820 7370 6563   token with spec
+0001d5f0: 6966 6965 6420 6e61 6d65 2061 6e64 2061  ified name and a
+0001d600: 6464 7320 6974 2069 6620 6e6f 7420 666f  dds it if not fo
+0001d610: 756e 6420 6f72 2061 6464 7320 7065 726d  und or adds perm
+0001d620: 6973 7369 6f6e 7320 746f 2069 740a 2020  issions to it.  
+0001d630: 2020 2020 2020 7420 3d20 4e6f 6e65 0a20        t = None. 
+0001d640: 2020 2020 2020 2066 6f72 2074 6b20 696e         for tk in
+0001d650: 2064 735b 2274 6f6b 656e 7322 5d3a 0a20   ds["tokens"]:. 
+0001d660: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0001d670: 5f6e 616d 6520 3d20 746b 5b22 746f 6b65  _name = tk["toke
+0001d680: 6e5f 6e61 6d65 225d 0a20 2020 2020 2020  n_name"].       
+0001d690: 2020 2020 2074 203d 2061 7761 6974 2063       t = await c
+0001d6a0: 6c69 656e 742e 6765 745f 746f 6b65 6e5f  lient.get_token_
+0001d6b0: 6279 5f6e 616d 6528 746f 6b65 6e5f 6e61  by_name(token_na
+0001d6c0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0001d6d0: 6966 206e 6f74 2074 3a0a 2020 2020 2020  if not t:.      
+0001d6e0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0001d6f0: 6e61 6d65 203d 2074 6b5b 2274 6f6b 656e  name = tk["token
+0001d700: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
+0001d710: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
+0001d720: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
+0001d730: 6572 2e69 6e66 6f5f 6372 6561 7465 5f6e  er.info_create_n
+0001d740: 6f74 5f66 6f75 6e64 5f74 6f6b 656e 2874  ot_found_token(t
+0001d750: 6f6b 656e 3d74 6f6b 656e 5f6e 616d 6529  oken=token_name)
+0001d760: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d770: 2020 2320 4453 203d 3d20 746f 6b65 6e5f    # DS == token_
+0001d780: 6f72 6967 696e 2e4f 7269 6769 6e73 2e44  origin.Origins.D
+0001d790: 4154 4153 4f55 5243 450a 2020 2020 2020  ATASOURCE.      
+0001d7a0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0001d7b0: 636c 6965 6e74 2e63 7265 6174 655f 746f  client.create_to
+0001d7c0: 6b65 6e28 746f 6b65 6e5f 6e61 6d65 2c20  ken(token_name, 
+0001d7d0: 6622 4441 5441 534f 5552 4345 533a 7b74  f"DATASOURCES:{t
+0001d7e0: 6b5b 2770 6572 6d69 7373 696f 6e73 275d  k['permissions']
+0001d7f0: 7d3a 7b64 735f 6e61 6d65 7d22 2c20 2244  }:{ds_name}", "D
+0001d800: 5322 2c20 6473 5f6e 616d 6529 0a20 2020  S", ds_name).   
+0001d810: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001d820: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001d830: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+0001d840: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
+0001d850: 7265 6174 655f 666f 756e 645f 746f 6b65  reate_found_toke
+0001d860: 6e28 746f 6b65 6e3d 746f 6b65 6e5f 6e61  n(token=token_na
+0001d870: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
+0001d880: 2020 2020 2073 636f 7065 7320 3d20 5b66       scopes = [f
+0001d890: 2244 4154 4153 4f55 5243 4553 3a7b 746b  "DATASOURCES:{tk
+0001d8a0: 5b27 7065 726d 6973 7369 6f6e 7327 5d7d  ['permissions']}
+0001d8b0: 3a7b 6473 5f6e 616d 657d 225d 0a20 2020  :{ds_name}"].   
+0001d8c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001d8d0: 2078 2069 6e20 745b 2273 636f 7065 7322   x in t["scopes"
+0001d8e0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0001d8f0: 2020 2020 2020 2073 6320 3d20 785b 2274         sc = x["t
+0001d900: 7970 6522 5d20 6966 2022 7265 736f 7572  ype"] if "resour
+0001d910: 6365 2220 6e6f 7420 696e 2078 2065 6c73  ce" not in x els
+0001d920: 6520 6622 7b78 5b27 7479 7065 275d 7d3a  e f"{x['type']}:
+0001d930: 7b78 5b27 7265 736f 7572 6365 275d 7d22  {x['resource']}"
+0001d940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d950: 2020 2020 2073 636f 7065 732e 6170 7065       scopes.appe
+0001d960: 6e64 2873 6329 0a20 2020 2020 2020 2020  nd(sc).         
+0001d970: 2020 2020 2020 2061 7761 6974 2063 6c69         await cli
+0001d980: 656e 742e 616c 7465 725f 746f 6b65 6e73  ent.alter_tokens
+0001d990: 2874 6f6b 656e 5f6e 616d 652c 2073 636f  (token_name, sco
+0001d9a0: 7065 7329 0a0a 2020 2020 7472 793a 0a20  pes)..    try:. 
+0001d9b0: 2020 2020 2020 2065 7869 7374 696e 675f         existing_
+0001d9c0: 6473 203d 2061 7761 6974 2063 6c69 656e  ds = await clien
+0001d9d0: 742e 6765 745f 6461 7461 736f 7572 6365  t.get_datasource
+0001d9e0: 2864 735f 6e61 6d65 290a 2020 2020 2020  (ds_name).      
+0001d9f0: 2020 6461 7461 736f 7572 6365 5f65 7869    datasource_exi
+0001da00: 7374 7320 3d20 5472 7565 0a20 2020 2065  sts = True.    e
+0001da10: 7863 6570 7420 446f 6573 4e6f 7445 7869  xcept DoesNotExi
+0001da20: 7374 4578 6365 7074 696f 6e3a 0a20 2020  stException:.   
+0001da30: 2020 2020 2064 6174 6173 6f75 7263 655f       datasource_
+0001da40: 6578 6973 7473 203d 2046 616c 7365 0a0a  exists = False..
+0001da50: 2020 2020 6966 2064 735b 2270 6172 616d      if ds["param
+0001da60: 7322 5d2e 6765 7428 2265 6e67 696e 6522  s"].get("engine"
+0001da70: 2c20 2222 292e 6c6f 7765 7228 2920 3d3d  , "").lower() ==
+0001da80: 2022 6a6f 696e 223a 0a20 2020 2020 2020   "join":.       
+0001da90: 2064 6570 7265 6361 7469 6f6e 5f6e 6f74   deprecation_not
+0001daa0: 6963 6520 3d20 4665 6564 6261 636b 4d61  ice = FeedbackMa
+0001dab0: 6e61 6765 722e 7761 726e 696e 675f 6465  nager.warning_de
+0001dac0: 7072 6563 6174 6564 280a 2020 2020 2020  precated(.      
+0001dad0: 2020 2020 2020 7761 726e 696e 673d 2244        warning="D
+0001dae0: 6174 6120 536f 7572 6365 7320 7769 7468  ata Sources with
+0001daf0: 204a 6f69 6e20 656e 6769 6e65 2061 7265   Join engine are
+0001db00: 2064 6570 7265 6361 7465 6420 616e 6420   deprecated and 
+0001db10: 7769 6c6c 2062 6520 7265 6d6f 7665 6420  will be removed 
+0001db20: 696e 2074 6865 206e 6578 7420 6d61 6a6f  in the next majo
+0001db30: 7220 7265 6c65 6173 6520 6f66 2074 696e  r release of tin
+0001db40: 7962 6972 642d 636c 692e 2055 7365 204d  ybird-cli. Use M
+0001db50: 6572 6765 5472 6565 2069 6e73 7465 6164  ergeTree instead
+0001db60: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0001db70: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001db80: 6465 7072 6563 6174 696f 6e5f 6e6f 7469  deprecation_noti
+0001db90: 6365 290a 0a20 2020 2069 6620 6e6f 7420  ce)..    if not 
+0001dba0: 6461 7461 736f 7572 6365 5f65 7869 7374  datasource_exist
+0001dbb0: 7320 6f72 2066 6f72 6b5f 646f 776e 7374  s or fork_downst
+0001dbc0: 7265 616d 206f 7220 666f 726b 3a0a 2020  ream or fork:.  
+0001dbd0: 2020 2020 2020 7061 7261 6d73 203d 2064        params = d
+0001dbe0: 735b 2270 6172 616d 7322 5d0a 2020 2020  s["params"].    
+0001dbf0: 2020 2020 7061 7261 6d73 5b22 6272 616e      params["bran
+0001dc00: 6368 5f6d 6f64 6522 5d20 3d20 2266 6f72  ch_mode"] = "for
+0001dc10: 6b22 2069 6620 666f 726b 5f64 6f77 6e73  k" if fork_downs
+0001dc20: 7472 6561 6d20 6f72 2066 6f72 6b20 656c  tream or fork el
+0001dc30: 7365 2022 4e6f 6e65 220a 0a20 2020 2020  se "None"..     
+0001dc40: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001dc50: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+0001dc60: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+0001dc70: 6765 7428 2273 6572 7669 6365 2229 2069  get("service") i
+0001dc80: 6e20 5052 4556 4945 575f 434f 4e4e 4543  n PREVIEW_CONNEC
+0001dc90: 544f 525f 5345 5256 4943 4553 0a20 2020  TOR_SERVICES.   
+0001dca0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+0001dcb0: 2070 6172 616d 732e 6765 7428 2263 6f6e   params.get("con
+0001dcc0: 6e65 6374 6f72 2229 0a20 2020 2020 2020  nector").       
+0001dcd0: 2020 2020 2020 2020 2061 6e64 2070 6172           and par
+0001dce0: 616d 732e 6765 7428 2262 7563 6b65 745f  ams.get("bucket_
+0001dcf0: 7572 6922 290a 2020 2020 2020 2020 2020  uri").          
+0001dd00: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0001dd10: 2020 2020 2064 6174 6120 3d20 6177 6169       data = awai
+0001dd20: 7420 636c 6965 6e74 2e70 7265 7669 6577  t client.preview
+0001dd30: 5f62 7563 6b65 7428 7061 7261 6d73 5b22  _bucket(params["
+0001dd40: 636f 6e6e 6563 746f 7222 5d2c 2070 6172  connector"], par
+0001dd50: 616d 735b 2262 7563 6b65 745f 7572 6922  ams["bucket_uri"
+0001dd60: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0001dd70: 2020 2069 6620 6461 7461 3a0a 2020 2020     if data:.    
+0001dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd90: 6669 6c65 7320 3d20 6461 7461 2e67 6574  files = data.get
+0001dda0: 2822 6669 6c65 7322 2c20 5b5d 290a 2020  ("files", []).  
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddc0: 2020 6966 206c 656e 2866 696c 6573 2920    if len(files) 
+0001ddd0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0001dde0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0001ddf0: 655f 6e61 6d65 203d 2066 696c 6573 5b30  e_name = files[0
+0001de00: 5d2e 6765 7428 226e 616d 6522 2c20 2222  ].get("name", ""
+0001de10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001de20: 2020 2020 2020 2020 2020 6578 7465 6e73            extens
+0001de30: 696f 6e20 3d20 6669 6c65 5f6e 616d 652e  ion = file_name.
+0001de40: 7370 6c69 7428 222e 2229 5b2d 315d 0a20  split(".")[-1]. 
+0001de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de60: 2020 2020 2020 2076 616c 6964 5f66 6f72         valid_for
+0001de70: 6d61 7473 203d 205b 2263 7376 222c 2022  mats = ["csv", "
+0001de80: 6e64 6a73 6f6e 222c 2022 7061 7271 7565  ndjson", "parque
+0001de90: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
+0001dea0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0001deb0: 7874 656e 7369 6f6e 206e 6f74 2069 6e20  xtension not in 
+0001dec0: 7661 6c69 645f 666f 726d 6174 733a 0a20  valid_formats:. 
+0001ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dee0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001def0: 2045 7863 6570 7469 6f6e 280a 2020 2020   Exception(.    
+0001df00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df10: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
+0001df20: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0001df30: 725f 666f 726d 6174 2865 7874 656e 7369  r_format(extensi
+0001df40: 6f6e 3d65 7874 656e 7369 6f6e 2c20 7661  on=extension, va
+0001df50: 6c69 645f 666f 726d 6174 733d 7661 6c69  lid_formats=vali
+0001df60: 645f 666f 726d 6174 7329 0a20 2020 2020  d_formats).     
+0001df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dfa0: 2070 6172 616d 735b 2266 6f72 6d61 7422   params["format"
+0001dfb0: 5d20 3d20 6578 7465 6e73 696f 6e0a 0a20  ] = extension.. 
+0001dfc0: 2020 2020 2020 2020 2020 2064 6174 6173             datas
+0001dfd0: 6f75 7263 6520 3d20 2861 7761 6974 2063  ource = (await c
+0001dfe0: 6c69 656e 742e 6461 7461 736f 7572 6365  lient.datasource
+0001dff0: 5f63 7265 6174 655f 6672 6f6d 5f64 6566  _create_from_def
+0001e000: 696e 6974 696f 6e28 7061 7261 6d73 2929  inition(params))
+0001e010: 2e67 6574 2822 6461 7461 736f 7572 6365  .get("datasource
+0001e020: 222c 207b 7d29 0a20 2020 2020 2020 2020  ", {}).         
+0001e030: 2020 2069 6620 2274 6f6b 656e 7322 2069     if "tokens" i
+0001e040: 6e20 6473 2061 6e64 2064 735b 2274 6f6b  n ds and ds["tok
+0001e050: 656e 7322 5d3a 0a20 2020 2020 2020 2020  ens"]:.         
+0001e060: 2020 2020 2020 2061 7761 6974 206d 616e         await man
+0001e070: 6167 655f 746f 6b65 6e73 2829 0a0a 2020  age_tokens()..  
+0001e080: 2020 2020 2020 2020 2020 6966 2022 7368            if "sh
+0001e090: 6172 6564 5f77 6974 6822 2069 6e20 6473  ared_with" in ds
+0001e0a0: 2061 6e64 2064 735b 2273 6861 7265 645f   and ds["shared_
+0001e0b0: 7769 7468 225d 3a0a 2020 2020 2020 2020  with"]:.        
+0001e0c0: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
+0001e0d0: 7365 725f 746f 6b65 6e3a 0a20 2020 2020  ser_token:.     
+0001e0e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001e0f0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+0001e100: 636b 4d61 6e61 6765 722e 696e 666f 5f73  ckManager.info_s
+0001e110: 6b69 7070 696e 675f 7368 6172 6564 5f77  kipping_shared_w
+0001e120: 6974 685f 656e 7472 7928 2929 0a20 2020  ith_entry()).   
+0001e130: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0001e140: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001e150: 2020 2020 2020 2061 7761 6974 2073 6861         await sha
+0001e160: 7265 5f61 6e64 5f75 6e73 6861 7265 5f64  re_and_unshare_d
+0001e170: 6174 6173 6f75 7263 6528 0a20 2020 2020  atasource(.     
+0001e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e190: 2020 2063 6c69 656e 742c 0a20 2020 2020     client,.     
+0001e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1b0: 2020 2064 6174 6173 6f75 7263 652c 0a20     datasource,. 
+0001e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1d0: 2020 2020 2020 2075 7365 725f 746f 6b65         user_toke
+0001e1e0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0001e1f0: 2020 2020 2020 2020 2020 2077 6f72 6b73             works
+0001e200: 7061 6365 735f 6375 7272 656e 745f 7368  paces_current_sh
+0001e210: 6172 6564 5f77 6974 683d 5b5d 2c0a 2020  ared_with=[],.  
+0001e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e230: 2020 2020 2020 776f 726b 7370 6163 6573        workspaces
+0001e240: 5f74 6f5f 7368 6172 653d 6473 5b22 7368  _to_share=ds["sh
+0001e250: 6172 6564 5f77 6974 6822 5d2c 0a20 2020  ared_with"],.   
+0001e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e270: 2020 2020 2063 7572 7265 6e74 5f77 733d       current_ws=
+0001e280: 6375 7272 656e 745f 7773 2c0a 2020 2020  current_ws,.    
 0001e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e2a0: 6461 7461 203d 2061 7761 6974 2063 6c69  data = await cli
-0001e2b0: 656e 742e 7072 6576 6965 775f 6275 636b  ent.preview_buck
-0001e2c0: 6574 2870 6172 616d 735b 2263 6f6e 6e65  et(params["conne
-0001e2d0: 6374 6f72 225d 2c20 7061 7261 6d73 5b22  ctor"], params["
-0001e2e0: 6275 636b 6574 5f75 7269 225d 290a 2020  bucket_uri"]).  
-0001e2f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001e300: 2064 6174 613a 0a20 2020 2020 2020 2020   data:.         
-0001e310: 2020 2020 2020 2020 2020 2066 696c 6573             files
-0001e320: 203d 2064 6174 612e 6765 7428 2266 696c   = data.get("fil
-0001e330: 6573 222c 205b 5d29 0a20 2020 2020 2020  es", []).       
-0001e340: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001e350: 6c65 6e28 6669 6c65 7329 203e 2030 3a0a  len(files) > 0:.
-0001e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e370: 2020 2020 2020 2020 6669 6c65 5f6e 616d          file_nam
-0001e380: 6520 3d20 6669 6c65 735b 305d 2e67 6574  e = files[0].get
-0001e390: 2822 6e61 6d65 222c 2022 2229 0a20 2020  ("name", "").   
-0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3b0: 2020 2020 2065 7874 656e 7369 6f6e 203d       extension =
-0001e3c0: 2066 696c 655f 6e61 6d65 2e73 706c 6974   file_name.split
-0001e3d0: 2822 2e22 295b 2d31 5d0a 2020 2020 2020  (".")[-1].      
-0001e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3f0: 2020 7661 6c69 645f 666f 726d 6174 7320    valid_formats 
-0001e400: 3d20 5b22 6373 7622 2c20 226e 646a 736f  = ["csv", "ndjso
-0001e410: 6e22 2c20 2270 6172 7175 6574 225d 0a20  n", "parquet"]. 
-0001e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e430: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
-0001e440: 696f 6e20 6e6f 7420 696e 2076 616c 6964  ion not in valid
-0001e450: 5f66 6f72 6d61 7473 3a0a 2020 2020 2020  _formats:.      
-0001e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e470: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0001e480: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-0001e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4a0: 2020 2020 2020 2046 6565 6462 6163 6b4d         FeedbackM
-0001e4b0: 616e 6167 6572 2e65 7272 6f72 5f66 6f72  anager.error_for
-0001e4c0: 6d61 7428 6578 7465 6e73 696f 6e3d 6578  mat(extension=ex
-0001e4d0: 7465 6e73 696f 6e2c 2076 616c 6964 5f66  tension, valid_f
-0001e4e0: 6f72 6d61 7473 3d76 616c 6964 5f66 6f72  ormats=valid_for
-0001e4f0: 6d61 7473 290a 2020 2020 2020 2020 2020  mats).          
-0001e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e510: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001e520: 2020 2020 2020 2020 2020 2020 7061 7261              para
-0001e530: 6d73 5b22 666f 726d 6174 225d 203d 2065  ms["format"] = e
-0001e540: 7874 656e 7369 6f6e 0a0a 2020 2020 2020  xtension..      
-0001e550: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-0001e560: 203d 2028 6177 6169 7420 636c 6965 6e74   = (await client
-0001e570: 2e64 6174 6173 6f75 7263 655f 6372 6561  .datasource_crea
-0001e580: 7465 5f66 726f 6d5f 6465 6669 6e69 7469  te_from_definiti
-0001e590: 6f6e 2870 6172 616d 7329 292e 6765 7428  on(params)).get(
-0001e5a0: 2264 6174 6173 6f75 7263 6522 2c20 7b7d  "datasource", {}
-0001e5b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001e5c0: 2022 746f 6b65 6e73 2220 696e 2064 7320   "tokens" in ds 
-0001e5d0: 616e 6420 6473 5b22 746f 6b65 6e73 225d  and ds["tokens"]
-0001e5e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e5f0: 2020 6177 6169 7420 6d61 6e61 6765 5f74    await manage_t
-0001e600: 6f6b 656e 7328 290a 0a20 2020 2020 2020  okens()..       
-0001e610: 2020 2020 2069 6620 2273 6861 7265 645f       if "shared_
-0001e620: 7769 7468 2220 696e 2064 7320 616e 6420  with" in ds and 
-0001e630: 6473 5b22 7368 6172 6564 5f77 6974 6822  ds["shared_with"
-0001e640: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001e650: 2020 2069 6620 6e6f 7420 7573 6572 5f74     if not user_t
-0001e660: 6f6b 656e 3a0a 2020 2020 2020 2020 2020  oken:.          
-0001e670: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0001e680: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-0001e690: 6167 6572 2e69 6e66 6f5f 736b 6970 7069  ager.info_skippi
-0001e6a0: 6e67 5f73 6861 7265 645f 7769 7468 5f65  ng_shared_with_e
-0001e6b0: 6e74 7279 2829 290a 2020 2020 2020 2020  ntry()).        
-0001e6c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6e0: 2020 6177 6169 7420 7368 6172 655f 616e    await share_an
-0001e6f0: 645f 756e 7368 6172 655f 6461 7461 736f  d_unshare_dataso
-0001e700: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-0001e710: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0001e720: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-0001e730: 2020 2020 2020 2020 2020 2020 2020 6461                da
-0001e740: 7461 736f 7572 6365 2c0a 2020 2020 2020  tasource,.      
-0001e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e760: 2020 7573 6572 5f74 6f6b 656e 2c0a 2020    user_token,.  
-0001e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e780: 2020 2020 2020 776f 726b 7370 6163 6573        workspaces
-0001e790: 5f63 7572 7265 6e74 5f73 6861 7265 645f  _current_shared_
-0001e7a0: 7769 7468 3d5b 5d2c 0a20 2020 2020 2020  with=[],.       
-0001e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7c0: 2077 6f72 6b73 7061 6365 735f 746f 5f73   workspaces_to_s
-0001e7d0: 6861 7265 3d64 735b 2273 6861 7265 645f  hare=ds["shared_
-0001e7e0: 7769 7468 225d 2c0a 2020 2020 2020 2020  with"],.        
-0001e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e800: 6375 7272 656e 745f 7773 3d63 7572 7265  current_ws=curre
-0001e810: 6e74 5f77 732c 0a20 2020 2020 2020 2020  nt_ws,.         
-0001e820: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001e830: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0001e840: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-0001e850: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
-0001e860: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
-0001e870: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
-0001e880: 6765 722e 6572 726f 725f 6372 6561 7469  ger.error_creati
-0001e890: 6e67 5f64 6174 6173 6f75 7263 6528 6572  ng_datasource(er
-0001e8a0: 726f 723d 7374 7228 6529 2929 0a20 2020  ror=str(e))).   
-0001e8b0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001e8c0: 2069 6620 6e6f 7420 666f 7263 653a 0a20   if not force:. 
-0001e8d0: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
-0001e8e0: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
-0001e8f0: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-0001e900: 722e 6572 726f 725f 6461 7461 736f 7572  r.error_datasour
-0001e910: 6365 5f61 6c72 6561 6479 5f65 7869 7374  ce_already_exist
-0001e920: 7328 6461 7461 736f 7572 6365 3d64 735f  s(datasource=ds_
-0001e930: 6e61 6d65 2929 0a0a 2020 2020 6966 2064  name))..    if d
-0001e940: 732e 6765 7428 2273 6861 7265 645f 7769  s.get("shared_wi
-0001e950: 7468 222c 205b 5d29 206f 7220 6578 6973  th", []) or exis
-0001e960: 7469 6e67 5f64 732e 6765 7428 2273 6861  ting_ds.get("sha
-0001e970: 7265 645f 7769 7468 222c 205b 5d29 3a0a  red_with", []):.
-0001e980: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
-0001e990: 7365 725f 746f 6b65 6e3a 0a20 2020 2020  ser_token:.     
-0001e9a0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-0001e9b0: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-0001e9c0: 722e 696e 666f 5f73 6b69 7070 696e 675f  r.info_skipping_
-0001e9d0: 7368 6172 6564 5f77 6974 685f 656e 7472  shared_with_entr
-0001e9e0: 7928 2929 0a20 2020 2020 2020 2065 6c73  y()).        els
-0001e9f0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-0001ea00: 7761 6974 2073 6861 7265 5f61 6e64 5f75  wait share_and_u
-0001ea10: 6e73 6861 7265 5f64 6174 6173 6f75 7263  nshare_datasourc
-0001ea20: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001ea30: 2020 2063 6c69 656e 742c 0a20 2020 2020     client,.     
-0001ea40: 2020 2020 2020 2020 2020 2065 7869 7374             exist
-0001ea50: 696e 675f 6473 2c0a 2020 2020 2020 2020  ing_ds,.        
-0001ea60: 2020 2020 2020 2020 7573 6572 5f74 6f6b          user_tok
-0001ea70: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
-0001ea80: 2020 2020 6578 6973 7469 6e67 5f64 732e      existing_ds.
-0001ea90: 6765 7428 2273 6861 7265 645f 7769 7468  get("shared_with
-0001eaa0: 222c 205b 5d29 2c0a 2020 2020 2020 2020  ", []),.        
-0001eab0: 2020 2020 2020 2020 6473 2e67 6574 2822          ds.get("
-0001eac0: 7368 6172 6564 5f77 6974 6822 2c20 5b5d  shared_with", []
-0001ead0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001eae0: 2020 2063 7572 7265 6e74 5f77 732c 0a20     current_ws,. 
-0001eaf0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001eb00: 2020 616c 7465 725f 7265 7370 6f6e 7365    alter_response
-0001eb10: 203d 204e 6f6e 650a 2020 2020 616c 7465   = None.    alte
-0001eb20: 725f 6572 726f 725f 6d65 7373 6167 6520  r_error_message 
-0001eb30: 3d20 4e6f 6e65 0a20 2020 206e 6577 5f64  = None.    new_d
-0001eb40: 6573 6372 6970 7469 6f6e 203d 204e 6f6e  escription = Non
-0001eb50: 650a 2020 2020 6e65 775f 7363 6865 6d61  e.    new_schema
-0001eb60: 203d 204e 6f6e 650a 2020 2020 6e65 775f   = None.    new_
-0001eb70: 696e 6469 6365 7320 3d20 4e6f 6e65 0a20  indices = None. 
-0001eb80: 2020 206e 6577 5f74 746c 203d 204e 6f6e     new_ttl = Non
-0001eb90: 650a 0a20 2020 2074 7279 3a0a 2020 2020  e..    try:.    
-0001eba0: 2020 2020 6966 2064 6174 6173 6f75 7263      if datasourc
-0001ebb0: 655f 6578 6973 7473 2061 6e64 2064 735b  e_exists and ds[
-0001ebc0: 2270 6172 616d 7322 5d5b 2264 6573 6372  "params"]["descr
-0001ebd0: 6970 7469 6f6e 225d 2021 3d20 6578 6973  iption"] != exis
-0001ebe0: 7469 6e67 5f64 735b 2264 6573 6372 6970  ting_ds["descrip
-0001ebf0: 7469 6f6e 225d 3a0a 2020 2020 2020 2020  tion"]:.        
-0001ec00: 2020 2020 6e65 775f 6465 7363 7269 7074      new_descript
-0001ec10: 696f 6e20 3d20 6473 5b22 7061 7261 6d73  ion = ds["params
-0001ec20: 225d 5b22 6465 7363 7269 7074 696f 6e22  "]["description"
-0001ec30: 5d0a 0a20 2020 2020 2020 2069 6620 6461  ]..        if da
-0001ec40: 7461 736f 7572 6365 5f65 7869 7374 7320  tasource_exists 
-0001ec50: 616e 6420 6473 5b22 7061 7261 6d73 225d  and ds["params"]
-0001ec60: 2e67 6574 2822 656e 6769 6e65 5f74 746c  .get("engine_ttl
-0001ec70: 2229 2021 3d20 6578 6973 7469 6e67 5f64  ") != existing_d
-0001ec80: 735b 2265 6e67 696e 6522 5d2e 6765 7428  s["engine"].get(
-0001ec90: 2274 746c 2229 3a0a 2020 2020 2020 2020  "ttl"):.        
-0001eca0: 2020 2020 6e65 775f 7474 6c20 3d20 6473      new_ttl = ds
-0001ecb0: 5b22 7061 7261 6d73 225d 2e67 6574 2822  ["params"].get("
-0001ecc0: 656e 6769 6e65 5f74 746c 222c 2022 6661  engine_ttl", "fa
-0001ecd0: 6c73 6522 290a 0a20 2020 2020 2020 2023  lse")..        #
-0001ece0: 2053 6368 656d 6120 6669 7865 6420 6279   Schema fixed by
-0001ecf0: 2074 6865 206b 6166 6b61 2063 6f6e 6e65   the kafka conne
-0001ed00: 6374 6f72 0a20 2020 2020 2020 2069 6620  ctor.        if 
-0001ed10: 6461 7461 736f 7572 6365 5f65 7869 7374  datasource_exist
-0001ed20: 7320 616e 6420 280a 2020 2020 2020 2020  s and (.        
-0001ed30: 2020 2020 6473 5b22 7061 7261 6d73 225d      ds["params"]
-0001ed40: 5b22 7363 6865 6d61 225d 2e72 6570 6c61  ["schema"].repla
-0001ed50: 6365 2822 2022 2c20 2222 2920 213d 2065  ce(" ", "") != e
-0001ed60: 7869 7374 696e 675f 6473 5b22 7363 6865  xisting_ds["sche
-0001ed70: 6d61 225d 5b22 7371 6c5f 7363 6865 6d61  ma"]["sql_schema
-0001ed80: 225d 2e72 6570 6c61 6365 2822 2022 2c20  "].replace(" ", 
-0001ed90: 2222 290a 2020 2020 2020 2020 293a 0a20  "").        ):. 
-0001eda0: 2020 2020 2020 2020 2020 206e 6577 5f73             new_s
-0001edb0: 6368 656d 6120 3d20 6473 5b22 7061 7261  chema = ds["para
-0001edc0: 6d73 225d 5b22 7363 6865 6d61 225d 0a0a  ms"]["schema"]..
-0001edd0: 2020 2020 2020 2020 6966 2064 6174 6173          if datas
-0001ede0: 6f75 7263 655f 6578 6973 7473 3a0a 2020  ource_exists:.  
-0001edf0: 2020 2020 2020 2020 2020 6e65 7720 3d20            new = 
-0001ee00: 5b61 7364 6963 7428 696e 6465 7829 2066  [asdict(index) f
-0001ee10: 6f72 2069 6e64 6578 2069 6e20 6473 2e67  or index in ds.g
-0001ee20: 6574 2822 7061 7261 6d73 222c 207b 7d29  et("params", {})
-0001ee30: 2e67 6574 2822 696e 6465 7865 735f 6c69  .get("indexes_li
-0001ee40: 7374 222c 205b 5d29 5d0a 2020 2020 2020  st", [])].      
-0001ee50: 2020 2020 2020 6578 6973 7469 6e67 203d        existing =
-0001ee60: 2065 7869 7374 696e 675f 6473 2e67 6574   existing_ds.get
-0001ee70: 2822 696e 6465 7865 7322 2c20 5b5d 290a  ("indexes", []).
-0001ee80: 2020 2020 2020 2020 2020 2020 6e65 772e              new.
-0001ee90: 736f 7274 286b 6579 3d6c 616d 6264 6120  sort(key=lambda 
-0001eea0: 783a 2078 5b22 6e61 6d65 225d 290a 2020  x: x["name"]).  
-0001eeb0: 2020 2020 2020 2020 2020 6578 6973 7469            existi
-0001eec0: 6e67 2e73 6f72 7428 6b65 793d 6c61 6d62  ng.sort(key=lamb
-0001eed0: 6461 2078 3a20 785b 226e 616d 6522 5d29  da x: x["name"])
-0001eee0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001eef0: 6c65 6e28 6578 6973 7469 6e67 2920 213d  len(existing) !=
-0001ef00: 206c 656e 286e 6577 2920 6f72 2061 6e79   len(new) or any
-0001ef10: 285b 2864 2c20 6432 2920 666f 7220 642c  ([(d, d2) for d,
-0001ef20: 2064 3220 696e 207a 6970 286e 6577 2c20   d2 in zip(new, 
-0001ef30: 6578 6973 7469 6e67 2920 6966 2064 2021  existing) if d !
-0001ef40: 3d20 6432 5d29 3a0a 2020 2020 2020 2020  = d2]):.        
-0001ef50: 2020 2020 2020 2020 6e65 775f 696e 6469          new_indi
-0001ef60: 6365 7320 3d20 6473 2e67 6574 2822 7061  ces = ds.get("pa
-0001ef70: 7261 6d73 222c 207b 7d29 2e67 6574 2822  rams", {}).get("
-0001ef80: 696e 6465 7865 7322 2920 6f72 2022 3022  indexes") or "0"
-0001ef90: 0a20 2020 2020 2020 2069 6620 6e65 775f  .        if new_
-0001efa0: 6465 7363 7269 7074 696f 6e20 6f72 206e  description or n
-0001efb0: 6577 5f73 6368 656d 6120 6f72 206e 6577  ew_schema or new
-0001efc0: 5f74 746c 206f 7220 286e 6577 5f69 6e64  _ttl or (new_ind
-0001efd0: 6963 6573 2069 7320 6e6f 7420 4e6f 6e65  ices is not None
-0001efe0: 2920 616e 6420 286e 6f74 2066 6f72 6b5f  ) and (not fork_
-0001eff0: 646f 776e 7374 7265 616d 206f 7220 6e6f  downstream or no
-0001f000: 7420 666f 726b 293a 0a20 2020 2020 2020  t fork):.       
-0001f010: 2020 2020 2061 6c74 6572 5f72 6573 706f       alter_respo
-0001f020: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-0001f030: 6e74 2e61 6c74 6572 5f64 6174 6173 6f75  nt.alter_datasou
-0001f040: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-0001f050: 2020 2020 2064 735f 6e61 6d65 2c0a 2020       ds_name,.  
-0001f060: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001f070: 775f 7363 6865 6d61 3d6e 6577 5f73 6368  w_schema=new_sch
-0001f080: 656d 612c 0a20 2020 2020 2020 2020 2020  ema,.           
-0001f090: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
-0001f0a0: 3d6e 6577 5f64 6573 6372 6970 7469 6f6e  =new_description
-0001f0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f0c0: 2020 7474 6c3d 6e65 775f 7474 6c2c 0a20    ttl=new_ttl,. 
-0001f0d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001f0e0: 7279 5f72 756e 3d54 7275 652c 0a20 2020  ry_run=True,.   
-0001f0f0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-0001f100: 6578 6573 3d6e 6577 5f69 6e64 6963 6573  exes=new_indices
-0001f110: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0001f120: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0001f130: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0001f140: 2020 2069 6620 2254 6865 7265 2077 6572     if "There wer
-0001f150: 6520 6e6f 206f 7065 7261 7469 6f6e 7320  e no operations 
-0001f160: 746f 2070 6572 666f 726d 2220 696e 2073  to perform" in s
-0001f170: 7472 2865 293a 0a20 2020 2020 2020 2020  tr(e):.         
-0001f180: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-0001f190: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001f1a0: 2020 616c 7465 725f 6572 726f 725f 6d65    alter_error_me
-0001f1b0: 7373 6167 6520 3d20 7374 7228 6529 0a0a  ssage = str(e)..
-0001f1c0: 2020 2020 6966 2061 6c74 6572 5f72 6573      if alter_res
-0001f1d0: 706f 6e73 653a 0a20 2020 2020 2020 2069  ponse:.        i
-0001f1e0: 6620 6769 745f 7265 6c65 6173 6520 616e  f git_release an
-0001f1f0: 6420 6e6f 7420 736b 6970 5f63 6f6e 6669  d not skip_confi
-0001f200: 726d 6174 696f 6e3a 0a20 2020 2020 2020  rmation:.       
-0001f210: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-0001f220: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001f230: 696e 666f 5f63 7573 746f 6d5f 6465 706c  info_custom_depl
-0001f240: 6f79 6d65 6e74 2829 290a 2020 2020 2020  oyment()).      
-0001f250: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0001f260: 2822 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ("**************
-0001f270: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f280: 2a2a 2a2a 2a2a 2a2a 2a22 290a 2020 2020  *********").    
-0001f290: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001f2a0: 686f 2822 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ho("************
-0001f2b0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f2c0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a22 290a 2020  ***********").  
-0001f2d0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0001f2e0: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-0001f2f0: 2e69 6e66 6f5f 6461 7461 736f 7572 6365  .info_datasource
-0001f300: 5f64 6f65 736e 745f 6d61 7463 6828 6461  _doesnt_match(da
-0001f310: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
-0001f320: 2929 0a20 2020 2020 2020 2066 6f72 206f  )).        for o
-0001f330: 7065 7261 7469 6f6e 2069 6e20 616c 7465  peration in alte
-0001f340: 725f 7265 7370 6f6e 7365 5b22 6f70 6572  r_response["oper
-0001f350: 6174 696f 6e73 225d 3a0a 2020 2020 2020  ations"]:.      
-0001f360: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0001f370: 2866 222a 2a20 2020 2d20 207b 6f70 6572  (f"**   -  {oper
-0001f380: 6174 696f 6e7d 2229 0a0a 2020 2020 2020  ation}")..      
-0001f390: 2020 6966 2073 6b69 705f 636f 6e66 6972    if skip_confir
-0001f3a0: 6d61 7469 6f6e 3a0a 2020 2020 2020 2020  mation:.        
-0001f3b0: 2020 2020 6d61 6b65 5f63 6861 6e67 6573      make_changes
-0001f3c0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001f3d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001f3e0: 2020 6d61 6b65 5f63 6861 6e67 6573 203d    make_changes =
-0001f3f0: 2063 6c69 636b 2e70 726f 6d70 7428 4665   click.prompt(Fe
-0001f400: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
-0001f410: 666f 5f61 736b 5f66 6f72 5f61 6c74 6572  fo_ask_for_alter
-0001f420: 5f63 6f6e 6669 726d 6174 696f 6e28 2929  _confirmation())
-0001f430: 2e6c 6f77 6572 2829 203d 3d20 2279 220a  .lower() == "y".
-0001f440: 0a20 2020 2020 2020 2069 6620 6d61 6b65  .        if make
-0001f450: 5f63 6861 6e67 6573 3a0a 2020 2020 2020  _changes:.      
-0001f460: 2020 2020 2020 6177 6169 7420 636c 6965        await clie
-0001f470: 6e74 2e61 6c74 6572 5f64 6174 6173 6f75  nt.alter_datasou
-0001f480: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-0001f490: 2020 2020 2064 735f 6e61 6d65 2c0a 2020       ds_name,.  
-0001f4a0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001f4b0: 775f 7363 6865 6d61 3d6e 6577 5f73 6368  w_schema=new_sch
-0001f4c0: 656d 612c 0a20 2020 2020 2020 2020 2020  ema,.           
-0001f4d0: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
-0001f4e0: 3d6e 6577 5f64 6573 6372 6970 7469 6f6e  =new_description
-0001f4f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f500: 2020 7474 6c3d 6e65 775f 7474 6c2c 0a20    ttl=new_ttl,. 
-0001f510: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001f520: 7279 5f72 756e 3d46 616c 7365 2c0a 2020  ry_run=False,.  
-0001f530: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0001f540: 6465 7865 733d 6e65 775f 696e 6469 6365  dexes=new_indice
-0001f550: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-0001f560: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0001f570: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-0001f580: 4d61 6e61 6765 722e 7375 6363 6573 735f  Manager.success_
-0001f590: 6461 7461 736f 7572 6365 5f61 6c74 6572  datasource_alter
-0001f5a0: 2829 290a 2020 2020 2020 2020 656c 7365  ()).        else
-0001f5b0: 3a0a 2020 2020 2020 2020 2020 2020 616c  :.            al
-0001f5c0: 7465 725f 6572 726f 725f 6d65 7373 6167  ter_error_messag
-0001f5d0: 6520 3d20 2241 6c74 6572 2064 6174 6173  e = "Alter datas
-0001f5e0: 6f75 7263 6520 6361 6e63 656c 6c65 6422  ource cancelled"
-0001f5f0: 0a0a 2020 2020 6966 2064 6174 6173 6f75  ..    if datasou
-0001f600: 7263 655f 6578 6973 7473 2061 6e64 2064  rce_exists and d
-0001f610: 735b 2270 6172 616d 7322 5d2e 6765 7428  s["params"].get(
-0001f620: 2262 6163 6b66 696c 6c5f 636f 6c75 6d6e  "backfill_column
-0001f630: 2229 2021 3d20 6578 6973 7469 6e67 5f64  ") != existing_d
-0001f640: 735b 2274 6167 7322 5d2e 6765 7428 2262  s["tags"].get("b
-0001f650: 6163 6b66 696c 6c5f 636f 6c75 6d6e 2229  ackfill_column")
-0001f660: 3a0a 2020 2020 2020 2020 7061 7261 6d73  :.        params
-0001f670: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001f680: 2022 6261 636b 6669 6c6c 5f63 6f6c 756d   "backfill_colum
-0001f690: 6e22 3a20 6473 5b22 7061 7261 6d73 225d  n": ds["params"]
-0001f6a0: 2e67 6574 2822 6261 636b 6669 6c6c 5f63  .get("backfill_c
-0001f6b0: 6f6c 756d 6e22 292c 0a20 2020 2020 2020  olumn"),.       
-0001f6c0: 207d 0a0a 2020 2020 2020 2020 7472 793a   }..        try:
-0001f6d0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0001f6e0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-0001f6f0: 4d61 6e61 6765 722e 696e 666f 5f75 7064  Manager.info_upd
-0001f700: 6174 655f 6461 7461 736f 7572 6365 2864  ate_datasource(d
-0001f710: 6174 6173 6f75 7263 653d 6473 5f6e 616d  atasource=ds_nam
-0001f720: 652c 2070 6172 616d 733d 7061 7261 6d73  e, params=params
-0001f730: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
-0001f740: 7761 6974 2063 6c69 656e 742e 7570 6461  wait client.upda
-0001f750: 7465 5f64 6174 6173 6f75 7263 6528 6473  te_datasource(ds
-0001f760: 5f6e 616d 652c 2070 6172 616d 7329 0a20  _name, params). 
-0001f770: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-0001f780: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
-0001f790: 6e61 6765 722e 7375 6363 6573 735f 7570  nager.success_up
-0001f7a0: 6461 7465 5f64 6174 6173 6f75 7263 6528  date_datasource(
-0001f7b0: 6461 7461 736f 7572 6365 3d64 735f 6e61  datasource=ds_na
-0001f7c0: 6d65 2c20 7061 7261 6d73 3d70 6172 616d  me, params=param
-0001f7d0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0001f7e0: 6d61 6b65 5f63 6861 6e67 6573 203d 2054  make_changes = T
-0001f7f0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0001f800: 616c 7465 725f 7265 7370 6f6e 7365 203d  alter_response =
-0001f810: 2054 7275 650a 2020 2020 2020 2020 6578   True.        ex
-0001f820: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-0001f830: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-0001f840: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-0001f850: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-0001f860: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-0001f870: 725f 7570 6461 7469 6e67 5f64 6174 6173  r_updating_datas
-0001f880: 6f75 7263 6528 6461 7461 736f 7572 6365  ource(datasource
-0001f890: 3d64 735f 6e61 6d65 2c20 6572 726f 723d  =ds_name, error=
-0001f8a0: 7374 7228 6529 2929 0a0a 2020 2020 636f  str(e)))..    co
-0001f8b0: 6e6e 6563 746f 725f 6461 7461 203d 204e  nnector_data = N
-0001f8c0: 6f6e 650a 2020 2020 7072 6f6d 6f74 655f  one.    promote_
-0001f8d0: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
-0001f8e0: 4e6f 6e65 0a0a 2020 2020 6473 5f70 6172  None..    ds_par
-0001f8f0: 616d 7320 3d20 6473 5b22 7061 7261 6d73  ams = ds["params
-0001f900: 225d 0a20 2020 2073 6572 7669 6365 203d  "].    service =
-0001f910: 2064 735f 7061 7261 6d73 2e67 6574 2822   ds_params.get("
-0001f920: 7365 7276 6963 6522 290a 2020 2020 4441  service").    DA
-0001f930: 5441 534f 5552 4345 5f56 414c 4944 5f53  TASOURCE_VALID_S
-0001f940: 4552 5649 4345 535f 544f 5f55 5044 4154  ERVICES_TO_UPDAT
-0001f950: 4520 3d20 5b22 6269 6771 7565 7279 222c  E = ["bigquery",
-0001f960: 2022 736e 6f77 666c 616b 6522 5d0a 2020   "snowflake"].  
-0001f970: 2020 6966 2064 6174 6173 6f75 7263 655f    if datasource_
-0001f980: 6578 6973 7473 2061 6e64 2073 6572 7669  exists and servi
-0001f990: 6365 2061 6e64 2073 6572 7669 6365 2069  ce and service i
-0001f9a0: 6e20 5b2a 4441 5441 534f 5552 4345 5f56  n [*DATASOURCE_V
-0001f9b0: 414c 4944 5f53 4552 5649 4345 535f 544f  ALID_SERVICES_TO
-0001f9c0: 5f55 5044 4154 452c 202a 5052 4556 4945  _UPDATE, *PREVIE
-0001f9d0: 575f 434f 4e4e 4543 544f 525f 5345 5256  W_CONNECTOR_SERV
-0001f9e0: 4943 4553 5d3a 0a20 2020 2020 2020 2063  ICES]:.        c
-0001f9f0: 6f6e 6e65 6374 6f72 5f72 6571 7569 7265  onnector_require
-0001fa00: 645f 7061 7261 6d73 203d 207b 0a20 2020  d_params = {.   
-0001fa10: 2020 2020 2020 2020 2022 6269 6771 7565           "bigque
-0001fa20: 7279 223a 205b 2273 6572 7669 6365 222c  ry": ["service",
-0001fa30: 2022 6372 6f6e 222c 2022 6578 7465 726e   "cron", "extern
-0001fa40: 616c 5f64 6174 615f 736f 7572 6365 225d  al_data_source"]
-0001fa50: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0001fa60: 6e6f 7766 6c61 6b65 223a 205b 2263 6f6e  nowflake": ["con
-0001fa70: 6e65 6374 6f72 222c 2022 7365 7276 6963  nector", "servic
-0001fa80: 6522 2c20 2263 726f 6e22 2c20 2265 7874  e", "cron", "ext
-0001fa90: 6572 6e61 6c5f 6461 7461 5f73 6f75 7263  ernal_data_sourc
-0001faa0: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
-0001fab0: 2022 7333 223a 205b 2263 6f6e 6e65 6374   "s3": ["connect
-0001fac0: 6f72 222c 2022 7365 7276 6963 6522 2c20  or", "service", 
-0001fad0: 2263 726f 6e22 2c20 2262 7563 6b65 745f  "cron", "bucket_
-0001fae0: 7572 6922 5d2c 0a20 2020 2020 2020 2020  uri"],.         
-0001faf0: 2020 2022 7333 5f69 616d 726f 6c65 223a     "s3_iamrole":
-0001fb00: 205b 2263 6f6e 6e65 6374 6f72 222c 2022   ["connector", "
-0001fb10: 7365 7276 6963 6522 2c20 2263 726f 6e22  service", "cron"
-0001fb20: 2c20 2262 7563 6b65 745f 7572 6922 5d2c  , "bucket_uri"],
-0001fb30: 0a20 2020 2020 2020 2020 2020 2022 6763  .            "gc
-0001fb40: 7322 3a20 5b22 636f 6e6e 6563 746f 7222  s": ["connector"
-0001fb50: 2c20 2273 6572 7669 6365 222c 2022 6372  , "service", "cr
-0001fb60: 6f6e 222c 2022 6275 636b 6574 5f75 7269  on", "bucket_uri
-0001fb70: 225d 2c0a 2020 2020 2020 2020 7d2e 6765  "],.        }.ge
-0001fb80: 7428 7365 7276 6963 652c 205b 5d29 0a0a  t(service, [])..
-0001fb90: 2020 2020 2020 2020 6966 206e 6f74 2061          if not a
-0001fba0: 6c6c 286b 6579 2069 6e20 6473 5f70 6172  ll(key in ds_par
-0001fbb0: 616d 7320 666f 7220 6b65 7920 696e 2063  ams for key in c
-0001fbc0: 6f6e 6e65 6374 6f72 5f72 6571 7569 7265  onnector_require
-0001fbd0: 645f 7061 7261 6d73 293a 0a20 2020 2020  d_params):.     
-0001fbe0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-0001fbf0: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
-0001fc00: 203d 2064 735f 7061 7261 6d73 2e67 6574   = ds_params.get
-0001fc10: 2822 636f 6e6e 6563 746f 7222 2c20 4e6f  ("connector", No
-0001fc20: 6e65 290a 0a20 2020 2020 2020 2069 6620  ne)..        if 
-0001fc30: 7365 7276 6963 6520 696e 2050 5245 5649  service in PREVI
-0001fc40: 4557 5f43 4f4e 4e45 4354 4f52 5f53 4552  EW_CONNECTOR_SER
-0001fc50: 5649 4345 533a 0a20 2020 2020 2020 2020  VICES:.         
-0001fc60: 2020 2063 6f6e 6e65 6374 6f72 5f69 6420     connector_id 
-0001fc70: 3d20 6578 6973 7469 6e67 5f64 732e 6765  = existing_ds.ge
-0001fc80: 7428 2263 6f6e 6e65 6374 6f72 222c 2022  t("connector", "
-0001fc90: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-0001fca0: 6620 6e6f 7420 636f 6e6e 6563 746f 725f  f not connector_
-0001fcb0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
-0001fcc0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0001fcd0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-0001fce0: 636f 6e6e 6563 746f 7220 3d20 6177 6169  connector = awai
-0001fcf0: 7420 636c 6965 6e74 2e67 6574 5f63 6f6e  t client.get_con
-0001fd00: 6e65 6374 6f72 5f62 795f 6964 2865 7869  nector_by_id(exi
-0001fd10: 7374 696e 675f 6473 2e67 6574 2822 636f  sting_ds.get("co
-0001fd20: 6e6e 6563 746f 7222 2c20 2222 2929 0a20  nnector", "")). 
-0001fd30: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0001fd40: 7420 6375 7272 656e 745f 636f 6e6e 6563  t current_connec
-0001fd50: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-0001fd60: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001fd70: 2020 2020 2020 2020 2069 6620 6375 7272           if curr
-0001fd80: 656e 745f 636f 6e6e 6563 746f 725b 226e  ent_connector["n
-0001fd90: 616d 6522 5d20 213d 2064 735f 7061 7261  ame"] != ds_para
-0001fda0: 6d73 5b22 636f 6e6e 6563 7469 6f6e 225d  ms["connection"]
-0001fdb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001fdc0: 2020 7061 7261 6d20 3d20 2263 6f6e 6e65    param = "conne
-0001fdd0: 6374 696f 6e22 0a20 2020 2020 2020 2020  ction".         
-0001fde0: 2020 2020 2020 2064 6174 6166 696c 655f         datafile_
-0001fdf0: 7061 7261 6d20 3d20 496d 706f 7274 5265  param = ImportRe
-0001fe00: 706c 6163 656d 656e 7473 2e67 6574 5f64  placements.get_d
-0001fe10: 6174 6166 696c 655f 7061 7261 6d5f 666f  atafile_param_fo
-0001fe20: 725f 6c69 6e6b 6572 5f70 6172 616d 2873  r_linker_param(s
-0001fe30: 6572 7669 6365 2c20 7061 7261 6d29 206f  ervice, param) o
-0001fe40: 7220 7061 7261 6d0a 2020 2020 2020 2020  r param.        
-0001fe50: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
-0001fe60: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
-0001fe70: 6f6e 2846 6565 6462 6163 6b4d 616e 6167  on(FeedbackManag
-0001fe80: 6572 2e65 7272 6f72 5f75 7064 6174 696e  er.error_updatin
-0001fe90: 675f 636f 6e6e 6563 746f 725f 6e6f 745f  g_connector_not_
-0001fea0: 7375 7070 6f72 7465 6428 7061 7261 6d3d  supported(param=
-0001feb0: 6461 7461 6669 6c65 5f70 6172 616d 2929  datafile_param))
-0001fec0: 0a0a 2020 2020 2020 2020 2020 2020 6c69  ..            li
-0001fed0: 6e6b 6572 7320 3d20 6375 7272 656e 745f  nkers = current_
-0001fee0: 636f 6e6e 6563 746f 722e 6765 7428 226c  connector.get("l
-0001fef0: 696e 6b65 7273 222c 205b 5d29 0a20 2020  inkers", []).   
-0001ff00: 2020 2020 2020 2020 206c 696e 6b65 7220           linker 
-0001ff10: 3d20 6e65 7874 2828 6c69 6e6b 6572 2066  = next((linker f
-0001ff20: 6f72 206c 696e 6b65 7220 696e 206c 696e  or linker in lin
-0001ff30: 6b65 7273 2069 6620 6c69 6e6b 6572 5b22  kers if linker["
-0001ff40: 6461 7461 736f 7572 6365 5f69 6422 5d20  datasource_id"] 
-0001ff50: 3d3d 2065 7869 7374 696e 675f 6473 5b22  == existing_ds["
-0001ff60: 6964 225d 292c 204e 6f6e 6529 0a20 2020  id"]), None).   
-0001ff70: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001ff80: 6c69 6e6b 6572 3a0a 2020 2020 2020 2020  linker:.        
-0001ff90: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0001ffa0: 2020 2020 2020 2020 2020 2020 6c69 6e6b              link
-0001ffb0: 6572 5f73 6574 7469 6e67 7320 3d20 6c69  er_settings = li
-0001ffc0: 6e6b 6572 2e67 6574 2822 7365 7474 696e  nker.get("settin
-0001ffd0: 6773 222c 207b 7d29 0a20 2020 2020 2020  gs", {}).       
-0001ffe0: 2020 2020 2066 6f72 2070 6172 616d 2c20       for param, 
-0001fff0: 7661 6c75 6520 696e 206c 696e 6b65 725f  value in linker_
-00020000: 7365 7474 696e 6773 2e69 7465 6d73 2829  settings.items()
-00020010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020020: 2020 6473 5f70 6172 616d 735f 7661 6c75    ds_params_valu
-00020030: 6520 3d20 6473 5f70 6172 616d 732e 6765  e = ds_params.ge
-00020040: 7428 7061 7261 6d2c 204e 6f6e 6529 0a20  t(param, None). 
-00020050: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00020060: 6620 6473 5f70 6172 616d 735f 7661 6c75  f ds_params_valu
-00020070: 6520 616e 6420 6473 5f70 6172 616d 735f  e and ds_params_
-00020080: 7661 6c75 6520 213d 2076 616c 7565 3a0a  value != value:.
-00020090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200a0: 2020 2020 6461 7461 6669 6c65 5f70 6172      datafile_par
-000200b0: 616d 203d 2049 6d70 6f72 7452 6570 6c61  am = ImportRepla
-000200c0: 6365 6d65 6e74 732e 6765 745f 6461 7461  cements.get_data
-000200d0: 6669 6c65 5f70 6172 616d 5f66 6f72 5f6c  file_param_for_l
-000200e0: 696e 6b65 725f 7061 7261 6d28 7365 7276  inker_param(serv
-000200f0: 6963 652c 2070 6172 616d 2920 6f72 2070  ice, param) or p
-00020100: 6172 616d 0a20 2020 2020 2020 2020 2020  aram.           
-00020110: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-00020120: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020140: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-00020150: 722e 6572 726f 725f 7570 6461 7469 6e67  r.error_updating
-00020160: 5f63 6f6e 6e65 6374 6f72 5f6e 6f74 5f73  _connector_not_s
-00020170: 7570 706f 7274 6564 2870 6172 616d 3d64  upported(param=d
-00020180: 6174 6166 696c 655f 7061 7261 6d2e 7570  atafile_param.up
-00020190: 7065 7228 2929 0a20 2020 2020 2020 2020  per()).         
-000201a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000201b0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000201c0: 0a20 2020 2020 2020 2063 6f6e 6e65 6374  .        connect
-000201d0: 6f72 5f64 6174 6120 3d20 7b0a 2020 2020  or_data = {.    
-000201e0: 2020 2020 2020 2020 2263 6f6e 6e65 6374          "connect
-000201f0: 6f72 223a 2063 6f6e 6e65 6374 6f72 2c0a  or": connector,.
-00020200: 2020 2020 2020 2020 2020 2020 2273 6572              "ser
-00020210: 7669 6365 223a 2073 6572 7669 6365 2c0a  vice": service,.
-00020220: 2020 2020 2020 2020 2020 2020 2263 726f              "cro
-00020230: 6e22 3a20 6473 5f70 6172 616d 732e 6765  n": ds_params.ge
-00020240: 7428 2263 726f 6e22 2c20 4e6f 6e65 292c  t("cron", None),
-00020250: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
-00020260: 7465 726e 616c 5f64 6174 615f 736f 7572  ternal_data_sour
-00020270: 6365 223a 2064 735f 7061 7261 6d73 2e67  ce": ds_params.g
-00020280: 6574 2822 6578 7465 726e 616c 5f64 6174  et("external_dat
-00020290: 615f 736f 7572 6365 222c 204e 6f6e 6529  a_source", None)
-000202a0: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
-000202b0: 7563 6b65 745f 7572 6922 3a20 6473 5f70  ucket_uri": ds_p
-000202c0: 6172 616d 732e 6765 7428 2262 7563 6b65  arams.get("bucke
-000202d0: 745f 7572 6922 2c20 4e6f 6e65 292c 0a20  t_uri", None),. 
-000202e0: 2020 2020 2020 2020 2020 2022 6d6f 6465             "mode
-000202f0: 223a 2064 735f 7061 7261 6d73 2e67 6574  ": ds_params.get
-00020300: 2822 6d6f 6465 222c 2022 7265 706c 6163  ("mode", "replac
-00020310: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
-00020320: 2022 7175 6572 7922 3a20 6473 5f70 6172   "query": ds_par
-00020330: 616d 732e 6765 7428 2271 7565 7279 222c  ams.get("query",
-00020340: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-00020350: 2020 2020 2269 6e67 6573 745f 6e6f 7722      "ingest_now"
-00020360: 3a20 6473 5f70 6172 616d 732e 6765 7428  : ds_params.get(
-00020370: 2269 6e67 6573 745f 6e6f 7722 2c20 4661  "ingest_now", Fa
-00020380: 6c73 6529 2c0a 2020 2020 2020 2020 7d0a  lse),.        }.
-00020390: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000203a0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000203b0: 636c 6965 6e74 2e75 7064 6174 655f 6461  client.update_da
-000203c0: 7461 736f 7572 6365 2864 735f 6e61 6d65  tasource(ds_name
-000203d0: 2c20 636f 6e6e 6563 746f 725f 6461 7461  , connector_data
-000203e0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-000203f0: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
-00020400: 6b4d 616e 6167 6572 2e73 7563 6365 7373  kManager.success
-00020410: 5f70 726f 6d6f 7469 6e67 5f64 6174 6173  _promoting_datas
-00020420: 6f75 7263 6528 6461 7461 736f 7572 6365  ource(datasource
-00020430: 3d64 735f 6e61 6d65 2929 0a20 2020 2020  =ds_name)).     
-00020440: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00020450: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00020460: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00020470: 2020 2020 2020 2020 2070 726f 6d6f 7465           promote
-00020480: 5f65 7272 6f72 5f6d 6573 7361 6765 203d  _error_message =
-00020490: 2073 7472 2865 290a 0a20 2020 2069 6620   str(e)..    if 
-000204a0: 616c 7465 725f 7265 7370 6f6e 7365 2061  alter_response a
-000204b0: 6e64 206d 616b 655f 6368 616e 6765 733a  nd make_changes:
-000204c0: 0a20 2020 2020 2020 2023 2061 6c74 6572  .        # alter
-000204d0: 206f 7065 7261 7469 6f6e 2066 696e 6973   operation finis
-000204e0: 6865 640a 2020 2020 2020 2020 7265 7475  hed.        retu
-000204f0: 726e 0a20 2020 2023 2072 656d 6f76 6564  rn.    # removed
-00020500: 2072 6570 6c61 6369 6e67 2062 7920 6465   replacing by de
-00020510: 6661 756c 742e 2057 6865 6e20 6120 6461  fault. When a da
-00020520: 7461 736f 7572 6365 2069 7320 7265 6d6f  tasource is remo
-00020530: 7665 6420 6461 7461 2069 730a 2020 2020  ved data is.    
-00020540: 2320 7265 6d6f 7665 6420 616e 6420 616c  # removed and al
-00020550: 6c20 7468 6520 7265 6665 7265 6e63 6573  l the references
-00020560: 206e 6565 6473 2074 6f20 6265 2075 7064   needs to be upd
-00020570: 6174 6564 0a20 2020 2069 6620 280a 2020  ated.    if (.  
-00020580: 2020 2020 2020 6f73 2e67 6574 656e 7628        os.getenv(
-00020590: 2254 425f 495f 4b4e 4f57 5f57 4841 545f  "TB_I_KNOW_WHAT_
-000205a0: 495f 414d 5f44 4f49 4e47 2229 0a20 2020  I_AM_DOING").   
-000205b0: 2020 2020 2061 6e64 2063 6c69 636b 2e70       and click.p
-000205c0: 726f 6d70 7428 4665 6564 6261 636b 4d61  rompt(FeedbackMa
-000205d0: 6e61 6765 722e 696e 666f 5f61 736b 5f66  nager.info_ask_f
-000205e0: 6f72 5f64 6174 6173 6f75 7263 655f 636f  or_datasource_co
-000205f0: 6e66 6972 6d61 7469 6f6e 2829 2920 3d3d  nfirmation()) ==
-00020600: 2064 735f 6e61 6d65 0a20 2020 2029 3a20   ds_name.    ): 
-00020610: 2023 2054 4f44 4f20 6d6f 7665 2074 6f20   # TODO move to 
-00020620: 434c 490a 2020 2020 2020 2020 7472 793a  CLI.        try:
-00020630: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00020640: 6974 2063 6c69 656e 742e 6461 7461 736f  it client.dataso
-00020650: 7572 6365 5f64 656c 6574 6528 6473 5f6e  urce_delete(ds_n
-00020660: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00020670: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
-00020680: 6261 636b 4d61 6e61 6765 722e 7375 6363  backManager.succ
-00020690: 6573 735f 6465 6c65 7465 5f64 6174 6173  ess_delete_datas
-000206a0: 6f75 7263 6528 6461 7461 736f 7572 6365  ource(datasource
-000206b0: 3d64 735f 6e61 6d65 2929 0a20 2020 2020  =ds_name)).     
-000206c0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000206d0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-000206e0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-000206f0: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-00020700: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-00020710: 725f 7265 6d6f 7669 6e67 5f64 6174 6173  r_removing_datas
-00020720: 6f75 7263 6528 6461 7461 736f 7572 6365  ource(datasource
-00020730: 3d64 735f 6e61 6d65 2929 0a20 2020 2020  =ds_name)).     
-00020740: 2020 2072 6574 7572 6e0a 2020 2020 656c     return.    el
-00020750: 7365 3a0a 2020 2020 2020 2020 6966 2061  se:.        if a
-00020760: 6c74 6572 5f65 7272 6f72 5f6d 6573 7361  lter_error_messa
-00020770: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-00020780: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
-00020790: 6b45 7863 6570 7469 6f6e 280a 2020 2020  kException(.    
-000207a0: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
-000207b0: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-000207c0: 725f 6461 7461 736f 7572 6365 5f61 6c72  r_datasource_alr
-000207d0: 6561 6479 5f65 7869 7374 735f 616e 645f  eady_exists_and_
-000207e0: 616c 7465 725f 6661 696c 6564 280a 2020  alter_failed(.  
-000207f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020800: 2020 6461 7461 736f 7572 6365 3d64 735f    datasource=ds_
-00020810: 6e61 6d65 2c20 616c 7465 725f 6572 726f  name, alter_erro
-00020820: 725f 6d65 7373 6167 653d 616c 7465 725f  r_message=alter_
-00020830: 6572 726f 725f 6d65 7373 6167 650a 2020  error_message.  
-00020840: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00020850: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00020860: 2020 2020 2020 6966 2070 726f 6d6f 7465        if promote
-00020870: 5f65 7272 6f72 5f6d 6573 7361 6765 3a0a  _error_message:.
-00020880: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00020890: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-000208a0: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-000208b0: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
-000208c0: 4d61 6e61 6765 722e 6572 726f 725f 7072  Manager.error_pr
-000208d0: 6f6d 6f74 696e 675f 6461 7461 736f 7572  omoting_datasour
-000208e0: 6365 2864 6174 6173 6f75 7263 653d 6473  ce(datasource=ds
-000208f0: 5f6e 616d 652c 2065 7272 6f72 3d70 726f  _name, error=pro
-00020900: 6d6f 7465 5f65 7272 6f72 5f6d 6573 7361  mote_error_messa
-00020910: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
-00020920: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00020930: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-00020940: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-00020950: 616e 6167 6572 2e77 6172 6e69 6e67 5f64  anager.warning_d
-00020960: 6174 6173 6f75 7263 655f 616c 7265 6164  atasource_alread
-00020970: 795f 6578 6973 7473 2864 6174 6173 6f75  y_exists(datasou
-00020980: 7263 653d 6473 5f6e 616d 6529 290a 0a0a  rce=ds_name))...
-00020990: 6173 796e 6320 6465 6620 6e65 775f 746f  async def new_to
-000209a0: 6b65 6e28 746f 6b65 6e3a 2044 6963 745b  ken(token: Dict[
-000209b0: 7374 722c 2041 6e79 5d2c 2063 6c69 656e  str, Any], clien
-000209c0: 743a 2054 696e 7942 2c20 666f 7263 653a  t: TinyB, force:
-000209d0: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
-000209e0: 2020 2020 6578 6973 7469 6e67 5f74 6f6b      existing_tok
-000209f0: 656e 203d 204e 6f6e 650a 2020 2020 7472  en = None.    tr
-00020a00: 793a 0a20 2020 2020 2020 2065 7869 7374  y:.        exist
-00020a10: 696e 675f 746f 6b65 6e20 3d20 6177 6169  ing_token = awai
-00020a20: 7420 636c 6965 6e74 2e74 6f6b 656e 5f67  t client.token_g
-00020a30: 6574 2874 6f6b 656e 5b22 6e61 6d65 225d  et(token["name"]
-00020a40: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-00020a50: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00020a60: 7061 7373 0a0a 2020 2020 6966 206e 6f74  pass..    if not
-00020a70: 2065 7869 7374 696e 675f 746f 6b65 6e3a   existing_token:
-00020a80: 0a20 2020 2020 2020 2061 7761 6974 2063  .        await c
-00020a90: 6c69 656e 742e 746f 6b65 6e5f 6372 6561  lient.token_crea
-00020aa0: 7465 2874 6f6b 656e 290a 2020 2020 2020  te(token).      
-00020ab0: 2020 7265 7475 726e 0a0a 2020 2020 6966    return..    if
-00020ac0: 2066 6f72 6365 3a0a 2020 2020 2020 2020   force:.        
-00020ad0: 4144 4d49 4e5f 5343 4f50 4553 203d 205b  ADMIN_SCOPES = [
-00020ae0: 2241 444d 494e 222c 2022 4144 4d49 4e5f  "ADMIN", "ADMIN_
-00020af0: 5553 4552 225d 0a20 2020 2020 2020 2069  USER"].        i
-00020b00: 6620 616e 7928 5b73 636f 7065 5b22 7479  f any([scope["ty
-00020b10: 7065 225d 2069 6e20 4144 4d49 4e5f 5343  pe"] in ADMIN_SC
-00020b20: 4f50 4553 2066 6f72 2073 636f 7065 2069  OPES for scope i
-00020b30: 6e20 6578 6973 7469 6e67 5f74 6f6b 656e  n existing_token
-00020b40: 5b22 7363 6f70 6573 225d 5d29 3a0a 2020  ["scopes"]]):.  
-00020b50: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00020b60: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-00020b70: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-00020b80: 6167 6572 2e65 7272 6f72 5f74 6f6b 656e  ager.error_token
-00020b90: 5f63 616e 6e6f 745f 6265 5f6f 7665 7272  _cannot_be_overr
-00020ba0: 6964 656e 2874 6f6b 656e 3d74 6f6b 656e  iden(token=token
-00020bb0: 5b22 6e61 6d65 225d 2929 0a0a 2020 2020  ["name"]))..    
-00020bc0: 2020 2020 6177 6169 7420 636c 6965 6e74      await client
-00020bd0: 2e74 6f6b 656e 5f75 7064 6174 6528 746f  .token_update(to
-00020be0: 6b65 6e29 0a20 2020 2020 2020 2072 6574  ken).        ret
-00020bf0: 7572 6e0a 0a20 2020 2072 6169 7365 2063  urn..    raise c
-00020c00: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
-00020c10: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
-00020c20: 6765 722e 6572 726f 725f 746f 6b65 6e5f  ger.error_token_
-00020c30: 616c 7265 6164 795f 6578 6973 7473 2874  already_exists(t
-00020c40: 6f6b 656e 3d74 6f6b 656e 5b22 6e61 6d65  oken=token["name
-00020c50: 225d 2929 0a0a 0a61 7379 6e63 2064 6566  "]))...async def
-00020c60: 2065 7865 635f 6669 6c65 280a 2020 2020   exec_file(.    
-00020c70: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00020c80: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00020c90: 2c0a 2020 2020 723a 2044 6963 745b 7374  ,.    r: Dict[st
-00020ca0: 722c 2041 6e79 5d2c 0a20 2020 2074 625f  r, Any],.    tb_
-00020cb0: 636c 6965 6e74 3a20 5469 6e79 422c 0a20  client: TinyB,. 
-00020cc0: 2020 2066 6f72 6365 3a20 626f 6f6c 2c0a     force: bool,.
-00020cd0: 2020 2020 6368 6563 6b3a 2062 6f6f 6c2c      check: bool,
-00020ce0: 0a20 2020 2064 6562 7567 3a20 626f 6f6c  .    debug: bool
-00020cf0: 2c0a 2020 2020 706f 7075 6c61 7465 3a20  ,.    populate: 
-00020d00: 626f 6f6c 2c0a 2020 2020 706f 7075 6c61  bool,.    popula
-00020d10: 7465 5f73 7562 7365 742c 0a20 2020 2070  te_subset,.    p
-00020d20: 6f70 756c 6174 655f 636f 6e64 6974 696f  opulate_conditio
-00020d30: 6e2c 0a20 2020 2075 6e6c 696e 6b5f 6f6e  n,.    unlink_on
-00020d40: 5f70 6f70 756c 6174 655f 6572 726f 722c  _populate_error,
-00020d50: 0a20 2020 2077 6169 745f 706f 7075 6c61  .    wait_popula
-00020d60: 7465 2c0a 2020 2020 7573 6572 5f74 6f6b  te,.    user_tok
-00020d70: 656e 3a20 4f70 7469 6f6e 616c 5b73 7472  en: Optional[str
-00020d80: 5d2c 0a20 2020 206f 7665 7272 6964 655f  ],.    override_
-00020d90: 6461 7461 736f 7572 6365 3a20 626f 6f6c  datasource: bool
-00020da0: 203d 2046 616c 7365 2c0a 2020 2020 6967   = False,.    ig
-00020db0: 6e6f 7265 5f73 716c 5f65 7272 6f72 733a  nore_sql_errors:
-00020dc0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00020dd0: 2020 2073 6b69 705f 636f 6e66 6972 6d61     skip_confirma
-00020de0: 7469 6f6e 3a20 626f 6f6c 203d 2046 616c  tion: bool = Fal
-00020df0: 7365 2c0a 2020 2020 6f6e 6c79 5f72 6573  se,.    only_res
-00020e00: 706f 6e73 655f 7469 6d65 733a 2062 6f6f  ponse_times: boo
-00020e10: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
-00020e20: 696d 656f 7574 3d4e 6f6e 652c 0a20 2020  imeout=None,.   
-00020e30: 2072 756e 5f74 6573 7473 3d46 616c 7365   run_tests=False
-00020e40: 2c0a 2020 2020 6173 5f73 7461 6e64 6172  ,.    as_standar
-00020e50: 643d 4661 6c73 652c 0a20 2020 2074 6573  d=False,.    tes
-00020e60: 7473 5f74 6f5f 7275 6e3a 2069 6e74 203d  ts_to_run: int =
-00020e70: 2030 2c0a 2020 2020 7465 7374 735f 746f   0,.    tests_to
-00020e80: 5f73 616d 706c 655f 6279 5f70 6172 616d  _sample_by_param
-00020e90: 733a 2069 6e74 203d 2030 2c0a 2020 2020  s: int = 0,.    
-00020ea0: 7465 7374 735f 6669 6c74 6572 5f62 793a  tests_filter_by:
-00020eb0: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00020ec0: 7472 5d5d 203d 204e 6f6e 652c 0a20 2020  tr]] = None,.   
-00020ed0: 2074 6573 7473 5f66 6169 6c66 6173 743a   tests_failfast:
-00020ee0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00020ef0: 2020 2074 6573 7473 5f69 676e 6f72 655f     tests_ignore_
-00020f00: 6f72 6465 723a 2062 6f6f 6c20 3d20 4661  order: bool = Fa
-00020f10: 6c73 652c 0a20 2020 2074 6573 7473 5f76  lse,.    tests_v
-00020f20: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
-00020f30: 645f 6279 7465 733a 2062 6f6f 6c20 3d20  d_bytes: bool = 
-00020f40: 4661 6c73 652c 0a20 2020 2074 6573 7473  False,.    tests
-00020f50: 5f63 6865 636b 5f72 6571 7565 7374 735f  _check_requests_
-00020f60: 6672 6f6d 5f62 7261 6e63 683a 2062 6f6f  from_branch: boo
-00020f70: 6c20 3d20 4661 6c73 652c 0a20 2020 2063  l = False,.    c
-00020f80: 7572 7265 6e74 5f77 733a 204f 7074 696f  urrent_ws: Optio
-00020f90: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
-00020fa0: 795d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  y]] = None,.    
-00020fb0: 666f 726b 5f64 6f77 6e73 7472 6561 6d3a  fork_downstream:
-00020fc0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00020fd0: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
-00020fe0: 6b3a 204f 7074 696f 6e61 6c5b 626f 6f6c  k: Optional[bool
-00020ff0: 5d20 3d20 4661 6c73 652c 0a20 2020 2067  ] = False,.    g
-00021000: 6974 5f72 656c 6561 7365 3a20 4f70 7469  it_release: Opti
-00021010: 6f6e 616c 5b62 6f6f 6c5d 203d 2046 616c  onal[bool] = Fal
-00021020: 7365 2c0a 293a 0a20 2020 2069 6620 6465  se,.):.    if de
-00021030: 6275 673a 0a20 2020 2020 2020 2063 6c69  bug:.        cli
-00021040: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-00021050: 4d61 6e61 6765 722e 6465 6275 675f 7275  Manager.debug_ru
-00021060: 6e6e 696e 675f 6669 6c65 2866 696c 653d  nning_file(file=
-00021070: 7070 2e70 666f 726d 6174 2872 2929 290a  pp.pformat(r))).
-00021080: 2020 2020 6966 2072 5b22 7265 736f 7572      if r["resour
-00021090: 6365 225d 203d 3d20 2270 6970 6573 223a  ce"] == "pipes":
-000210a0: 0a20 2020 2020 2020 2061 7761 6974 206e  .        await n
-000210b0: 6577 5f70 6970 6528 0a20 2020 2020 2020  ew_pipe(.       
-000210c0: 2020 2020 2072 2c0a 2020 2020 2020 2020       r,.        
-000210d0: 2020 2020 7462 5f63 6c69 656e 742c 0a20      tb_client,. 
-000210e0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-000210f0: 2c0a 2020 2020 2020 2020 2020 2020 6368  ,.            ch
-00021100: 6563 6b2c 0a20 2020 2020 2020 2020 2020  eck,.           
-00021110: 2070 6f70 756c 6174 652c 0a20 2020 2020   populate,.     
-00021120: 2020 2020 2020 2070 6f70 756c 6174 655f         populate_
-00021130: 7375 6273 6574 2c0a 2020 2020 2020 2020  subset,.        
-00021140: 2020 2020 706f 7075 6c61 7465 5f63 6f6e      populate_con
-00021150: 6469 7469 6f6e 2c0a 2020 2020 2020 2020  dition,.        
-00021160: 2020 2020 756e 6c69 6e6b 5f6f 6e5f 706f      unlink_on_po
-00021170: 7075 6c61 7465 5f65 7272 6f72 2c0a 2020  pulate_error,.  
-00021180: 2020 2020 2020 2020 2020 7761 6974 5f70            wait_p
-00021190: 6f70 756c 6174 652c 0a20 2020 2020 2020  opulate,.       
-000211a0: 2020 2020 2069 676e 6f72 655f 7371 6c5f       ignore_sql_
-000211b0: 6572 726f 7273 3d69 676e 6f72 655f 7371  errors=ignore_sq
-000211c0: 6c5f 6572 726f 7273 2c0a 2020 2020 2020  l_errors,.      
-000211d0: 2020 2020 2020 6f6e 6c79 5f72 6573 706f        only_respo
-000211e0: 6e73 655f 7469 6d65 733d 6f6e 6c79 5f72  nse_times=only_r
-000211f0: 6573 706f 6e73 655f 7469 6d65 732c 0a20  esponse_times,. 
-00021200: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-00021210: 7574 3d74 696d 656f 7574 2c0a 2020 2020  ut=timeout,.    
-00021220: 2020 2020 2020 2020 7275 6e5f 7465 7374          run_test
-00021230: 733d 7275 6e5f 7465 7374 732c 0a20 2020  s=run_tests,.   
-00021240: 2020 2020 2020 2020 2061 735f 7374 616e           as_stan
-00021250: 6461 7264 3d61 735f 7374 616e 6461 7264  dard=as_standard
-00021260: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-00021270: 7374 735f 746f 5f72 756e 3d74 6573 7473  sts_to_run=tests
-00021280: 5f74 6f5f 7275 6e2c 0a20 2020 2020 2020  _to_run,.       
-00021290: 2020 2020 2074 6573 7473 5f74 6f5f 7361       tests_to_sa
-000212a0: 6d70 6c65 5f62 795f 7061 7261 6d73 3d74  mple_by_params=t
-000212b0: 6573 7473 5f74 6f5f 7361 6d70 6c65 5f62  ests_to_sample_b
-000212c0: 795f 7061 7261 6d73 2c0a 2020 2020 2020  y_params,.      
-000212d0: 2020 2020 2020 7465 7374 735f 6669 6c74        tests_filt
-000212e0: 6572 5f62 793d 7465 7374 735f 6669 6c74  er_by=tests_filt
-000212f0: 6572 5f62 792c 0a20 2020 2020 2020 2020  er_by,.         
-00021300: 2020 2074 6573 7473 5f66 6169 6c66 6173     tests_failfas
-00021310: 743d 7465 7374 735f 6661 696c 6661 7374  t=tests_failfast
-00021320: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-00021330: 7374 735f 6967 6e6f 7265 5f6f 7264 6572  sts_ignore_order
-00021340: 3d74 6573 7473 5f69 676e 6f72 655f 6f72  =tests_ignore_or
-00021350: 6465 722c 0a20 2020 2020 2020 2020 2020  der,.           
-00021360: 2074 6573 7473 5f76 616c 6964 6174 655f   tests_validate_
-00021370: 7072 6f63 6573 7365 645f 6279 7465 733d  processed_bytes=
-00021380: 7465 7374 735f 7661 6c69 6461 7465 5f70  tests_validate_p
-00021390: 726f 6365 7373 6564 5f62 7974 6573 2c0a  rocessed_bytes,.
-000213a0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
-000213b0: 7269 6465 5f64 6174 6173 6f75 7263 653d  ride_datasource=
-000213c0: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
-000213d0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-000213e0: 2074 6573 7473 5f63 6865 636b 5f72 6571   tests_check_req
-000213f0: 7565 7374 735f 6672 6f6d 5f62 7261 6e63  uests_from_branc
-00021400: 683d 7465 7374 735f 6368 6563 6b5f 7265  h=tests_check_re
-00021410: 7175 6573 7473 5f66 726f 6d5f 6272 616e  quests_from_bran
-00021420: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
-00021430: 666f 726b 5f64 6f77 6e73 7472 6561 6d3d  fork_downstream=
-00021440: 666f 726b 5f64 6f77 6e73 7472 6561 6d2c  fork_downstream,
-00021450: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00021460: 6b3d 666f 726b 2c0a 2020 2020 2020 2020  k=fork,.        
-00021470: 290a 2020 2020 656c 6966 2072 5b22 7265  ).    elif r["re
-00021480: 736f 7572 6365 225d 203d 3d20 2264 6174  source"] == "dat
-00021490: 6173 6f75 7263 6573 223a 0a20 2020 2020  asources":.     
-000214a0: 2020 2061 7761 6974 206e 6577 5f64 7328     await new_ds(
-000214b0: 0a20 2020 2020 2020 2020 2020 2072 2c0a  .            r,.
-000214c0: 2020 2020 2020 2020 2020 2020 7462 5f63              tb_c
-000214d0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-000214e0: 2020 2075 7365 725f 746f 6b65 6e2c 0a20     user_token,. 
-000214f0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-00021500: 2c0a 2020 2020 2020 2020 2020 2020 736b  ,.            sk
-00021510: 6970 5f63 6f6e 6669 726d 6174 696f 6e3d  ip_confirmation=
-00021520: 736b 6970 5f63 6f6e 6669 726d 6174 696f  skip_confirmatio
-00021530: 6e2c 0a20 2020 2020 2020 2020 2020 2063  n,.            c
-00021540: 7572 7265 6e74 5f77 733d 6375 7272 656e  urrent_ws=curren
-00021550: 745f 7773 2c0a 2020 2020 2020 2020 2020  t_ws,.          
-00021560: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
-00021570: 6d3d 666f 726b 5f64 6f77 6e73 7472 6561  m=fork_downstrea
-00021580: 6d2c 0a20 2020 2020 2020 2020 2020 2066  m,.            f
-00021590: 6f72 6b3d 666f 726b 2c0a 2020 2020 2020  ork=fork,.      
-000215a0: 2020 2020 2020 6769 745f 7265 6c65 6173        git_releas
-000215b0: 653d 6769 745f 7265 6c65 6173 652c 0a20  e=git_release,. 
-000215c0: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
-000215d0: 6620 725b 2272 6573 6f75 7263 6522 5d20  f r["resource"] 
-000215e0: 3d3d 2022 746f 6b65 6e73 223a 0a20 2020  == "tokens":.   
-000215f0: 2020 2020 2061 7761 6974 206e 6577 5f74       await new_t
-00021600: 6f6b 656e 2872 2c20 7462 5f63 6c69 656e  oken(r, tb_clien
-00021610: 742c 2066 6f72 6365 290a 2020 2020 656c  t, force).    el
-00021620: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-00021630: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-00021640: 6570 7469 6f6e 2846 6565 6462 6163 6b4d  eption(FeedbackM
-00021650: 616e 6167 6572 2e65 7272 6f72 5f75 6e6b  anager.error_unk
-00021660: 6e6f 776e 5f72 6573 6f75 7263 6528 7265  nown_resource(re
-00021670: 736f 7572 6365 3d72 5b22 7265 736f 7572  source=r["resour
-00021680: 6365 225d 2929 0a0a 0a64 6566 2067 6574  ce"]))...def get
-00021690: 5f6e 616d 655f 7665 7273 696f 6e28 6473  _name_version(ds
-000216a0: 3a20 7374 7229 202d 3e20 4469 6374 5b73  : str) -> Dict[s
-000216b0: 7472 2c20 416e 795d 3a0a 2020 2020 2222  tr, Any]:.    ""
-000216c0: 220a 2020 2020 4769 7665 6e20 6120 6e61  ".    Given a na
-000216d0: 6d65 206c 696b 6520 226e 616d 655f 5f64  me like "name__d
-000216e0: 6576 5f5f 7630 2220 7265 7475 726e 7320  ev__v0" returns 
-000216f0: 5b27 6e61 6d65 272c 2027 6465 7627 2c20  ['name', 'dev', 
-00021700: 2776 3027 5d0a 2020 2020 3e3e 3e20 6765  'v0'].    >>> ge
-00021710: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
-00021720: 6465 765f 5f6e 616d 655f 5f76 3027 290a  dev__name__v0').
-00021730: 2020 2020 7b27 6e61 6d65 273a 2027 6465      {'name': 'de
-00021740: 765f 5f6e 616d 6527 2c20 2776 6572 7369  v__name', 'versi
-00021750: 6f6e 273a 2030 7d0a 2020 2020 3e3e 3e20  on': 0}.    >>> 
-00021760: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
-00021770: 2827 6e61 6d65 5f5f 7630 2729 0a20 2020  ('name__v0').   
-00021780: 207b 276e 616d 6527 3a20 276e 616d 6527   {'name': 'name'
-00021790: 2c20 2776 6572 7369 6f6e 273a 2030 7d0a  , 'version': 0}.
-000217a0: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
-000217b0: 5f76 6572 7369 6f6e 2827 6465 765f 5f6e  _version('dev__n
-000217c0: 616d 6527 290a 2020 2020 7b27 6e61 6d65  ame').    {'name
-000217d0: 273a 2027 6465 765f 5f6e 616d 6527 2c20  ': 'dev__name', 
-000217e0: 2776 6572 7369 6f6e 273a 204e 6f6e 657d  'version': None}
-000217f0: 0a20 2020 203e 3e3e 2067 6574 5f6e 616d  .    >>> get_nam
-00021800: 655f 7665 7273 696f 6e28 276e 616d 6527  e_version('name'
+0001e2a0: 290a 0a20 2020 2020 2020 2065 7863 6570  )..        excep
+0001e2b0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0001e2c0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0001e2d0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0001e2e0: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0001e2f0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f63  kManager.error_c
+0001e300: 7265 6174 696e 675f 6461 7461 736f 7572  reating_datasour
+0001e310: 6365 2865 7272 6f72 3d73 7472 2865 2929  ce(error=str(e))
+0001e320: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001e330: 0a0a 2020 2020 6966 206e 6f74 2066 6f72  ..    if not for
+0001e340: 6365 3a0a 2020 2020 2020 2020 7261 6973  ce:.        rais
+0001e350: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
+0001e360: 6570 7469 6f6e 2846 6565 6462 6163 6b4d  eption(FeedbackM
+0001e370: 616e 6167 6572 2e65 7272 6f72 5f64 6174  anager.error_dat
+0001e380: 6173 6f75 7263 655f 616c 7265 6164 795f  asource_already_
+0001e390: 6578 6973 7473 2864 6174 6173 6f75 7263  exists(datasourc
+0001e3a0: 653d 6473 5f6e 616d 6529 290a 0a20 2020  e=ds_name))..   
+0001e3b0: 2069 6620 6473 2e67 6574 2822 7368 6172   if ds.get("shar
+0001e3c0: 6564 5f77 6974 6822 2c20 5b5d 2920 6f72  ed_with", []) or
+0001e3d0: 2065 7869 7374 696e 675f 6473 2e67 6574   existing_ds.get
+0001e3e0: 2822 7368 6172 6564 5f77 6974 6822 2c20  ("shared_with", 
+0001e3f0: 5b5d 293a 0a20 2020 2020 2020 2069 6620  []):.        if 
+0001e400: 6e6f 7420 7573 6572 5f74 6f6b 656e 3a0a  not user_token:.
+0001e410: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+0001e420: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
+0001e430: 616e 6167 6572 2e69 6e66 6f5f 736b 6970  anager.info_skip
+0001e440: 7069 6e67 5f73 6861 7265 645f 7769 7468  ping_shared_with
+0001e450: 5f65 6e74 7279 2829 290a 2020 2020 2020  _entry()).      
+0001e460: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001e470: 2020 2020 6177 6169 7420 7368 6172 655f      await share_
+0001e480: 616e 645f 756e 7368 6172 655f 6461 7461  and_unshare_data
+0001e490: 736f 7572 6365 280a 2020 2020 2020 2020  source(.        
+0001e4a0: 2020 2020 2020 2020 636c 6965 6e74 2c0a          client,.
+0001e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4c0: 6578 6973 7469 6e67 5f64 732c 0a20 2020  existing_ds,.   
+0001e4d0: 2020 2020 2020 2020 2020 2020 2075 7365               use
+0001e4e0: 725f 746f 6b65 6e2c 0a20 2020 2020 2020  r_token,.       
+0001e4f0: 2020 2020 2020 2020 2065 7869 7374 696e           existin
+0001e500: 675f 6473 2e67 6574 2822 7368 6172 6564  g_ds.get("shared
+0001e510: 5f77 6974 6822 2c20 5b5d 292c 0a20 2020  _with", []),.   
+0001e520: 2020 2020 2020 2020 2020 2020 2064 732e               ds.
+0001e530: 6765 7428 2273 6861 7265 645f 7769 7468  get("shared_with
+0001e540: 222c 205b 5d29 2c0a 2020 2020 2020 2020  ", []),.        
+0001e550: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+0001e560: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
+0001e570: 290a 0a20 2020 2061 6c74 6572 5f72 6573  )..    alter_res
+0001e580: 706f 6e73 6520 3d20 4e6f 6e65 0a20 2020  ponse = None.   
+0001e590: 2061 6c74 6572 5f65 7272 6f72 5f6d 6573   alter_error_mes
+0001e5a0: 7361 6765 203d 204e 6f6e 650a 2020 2020  sage = None.    
+0001e5b0: 6e65 775f 6465 7363 7269 7074 696f 6e20  new_description 
+0001e5c0: 3d20 4e6f 6e65 0a20 2020 206e 6577 5f73  = None.    new_s
+0001e5d0: 6368 656d 6120 3d20 4e6f 6e65 0a20 2020  chema = None.   
+0001e5e0: 206e 6577 5f69 6e64 6963 6573 203d 204e   new_indices = N
+0001e5f0: 6f6e 650a 2020 2020 6e65 775f 7474 6c20  one.    new_ttl 
+0001e600: 3d20 4e6f 6e65 0a0a 2020 2020 7472 793a  = None..    try:
+0001e610: 0a20 2020 2020 2020 2069 6620 6461 7461  .        if data
+0001e620: 736f 7572 6365 5f65 7869 7374 7320 616e  source_exists an
+0001e630: 6420 6473 5b22 7061 7261 6d73 225d 5b22  d ds["params"]["
+0001e640: 6465 7363 7269 7074 696f 6e22 5d20 213d  description"] !=
+0001e650: 2065 7869 7374 696e 675f 6473 5b22 6465   existing_ds["de
+0001e660: 7363 7269 7074 696f 6e22 5d3a 0a20 2020  scription"]:.   
+0001e670: 2020 2020 2020 2020 206e 6577 5f64 6573           new_des
+0001e680: 6372 6970 7469 6f6e 203d 2064 735b 2270  cription = ds["p
+0001e690: 6172 616d 7322 5d5b 2264 6573 6372 6970  arams"]["descrip
+0001e6a0: 7469 6f6e 225d 0a0a 2020 2020 2020 2020  tion"]..        
+0001e6b0: 6966 2064 6174 6173 6f75 7263 655f 6578  if datasource_ex
+0001e6c0: 6973 7473 2061 6e64 2064 735b 2270 6172  ists and ds["par
+0001e6d0: 616d 7322 5d2e 6765 7428 2265 6e67 696e  ams"].get("engin
+0001e6e0: 655f 7474 6c22 2920 213d 2065 7869 7374  e_ttl") != exist
+0001e6f0: 696e 675f 6473 5b22 656e 6769 6e65 225d  ing_ds["engine"]
+0001e700: 2e67 6574 2822 7474 6c22 293a 0a20 2020  .get("ttl"):.   
+0001e710: 2020 2020 2020 2020 206e 6577 5f74 746c           new_ttl
+0001e720: 203d 2064 735b 2270 6172 616d 7322 5d2e   = ds["params"].
+0001e730: 6765 7428 2265 6e67 696e 655f 7474 6c22  get("engine_ttl"
+0001e740: 2c20 2266 616c 7365 2229 0a0a 2020 2020  , "false")..    
+0001e750: 2020 2020 2320 5363 6865 6d61 2066 6978      # Schema fix
+0001e760: 6564 2062 7920 7468 6520 6b61 666b 6120  ed by the kafka 
+0001e770: 636f 6e6e 6563 746f 720a 2020 2020 2020  connector.      
+0001e780: 2020 6966 2064 6174 6173 6f75 7263 655f    if datasource_
+0001e790: 6578 6973 7473 2061 6e64 2028 0a20 2020  exists and (.   
+0001e7a0: 2020 2020 2020 2020 2064 735b 2270 6172           ds["par
+0001e7b0: 616d 7322 5d5b 2273 6368 656d 6122 5d2e  ams"]["schema"].
+0001e7c0: 7265 706c 6163 6528 2220 222c 2022 2229  replace(" ", "")
+0001e7d0: 2021 3d20 6578 6973 7469 6e67 5f64 735b   != existing_ds[
+0001e7e0: 2273 6368 656d 6122 5d5b 2273 716c 5f73  "schema"]["sql_s
+0001e7f0: 6368 656d 6122 5d2e 7265 706c 6163 6528  chema"].replace(
+0001e800: 2220 222c 2022 2229 0a20 2020 2020 2020  " ", "").       
+0001e810: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0001e820: 6e65 775f 7363 6865 6d61 203d 2064 735b  new_schema = ds[
+0001e830: 2270 6172 616d 7322 5d5b 2273 6368 656d  "params"]["schem
+0001e840: 6122 5d0a 0a20 2020 2020 2020 2069 6620  a"]..        if 
+0001e850: 6461 7461 736f 7572 6365 5f65 7869 7374  datasource_exist
+0001e860: 733a 0a20 2020 2020 2020 2020 2020 206e  s:.            n
+0001e870: 6577 203d 205b 6173 6469 6374 2869 6e64  ew = [asdict(ind
+0001e880: 6578 2920 666f 7220 696e 6465 7820 696e  ex) for index in
+0001e890: 2064 732e 6765 7428 2270 6172 616d 7322   ds.get("params"
+0001e8a0: 2c20 7b7d 292e 6765 7428 2269 6e64 6578  , {}).get("index
+0001e8b0: 6573 5f6c 6973 7422 2c20 5b5d 295d 0a20  es_list", [])]. 
+0001e8c0: 2020 2020 2020 2020 2020 2065 7869 7374             exist
+0001e8d0: 696e 6720 3d20 6578 6973 7469 6e67 5f64  ing = existing_d
+0001e8e0: 732e 6765 7428 2269 6e64 6578 6573 222c  s.get("indexes",
+0001e8f0: 205b 5d29 0a20 2020 2020 2020 2020 2020   []).           
+0001e900: 206e 6577 2e73 6f72 7428 6b65 793d 6c61   new.sort(key=la
+0001e910: 6d62 6461 2078 3a20 785b 226e 616d 6522  mbda x: x["name"
+0001e920: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
+0001e930: 7869 7374 696e 672e 736f 7274 286b 6579  xisting.sort(key
+0001e940: 3d6c 616d 6264 6120 783a 2078 5b22 6e61  =lambda x: x["na
+0001e950: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
+0001e960: 2020 6966 206c 656e 2865 7869 7374 696e    if len(existin
+0001e970: 6729 2021 3d20 6c65 6e28 6e65 7729 206f  g) != len(new) o
+0001e980: 7220 616e 7928 5b28 642c 2064 3229 2066  r any([(d, d2) f
+0001e990: 6f72 2064 2c20 6432 2069 6e20 7a69 7028  or d, d2 in zip(
+0001e9a0: 6e65 772c 2065 7869 7374 696e 6729 2069  new, existing) i
+0001e9b0: 6620 6420 213d 2064 325d 293a 0a20 2020  f d != d2]):.   
+0001e9c0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0001e9d0: 5f69 6e64 6963 6573 203d 2064 732e 6765  _indices = ds.ge
+0001e9e0: 7428 2270 6172 616d 7322 2c20 7b7d 292e  t("params", {}).
+0001e9f0: 6765 7428 2269 6e64 6578 6573 2229 206f  get("indexes") o
+0001ea00: 7220 2230 220a 2020 2020 2020 2020 6966  r "0".        if
+0001ea10: 206e 6577 5f64 6573 6372 6970 7469 6f6e   new_description
+0001ea20: 206f 7220 6e65 775f 7363 6865 6d61 206f   or new_schema o
+0001ea30: 7220 6e65 775f 7474 6c20 6f72 2028 6e65  r new_ttl or (ne
+0001ea40: 775f 696e 6469 6365 7320 6973 206e 6f74  w_indices is not
+0001ea50: 204e 6f6e 6529 2061 6e64 2028 6e6f 7420   None) and (not 
+0001ea60: 666f 726b 5f64 6f77 6e73 7472 6561 6d20  fork_downstream 
+0001ea70: 6f72 206e 6f74 2066 6f72 6b29 3a0a 2020  or not fork):.  
+0001ea80: 2020 2020 2020 2020 2020 616c 7465 725f            alter_
+0001ea90: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+0001eaa0: 2063 6c69 656e 742e 616c 7465 725f 6461   client.alter_da
+0001eab0: 7461 736f 7572 6365 280a 2020 2020 2020  tasource(.      
+0001eac0: 2020 2020 2020 2020 2020 6473 5f6e 616d            ds_nam
+0001ead0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001eae0: 2020 206e 6577 5f73 6368 656d 613d 6e65     new_schema=ne
+0001eaf0: 775f 7363 6865 6d61 2c0a 2020 2020 2020  w_schema,.      
+0001eb00: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0001eb10: 7074 696f 6e3d 6e65 775f 6465 7363 7269  ption=new_descri
+0001eb20: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
+0001eb30: 2020 2020 2020 2074 746c 3d6e 6577 5f74         ttl=new_t
+0001eb40: 746c 2c0a 2020 2020 2020 2020 2020 2020  tl,.            
+0001eb50: 2020 2020 6472 795f 7275 6e3d 5472 7565      dry_run=True
+0001eb60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001eb70: 2020 696e 6465 7865 733d 6e65 775f 696e    indexes=new_in
+0001eb80: 6469 6365 732c 0a20 2020 2020 2020 2020  dices,.         
+0001eb90: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
+0001eba0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0001ebb0: 2020 2020 2020 2020 6966 2022 5468 6572          if "Ther
+0001ebc0: 6520 7765 7265 206e 6f20 6f70 6572 6174  e were no operat
+0001ebd0: 696f 6e73 2074 6f20 7065 7266 6f72 6d22  ions to perform"
+0001ebe0: 2069 6e20 7374 7228 6529 3a0a 2020 2020   in str(e):.    
+0001ebf0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+0001ec00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001ec10: 2020 2020 2020 2061 6c74 6572 5f65 7272         alter_err
+0001ec20: 6f72 5f6d 6573 7361 6765 203d 2073 7472  or_message = str
+0001ec30: 2865 290a 0a20 2020 2069 6620 616c 7465  (e)..    if alte
+0001ec40: 725f 7265 7370 6f6e 7365 3a0a 2020 2020  r_response:.    
+0001ec50: 2020 2020 6966 2067 6974 5f72 656c 6561      if git_relea
+0001ec60: 7365 2061 6e64 206e 6f74 2073 6b69 705f  se and not skip_
+0001ec70: 636f 6e66 6972 6d61 7469 6f6e 3a0a 2020  confirmation:.  
+0001ec80: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+0001ec90: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+0001eca0: 6167 6572 2e69 6e66 6f5f 6375 7374 6f6d  ager.info_custom
+0001ecb0: 5f64 6570 6c6f 796d 656e 7428 2929 0a20  _deployment()). 
+0001ecc0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0001ecd0: 2e65 6368 6f28 222a 2a2a 2a2a 2a2a 2a2a  .echo("*********
+0001ece0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001ecf0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2229  **************")
+0001ed00: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001ed10: 636b 2e65 6368 6f28 222a 2a2a 2a2a 2a2a  ck.echo("*******
+0001ed20: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001ed30: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001ed40: 2229 0a20 2020 2020 2020 2063 6c69 636b  ").        click
+0001ed50: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+0001ed60: 6e61 6765 722e 696e 666f 5f64 6174 6173  nager.info_datas
+0001ed70: 6f75 7263 655f 646f 6573 6e74 5f6d 6174  ource_doesnt_mat
+0001ed80: 6368 2864 6174 6173 6f75 7263 653d 6473  ch(datasource=ds
+0001ed90: 5f6e 616d 6529 290a 2020 2020 2020 2020  _name)).        
+0001eda0: 666f 7220 6f70 6572 6174 696f 6e20 696e  for operation in
+0001edb0: 2061 6c74 6572 5f72 6573 706f 6e73 655b   alter_response[
+0001edc0: 226f 7065 7261 7469 6f6e 7322 5d3a 0a20  "operations"]:. 
+0001edd0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0001ede0: 2e65 6368 6f28 6622 2a2a 2020 202d 2020  .echo(f"**   -  
+0001edf0: 7b6f 7065 7261 7469 6f6e 7d22 290a 0a20  {operation}").. 
+0001ee00: 2020 2020 2020 2069 6620 736b 6970 5f63         if skip_c
+0001ee10: 6f6e 6669 726d 6174 696f 6e3a 0a20 2020  onfirmation:.   
+0001ee20: 2020 2020 2020 2020 206d 616b 655f 6368           make_ch
+0001ee30: 616e 6765 7320 3d20 5472 7565 0a20 2020  anges = True.   
+0001ee40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001ee50: 2020 2020 2020 206d 616b 655f 6368 616e         make_chan
+0001ee60: 6765 7320 3d20 636c 6963 6b2e 7072 6f6d  ges = click.prom
+0001ee70: 7074 2846 6565 6462 6163 6b4d 616e 6167  pt(FeedbackManag
+0001ee80: 6572 2e69 6e66 6f5f 6173 6b5f 666f 725f  er.info_ask_for_
+0001ee90: 616c 7465 725f 636f 6e66 6972 6d61 7469  alter_confirmati
+0001eea0: 6f6e 2829 292e 6c6f 7765 7228 2920 3d3d  on()).lower() ==
+0001eeb0: 2022 7922 0a0a 2020 2020 2020 2020 6966   "y"..        if
+0001eec0: 206d 616b 655f 6368 616e 6765 733a 0a20   make_changes:. 
+0001eed0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001eee0: 2063 6c69 656e 742e 616c 7465 725f 6461   client.alter_da
+0001eef0: 7461 736f 7572 6365 280a 2020 2020 2020  tasource(.      
+0001ef00: 2020 2020 2020 2020 2020 6473 5f6e 616d            ds_nam
+0001ef10: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001ef20: 2020 206e 6577 5f73 6368 656d 613d 6e65     new_schema=ne
+0001ef30: 775f 7363 6865 6d61 2c0a 2020 2020 2020  w_schema,.      
+0001ef40: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0001ef50: 7074 696f 6e3d 6e65 775f 6465 7363 7269  ption=new_descri
+0001ef60: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
+0001ef70: 2020 2020 2020 2074 746c 3d6e 6577 5f74         ttl=new_t
+0001ef80: 746c 2c0a 2020 2020 2020 2020 2020 2020  tl,.            
+0001ef90: 2020 2020 6472 795f 7275 6e3d 4661 6c73      dry_run=Fals
+0001efa0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001efb0: 2020 2069 6e64 6578 6573 3d6e 6577 5f69     indexes=new_i
+0001efc0: 6e64 6963 6573 2c0a 2020 2020 2020 2020  ndices,.        
+0001efd0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001efe0: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
+0001eff0: 6462 6163 6b4d 616e 6167 6572 2e73 7563  dbackManager.suc
+0001f000: 6365 7373 5f64 6174 6173 6f75 7263 655f  cess_datasource_
+0001f010: 616c 7465 7228 2929 0a20 2020 2020 2020  alter()).       
+0001f020: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001f030: 2020 2061 6c74 6572 5f65 7272 6f72 5f6d     alter_error_m
+0001f040: 6573 7361 6765 203d 2022 416c 7465 7220  essage = "Alter 
+0001f050: 6461 7461 736f 7572 6365 2063 616e 6365  datasource cance
+0001f060: 6c6c 6564 220a 0a20 2020 2069 6620 616c  lled"..    if al
+0001f070: 7465 725f 6572 726f 725f 6d65 7373 6167  ter_error_messag
+0001f080: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
+0001f090: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0001f0a0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+0001f0b0: 2020 2046 6565 6462 6163 6b4d 616e 6167     FeedbackManag
+0001f0c0: 6572 2e65 7272 6f72 5f64 6174 6173 6f75  er.error_datasou
+0001f0d0: 7263 655f 616c 7265 6164 795f 6578 6973  rce_already_exis
+0001f0e0: 7473 5f61 6e64 5f61 6c74 6572 5f66 6169  ts_and_alter_fai
+0001f0f0: 6c65 6428 0a20 2020 2020 2020 2020 2020  led(.           
+0001f100: 2020 2020 2064 6174 6173 6f75 7263 653d       datasource=
+0001f110: 6473 5f6e 616d 652c 2061 6c74 6572 5f65  ds_name, alter_e
+0001f120: 7272 6f72 5f6d 6573 7361 6765 3d61 6c74  rror_message=alt
+0001f130: 6572 5f65 7272 6f72 5f6d 6573 7361 6765  er_error_message
+0001f140: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001f150: 2020 2020 2020 2029 0a0a 2020 2020 6966         )..    if
+0001f160: 2064 6174 6173 6f75 7263 655f 6578 6973   datasource_exis
+0001f170: 7473 2061 6e64 2064 735b 2270 6172 616d  ts and ds["param
+0001f180: 7322 5d2e 6765 7428 2262 6163 6b66 696c  s"].get("backfil
+0001f190: 6c5f 636f 6c75 6d6e 2229 2021 3d20 6578  l_column") != ex
+0001f1a0: 6973 7469 6e67 5f64 735b 2274 6167 7322  isting_ds["tags"
+0001f1b0: 5d2e 6765 7428 2262 6163 6b66 696c 6c5f  ].get("backfill_
+0001f1c0: 636f 6c75 6d6e 2229 3a0a 2020 2020 2020  column"):.      
+0001f1d0: 2020 7061 7261 6d73 203d 207b 0a20 2020    params = {.   
+0001f1e0: 2020 2020 2020 2020 2022 6261 636b 6669           "backfi
+0001f1f0: 6c6c 5f63 6f6c 756d 6e22 3a20 6473 5b22  ll_column": ds["
+0001f200: 7061 7261 6d73 225d 2e67 6574 2822 6261  params"].get("ba
+0001f210: 636b 6669 6c6c 5f63 6f6c 756d 6e22 292c  ckfill_column"),
+0001f220: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0001f230: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001f240: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001f250: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001f260: 696e 666f 5f75 7064 6174 655f 6461 7461  info_update_data
+0001f270: 736f 7572 6365 2864 6174 6173 6f75 7263  source(datasourc
+0001f280: 653d 6473 5f6e 616d 652c 2070 6172 616d  e=ds_name, param
+0001f290: 733d 7061 7261 6d73 2929 0a20 2020 2020  s=params)).     
+0001f2a0: 2020 2020 2020 2061 7761 6974 2063 6c69         await cli
+0001f2b0: 656e 742e 7570 6461 7465 5f64 6174 6173  ent.update_datas
+0001f2c0: 6f75 7263 6528 6473 5f6e 616d 652c 2070  ource(ds_name, p
+0001f2d0: 6172 616d 7329 0a20 2020 2020 2020 2020  arams).         
+0001f2e0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+0001f2f0: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
+0001f300: 6363 6573 735f 7570 6461 7465 5f64 6174  ccess_update_dat
+0001f310: 6173 6f75 7263 6528 6461 7461 736f 7572  asource(datasour
+0001f320: 6365 3d64 735f 6e61 6d65 2c20 7061 7261  ce=ds_name, para
+0001f330: 6d73 3d70 6172 616d 7329 290a 2020 2020  ms=params)).    
+0001f340: 2020 2020 2020 2020 6d61 6b65 5f63 6861          make_cha
+0001f350: 6e67 6573 203d 2054 7275 650a 2020 2020  nges = True.    
+0001f360: 2020 2020 2020 2020 616c 7465 725f 7265          alter_re
+0001f370: 7370 6f6e 7365 203d 2054 7275 650a 2020  sponse = True.  
+0001f380: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0001f390: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0001f3a0: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+0001f3b0: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0001f3c0: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+0001f3d0: 6765 722e 6572 726f 725f 7570 6461 7469  ger.error_updati
+0001f3e0: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+0001f3f0: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+0001f400: 2c20 6572 726f 723d 7374 7228 6529 2929  , error=str(e)))
+0001f410: 0a0a 2020 2020 636f 6e6e 6563 746f 725f  ..    connector_
+0001f420: 6461 7461 203d 204e 6f6e 650a 2020 2020  data = None.    
+0001f430: 7072 6f6d 6f74 655f 6572 726f 725f 6d65  promote_error_me
+0001f440: 7373 6167 6520 3d20 4e6f 6e65 0a0a 2020  ssage = None..  
+0001f450: 2020 6473 5f70 6172 616d 7320 3d20 6473    ds_params = ds
+0001f460: 5b22 7061 7261 6d73 225d 0a20 2020 2073  ["params"].    s
+0001f470: 6572 7669 6365 203d 2064 735f 7061 7261  ervice = ds_para
+0001f480: 6d73 2e67 6574 2822 7365 7276 6963 6522  ms.get("service"
+0001f490: 290a 2020 2020 4441 5441 534f 5552 4345  ).    DATASOURCE
+0001f4a0: 5f56 414c 4944 5f53 4552 5649 4345 535f  _VALID_SERVICES_
+0001f4b0: 544f 5f55 5044 4154 4520 3d20 5b22 6269  TO_UPDATE = ["bi
+0001f4c0: 6771 7565 7279 222c 2022 736e 6f77 666c  gquery", "snowfl
+0001f4d0: 616b 6522 5d0a 2020 2020 6966 2064 6174  ake"].    if dat
+0001f4e0: 6173 6f75 7263 655f 6578 6973 7473 2061  asource_exists a
+0001f4f0: 6e64 2073 6572 7669 6365 2061 6e64 2073  nd service and s
+0001f500: 6572 7669 6365 2069 6e20 5b2a 4441 5441  ervice in [*DATA
+0001f510: 534f 5552 4345 5f56 414c 4944 5f53 4552  SOURCE_VALID_SER
+0001f520: 5649 4345 535f 544f 5f55 5044 4154 452c  VICES_TO_UPDATE,
+0001f530: 202a 5052 4556 4945 575f 434f 4e4e 4543   *PREVIEW_CONNEC
+0001f540: 544f 525f 5345 5256 4943 4553 5d3a 0a20  TOR_SERVICES]:. 
+0001f550: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
+0001f560: 5f72 6571 7569 7265 645f 7061 7261 6d73  _required_params
+0001f570: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001f580: 2022 6269 6771 7565 7279 223a 205b 2273   "bigquery": ["s
+0001f590: 6572 7669 6365 222c 2022 6372 6f6e 222c  ervice", "cron",
+0001f5a0: 2022 6578 7465 726e 616c 5f64 6174 615f   "external_data_
+0001f5b0: 736f 7572 6365 225d 2c0a 2020 2020 2020  source"],.      
+0001f5c0: 2020 2020 2020 2273 6e6f 7766 6c61 6b65        "snowflake
+0001f5d0: 223a 205b 2263 6f6e 6e65 6374 6f72 222c  ": ["connector",
+0001f5e0: 2022 7365 7276 6963 6522 2c20 2263 726f   "service", "cro
+0001f5f0: 6e22 2c20 2265 7874 6572 6e61 6c5f 6461  n", "external_da
+0001f600: 7461 5f73 6f75 7263 6522 5d2c 0a20 2020  ta_source"],.   
+0001f610: 2020 2020 2020 2020 2022 7333 223a 205b           "s3": [
+0001f620: 2263 6f6e 6e65 6374 6f72 222c 2022 7365  "connector", "se
+0001f630: 7276 6963 6522 2c20 2263 726f 6e22 2c20  rvice", "cron", 
+0001f640: 2262 7563 6b65 745f 7572 6922 5d2c 0a20  "bucket_uri"],. 
+0001f650: 2020 2020 2020 2020 2020 2022 7333 5f69             "s3_i
+0001f660: 616d 726f 6c65 223a 205b 2263 6f6e 6e65  amrole": ["conne
+0001f670: 6374 6f72 222c 2022 7365 7276 6963 6522  ctor", "service"
+0001f680: 2c20 2263 726f 6e22 2c20 2262 7563 6b65  , "cron", "bucke
+0001f690: 745f 7572 6922 5d2c 0a20 2020 2020 2020  t_uri"],.       
+0001f6a0: 2020 2020 2022 6763 7322 3a20 5b22 636f       "gcs": ["co
+0001f6b0: 6e6e 6563 746f 7222 2c20 2273 6572 7669  nnector", "servi
+0001f6c0: 6365 222c 2022 6372 6f6e 222c 2022 6275  ce", "cron", "bu
+0001f6d0: 636b 6574 5f75 7269 225d 2c0a 2020 2020  cket_uri"],.    
+0001f6e0: 2020 2020 7d2e 6765 7428 7365 7276 6963      }.get(servic
+0001f6f0: 652c 205b 5d29 0a0a 2020 2020 2020 2020  e, [])..        
+0001f700: 6966 206e 6f74 2061 6c6c 286b 6579 2069  if not all(key i
+0001f710: 6e20 6473 5f70 6172 616d 7320 666f 7220  n ds_params for 
+0001f720: 6b65 7920 696e 2063 6f6e 6e65 6374 6f72  key in connector
+0001f730: 5f72 6571 7569 7265 645f 7061 7261 6d73  _required_params
+0001f740: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001f750: 6574 7572 6e0a 0a20 2020 2020 2020 2063  eturn..        c
+0001f760: 6f6e 6e65 6374 6f72 203d 2064 735f 7061  onnector = ds_pa
+0001f770: 7261 6d73 2e67 6574 2822 636f 6e6e 6563  rams.get("connec
+0001f780: 746f 7222 2c20 4e6f 6e65 290a 0a20 2020  tor", None)..   
+0001f790: 2020 2020 2069 6620 7365 7276 6963 6520       if service 
+0001f7a0: 696e 2050 5245 5649 4557 5f43 4f4e 4e45  in PREVIEW_CONNE
+0001f7b0: 4354 4f52 5f53 4552 5649 4345 533a 0a20  CTOR_SERVICES:. 
+0001f7c0: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
+0001f7d0: 6374 6f72 5f69 6420 3d20 6578 6973 7469  ctor_id = existi
+0001f7e0: 6e67 5f64 732e 6765 7428 2263 6f6e 6e65  ng_ds.get("conne
+0001f7f0: 6374 6f72 222c 2022 2229 0a20 2020 2020  ctor", "").     
+0001f800: 2020 2020 2020 2069 6620 6e6f 7420 636f         if not co
+0001f810: 6e6e 6563 746f 725f 6964 3a0a 2020 2020  nnector_id:.    
+0001f820: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001f830: 726e 0a0a 2020 2020 2020 2020 2020 2020  rn..            
+0001f840: 6375 7272 656e 745f 636f 6e6e 6563 746f  current_connecto
+0001f850: 7220 3d20 6177 6169 7420 636c 6965 6e74  r = await client
+0001f860: 2e67 6574 5f63 6f6e 6e65 6374 6f72 5f62  .get_connector_b
+0001f870: 795f 6964 2865 7869 7374 696e 675f 6473  y_id(existing_ds
+0001f880: 2e67 6574 2822 636f 6e6e 6563 746f 7222  .get("connector"
+0001f890: 2c20 2222 2929 0a20 2020 2020 2020 2020  , "")).         
+0001f8a0: 2020 2069 6620 6e6f 7420 6375 7272 656e     if not curren
+0001f8b0: 745f 636f 6e6e 6563 746f 723a 0a20 2020  t_connector:.   
+0001f8c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001f8d0: 7572 6e0a 0a20 2020 2020 2020 2020 2020  urn..           
+0001f8e0: 2069 6620 6375 7272 656e 745f 636f 6e6e   if current_conn
+0001f8f0: 6563 746f 725b 226e 616d 6522 5d20 213d  ector["name"] !=
+0001f900: 2064 735f 7061 7261 6d73 5b22 636f 6e6e   ds_params["conn
+0001f910: 6563 7469 6f6e 225d 3a0a 2020 2020 2020  ection"]:.      
+0001f920: 2020 2020 2020 2020 2020 7061 7261 6d20            param 
+0001f930: 3d20 2263 6f6e 6e65 6374 696f 6e22 0a20  = "connection". 
+0001f940: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001f950: 6174 6166 696c 655f 7061 7261 6d20 3d20  atafile_param = 
+0001f960: 496d 706f 7274 5265 706c 6163 656d 656e  ImportReplacemen
+0001f970: 7473 2e67 6574 5f64 6174 6166 696c 655f  ts.get_datafile_
+0001f980: 7061 7261 6d5f 666f 725f 6c69 6e6b 6572  param_for_linker
+0001f990: 5f70 6172 616d 2873 6572 7669 6365 2c20  _param(service, 
+0001f9a0: 7061 7261 6d29 206f 7220 7061 7261 6d0a  param) or param.
+0001f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f9c0: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
+0001f9d0: 6b45 7863 6570 7469 6f6e 2846 6565 6462  kException(Feedb
+0001f9e0: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+0001f9f0: 5f75 7064 6174 696e 675f 636f 6e6e 6563  _updating_connec
+0001fa00: 746f 725f 6e6f 745f 7375 7070 6f72 7465  tor_not_supporte
+0001fa10: 6428 7061 7261 6d3d 6461 7461 6669 6c65  d(param=datafile
+0001fa20: 5f70 6172 616d 2929 0a0a 2020 2020 2020  _param))..      
+0001fa30: 2020 2020 2020 6c69 6e6b 6572 7320 3d20        linkers = 
+0001fa40: 6375 7272 656e 745f 636f 6e6e 6563 746f  current_connecto
+0001fa50: 722e 6765 7428 226c 696e 6b65 7273 222c  r.get("linkers",
+0001fa60: 205b 5d29 0a20 2020 2020 2020 2020 2020   []).           
+0001fa70: 206c 696e 6b65 7220 3d20 6e65 7874 2828   linker = next((
+0001fa80: 6c69 6e6b 6572 2066 6f72 206c 696e 6b65  linker for linke
+0001fa90: 7220 696e 206c 696e 6b65 7273 2069 6620  r in linkers if 
+0001faa0: 6c69 6e6b 6572 5b22 6461 7461 736f 7572  linker["datasour
+0001fab0: 6365 5f69 6422 5d20 3d3d 2065 7869 7374  ce_id"] == exist
+0001fac0: 696e 675f 6473 5b22 6964 225d 292c 204e  ing_ds["id"]), N
+0001fad0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+0001fae0: 2069 6620 6e6f 7420 6c69 6e6b 6572 3a0a   if not linker:.
+0001faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb00: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0001fb10: 2020 2020 6c69 6e6b 6572 5f73 6574 7469      linker_setti
+0001fb20: 6e67 7320 3d20 6c69 6e6b 6572 2e67 6574  ngs = linker.get
+0001fb30: 2822 7365 7474 696e 6773 222c 207b 7d29  ("settings", {})
+0001fb40: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001fb50: 2070 6172 616d 2c20 7661 6c75 6520 696e   param, value in
+0001fb60: 206c 696e 6b65 725f 7365 7474 696e 6773   linker_settings
+0001fb70: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0001fb80: 2020 2020 2020 2020 2020 6473 5f70 6172            ds_par
+0001fb90: 616d 735f 7661 6c75 6520 3d20 6473 5f70  ams_value = ds_p
+0001fba0: 6172 616d 732e 6765 7428 7061 7261 6d2c  arams.get(param,
+0001fbb0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+0001fbc0: 2020 2020 2020 2069 6620 6473 5f70 6172         if ds_par
+0001fbd0: 616d 735f 7661 6c75 6520 616e 6420 6473  ams_value and ds
+0001fbe0: 5f70 6172 616d 735f 7661 6c75 6520 213d  _params_value !=
+0001fbf0: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
+0001fc00: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0001fc10: 6669 6c65 5f70 6172 616d 203d 2049 6d70  file_param = Imp
+0001fc20: 6f72 7452 6570 6c61 6365 6d65 6e74 732e  ortReplacements.
+0001fc30: 6765 745f 6461 7461 6669 6c65 5f70 6172  get_datafile_par
+0001fc40: 616d 5f66 6f72 5f6c 696e 6b65 725f 7061  am_for_linker_pa
+0001fc50: 7261 6d28 7365 7276 6963 652c 2070 6172  ram(service, par
+0001fc60: 616d 2920 6f72 2070 6172 616d 0a20 2020  am) or param.   
+0001fc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc80: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0001fc90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001fca0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001fcb0: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0001fcc0: 7570 6461 7469 6e67 5f63 6f6e 6e65 6374  updating_connect
+0001fcd0: 6f72 5f6e 6f74 5f73 7570 706f 7274 6564  or_not_supported
+0001fce0: 2870 6172 616d 3d64 6174 6166 696c 655f  (param=datafile_
+0001fcf0: 7061 7261 6d2e 7570 7065 7228 2929 0a20  param.upper()). 
+0001fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001fd20: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0001fd30: 2063 6f6e 6e65 6374 6f72 5f64 6174 6120   connector_data 
+0001fd40: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001fd50: 2263 6f6e 6e65 6374 6f72 223a 2063 6f6e  "connector": con
+0001fd60: 6e65 6374 6f72 2c0a 2020 2020 2020 2020  nector,.        
+0001fd70: 2020 2020 2273 6572 7669 6365 223a 2073      "service": s
+0001fd80: 6572 7669 6365 2c0a 2020 2020 2020 2020  ervice,.        
+0001fd90: 2020 2020 2263 726f 6e22 3a20 6473 5f70      "cron": ds_p
+0001fda0: 6172 616d 732e 6765 7428 2263 726f 6e22  arams.get("cron"
+0001fdb0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0001fdc0: 2020 2020 2022 6578 7465 726e 616c 5f64       "external_d
+0001fdd0: 6174 615f 736f 7572 6365 223a 2064 735f  ata_source": ds_
+0001fde0: 7061 7261 6d73 2e67 6574 2822 6578 7465  params.get("exte
+0001fdf0: 726e 616c 5f64 6174 615f 736f 7572 6365  rnal_data_source
+0001fe00: 222c 204e 6f6e 6529 2c0a 2020 2020 2020  ", None),.      
+0001fe10: 2020 2020 2020 2262 7563 6b65 745f 7572        "bucket_ur
+0001fe20: 6922 3a20 6473 5f70 6172 616d 732e 6765  i": ds_params.ge
+0001fe30: 7428 2262 7563 6b65 745f 7572 6922 2c20  t("bucket_uri", 
+0001fe40: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0001fe50: 2020 2022 6d6f 6465 223a 2064 735f 7061     "mode": ds_pa
+0001fe60: 7261 6d73 2e67 6574 2822 6d6f 6465 222c  rams.get("mode",
+0001fe70: 2022 7265 706c 6163 6522 292c 0a20 2020   "replace"),.   
+0001fe80: 2020 2020 2020 2020 2022 7175 6572 7922           "query"
+0001fe90: 3a20 6473 5f70 6172 616d 732e 6765 7428  : ds_params.get(
+0001fea0: 2271 7565 7279 222c 204e 6f6e 6529 2c0a  "query", None),.
+0001feb0: 2020 2020 2020 2020 2020 2020 2269 6e67              "ing
+0001fec0: 6573 745f 6e6f 7722 3a20 6473 5f70 6172  est_now": ds_par
+0001fed0: 616d 732e 6765 7428 2269 6e67 6573 745f  ams.get("ingest_
+0001fee0: 6e6f 7722 2c20 4661 6c73 6529 2c0a 2020  now", False),.  
+0001fef0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0001ff00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001ff10: 2020 6177 6169 7420 636c 6965 6e74 2e75    await client.u
+0001ff20: 7064 6174 655f 6461 7461 736f 7572 6365  pdate_datasource
+0001ff30: 2864 735f 6e61 6d65 2c20 636f 6e6e 6563  (ds_name, connec
+0001ff40: 746f 725f 6461 7461 290a 2020 2020 2020  tor_data).      
+0001ff50: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+0001ff60: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+0001ff70: 2e73 7563 6365 7373 5f70 726f 6d6f 7469  .success_promoti
+0001ff80: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+0001ff90: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+0001ffa0: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+0001ffb0: 6574 7572 6e0a 2020 2020 2020 2020 6578  eturn.        ex
+0001ffc0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0001ffd0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001ffe0: 2070 726f 6d6f 7465 5f65 7272 6f72 5f6d   promote_error_m
+0001fff0: 6573 7361 6765 203d 2073 7472 2865 290a  essage = str(e).
+00020000: 0a20 2020 2069 6620 616c 7465 725f 7265  .    if alter_re
+00020010: 7370 6f6e 7365 2061 6e64 206d 616b 655f  sponse and make_
+00020020: 6368 616e 6765 733a 0a20 2020 2020 2020  changes:.       
+00020030: 2023 2061 6c74 6572 206f 7065 7261 7469   # alter operati
+00020040: 6f6e 2066 696e 6973 6865 640a 2020 2020  on finished.    
+00020050: 2020 2020 7265 7475 726e 0a20 2020 2023      return.    #
+00020060: 2072 656d 6f76 6564 2072 6570 6c61 6369   removed replaci
+00020070: 6e67 2062 7920 6465 6661 756c 742e 2057  ng by default. W
+00020080: 6865 6e20 6120 6461 7461 736f 7572 6365  hen a datasource
+00020090: 2069 7320 7265 6d6f 7665 6420 6461 7461   is removed data
+000200a0: 2069 730a 2020 2020 2320 7265 6d6f 7665   is.    # remove
+000200b0: 6420 616e 6420 616c 6c20 7468 6520 7265  d and all the re
+000200c0: 6665 7265 6e63 6573 206e 6565 6473 2074  ferences needs t
+000200d0: 6f20 6265 2075 7064 6174 6564 0a20 2020  o be updated.   
+000200e0: 2069 6620 280a 2020 2020 2020 2020 6f73   if (.        os
+000200f0: 2e67 6574 656e 7628 2254 425f 495f 4b4e  .getenv("TB_I_KN
+00020100: 4f57 5f57 4841 545f 495f 414d 5f44 4f49  OW_WHAT_I_AM_DOI
+00020110: 4e47 2229 0a20 2020 2020 2020 2061 6e64  NG").        and
+00020120: 2063 6c69 636b 2e70 726f 6d70 7428 4665   click.prompt(Fe
+00020130: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
+00020140: 666f 5f61 736b 5f66 6f72 5f64 6174 6173  fo_ask_for_datas
+00020150: 6f75 7263 655f 636f 6e66 6972 6d61 7469  ource_confirmati
+00020160: 6f6e 2829 2920 3d3d 2064 735f 6e61 6d65  on()) == ds_name
+00020170: 0a20 2020 2029 3a20 2023 2054 4f44 4f20  .    ):  # TODO 
+00020180: 6d6f 7665 2074 6f20 434c 490a 2020 2020  move to CLI.    
+00020190: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000201a0: 2020 2020 2061 7761 6974 2063 6c69 656e       await clien
+000201b0: 742e 6461 7461 736f 7572 6365 5f64 656c  t.datasource_del
+000201c0: 6574 6528 6473 5f6e 616d 6529 0a20 2020  ete(ds_name).   
+000201d0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+000201e0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
+000201f0: 6765 722e 7375 6363 6573 735f 6465 6c65  ger.success_dele
+00020200: 7465 5f64 6174 6173 6f75 7263 6528 6461  te_datasource(da
+00020210: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+00020220: 2929 0a20 2020 2020 2020 2065 7863 6570  )).        excep
+00020230: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00020240: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+00020250: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+00020260: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+00020270: 6765 722e 6572 726f 725f 7265 6d6f 7669  ger.error_removi
+00020280: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+00020290: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+000202a0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+000202b0: 6e0a 2020 2020 656c 7365 3a0a 2020 2020  n.    else:.    
+000202c0: 2020 2020 6966 2061 6c74 6572 5f65 7272      if alter_err
+000202d0: 6f72 5f6d 6573 7361 6765 3a0a 2020 2020  or_message:.    
+000202e0: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
+000202f0: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
+00020300: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00020310: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
+00020320: 6765 722e 6572 726f 725f 6461 7461 736f  ger.error_dataso
+00020330: 7572 6365 5f61 6c72 6561 6479 5f65 7869  urce_already_exi
+00020340: 7374 735f 616e 645f 616c 7465 725f 6661  sts_and_alter_fa
+00020350: 696c 6564 280a 2020 2020 2020 2020 2020  iled(.          
+00020360: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
+00020370: 7572 6365 3d64 735f 6e61 6d65 2c20 616c  urce=ds_name, al
+00020380: 7465 725f 6572 726f 725f 6d65 7373 6167  ter_error_messag
+00020390: 653d 616c 7465 725f 6572 726f 725f 6d65  e=alter_error_me
+000203a0: 7373 6167 650a 2020 2020 2020 2020 2020  ssage.          
+000203b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000203c0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+000203d0: 2070 726f 6d6f 7465 5f65 7272 6f72 5f6d   promote_error_m
+000203e0: 6573 7361 6765 3a0a 2020 2020 2020 2020  essage:.        
+000203f0: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+00020400: 436c 6963 6b45 7863 6570 7469 6f6e 280a  ClickException(.
+00020410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020420: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00020430: 6572 726f 725f 7072 6f6d 6f74 696e 675f  error_promoting_
+00020440: 6461 7461 736f 7572 6365 2864 6174 6173  datasource(datas
+00020450: 6f75 7263 653d 6473 5f6e 616d 652c 2065  ource=ds_name, e
+00020460: 7272 6f72 3d70 726f 6d6f 7465 5f65 7272  rror=promote_err
+00020470: 6f72 5f6d 6573 7361 6765 290a 2020 2020  or_message).    
+00020480: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00020490: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000204a0: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
+000204b0: 6565 6462 6163 6b4d 616e 6167 6572 2e77  eedbackManager.w
+000204c0: 6172 6e69 6e67 5f64 6174 6173 6f75 7263  arning_datasourc
+000204d0: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
+000204e0: 2864 6174 6173 6f75 7263 653d 6473 5f6e  (datasource=ds_n
+000204f0: 616d 6529 290a 0a0a 6173 796e 6320 6465  ame))...async de
+00020500: 6620 6e65 775f 746f 6b65 6e28 746f 6b65  f new_token(toke
+00020510: 6e3a 2044 6963 745b 7374 722c 2041 6e79  n: Dict[str, Any
+00020520: 5d2c 2063 6c69 656e 743a 2054 696e 7942  ], client: TinyB
+00020530: 2c20 666f 7263 653a 2062 6f6f 6c20 3d20  , force: bool = 
+00020540: 4661 6c73 6529 3a0a 2020 2020 6578 6973  False):.    exis
+00020550: 7469 6e67 5f74 6f6b 656e 203d 204e 6f6e  ting_token = Non
+00020560: 650a 2020 2020 7472 793a 0a20 2020 2020  e.    try:.     
+00020570: 2020 2065 7869 7374 696e 675f 746f 6b65     existing_toke
+00020580: 6e20 3d20 6177 6169 7420 636c 6965 6e74  n = await client
+00020590: 2e74 6f6b 656e 5f67 6574 2874 6f6b 656e  .token_get(token
+000205a0: 5b22 6e61 6d65 225d 290a 2020 2020 6578  ["name"]).    ex
+000205b0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+000205c0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+000205d0: 2020 6966 206e 6f74 2065 7869 7374 696e    if not existin
+000205e0: 675f 746f 6b65 6e3a 0a20 2020 2020 2020  g_token:.       
+000205f0: 2061 7761 6974 2063 6c69 656e 742e 746f   await client.to
+00020600: 6b65 6e5f 6372 6561 7465 2874 6f6b 656e  ken_create(token
+00020610: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00020620: 0a0a 2020 2020 6966 2066 6f72 6365 3a0a  ..    if force:.
+00020630: 2020 2020 2020 2020 4144 4d49 4e5f 5343          ADMIN_SC
+00020640: 4f50 4553 203d 205b 2241 444d 494e 222c  OPES = ["ADMIN",
+00020650: 2022 4144 4d49 4e5f 5553 4552 225d 0a20   "ADMIN_USER"]. 
+00020660: 2020 2020 2020 2069 6620 616e 7928 5b73         if any([s
+00020670: 636f 7065 5b22 7479 7065 225d 2069 6e20  cope["type"] in 
+00020680: 4144 4d49 4e5f 5343 4f50 4553 2066 6f72  ADMIN_SCOPES for
+00020690: 2073 636f 7065 2069 6e20 6578 6973 7469   scope in existi
+000206a0: 6e67 5f74 6f6b 656e 5b22 7363 6f70 6573  ng_token["scopes
+000206b0: 225d 5d29 3a0a 2020 2020 2020 2020 2020  "]]):.          
+000206c0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+000206d0: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+000206e0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+000206f0: 6f72 5f74 6f6b 656e 5f63 616e 6e6f 745f  or_token_cannot_
+00020700: 6265 5f6f 7665 7272 6964 656e 2874 6f6b  be_overriden(tok
+00020710: 656e 3d74 6f6b 656e 5b22 6e61 6d65 225d  en=token["name"]
+00020720: 2929 0a0a 2020 2020 2020 2020 6177 6169  ))..        awai
+00020730: 7420 636c 6965 6e74 2e74 6f6b 656e 5f75  t client.token_u
+00020740: 7064 6174 6528 746f 6b65 6e29 0a20 2020  pdate(token).   
+00020750: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00020760: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+00020770: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+00020780: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+00020790: 725f 746f 6b65 6e5f 616c 7265 6164 795f  r_token_already_
+000207a0: 6578 6973 7473 2874 6f6b 656e 3d74 6f6b  exists(token=tok
+000207b0: 656e 5b22 6e61 6d65 225d 2929 0a0a 0a61  en["name"]))...a
+000207c0: 7379 6e63 2064 6566 2065 7865 635f 6669  sync def exec_fi
+000207d0: 6c65 280a 2020 2020 636f 6e66 6967 3a20  le(.    config: 
+000207e0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+000207f0: 722c 2041 6e79 5d5d 2c0a 2020 2020 723a  r, Any]],.    r:
+00020800: 2044 6963 745b 7374 722c 2041 6e79 5d2c   Dict[str, Any],
+00020810: 0a20 2020 2074 625f 636c 6965 6e74 3a20  .    tb_client: 
+00020820: 5469 6e79 422c 0a20 2020 2066 6f72 6365  TinyB,.    force
+00020830: 3a20 626f 6f6c 2c0a 2020 2020 6368 6563  : bool,.    chec
+00020840: 6b3a 2062 6f6f 6c2c 0a20 2020 2064 6562  k: bool,.    deb
+00020850: 7567 3a20 626f 6f6c 2c0a 2020 2020 706f  ug: bool,.    po
+00020860: 7075 6c61 7465 3a20 626f 6f6c 2c0a 2020  pulate: bool,.  
+00020870: 2020 706f 7075 6c61 7465 5f73 7562 7365    populate_subse
+00020880: 742c 0a20 2020 2070 6f70 756c 6174 655f  t,.    populate_
+00020890: 636f 6e64 6974 696f 6e2c 0a20 2020 2075  condition,.    u
+000208a0: 6e6c 696e 6b5f 6f6e 5f70 6f70 756c 6174  nlink_on_populat
+000208b0: 655f 6572 726f 722c 0a20 2020 2077 6169  e_error,.    wai
+000208c0: 745f 706f 7075 6c61 7465 2c0a 2020 2020  t_populate,.    
+000208d0: 7573 6572 5f74 6f6b 656e 3a20 4f70 7469  user_token: Opti
+000208e0: 6f6e 616c 5b73 7472 5d2c 0a20 2020 206f  onal[str],.    o
+000208f0: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
+00020900: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
+00020910: 2c0a 2020 2020 6967 6e6f 7265 5f73 716c  ,.    ignore_sql
+00020920: 5f65 7272 6f72 733a 2062 6f6f 6c20 3d20  _errors: bool = 
+00020930: 4661 6c73 652c 0a20 2020 2073 6b69 705f  False,.    skip_
+00020940: 636f 6e66 6972 6d61 7469 6f6e 3a20 626f  confirmation: bo
+00020950: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00020960: 6f6e 6c79 5f72 6573 706f 6e73 655f 7469  only_response_ti
+00020970: 6d65 733a 2062 6f6f 6c20 3d20 4661 6c73  mes: bool = Fals
+00020980: 652c 0a20 2020 2072 756e 5f74 6573 7473  e,.    run_tests
+00020990: 3d46 616c 7365 2c0a 2020 2020 6173 5f73  =False,.    as_s
+000209a0: 7461 6e64 6172 643d 4661 6c73 652c 0a20  tandard=False,. 
+000209b0: 2020 2074 6573 7473 5f74 6f5f 7275 6e3a     tests_to_run:
+000209c0: 2069 6e74 203d 2030 2c0a 2020 2020 7465   int = 0,.    te
+000209d0: 7374 735f 746f 5f73 616d 706c 655f 6279  sts_to_sample_by
+000209e0: 5f70 6172 616d 733a 2069 6e74 203d 2030  _params: int = 0
+000209f0: 2c0a 2020 2020 7465 7374 735f 6669 6c74  ,.    tests_filt
+00020a00: 6572 5f62 793a 204f 7074 696f 6e61 6c5b  er_by: Optional[
+00020a10: 4c69 7374 5b73 7472 5d5d 203d 204e 6f6e  List[str]] = Non
+00020a20: 652c 0a20 2020 2074 6573 7473 5f66 6169  e,.    tests_fai
+00020a30: 6c66 6173 743a 2062 6f6f 6c20 3d20 4661  lfast: bool = Fa
+00020a40: 6c73 652c 0a20 2020 2074 6573 7473 5f69  lse,.    tests_i
+00020a50: 676e 6f72 655f 6f72 6465 723a 2062 6f6f  gnore_order: boo
+00020a60: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
+00020a70: 6573 7473 5f76 616c 6964 6174 655f 7072  ests_validate_pr
+00020a80: 6f63 6573 7365 645f 6279 7465 733a 2062  ocessed_bytes: b
+00020a90: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00020aa0: 2074 6573 7473 5f63 6865 636b 5f72 6571   tests_check_req
+00020ab0: 7565 7374 735f 6672 6f6d 5f62 7261 6e63  uests_from_branc
+00020ac0: 683a 2062 6f6f 6c20 3d20 4661 6c73 652c  h: bool = False,
+00020ad0: 0a20 2020 2063 7572 7265 6e74 5f77 733a  .    current_ws:
+00020ae0: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
+00020af0: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
+00020b00: 2c0a 2020 2020 666f 726b 5f64 6f77 6e73  ,.    fork_downs
+00020b10: 7472 6561 6d3a 204f 7074 696f 6e61 6c5b  tream: Optional[
+00020b20: 626f 6f6c 5d20 3d20 4661 6c73 652c 0a20  bool] = False,. 
+00020b30: 2020 2066 6f72 6b3a 204f 7074 696f 6e61     fork: Optiona
+00020b40: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+00020b50: 0a20 2020 2067 6974 5f72 656c 6561 7365  .    git_release
+00020b60: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00020b70: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
+00020b80: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
+00020b90: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+00020ba0: 6564 6261 636b 4d61 6e61 6765 722e 6465  edbackManager.de
+00020bb0: 6275 675f 7275 6e6e 696e 675f 6669 6c65  bug_running_file
+00020bc0: 2866 696c 653d 7070 2e70 666f 726d 6174  (file=pp.pformat
+00020bd0: 2872 2929 290a 2020 2020 6966 2072 5b22  (r))).    if r["
+00020be0: 7265 736f 7572 6365 225d 203d 3d20 2270  resource"] == "p
+00020bf0: 6970 6573 223a 0a20 2020 2020 2020 2061  ipes":.        a
+00020c00: 7761 6974 206e 6577 5f70 6970 6528 0a20  wait new_pipe(. 
+00020c10: 2020 2020 2020 2020 2020 2072 2c0a 2020             r,.  
+00020c20: 2020 2020 2020 2020 2020 7462 5f63 6c69            tb_cli
+00020c30: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00020c40: 2066 6f72 6365 2c0a 2020 2020 2020 2020   force,.        
+00020c50: 2020 2020 6368 6563 6b2c 0a20 2020 2020      check,.     
+00020c60: 2020 2020 2020 2070 6f70 756c 6174 652c         populate,
+00020c70: 0a20 2020 2020 2020 2020 2020 2070 6f70  .            pop
+00020c80: 756c 6174 655f 7375 6273 6574 2c0a 2020  ulate_subset,.  
+00020c90: 2020 2020 2020 2020 2020 706f 7075 6c61            popula
+00020ca0: 7465 5f63 6f6e 6469 7469 6f6e 2c0a 2020  te_condition,.  
+00020cb0: 2020 2020 2020 2020 2020 756e 6c69 6e6b            unlink
+00020cc0: 5f6f 6e5f 706f 7075 6c61 7465 5f65 7272  _on_populate_err
+00020cd0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00020ce0: 7761 6974 5f70 6f70 756c 6174 652c 0a20  wait_populate,. 
+00020cf0: 2020 2020 2020 2020 2020 2069 676e 6f72             ignor
+00020d00: 655f 7371 6c5f 6572 726f 7273 3d69 676e  e_sql_errors=ign
+00020d10: 6f72 655f 7371 6c5f 6572 726f 7273 2c0a  ore_sql_errors,.
+00020d20: 2020 2020 2020 2020 2020 2020 6f6e 6c79              only
+00020d30: 5f72 6573 706f 6e73 655f 7469 6d65 733d  _response_times=
+00020d40: 6f6e 6c79 5f72 6573 706f 6e73 655f 7469  only_response_ti
+00020d50: 6d65 732c 0a20 2020 2020 2020 2020 2020  mes,.           
+00020d60: 2072 756e 5f74 6573 7473 3d72 756e 5f74   run_tests=run_t
+00020d70: 6573 7473 2c0a 2020 2020 2020 2020 2020  ests,.          
+00020d80: 2020 6173 5f73 7461 6e64 6172 643d 6173    as_standard=as
+00020d90: 5f73 7461 6e64 6172 642c 0a20 2020 2020  _standard,.     
+00020da0: 2020 2020 2020 2074 6573 7473 5f74 6f5f         tests_to_
+00020db0: 7275 6e3d 7465 7374 735f 746f 5f72 756e  run=tests_to_run
+00020dc0: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
+00020dd0: 7374 735f 746f 5f73 616d 706c 655f 6279  sts_to_sample_by
+00020de0: 5f70 6172 616d 733d 7465 7374 735f 746f  _params=tests_to
+00020df0: 5f73 616d 706c 655f 6279 5f70 6172 616d  _sample_by_param
+00020e00: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
+00020e10: 6573 7473 5f66 696c 7465 725f 6279 3d74  ests_filter_by=t
+00020e20: 6573 7473 5f66 696c 7465 725f 6279 2c0a  ests_filter_by,.
+00020e30: 2020 2020 2020 2020 2020 2020 7465 7374              test
+00020e40: 735f 6661 696c 6661 7374 3d74 6573 7473  s_failfast=tests
+00020e50: 5f66 6169 6c66 6173 742c 0a20 2020 2020  _failfast,.     
+00020e60: 2020 2020 2020 2074 6573 7473 5f69 676e         tests_ign
+00020e70: 6f72 655f 6f72 6465 723d 7465 7374 735f  ore_order=tests_
+00020e80: 6967 6e6f 7265 5f6f 7264 6572 2c0a 2020  ignore_order,.  
+00020e90: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
+00020ea0: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
+00020eb0: 6564 5f62 7974 6573 3d74 6573 7473 5f76  ed_bytes=tests_v
+00020ec0: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
+00020ed0: 645f 6279 7465 732c 0a20 2020 2020 2020  d_bytes,.       
+00020ee0: 2020 2020 206f 7665 7272 6964 655f 6461       override_da
+00020ef0: 7461 736f 7572 6365 3d6f 7665 7272 6964  tasource=overrid
+00020f00: 655f 6461 7461 736f 7572 6365 2c0a 2020  e_datasource,.  
+00020f10: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
+00020f20: 6368 6563 6b5f 7265 7175 6573 7473 5f66  check_requests_f
+00020f30: 726f 6d5f 6272 616e 6368 3d74 6573 7473  rom_branch=tests
+00020f40: 5f63 6865 636b 5f72 6571 7565 7374 735f  _check_requests_
+00020f50: 6672 6f6d 5f62 7261 6e63 682c 0a20 2020  from_branch,.   
+00020f60: 2020 2020 2020 2020 2066 6f72 6b5f 646f           fork_do
+00020f70: 776e 7374 7265 616d 3d66 6f72 6b5f 646f  wnstream=fork_do
+00020f80: 776e 7374 7265 616d 2c0a 2020 2020 2020  wnstream,.      
+00020f90: 2020 2020 2020 666f 726b 3d66 6f72 6b2c        fork=fork,
+00020fa0: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
+00020fb0: 6c69 6620 725b 2272 6573 6f75 7263 6522  lif r["resource"
+00020fc0: 5d20 3d3d 2022 6461 7461 736f 7572 6365  ] == "datasource
+00020fd0: 7322 3a0a 2020 2020 2020 2020 6177 6169  s":.        awai
+00020fe0: 7420 6e65 775f 6473 280a 2020 2020 2020  t new_ds(.      
+00020ff0: 2020 2020 2020 722c 0a20 2020 2020 2020        r,.       
+00021000: 2020 2020 2074 625f 636c 6965 6e74 2c0a       tb_client,.
+00021010: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00021020: 5f74 6f6b 656e 2c0a 2020 2020 2020 2020  _token,.        
+00021030: 2020 2020 666f 7263 652c 0a20 2020 2020      force,.     
+00021040: 2020 2020 2020 2073 6b69 705f 636f 6e66         skip_conf
+00021050: 6972 6d61 7469 6f6e 3d73 6b69 705f 636f  irmation=skip_co
+00021060: 6e66 6972 6d61 7469 6f6e 2c0a 2020 2020  nfirmation,.    
+00021070: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00021080: 7773 3d63 7572 7265 6e74 5f77 732c 0a20  ws=current_ws,. 
+00021090: 2020 2020 2020 2020 2020 2066 6f72 6b5f             fork_
+000210a0: 646f 776e 7374 7265 616d 3d66 6f72 6b5f  downstream=fork_
+000210b0: 646f 776e 7374 7265 616d 2c0a 2020 2020  downstream,.    
+000210c0: 2020 2020 2020 2020 666f 726b 3d66 6f72          fork=for
+000210d0: 6b2c 0a20 2020 2020 2020 2020 2020 2067  k,.            g
+000210e0: 6974 5f72 656c 6561 7365 3d67 6974 5f72  it_release=git_r
+000210f0: 656c 6561 7365 2c0a 2020 2020 2020 2020  elease,.        
+00021100: 290a 2020 2020 656c 6966 2072 5b22 7265  ).    elif r["re
+00021110: 736f 7572 6365 225d 203d 3d20 2274 6f6b  source"] == "tok
+00021120: 656e 7322 3a0a 2020 2020 2020 2020 6177  ens":.        aw
+00021130: 6169 7420 6e65 775f 746f 6b65 6e28 722c  ait new_token(r,
+00021140: 2074 625f 636c 6965 6e74 2c20 666f 7263   tb_client, forc
+00021150: 6529 0a20 2020 2065 6c73 653a 0a20 2020  e).    else:.   
+00021160: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
+00021170: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
+00021180: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00021190: 6572 726f 725f 756e 6b6e 6f77 6e5f 7265  error_unknown_re
+000211a0: 736f 7572 6365 2872 6573 6f75 7263 653d  source(resource=
+000211b0: 725b 2272 6573 6f75 7263 6522 5d29 290a  r["resource"])).
+000211c0: 0a0a 6465 6620 6765 745f 6e61 6d65 5f76  ..def get_name_v
+000211d0: 6572 7369 6f6e 2864 733a 2073 7472 2920  ersion(ds: str) 
+000211e0: 2d3e 2044 6963 745b 7374 722c 2041 6e79  -> Dict[str, Any
+000211f0: 5d3a 0a20 2020 2022 2222 0a20 2020 2047  ]:.    """.    G
+00021200: 6976 656e 2061 206e 616d 6520 6c69 6b65  iven a name like
+00021210: 2022 6e61 6d65 5f5f 6465 765f 5f76 3022   "name__dev__v0"
+00021220: 2072 6574 7572 6e73 205b 276e 616d 6527   returns ['name'
+00021230: 2c20 2764 6576 272c 2027 7630 275d 0a20  , 'dev', 'v0']. 
+00021240: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
+00021250: 7665 7273 696f 6e28 2764 6576 5f5f 6e61  version('dev__na
+00021260: 6d65 5f5f 7630 2729 0a20 2020 207b 276e  me__v0').    {'n
+00021270: 616d 6527 3a20 2764 6576 5f5f 6e61 6d65  ame': 'dev__name
+00021280: 272c 2027 7665 7273 696f 6e27 3a20 307d  ', 'version': 0}
+00021290: 0a20 2020 203e 3e3e 2067 6574 5f6e 616d  .    >>> get_nam
+000212a0: 655f 7665 7273 696f 6e28 276e 616d 655f  e_version('name_
+000212b0: 5f76 3027 290a 2020 2020 7b27 6e61 6d65  _v0').    {'name
+000212c0: 273a 2027 6e61 6d65 272c 2027 7665 7273  ': 'name', 'vers
+000212d0: 696f 6e27 3a20 307d 0a20 2020 203e 3e3e  ion': 0}.    >>>
+000212e0: 2067 6574 5f6e 616d 655f 7665 7273 696f   get_name_versio
+000212f0: 6e28 2764 6576 5f5f 6e61 6d65 2729 0a20  n('dev__name'). 
+00021300: 2020 207b 276e 616d 6527 3a20 2764 6576     {'name': 'dev
+00021310: 5f5f 6e61 6d65 272c 2027 7665 7273 696f  __name', 'versio
+00021320: 6e27 3a20 4e6f 6e65 7d0a 2020 2020 3e3e  n': None}.    >>
+00021330: 3e20 6765 745f 6e61 6d65 5f76 6572 7369  > get_name_versi
+00021340: 6f6e 2827 6e61 6d65 2729 0a20 2020 207b  on('name').    {
+00021350: 276e 616d 6527 3a20 276e 616d 6527 2c20  'name': 'name', 
+00021360: 2776 6572 7369 6f6e 273a 204e 6f6e 657d  'version': None}
+00021370: 0a20 2020 203e 3e3e 2067 6574 5f6e 616d  .    >>> get_nam
+00021380: 655f 7665 7273 696f 6e28 2768 6f72 6172  e_version('horar
+00021390: 696f 5f5f 335f 5f70 6970 6527 290a 2020  io__3__pipe').  
+000213a0: 2020 7b27 6e61 6d65 273a 2027 686f 7261    {'name': 'hora
+000213b0: 7269 6f5f 5f33 5f5f 7069 7065 272c 2027  rio__3__pipe', '
+000213c0: 7665 7273 696f 6e27 3a20 4e6f 6e65 7d0a  version': None}.
+000213d0: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
+000213e0: 5f76 6572 7369 6f6e 2827 686f 7261 7269  _version('horari
+000213f0: 6f5f 5f63 6865 636b 6572 2729 0a20 2020  o__checker').   
+00021400: 207b 276e 616d 6527 3a20 2768 6f72 6172   {'name': 'horar
+00021410: 696f 5f5f 6368 6563 6b65 7227 2c20 2776  io__checker', 'v
+00021420: 6572 7369 6f6e 273a 204e 6f6e 657d 0a20  ersion': None}. 
+00021430: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
+00021440: 7665 7273 696f 6e28 2764 6576 5f5f 686f  version('dev__ho
+00021450: 7261 7269 6f5f 5f63 6865 636b 6572 2729  rario__checker')
+00021460: 0a20 2020 207b 276e 616d 6527 3a20 2764  .    {'name': 'd
+00021470: 6576 5f5f 686f 7261 7269 6f5f 5f63 6865  ev__horario__che
+00021480: 636b 6572 272c 2027 7665 7273 696f 6e27  cker', 'version'
+00021490: 3a20 4e6f 6e65 7d0a 2020 2020 3e3e 3e20  : None}.    >>> 
+000214a0: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
+000214b0: 2827 7467 5f5f 6441 6374 6976 6964 6164  ('tg__dActividad
+000214c0: 6573 5f5f 7630 5f70 6970 655f 3339 3037  es__v0_pipe_3907
+000214d0: 2729 0a20 2020 207b 276e 616d 6527 3a20  ').    {'name': 
+000214e0: 2774 675f 5f64 4163 7469 7669 6461 6465  'tg__dActividade
+000214f0: 7327 2c20 2776 6572 7369 6f6e 273a 2030  s', 'version': 0
+00021500: 7d0a 2020 2020 3e3e 3e20 6765 745f 6e61  }.    >>> get_na
+00021510: 6d65 5f76 6572 7369 6f6e 2827 7467 5f5f  me_version('tg__
+00021520: 6441 6374 6976 6964 6164 6573 5f5f 7661  dActividades__va
+00021530: 5f70 6970 655f 3339 3037 2729 0a20 2020  _pipe_3907').   
+00021540: 207b 276e 616d 6527 3a20 2774 675f 5f64   {'name': 'tg__d
+00021550: 4163 7469 7669 6461 6465 735f 5f76 615f  Actividades__va_
+00021560: 7069 7065 5f33 3930 3727 2c20 2776 6572  pipe_3907', 'ver
+00021570: 7369 6f6e 273a 204e 6f6e 657d 0a20 2020  sion': None}.   
+00021580: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
+00021590: 7273 696f 6e28 2774 675f 5f6f 7269 6769  rsion('tg__origi
+000215a0: 6e5f 776f 726b 7370 6163 652e 7368 6172  n_workspace.shar
+000215b0: 6564 5f64 735f 5f76 3339 3037 2729 0a20  ed_ds__v3907'). 
+000215c0: 2020 207b 276e 616d 6527 3a20 2774 675f     {'name': 'tg_
+000215d0: 5f6f 7269 6769 6e5f 776f 726b 7370 6163  _origin_workspac
+000215e0: 652e 7368 6172 6564 5f64 7327 2c20 2776  e.shared_ds', 'v
+000215f0: 6572 7369 6f6e 273a 2033 3930 377d 0a20  ersion': 3907}. 
+00021600: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
+00021610: 7665 7273 696f 6e28 2774 6d70 6838 6567  version('tmph8eg
+00021620: 746c 5f5f 2729 0a20 2020 207b 276e 616d  tl__').    {'nam
+00021630: 6527 3a20 2774 6d70 6838 6567 746c 5f5f  e': 'tmph8egtl__
+00021640: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
+00021650: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
+00021660: 6e61 6d65 5f76 6572 7369 6f6e 2827 746d  name_version('tm
+00021670: 7068 3865 6774 6c5f 5f31 3233 5f5f 2729  ph8egtl__123__')
+00021680: 0a20 2020 207b 276e 616d 6527 3a20 2774  .    {'name': 't
+00021690: 6d70 6838 6567 746c 5f5f 3132 335f 5f27  mph8egtl__123__'
+000216a0: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
+000216b0: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
+000216c0: 616d 655f 7665 7273 696f 6e28 2764 6576  ame_version('dev
+000216d0: 5f5f 6e61 6d65 5f5f 7630 2729 0a20 2020  __name__v0').   
+000216e0: 207b 276e 616d 6527 3a20 2764 6576 5f5f   {'name': 'dev__
+000216f0: 6e61 6d65 272c 2027 7665 7273 696f 6e27  name', 'version'
+00021700: 3a20 307d 0a20 2020 203e 3e3e 2067 6574  : 0}.    >>> get
+00021710: 5f6e 616d 655f 7665 7273 696f 6e28 276e  _name_version('n
+00021720: 616d 655f 5f76 3027 290a 2020 2020 7b27  ame__v0').    {'
+00021730: 6e61 6d65 273a 2027 6e61 6d65 272c 2027  name': 'name', '
+00021740: 7665 7273 696f 6e27 3a20 307d 0a20 2020  version': 0}.   
+00021750: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
+00021760: 7273 696f 6e28 2764 6576 5f5f 6e61 6d65  rsion('dev__name
+00021770: 2729 0a20 2020 207b 276e 616d 6527 3a20  ').    {'name': 
+00021780: 2764 6576 5f5f 6e61 6d65 272c 2027 7665  'dev__name', 've
+00021790: 7273 696f 6e27 3a20 4e6f 6e65 7d0a 2020  rsion': None}.  
+000217a0: 2020 3e3e 3e20 6765 745f 6e61 6d65 5f76    >>> get_name_v
+000217b0: 6572 7369 6f6e 2827 6e61 6d65 2729 0a20  ersion('name'). 
+000217c0: 2020 207b 276e 616d 6527 3a20 276e 616d     {'name': 'nam
+000217d0: 6527 2c20 2776 6572 7369 6f6e 273a 204e  e', 'version': N
+000217e0: 6f6e 657d 0a20 2020 203e 3e3e 2067 6574  one}.    >>> get
+000217f0: 5f6e 616d 655f 7665 7273 696f 6e28 2768  _name_version('h
+00021800: 6f72 6172 696f 5f5f 335f 5f70 6970 6527  orario__3__pipe'
 00021810: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
-00021820: 6e61 6d65 272c 2027 7665 7273 696f 6e27  name', 'version'
-00021830: 3a20 4e6f 6e65 7d0a 2020 2020 3e3e 3e20  : None}.    >>> 
-00021840: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
-00021850: 2827 686f 7261 7269 6f5f 5f33 5f5f 7069  ('horario__3__pi
-00021860: 7065 2729 0a20 2020 207b 276e 616d 6527  pe').    {'name'
-00021870: 3a20 2768 6f72 6172 696f 5f5f 335f 5f70  : 'horario__3__p
-00021880: 6970 6527 2c20 2776 6572 7369 6f6e 273a  ipe', 'version':
-00021890: 204e 6f6e 657d 0a20 2020 203e 3e3e 2067   None}.    >>> g
-000218a0: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
-000218b0: 2768 6f72 6172 696f 5f5f 6368 6563 6b65  'horario__checke
-000218c0: 7227 290a 2020 2020 7b27 6e61 6d65 273a  r').    {'name':
-000218d0: 2027 686f 7261 7269 6f5f 5f63 6865 636b   'horario__check
-000218e0: 6572 272c 2027 7665 7273 696f 6e27 3a20  er', 'version': 
-000218f0: 4e6f 6e65 7d0a 2020 2020 3e3e 3e20 6765  None}.    >>> ge
-00021900: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
-00021910: 6465 765f 5f68 6f72 6172 696f 5f5f 6368  dev__horario__ch
-00021920: 6563 6b65 7227 290a 2020 2020 7b27 6e61  ecker').    {'na
-00021930: 6d65 273a 2027 6465 765f 5f68 6f72 6172  me': 'dev__horar
-00021940: 696f 5f5f 6368 6563 6b65 7227 2c20 2776  io__checker', 'v
-00021950: 6572 7369 6f6e 273a 204e 6f6e 657d 0a20  ersion': None}. 
-00021960: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
-00021970: 7665 7273 696f 6e28 2774 675f 5f64 4163  version('tg__dAc
-00021980: 7469 7669 6461 6465 735f 5f76 305f 7069  tividades__v0_pi
-00021990: 7065 5f33 3930 3727 290a 2020 2020 7b27  pe_3907').    {'
-000219a0: 6e61 6d65 273a 2027 7467 5f5f 6441 6374  name': 'tg__dAct
-000219b0: 6976 6964 6164 6573 272c 2027 7665 7273  ividades', 'vers
-000219c0: 696f 6e27 3a20 307d 0a20 2020 203e 3e3e  ion': 0}.    >>>
-000219d0: 2067 6574 5f6e 616d 655f 7665 7273 696f   get_name_versio
-000219e0: 6e28 2774 675f 5f64 4163 7469 7669 6461  n('tg__dActivida
-000219f0: 6465 735f 5f76 615f 7069 7065 5f33 3930  des__va_pipe_390
-00021a00: 3727 290a 2020 2020 7b27 6e61 6d65 273a  7').    {'name':
-00021a10: 2027 7467 5f5f 6441 6374 6976 6964 6164   'tg__dActividad
-00021a20: 6573 5f5f 7661 5f70 6970 655f 3339 3037  es__va_pipe_3907
-00021a30: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
-00021a40: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
-00021a50: 6e61 6d65 5f76 6572 7369 6f6e 2827 7467  name_version('tg
-00021a60: 5f5f 6f72 6967 696e 5f77 6f72 6b73 7061  __origin_workspa
-00021a70: 6365 2e73 6861 7265 645f 6473 5f5f 7633  ce.shared_ds__v3
-00021a80: 3930 3727 290a 2020 2020 7b27 6e61 6d65  907').    {'name
-00021a90: 273a 2027 7467 5f5f 6f72 6967 696e 5f77  ': 'tg__origin_w
-00021aa0: 6f72 6b73 7061 6365 2e73 6861 7265 645f  orkspace.shared_
-00021ab0: 6473 272c 2027 7665 7273 696f 6e27 3a20  ds', 'version': 
-00021ac0: 3339 3037 7d0a 2020 2020 3e3e 3e20 6765  3907}.    >>> ge
-00021ad0: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
-00021ae0: 746d 7068 3865 6774 6c5f 5f27 290a 2020  tmph8egtl__').  
-00021af0: 2020 7b27 6e61 6d65 273a 2027 746d 7068    {'name': 'tmph
-00021b00: 3865 6774 6c5f 5f27 2c20 2776 6572 7369  8egtl__', 'versi
-00021b10: 6f6e 273a 204e 6f6e 657d 0a20 2020 203e  on': None}.    >
-00021b20: 3e3e 2067 6574 5f6e 616d 655f 7665 7273  >> get_name_vers
-00021b30: 696f 6e28 2774 6d70 6838 6567 746c 5f5f  ion('tmph8egtl__
-00021b40: 3132 335f 5f27 290a 2020 2020 7b27 6e61  123__').    {'na
-00021b50: 6d65 273a 2027 746d 7068 3865 6774 6c5f  me': 'tmph8egtl_
-00021b60: 5f31 3233 5f5f 272c 2027 7665 7273 696f  _123__', 'versio
-00021b70: 6e27 3a20 4e6f 6e65 7d0a 2020 2020 3e3e  n': None}.    >>
-00021b80: 3e20 6765 745f 6e61 6d65 5f76 6572 7369  > get_name_versi
-00021b90: 6f6e 2827 6465 765f 5f6e 616d 655f 5f76  on('dev__name__v
-00021ba0: 3027 290a 2020 2020 7b27 6e61 6d65 273a  0').    {'name':
-00021bb0: 2027 6465 765f 5f6e 616d 6527 2c20 2776   'dev__name', 'v
-00021bc0: 6572 7369 6f6e 273a 2030 7d0a 2020 2020  ersion': 0}.    
-00021bd0: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
-00021be0: 7369 6f6e 2827 6e61 6d65 5f5f 7630 2729  sion('name__v0')
-00021bf0: 0a20 2020 207b 276e 616d 6527 3a20 276e  .    {'name': 'n
-00021c00: 616d 6527 2c20 2776 6572 7369 6f6e 273a  ame', 'version':
-00021c10: 2030 7d0a 2020 2020 3e3e 3e20 6765 745f   0}.    >>> get_
-00021c20: 6e61 6d65 5f76 6572 7369 6f6e 2827 6465  name_version('de
-00021c30: 765f 5f6e 616d 6527 290a 2020 2020 7b27  v__name').    {'
-00021c40: 6e61 6d65 273a 2027 6465 765f 5f6e 616d  name': 'dev__nam
-00021c50: 6527 2c20 2776 6572 7369 6f6e 273a 204e  e', 'version': N
-00021c60: 6f6e 657d 0a20 2020 203e 3e3e 2067 6574  one}.    >>> get
-00021c70: 5f6e 616d 655f 7665 7273 696f 6e28 276e  _name_version('n
-00021c80: 616d 6527 290a 2020 2020 7b27 6e61 6d65  ame').    {'name
-00021c90: 273a 2027 6e61 6d65 272c 2027 7665 7273  ': 'name', 'vers
-00021ca0: 696f 6e27 3a20 4e6f 6e65 7d0a 2020 2020  ion': None}.    
-00021cb0: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
-00021cc0: 7369 6f6e 2827 686f 7261 7269 6f5f 5f33  sion('horario__3
-00021cd0: 5f5f 7069 7065 2729 0a20 2020 207b 276e  __pipe').    {'n
-00021ce0: 616d 6527 3a20 2768 6f72 6172 696f 5f5f  ame': 'horario__
-00021cf0: 335f 5f70 6970 6527 2c20 2776 6572 7369  3__pipe', 'versi
-00021d00: 6f6e 273a 204e 6f6e 657d 0a20 2020 203e  on': None}.    >
-00021d10: 3e3e 2067 6574 5f6e 616d 655f 7665 7273  >> get_name_vers
-00021d20: 696f 6e28 2768 6f72 6172 696f 5f5f 6368  ion('horario__ch
-00021d30: 6563 6b65 7227 290a 2020 2020 7b27 6e61  ecker').    {'na
-00021d40: 6d65 273a 2027 686f 7261 7269 6f5f 5f63  me': 'horario__c
-00021d50: 6865 636b 6572 272c 2027 7665 7273 696f  hecker', 'versio
-00021d60: 6e27 3a20 4e6f 6e65 7d0a 2020 2020 3e3e  n': None}.    >>
-00021d70: 3e20 6765 745f 6e61 6d65 5f76 6572 7369  > get_name_versi
-00021d80: 6f6e 2827 6465 765f 5f68 6f72 6172 696f  on('dev__horario
-00021d90: 5f5f 6368 6563 6b65 7227 290a 2020 2020  __checker').    
-00021da0: 7b27 6e61 6d65 273a 2027 6465 765f 5f68  {'name': 'dev__h
-00021db0: 6f72 6172 696f 5f5f 6368 6563 6b65 7227  orario__checker'
-00021dc0: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
-00021dd0: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
-00021de0: 616d 655f 7665 7273 696f 6e28 2774 675f  ame_version('tg_
-00021df0: 5f64 4163 7469 7669 6461 6465 735f 5f76  _dActividades__v
-00021e00: 305f 7069 7065 5f33 3930 3727 290a 2020  0_pipe_3907').  
-00021e10: 2020 7b27 6e61 6d65 273a 2027 7467 5f5f    {'name': 'tg__
-00021e20: 6441 6374 6976 6964 6164 6573 272c 2027  dActividades', '
-00021e30: 7665 7273 696f 6e27 3a20 307d 0a20 2020  version': 0}.   
-00021e40: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
-00021e50: 7273 696f 6e28 2774 675f 5f6f 7269 6769  rsion('tg__origi
-00021e60: 6e5f 776f 726b 7370 6163 652e 7368 6172  n_workspace.shar
-00021e70: 6564 5f64 735f 5f76 3339 3037 2729 0a20  ed_ds__v3907'). 
-00021e80: 2020 207b 276e 616d 6527 3a20 2774 675f     {'name': 'tg_
-00021e90: 5f6f 7269 6769 6e5f 776f 726b 7370 6163  _origin_workspac
-00021ea0: 652e 7368 6172 6564 5f64 7327 2c20 2776  e.shared_ds', 'v
-00021eb0: 6572 7369 6f6e 273a 2033 3930 377d 0a20  ersion': 3907}. 
-00021ec0: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
-00021ed0: 7665 7273 696f 6e28 2774 6d70 6838 6567  version('tmph8eg
-00021ee0: 746c 5f5f 2729 0a20 2020 207b 276e 616d  tl__').    {'nam
-00021ef0: 6527 3a20 2774 6d70 6838 6567 746c 5f5f  e': 'tmph8egtl__
-00021f00: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
-00021f10: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
-00021f20: 6e61 6d65 5f76 6572 7369 6f6e 2827 746d  name_version('tm
-00021f30: 7068 3865 6774 6c5f 5f31 3233 5f5f 2729  ph8egtl__123__')
-00021f40: 0a20 2020 207b 276e 616d 6527 3a20 2774  .    {'name': 't
-00021f50: 6d70 6838 6567 746c 5f5f 3132 335f 5f27  mph8egtl__123__'
-00021f60: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
-00021f70: 657d 0a20 2020 2022 2222 0a20 2020 2074  e}.    """.    t
-00021f80: 6b20 3d20 6473 2e72 7370 6c69 7428 225f  k = ds.rsplit("_
-00021f90: 5f22 2c20 3229 0a20 2020 2069 6620 6c65  _", 2).    if le
-00021fa0: 6e28 746b 2920 3d3d 2031 3a0a 2020 2020  n(tk) == 1:.    
-00021fb0: 2020 2020 7265 7475 726e 207b 226e 616d      return {"nam
-00021fc0: 6522 3a20 746b 5b30 5d2c 2022 7665 7273  e": tk[0], "vers
-00021fd0: 696f 6e22 3a20 4e6f 6e65 7d0a 2020 2020  ion": None}.    
-00021fe0: 656c 6966 206c 656e 2874 6b29 203d 3d20  elif len(tk) == 
-00021ff0: 323a 0a20 2020 2020 2020 2069 6620 6c65  2:.        if le
-00022000: 6e28 746b 5b31 5d29 3a0a 2020 2020 2020  n(tk[1]):.      
-00022010: 2020 2020 2020 6966 2074 6b5b 315d 5b30        if tk[1][0
-00022020: 5d20 3d3d 2022 7622 2061 6e64 2072 652e  ] == "v" and re.
-00022030: 6d61 7463 6828 225b 302d 395d 2b24 222c  match("[0-9]+$",
-00022040: 2074 6b5b 315d 5b31 3a5d 293a 0a20 2020   tk[1][1:]):.   
-00022050: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00022060: 7572 6e20 7b22 6e61 6d65 223a 2074 6b5b  urn {"name": tk[
-00022070: 305d 2c20 2276 6572 7369 6f6e 223a 2069  0], "version": i
-00022080: 6e74 2874 6b5b 315d 5b31 3a5d 297d 0a20  nt(tk[1][1:])}. 
-00022090: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000220a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000220b0: 2072 6574 7572 6e20 7b22 6e61 6d65 223a   return {"name":
-000220c0: 2074 6b5b 305d 202b 2022 5f5f 2220 2b20   tk[0] + "__" + 
-000220d0: 746b 5b31 5d2c 2022 7665 7273 696f 6e22  tk[1], "version"
-000220e0: 3a20 4e6f 6e65 7d0a 2020 2020 656c 6966  : None}.    elif
-000220f0: 206c 656e 2874 6b29 203d 3d20 3320 616e   len(tk) == 3 an
-00022100: 6420 6c65 6e28 746b 5b32 5d29 3a0a 2020  d len(tk[2]):.  
-00022110: 2020 2020 2020 6966 2074 6b5b 325d 203d        if tk[2] =
-00022120: 3d20 2263 6865 636b 6572 223a 0a20 2020  = "checker":.   
-00022130: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00022140: 7b22 6e61 6d65 223a 2074 6b5b 305d 202b  {"name": tk[0] +
-00022150: 2022 5f5f 2220 2b20 746b 5b31 5d20 2b20   "__" + tk[1] + 
-00022160: 225f 5f22 202b 2074 6b5b 325d 2c20 2276  "__" + tk[2], "v
-00022170: 6572 7369 6f6e 223a 204e 6f6e 657d 0a20  ersion": None}. 
-00022180: 2020 2020 2020 2069 6620 746b 5b32 5d5b         if tk[2][
-00022190: 305d 203d 3d20 2276 223a 0a20 2020 2020  0] == "v":.     
-000221a0: 2020 2020 2020 2070 6172 7473 203d 2074         parts = t
-000221b0: 6b5b 325d 2e73 706c 6974 2822 5f22 290a  k[2].split("_").
-000221c0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000221d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000221e0: 2072 6574 7572 6e20 7b22 6e61 6d65 223a   return {"name":
-000221f0: 2074 6b5b 305d 202b 2022 5f5f 2220 2b20   tk[0] + "__" + 
-00022200: 746b 5b31 5d2c 2022 7665 7273 696f 6e22  tk[1], "version"
-00022210: 3a20 696e 7428 7061 7274 735b 305d 5b31  : int(parts[0][1
-00022220: 3a5d 297d 0a20 2020 2020 2020 2020 2020  :])}.           
-00022230: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-00022240: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00022250: 2020 2020 7265 7475 726e 207b 226e 616d      return {"nam
-00022260: 6522 3a20 746b 5b30 5d20 2b20 225f 5f22  e": tk[0] + "__"
-00022270: 202b 2074 6b5b 315d 202b 2022 5f5f 2220   + tk[1] + "__" 
-00022280: 2b20 746b 5b32 5d2c 2022 7665 7273 696f  + tk[2], "versio
-00022290: 6e22 3a20 4e6f 6e65 7d0a 2020 2020 2020  n": None}.      
-000222a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000222b0: 2020 2020 7265 7475 726e 207b 226e 616d      return {"nam
-000222c0: 6522 3a20 225f 5f22 2e6a 6f69 6e28 746b  e": "__".join(tk
-000222d0: 5b30 3a5d 292c 2022 7665 7273 696f 6e22  [0:]), "version"
-000222e0: 3a20 4e6f 6e65 7d0a 0a20 2020 2072 6574  : None}..    ret
-000222f0: 7572 6e20 7b22 6e61 6d65 223a 2064 732c  urn {"name": ds,
-00022300: 2022 7665 7273 696f 6e22 3a20 4e6f 6e65   "version": None
-00022310: 7d0a 0a0a 6465 6620 6765 745f 7265 736f  }...def get_reso
-00022320: 7572 6365 5f76 6572 7369 6f6e 7328 6461  urce_versions(da
-00022330: 7461 736f 7572 6365 733a 204c 6973 745b  tasources: List[
-00022340: 7374 725d 293a 0a20 2020 2022 2222 0a20  str]):.    """. 
-00022350: 2020 2072 6574 7572 6e20 7468 6520 6c61     return the la
-00022360: 7465 7374 2076 6572 7369 6f6e 2066 6f72  test version for
-00022370: 2061 6c6c 2074 6865 2064 6174 6173 6f75   all the datasou
-00022380: 7263 6573 0a20 2020 2022 2222 0a20 2020  rces.    """.   
-00022390: 2076 6572 7369 6f6e 7320 3d20 7b7d 0a20   versions = {}. 
-000223a0: 2020 2066 6f72 2078 2069 6e20 6461 7461     for x in data
-000223b0: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-000223c0: 2074 203d 2067 6574 5f6e 616d 655f 7665   t = get_name_ve
-000223d0: 7273 696f 6e28 7829 0a20 2020 2020 2020  rsion(x).       
-000223e0: 206e 616d 6520 3d20 745b 226e 616d 6522   name = t["name"
-000223f0: 5d0a 2020 2020 2020 2020 6966 2074 2e67  ].        if t.g
-00022400: 6574 2822 7665 7273 696f 6e22 2c20 4e6f  et("version", No
-00022410: 6e65 2920 6973 206e 6f74 204e 6f6e 653a  ne) is not None:
-00022420: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-00022430: 7369 6f6e 735b 6e61 6d65 5d20 3d20 745b  sions[name] = t[
-00022440: 2276 6572 7369 6f6e 225d 0a20 2020 2072  "version"].    r
-00022450: 6574 7572 6e20 7665 7273 696f 6e73 0a0a  eturn versions..
-00022460: 0a64 6566 2067 6574 5f72 656d 6f74 655f  .def get_remote_
-00022470: 7265 736f 7572 6365 5f6e 616d 655f 7769  resource_name_wi
-00022480: 7468 6f75 745f 7665 7273 696f 6e28 7265  thout_version(re
-00022490: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
-000224a0: 6d65 3a20 7374 7229 202d 3e20 7374 723a  me: str) -> str:
-000224b0: 0a20 2020 2022 2222 0a20 2020 203e 3e3e  .    """.    >>>
-000224c0: 2067 6574 5f72 656d 6f74 655f 7265 736f   get_remote_reso
-000224d0: 7572 6365 5f6e 616d 655f 7769 7468 6f75  urce_name_withou
-000224e0: 745f 7665 7273 696f 6e28 2272 5f5f 6461  t_version("r__da
-000224f0: 7461 736f 7572 6365 2229 0a20 2020 2027  tasource").    '
-00022500: 725f 5f64 6174 6173 6f75 7263 6527 0a20  r__datasource'. 
-00022510: 2020 203e 3e3e 2067 6574 5f72 656d 6f74     >>> get_remot
-00022520: 655f 7265 736f 7572 6365 5f6e 616d 655f  e_resource_name_
-00022530: 7769 7468 6f75 745f 7665 7273 696f 6e28  without_version(
-00022540: 2272 5f5f 6461 7461 736f 7572 6365 5f5f  "r__datasource__
-00022550: 7630 2229 0a20 2020 2027 725f 5f64 6174  v0").    'r__dat
-00022560: 6173 6f75 7263 6527 0a20 2020 203e 3e3e  asource'.    >>>
-00022570: 2067 6574 5f72 656d 6f74 655f 7265 736f   get_remote_reso
-00022580: 7572 6365 5f6e 616d 655f 7769 7468 6f75  urce_name_withou
-00022590: 745f 7665 7273 696f 6e28 2264 6174 6173  t_version("datas
-000225a0: 6f75 7263 6522 290a 2020 2020 2764 6174  ource").    'dat
-000225b0: 6173 6f75 7263 6527 0a20 2020 2022 2222  asource'.    """
-000225c0: 0a20 2020 2070 6172 7473 203d 2067 6574  .    parts = get
-000225d0: 5f6e 616d 655f 7665 7273 696f 6e28 7265  _name_version(re
-000225e0: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
-000225f0: 6d65 290a 2020 2020 7265 7475 726e 2070  me).    return p
-00022600: 6172 7473 5b22 6e61 6d65 225d 0a0a 0a64  arts["name"]...d
-00022610: 6566 2067 6574 5f64 6570 5f66 726f 6d5f  ef get_dep_from_
-00022620: 7261 775f 7461 626c 6573 2878 3a20 7374  raw_tables(x: st
-00022630: 7229 202d 3e20 7374 723a 0a20 2020 2022  r) -> str:.    "
-00022640: 2222 0a20 2020 2064 6174 6173 6f75 7263  "".    datasourc
-00022650: 6573 204b 4559 2063 6f6d 6d61 6e64 2067  es KEY command g
-00022660: 656e 6572 6174 6573 2074 6162 6c65 732c  enerates tables,
-00022670: 2074 6869 7320 7472 616e 7366 6f72 6d20   this transform 
-00022680: 7468 6520 7573 6564 2074 6162 6c65 2077  the used table w
-00022690: 6974 6820 7468 6520 736f 7572 6365 2066  ith the source f
-000226a0: 696c 650a 2020 2020 3e3e 3e20 6765 745f  ile.    >>> get_
-000226b0: 6465 705f 6672 6f6d 5f72 6177 5f74 6162  dep_from_raw_tab
-000226c0: 6c65 7328 2774 6573 7427 290a 2020 2020  les('test').    
-000226d0: 2774 6573 7427 0a20 2020 203e 3e3e 2067  'test'.    >>> g
-000226e0: 6574 5f64 6570 5f66 726f 6d5f 7261 775f  et_dep_from_raw_
-000226f0: 7461 626c 6573 2827 7465 7374 5f6a 6f69  tables('test_joi
-00022700: 6e5f 6279 5f63 6f6c 756d 6e27 290a 2020  n_by_column').  
-00022710: 2020 2774 6573 7427 0a20 2020 2022 2222    'test'.    """
-00022720: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00022730: 2020 2072 6574 7572 6e20 785b 3a20 782e     return x[: x.
-00022740: 696e 6465 7828 225f 6a6f 696e 5f62 795f  index("_join_by_
-00022750: 2229 5d0a 2020 2020 6578 6365 7074 2056  ")].    except V
-00022760: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
-00022770: 2020 2072 6574 7572 6e20 780a 0a0a 6465     return x...de
-00022780: 6620 6372 6561 7465 5f64 6f77 6e73 7472  f create_downstr
-00022790: 6561 6d5f 6465 7065 6e64 656e 6379 5f67  eam_dependency_g
-000227a0: 7261 7068 2864 6570 656e 6465 6e63 795f  raph(dependency_
-000227b0: 6772 6170 683a 2044 6963 745b 7374 722c  graph: Dict[str,
-000227c0: 2053 6574 5b73 7472 5d5d 2c20 616c 6c5f   Set[str]], all_
-000227d0: 7265 736f 7572 6365 733a 2044 6963 745b  resources: Dict[
-000227e0: 7374 722c 2044 6963 745b 7374 722c 2041  str, Dict[str, A
-000227f0: 6e79 5d5d 293a 0a20 2020 2022 2222 0a20  ny]]):.    """. 
-00022800: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-00022810: 2072 6576 6572 7365 7320 7468 6520 6465   reverses the de
-00022820: 7065 6e64 656e 6379 2067 7261 7068 206f  pendency graph o
-00022830: 6274 6169 6e65 6420 6672 6f6d 2062 7569  btained from bui
-00022840: 6c64 5f67 7261 7068 2073 6f20 796f 7520  ld_graph so you 
-00022850: 6861 7665 2064 6f77 6e73 7472 6561 6d20  have downstream 
-00022860: 6465 7065 6e64 656e 6369 6573 2066 6f72  dependencies for
-00022870: 2065 6163 6820 6e6f 6465 2069 6e20 7468   each node in th
-00022880: 6520 6772 6170 682e 0a0a 2020 2020 4164  e graph...    Ad
-00022890: 6469 7469 6f6e 616c 6c79 2074 616b 6573  ditionally takes
-000228a0: 2069 6e74 6f20 6163 636f 756e 7420 7461   into account ta
-000228b0: 7267 6574 5f64 6174 6173 6f75 7263 6520  rget_datasource 
-000228c0: 6f66 206d 6174 6572 6961 6c69 7a65 6420  of materialized 
-000228d0: 7669 6577 730a 2020 2020 2222 220a 2020  views.    """.  
-000228e0: 2020 646f 776e 7374 7265 616d 5f64 6570    downstream_dep
-000228f0: 656e 6465 6e63 795f 6772 6170 683a 2044  endency_graph: D
-00022900: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
-00022910: 5d5d 203d 207b 6e6f 6465 3a20 7365 7428  ]] = {node: set(
-00022920: 2920 666f 7220 6e6f 6465 2069 6e20 6465  ) for node in de
-00022930: 7065 6e64 656e 6379 5f67 7261 7068 7d0a  pendency_graph}.
-00022940: 0a20 2020 2066 6f72 206e 6f64 652c 2064  .    for node, d
-00022950: 6570 656e 6465 6e63 6965 7320 696e 2064  ependencies in d
-00022960: 6570 656e 6465 6e63 795f 6772 6170 682e  ependency_graph.
-00022970: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00022980: 2066 6f72 2064 6570 656e 6465 6e63 7920   for dependency 
-00022990: 696e 2064 6570 656e 6465 6e63 6965 733a  in dependencies:
-000229a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000229b0: 6465 7065 6e64 656e 6379 206e 6f74 2069  dependency not i
-000229c0: 6e20 646f 776e 7374 7265 616d 5f64 6570  n downstream_dep
-000229d0: 656e 6465 6e63 795f 6772 6170 683a 0a20  endency_graph:. 
-000229e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000229f0: 2061 2073 6861 7265 6420 6461 7461 2073   a shared data s
-00022a00: 6f75 7263 652c 2077 6520 6361 6e20 736b  ource, we can sk
-00022a10: 6970 2069 740a 2020 2020 2020 2020 2020  ip it.          
-00022a20: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00022a30: 2020 2020 2020 2020 2020 2064 6f77 6e73             downs
-00022a40: 7472 6561 6d5f 6465 7065 6e64 656e 6379  tream_dependency
-00022a50: 5f67 7261 7068 5b64 6570 656e 6465 6e63  _graph[dependenc
-00022a60: 795d 2e61 6464 286e 6f64 6529 0a0a 2020  y].add(node)..  
-00022a70: 2020 666f 7220 6b65 7920 696e 2064 6963    for key in dic
-00022a80: 7428 646f 776e 7374 7265 616d 5f64 6570  t(downstream_dep
-00022a90: 656e 6465 6e63 795f 6772 6170 6829 3a0a  endency_graph):.
-00022aa0: 2020 2020 2020 2020 7461 7267 6574 5f64          target_d
-00022ab0: 6174 6173 6f75 7263 6520 3d20 6765 745f  atasource = get_
-00022ac0: 7461 7267 6574 5f6d 6174 6572 6961 6c69  target_materiali
-00022ad0: 7a65 645f 6461 7461 5f73 6f75 7263 655f  zed_data_source_
-00022ae0: 6e61 6d65 2861 6c6c 5f72 6573 6f75 7263  name(all_resourc
-00022af0: 6573 5b6b 6579 5d29 0a20 2020 2020 2020  es[key]).       
-00022b00: 2069 6620 7461 7267 6574 5f64 6174 6173   if target_datas
-00022b10: 6f75 7263 653a 0a20 2020 2020 2020 2020  ource:.         
-00022b20: 2020 2064 6f77 6e73 7472 6561 6d5f 6465     downstream_de
-00022b30: 7065 6e64 656e 6379 5f67 7261 7068 5b6b  pendency_graph[k
-00022b40: 6579 5d2e 7570 6461 7465 287b 7461 7267  ey].update({targ
-00022b50: 6574 5f64 6174 6173 6f75 7263 657d 290a  et_datasource}).
-00022b60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00022b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b80: 2064 6f77 6e73 7472 6561 6d5f 6465 7065   downstream_depe
-00022b90: 6e64 656e 6379 5f67 7261 7068 5b74 6172  ndency_graph[tar
-00022ba0: 6765 745f 6461 7461 736f 7572 6365 5d2e  get_datasource].
-00022bb0: 7265 6d6f 7665 286b 6579 290a 2020 2020  remove(key).    
-00022bc0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00022bd0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00022be0: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
-00022bf0: 2020 2072 6574 7572 6e20 646f 776e 7374     return downst
-00022c00: 7265 616d 5f64 6570 656e 6465 6e63 795f  ream_dependency_
-00022c10: 6772 6170 680a 0a0a 6465 6620 7570 6461  graph...def upda
-00022c20: 7465 5f64 6570 5f6d 6170 5f72 6563 7572  te_dep_map_recur
-00022c30: 7369 7665 6c79 280a 2020 2020 6465 705f  sively(.    dep_
-00022c40: 6d61 703a 2044 6963 745b 7374 722c 2053  map: Dict[str, S
-00022c50: 6574 5b73 7472 5d5d 2c0a 2020 2020 646f  et[str]],.    do
-00022c60: 776e 7374 7265 616d 5f64 6570 5f6d 6170  wnstream_dep_map
-00022c70: 3a20 4469 6374 5b73 7472 2c20 5365 745b  : Dict[str, Set[
-00022c80: 7374 725d 5d2c 0a20 2020 2061 6c6c 5f72  str]],.    all_r
-00022c90: 6573 6f75 7263 6573 3a20 4469 6374 5b73  esources: Dict[s
-00022ca0: 7472 2c20 4469 6374 5b73 7472 2c20 416e  tr, Dict[str, An
-00022cb0: 795d 5d2c 0a20 2020 2074 6f5f 7275 6e3a  y]],.    to_run:
-00022cc0: 2044 6963 745b 7374 722c 2044 6963 745b   Dict[str, Dict[
-00022cd0: 7374 722c 2041 6e79 5d5d 2c0a 2020 2020  str, Any]],.    
-00022ce0: 6465 705f 6d61 705f 6b65 7973 3a20 4c69  dep_map_keys: Li
-00022cf0: 7374 5b73 7472 5d2c 0a20 2020 206b 6579  st[str],.    key
-00022d00: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00022d10: 3d20 4e6f 6e65 2c0a 2020 2020 7669 7369  = None,.    visi
-00022d20: 7465 643a 204f 7074 696f 6e61 6c5b 4c69  ted: Optional[Li
-00022d30: 7374 5b73 7472 5d5d 203d 204e 6f6e 652c  st[str]] = None,
-00022d40: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
-00022d50: 4769 7665 6e20 6120 646f 776e 7374 7265  Given a downstre
-00022d60: 616d 5f64 6570 5f6d 6170 206f 6274 6169  am_dep_map obtai
-00022d70: 6e65 6420 6672 6f6d 2063 7265 6174 655f  ned from create_
-00022d80: 646f 776e 7374 7265 616d 5f64 6570 656e  downstream_depen
-00022d90: 6465 6e63 795f 6772 6170 6820 7468 6973  dency_graph this
-00022da0: 2066 756e 6374 696f 6e20 7570 6461 7465   function update
-00022db0: 7320 6561 6368 206e 6f64 6520 7265 6375  s each node recu
-00022dc0: 7273 6976 656c 7920 746f 2063 6f6d 706c  rsively to compl
-00022dd0: 6574 6520 7468 6520 646f 776e 7374 7265  ete the downstre
-00022de0: 616d 2064 6570 656e 6465 6e63 7920 6772  am dependency gr
-00022df0: 6170 6820 666f 7220 6561 6368 206e 6f64  aph for each nod
-00022e00: 650a 2020 2020 2222 220a 2020 2020 6966  e.    """.    if
-00022e10: 206e 6f74 2076 6973 6974 6564 3a0a 2020   not visited:.  
-00022e20: 2020 2020 2020 7669 7369 7465 6420 3d20        visited = 
-00022e30: 6c69 7374 2829 0a20 2020 2069 6620 6e6f  list().    if no
-00022e40: 7420 6b65 7920 616e 6420 6c65 6e28 6465  t key and len(de
-00022e50: 705f 6d61 705f 6b65 7973 2920 3d3d 2030  p_map_keys) == 0
-00022e60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00022e70: 0a20 2020 2069 6620 6e6f 7420 6b65 793a  .    if not key:
-00022e80: 0a20 2020 2020 2020 206b 6579 203d 2064  .        key = d
-00022e90: 6570 5f6d 6170 5f6b 6579 732e 706f 7028  ep_map_keys.pop(
-00022ea0: 290a 2020 2020 6966 206b 6579 206e 6f74  ).    if key not
-00022eb0: 2069 6e20 6465 705f 6d61 703a 0a20 2020   in dep_map:.   
-00022ec0: 2020 2020 2064 6570 5f6d 6170 5b6b 6579       dep_map[key
-00022ed0: 5d20 3d20 7365 7428 290a 2020 2020 656c  ] = set().    el
-00022ee0: 7365 3a0a 2020 2020 2020 2020 7669 7369  se:.        visi
-00022ef0: 7465 642e 6170 7065 6e64 286b 6579 290a  ted.append(key).
-00022f00: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00022f10: 2020 2020 666f 7220 6465 7020 696e 2064      for dep in d
-00022f20: 6f77 6e73 7472 6561 6d5f 6465 705f 6d61  ownstream_dep_ma
-00022f30: 702e 6765 7428 6b65 792c 207b 7d29 3a0a  p.get(key, {}):.
-00022f40: 2020 2020 2020 2020 6966 2064 6570 206e          if dep n
-00022f50: 6f74 2069 6e20 646f 776e 7374 7265 616d  ot in downstream
-00022f60: 5f64 6570 5f6d 6170 3a0a 2020 2020 2020  _dep_map:.      
-00022f70: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00022f80: 2020 2020 2020 2074 6f5f 7275 6e5b 6465         to_run[de
-00022f90: 705d 203d 2061 6c6c 5f72 6573 6f75 7263  p] = all_resourc
-00022fa0: 6573 2e67 6574 2864 6570 2c20 7b7d 290a  es.get(dep, {}).
-00022fb0: 2020 2020 2020 2020 7570 6461 7465 5f64          update_d
-00022fc0: 6570 5f6d 6170 5f72 6563 7572 7369 7665  ep_map_recursive
-00022fd0: 6c79 280a 2020 2020 2020 2020 2020 2020  ly(.            
-00022fe0: 6465 705f 6d61 702c 2064 6f77 6e73 7472  dep_map, downstr
-00022ff0: 6561 6d5f 6465 705f 6d61 702c 2061 6c6c  eam_dep_map, all
-00023000: 5f72 6573 6f75 7263 6573 2c20 746f 5f72  _resources, to_r
-00023010: 756e 2c20 6465 705f 6d61 705f 6b65 7973  un, dep_map_keys
-00023020: 2c20 6b65 793d 6465 702c 2076 6973 6974  , key=dep, visit
-00023030: 6564 3d76 6973 6974 6564 0a20 2020 2020  ed=visited.     
-00023040: 2020 2029 0a20 2020 2020 2020 2064 6570     ).        dep
-00023050: 5f6d 6170 5b6b 6579 5d2e 7570 6461 7465  _map[key].update
-00023060: 2864 6f77 6e73 7472 6561 6d5f 6465 705f  (downstream_dep_
-00023070: 6d61 705b 6465 705d 290a 2020 2020 2020  map[dep]).      
-00023080: 2020 6465 705f 6d61 705b 6b65 795d 2e75    dep_map[key].u
-00023090: 7064 6174 6528 7b64 6570 7d29 0a20 2020  pdate({dep}).   
-000230a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000230b0: 2020 2020 2020 6465 705f 6d61 705b 6b65        dep_map[ke
-000230c0: 795d 2e72 656d 6f76 6528 6b65 7929 0a20  y].remove(key). 
-000230d0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-000230e0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-000230f0: 2020 2020 7061 7373 0a0a 2020 2020 746f      pass..    to
-00023100: 5f72 756e 5b6b 6579 5d20 3d20 616c 6c5f  _run[key] = all_
-00023110: 7265 736f 7572 6365 732e 6765 7428 6b65  resources.get(ke
-00023120: 792c 207b 7d29 0a20 2020 2075 7064 6174  y, {}).    updat
-00023130: 655f 6465 705f 6d61 705f 7265 6375 7273  e_dep_map_recurs
-00023140: 6976 656c 7928 0a20 2020 2020 2020 2064  ively(.        d
-00023150: 6570 5f6d 6170 2c20 646f 776e 7374 7265  ep_map, downstre
-00023160: 616d 5f64 6570 5f6d 6170 2c20 616c 6c5f  am_dep_map, all_
-00023170: 7265 736f 7572 6365 732c 2074 6f5f 7275  resources, to_ru
-00023180: 6e2c 2064 6570 5f6d 6170 5f6b 6579 732c  n, dep_map_keys,
-00023190: 206b 6579 3d4e 6f6e 652c 2076 6973 6974   key=None, visit
-000231a0: 6564 3d76 6973 6974 6564 0a20 2020 2029  ed=visited.    )
-000231b0: 0a0a 0a64 6566 2067 656e 6572 6174 655f  ...def generate_
-000231c0: 666f 726b 646f 776e 7374 7265 616d 5f67  forkdownstream_g
-000231d0: 7261 7068 280a 2020 2020 616c 6c5f 6465  raph(.    all_de
-000231e0: 705f 6d61 703a 2044 6963 745b 7374 722c  p_map: Dict[str,
-000231f0: 2053 6574 5b73 7472 5d5d 2c0a 2020 2020   Set[str]],.    
-00023200: 616c 6c5f 7265 736f 7572 6365 733a 2044  all_resources: D
-00023210: 6963 745b 7374 722c 2044 6963 745b 7374  ict[str, Dict[st
-00023220: 722c 2041 6e79 5d5d 2c0a 2020 2020 746f  r, Any]],.    to
-00023230: 5f72 756e 3a20 4469 6374 5b73 7472 2c20  _run: Dict[str, 
-00023240: 4469 6374 5b73 7472 2c20 416e 795d 5d2c  Dict[str, Any]],
-00023250: 0a20 2020 2064 6570 5f6d 6170 5f6b 6579  .    dep_map_key
-00023260: 733a 204c 6973 745b 7374 725d 2c0a 2920  s: List[str],.) 
-00023270: 2d3e 2054 7570 6c65 5b44 6963 745b 7374  -> Tuple[Dict[st
-00023280: 722c 2053 6574 5b73 7472 5d5d 2c20 4469  r, Set[str]], Di
-00023290: 6374 5b73 7472 2c20 4469 6374 5b73 7472  ct[str, Dict[str
-000232a0: 2c20 416e 795d 5d5d 3a0a 2020 2020 2222  , Any]]]:.    ""
-000232b0: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
-000232c0: 696f 6e20 666f 7220 6120 6769 7665 6e20  ion for a given 
-000232d0: 6772 6170 6820 6f66 2064 6570 656e 6465  graph of depende
-000232e0: 6e63 6965 7320 6672 6f6d 206c 6566 7420  ncies from left 
-000232f0: 746f 2072 6967 6874 2e20 4974 2077 696c  to right. It wil
-00023300: 6c20 6765 6e65 7261 7465 2061 206e 6577  l generate a new
-00023310: 2067 7261 7068 2077 6974 6820 7468 6520   graph with the 
-00023320: 6465 7065 6e64 656e 6369 6573 2066 726f  dependencies fro
-00023330: 6d20 7269 6768 7420 746f 206c 6566 742c  m right to left,
-00023340: 2062 7574 2074 616b 696e 6720 696e 746f   but taking into
-00023350: 2061 6363 6f75 6e74 2074 6861 7420 6576   account that ev
-00023360: 656e 2069 6620 736f 6d65 206e 6f64 6573  en if some nodes
-00023370: 2061 7265 206e 6f74 2069 6e73 6964 6520   are not inside 
-00023380: 746f 5f72 756e 2c20 7468 6579 2061 7265  to_run, they are
-00023390: 2073 7469 6c6c 2064 6570 656e 6465 6e63   still dependenc
-000233a0: 6965 7320 7468 6174 206e 6565 6420 746f  ies that need to
-000233b0: 2062 6520 6465 706c 6f79 6564 2e0a 0a20   be deployed... 
-000233c0: 2020 203e 3e3e 2064 6570 732c 205f 203d     >>> deps, _ =
-000233d0: 2067 656e 6572 6174 655f 666f 726b 646f   generate_forkdo
-000233e0: 776e 7374 7265 616d 5f67 7261 7068 280a  wnstream_graph(.
-000233f0: 2020 2020 2e2e 2e20 2020 2020 7b0a 2020      ...     {.  
-00023400: 2020 2e2e 2e20 2020 2020 2020 2020 2761    ...         'a
-00023410: 273a 207b 2762 277d 2c0a 2020 2020 2e2e  ': {'b'},.    ..
-00023420: 2e20 2020 2020 2020 2020 2762 273a 207b  .         'b': {
-00023430: 2763 277d 2c0a 2020 2020 2e2e 2e20 2020  'c'},.    ...   
-00023440: 2020 2020 2020 2763 273a 2073 6574 2829        'c': set()
-00023450: 2c0a 2020 2020 2e2e 2e20 2020 2020 7d2c  ,.    ...     },
-00023460: 0a20 2020 202e 2e2e 2020 2020 207b 0a20  .    ...     {. 
-00023470: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023480: 6127 3a20 7b27 7265 736f 7572 6365 5f6e  a': {'resource_n
-00023490: 616d 6527 3a20 2761 277d 2c0a 2020 2020  ame': 'a'},.    
-000234a0: 2e2e 2e20 2020 2020 2020 2020 2762 273a  ...         'b':
-000234b0: 207b 2772 6573 6f75 7263 655f 6e61 6d65   {'resource_name
-000234c0: 273a 2027 6227 2c20 276e 6f64 6573 273a  ': 'b', 'nodes':
-000234d0: 205b 7b27 7061 7261 6d73 273a 207b 2774   [{'params': {'t
-000234e0: 7970 6527 3a20 276d 6174 6572 6961 6c69  ype': 'materiali
-000234f0: 7a65 6427 2c20 2764 6174 6173 6f75 7263  zed', 'datasourc
-00023500: 6527 3a20 2763 277d 7d5d 207d 2c0a 2020  e': 'c'}}] },.  
-00023510: 2020 2e2e 2e20 2020 2020 2020 2020 2763    ...         'c
-00023520: 273a 207b 2772 6573 6f75 7263 655f 6e61  ': {'resource_na
-00023530: 6d65 273a 2027 6327 7d2c 0a20 2020 202e  me': 'c'},.    .
-00023540: 2e2e 2020 2020 207d 2c0a 2020 2020 2e2e  ..     },.    ..
-00023550: 2e20 2020 2020 7b0a 2020 2020 2e2e 2e20  .     {.    ... 
-00023560: 2020 2020 2020 2020 2761 273a 207b 2772          'a': {'r
-00023570: 6573 6f75 7263 655f 6e61 6d65 273a 2027  esource_name': '
-00023580: 6127 7d2c 0a20 2020 202e 2e2e 2020 2020  a'},.    ...    
-00023590: 207d 2c0a 2020 2020 2e2e 2e20 2020 2020   },.    ...     
-000235a0: 5b27 6127 2c20 2762 272c 2027 6327 5d2c  ['a', 'b', 'c'],
-000235b0: 0a20 2020 202e 2e2e 2029 0a20 2020 203e  .    ... ).    >
-000235c0: 3e3e 207b 6b3a 2073 6f72 7465 6428 7629  >> {k: sorted(v)
-000235d0: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
-000235e0: 732e 6974 656d 7328 297d 0a20 2020 207b  s.items()}.    {
-000235f0: 2763 273a 205b 5d2c 2027 6227 3a20 5b27  'c': [], 'b': ['
-00023600: 6127 2c20 2763 275d 2c20 2761 273a 205b  a', 'c'], 'a': [
-00023610: 5d7d 0a0a 2020 2020 3e3e 3e20 6465 7073  ]}..    >>> deps
-00023620: 2c20 5f20 3d20 6765 6e65 7261 7465 5f66  , _ = generate_f
-00023630: 6f72 6b64 6f77 6e73 7472 6561 6d5f 6772  orkdownstream_gr
-00023640: 6170 6828 0a20 2020 202e 2e2e 2020 2020  aph(.    ...    
-00023650: 207b 0a20 2020 202e 2e2e 2020 2020 2020   {.    ...      
-00023660: 2020 2027 6127 3a20 7b27 6227 7d2c 0a20     'a': {'b'},. 
-00023670: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023680: 6227 3a20 7b27 6327 7d2c 0a20 2020 202e  b': {'c'},.    .
-00023690: 2e2e 2020 2020 2020 2020 2027 6327 3a20  ..         'c': 
-000236a0: 7365 7428 292c 0a20 2020 202e 2e2e 2020  set(),.    ...  
-000236b0: 2020 207d 2c0a 2020 2020 2e2e 2e20 2020     },.    ...   
-000236c0: 2020 7b0a 2020 2020 2e2e 2e20 2020 2020    {.    ...     
-000236d0: 2020 2020 2761 273a 207b 2772 6573 6f75      'a': {'resou
-000236e0: 7263 655f 6e61 6d65 273a 2027 6127 7d2c  rce_name': 'a'},
-000236f0: 0a20 2020 202e 2e2e 2020 2020 2020 2020  .    ...        
-00023700: 2027 6227 3a20 7b27 7265 736f 7572 6365   'b': {'resource
-00023710: 5f6e 616d 6527 3a20 2762 272c 2027 6e6f  _name': 'b', 'no
-00023720: 6465 7327 3a20 5b7b 2770 6172 616d 7327  des': [{'params'
-00023730: 3a20 7b27 7479 7065 273a 2027 6d61 7465  : {'type': 'mate
-00023740: 7269 616c 697a 6564 272c 2027 6461 7461  rialized', 'data
-00023750: 736f 7572 6365 273a 2027 6327 7d7d 5d20  source': 'c'}}] 
-00023760: 7d2c 0a20 2020 202e 2e2e 2020 2020 2020  },.    ...      
-00023770: 2020 2027 6327 3a20 7b27 7265 736f 7572     'c': {'resour
-00023780: 6365 5f6e 616d 6527 3a20 2763 277d 2c0a  ce_name': 'c'},.
-00023790: 2020 2020 2e2e 2e20 2020 2020 7d2c 0a20      ...     },. 
-000237a0: 2020 202e 2e2e 2020 2020 207b 0a20 2020     ...     {.   
-000237b0: 202e 2e2e 2020 2020 2020 2020 2027 6227   ...         'b'
-000237c0: 3a20 7b27 7265 736f 7572 6365 5f6e 616d  : {'resource_nam
-000237d0: 6527 3a20 2762 277d 2c0a 2020 2020 2e2e  e': 'b'},.    ..
-000237e0: 2e20 2020 2020 7d2c 0a20 2020 202e 2e2e  .     },.    ...
-000237f0: 2020 2020 205b 2761 272c 2027 6227 2c20       ['a', 'b', 
-00023800: 2763 275d 2c0a 2020 2020 2e2e 2e20 290a  'c'],.    ... ).
-00023810: 2020 2020 3e3e 3e20 7b6b 3a20 736f 7274      >>> {k: sort
-00023820: 6564 2876 2920 666f 7220 6b2c 2076 2069  ed(v) for k, v i
-00023830: 6e20 6465 7073 2e69 7465 6d73 2829 7d0a  n deps.items()}.
-00023840: 2020 2020 7b27 6327 3a20 5b5d 2c20 2762      {'c': [], 'b
-00023850: 273a 205b 2761 272c 2027 6327 5d2c 2027  ': ['a', 'c'], '
-00023860: 6127 3a20 5b5d 7d0a 0a20 2020 203e 3e3e  a': []}..    >>>
-00023870: 2064 6570 732c 205f 203d 2067 656e 6572   deps, _ = gener
-00023880: 6174 655f 666f 726b 646f 776e 7374 7265  ate_forkdownstre
-00023890: 616d 5f67 7261 7068 280a 2020 2020 2e2e  am_graph(.    ..
-000238a0: 2e20 2020 2020 7b0a 2020 2020 2e2e 2e20  .     {.    ... 
-000238b0: 2020 2020 2020 2020 276d 6967 7261 7465          'migrate
-000238c0: 645f 5f61 273a 207b 2761 277d 2c0a 2020  d__a': {'a'},.  
-000238d0: 2020 2e2e 2e20 2020 2020 2020 2020 2761    ...         'a
-000238e0: 273a 207b 2762 277d 2c0a 2020 2020 2e2e  ': {'b'},.    ..
-000238f0: 2e20 2020 2020 2020 2020 2762 273a 207b  .         'b': {
-00023900: 2763 277d 2c0a 2020 2020 2e2e 2e20 2020  'c'},.    ...   
-00023910: 2020 2020 2020 2763 273a 2073 6574 2829        'c': set()
-00023920: 2c0a 2020 2020 2e2e 2e20 2020 2020 7d2c  ,.    ...     },
-00023930: 0a20 2020 202e 2e2e 2020 2020 207b 0a20  .    ...     {. 
-00023940: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023950: 6d69 6772 6174 6564 5f5f 6127 3a20 7b27  migrated__a': {'
-00023960: 7265 736f 7572 6365 5f6e 616d 6527 3a20  resource_name': 
-00023970: 276d 6967 7261 7465 645f 5f61 272c 2027  'migrated__a', '
-00023980: 6e6f 6465 7327 3a20 5b7b 2770 6172 616d  nodes': [{'param
-00023990: 7327 3a20 7b27 7479 7065 273a 2027 6d61  s': {'type': 'ma
-000239a0: 7465 7269 616c 697a 6564 272c 2027 6461  terialized', 'da
-000239b0: 7461 736f 7572 6365 273a 2027 6127 7d7d  tasource': 'a'}}
-000239c0: 5d7d 2c0a 2020 2020 2e2e 2e20 2020 2020  ]},.    ...     
-000239d0: 2020 2020 2761 273a 207b 2772 6573 6f75      'a': {'resou
-000239e0: 7263 655f 6e61 6d65 273a 2027 6127 7d2c  rce_name': 'a'},
-000239f0: 0a20 2020 202e 2e2e 2020 2020 2020 2020  .    ...        
-00023a00: 2027 6227 3a20 7b27 7265 736f 7572 6365   'b': {'resource
-00023a10: 5f6e 616d 6527 3a20 2762 272c 2027 6e6f  _name': 'b', 'no
-00023a20: 6465 7327 3a20 5b7b 2770 6172 616d 7327  des': [{'params'
-00023a30: 3a20 7b27 7479 7065 273a 2027 6d61 7465  : {'type': 'mate
-00023a40: 7269 616c 697a 6564 272c 2027 6461 7461  rialized', 'data
-00023a50: 736f 7572 6365 273a 2027 6327 7d7d 5d20  source': 'c'}}] 
-00023a60: 7d2c 0a20 2020 202e 2e2e 2020 2020 2020  },.    ...      
-00023a70: 2020 2027 6327 3a20 7b27 7265 736f 7572     'c': {'resour
-00023a80: 6365 5f6e 616d 6527 3a20 2763 277d 2c0a  ce_name': 'c'},.
-00023a90: 2020 2020 2e2e 2e20 2020 2020 7d2c 0a20      ...     },. 
-00023aa0: 2020 202e 2e2e 2020 2020 207b 0a20 2020     ...     {.   
-00023ab0: 202e 2e2e 2020 2020 2020 2020 2027 6d69   ...         'mi
-00023ac0: 6772 6174 6564 5f5f 6127 3a20 7b27 7265  grated__a': {'re
-00023ad0: 736f 7572 6365 5f6e 616d 6527 3a20 276d  source_name': 'm
-00023ae0: 6967 7261 7465 645f 5f61 277d 2c0a 2020  igrated__a'},.  
-00023af0: 2020 2e2e 2e20 2020 2020 2020 2020 2761    ...         'a
-00023b00: 273a 207b 2772 6573 6f75 7263 655f 6e61  ': {'resource_na
-00023b10: 6d65 273a 2027 6127 7d2c 0a20 2020 202e  me': 'a'},.    .
-00023b20: 2e2e 2020 2020 207d 2c0a 2020 2020 2e2e  ..     },.    ..
-00023b30: 2e20 2020 2020 5b27 6d69 6772 6174 6564  .     ['migrated
-00023b40: 5f61 272c 2027 6127 2c20 2762 272c 2027  _a', 'a', 'b', '
-00023b50: 6327 5d2c 0a20 2020 202e 2e2e 2029 0a20  c'],.    ... ). 
-00023b60: 2020 203e 3e3e 207b 6b3a 2073 6f72 7465     >>> {k: sorte
-00023b70: 6428 7629 2066 6f72 206b 2c20 7620 696e  d(v) for k, v in
-00023b80: 2064 6570 732e 6974 656d 7328 297d 0a20   deps.items()}. 
-00023b90: 2020 207b 2763 273a 205b 5d2c 2027 6227     {'c': [], 'b'
-00023ba0: 3a20 5b27 6127 2c20 2763 275d 2c20 2761  : ['a', 'c'], 'a
-00023bb0: 273a 205b 5d2c 2027 6d69 6772 6174 6564  ': [], 'migrated
-00023bc0: 5f61 273a 205b 5d7d 0a20 2020 2022 2222  _a': []}.    """
-00023bd0: 0a20 2020 2064 6f77 6e73 7472 6561 6d5f  .    downstream_
-00023be0: 6465 705f 6d61 7020 3d20 6372 6561 7465  dep_map = create
-00023bf0: 5f64 6f77 6e73 7472 6561 6d5f 6465 7065  _downstream_depe
-00023c00: 6e64 656e 6379 5f67 7261 7068 2861 6c6c  ndency_graph(all
-00023c10: 5f64 6570 5f6d 6170 2c20 616c 6c5f 7265  _dep_map, all_re
-00023c20: 736f 7572 6365 7329 0a20 2020 206e 6577  sources).    new
-00023c30: 5f64 6570 5f6d 6170 3a20 4469 6374 5b73  _dep_map: Dict[s
-00023c40: 7472 2c20 5365 745b 7374 725d 5d20 3d20  tr, Set[str]] = 
-00023c50: 7b7d 0a20 2020 206e 6577 5f74 6f5f 7275  {}.    new_to_ru
-00023c60: 6e20 3d20 6465 6570 636f 7079 2874 6f5f  n = deepcopy(to_
-00023c70: 7275 6e29 0a20 2020 2075 7064 6174 655f  run).    update_
-00023c80: 6465 705f 6d61 705f 7265 6375 7273 6976  dep_map_recursiv
-00023c90: 656c 7928 6e65 775f 6465 705f 6d61 702c  ely(new_dep_map,
-00023ca0: 2064 6f77 6e73 7472 6561 6d5f 6465 705f   downstream_dep_
-00023cb0: 6d61 702c 2061 6c6c 5f72 6573 6f75 7263  map, all_resourc
-00023cc0: 6573 2c20 6e65 775f 746f 5f72 756e 2c20  es, new_to_run, 
-00023cd0: 6465 705f 6d61 705f 6b65 7973 290a 2020  dep_map_keys).  
-00023ce0: 2020 7265 7475 726e 206e 6577 5f64 6570    return new_dep
-00023cf0: 5f6d 6170 2c20 6e65 775f 746f 5f72 756e  _map, new_to_run
-00023d00: 0a0a 0a40 6461 7461 636c 6173 730a 636c  ...@dataclass.cl
-00023d10: 6173 7320 4772 6170 6844 6570 656e 6465  ass GraphDepende
-00023d20: 6e63 6965 733a 0a20 2020 2022 2222 0a20  ncies:.    """. 
-00023d30: 2020 2054 6869 7320 636c 6173 7320 6973     This class is
-00023d40: 2075 7365 6420 746f 2073 746f 7265 2074   used to store t
-00023d50: 6865 2064 6570 656e 6465 6e63 6965 7320  he dependencies 
-00023d60: 6772 6170 6820 616e 6420 7468 6520 7265  graph and the re
-00023d70: 736f 7572 6365 7320 7468 6174 2061 7265  sources that are
-00023d80: 2067 6f69 6e67 2074 6f20 6265 2064 6570   going to be dep
-00023d90: 6c6f 7965 640a 2020 2020 2222 220a 0a20  loyed.    """.. 
-00023da0: 2020 2064 6570 5f6d 6170 3a20 4469 6374     dep_map: Dict
-00023db0: 5b73 7472 2c20 5365 745b 7374 725d 5d0a  [str, Set[str]].
-00023dc0: 2020 2020 746f 5f72 756e 3a20 4469 6374      to_run: Dict
-00023dd0: 5b73 7472 2c20 4469 6374 5b73 7472 2c20  [str, Dict[str, 
-00023de0: 416e 795d 5d0a 0a20 2020 2023 2054 6865  Any]]..    # The
-00023df0: 2073 616d 6520 6173 2061 626f 7665 2062   same as above b
-00023e00: 7574 2066 6f72 2074 6865 2077 686f 6c65  ut for the whole
-00023e10: 2070 726f 6a65 6374 2c20 6e6f 7420 6a75   project, not ju
-00023e20: 7374 2074 6865 2072 6573 6f75 7263 6573  st the resources
-00023e30: 2061 6666 6563 7465 6420 6279 2074 6865   affected by the
-00023e40: 2063 7572 7265 6e74 2064 6570 6c6f 796d   current deploym
-00023e50: 656e 740a 2020 2020 616c 6c5f 6465 705f  ent.    all_dep_
-00023e60: 6d61 703a 2044 6963 745b 7374 722c 2053  map: Dict[str, S
-00023e70: 6574 5b73 7472 5d5d 0a20 2020 2061 6c6c  et[str]].    all
-00023e80: 5f72 6573 6f75 7263 6573 3a20 4469 6374  _resources: Dict
-00023e90: 5b73 7472 2c20 4469 6374 5b73 7472 2c20  [str, Dict[str, 
-00023ea0: 416e 795d 5d0a 0a0a 6173 796e 6320 6465  Any]]...async de
-00023eb0: 6620 6275 696c 645f 6772 6170 6828 0a20  f build_graph(. 
-00023ec0: 2020 2066 696c 656e 616d 6573 3a20 4974     filenames: It
-00023ed0: 6572 6162 6c65 5b73 7472 5d2c 0a20 2020  erable[str],.   
-00023ee0: 2074 625f 636c 6965 6e74 3a20 5469 6e79   tb_client: Tiny
-00023ef0: 422c 0a20 2020 2064 6972 5f70 6174 683a  B,.    dir_path:
-00023f00: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00023f10: 204e 6f6e 652c 0a20 2020 2072 6573 6f75   None,.    resou
-00023f20: 7263 655f 7665 7273 696f 6e73 3d4e 6f6e  rce_versions=Non
-00023f30: 652c 0a20 2020 2077 6f72 6b73 7061 6365  e,.    workspace
-00023f40: 5f6d 6170 3a20 4f70 7469 6f6e 616c 5b44  _map: Optional[D
-00023f50: 6963 745d 203d 204e 6f6e 652c 0a20 2020  ict] = None,.   
-00023f60: 2070 726f 6365 7373 5f64 6570 656e 6465   process_depende
-00023f70: 6e63 6965 733a 2062 6f6f 6c20 3d20 4661  ncies: bool = Fa
-00023f80: 6c73 652c 0a20 2020 2076 6572 626f 7365  lse,.    verbose
-00023f90: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00023fa0: 2020 2020 736b 6970 5f63 6f6e 6e65 6374      skip_connect
-00023fb0: 6f72 733a 2062 6f6f 6c20 3d20 4661 6c73  ors: bool = Fals
-00023fc0: 652c 0a20 2020 2077 6f72 6b73 7061 6365  e,.    workspace
-00023fd0: 5f6c 6962 5f70 6174 6873 3a20 4f70 7469  _lib_paths: Opti
-00023fe0: 6f6e 616c 5b4c 6973 745b 5475 706c 655b  onal[List[Tuple[
-00023ff0: 7374 722c 2073 7472 5d5d 5d20 3d20 4e6f  str, str]]] = No
-00024000: 6e65 2c0a 2020 2020 6375 7272 656e 745f  ne,.    current_
-00024010: 7773 3a20 4f70 7469 6f6e 616c 5b44 6963  ws: Optional[Dic
-00024020: 745b 7374 722c 2041 6e79 5d5d 203d 204e  t[str, Any]] = N
-00024030: 6f6e 652c 0a20 2020 2063 6861 6e67 6564  one,.    changed
-00024040: 3a20 4f70 7469 6f6e 616c 5b44 6963 745b  : Optional[Dict[
-00024050: 7374 722c 2041 6e79 5d5d 203d 204e 6f6e  str, Any]] = Non
-00024060: 652c 0a20 2020 206f 6e6c 795f 6368 616e  e,.    only_chan
-00024070: 6765 733a 2062 6f6f 6c20 3d20 4661 6c73  ges: bool = Fals
-00024080: 652c 0a20 2020 2066 6f72 6b5f 646f 776e  e,.    fork_down
-00024090: 7374 7265 616d 3a20 4f70 7469 6f6e 616c  stream: Optional
-000240a0: 5b62 6f6f 6c5d 203d 2046 616c 7365 2c0a  [bool] = False,.
-000240b0: 2020 2020 6973 5f69 6e74 6572 6e61 6c3a      is_internal:
-000240c0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-000240d0: 3d20 4661 6c73 652c 0a29 202d 3e20 4772  = False,.) -> Gr
-000240e0: 6170 6844 6570 656e 6465 6e63 6965 733a  aphDependencies:
-000240f0: 0a20 2020 2022 2222 0a20 2020 2054 6869  .    """.    Thi
-00024100: 7320 6d65 7468 6f64 2077 696c 6c20 6765  s method will ge
-00024110: 6e65 7261 7465 2061 2064 6570 656e 6465  nerate a depende
-00024120: 6e63 7920 6772 6170 6820 666f 7220 7468  ncy graph for th
-00024130: 6520 6769 7665 6e20 6669 6c65 732e 2049  e given files. I
-00024140: 7420 7769 6c6c 2061 6c73 6f20 7265 7475  t will also retu
-00024150: 726e 2061 206d 6170 206f 6620 616c 6c20  rn a map of all 
-00024160: 7468 6520 7265 736f 7572 6365 7320 7468  the resources th
-00024170: 6174 2061 7265 2067 6f69 6e67 2074 6f20  at are going to 
-00024180: 6265 2064 6570 6c6f 7965 642e 0a20 2020  be deployed..   
-00024190: 2042 7920 6465 6661 756c 7420 6974 2077   By default it w
-000241a0: 696c 6c20 6765 6e65 7261 7465 2074 6865  ill generate the
-000241b0: 2067 7261 7068 2066 726f 6d20 6c65 6674   graph from left
-000241c0: 2074 6f20 7269 6768 742c 2062 7574 2069   to right, but i
-000241d0: 6620 666f 726b 2d64 6f77 6e73 7472 6561  f fork-downstrea
-000241e0: 6d2c 2069 7420 7769 6c6c 2067 656e 6572  m, it will gener
-000241f0: 6174 6520 7468 6520 6772 6170 6820 6672  ate the graph fr
-00024200: 6f6d 2072 6967 6874 2074 6f20 6c65 6674  om right to left
-00024210: 2e0a 2020 2020 2222 220a 2020 2020 746f  ..    """.    to
-00024220: 5f72 756e 3a20 4469 6374 5b73 7472 2c20  _run: Dict[str, 
-00024230: 416e 795d 203d 207b 7d0a 2020 2020 6465  Any] = {}.    de
-00024240: 7073 3a20 4c69 7374 5b73 7472 5d20 3d20  ps: List[str] = 
-00024250: 5b5d 0a20 2020 2064 6570 5f6d 6170 3a20  [].    dep_map: 
-00024260: 4469 6374 5b73 7472 2c20 416e 795d 203d  Dict[str, Any] =
-00024270: 207b 7d0a 2020 2020 656d 6265 6464 6564   {}.    embedded
-00024280: 5f64 6174 6173 6f75 7263 6573 203d 207b  _datasources = {
-00024290: 7d0a 2020 2020 6966 206e 6f74 2077 6f72  }.    if not wor
-000242a0: 6b73 7061 6365 5f6d 6170 3a0a 2020 2020  kspace_map:.    
-000242b0: 2020 2020 776f 726b 7370 6163 655f 6d61      workspace_ma
-000242c0: 7020 3d20 7b7d 0a0a 2020 2020 2320 5468  p = {}..    # Th
-000242d0: 6573 6520 6469 6374 696f 6e61 7269 6573  ese dictionaries
-000242e0: 2061 7265 2075 7365 6420 746f 2073 746f   are used to sto
-000242f0: 7265 2061 6c6c 2074 6865 2072 6573 6f75  re all the resou
-00024300: 7263 6573 2061 6e64 2074 6865 7265 2064  rces and there d
-00024310: 6570 656e 6465 6e63 6965 7320 666f 7220  ependencies for 
-00024320: 7468 6520 7768 6f6c 6520 7072 6f6a 6563  the whole projec
-00024330: 740a 2020 2020 2320 5468 6973 2069 7320  t.    # This is 
-00024340: 7573 6564 2066 6f72 2074 6865 2064 6f77  used for the dow
-00024350: 6e73 7472 6561 6d20 6465 7065 6e64 656e  nstream dependen
-00024360: 6379 2067 7261 7068 0a20 2020 2061 6c6c  cy graph.    all
-00024370: 5f64 6570 5f6d 6170 3a20 4469 6374 5b73  _dep_map: Dict[s
-00024380: 7472 2c20 5365 745b 7374 725d 5d20 3d20  tr, Set[str]] = 
-00024390: 7b7d 0a20 2020 2061 6c6c 5f72 6573 6f75  {}.    all_resou
-000243a0: 7263 6573 3a20 4469 6374 5b73 7472 2c20  rces: Dict[str, 
-000243b0: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
-000243c0: 3d20 7b7d 0a0a 2020 2020 6966 2064 6972  = {}..    if dir
-000243d0: 5f70 6174 6820 6973 204e 6f6e 653a 0a20  _path is None:. 
-000243e0: 2020 2020 2020 2064 6972 5f70 6174 6820         dir_path 
-000243f0: 3d20 6f73 2e67 6574 6377 6428 290a 0a20  = os.getcwd().. 
-00024400: 2020 2023 2057 6865 6e20 7573 696e 6720     # When using 
-00024410: 666f 726b 2d64 6f77 6e73 7472 6561 6d20  fork-downstream 
-00024420: 6f72 202d 2d6f 6e6c 792d 6368 616e 6765  or --only-change
-00024430: 732c 2077 6520 6e65 6564 2074 6f20 6765  s, we need to ge
-00024440: 6e65 7261 7465 2061 6c6c 2074 6865 2067  nerate all the g
-00024450: 7261 7068 206f 6620 616c 6c20 7468 6520  raph of all the 
-00024460: 7265 736f 7572 6365 7320 616e 6420 7468  resources and th
-00024470: 6569 7220 6465 7065 6e64 656e 6369 6573  eir dependencies
-00024480: 0a20 2020 2023 2054 6869 7320 7761 7920  .    # This way 
-00024490: 7765 2063 616e 2061 6464 206d 6f72 6520  we can add more 
-000244a0: 7265 736f 7572 6365 7320 696e 746f 2074  resources into t
-000244b0: 6865 2074 6f5f 7275 6e20 6469 6374 696f  he to_run dictio
-000244c0: 6e61 7279 2069 6620 6e65 6564 6564 2e0a  nary if needed..
-000244d0: 2020 2020 6966 2070 726f 6365 7373 5f64      if process_d
-000244e0: 6570 656e 6465 6e63 6965 7320 616e 6420  ependencies and 
-000244f0: 6f6e 6c79 5f63 6861 6e67 6573 3a0a 2020  only_changes:.  
-00024500: 2020 2020 2020 616c 6c5f 6465 7065 6e64        all_depend
-00024510: 656e 6369 6573 5f67 7261 7068 203d 2061  encies_graph = a
-00024520: 7761 6974 2062 7569 6c64 5f67 7261 7068  wait build_graph
-00024530: 280a 2020 2020 2020 2020 2020 2020 6765  (.            ge
-00024540: 745f 7072 6f6a 6563 745f 6669 6c65 6e61  t_project_filena
-00024550: 6d65 7328 6469 725f 7061 7468 292c 0a20  mes(dir_path),. 
-00024560: 2020 2020 2020 2020 2020 2074 625f 636c             tb_cl
-00024570: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-00024580: 2020 6469 725f 7061 7468 3d64 6972 5f70    dir_path=dir_p
-00024590: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-000245a0: 2070 726f 6365 7373 5f64 6570 656e 6465   process_depende
-000245b0: 6e63 6965 733d 5472 7565 2c0a 2020 2020  ncies=True,.    
-000245c0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-000245d0: 5f76 6572 7369 6f6e 733d 7265 736f 7572  _versions=resour
-000245e0: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
-000245f0: 2020 2020 2020 2020 2077 6f72 6b73 7061           workspa
-00024600: 6365 5f6d 6170 3d77 6f72 6b73 7061 6365  ce_map=workspace
-00024610: 5f6d 6170 2c0a 2020 2020 2020 2020 2020  _map,.          
-00024620: 2020 736b 6970 5f63 6f6e 6e65 6374 6f72    skip_connector
-00024630: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00024640: 2020 2020 776f 726b 7370 6163 655f 6c69      workspace_li
-00024650: 625f 7061 7468 733d 776f 726b 7370 6163  b_paths=workspac
-00024660: 655f 6c69 625f 7061 7468 732c 0a20 2020  e_lib_paths,.   
-00024670: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00024680: 5f77 733d 6375 7272 656e 745f 7773 2c0a  _ws=current_ws,.
-00024690: 2020 2020 2020 2020 2020 2020 6368 616e              chan
-000246a0: 6765 643d 4e6f 6e65 2c0a 2020 2020 2020  ged=None,.      
-000246b0: 2020 2020 2020 6f6e 6c79 5f63 6861 6e67        only_chang
-000246c0: 6573 3d46 616c 7365 2c0a 2020 2020 2020  es=False,.      
-000246d0: 2020 2020 2020 6973 5f69 6e74 6572 6e61        is_interna
-000246e0: 6c3d 6973 5f69 6e74 6572 6e61 6c2c 0a20  l=is_internal,. 
-000246f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00024700: 2061 6c6c 5f64 6570 5f6d 6170 203d 2061   all_dep_map = a
-00024710: 6c6c 5f64 6570 656e 6465 6e63 6965 735f  ll_dependencies_
-00024720: 6772 6170 682e 6465 705f 6d61 700a 2020  graph.dep_map.  
-00024730: 2020 2020 2020 616c 6c5f 7265 736f 7572        all_resour
-00024740: 6365 7320 3d20 616c 6c5f 6465 7065 6e64  ces = all_depend
-00024750: 656e 6369 6573 5f67 7261 7068 2e74 6f5f  encies_graph.to_
-00024760: 7275 6e0a 0a20 2020 2061 7379 6e63 2064  run..    async d
-00024770: 6566 2070 726f 6365 7373 280a 2020 2020  ef process(.    
-00024780: 2020 2020 6669 6c65 6e61 6d65 3a20 7374      filename: st
-00024790: 722c 0a20 2020 2020 2020 2064 6570 733a  r,.        deps:
-000247a0: 204c 6973 745b 7374 725d 2c0a 2020 2020   List[str],.    
-000247b0: 2020 2020 6465 705f 6d61 703a 2044 6963      dep_map: Dic
-000247c0: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-000247d0: 2020 2020 2074 6f5f 7275 6e3a 2044 6963       to_run: Dic
-000247e0: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-000247f0: 2020 2020 2077 6f72 6b73 7061 6365 5f6c       workspace_l
-00024800: 6962 5f70 6174 6873 3a20 4f70 7469 6f6e  ib_paths: Option
-00024810: 616c 5b4c 6973 745b 5475 706c 655b 7374  al[List[Tuple[st
-00024820: 722c 2073 7472 5d5d 5d2c 0a20 2020 2029  r, str]]],.    )
-00024830: 3a0a 2020 2020 2020 2020 6e61 6d65 2c20  :.        name, 
-00024840: 6b69 6e64 203d 2066 696c 656e 616d 652e  kind = filename.
-00024850: 7273 706c 6974 2822 2e22 2c20 3129 0a0a  rsplit(".", 1)..
-00024860: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00024870: 2020 2020 2020 2020 2072 6573 203d 2061           res = a
-00024880: 7761 6974 2070 726f 6365 7373 5f66 696c  wait process_fil
-00024890: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-000248a0: 2020 2066 696c 656e 616d 652c 0a20 2020     filename,.   
-000248b0: 2020 2020 2020 2020 2020 2020 2074 625f               tb_
-000248c0: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-000248d0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-000248e0: 5f76 6572 7369 6f6e 733d 7265 736f 7572  _versions=resour
-000248f0: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
-00024900: 2020 2020 2020 2020 2020 2020 2073 6b69               ski
-00024910: 705f 636f 6e6e 6563 746f 7273 3d73 6b69  p_connectors=ski
-00024920: 705f 636f 6e6e 6563 746f 7273 2c0a 2020  p_connectors,.  
-00024930: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00024940: 726b 7370 6163 655f 6d61 703d 776f 726b  rkspace_map=work
-00024950: 7370 6163 655f 6d61 702c 0a20 2020 2020  space_map,.     
-00024960: 2020 2020 2020 2020 2020 2077 6f72 6b73             works
-00024970: 7061 6365 5f6c 6962 5f70 6174 6873 3d77  pace_lib_paths=w
-00024980: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
-00024990: 6873 2c0a 2020 2020 2020 2020 2020 2020  hs,.            
-000249a0: 2020 2020 6375 7272 656e 745f 7773 3d63      current_ws=c
-000249b0: 7572 7265 6e74 5f77 732c 0a20 2020 2020  urrent_ws,.     
-000249c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000249d0: 2065 7863 6570 7420 636c 6963 6b2e 436c   except click.Cl
-000249e0: 6963 6b45 7863 6570 7469 6f6e 2061 7320  ickException as 
-000249f0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00024a00: 6169 7365 2065 0a20 2020 2020 2020 2065  aise e.        e
-00024a10: 7863 6570 7420 496e 636c 7564 6546 696c  xcept IncludeFil
-00024a20: 654e 6f74 466f 756e 6445 7863 6570 7469  eNotFoundExcepti
-00024a30: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00024a40: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-00024a50: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-00024a60: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00024a70: 6572 726f 725f 6465 6c65 7465 645f 696e  error_deleted_in
-00024a80: 636c 7564 6528 696e 636c 7564 655f 6669  clude(include_fi
-00024a90: 6c65 3d73 7472 2865 292c 2066 696c 656e  le=str(e), filen
-00024aa0: 616d 653d 6669 6c65 6e61 6d65 2929 0a20  ame=filename)). 
-00024ab0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00024ac0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00024ad0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00024ae0: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-00024af0: 7469 6f6e 2873 7472 2865 2929 0a0a 2020  tion(str(e))..  
-00024b00: 2020 2020 2020 666f 7220 7220 696e 2072        for r in r
-00024b10: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00024b20: 666e 203d 2072 5b22 7265 736f 7572 6365  fn = r["resource
-00024b30: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
-00024b40: 2020 2020 6966 2063 6861 6e67 6564 2061      if changed a
-00024b50: 6e64 2066 6e20 696e 2063 6861 6e67 6564  nd fn in changed
-00024b60: 2061 6e64 2028 6e6f 7420 6368 616e 6765   and (not change
-00024b70: 645b 666e 5d20 6f72 2063 6861 6e67 6564  d[fn] or changed
-00024b80: 5b66 6e5d 2069 6e20 5b22 7368 6172 6564  [fn] in ["shared
-00024b90: 222c 2022 7265 6d6f 7465 225d 293a 0a20  ", "remote"]):. 
-00024ba0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00024bb0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00024bc0: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
-00024bd0: 2020 2020 2020 2020 2020 666f 726b 5f64            fork_d
-00024be0: 6f77 6e73 7472 6561 6d0a 2020 2020 2020  ownstream.      
-00024bf0: 2020 2020 2020 2020 2020 616e 6420 722e            and r.
-00024c00: 6765 7428 2272 6573 6f75 7263 6522 2c20  get("resource", 
-00024c10: 2222 2920 3d3d 2022 7069 7065 7322 0a20  "") == "pipes". 
-00024c20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00024c30: 6e64 2061 6e79 285b 2265 6e67 696e 6522  nd any(["engine"
-00024c40: 2069 6e20 782e 6765 7428 2270 6172 616d   in x.get("param
-00024c50: 7322 2c20 7b7d 2920 666f 7220 7820 696e  s", {}) for x in
-00024c60: 2072 2e67 6574 2822 6e6f 6465 7322 2c20   r.get("nodes", 
-00024c70: 5b5d 295d 290a 2020 2020 2020 2020 2020  [])]).          
-00024c80: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00024c90: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-00024ca0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-00024cb0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00024cc0: 6572 726f 725f 666f 726b 646f 776e 7374  error_forkdownst
-00024cd0: 7265 616d 5f70 6970 6573 5f77 6974 685f  ream_pipes_with_
-00024ce0: 656e 6769 6e65 2870 6970 653d 666e 2929  engine(pipe=fn))
-00024cf0: 0a0a 2020 2020 2020 2020 2020 2020 746f  ..            to
-00024d00: 5f72 756e 5b66 6e5d 203d 2072 0a20 2020  _run[fn] = r.   
-00024d10: 2020 2020 2020 2020 2066 696c 655f 6465           file_de
-00024d20: 7073 203d 2072 2e67 6574 2822 6465 7073  ps = r.get("deps
-00024d30: 222c 205b 5d29 0a20 2020 2020 2020 2020  ", []).         
-00024d40: 2020 2064 6570 7320 2b3d 2066 696c 655f     deps += file_
-00024d50: 6465 7073 0a20 2020 2020 2020 2020 2020  deps.           
-00024d60: 2023 2063 616c 6375 6c61 7465 2061 6e64   # calculate and
-00024d70: 206c 6f6f 6b20 666f 7220 6465 7073 0a20   look for deps. 
-00024d80: 2020 2020 2020 2020 2020 2064 6570 5f6c             dep_l
-00024d90: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-00024da0: 2020 2020 2066 6f72 2078 2069 6e20 6669       for x in fi
-00024db0: 6c65 5f64 6570 733a 0a20 2020 2020 2020  le_deps:.       
-00024dc0: 2020 2020 2020 2020 2069 6620 7820 6e6f           if x no
-00024dd0: 7420 696e 2049 4e54 4552 4e41 4c5f 5441  t in INTERNAL_TA
-00024de0: 424c 4553 206f 7220 6973 5f69 6e74 6572  BLES or is_inter
-00024df0: 6e61 6c3a 0a20 2020 2020 2020 2020 2020  nal:.           
-00024e00: 2020 2020 2020 2020 2066 2c20 6473 203d           f, ds =
-00024e10: 2066 696e 645f 6669 6c65 5f62 795f 6e61   find_file_by_na
-00024e20: 6d65 2864 6972 5f70 6174 682c 2078 2c20  me(dir_path, x, 
-00024e30: 7665 7262 6f73 652c 2077 6f72 6b73 7061  verbose, workspa
-00024e40: 6365 5f6c 6962 5f70 6174 6873 3d77 6f72  ce_lib_paths=wor
-00024e50: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
-00024e60: 2c20 7265 736f 7572 6365 3d72 290a 2020  , resource=r).  
-00024e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e80: 2020 6966 2066 3a0a 2020 2020 2020 2020    if f:.        
-00024e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ea0: 6465 705f 6c69 7374 2e61 7070 656e 6428  dep_list.append(
-00024eb0: 662e 7273 706c 6974 2822 2e22 2c20 3129  f.rsplit(".", 1)
-00024ec0: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-00024ed0: 2020 2020 2020 2020 2069 6620 6473 3a0a           if ds:.
-00024ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ef0: 2020 2020 2020 2020 6473 5f66 6e20 3d20          ds_fn = 
-00024f00: 6473 5b22 7265 736f 7572 6365 5f6e 616d  ds["resource_nam
-00024f10: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-00024f20: 2020 2020 2020 2020 2020 2020 7072 6576              prev
-00024f30: 203d 2074 6f5f 7275 6e2e 6765 7428 6473   = to_run.get(ds
-00024f40: 5f66 6e2c 207b 7d29 0a20 2020 2020 2020  _fn, {}).       
-00024f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f60: 2074 6f5f 7275 6e5b 6473 5f66 6e5d 203d   to_run[ds_fn] =
-00024f70: 2064 6565 7063 6f70 7928 7229 0a20 2020   deepcopy(r).   
-00024f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f90: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fb0: 2020 2020 2020 746f 5f72 756e 5b64 735f        to_run[ds_
-00024fc0: 666e 5d5b 2264 6570 7322 5d20 3d20 6c69  fn]["deps"] = li
-00024fd0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00024fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ff0: 2020 2020 7365 7428 746f 5f72 756e 5b64      set(to_run[d
-00025000: 735f 666e 5d2e 6765 7428 2264 6570 7322  s_fn].get("deps"
-00025010: 2c20 5b5d 2920 2b20 7072 6576 2e67 6574  , []) + prev.get
-00025020: 2822 6465 7073 222c 205b 5d29 202b 205b  ("deps", []) + [
-00025030: 666e 5d29 0a20 2020 2020 2020 2020 2020  fn]).           
-00025040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025050: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00025060: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00025070: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
-00025080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025090: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00021820: 686f 7261 7269 6f5f 5f33 5f5f 7069 7065  horario__3__pipe
+00021830: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
+00021840: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
+00021850: 6e61 6d65 5f76 6572 7369 6f6e 2827 686f  name_version('ho
+00021860: 7261 7269 6f5f 5f63 6865 636b 6572 2729  rario__checker')
+00021870: 0a20 2020 207b 276e 616d 6527 3a20 2768  .    {'name': 'h
+00021880: 6f72 6172 696f 5f5f 6368 6563 6b65 7227  orario__checker'
+00021890: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
+000218a0: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
+000218b0: 616d 655f 7665 7273 696f 6e28 2764 6576  ame_version('dev
+000218c0: 5f5f 686f 7261 7269 6f5f 5f63 6865 636b  __horario__check
+000218d0: 6572 2729 0a20 2020 207b 276e 616d 6527  er').    {'name'
+000218e0: 3a20 2764 6576 5f5f 686f 7261 7269 6f5f  : 'dev__horario_
+000218f0: 5f63 6865 636b 6572 272c 2027 7665 7273  _checker', 'vers
+00021900: 696f 6e27 3a20 4e6f 6e65 7d0a 2020 2020  ion': None}.    
+00021910: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
+00021920: 7369 6f6e 2827 7467 5f5f 6441 6374 6976  sion('tg__dActiv
+00021930: 6964 6164 6573 5f5f 7630 5f70 6970 655f  idades__v0_pipe_
+00021940: 3339 3037 2729 0a20 2020 207b 276e 616d  3907').    {'nam
+00021950: 6527 3a20 2774 675f 5f64 4163 7469 7669  e': 'tg__dActivi
+00021960: 6461 6465 7327 2c20 2776 6572 7369 6f6e  dades', 'version
+00021970: 273a 2030 7d0a 2020 2020 3e3e 3e20 6765  ': 0}.    >>> ge
+00021980: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
+00021990: 7467 5f5f 6f72 6967 696e 5f77 6f72 6b73  tg__origin_works
+000219a0: 7061 6365 2e73 6861 7265 645f 6473 5f5f  pace.shared_ds__
+000219b0: 7633 3930 3727 290a 2020 2020 7b27 6e61  v3907').    {'na
+000219c0: 6d65 273a 2027 7467 5f5f 6f72 6967 696e  me': 'tg__origin
+000219d0: 5f77 6f72 6b73 7061 6365 2e73 6861 7265  _workspace.share
+000219e0: 645f 6473 272c 2027 7665 7273 696f 6e27  d_ds', 'version'
+000219f0: 3a20 3339 3037 7d0a 2020 2020 3e3e 3e20  : 3907}.    >>> 
+00021a00: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
+00021a10: 2827 746d 7068 3865 6774 6c5f 5f27 290a  ('tmph8egtl__').
+00021a20: 2020 2020 7b27 6e61 6d65 273a 2027 746d      {'name': 'tm
+00021a30: 7068 3865 6774 6c5f 5f27 2c20 2776 6572  ph8egtl__', 'ver
+00021a40: 7369 6f6e 273a 204e 6f6e 657d 0a20 2020  sion': None}.   
+00021a50: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
+00021a60: 7273 696f 6e28 2774 6d70 6838 6567 746c  rsion('tmph8egtl
+00021a70: 5f5f 3132 335f 5f27 290a 2020 2020 7b27  __123__').    {'
+00021a80: 6e61 6d65 273a 2027 746d 7068 3865 6774  name': 'tmph8egt
+00021a90: 6c5f 5f31 3233 5f5f 272c 2027 7665 7273  l__123__', 'vers
+00021aa0: 696f 6e27 3a20 4e6f 6e65 7d0a 2020 2020  ion': None}.    
+00021ab0: 2222 220a 2020 2020 746b 203d 2064 732e  """.    tk = ds.
+00021ac0: 7273 706c 6974 2822 5f5f 222c 2032 290a  rsplit("__", 2).
+00021ad0: 2020 2020 6966 206c 656e 2874 6b29 203d      if len(tk) =
+00021ae0: 3d20 313a 0a20 2020 2020 2020 2072 6574  = 1:.        ret
+00021af0: 7572 6e20 7b22 6e61 6d65 223a 2074 6b5b  urn {"name": tk[
+00021b00: 305d 2c20 2276 6572 7369 6f6e 223a 204e  0], "version": N
+00021b10: 6f6e 657d 0a20 2020 2065 6c69 6620 6c65  one}.    elif le
+00021b20: 6e28 746b 2920 3d3d 2032 3a0a 2020 2020  n(tk) == 2:.    
+00021b30: 2020 2020 6966 206c 656e 2874 6b5b 315d      if len(tk[1]
+00021b40: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00021b50: 6620 746b 5b31 5d5b 305d 203d 3d20 2276  f tk[1][0] == "v
+00021b60: 2220 616e 6420 7265 2e6d 6174 6368 2822  " and re.match("
+00021b70: 5b30 2d39 5d2b 2422 2c20 746b 5b31 5d5b  [0-9]+$", tk[1][
+00021b80: 313a 5d29 3a0a 2020 2020 2020 2020 2020  1:]):.          
+00021b90: 2020 2020 2020 7265 7475 726e 207b 226e        return {"n
+00021ba0: 616d 6522 3a20 746b 5b30 5d2c 2022 7665  ame": tk[0], "ve
+00021bb0: 7273 696f 6e22 3a20 696e 7428 746b 5b31  rsion": int(tk[1
+00021bc0: 5d5b 313a 5d29 7d0a 2020 2020 2020 2020  ][1:])}.        
+00021bd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00021be0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021bf0: 207b 226e 616d 6522 3a20 746b 5b30 5d20   {"name": tk[0] 
+00021c00: 2b20 225f 5f22 202b 2074 6b5b 315d 2c20  + "__" + tk[1], 
+00021c10: 2276 6572 7369 6f6e 223a 204e 6f6e 657d  "version": None}
+00021c20: 0a20 2020 2065 6c69 6620 6c65 6e28 746b  .    elif len(tk
+00021c30: 2920 3d3d 2033 2061 6e64 206c 656e 2874  ) == 3 and len(t
+00021c40: 6b5b 325d 293a 0a20 2020 2020 2020 2069  k[2]):.        i
+00021c50: 6620 746b 5b32 5d20 3d3d 2022 6368 6563  f tk[2] == "chec
+00021c60: 6b65 7222 3a0a 2020 2020 2020 2020 2020  ker":.          
+00021c70: 2020 7265 7475 726e 207b 226e 616d 6522    return {"name"
+00021c80: 3a20 746b 5b30 5d20 2b20 225f 5f22 202b  : tk[0] + "__" +
+00021c90: 2074 6b5b 315d 202b 2022 5f5f 2220 2b20   tk[1] + "__" + 
+00021ca0: 746b 5b32 5d2c 2022 7665 7273 696f 6e22  tk[2], "version"
+00021cb0: 3a20 4e6f 6e65 7d0a 2020 2020 2020 2020  : None}.        
+00021cc0: 6966 2074 6b5b 325d 5b30 5d20 3d3d 2022  if tk[2][0] == "
+00021cd0: 7622 3a0a 2020 2020 2020 2020 2020 2020  v":.            
+00021ce0: 7061 7274 7320 3d20 746b 5b32 5d2e 7370  parts = tk[2].sp
+00021cf0: 6c69 7428 225f 2229 0a20 2020 2020 2020  lit("_").       
+00021d00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00021d10: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021d20: 207b 226e 616d 6522 3a20 746b 5b30 5d20   {"name": tk[0] 
+00021d30: 2b20 225f 5f22 202b 2074 6b5b 315d 2c20  + "__" + tk[1], 
+00021d40: 2276 6572 7369 6f6e 223a 2069 6e74 2870  "version": int(p
+00021d50: 6172 7473 5b30 5d5b 313a 5d29 7d0a 2020  arts[0][1:])}.  
+00021d60: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00021d70: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+00021d80: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00021d90: 7572 6e20 7b22 6e61 6d65 223a 2074 6b5b  urn {"name": tk[
+00021da0: 305d 202b 2022 5f5f 2220 2b20 746b 5b31  0] + "__" + tk[1
+00021db0: 5d20 2b20 225f 5f22 202b 2074 6b5b 325d  ] + "__" + tk[2]
+00021dc0: 2c20 2276 6572 7369 6f6e 223a 204e 6f6e  , "version": Non
+00021dd0: 657d 0a20 2020 2020 2020 2065 6c73 653a  e}.        else:
+00021de0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00021df0: 7572 6e20 7b22 6e61 6d65 223a 2022 5f5f  urn {"name": "__
+00021e00: 222e 6a6f 696e 2874 6b5b 303a 5d29 2c20  ".join(tk[0:]), 
+00021e10: 2276 6572 7369 6f6e 223a 204e 6f6e 657d  "version": None}
+00021e20: 0a0a 2020 2020 7265 7475 726e 207b 226e  ..    return {"n
+00021e30: 616d 6522 3a20 6473 2c20 2276 6572 7369  ame": ds, "versi
+00021e40: 6f6e 223a 204e 6f6e 657d 0a0a 0a64 6566  on": None}...def
+00021e50: 2067 6574 5f72 6573 6f75 7263 655f 7665   get_resource_ve
+00021e60: 7273 696f 6e73 2864 6174 6173 6f75 7263  rsions(datasourc
+00021e70: 6573 3a20 4c69 7374 5b73 7472 5d29 3a0a  es: List[str]):.
+00021e80: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
+00021e90: 726e 2074 6865 206c 6174 6573 7420 7665  rn the latest ve
+00021ea0: 7273 696f 6e20 666f 7220 616c 6c20 7468  rsion for all th
+00021eb0: 6520 6461 7461 736f 7572 6365 730a 2020  e datasources.  
+00021ec0: 2020 2222 220a 2020 2020 7665 7273 696f    """.    versio
+00021ed0: 6e73 203d 207b 7d0a 2020 2020 666f 7220  ns = {}.    for 
+00021ee0: 7820 696e 2064 6174 6173 6f75 7263 6573  x in datasources
+00021ef0: 3a0a 2020 2020 2020 2020 7420 3d20 6765  :.        t = ge
+00021f00: 745f 6e61 6d65 5f76 6572 7369 6f6e 2878  t_name_version(x
+00021f10: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
+00021f20: 2074 5b22 6e61 6d65 225d 0a20 2020 2020   t["name"].     
+00021f30: 2020 2069 6620 742e 6765 7428 2276 6572     if t.get("ver
+00021f40: 7369 6f6e 222c 204e 6f6e 6529 2069 7320  sion", None) is 
+00021f50: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00021f60: 2020 2020 2020 7665 7273 696f 6e73 5b6e        versions[n
+00021f70: 616d 655d 203d 2074 5b22 7665 7273 696f  ame] = t["versio
+00021f80: 6e22 5d0a 2020 2020 7265 7475 726e 2076  n"].    return v
+00021f90: 6572 7369 6f6e 730a 0a0a 6465 6620 6765  ersions...def ge
+00021fa0: 745f 7265 6d6f 7465 5f72 6573 6f75 7263  t_remote_resourc
+00021fb0: 655f 6e61 6d65 5f77 6974 686f 7574 5f76  e_name_without_v
+00021fc0: 6572 7369 6f6e 2872 656d 6f74 655f 7265  ersion(remote_re
+00021fd0: 736f 7572 6365 5f6e 616d 653a 2073 7472  source_name: str
+00021fe0: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
+00021ff0: 220a 2020 2020 3e3e 3e20 6765 745f 7265  ".    >>> get_re
+00022000: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
+00022010: 6d65 5f77 6974 686f 7574 5f76 6572 7369  me_without_versi
+00022020: 6f6e 2822 725f 5f64 6174 6173 6f75 7263  on("r__datasourc
+00022030: 6522 290a 2020 2020 2772 5f5f 6461 7461  e").    'r__data
+00022040: 736f 7572 6365 270a 2020 2020 3e3e 3e20  source'.    >>> 
+00022050: 6765 745f 7265 6d6f 7465 5f72 6573 6f75  get_remote_resou
+00022060: 7263 655f 6e61 6d65 5f77 6974 686f 7574  rce_name_without
+00022070: 5f76 6572 7369 6f6e 2822 725f 5f64 6174  _version("r__dat
+00022080: 6173 6f75 7263 655f 5f76 3022 290a 2020  asource__v0").  
+00022090: 2020 2772 5f5f 6461 7461 736f 7572 6365    'r__datasource
+000220a0: 270a 2020 2020 3e3e 3e20 6765 745f 7265  '.    >>> get_re
+000220b0: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
+000220c0: 6d65 5f77 6974 686f 7574 5f76 6572 7369  me_without_versi
+000220d0: 6f6e 2822 6461 7461 736f 7572 6365 2229  on("datasource")
+000220e0: 0a20 2020 2027 6461 7461 736f 7572 6365  .    'datasource
+000220f0: 270a 2020 2020 2222 220a 2020 2020 7061  '.    """.    pa
+00022100: 7274 7320 3d20 6765 745f 6e61 6d65 5f76  rts = get_name_v
+00022110: 6572 7369 6f6e 2872 656d 6f74 655f 7265  ersion(remote_re
+00022120: 736f 7572 6365 5f6e 616d 6529 0a20 2020  source_name).   
+00022130: 2072 6574 7572 6e20 7061 7274 735b 226e   return parts["n
+00022140: 616d 6522 5d0a 0a0a 6465 6620 6372 6561  ame"]...def crea
+00022150: 7465 5f64 6f77 6e73 7472 6561 6d5f 6465  te_downstream_de
+00022160: 7065 6e64 656e 6379 5f67 7261 7068 2864  pendency_graph(d
+00022170: 6570 656e 6465 6e63 795f 6772 6170 683a  ependency_graph:
+00022180: 2044 6963 745b 7374 722c 2053 6574 5b73   Dict[str, Set[s
+00022190: 7472 5d5d 2c20 616c 6c5f 7265 736f 7572  tr]], all_resour
+000221a0: 6365 733a 2044 6963 745b 7374 722c 2044  ces: Dict[str, D
+000221b0: 6963 745b 7374 722c 2041 6e79 5d5d 293a  ict[str, Any]]):
+000221c0: 0a20 2020 2022 2222 0a20 2020 2054 6869  .    """.    Thi
+000221d0: 7320 6675 6e63 7469 6f6e 2072 6576 6572  s function rever
+000221e0: 7365 7320 7468 6520 6465 7065 6e64 656e  ses the dependen
+000221f0: 6379 2067 7261 7068 206f 6274 6169 6e65  cy graph obtaine
+00022200: 6420 6672 6f6d 2062 7569 6c64 5f67 7261  d from build_gra
+00022210: 7068 2073 6f20 796f 7520 6861 7665 2064  ph so you have d
+00022220: 6f77 6e73 7472 6561 6d20 6465 7065 6e64  ownstream depend
+00022230: 656e 6369 6573 2066 6f72 2065 6163 6820  encies for each 
+00022240: 6e6f 6465 2069 6e20 7468 6520 6772 6170  node in the grap
+00022250: 682e 0a0a 2020 2020 4164 6469 7469 6f6e  h...    Addition
+00022260: 616c 6c79 2074 616b 6573 2069 6e74 6f20  ally takes into 
+00022270: 6163 636f 756e 7420 7461 7267 6574 5f64  account target_d
+00022280: 6174 6173 6f75 7263 6520 6f66 206d 6174  atasource of mat
+00022290: 6572 6961 6c69 7a65 6420 7669 6577 730a  erialized views.
+000222a0: 2020 2020 2222 220a 2020 2020 646f 776e      """.    down
+000222b0: 7374 7265 616d 5f64 6570 656e 6465 6e63  stream_dependenc
+000222c0: 795f 6772 6170 683a 2044 6963 745b 7374  y_graph: Dict[st
+000222d0: 722c 2053 6574 5b73 7472 5d5d 203d 207b  r, Set[str]] = {
+000222e0: 6e6f 6465 3a20 7365 7428 2920 666f 7220  node: set() for 
+000222f0: 6e6f 6465 2069 6e20 6465 7065 6e64 656e  node in dependen
+00022300: 6379 5f67 7261 7068 7d0a 0a20 2020 2066  cy_graph}..    f
+00022310: 6f72 206e 6f64 652c 2064 6570 656e 6465  or node, depende
+00022320: 6e63 6965 7320 696e 2064 6570 656e 6465  ncies in depende
+00022330: 6e63 795f 6772 6170 682e 6974 656d 7328  ncy_graph.items(
+00022340: 293a 0a20 2020 2020 2020 2066 6f72 2064  ):.        for d
+00022350: 6570 656e 6465 6e63 7920 696e 2064 6570  ependency in dep
+00022360: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00022370: 2020 2020 2020 2069 6620 6465 7065 6e64         if depend
+00022380: 656e 6379 206e 6f74 2069 6e20 646f 776e  ency not in down
+00022390: 7374 7265 616d 5f64 6570 656e 6465 6e63  stream_dependenc
+000223a0: 795f 6772 6170 683a 0a20 2020 2020 2020  y_graph:.       
+000223b0: 2020 2020 2020 2020 2023 2061 2073 6861           # a sha
+000223c0: 7265 6420 6461 7461 2073 6f75 7263 652c  red data source,
+000223d0: 2077 6520 6361 6e20 736b 6970 2069 740a   we can skip it.
+000223e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223f0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00022400: 2020 2020 2064 6f77 6e73 7472 6561 6d5f       downstream_
+00022410: 6465 7065 6e64 656e 6379 5f67 7261 7068  dependency_graph
+00022420: 5b64 6570 656e 6465 6e63 795d 2e61 6464  [dependency].add
+00022430: 286e 6f64 6529 0a0a 2020 2020 666f 7220  (node)..    for 
+00022440: 6b65 7920 696e 2064 6963 7428 646f 776e  key in dict(down
+00022450: 7374 7265 616d 5f64 6570 656e 6465 6e63  stream_dependenc
+00022460: 795f 6772 6170 6829 3a0a 2020 2020 2020  y_graph):.      
+00022470: 2020 7461 7267 6574 5f64 6174 6173 6f75    target_datasou
+00022480: 7263 6520 3d20 6765 745f 7461 7267 6574  rce = get_target
+00022490: 5f6d 6174 6572 6961 6c69 7a65 645f 6461  _materialized_da
+000224a0: 7461 5f73 6f75 7263 655f 6e61 6d65 2861  ta_source_name(a
+000224b0: 6c6c 5f72 6573 6f75 7263 6573 5b6b 6579  ll_resources[key
+000224c0: 5d29 0a20 2020 2020 2020 2069 6620 7461  ]).        if ta
+000224d0: 7267 6574 5f64 6174 6173 6f75 7263 653a  rget_datasource:
+000224e0: 0a20 2020 2020 2020 2020 2020 2064 6f77  .            dow
+000224f0: 6e73 7472 6561 6d5f 6465 7065 6e64 656e  nstream_dependen
+00022500: 6379 5f67 7261 7068 5b6b 6579 5d2e 7570  cy_graph[key].up
+00022510: 6461 7465 287b 7461 7267 6574 5f64 6174  date({target_dat
+00022520: 6173 6f75 7263 657d 290a 2020 2020 2020  asource}).      
+00022530: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00022540: 2020 2020 2020 2020 2020 2064 6f77 6e73             downs
+00022550: 7472 6561 6d5f 6465 7065 6e64 656e 6379  tream_dependency
+00022560: 5f67 7261 7068 5b74 6172 6765 745f 6461  _graph[target_da
+00022570: 7461 736f 7572 6365 5d2e 7265 6d6f 7665  tasource].remove
+00022580: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
+00022590: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+000225a0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+000225b0: 2020 2070 6173 730a 0a20 2020 2072 6574     pass..    ret
+000225c0: 7572 6e20 646f 776e 7374 7265 616d 5f64  urn downstream_d
+000225d0: 6570 656e 6465 6e63 795f 6772 6170 680a  ependency_graph.
+000225e0: 0a0a 6465 6620 7570 6461 7465 5f64 6570  ..def update_dep
+000225f0: 5f6d 6170 5f72 6563 7572 7369 7665 6c79  _map_recursively
+00022600: 280a 2020 2020 6465 705f 6d61 703a 2044  (.    dep_map: D
+00022610: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
+00022620: 5d5d 2c0a 2020 2020 646f 776e 7374 7265  ]],.    downstre
+00022630: 616d 5f64 6570 5f6d 6170 3a20 4469 6374  am_dep_map: Dict
+00022640: 5b73 7472 2c20 5365 745b 7374 725d 5d2c  [str, Set[str]],
+00022650: 0a20 2020 2061 6c6c 5f72 6573 6f75 7263  .    all_resourc
+00022660: 6573 3a20 4469 6374 5b73 7472 2c20 4469  es: Dict[str, Di
+00022670: 6374 5b73 7472 2c20 416e 795d 5d2c 0a20  ct[str, Any]],. 
+00022680: 2020 2074 6f5f 7275 6e3a 2044 6963 745b     to_run: Dict[
+00022690: 7374 722c 2044 6963 745b 7374 722c 2041  str, Dict[str, A
+000226a0: 6e79 5d5d 2c0a 2020 2020 6465 705f 6d61  ny]],.    dep_ma
+000226b0: 705f 6b65 7973 3a20 4c69 7374 5b73 7472  p_keys: List[str
+000226c0: 5d2c 0a20 2020 206b 6579 3a20 4f70 7469  ],.    key: Opti
+000226d0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+000226e0: 2c0a 2020 2020 7669 7369 7465 643a 204f  ,.    visited: O
+000226f0: 7074 696f 6e61 6c5b 4c69 7374 5b73 7472  ptional[List[str
+00022700: 5d5d 203d 204e 6f6e 652c 0a29 3a0a 2020  ]] = None,.):.  
+00022710: 2020 2222 220a 2020 2020 4769 7665 6e20    """.    Given 
+00022720: 6120 646f 776e 7374 7265 616d 5f64 6570  a downstream_dep
+00022730: 5f6d 6170 206f 6274 6169 6e65 6420 6672  _map obtained fr
+00022740: 6f6d 2063 7265 6174 655f 646f 776e 7374  om create_downst
+00022750: 7265 616d 5f64 6570 656e 6465 6e63 795f  ream_dependency_
+00022760: 6772 6170 6820 7468 6973 2066 756e 6374  graph this funct
+00022770: 696f 6e20 7570 6461 7465 7320 6561 6368  ion updates each
+00022780: 206e 6f64 6520 7265 6375 7273 6976 656c   node recursivel
+00022790: 7920 746f 2063 6f6d 706c 6574 6520 7468  y to complete th
+000227a0: 6520 646f 776e 7374 7265 616d 2064 6570  e downstream dep
+000227b0: 656e 6465 6e63 7920 6772 6170 6820 666f  endency graph fo
+000227c0: 7220 6561 6368 206e 6f64 650a 2020 2020  r each node.    
+000227d0: 2222 220a 2020 2020 6966 206e 6f74 2076  """.    if not v
+000227e0: 6973 6974 6564 3a0a 2020 2020 2020 2020  isited:.        
+000227f0: 7669 7369 7465 6420 3d20 6c69 7374 2829  visited = list()
+00022800: 0a20 2020 2069 6620 6e6f 7420 6b65 7920  .    if not key 
+00022810: 616e 6420 6c65 6e28 6465 705f 6d61 705f  and len(dep_map_
+00022820: 6b65 7973 2920 3d3d 2030 3a0a 2020 2020  keys) == 0:.    
+00022830: 2020 2020 7265 7475 726e 0a20 2020 2069      return.    i
+00022840: 6620 6e6f 7420 6b65 793a 0a20 2020 2020  f not key:.     
+00022850: 2020 206b 6579 203d 2064 6570 5f6d 6170     key = dep_map
+00022860: 5f6b 6579 732e 706f 7028 290a 2020 2020  _keys.pop().    
+00022870: 6966 206b 6579 206e 6f74 2069 6e20 6465  if key not in de
+00022880: 705f 6d61 703a 0a20 2020 2020 2020 2064  p_map:.        d
+00022890: 6570 5f6d 6170 5b6b 6579 5d20 3d20 7365  ep_map[key] = se
+000228a0: 7428 290a 2020 2020 656c 7365 3a0a 2020  t().    else:.  
+000228b0: 2020 2020 2020 7669 7369 7465 642e 6170        visited.ap
+000228c0: 7065 6e64 286b 6579 290a 2020 2020 2020  pend(key).      
+000228d0: 2020 7265 7475 726e 0a0a 2020 2020 666f    return..    fo
+000228e0: 7220 6465 7020 696e 2064 6f77 6e73 7472  r dep in downstr
+000228f0: 6561 6d5f 6465 705f 6d61 702e 6765 7428  eam_dep_map.get(
+00022900: 6b65 792c 207b 7d29 3a0a 2020 2020 2020  key, {}):.      
+00022910: 2020 6966 2064 6570 206e 6f74 2069 6e20    if dep not in 
+00022920: 646f 776e 7374 7265 616d 5f64 6570 5f6d  downstream_dep_m
+00022930: 6170 3a0a 2020 2020 2020 2020 2020 2020  ap:.            
+00022940: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00022950: 2074 6f5f 7275 6e5b 6465 705d 203d 2061   to_run[dep] = a
+00022960: 6c6c 5f72 6573 6f75 7263 6573 2e67 6574  ll_resources.get
+00022970: 2864 6570 2c20 7b7d 290a 2020 2020 2020  (dep, {}).      
+00022980: 2020 7570 6461 7465 5f64 6570 5f6d 6170    update_dep_map
+00022990: 5f72 6563 7572 7369 7665 6c79 280a 2020  _recursively(.  
+000229a0: 2020 2020 2020 2020 2020 6465 705f 6d61            dep_ma
+000229b0: 702c 2064 6f77 6e73 7472 6561 6d5f 6465  p, downstream_de
+000229c0: 705f 6d61 702c 2061 6c6c 5f72 6573 6f75  p_map, all_resou
+000229d0: 7263 6573 2c20 746f 5f72 756e 2c20 6465  rces, to_run, de
+000229e0: 705f 6d61 705f 6b65 7973 2c20 6b65 793d  p_map_keys, key=
+000229f0: 6465 702c 2076 6973 6974 6564 3d76 6973  dep, visited=vis
+00022a00: 6974 6564 0a20 2020 2020 2020 2029 0a20  ited.        ). 
+00022a10: 2020 2020 2020 2064 6570 5f6d 6170 5b6b         dep_map[k
+00022a20: 6579 5d2e 7570 6461 7465 2864 6f77 6e73  ey].update(downs
+00022a30: 7472 6561 6d5f 6465 705f 6d61 705b 6465  tream_dep_map[de
+00022a40: 705d 290a 2020 2020 2020 2020 6465 705f  p]).        dep_
+00022a50: 6d61 705b 6b65 795d 2e75 7064 6174 6528  map[key].update(
+00022a60: 7b64 6570 7d29 0a20 2020 2020 2020 2074  {dep}).        t
+00022a70: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00022a80: 6465 705f 6d61 705b 6b65 795d 2e72 656d  dep_map[key].rem
+00022a90: 6f76 6528 6b65 7929 0a20 2020 2020 2020  ove(key).       
+00022aa0: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+00022ab0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00022ac0: 7373 0a0a 2020 2020 746f 5f72 756e 5b6b  ss..    to_run[k
+00022ad0: 6579 5d20 3d20 616c 6c5f 7265 736f 7572  ey] = all_resour
+00022ae0: 6365 732e 6765 7428 6b65 792c 207b 7d29  ces.get(key, {})
+00022af0: 0a20 2020 2075 7064 6174 655f 6465 705f  .    update_dep_
+00022b00: 6d61 705f 7265 6375 7273 6976 656c 7928  map_recursively(
+00022b10: 0a20 2020 2020 2020 2064 6570 5f6d 6170  .        dep_map
+00022b20: 2c20 646f 776e 7374 7265 616d 5f64 6570  , downstream_dep
+00022b30: 5f6d 6170 2c20 616c 6c5f 7265 736f 7572  _map, all_resour
+00022b40: 6365 732c 2074 6f5f 7275 6e2c 2064 6570  ces, to_run, dep
+00022b50: 5f6d 6170 5f6b 6579 732c 206b 6579 3d4e  _map_keys, key=N
+00022b60: 6f6e 652c 2076 6973 6974 6564 3d76 6973  one, visited=vis
+00022b70: 6974 6564 0a20 2020 2029 0a0a 0a64 6566  ited.    )...def
+00022b80: 2067 656e 6572 6174 655f 666f 726b 646f   generate_forkdo
+00022b90: 776e 7374 7265 616d 5f67 7261 7068 280a  wnstream_graph(.
+00022ba0: 2020 2020 616c 6c5f 6465 705f 6d61 703a      all_dep_map:
+00022bb0: 2044 6963 745b 7374 722c 2053 6574 5b73   Dict[str, Set[s
+00022bc0: 7472 5d5d 2c0a 2020 2020 616c 6c5f 7265  tr]],.    all_re
+00022bd0: 736f 7572 6365 733a 2044 6963 745b 7374  sources: Dict[st
+00022be0: 722c 2044 6963 745b 7374 722c 2041 6e79  r, Dict[str, Any
+00022bf0: 5d5d 2c0a 2020 2020 746f 5f72 756e 3a20  ]],.    to_run: 
+00022c00: 4469 6374 5b73 7472 2c20 4469 6374 5b73  Dict[str, Dict[s
+00022c10: 7472 2c20 416e 795d 5d2c 0a20 2020 2064  tr, Any]],.    d
+00022c20: 6570 5f6d 6170 5f6b 6579 733a 204c 6973  ep_map_keys: Lis
+00022c30: 745b 7374 725d 2c0a 2920 2d3e 2054 7570  t[str],.) -> Tup
+00022c40: 6c65 5b44 6963 745b 7374 722c 2053 6574  le[Dict[str, Set
+00022c50: 5b73 7472 5d5d 2c20 4469 6374 5b73 7472  [str]], Dict[str
+00022c60: 2c20 4469 6374 5b73 7472 2c20 416e 795d  , Dict[str, Any]
+00022c70: 5d5d 3a0a 2020 2020 2222 220a 2020 2020  ]]:.    """.    
+00022c80: 5468 6973 2066 756e 6374 696f 6e20 666f  This function fo
+00022c90: 7220 6120 6769 7665 6e20 6772 6170 6820  r a given graph 
+00022ca0: 6f66 2064 6570 656e 6465 6e63 6965 7320  of dependencies 
+00022cb0: 6672 6f6d 206c 6566 7420 746f 2072 6967  from left to rig
+00022cc0: 6874 2e20 4974 2077 696c 6c20 6765 6e65  ht. It will gene
+00022cd0: 7261 7465 2061 206e 6577 2067 7261 7068  rate a new graph
+00022ce0: 2077 6974 6820 7468 6520 6465 7065 6e64   with the depend
+00022cf0: 656e 6369 6573 2066 726f 6d20 7269 6768  encies from righ
+00022d00: 7420 746f 206c 6566 742c 2062 7574 2074  t to left, but t
+00022d10: 616b 696e 6720 696e 746f 2061 6363 6f75  aking into accou
+00022d20: 6e74 2074 6861 7420 6576 656e 2069 6620  nt that even if 
+00022d30: 736f 6d65 206e 6f64 6573 2061 7265 206e  some nodes are n
+00022d40: 6f74 2069 6e73 6964 6520 746f 5f72 756e  ot inside to_run
+00022d50: 2c20 7468 6579 2061 7265 2073 7469 6c6c  , they are still
+00022d60: 2064 6570 656e 6465 6e63 6965 7320 7468   dependencies th
+00022d70: 6174 206e 6565 6420 746f 2062 6520 6465  at need to be de
+00022d80: 706c 6f79 6564 2e0a 0a20 2020 203e 3e3e  ployed...    >>>
+00022d90: 2064 6570 732c 205f 203d 2067 656e 6572   deps, _ = gener
+00022da0: 6174 655f 666f 726b 646f 776e 7374 7265  ate_forkdownstre
+00022db0: 616d 5f67 7261 7068 280a 2020 2020 2e2e  am_graph(.    ..
+00022dc0: 2e20 2020 2020 7b0a 2020 2020 2e2e 2e20  .     {.    ... 
+00022dd0: 2020 2020 2020 2020 2761 273a 207b 2762          'a': {'b
+00022de0: 277d 2c0a 2020 2020 2e2e 2e20 2020 2020  '},.    ...     
+00022df0: 2020 2020 2762 273a 207b 2763 277d 2c0a      'b': {'c'},.
+00022e00: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+00022e10: 2763 273a 2073 6574 2829 2c0a 2020 2020  'c': set(),.    
+00022e20: 2e2e 2e20 2020 2020 7d2c 0a20 2020 202e  ...     },.    .
+00022e30: 2e2e 2020 2020 207b 0a20 2020 202e 2e2e  ..     {.    ...
+00022e40: 2020 2020 2020 2020 2027 6127 3a20 7b27           'a': {'
+00022e50: 7265 736f 7572 6365 5f6e 616d 6527 3a20  resource_name': 
+00022e60: 2761 277d 2c0a 2020 2020 2e2e 2e20 2020  'a'},.    ...   
+00022e70: 2020 2020 2020 2762 273a 207b 2772 6573        'b': {'res
+00022e80: 6f75 7263 655f 6e61 6d65 273a 2027 6227  ource_name': 'b'
+00022e90: 2c20 276e 6f64 6573 273a 205b 7b27 7061  , 'nodes': [{'pa
+00022ea0: 7261 6d73 273a 207b 2774 7970 6527 3a20  rams': {'type': 
+00022eb0: 276d 6174 6572 6961 6c69 7a65 6427 2c20  'materialized', 
+00022ec0: 2764 6174 6173 6f75 7263 6527 3a20 2763  'datasource': 'c
+00022ed0: 277d 7d5d 207d 2c0a 2020 2020 2e2e 2e20  '}}] },.    ... 
+00022ee0: 2020 2020 2020 2020 2763 273a 207b 2772          'c': {'r
+00022ef0: 6573 6f75 7263 655f 6e61 6d65 273a 2027  esource_name': '
+00022f00: 6327 7d2c 0a20 2020 202e 2e2e 2020 2020  c'},.    ...    
+00022f10: 207d 2c0a 2020 2020 2e2e 2e20 2020 2020   },.    ...     
+00022f20: 7b0a 2020 2020 2e2e 2e20 2020 2020 2020  {.    ...       
+00022f30: 2020 2761 273a 207b 2772 6573 6f75 7263    'a': {'resourc
+00022f40: 655f 6e61 6d65 273a 2027 6127 7d2c 0a20  e_name': 'a'},. 
+00022f50: 2020 202e 2e2e 2020 2020 207d 2c0a 2020     ...     },.  
+00022f60: 2020 2e2e 2e20 2020 2020 5b27 6127 2c20    ...     ['a', 
+00022f70: 2762 272c 2027 6327 5d2c 0a20 2020 202e  'b', 'c'],.    .
+00022f80: 2e2e 2029 0a20 2020 203e 3e3e 207b 6b3a  .. ).    >>> {k:
+00022f90: 2073 6f72 7465 6428 7629 2066 6f72 206b   sorted(v) for k
+00022fa0: 2c20 7620 696e 2064 6570 732e 6974 656d  , v in deps.item
+00022fb0: 7328 297d 0a20 2020 207b 2763 273a 205b  s()}.    {'c': [
+00022fc0: 5d2c 2027 6227 3a20 5b27 6127 2c20 2763  ], 'b': ['a', 'c
+00022fd0: 275d 2c20 2761 273a 205b 5d7d 0a0a 2020  '], 'a': []}..  
+00022fe0: 2020 3e3e 3e20 6465 7073 2c20 5f20 3d20    >>> deps, _ = 
+00022ff0: 6765 6e65 7261 7465 5f66 6f72 6b64 6f77  generate_forkdow
+00023000: 6e73 7472 6561 6d5f 6772 6170 6828 0a20  nstream_graph(. 
+00023010: 2020 202e 2e2e 2020 2020 207b 0a20 2020     ...     {.   
+00023020: 202e 2e2e 2020 2020 2020 2020 2027 6127   ...         'a'
+00023030: 3a20 7b27 6227 7d2c 0a20 2020 202e 2e2e  : {'b'},.    ...
+00023040: 2020 2020 2020 2020 2027 6227 3a20 7b27           'b': {'
+00023050: 6327 7d2c 0a20 2020 202e 2e2e 2020 2020  c'},.    ...    
+00023060: 2020 2020 2027 6327 3a20 7365 7428 292c       'c': set(),
+00023070: 0a20 2020 202e 2e2e 2020 2020 207d 2c0a  .    ...     },.
+00023080: 2020 2020 2e2e 2e20 2020 2020 7b0a 2020      ...     {.  
+00023090: 2020 2e2e 2e20 2020 2020 2020 2020 2761    ...         'a
+000230a0: 273a 207b 2772 6573 6f75 7263 655f 6e61  ': {'resource_na
+000230b0: 6d65 273a 2027 6127 7d2c 0a20 2020 202e  me': 'a'},.    .
+000230c0: 2e2e 2020 2020 2020 2020 2027 6227 3a20  ..         'b': 
+000230d0: 7b27 7265 736f 7572 6365 5f6e 616d 6527  {'resource_name'
+000230e0: 3a20 2762 272c 2027 6e6f 6465 7327 3a20  : 'b', 'nodes': 
+000230f0: 5b7b 2770 6172 616d 7327 3a20 7b27 7479  [{'params': {'ty
+00023100: 7065 273a 2027 6d61 7465 7269 616c 697a  pe': 'materializ
+00023110: 6564 272c 2027 6461 7461 736f 7572 6365  ed', 'datasource
+00023120: 273a 2027 6327 7d7d 5d20 7d2c 0a20 2020  ': 'c'}}] },.   
+00023130: 202e 2e2e 2020 2020 2020 2020 2027 6327   ...         'c'
+00023140: 3a20 7b27 7265 736f 7572 6365 5f6e 616d  : {'resource_nam
+00023150: 6527 3a20 2763 277d 2c0a 2020 2020 2e2e  e': 'c'},.    ..
+00023160: 2e20 2020 2020 7d2c 0a20 2020 202e 2e2e  .     },.    ...
+00023170: 2020 2020 207b 0a20 2020 202e 2e2e 2020       {.    ...  
+00023180: 2020 2020 2020 2027 6227 3a20 7b27 7265         'b': {'re
+00023190: 736f 7572 6365 5f6e 616d 6527 3a20 2762  source_name': 'b
+000231a0: 277d 2c0a 2020 2020 2e2e 2e20 2020 2020  '},.    ...     
+000231b0: 7d2c 0a20 2020 202e 2e2e 2020 2020 205b  },.    ...     [
+000231c0: 2761 272c 2027 6227 2c20 2763 275d 2c0a  'a', 'b', 'c'],.
+000231d0: 2020 2020 2e2e 2e20 290a 2020 2020 3e3e      ... ).    >>
+000231e0: 3e20 7b6b 3a20 736f 7274 6564 2876 2920  > {k: sorted(v) 
+000231f0: 666f 7220 6b2c 2076 2069 6e20 6465 7073  for k, v in deps
+00023200: 2e69 7465 6d73 2829 7d0a 2020 2020 7b27  .items()}.    {'
+00023210: 6327 3a20 5b5d 2c20 2762 273a 205b 2761  c': [], 'b': ['a
+00023220: 272c 2027 6327 5d2c 2027 6127 3a20 5b5d  ', 'c'], 'a': []
+00023230: 7d0a 0a20 2020 203e 3e3e 2064 6570 732c  }..    >>> deps,
+00023240: 205f 203d 2067 656e 6572 6174 655f 666f   _ = generate_fo
+00023250: 726b 646f 776e 7374 7265 616d 5f67 7261  rkdownstream_gra
+00023260: 7068 280a 2020 2020 2e2e 2e20 2020 2020  ph(.    ...     
+00023270: 7b0a 2020 2020 2e2e 2e20 2020 2020 2020  {.    ...       
+00023280: 2020 276d 6967 7261 7465 645f 5f61 273a    'migrated__a':
+00023290: 207b 2761 277d 2c0a 2020 2020 2e2e 2e20   {'a'},.    ... 
+000232a0: 2020 2020 2020 2020 2761 273a 207b 2762          'a': {'b
+000232b0: 277d 2c0a 2020 2020 2e2e 2e20 2020 2020  '},.    ...     
+000232c0: 2020 2020 2762 273a 207b 2763 277d 2c0a      'b': {'c'},.
+000232d0: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+000232e0: 2763 273a 2073 6574 2829 2c0a 2020 2020  'c': set(),.    
+000232f0: 2e2e 2e20 2020 2020 7d2c 0a20 2020 202e  ...     },.    .
+00023300: 2e2e 2020 2020 207b 0a20 2020 202e 2e2e  ..     {.    ...
+00023310: 2020 2020 2020 2020 2027 6d69 6772 6174           'migrat
+00023320: 6564 5f5f 6127 3a20 7b27 7265 736f 7572  ed__a': {'resour
+00023330: 6365 5f6e 616d 6527 3a20 276d 6967 7261  ce_name': 'migra
+00023340: 7465 645f 5f61 272c 2027 6e6f 6465 7327  ted__a', 'nodes'
+00023350: 3a20 5b7b 2770 6172 616d 7327 3a20 7b27  : [{'params': {'
+00023360: 7479 7065 273a 2027 6d61 7465 7269 616c  type': 'material
+00023370: 697a 6564 272c 2027 6461 7461 736f 7572  ized', 'datasour
+00023380: 6365 273a 2027 6127 7d7d 5d7d 2c0a 2020  ce': 'a'}}]},.  
+00023390: 2020 2e2e 2e20 2020 2020 2020 2020 2761    ...         'a
+000233a0: 273a 207b 2772 6573 6f75 7263 655f 6e61  ': {'resource_na
+000233b0: 6d65 273a 2027 6127 7d2c 0a20 2020 202e  me': 'a'},.    .
+000233c0: 2e2e 2020 2020 2020 2020 2027 6227 3a20  ..         'b': 
+000233d0: 7b27 7265 736f 7572 6365 5f6e 616d 6527  {'resource_name'
+000233e0: 3a20 2762 272c 2027 6e6f 6465 7327 3a20  : 'b', 'nodes': 
+000233f0: 5b7b 2770 6172 616d 7327 3a20 7b27 7479  [{'params': {'ty
+00023400: 7065 273a 2027 6d61 7465 7269 616c 697a  pe': 'materializ
+00023410: 6564 272c 2027 6461 7461 736f 7572 6365  ed', 'datasource
+00023420: 273a 2027 6327 7d7d 5d20 7d2c 0a20 2020  ': 'c'}}] },.   
+00023430: 202e 2e2e 2020 2020 2020 2020 2027 6327   ...         'c'
+00023440: 3a20 7b27 7265 736f 7572 6365 5f6e 616d  : {'resource_nam
+00023450: 6527 3a20 2763 277d 2c0a 2020 2020 2e2e  e': 'c'},.    ..
+00023460: 2e20 2020 2020 7d2c 0a20 2020 202e 2e2e  .     },.    ...
+00023470: 2020 2020 207b 0a20 2020 202e 2e2e 2020       {.    ...  
+00023480: 2020 2020 2020 2027 6d69 6772 6174 6564         'migrated
+00023490: 5f5f 6127 3a20 7b27 7265 736f 7572 6365  __a': {'resource
+000234a0: 5f6e 616d 6527 3a20 276d 6967 7261 7465  _name': 'migrate
+000234b0: 645f 5f61 277d 2c0a 2020 2020 2e2e 2e20  d__a'},.    ... 
+000234c0: 2020 2020 2020 2020 2761 273a 207b 2772          'a': {'r
+000234d0: 6573 6f75 7263 655f 6e61 6d65 273a 2027  esource_name': '
+000234e0: 6127 7d2c 0a20 2020 202e 2e2e 2020 2020  a'},.    ...    
+000234f0: 207d 2c0a 2020 2020 2e2e 2e20 2020 2020   },.    ...     
+00023500: 5b27 6d69 6772 6174 6564 5f61 272c 2027  ['migrated_a', '
+00023510: 6127 2c20 2762 272c 2027 6327 5d2c 0a20  a', 'b', 'c'],. 
+00023520: 2020 202e 2e2e 2029 0a20 2020 203e 3e3e     ... ).    >>>
+00023530: 207b 6b3a 2073 6f72 7465 6428 7629 2066   {k: sorted(v) f
+00023540: 6f72 206b 2c20 7620 696e 2064 6570 732e  or k, v in deps.
+00023550: 6974 656d 7328 297d 0a20 2020 207b 2763  items()}.    {'c
+00023560: 273a 205b 5d2c 2027 6227 3a20 5b27 6127  ': [], 'b': ['a'
+00023570: 2c20 2763 275d 2c20 2761 273a 205b 5d2c  , 'c'], 'a': [],
+00023580: 2027 6d69 6772 6174 6564 5f61 273a 205b   'migrated_a': [
+00023590: 5d7d 0a20 2020 2022 2222 0a20 2020 2064  ]}.    """.    d
+000235a0: 6f77 6e73 7472 6561 6d5f 6465 705f 6d61  ownstream_dep_ma
+000235b0: 7020 3d20 6372 6561 7465 5f64 6f77 6e73  p = create_downs
+000235c0: 7472 6561 6d5f 6465 7065 6e64 656e 6379  tream_dependency
+000235d0: 5f67 7261 7068 2861 6c6c 5f64 6570 5f6d  _graph(all_dep_m
+000235e0: 6170 2c20 616c 6c5f 7265 736f 7572 6365  ap, all_resource
+000235f0: 7329 0a20 2020 206e 6577 5f64 6570 5f6d  s).    new_dep_m
+00023600: 6170 3a20 4469 6374 5b73 7472 2c20 5365  ap: Dict[str, Se
+00023610: 745b 7374 725d 5d20 3d20 7b7d 0a20 2020  t[str]] = {}.   
+00023620: 206e 6577 5f74 6f5f 7275 6e20 3d20 6465   new_to_run = de
+00023630: 6570 636f 7079 2874 6f5f 7275 6e29 0a20  epcopy(to_run). 
+00023640: 2020 2075 7064 6174 655f 6465 705f 6d61     update_dep_ma
+00023650: 705f 7265 6375 7273 6976 656c 7928 6e65  p_recursively(ne
+00023660: 775f 6465 705f 6d61 702c 2064 6f77 6e73  w_dep_map, downs
+00023670: 7472 6561 6d5f 6465 705f 6d61 702c 2061  tream_dep_map, a
+00023680: 6c6c 5f72 6573 6f75 7263 6573 2c20 6e65  ll_resources, ne
+00023690: 775f 746f 5f72 756e 2c20 6465 705f 6d61  w_to_run, dep_ma
+000236a0: 705f 6b65 7973 290a 2020 2020 7265 7475  p_keys).    retu
+000236b0: 726e 206e 6577 5f64 6570 5f6d 6170 2c20  rn new_dep_map, 
+000236c0: 6e65 775f 746f 5f72 756e 0a0a 0a40 6461  new_to_run...@da
+000236d0: 7461 636c 6173 730a 636c 6173 7320 4772  taclass.class Gr
+000236e0: 6170 6844 6570 656e 6465 6e63 6965 733a  aphDependencies:
+000236f0: 0a20 2020 2022 2222 0a20 2020 2054 6869  .    """.    Thi
+00023700: 7320 636c 6173 7320 6973 2075 7365 6420  s class is used 
+00023710: 746f 2073 746f 7265 2074 6865 2064 6570  to store the dep
+00023720: 656e 6465 6e63 6965 7320 6772 6170 6820  endencies graph 
+00023730: 616e 6420 7468 6520 7265 736f 7572 6365  and the resource
+00023740: 7320 7468 6174 2061 7265 2067 6f69 6e67  s that are going
+00023750: 2074 6f20 6265 2064 6570 6c6f 7965 640a   to be deployed.
+00023760: 2020 2020 2222 220a 0a20 2020 2064 6570      """..    dep
+00023770: 5f6d 6170 3a20 4469 6374 5b73 7472 2c20  _map: Dict[str, 
+00023780: 5365 745b 7374 725d 5d0a 2020 2020 746f  Set[str]].    to
+00023790: 5f72 756e 3a20 4469 6374 5b73 7472 2c20  _run: Dict[str, 
+000237a0: 4469 6374 5b73 7472 2c20 416e 795d 5d0a  Dict[str, Any]].
+000237b0: 0a20 2020 2023 2054 6865 2073 616d 6520  .    # The same 
+000237c0: 6173 2061 626f 7665 2062 7574 2066 6f72  as above but for
+000237d0: 2074 6865 2077 686f 6c65 2070 726f 6a65   the whole proje
+000237e0: 6374 2c20 6e6f 7420 6a75 7374 2074 6865  ct, not just the
+000237f0: 2072 6573 6f75 7263 6573 2061 6666 6563   resources affec
+00023800: 7465 6420 6279 2074 6865 2063 7572 7265  ted by the curre
+00023810: 6e74 2064 6570 6c6f 796d 656e 740a 2020  nt deployment.  
+00023820: 2020 616c 6c5f 6465 705f 6d61 703a 2044    all_dep_map: D
+00023830: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
+00023840: 5d5d 0a20 2020 2061 6c6c 5f72 6573 6f75  ]].    all_resou
+00023850: 7263 6573 3a20 4469 6374 5b73 7472 2c20  rces: Dict[str, 
+00023860: 4469 6374 5b73 7472 2c20 416e 795d 5d0a  Dict[str, Any]].
+00023870: 0a0a 6173 796e 6320 6465 6620 6275 696c  ..async def buil
+00023880: 645f 6772 6170 6828 0a20 2020 2066 696c  d_graph(.    fil
+00023890: 656e 616d 6573 3a20 4974 6572 6162 6c65  enames: Iterable
+000238a0: 5b73 7472 5d2c 0a20 2020 2074 625f 636c  [str],.    tb_cl
+000238b0: 6965 6e74 3a20 5469 6e79 422c 0a20 2020  ient: TinyB,.   
+000238c0: 2064 6972 5f70 6174 683a 204f 7074 696f   dir_path: Optio
+000238d0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000238e0: 0a20 2020 2072 6573 6f75 7263 655f 7665  .    resource_ve
+000238f0: 7273 696f 6e73 3d4e 6f6e 652c 0a20 2020  rsions=None,.   
+00023900: 2077 6f72 6b73 7061 6365 5f6d 6170 3a20   workspace_map: 
+00023910: 4f70 7469 6f6e 616c 5b44 6963 745d 203d  Optional[Dict] =
+00023920: 204e 6f6e 652c 0a20 2020 2070 726f 6365   None,.    proce
+00023930: 7373 5f64 6570 656e 6465 6e63 6965 733a  ss_dependencies:
+00023940: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00023950: 2020 2076 6572 626f 7365 3a20 626f 6f6c     verbose: bool
+00023960: 203d 2046 616c 7365 2c0a 2020 2020 736b   = False,.    sk
+00023970: 6970 5f63 6f6e 6e65 6374 6f72 733a 2062  ip_connectors: b
+00023980: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00023990: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+000239a0: 6174 6873 3a20 4f70 7469 6f6e 616c 5b4c  aths: Optional[L
+000239b0: 6973 745b 5475 706c 655b 7374 722c 2073  ist[Tuple[str, s
+000239c0: 7472 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  tr]]] = None,.  
+000239d0: 2020 6375 7272 656e 745f 7773 3a20 4f70    current_ws: Op
+000239e0: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
+000239f0: 2041 6e79 5d5d 203d 204e 6f6e 652c 0a20   Any]] = None,. 
+00023a00: 2020 2063 6861 6e67 6564 3a20 4f70 7469     changed: Opti
+00023a10: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+00023a20: 6e79 5d5d 203d 204e 6f6e 652c 0a20 2020  ny]] = None,.   
+00023a30: 206f 6e6c 795f 6368 616e 6765 733a 2062   only_changes: b
+00023a40: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00023a50: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
+00023a60: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00023a70: 203d 2046 616c 7365 2c0a 2020 2020 6973   = False,.    is
+00023a80: 5f69 6e74 6572 6e61 6c3a 204f 7074 696f  _internal: Optio
+00023a90: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00023aa0: 652c 0a29 202d 3e20 4772 6170 6844 6570  e,.) -> GraphDep
+00023ab0: 656e 6465 6e63 6965 733a 0a20 2020 2022  endencies:.    "
+00023ac0: 2222 0a20 2020 2054 6869 7320 6d65 7468  "".    This meth
+00023ad0: 6f64 2077 696c 6c20 6765 6e65 7261 7465  od will generate
+00023ae0: 2061 2064 6570 656e 6465 6e63 7920 6772   a dependency gr
+00023af0: 6170 6820 666f 7220 7468 6520 6769 7665  aph for the give
+00023b00: 6e20 6669 6c65 732e 2049 7420 7769 6c6c  n files. It will
+00023b10: 2061 6c73 6f20 7265 7475 726e 2061 206d   also return a m
+00023b20: 6170 206f 6620 616c 6c20 7468 6520 7265  ap of all the re
+00023b30: 736f 7572 6365 7320 7468 6174 2061 7265  sources that are
+00023b40: 2067 6f69 6e67 2074 6f20 6265 2064 6570   going to be dep
+00023b50: 6c6f 7965 642e 0a20 2020 2042 7920 6465  loyed..    By de
+00023b60: 6661 756c 7420 6974 2077 696c 6c20 6765  fault it will ge
+00023b70: 6e65 7261 7465 2074 6865 2067 7261 7068  nerate the graph
+00023b80: 2066 726f 6d20 6c65 6674 2074 6f20 7269   from left to ri
+00023b90: 6768 742c 2062 7574 2069 6620 666f 726b  ght, but if fork
+00023ba0: 2d64 6f77 6e73 7472 6561 6d2c 2069 7420  -downstream, it 
+00023bb0: 7769 6c6c 2067 656e 6572 6174 6520 7468  will generate th
+00023bc0: 6520 6772 6170 6820 6672 6f6d 2072 6967  e graph from rig
+00023bd0: 6874 2074 6f20 6c65 6674 2e0a 2020 2020  ht to left..    
+00023be0: 2222 220a 2020 2020 746f 5f72 756e 3a20  """.    to_run: 
+00023bf0: 4469 6374 5b73 7472 2c20 416e 795d 203d  Dict[str, Any] =
+00023c00: 207b 7d0a 2020 2020 6465 7073 3a20 4c69   {}.    deps: Li
+00023c10: 7374 5b73 7472 5d20 3d20 5b5d 0a20 2020  st[str] = [].   
+00023c20: 2064 6570 5f6d 6170 3a20 4469 6374 5b73   dep_map: Dict[s
+00023c30: 7472 2c20 416e 795d 203d 207b 7d0a 2020  tr, Any] = {}.  
+00023c40: 2020 656d 6265 6464 6564 5f64 6174 6173    embedded_datas
+00023c50: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
+00023c60: 6966 206e 6f74 2077 6f72 6b73 7061 6365  if not workspace
+00023c70: 5f6d 6170 3a0a 2020 2020 2020 2020 776f  _map:.        wo
+00023c80: 726b 7370 6163 655f 6d61 7020 3d20 7b7d  rkspace_map = {}
+00023c90: 0a0a 2020 2020 2320 5468 6573 6520 6469  ..    # These di
+00023ca0: 6374 696f 6e61 7269 6573 2061 7265 2075  ctionaries are u
+00023cb0: 7365 6420 746f 2073 746f 7265 2061 6c6c  sed to store all
+00023cc0: 2074 6865 2072 6573 6f75 7263 6573 2061   the resources a
+00023cd0: 6e64 2074 6865 7265 2064 6570 656e 6465  nd there depende
+00023ce0: 6e63 6965 7320 666f 7220 7468 6520 7768  ncies for the wh
+00023cf0: 6f6c 6520 7072 6f6a 6563 740a 2020 2020  ole project.    
+00023d00: 2320 5468 6973 2069 7320 7573 6564 2066  # This is used f
+00023d10: 6f72 2074 6865 2064 6f77 6e73 7472 6561  or the downstrea
+00023d20: 6d20 6465 7065 6e64 656e 6379 2067 7261  m dependency gra
+00023d30: 7068 0a20 2020 2061 6c6c 5f64 6570 5f6d  ph.    all_dep_m
+00023d40: 6170 3a20 4469 6374 5b73 7472 2c20 5365  ap: Dict[str, Se
+00023d50: 745b 7374 725d 5d20 3d20 7b7d 0a20 2020  t[str]] = {}.   
+00023d60: 2061 6c6c 5f72 6573 6f75 7263 6573 3a20   all_resources: 
+00023d70: 4469 6374 5b73 7472 2c20 4469 6374 5b73  Dict[str, Dict[s
+00023d80: 7472 2c20 416e 795d 5d20 3d20 7b7d 0a0a  tr, Any]] = {}..
+00023d90: 2020 2020 6966 2064 6972 5f70 6174 6820      if dir_path 
+00023da0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00023db0: 2064 6972 5f70 6174 6820 3d20 6f73 2e67   dir_path = os.g
+00023dc0: 6574 6377 6428 290a 0a20 2020 2023 2057  etcwd()..    # W
+00023dd0: 6865 6e20 7573 696e 6720 666f 726b 2d64  hen using fork-d
+00023de0: 6f77 6e73 7472 6561 6d20 6f72 202d 2d6f  ownstream or --o
+00023df0: 6e6c 792d 6368 616e 6765 732c 2077 6520  nly-changes, we 
+00023e00: 6e65 6564 2074 6f20 6765 6e65 7261 7465  need to generate
+00023e10: 2061 6c6c 2074 6865 2067 7261 7068 206f   all the graph o
+00023e20: 6620 616c 6c20 7468 6520 7265 736f 7572  f all the resour
+00023e30: 6365 7320 616e 6420 7468 6569 7220 6465  ces and their de
+00023e40: 7065 6e64 656e 6369 6573 0a20 2020 2023  pendencies.    #
+00023e50: 2054 6869 7320 7761 7920 7765 2063 616e   This way we can
+00023e60: 2061 6464 206d 6f72 6520 7265 736f 7572   add more resour
+00023e70: 6365 7320 696e 746f 2074 6865 2074 6f5f  ces into the to_
+00023e80: 7275 6e20 6469 6374 696f 6e61 7279 2069  run dictionary i
+00023e90: 6620 6e65 6564 6564 2e0a 2020 2020 6966  f needed..    if
+00023ea0: 2070 726f 6365 7373 5f64 6570 656e 6465   process_depende
+00023eb0: 6e63 6965 7320 616e 6420 6f6e 6c79 5f63  ncies and only_c
+00023ec0: 6861 6e67 6573 3a0a 2020 2020 2020 2020  hanges:.        
+00023ed0: 616c 6c5f 6465 7065 6e64 656e 6369 6573  all_dependencies
+00023ee0: 5f67 7261 7068 203d 2061 7761 6974 2062  _graph = await b
+00023ef0: 7569 6c64 5f67 7261 7068 280a 2020 2020  uild_graph(.    
+00023f00: 2020 2020 2020 2020 6765 745f 7072 6f6a          get_proj
+00023f10: 6563 745f 6669 6c65 6e61 6d65 7328 6469  ect_filenames(di
+00023f20: 725f 7061 7468 292c 0a20 2020 2020 2020  r_path),.       
+00023f30: 2020 2020 2074 625f 636c 6965 6e74 2c0a       tb_client,.
+00023f40: 2020 2020 2020 2020 2020 2020 6469 725f              dir_
+00023f50: 7061 7468 3d64 6972 5f70 6174 682c 0a20  path=dir_path,. 
+00023f60: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+00023f70: 7373 5f64 6570 656e 6465 6e63 6965 733d  ss_dependencies=
+00023f80: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00023f90: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
+00023fa0: 6f6e 733d 7265 736f 7572 6365 5f76 6572  ons=resource_ver
+00023fb0: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+00023fc0: 2020 2077 6f72 6b73 7061 6365 5f6d 6170     workspace_map
+00023fd0: 3d77 6f72 6b73 7061 6365 5f6d 6170 2c0a  =workspace_map,.
+00023fe0: 2020 2020 2020 2020 2020 2020 736b 6970              skip
+00023ff0: 5f63 6f6e 6e65 6374 6f72 733d 5472 7565  _connectors=True
+00024000: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
+00024010: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
+00024020: 733d 776f 726b 7370 6163 655f 6c69 625f  s=workspace_lib_
+00024030: 7061 7468 732c 0a20 2020 2020 2020 2020  paths,.         
+00024040: 2020 2063 7572 7265 6e74 5f77 733d 6375     current_ws=cu
+00024050: 7272 656e 745f 7773 2c0a 2020 2020 2020  rrent_ws,.      
+00024060: 2020 2020 2020 6368 616e 6765 643d 4e6f        changed=No
+00024070: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00024080: 6f6e 6c79 5f63 6861 6e67 6573 3d46 616c  only_changes=Fal
+00024090: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+000240a0: 6973 5f69 6e74 6572 6e61 6c3d 6973 5f69  is_internal=is_i
+000240b0: 6e74 6572 6e61 6c2c 0a20 2020 2020 2020  nternal,.       
+000240c0: 2029 0a20 2020 2020 2020 2061 6c6c 5f64   ).        all_d
+000240d0: 6570 5f6d 6170 203d 2061 6c6c 5f64 6570  ep_map = all_dep
+000240e0: 656e 6465 6e63 6965 735f 6772 6170 682e  endencies_graph.
+000240f0: 6465 705f 6d61 700a 2020 2020 2020 2020  dep_map.        
+00024100: 616c 6c5f 7265 736f 7572 6365 7320 3d20  all_resources = 
+00024110: 616c 6c5f 6465 7065 6e64 656e 6369 6573  all_dependencies
+00024120: 5f67 7261 7068 2e74 6f5f 7275 6e0a 0a20  _graph.to_run.. 
+00024130: 2020 2061 7379 6e63 2064 6566 2070 726f     async def pro
+00024140: 6365 7373 280a 2020 2020 2020 2020 6669  cess(.        fi
+00024150: 6c65 6e61 6d65 3a20 7374 722c 0a20 2020  lename: str,.   
+00024160: 2020 2020 2064 6570 733a 204c 6973 745b       deps: List[
+00024170: 7374 725d 2c0a 2020 2020 2020 2020 6465  str],.        de
+00024180: 705f 6d61 703a 2044 6963 745b 7374 722c  p_map: Dict[str,
+00024190: 2041 6e79 5d2c 0a20 2020 2020 2020 2074   Any],.        t
+000241a0: 6f5f 7275 6e3a 2044 6963 745b 7374 722c  o_run: Dict[str,
+000241b0: 2041 6e79 5d2c 0a20 2020 2020 2020 2077   Any],.        w
+000241c0: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
+000241d0: 6873 3a20 4f70 7469 6f6e 616c 5b4c 6973  hs: Optional[Lis
+000241e0: 745b 5475 706c 655b 7374 722c 2073 7472  t[Tuple[str, str
+000241f0: 5d5d 5d2c 0a20 2020 2029 3a0a 2020 2020  ]]],.    ):.    
+00024200: 2020 2020 6e61 6d65 2c20 6b69 6e64 203d      name, kind =
+00024210: 2066 696c 656e 616d 652e 7273 706c 6974   filename.rsplit
+00024220: 2822 2e22 2c20 3129 0a0a 2020 2020 2020  (".", 1)..      
+00024230: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00024240: 2020 2072 6573 203d 2061 7761 6974 2070     res = await p
+00024250: 726f 6365 7373 5f66 696c 6528 0a20 2020  rocess_file(.   
+00024260: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00024270: 656e 616d 652c 0a20 2020 2020 2020 2020  ename,.         
+00024280: 2020 2020 2020 2074 625f 636c 6965 6e74         tb_client
+00024290: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000242a0: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
+000242b0: 6f6e 733d 7265 736f 7572 6365 5f76 6572  ons=resource_ver
+000242c0: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+000242d0: 2020 2020 2020 2073 6b69 705f 636f 6e6e         skip_conn
+000242e0: 6563 746f 7273 3d73 6b69 705f 636f 6e6e  ectors=skip_conn
+000242f0: 6563 746f 7273 2c0a 2020 2020 2020 2020  ectors,.        
+00024300: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
+00024310: 655f 6d61 703d 776f 726b 7370 6163 655f  e_map=workspace_
+00024320: 6d61 702c 0a20 2020 2020 2020 2020 2020  map,.           
+00024330: 2020 2020 2077 6f72 6b73 7061 6365 5f6c       workspace_l
+00024340: 6962 5f70 6174 6873 3d77 6f72 6b73 7061  ib_paths=workspa
+00024350: 6365 5f6c 6962 5f70 6174 6873 2c0a 2020  ce_lib_paths,.  
+00024360: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00024370: 7272 656e 745f 7773 3d63 7572 7265 6e74  rrent_ws=current
+00024380: 5f77 732c 0a20 2020 2020 2020 2020 2020  _ws,.           
+00024390: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+000243a0: 7420 636c 6963 6b2e 436c 6963 6b45 7863  t click.ClickExc
+000243b0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+000243c0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+000243d0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000243e0: 496e 636c 7564 6546 696c 654e 6f74 466f  IncludeFileNotFo
+000243f0: 756e 6445 7863 6570 7469 6f6e 2061 7320  undException as 
+00024400: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00024410: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
+00024420: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
+00024430: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+00024440: 6465 6c65 7465 645f 696e 636c 7564 6528  deleted_include(
+00024450: 696e 636c 7564 655f 6669 6c65 3d73 7472  include_file=str
+00024460: 2865 292c 2066 696c 656e 616d 653d 6669  (e), filename=fi
+00024470: 6c65 6e61 6d65 2929 0a20 2020 2020 2020  lename)).       
+00024480: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00024490: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+000244a0: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+000244b0: 436c 6963 6b45 7863 6570 7469 6f6e 2873  ClickException(s
+000244c0: 7472 2865 2929 0a0a 2020 2020 2020 2020  tr(e))..        
+000244d0: 666f 7220 7220 696e 2072 6573 3a0a 2020  for r in res:.  
+000244e0: 2020 2020 2020 2020 2020 666e 203d 2072            fn = r
+000244f0: 5b22 7265 736f 7572 6365 5f6e 616d 6522  ["resource_name"
+00024500: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00024510: 2063 6861 6e67 6564 2061 6e64 2066 6e20   changed and fn 
+00024520: 696e 2063 6861 6e67 6564 2061 6e64 2028  in changed and (
+00024530: 6e6f 7420 6368 616e 6765 645b 666e 5d20  not changed[fn] 
+00024540: 6f72 2063 6861 6e67 6564 5b66 6e5d 2069  or changed[fn] i
+00024550: 6e20 5b22 7368 6172 6564 222c 2022 7265  n ["shared", "re
+00024560: 6d6f 7465 225d 293a 0a20 2020 2020 2020  mote"]):.       
+00024570: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00024580: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
+00024590: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+000245a0: 2020 2020 666f 726b 5f64 6f77 6e73 7472      fork_downstr
+000245b0: 6561 6d0a 2020 2020 2020 2020 2020 2020  eam.            
+000245c0: 2020 2020 616e 6420 722e 6765 7428 2272      and r.get("r
+000245d0: 6573 6f75 7263 6522 2c20 2222 2920 3d3d  esource", "") ==
+000245e0: 2022 7069 7065 7322 0a20 2020 2020 2020   "pipes".       
+000245f0: 2020 2020 2020 2020 2061 6e64 2061 6e79           and any
+00024600: 285b 2265 6e67 696e 6522 2069 6e20 782e  (["engine" in x.
+00024610: 6765 7428 2270 6172 616d 7322 2c20 7b7d  get("params", {}
+00024620: 2920 666f 7220 7820 696e 2072 2e67 6574  ) for x in r.get
+00024630: 2822 6e6f 6465 7322 2c20 5b5d 295d 290a  ("nodes", [])]).
+00024640: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+00024650: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00024660: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
+00024670: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
+00024680: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+00024690: 666f 726b 646f 776e 7374 7265 616d 5f70  forkdownstream_p
+000246a0: 6970 6573 5f77 6974 685f 656e 6769 6e65  ipes_with_engine
+000246b0: 2870 6970 653d 666e 2929 0a0a 2020 2020  (pipe=fn))..    
+000246c0: 2020 2020 2020 2020 746f 5f72 756e 5b66          to_run[f
+000246d0: 6e5d 203d 2072 0a20 2020 2020 2020 2020  n] = r.         
+000246e0: 2020 2066 696c 655f 6465 7073 203d 2072     file_deps = r
+000246f0: 2e67 6574 2822 6465 7073 222c 205b 5d29  .get("deps", [])
+00024700: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
+00024710: 7320 2b3d 2066 696c 655f 6465 7073 0a20  s += file_deps. 
+00024720: 2020 2020 2020 2020 2020 2023 2063 616c             # cal
+00024730: 6375 6c61 7465 2061 6e64 206c 6f6f 6b20  culate and look 
+00024740: 666f 7220 6465 7073 0a20 2020 2020 2020  for deps.       
+00024750: 2020 2020 2064 6570 5f6c 6973 7420 3d20       dep_list = 
+00024760: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00024770: 6f72 2078 2069 6e20 6669 6c65 5f64 6570  or x in file_dep
+00024780: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00024790: 2020 2069 6620 7820 6e6f 7420 696e 2049     if x not in I
+000247a0: 4e54 4552 4e41 4c5f 5441 424c 4553 206f  NTERNAL_TABLES o
+000247b0: 7220 6973 5f69 6e74 6572 6e61 6c3a 0a20  r is_internal:. 
+000247c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000247d0: 2020 2066 2c20 6473 203d 2066 696e 645f     f, ds = find_
+000247e0: 6669 6c65 5f62 795f 6e61 6d65 2864 6972  file_by_name(dir
+000247f0: 5f70 6174 682c 2078 2c20 7665 7262 6f73  _path, x, verbos
+00024800: 652c 2077 6f72 6b73 7061 6365 5f6c 6962  e, workspace_lib
+00024810: 5f70 6174 6873 3d77 6f72 6b73 7061 6365  _paths=workspace
+00024820: 5f6c 6962 5f70 6174 6873 2c20 7265 736f  _lib_paths, reso
+00024830: 7572 6365 3d72 290a 2020 2020 2020 2020  urce=r).        
+00024840: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00024850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024860: 2020 2020 2020 2020 2020 6465 705f 6c69            dep_li
+00024870: 7374 2e61 7070 656e 6428 662e 7273 706c  st.append(f.rspl
+00024880: 6974 2822 2e22 2c20 3129 5b30 5d29 0a20  it(".", 1)[0]). 
+00024890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248a0: 2020 2069 6620 6473 3a0a 2020 2020 2020     if ds:.      
+000248b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248c0: 2020 6473 5f66 6e20 3d20 6473 5b22 7265    ds_fn = ds["re
+000248d0: 736f 7572 6365 5f6e 616d 6522 5d0a 2020  source_name"].  
+000248e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248f0: 2020 2020 2020 7072 6576 203d 2074 6f5f        prev = to_
+00024900: 7275 6e2e 6765 7428 6473 5f66 6e2c 207b  run.get(ds_fn, {
+00024910: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00024920: 2020 2020 2020 2020 2020 2074 6f5f 7275             to_ru
+00024930: 6e5b 6473 5f66 6e5d 203d 2064 6565 7063  n[ds_fn] = deepc
+00024940: 6f70 7928 7229 0a20 2020 2020 2020 2020  opy(r).         
+00024950: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00024960: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00024970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024980: 746f 5f72 756e 5b64 735f 666e 5d5b 2264  to_run[ds_fn]["d
+00024990: 6570 7322 5d20 3d20 6c69 7374 280a 2020  eps"] = list(.  
+000249a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000249b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000249c0: 7428 746f 5f72 756e 5b64 735f 666e 5d2e  t(to_run[ds_fn].
+000249d0: 6765 7428 2264 6570 7322 2c20 5b5d 2920  get("deps", []) 
+000249e0: 2b20 7072 6576 2e67 6574 2822 6465 7073  + prev.get("deps
+000249f0: 222c 205b 5d29 202b 205b 666e 5d29 0a20  ", []) + [fn]). 
+00024a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a10: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00024a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a30: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+00024a40: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00024a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a60: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00024a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a80: 2065 6d62 6564 6465 645f 6461 7461 736f   embedded_dataso
+00024a90: 7572 6365 735b 785d 203d 2074 6f5f 7275  urces[x] = to_ru
+00024aa0: 6e5b 6473 5f66 6e5d 0a20 2020 2020 2020  n[ds_fn].       
+00024ab0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00024ac0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00024ad0: 2020 2020 2020 2020 2020 2065 5f64 7320             e_ds 
+00024ae0: 3d20 656d 6265 6464 6564 5f64 6174 6173  = embedded_datas
+00024af0: 6f75 7263 6573 2e67 6574 2878 2c20 4e6f  ources.get(x, No
+00024b00: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00024b10: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+00024b20: 5f64 733a 0a20 2020 2020 2020 2020 2020  _ds:.           
+00024b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024b40: 2064 6570 5f6c 6973 742e 6170 7065 6e64   dep_list.append
+00024b50: 2865 5f64 735b 2272 6573 6f75 7263 655f  (e_ds["resource_
+00024b60: 6e61 6d65 225d 290a 0a20 2020 2020 2020  name"])..       
+00024b70: 2020 2020 2023 2049 6e20 6361 7365 2074       # In case t
+00024b80: 6865 2064 6174 6173 6f75 7263 6520 6973  he datasource is
+00024b90: 2074 6f20 6265 2073 6861 7265 6420 616e   to be shared an
+00024ba0: 6420 7765 2068 6176 6520 6d61 7070 696e  d we have mappin
+00024bb0: 672c 206c 6574 2773 2072 6570 6c61 6365  g, let's replace
+00024bc0: 2074 6865 206e 616d 650a 2020 2020 2020   the name.      
+00024bd0: 2020 2020 2020 6966 2022 7368 6172 6564        if "shared
+00024be0: 5f77 6974 6822 2069 6e20 7220 616e 6420  _with" in r and 
+00024bf0: 776f 726b 7370 6163 655f 6d61 703a 0a20  workspace_map:. 
+00024c00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00024c10: 6170 7065 645f 776f 726b 7370 6163 6573  apped_workspaces
+00024c20: 3a20 4c69 7374 5b73 7472 5d20 3d20 5b5d  : List[str] = []
+00024c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024c40: 2066 6f72 2073 6861 7265 645f 7769 7468   for shared_with
+00024c50: 2069 6e20 725b 2273 6861 7265 645f 7769   in r["shared_wi
+00024c60: 7468 225d 3a0a 2020 2020 2020 2020 2020  th"]:.          
+00024c70: 2020 2020 2020 2020 2020 6d61 7070 6564            mapped
+00024c80: 5f77 6f72 6b73 7061 6365 732e 6170 7065  _workspaces.appe
+00024c90: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+00024ca0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00024cb0: 7370 6163 655f 6d61 702e 6765 7428 7368  space_map.get(sh
+00024cc0: 6172 6564 5f77 6974 6829 0a20 2020 2020  ared_with).     
+00024cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ce0: 2020 2069 6620 776f 726b 7370 6163 655f     if workspace_
+00024cf0: 6d61 702e 6765 7428 7368 6172 6564 5f77  map.get(shared_w
+00024d00: 6974 682c 204e 6f6e 6529 2069 7320 6e6f  ith, None) is no
+00024d10: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+00024d20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00024d30: 6c73 6520 7368 6172 6564 5f77 6974 680a  lse shared_with.
+00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d50: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00024d60: 2020 2020 2020 725b 2273 6861 7265 645f        r["shared_
+00024d70: 7769 7468 225d 203d 206d 6170 7065 645f  with"] = mapped_
+00024d80: 776f 726b 7370 6163 6573 0a0a 2020 2020  workspaces..    
+00024d90: 2020 2020 2020 2020 6465 705f 6d61 705b          dep_map[
+00024da0: 666e 5d20 3d20 7365 7428 6465 705f 6c69  fn] = set(dep_li
+00024db0: 7374 290a 2020 2020 2020 2020 7265 7475  st).        retu
+00024dc0: 726e 206f 732e 7061 7468 2e62 6173 656e  rn os.path.basen
+00024dd0: 616d 6528 6e61 6d65 290a 0a20 2020 2070  ame(name)..    p
+00024de0: 726f 6365 7373 6564 203d 2073 6574 2829  rocessed = set()
+00024df0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00024e00: 6765 745f 7072 6f63 6573 7365 6428 6669  get_processed(fi
+00024e10: 6c65 6e61 6d65 733a 2049 7465 7261 626c  lenames: Iterabl
+00024e20: 655b 7374 725d 293a 0a20 2020 2020 2020  e[str]):.       
+00024e30: 2066 6f72 2066 696c 656e 616d 6520 696e   for filename in
+00024e40: 2066 696c 656e 616d 6573 3a0a 2020 2020   filenames:.    
+00024e50: 2020 2020 2020 2020 2320 6a75 7374 2070          # just p
+00024e60: 726f 6365 7373 2063 6861 6e67 6564 2066  rocess changed f
+00024e70: 696c 656e 616d 6573 2028 7462 2064 6570  ilenames (tb dep
+00024e80: 6c6f 7920 616e 6420 2d2d 6f6e 6c79 2d63  loy and --only-c
+00024e90: 6861 6e67 6573 290a 2020 2020 2020 2020  hanges).        
+00024ea0: 2020 2020 6966 2063 6861 6e67 6564 3a0a      if changed:.
+00024eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ec0: 7265 736f 7572 6365 203d 2050 6174 6828  resource = Path(
+00024ed0: 6669 6c65 6e61 6d65 292e 7265 736f 6c76  filename).resolv
+00024ee0: 6528 292e 7374 656d 0a20 2020 2020 2020  e().stem.       
+00024ef0: 2020 2020 2020 2020 2069 6620 7265 736f           if reso
+00024f00: 7572 6365 2069 6e20 6368 616e 6765 6420  urce in changed 
+00024f10: 616e 6420 286e 6f74 2063 6861 6e67 6564  and (not changed
+00024f20: 5b72 6573 6f75 7263 655d 206f 7220 6368  [resource] or ch
+00024f30: 616e 6765 645b 7265 736f 7572 6365 5d20  anged[resource] 
+00024f40: 696e 205b 2273 6861 7265 6422 2c20 2272  in ["shared", "r
+00024f50: 656d 6f74 6522 5d29 3a0a 2020 2020 2020  emote"]):.      
+00024f60: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00024f70: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00024f80: 2020 2069 6620 6f73 2e70 6174 682e 6973     if os.path.is
+00024f90: 6469 7228 6669 6c65 6e61 6d65 293a 0a20  dir(filename):. 
+00024fa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00024fb0: 7761 6974 2067 6574 5f70 726f 6365 7373  wait get_process
+00024fc0: 6564 2866 696c 656e 616d 6573 3d67 6574  ed(filenames=get
+00024fd0: 5f70 726f 6a65 6374 5f66 696c 656e 616d  _project_filenam
+00024fe0: 6573 2866 696c 656e 616d 6529 290a 2020  es(filename)).  
+00024ff0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00025000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025010: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00025020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025030: 636c 6963 6b2e 6563 686f 2846 6565 6462  click.echo(Feedb
+00025040: 6163 6b4d 616e 6167 6572 2e69 6e66 6f5f  ackManager.info_
+00025050: 7072 6f63 6573 7369 6e67 5f66 696c 6528  processing_file(
+00025060: 6669 6c65 6e61 6d65 3d66 696c 656e 616d  filename=filenam
+00025070: 6529 290a 0a20 2020 2020 2020 2020 2020  e))..           
+00025080: 2020 2020 2069 6620 222e 696e 636c 2220       if ".incl" 
+00025090: 696e 2066 696c 656e 616d 653a 0a20 2020  in filename:.   
 000250a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250b0: 2020 2020 2020 2065 6d62 6564 6465 645f         embedded_
-000250c0: 6461 7461 736f 7572 6365 735b 785d 203d  datasources[x] =
-000250d0: 2074 6f5f 7275 6e5b 6473 5f66 6e5d 0a20   to_run[ds_fn]. 
-000250e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00025100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025110: 2065 5f64 7320 3d20 656d 6265 6464 6564   e_ds = embedded
-00025120: 5f64 6174 6173 6f75 7263 6573 2e67 6574  _datasources.get
-00025130: 2878 2c20 4e6f 6e65 290a 2020 2020 2020  (x, None).      
-00025140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025150: 2020 6966 2065 5f64 733a 0a20 2020 2020    if e_ds:.     
-00025160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025170: 2020 2020 2020 2064 6570 5f6c 6973 742e         dep_list.
-00025180: 6170 7065 6e64 2865 5f64 735b 2272 6573  append(e_ds["res
-00025190: 6f75 7263 655f 6e61 6d65 225d 290a 0a20  ource_name"]).. 
-000251a0: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
-000251b0: 6361 7365 2074 6865 2064 6174 6173 6f75  case the datasou
-000251c0: 7263 6520 6973 2074 6f20 6265 2073 6861  rce is to be sha
-000251d0: 7265 6420 616e 6420 7765 2068 6176 6520  red and we have 
-000251e0: 6d61 7070 696e 672c 206c 6574 2773 2072  mapping, let's r
-000251f0: 6570 6c61 6365 2074 6865 206e 616d 650a  eplace the name.
-00025200: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-00025210: 7368 6172 6564 5f77 6974 6822 2069 6e20  shared_with" in 
-00025220: 7220 616e 6420 776f 726b 7370 6163 655f  r and workspace_
-00025230: 6d61 703a 0a20 2020 2020 2020 2020 2020  map:.           
-00025240: 2020 2020 206d 6170 7065 645f 776f 726b       mapped_work
-00025250: 7370 6163 6573 3a20 4c69 7374 5b73 7472  spaces: List[str
-00025260: 5d20 3d20 5b5d 0a20 2020 2020 2020 2020  ] = [].         
-00025270: 2020 2020 2020 2066 6f72 2073 6861 7265         for share
-00025280: 645f 7769 7468 2069 6e20 725b 2273 6861  d_with in r["sha
-00025290: 7265 645f 7769 7468 225d 3a0a 2020 2020  red_with"]:.    
-000252a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000252b0: 6d61 7070 6564 5f77 6f72 6b73 7061 6365  mapped_workspace
-000252c0: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
-000252d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000252e0: 2020 776f 726b 7370 6163 655f 6d61 702e    workspace_map.
-000252f0: 6765 7428 7368 6172 6564 5f77 6974 6829  get(shared_with)
-00025300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025310: 2020 2020 2020 2020 2069 6620 776f 726b           if work
-00025320: 7370 6163 655f 6d61 702e 6765 7428 7368  space_map.get(sh
-00025330: 6172 6564 5f77 6974 682c 204e 6f6e 6529  ared_with, None)
-00025340: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+000250b0: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+000250c0: 6261 636b 4d61 6e61 6765 722e 7761 726e  backManager.warn
+000250d0: 696e 675f 736b 6970 7069 6e67 5f69 6e63  ing_skipping_inc
+000250e0: 6c75 6465 5f66 696c 6528 6669 6c65 3d66  lude_file(file=f
+000250f0: 696c 656e 616d 6529 290a 0a20 2020 2020  ilename))..     
+00025100: 2020 2020 2020 2020 2020 206e 616d 6520             name 
+00025110: 3d20 6177 6169 7420 7072 6f63 6573 7328  = await process(
+00025120: 6669 6c65 6e61 6d65 2c20 6465 7073 2c20  filename, deps, 
+00025130: 6465 705f 6d61 702c 2074 6f5f 7275 6e2c  dep_map, to_run,
+00025140: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+00025150: 6174 6873 290a 2020 2020 2020 2020 2020  aths).          
+00025160: 2020 2020 2020 7072 6f63 6573 7365 642e        processed.
+00025170: 6164 6428 6e61 6d65 290a 0a20 2020 2061  add(name)..    a
+00025180: 7761 6974 2067 6574 5f70 726f 6365 7373  wait get_process
+00025190: 6564 2866 696c 656e 616d 6573 3d66 696c  ed(filenames=fil
+000251a0: 656e 616d 6573 290a 0a20 2020 2069 6620  enames)..    if 
+000251b0: 7072 6f63 6573 735f 6465 7065 6e64 656e  process_dependen
+000251c0: 6369 6573 3a0a 2020 2020 2020 2020 6966  cies:.        if
+000251d0: 206f 6e6c 795f 6368 616e 6765 733a 0a20   only_changes:. 
+000251e0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+000251f0: 6579 2069 6e20 6469 6374 2874 6f5f 7275  ey in dict(to_ru
+00025200: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+00025210: 2020 2020 2320 6c6f 6f6b 2066 6f72 2064      # look for d
+00025220: 6570 7320 7468 6174 2061 7265 2074 6865  eps that are the
+00025230: 2074 6172 6765 7420 6461 7461 2073 6f75   target data sou
+00025240: 7263 6520 6f66 2061 206d 6174 6572 6961  rce of a materia
+00025250: 6c69 7a65 6420 6e6f 6465 0a20 2020 2020  lized node.     
+00025260: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+00025270: 745f 6461 7461 736f 7572 6365 203d 2067  t_datasource = g
+00025280: 6574 5f74 6172 6765 745f 6d61 7465 7269  et_target_materi
+00025290: 616c 697a 6564 5f64 6174 615f 736f 7572  alized_data_sour
+000252a0: 6365 5f6e 616d 6528 746f 5f72 756e 5b6b  ce_name(to_run[k
+000252b0: 6579 5d29 0a20 2020 2020 2020 2020 2020  ey]).           
+000252c0: 2020 2020 2069 6620 7461 7267 6574 5f64       if target_d
+000252d0: 6174 6173 6f75 7263 653a 0a20 2020 2020  atasource:.     
+000252e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000252f0: 206c 6f6f 6b20 696e 2061 6c6c 5f64 6570   look in all_dep
+00025300: 5f6d 6170 2069 7465 6d73 2074 6861 7420  _map items that 
+00025310: 6861 7665 2061 7320 6120 6465 7065 6e64  have as a depend
+00025320: 656e 6379 2074 6865 2074 6172 6765 7420  ency the target 
+00025330: 6461 7461 2073 6f75 7263 6520 616e 6420  data source and 
+00025340: 6172 6520 616e 2065 6e64 706f 696e 740a  are an endpoint.
 00025350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025360: 2020 2020 2065 6c73 6520 7368 6172 6564       else shared
-00025370: 5f77 6974 680a 2020 2020 2020 2020 2020  _with.          
-00025380: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00025390: 2020 2020 2020 2020 2020 2020 725b 2273              r["s
-000253a0: 6861 7265 645f 7769 7468 225d 203d 206d  hared_with"] = m
-000253b0: 6170 7065 645f 776f 726b 7370 6163 6573  apped_workspaces
-000253c0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
-000253d0: 705f 6d61 705b 666e 5d20 3d20 7365 7428  p_map[fn] = set(
-000253e0: 6465 705f 6c69 7374 290a 2020 2020 2020  dep_list).      
-000253f0: 2020 7265 7475 726e 206f 732e 7061 7468    return os.path
-00025400: 2e62 6173 656e 616d 6528 6e61 6d65 290a  .basename(name).
-00025410: 0a20 2020 2070 726f 6365 7373 6564 203d  .    processed =
-00025420: 2073 6574 2829 0a0a 2020 2020 6173 796e   set()..    asyn
-00025430: 6320 6465 6620 6765 745f 7072 6f63 6573  c def get_proces
-00025440: 7365 6428 6669 6c65 6e61 6d65 733a 2049  sed(filenames: I
-00025450: 7465 7261 626c 655b 7374 725d 293a 0a20  terable[str]):. 
-00025460: 2020 2020 2020 2066 6f72 2066 696c 656e         for filen
-00025470: 616d 6520 696e 2066 696c 656e 616d 6573  ame in filenames
-00025480: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00025490: 6a75 7374 2070 726f 6365 7373 2063 6861  just process cha
-000254a0: 6e67 6564 2066 696c 656e 616d 6573 2028  nged filenames (
-000254b0: 7462 2064 6570 6c6f 7920 616e 6420 2d2d  tb deploy and --
-000254c0: 6f6e 6c79 2d63 6861 6e67 6573 290a 2020  only-changes).  
-000254d0: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
-000254e0: 6e67 6564 3a0a 2020 2020 2020 2020 2020  nged:.          
-000254f0: 2020 2020 2020 7265 736f 7572 6365 203d        resource =
-00025500: 2050 6174 6828 6669 6c65 6e61 6d65 292e   Path(filename).
-00025510: 7265 736f 6c76 6528 292e 7374 656d 0a20  resolve().stem. 
-00025520: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00025530: 6620 7265 736f 7572 6365 2069 6e20 6368  f resource in ch
-00025540: 616e 6765 6420 616e 6420 286e 6f74 2063  anged and (not c
-00025550: 6861 6e67 6564 5b72 6573 6f75 7263 655d  hanged[resource]
-00025560: 206f 7220 6368 616e 6765 645b 7265 736f   or changed[reso
-00025570: 7572 6365 5d20 696e 205b 2273 6861 7265  urce] in ["share
-00025580: 6422 2c20 2272 656d 6f74 6522 5d29 3a0a  d", "remote"]):.
-00025590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000255a0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-000255b0: 2020 2020 2020 2020 2069 6620 6f73 2e70           if os.p
-000255c0: 6174 682e 6973 6469 7228 6669 6c65 6e61  ath.isdir(filena
-000255d0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-000255e0: 2020 2020 2061 7761 6974 2067 6574 5f70       await get_p
-000255f0: 726f 6365 7373 6564 2866 696c 656e 616d  rocessed(filenam
-00025600: 6573 3d67 6574 5f70 726f 6a65 6374 5f66  es=get_project_f
-00025610: 696c 656e 616d 6573 2866 696c 656e 616d  ilenames(filenam
-00025620: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00025630: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00025640: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00025650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025660: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00025670: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00025680: 2e69 6e66 6f5f 7072 6f63 6573 7369 6e67  .info_processing
-00025690: 5f66 696c 6528 6669 6c65 6e61 6d65 3d66  _file(filename=f
-000256a0: 696c 656e 616d 6529 290a 0a20 2020 2020  ilename))..     
-000256b0: 2020 2020 2020 2020 2020 2069 6620 222e             if ".
-000256c0: 696e 636c 2220 696e 2066 696c 656e 616d  incl" in filenam
-000256d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000256e0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-000256f0: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-00025700: 722e 7761 726e 696e 675f 736b 6970 7069  r.warning_skippi
-00025710: 6e67 5f69 6e63 6c75 6465 5f66 696c 6528  ng_include_file(
-00025720: 6669 6c65 3d66 696c 656e 616d 6529 290a  file=filename)).
-00025730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025740: 206e 616d 6520 3d20 6177 6169 7420 7072   name = await pr
-00025750: 6f63 6573 7328 6669 6c65 6e61 6d65 2c20  ocess(filename, 
-00025760: 6465 7073 2c20 6465 705f 6d61 702c 2074  deps, dep_map, t
-00025770: 6f5f 7275 6e2c 2077 6f72 6b73 7061 6365  o_run, workspace
-00025780: 5f6c 6962 5f70 6174 6873 290a 2020 2020  _lib_paths).    
-00025790: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-000257a0: 6573 7365 642e 6164 6428 6e61 6d65 290a  essed.add(name).
-000257b0: 0a20 2020 2061 7761 6974 2067 6574 5f70  .    await get_p
-000257c0: 726f 6365 7373 6564 2866 696c 656e 616d  rocessed(filenam
-000257d0: 6573 3d66 696c 656e 616d 6573 290a 0a20  es=filenames).. 
-000257e0: 2020 2069 6620 7072 6f63 6573 735f 6465     if process_de
-000257f0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-00025800: 2020 2020 6966 206f 6e6c 795f 6368 616e      if only_chan
-00025810: 6765 733a 0a20 2020 2020 2020 2020 2020  ges:.           
-00025820: 2066 6f72 206b 6579 2069 6e20 6469 6374   for key in dict
-00025830: 2874 6f5f 7275 6e29 3a0a 2020 2020 2020  (to_run):.      
-00025840: 2020 2020 2020 2020 2020 2320 6c6f 6f6b            # look
-00025850: 2066 6f72 2064 6570 7320 7468 6174 2061   for deps that a
-00025860: 7265 2074 6865 2074 6172 6765 7420 6461  re the target da
-00025870: 7461 2073 6f75 7263 6520 6f66 2061 206d  ta source of a m
-00025880: 6174 6572 6961 6c69 7a65 6420 6e6f 6465  aterialized node
-00025890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000258a0: 2074 6172 6765 745f 6461 7461 736f 7572   target_datasour
-000258b0: 6365 203d 2067 6574 5f74 6172 6765 745f  ce = get_target_
-000258c0: 6d61 7465 7269 616c 697a 6564 5f64 6174  materialized_dat
-000258d0: 615f 736f 7572 6365 5f6e 616d 6528 746f  a_source_name(to
-000258e0: 5f72 756e 5b6b 6579 5d29 0a20 2020 2020  _run[key]).     
-000258f0: 2020 2020 2020 2020 2020 2069 6620 7461             if ta
-00025900: 7267 6574 5f64 6174 6173 6f75 7263 653a  rget_datasource:
-00025910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025920: 2020 2020 2023 206c 6f6f 6b20 696e 2061       # look in a
-00025930: 6c6c 5f64 6570 5f6d 6170 2069 7465 6d73  ll_dep_map items
-00025940: 2074 6861 7420 6861 7665 2061 7320 6120   that have as a 
-00025950: 6465 7065 6e64 656e 6379 2074 6865 2074  dependency the t
-00025960: 6172 6765 7420 6461 7461 2073 6f75 7263  arget data sourc
-00025970: 6520 616e 6420 6172 6520 616e 2065 6e64  e and are an end
-00025980: 706f 696e 740a 2020 2020 2020 2020 2020  point.          
-00025990: 2020 2020 2020 2020 2020 666f 7220 5f6b            for _k
-000259a0: 6579 2c20 5f64 6570 7320 696e 2061 6c6c  ey, _deps in all
-000259b0: 5f64 6570 5f6d 6170 2e69 7465 6d73 2829  _dep_map.items()
-000259c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000259d0: 2020 2020 2020 2020 2020 666f 7220 6465            for de
-000259e0: 7020 696e 205f 6465 7073 3a0a 2020 2020  p in _deps:.    
-000259f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a00: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
-00025a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a20: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00025a30: 203d 3d20 7461 7267 6574 5f64 6174 6173   == target_datas
-00025a40: 6f75 7263 650a 2020 2020 2020 2020 2020  ource.          
-00025a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a60: 2020 2020 2020 6f72 2028 6465 7020 3d3d        or (dep ==
-00025a70: 206b 6579 2061 6e64 2074 6172 6765 745f   key and target_
-00025a80: 6461 7461 736f 7572 6365 206e 6f74 2069  datasource not i
-00025a90: 6e20 616c 6c5f 6465 705f 6d61 702e 6765  n all_dep_map.ge
-00025aa0: 7428 6b65 792c 205b 5d29 290a 2020 2020  t(key, [])).    
-00025ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ac0: 2020 2020 2020 2020 2920 616e 6420 6973          ) and is
-00025ad0: 5f65 6e64 706f 696e 745f 7769 7468 5f6e  _endpoint_with_n
-00025ae0: 6f5f 6465 7065 6e64 656e 6369 6573 280a  o_dependencies(.
-00025af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b10: 616c 6c5f 7265 736f 7572 6365 732e 6765  all_resources.ge
-00025b20: 7428 5f6b 6579 2c20 7b7d 292c 2061 6c6c  t(_key, {}), all
-00025b30: 5f64 6570 5f6d 6170 2c20 616c 6c5f 7265  _dep_map, all_re
-00025b40: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
-00025b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b60: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00025b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b80: 2020 2020 2020 2064 6570 5f6d 6170 5b5f         dep_map[_
-00025b90: 6b65 795d 203d 205f 6465 7073 0a20 2020  key] = _deps.   
-00025ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025bb0: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
-00025bc0: 7275 6e5b 5f6b 6579 5d20 3d20 616c 6c5f  run[_key] = all_
-00025bd0: 7265 736f 7572 6365 732e 6765 7428 5f6b  resources.get(_k
-00025be0: 6579 290a 2020 2020 2020 2020 656c 7365  ey).        else
-00025bf0: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
-00025c00: 696c 6520 6c65 6e28 6465 7073 2920 3e20  ile len(deps) > 
-00025c10: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00025c20: 2020 2064 6570 203d 2064 6570 732e 706f     dep = deps.po
-00025c30: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00025c40: 2020 2020 6966 2064 6570 206e 6f74 2069      if dep not i
-00025c50: 6e20 7072 6f63 6573 7365 643a 0a20 2020  n processed:.   
-00025c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c70: 2070 726f 6365 7373 6564 2e61 6464 2864   processed.add(d
-00025c80: 6570 290a 2020 2020 2020 2020 2020 2020  ep).            
-00025c90: 2020 2020 2020 2020 6620 3d20 6675 6c6c          f = full
-00025ca0: 5f70 6174 685f 6279 5f6e 616d 6528 6469  _path_by_name(di
-00025cb0: 725f 7061 7468 2c20 6465 702c 2077 6f72  r_path, dep, wor
-00025cc0: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
-00025cd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00025ce0: 2020 2020 2020 6966 2066 3a0a 2020 2020        if f:.    
-00025cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d00: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00025d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d20: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00025d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d50: 2070 726f 6365 7373 6564 5f66 696c 656e   processed_filen
-00025d60: 616d 6520 3d20 662e 7265 6c61 7469 7665  ame = f.relative
-00025d70: 5f74 6f28 6f73 2e67 6574 6377 6428 2929  _to(os.getcwd())
-00025d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025d90: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00025da0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
-00025db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025dd0: 7072 6f63 6573 7365 645f 6669 6c65 6e61  processed_filena
-00025de0: 6d65 203d 2066 0a20 2020 2020 2020 2020  me = f.         
-00025df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e00: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-00025e10: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
-00025e20: 666f 5f70 726f 6365 7373 696e 675f 6669  fo_processing_fi
-00025e30: 6c65 2866 696c 656e 616d 653d 7072 6f63  le(filename=proc
-00025e40: 6573 7365 645f 6669 6c65 6e61 6d65 2929  essed_filename))
-00025e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025e60: 2020 2020 2020 2020 2061 7761 6974 2070           await p
-00025e70: 726f 6365 7373 2873 7472 2866 292c 2064  rocess(str(f), d
-00025e80: 6570 732c 2064 6570 5f6d 6170 2c20 746f  eps, dep_map, to
-00025e90: 5f72 756e 2c20 776f 726b 7370 6163 655f  _run, workspace_
-00025ea0: 6c69 625f 7061 7468 7329 0a0a 2020 2020  lib_paths)..    
-00025eb0: 7265 7475 726e 2047 7261 7068 4465 7065  return GraphDepe
-00025ec0: 6e64 656e 6369 6573 2864 6570 5f6d 6170  ndencies(dep_map
-00025ed0: 2c20 746f 5f72 756e 2c20 616c 6c5f 6465  , to_run, all_de
-00025ee0: 705f 6d61 702c 2061 6c6c 5f72 6573 6f75  p_map, all_resou
-00025ef0: 7263 6573 290a 0a0a 6173 796e 6320 6465  rces)...async de
-00025f00: 6620 6765 745f 6368 616e 6765 735f 6672  f get_changes_fr
-00025f10: 6f6d 5f6d 6169 6e28 0a20 2020 206f 6e6c  om_main(.    onl
-00025f20: 795f 6368 616e 6765 733a 2062 6f6f 6c2c  y_changes: bool,
-00025f30: 0a20 2020 2063 6c69 656e 743a 2054 696e  .    client: Tin
-00025f40: 7942 2c0a 2020 2020 636f 6e66 6967 3a20  yB,.    config: 
-00025f50: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
-00025f60: 722c 2041 6e79 5d5d 203d 204e 6f6e 652c  r, Any]] = None,
-00025f70: 0a20 2020 2063 7572 7265 6e74 5f77 733a  .    current_ws:
-00025f80: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
-00025f90: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
-00025fa0: 2c0a 2020 2020 6669 6c65 6e61 6d65 733a  ,.    filenames:
-00025fb0: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00025fc0: 7472 5d5d 203d 204e 6f6e 652c 0a29 3a0a  tr]] = None,.):.
-00025fd0: 2020 2020 6368 616e 6765 6420 3d20 4e6f      changed = No
-00025fe0: 6e65 0a20 2020 2069 6620 6e6f 7420 6f6e  ne.    if not on
-00025ff0: 6c79 5f63 6861 6e67 6573 3a0a 2020 2020  ly_changes:.    
-00026000: 2020 2020 7265 7475 726e 2063 6861 6e67      return chang
-00026010: 6564 0a0a 2020 2020 6966 2063 7572 7265  ed..    if curre
-00026020: 6e74 5f77 7320 616e 6420 6e6f 7420 6375  nt_ws and not cu
-00026030: 7272 656e 745f 7773 2e67 6574 2822 6973  rrent_ws.get("is
-00026040: 5f62 7261 6e63 6822 293a 0a20 2020 2020  _branch"):.     
-00026050: 2020 2063 6861 6e67 6564 203d 2061 7761     changed = awa
-00026060: 6974 2064 6966 665f 636f 6d6d 616e 6428  it diff_command(
-00026070: 6669 6c65 6e61 6d65 732c 2054 7275 652c  filenames, True,
-00026080: 2063 6c69 656e 742c 206e 6f5f 636f 6c6f   client, no_colo
-00026090: 723d 5472 7565 2c20 7769 7468 5f70 7269  r=True, with_pri
-000260a0: 6e74 3d46 616c 7365 290a 2020 2020 656c  nt=False).    el
-000260b0: 6966 2063 6f6e 6669 6720 616e 6420 636f  if config and co
-000260c0: 6e66 6967 2e67 6574 2822 686f 7374 2229  nfig.get("host")
-000260d0: 3a0a 2020 2020 2020 2020 776f 726b 7370  :.        worksp
-000260e0: 6163 6520 3d20 6177 6169 7420 6765 745f  ace = await get_
-000260f0: 6375 7272 656e 745f 6d61 696e 5f77 6f72  current_main_wor
-00026100: 6b73 7061 6365 2863 6c69 656e 742c 2063  kspace(client, c
-00026110: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
-00026120: 6966 2077 6f72 6b73 7061 6365 3a0a 2020  if workspace:.  
-00026130: 2020 2020 2020 2020 2020 7773 5f63 6c69            ws_cli
-00026140: 656e 7420 3d20 5f67 6574 5f74 625f 636c  ent = _get_tb_cl
-00026150: 6965 6e74 2877 6f72 6b73 7061 6365 5b22  ient(workspace["
-00026160: 746f 6b65 6e22 5d2c 2063 6f6e 6669 675b  token"], config[
-00026170: 2268 6f73 7422 5d29 0a20 2020 2020 2020  "host"]).       
-00026180: 2020 2020 2063 6861 6e67 6564 203d 2061       changed = a
-00026190: 7761 6974 2064 6966 665f 636f 6d6d 616e  wait diff_comman
-000261a0: 6428 6669 6c65 6e61 6d65 732c 2054 7275  d(filenames, Tru
-000261b0: 652c 2077 735f 636c 6965 6e74 2c20 6e6f  e, ws_client, no
-000261c0: 5f63 6f6c 6f72 3d54 7275 652c 2077 6974  _color=True, wit
-000261d0: 685f 7072 696e 743d 4661 6c73 6529 0a20  h_print=False). 
-000261e0: 2020 2072 6574 7572 6e20 6368 616e 6765     return change
-000261f0: 640a 0a0a 6465 6620 6765 745f 7072 6f6a  d...def get_proj
-00026200: 6563 745f 6669 6c65 6e61 6d65 7328 666f  ect_filenames(fo
-00026210: 6c64 6572 3a20 7374 722c 2077 6974 685f  lder: str, with_
-00026220: 7665 6e64 6f72 3d46 616c 7365 2920 2d3e  vendor=False) ->
-00026230: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-00026240: 666f 6c64 6572 733a 204c 6973 745b 7374  folders: List[st
-00026250: 725d 203d 205b 0a20 2020 2020 2020 2066  r] = [.        f
-00026260: 227b 666f 6c64 6572 7d2f 2a2e 6461 7461  "{folder}/*.data
-00026270: 736f 7572 6365 222c 0a20 2020 2020 2020  source",.       
-00026280: 2066 227b 666f 6c64 6572 7d2f 6461 7461   f"{folder}/data
-00026290: 736f 7572 6365 732f 2a2e 6461 7461 736f  sources/*.dataso
-000262a0: 7572 6365 222c 0a20 2020 2020 2020 2066  urce",.        f
-000262b0: 227b 666f 6c64 6572 7d2f 2a2e 7069 7065  "{folder}/*.pipe
-000262c0: 222c 0a20 2020 2020 2020 2066 227b 666f  ",.        f"{fo
-000262d0: 6c64 6572 7d2f 7069 7065 732f 2a2e 7069  lder}/pipes/*.pi
-000262e0: 7065 222c 0a20 2020 2020 2020 2066 227b  pe",.        f"{
-000262f0: 666f 6c64 6572 7d2f 656e 6470 6f69 6e74  folder}/endpoint
-00026300: 732f 2a2e 7069 7065 222c 0a20 2020 2020  s/*.pipe",.     
-00026310: 2020 2066 227b 666f 6c64 6572 7d2f 2a2e     f"{folder}/*.
-00026320: 746f 6b65 6e22 2c0a 2020 2020 2020 2020  token",.        
-00026330: 6622 7b66 6f6c 6465 727d 2f74 6f6b 656e  f"{folder}/token
-00026340: 732f 2a2e 746f 6b65 6e22 2c0a 2020 2020  s/*.token",.    
-00026350: 5d0a 2020 2020 6966 2077 6974 685f 7665  ].    if with_ve
-00026360: 6e64 6f72 3a0a 2020 2020 2020 2020 666f  ndor:.        fo
-00026370: 6c64 6572 732e 6170 7065 6e64 2866 227b  lders.append(f"{
-00026380: 666f 6c64 6572 7d2f 7665 6e64 6f72 2f2a  folder}/vendor/*
-00026390: 2a2f 2a2a 2f2a 2e64 6174 6173 6f75 7263  */**/*.datasourc
-000263a0: 6522 290a 2020 2020 6669 6c65 6e61 6d65  e").    filename
-000263b0: 733a 204c 6973 745b 7374 725d 203d 205b  s: List[str] = [
-000263c0: 5d0a 2020 2020 666f 7220 7820 696e 2066  ].    for x in f
-000263d0: 6f6c 6465 7273 3a0a 2020 2020 2020 2020  olders:.        
-000263e0: 6669 6c65 6e61 6d65 7320 2b3d 2067 6c6f  filenames += glo
-000263f0: 622e 676c 6f62 2878 290a 2020 2020 7265  b.glob(x).    re
-00026400: 7475 726e 2066 696c 656e 616d 6573 0a0a  turn filenames..
-00026410: 0a64 6566 2069 735f 6e65 7728 0a20 2020  .def is_new(.   
-00026420: 206e 616d 653a 2073 7472 2c0a 2020 2020   name: str,.    
-00026430: 6368 616e 6765 643a 2044 6963 745b 7374  changed: Dict[st
-00026440: 722c 2073 7472 5d2c 0a20 2020 206e 6f72  r, str],.    nor
-00026450: 6d61 6c5f 6465 7065 6e64 656e 6379 3a20  mal_dependency: 
-00026460: 4469 6374 5b73 7472 2c20 5365 745b 7374  Dict[str, Set[st
-00026470: 725d 5d2c 0a20 2020 2066 6f72 6b5f 646f  r]],.    fork_do
-00026480: 776e 7374 7265 616d 5f64 6570 656e 6465  wnstream_depende
-00026490: 6e63 793a 2044 6963 745b 7374 722c 2053  ncy: Dict[str, S
-000264a0: 6574 5b73 7472 5d5d 2c0a 2920 2d3e 2062  et[str]],.) -> b
-000264b0: 6f6f 6c3a 0a20 2020 2064 6566 2069 735f  ool:.    def is_
-000264c0: 6769 745f 6e65 7728 6e61 6d65 3a20 7374  git_new(name: st
-000264d0: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
-000264e0: 726e 2063 6861 6e67 6564 2061 6e64 2063  rn changed and c
-000264f0: 6861 6e67 6564 2e67 6574 286e 616d 6529  hanged.get(name)
-00026500: 203d 3d20 2241 220a 0a20 2020 2069 6620   == "A"..    if 
-00026510: 6e6f 7420 6973 5f67 6974 5f6e 6577 286e  not is_git_new(n
-00026520: 616d 6529 3a0a 2020 2020 2020 2020 7265  ame):.        re
-00026530: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00026540: 2320 6966 2073 686f 756c 6420 6e6f 7420  # if should not 
-00026550: 6465 7065 6e64 206f 6e20 6120 6368 616e  depend on a chan
-00026560: 6765 6420 7265 736f 7572 6365 0a20 2020  ged resource.   
-00026570: 2069 6620 6261 636b 5f64 6570 7320 3a3d   if back_deps :=
-00026580: 206e 6f72 6d61 6c5f 6465 7065 6e64 656e   normal_dependen
-00026590: 6379 2e67 6574 286e 616d 6529 3a0a 2020  cy.get(name):.  
-000265a0: 2020 2020 2020 666f 7220 6465 7020 696e        for dep in
-000265b0: 2062 6163 6b5f 6465 7073 3a0a 2020 2020   back_deps:.    
-000265c0: 2020 2020 2020 2020 6966 2064 6570 2069          if dep i
-000265d0: 6e20 666f 726b 5f64 6f77 6e73 7472 6561  n fork_downstrea
-000265e0: 6d5f 6465 7065 6e64 656e 6379 2061 6e64  m_dependency and
-000265f0: 206e 6f74 2069 735f 6769 745f 6e65 7728   not is_git_new(
-00026600: 6465 7029 3a0a 2020 2020 2020 2020 2020  dep):.          
-00026610: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00026620: 7365 0a0a 2020 2020 7265 7475 726e 2054  se..    return T
-00026630: 7275 650a 0a0a 6173 796e 6320 6465 6620  rue...async def 
-00026640: 666f 6c64 6572 5f70 7573 6828 0a20 2020  folder_push(.   
-00026650: 2074 625f 636c 6965 6e74 3a20 5469 6e79   tb_client: Tiny
-00026660: 422c 0a20 2020 2066 696c 656e 616d 6573  B,.    filenames
-00026670: 3a20 4f70 7469 6f6e 616c 5b4c 6973 745b  : Optional[List[
-00026680: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-00026690: 2020 6472 795f 7275 6e3a 2062 6f6f 6c20    dry_run: bool 
-000266a0: 3d20 4661 6c73 652c 0a20 2020 2063 6865  = False,.    che
-000266b0: 636b 3a20 626f 6f6c 203d 2046 616c 7365  ck: bool = False
-000266c0: 2c0a 2020 2020 7075 7368 5f64 6570 733a  ,.    push_deps:
-000266d0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-000266e0: 2020 206f 6e6c 795f 6368 616e 6765 733a     only_changes:
-000266f0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00026700: 2020 2067 6974 5f72 656c 6561 7365 3a20     git_release: 
-00026710: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00026720: 2020 6465 6275 673a 2062 6f6f 6c20 3d20    debug: bool = 
-00026730: 4661 6c73 652c 0a20 2020 2066 6f72 6365  False,.    force
-00026740: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00026750: 2020 2020 6f76 6572 7269 6465 5f64 6174      override_dat
-00026760: 6173 6f75 7263 653a 2062 6f6f 6c20 3d20  asource: bool = 
-00026770: 4661 6c73 652c 0a20 2020 2066 6f6c 6465  False,.    folde
-00026780: 723a 2073 7472 203d 2022 2e22 2c0a 2020  r: str = ".",.  
-00026790: 2020 706f 7075 6c61 7465 3a20 626f 6f6c    populate: bool
-000267a0: 203d 2046 616c 7365 2c0a 2020 2020 706f   = False,.    po
-000267b0: 7075 6c61 7465 5f73 7562 7365 743d 4e6f  pulate_subset=No
-000267c0: 6e65 2c0a 2020 2020 706f 7075 6c61 7465  ne,.    populate
-000267d0: 5f63 6f6e 6469 7469 6f6e 3a20 4f70 7469  _condition: Opti
-000267e0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-000267f0: 2c0a 2020 2020 756e 6c69 6e6b 5f6f 6e5f  ,.    unlink_on_
-00026800: 706f 7075 6c61 7465 5f65 7272 6f72 3a20  populate_error: 
-00026810: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00026820: 2020 7570 6c6f 6164 5f66 6978 7475 7265    upload_fixture
-00026830: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00026840: 0a20 2020 2077 6169 743a 2062 6f6f 6c20  .    wait: bool 
-00026850: 3d20 4661 6c73 652c 0a20 2020 2069 676e  = False,.    ign
-00026860: 6f72 655f 7371 6c5f 6572 726f 7273 3a20  ore_sql_errors: 
-00026870: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00026880: 2020 736b 6970 5f63 6f6e 6669 726d 6174    skip_confirmat
-00026890: 696f 6e3a 2062 6f6f 6c20 3d20 4661 6c73  ion: bool = Fals
-000268a0: 652c 0a20 2020 206f 6e6c 795f 7265 7370  e,.    only_resp
-000268b0: 6f6e 7365 5f74 696d 6573 3a20 626f 6f6c  onse_times: bool
-000268c0: 203d 2046 616c 7365 2c0a 2020 2020 776f   = False,.    wo
-000268d0: 726b 7370 6163 655f 6d61 703d 4e6f 6e65  rkspace_map=None
-000268e0: 2c0a 2020 2020 776f 726b 7370 6163 655f  ,.    workspace_
-000268f0: 6c69 625f 7061 7468 733d 4e6f 6e65 2c0a  lib_paths=None,.
-00026900: 2020 2020 6e6f 5f76 6572 7369 6f6e 733a      no_versions:
-00026910: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00026920: 2020 2074 696d 656f 7574 3d4e 6f6e 652c     timeout=None,
-00026930: 0a20 2020 2072 756e 5f74 6573 7473 3a20  .    run_tests: 
-00026940: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00026950: 2020 6173 5f73 7461 6e64 6172 643a 2062    as_standard: b
-00026960: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00026970: 2072 6169 7365 5f6f 6e5f 6578 6973 7473   raise_on_exists
-00026980: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00026990: 2020 2020 7665 7262 6f73 653a 2062 6f6f      verbose: boo
-000269a0: 6c20 3d20 5472 7565 2c0a 2020 2020 7465  l = True,.    te
-000269b0: 7374 735f 746f 5f72 756e 3a20 696e 7420  sts_to_run: int 
-000269c0: 3d20 302c 0a20 2020 2074 6573 7473 5f73  = 0,.    tests_s
-000269d0: 616d 706c 655f 6279 5f70 6172 616d 733a  ample_by_params:
-000269e0: 2069 6e74 203d 2030 2c0a 2020 2020 7465   int = 0,.    te
-000269f0: 7374 735f 6669 6c74 6572 5f62 793a 204f  sts_filter_by: O
-00026a00: 7074 696f 6e61 6c5b 4c69 7374 5b73 7472  ptional[List[str
-00026a10: 5d5d 203d 204e 6f6e 652c 0a20 2020 2074  ]] = None,.    t
-00026a20: 6573 7473 5f66 6169 6c66 6173 743a 2062  ests_failfast: b
-00026a30: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00026a40: 2074 6573 7473 5f69 676e 6f72 655f 6f72   tests_ignore_or
-00026a50: 6465 723a 2062 6f6f 6c20 3d20 4661 6c73  der: bool = Fals
-00026a60: 652c 0a20 2020 2074 6573 7473 5f76 616c  e,.    tests_val
-00026a70: 6964 6174 655f 7072 6f63 6573 7365 645f  idate_processed_
-00026a80: 6279 7465 733a 2062 6f6f 6c20 3d20 4661  bytes: bool = Fa
-00026a90: 6c73 652c 0a20 2020 2074 6573 7473 5f63  lse,.    tests_c
-00026aa0: 6865 636b 5f72 6571 7565 7374 735f 6672  heck_requests_fr
-00026ab0: 6f6d 5f62 7261 6e63 683a 2062 6f6f 6c20  om_branch: bool 
-00026ac0: 3d20 4661 6c73 652c 0a20 2020 2063 6f6e  = False,.    con
-00026ad0: 6669 673a 204f 7074 696f 6e61 6c5b 4469  fig: Optional[Di
-00026ae0: 6374 5b73 7472 2c20 416e 795d 5d20 3d20  ct[str, Any]] = 
-00026af0: 4e6f 6e65 2c0a 2020 2020 7573 6572 5f74  None,.    user_t
-00026b00: 6f6b 656e 3a20 4f70 7469 6f6e 616c 5b73  oken: Optional[s
-00026b10: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00026b20: 666f 726b 5f64 6f77 6e73 7472 6561 6d3a  fork_downstream:
-00026b30: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00026b40: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
-00026b50: 6b3a 204f 7074 696f 6e61 6c5b 626f 6f6c  k: Optional[bool
-00026b60: 5d20 3d20 4661 6c73 652c 0a20 2020 2069  ] = False,.    i
-00026b70: 735f 696e 7465 726e 616c 3a20 4f70 7469  s_internal: Opti
-00026b80: 6f6e 616c 5b62 6f6f 6c5d 203d 2046 616c  onal[bool] = Fal
-00026b90: 7365 2c0a 2020 2020 7265 6c65 6173 655f  se,.    release_
-00026ba0: 6372 6561 7465 643a 204f 7074 696f 6e61  created: Optiona
-00026bb0: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
-00026bc0: 0a20 2020 2061 7574 6f5f 7072 6f6d 6f74  .    auto_promot
-00026bd0: 653a 204f 7074 696f 6e61 6c5b 626f 6f6c  e: Optional[bool
-00026be0: 5d20 3d20 4661 6c73 652c 0a20 2020 2063  ] = False,.    c
-00026bf0: 6865 636b 5f62 6163 6b66 696c 6c5f 7265  heck_backfill_re
-00026c00: 7175 6972 6564 3a20 626f 6f6c 203d 2046  quired: bool = F
-00026c10: 616c 7365 2c0a 2020 2020 7573 655f 6d61  alse,.    use_ma
-00026c20: 696e 3a20 626f 6f6c 203d 2046 616c 7365  in: bool = False
-00026c30: 2c0a 293a 2020 2320 6e6f 7161 3a20 4339  ,.):  # noqa: C9
-00026c40: 3031 0a20 2020 2077 6f72 6b73 7061 6365  01.    workspace
-00026c50: 733a 204c 6973 745b 4469 6374 5b73 7472  s: List[Dict[str
-00026c60: 2c20 416e 795d 5d20 3d20 2861 7761 6974  , Any]] = (await
-00026c70: 2074 625f 636c 6965 6e74 2e75 7365 725f   tb_client.user_
-00026c80: 776f 726b 7370 6163 6573 5f61 6e64 5f62  workspaces_and_b
-00026c90: 7261 6e63 6865 7328 2929 2e67 6574 2822  ranches()).get("
-00026ca0: 776f 726b 7370 6163 6573 222c 205b 5d29  workspaces", [])
-00026cb0: 0a20 2020 2063 7572 7265 6e74 5f77 733a  .    current_ws:
-00026cc0: 2044 6963 745b 7374 722c 2041 6e79 5d20   Dict[str, Any] 
-00026cd0: 3d20 6e65 7874 280a 2020 2020 2020 2020  = next(.        
-00026ce0: 2877 6f72 6b73 7061 6365 2066 6f72 2077  (workspace for w
-00026cf0: 6f72 6b73 7061 6365 2069 6e20 776f 726b  orkspace in work
-00026d00: 7370 6163 6573 2069 6620 636f 6e66 6967  spaces if config
-00026d10: 2061 6e64 2077 6f72 6b73 7061 6365 2e67   and workspace.g
-00026d20: 6574 2822 6964 222c 2022 2e22 2920 3d3d  et("id", ".") ==
-00026d30: 2063 6f6e 6669 672e 6765 7428 2269 6422   config.get("id"
-00026d40: 2c20 222e 2e22 2929 2c20 7b7d 0a20 2020  , "..")), {}.   
-00026d50: 2029 0a20 2020 2069 735f 6272 616e 6368   ).    is_branch
-00026d60: 203d 2063 7572 7265 6e74 5f77 732e 6765   = current_ws.ge
-00026d70: 7428 2269 735f 6272 616e 6368 222c 2046  t("is_branch", F
-00026d80: 616c 7365 290a 2020 2020 6861 735f 7365  alse).    has_se
-00026d90: 6d76 6572 3a20 626f 6f6c 203d 2072 656c  mver: bool = rel
-00026da0: 6561 7365 5f63 7265 6174 6564 206f 7220  ease_created or 
-00026db0: 4661 6c73 650a 0a20 2020 2064 6570 6c6f  False..    deplo
-00026dc0: 796d 656e 7420 3d20 4465 706c 6f79 6d65  yment = Deployme
-00026dd0: 6e74 2863 7572 7265 6e74 5f77 732c 2067  nt(current_ws, g
-00026de0: 6974 5f72 656c 6561 7365 2c20 7462 5f63  it_release, tb_c
-00026df0: 6c69 656e 742c 2064 7279 5f72 756e 2c20  lient, dry_run, 
-00026e00: 6f6e 6c79 5f63 6861 6e67 6573 290a 0a20  only_changes).. 
-00026e10: 2020 2069 6620 6e6f 7420 776f 726b 7370     if not worksp
-00026e20: 6163 655f 6d61 703a 0a20 2020 2020 2020  ace_map:.       
-00026e30: 2077 6f72 6b73 7061 6365 5f6d 6170 203d   workspace_map =
-00026e40: 207b 7d0a 2020 2020 6966 206e 6f74 2077   {}.    if not w
-00026e50: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
-00026e60: 6873 3a0a 2020 2020 2020 2020 776f 726b  hs:.        work
-00026e70: 7370 6163 655f 6c69 625f 7061 7468 7320  space_lib_paths 
-00026e80: 3d20 5b5d 0a0a 2020 2020 776f 726b 7370  = []..    worksp
-00026e90: 6163 655f 6c69 625f 7061 7468 7320 3d20  ace_lib_paths = 
-00026ea0: 6c69 7374 2877 6f72 6b73 7061 6365 5f6c  list(workspace_l
-00026eb0: 6962 5f70 6174 6873 290a 2020 2020 2320  ib_paths).    # 
-00026ec0: 696e 636c 7564 6520 7665 6e64 6f72 206c  include vendor l
-00026ed0: 6962 7320 7769 7468 6f75 7420 6f76 6572  ibs without over
-00026ee0: 7269 6469 6e67 2075 7365 7220 6f6e 6573  riding user ones
-00026ef0: 0a20 2020 2065 7869 7374 696e 675f 776f  .    existing_wo
-00026f00: 726b 7370 6163 6573 203d 2073 6574 2878  rkspaces = set(x
-00026f10: 5b31 5d20 666f 7220 7820 696e 2077 6f72  [1] for x in wor
-00026f20: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
-00026f30: 290a 2020 2020 7665 6e64 6f72 5f70 6174  ).    vendor_pat
-00026f40: 6820 3d20 5061 7468 2822 7665 6e64 6f72  h = Path("vendor
-00026f50: 2229 0a20 2020 2069 6620 7665 6e64 6f72  ").    if vendor
-00026f60: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
-00026f70: 2020 2020 2020 2020 666f 7220 7820 696e          for x in
-00026f80: 2076 656e 646f 725f 7061 7468 2e69 7465   vendor_path.ite
-00026f90: 7264 6972 2829 3a0a 2020 2020 2020 2020  rdir():.        
-00026fa0: 2020 2020 6966 2078 2e69 735f 6469 7228      if x.is_dir(
-00026fb0: 2920 616e 6420 782e 6e61 6d65 206e 6f74  ) and x.name not
-00026fc0: 2069 6e20 6578 6973 7469 6e67 5f77 6f72   in existing_wor
-00026fd0: 6b73 7061 6365 733a 0a20 2020 2020 2020  kspaces:.       
-00026fe0: 2020 2020 2020 2020 2077 6f72 6b73 7061           workspa
-00026ff0: 6365 5f6c 6962 5f70 6174 6873 2e61 7070  ce_lib_paths.app
-00027000: 656e 6428 2878 2e6e 616d 652c 2078 2929  end((x.name, x))
-00027010: 0a0a 2020 2020 6461 7461 736f 7572 6365  ..    datasource
-00027020: 733a 204c 6973 745b 4469 6374 5b73 7472  s: List[Dict[str
-00027030: 2c20 416e 795d 5d20 3d20 6177 6169 7420  , Any]] = await 
-00027040: 7462 5f63 6c69 656e 742e 6461 7461 736f  tb_client.dataso
-00027050: 7572 6365 7328 290a 2020 2020 7069 7065  urces().    pipe
-00027060: 733a 204c 6973 745b 4469 6374 5b73 7472  s: List[Dict[str
-00027070: 2c20 416e 795d 5d20 3d20 6177 6169 7420  , Any]] = await 
-00027080: 7462 5f63 6c69 656e 742e 7069 7065 7328  tb_client.pipes(
-00027090: 6465 7065 6e64 656e 6369 6573 3d54 7275  dependencies=Tru
-000270a0: 6529 0a0a 2020 2020 6578 6973 7469 6e67  e)..    existing
-000270b0: 5f72 6573 6f75 7263 6573 3a20 4c69 7374  _resources: List
-000270c0: 5b73 7472 5d20 3d20 5b78 5b22 6e61 6d65  [str] = [x["name
-000270d0: 225d 2066 6f72 2078 2069 6e20 6461 7461  "] for x in data
-000270e0: 736f 7572 6365 735d 202b 205b 785b 226e  sources] + [x["n
-000270f0: 616d 6522 5d20 666f 7220 7820 696e 2070  ame"] for x in p
-00027100: 6970 6573 5d0a 2020 2020 2320 7265 706c  ipes].    # repl
-00027110: 6163 6520 776f 726b 7370 6163 6520 6d61  ace workspace ma
-00027120: 7070 696e 6720 6e61 6d65 730a 2020 2020  pping names.    
-00027130: 666f 7220 6f6c 645f 7773 2c20 6e65 775f  for old_ws, new_
-00027140: 7773 2069 6e20 776f 726b 7370 6163 655f  ws in workspace_
-00027150: 6d61 702e 6974 656d 7328 293a 0a20 2020  map.items():.   
-00027160: 2020 2020 2065 7869 7374 696e 675f 7265       existing_re
-00027170: 736f 7572 6365 7320 3d20 5b72 652e 7375  sources = [re.su
-00027180: 6228 6622 5e7b 6f6c 645f 7773 7d5c 2e22  b(f"^{old_ws}\."
-00027190: 2c20 6622 7b6e 6577 5f77 737d 2e22 2c20  , f"{new_ws}.", 
-000271a0: 7829 2066 6f72 2078 2069 6e20 6578 6973  x) for x in exis
-000271b0: 7469 6e67 5f72 6573 6f75 7263 6573 5d0a  ting_resources].
-000271c0: 0a20 2020 2072 656d 6f74 655f 7265 736f  .    remote_reso
-000271d0: 7572 6365 5f6e 616d 6573 203d 205b 6765  urce_names = [ge
-000271e0: 745f 7265 6d6f 7465 5f72 6573 6f75 7263  t_remote_resourc
-000271f0: 655f 6e61 6d65 5f77 6974 686f 7574 5f76  e_name_without_v
-00027200: 6572 7369 6f6e 2878 2920 666f 7220 7820  ersion(x) for x 
-00027210: 696e 2065 7869 7374 696e 675f 7265 736f  in existing_reso
-00027220: 7572 6365 735d 0a0a 2020 2020 2320 7265  urces]..    # re
-00027230: 706c 6163 6520 776f 726b 7370 6163 6520  place workspace 
-00027240: 6d61 7070 696e 6720 6e61 6d65 730a 2020  mapping names.  
-00027250: 2020 666f 7220 6f6c 645f 7773 2c20 6e65    for old_ws, ne
-00027260: 775f 7773 2069 6e20 776f 726b 7370 6163  w_ws in workspac
-00027270: 655f 6d61 702e 6974 656d 7328 293a 0a20  e_map.items():. 
-00027280: 2020 2020 2020 2072 656d 6f74 655f 7265         remote_re
-00027290: 736f 7572 6365 5f6e 616d 6573 203d 205b  source_names = [
-000272a0: 7265 2e73 7562 2866 225e 7b6f 6c64 5f77  re.sub(f"^{old_w
-000272b0: 737d 5c2e 222c 2066 227b 6e65 775f 7773  s}\.", f"{new_ws
-000272c0: 7d2e 222c 2078 2920 666f 7220 7820 696e  }.", x) for x in
-000272d0: 2072 656d 6f74 655f 7265 736f 7572 6365   remote_resource
-000272e0: 5f6e 616d 6573 5d0a 0a20 2020 2069 6620  _names]..    if 
-000272f0: 6e6f 7420 6669 6c65 6e61 6d65 733a 0a20  not filenames:. 
-00027300: 2020 2020 2020 2066 696c 656e 616d 6573         filenames
-00027310: 203d 2067 6574 5f70 726f 6a65 6374 5f66   = get_project_f
-00027320: 696c 656e 616d 6573 2866 6f6c 6465 7229  ilenames(folder)
-00027330: 0a0a 2020 2020 2320 6765 7420 7468 6520  ..    # get the 
-00027340: 6c69 7374 206f 6620 6368 616e 6765 730a  list of changes.
-00027350: 2020 2020 6368 616e 6765 642c 2064 656c      changed, del
-00027360: 6574 6564 203d 2061 7761 6974 2064 6570  eted = await dep
-00027370: 6c6f 796d 656e 742e 6465 7465 6374 5f63  loyment.detect_c
-00027380: 6861 6e67 6573 2866 696c 656e 616d 6573  hanges(filenames
-00027390: 2c20 6f6e 6c79 5f63 6861 6e67 6573 2c20  , only_changes, 
-000273a0: 636f 6e66 6967 2c20 7573 655f 6d61 696e  config, use_main
-000273b0: 290a 0a20 2020 2064 6570 6c6f 796d 656e  )..    deploymen
-000273c0: 742e 6368 6563 6b5f 6368 616e 6765 7328  t.check_changes(
-000273d0: 6368 616e 6765 642c 2070 6970 6573 2c20  changed, pipes, 
-000273e0: 7265 6c65 6173 655f 6372 6561 7465 6429  release_created)
-000273f0: 0a0a 2020 2020 6465 706c 6f79 6d65 6e74  ..    deployment
-00027400: 2e70 7265 7061 7269 6e67 5f72 656c 6561  .preparing_relea
-00027410: 7365 2829 0a0a 2020 2020 2320 6275 696c  se()..    # buil
-00027420: 6420 6772 6170 6820 746f 2067 6574 206e  d graph to get n
-00027430: 6577 2076 6572 7369 6f6e 7320 666f 7220  ew versions for 
-00027440: 616c 6c20 7468 6520 6669 6c65 7320 696e  all the files in
-00027450: 766f 6c76 6564 2069 6e20 7468 6520 7175  volved in the qu
-00027460: 6572 790a 2020 2020 2320 6465 7065 6e64  ery.    # depend
-00027470: 656e 6369 6573 206e 6565 6420 746f 2062  encies need to b
-00027480: 6520 7072 6f63 6573 7365 6420 616c 7761  e processed alwa
-00027490: 7973 2074 6f20 6765 7420 7468 6520 7665  ys to get the ve
-000274a0: 7273 696f 6e73 0a20 2020 2064 6570 656e  rsions.    depen
-000274b0: 6465 6e63 6965 735f 6772 6170 6820 3d20  dencies_graph = 
-000274c0: 6177 6169 7420 6275 696c 645f 6772 6170  await build_grap
-000274d0: 6828 0a20 2020 2020 2020 2066 696c 656e  h(.        filen
-000274e0: 616d 6573 2c0a 2020 2020 2020 2020 7462  ames,.        tb
-000274f0: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
-00027500: 2064 6972 5f70 6174 683d 666f 6c64 6572   dir_path=folder
-00027510: 2c0a 2020 2020 2020 2020 7072 6f63 6573  ,.        proces
-00027520: 735f 6465 7065 6e64 656e 6369 6573 3d54  s_dependencies=T
-00027530: 7275 652c 0a20 2020 2020 2020 2077 6f72  rue,.        wor
-00027540: 6b73 7061 6365 5f6d 6170 3d77 6f72 6b73  kspace_map=works
-00027550: 7061 6365 5f6d 6170 2c0a 2020 2020 2020  pace_map,.      
-00027560: 2020 736b 6970 5f63 6f6e 6e65 6374 6f72    skip_connector
-00027570: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00027580: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
-00027590: 7468 733d 776f 726b 7370 6163 655f 6c69  ths=workspace_li
-000275a0: 625f 7061 7468 732c 0a20 2020 2020 2020  b_paths,.       
-000275b0: 2063 7572 7265 6e74 5f77 733d 6375 7272   current_ws=curr
-000275c0: 656e 745f 7773 2c0a 2020 2020 2020 2020  ent_ws,.        
-000275d0: 6368 616e 6765 643d 6368 616e 6765 642c  changed=changed,
-000275e0: 0a20 2020 2020 2020 206f 6e6c 795f 6368  .        only_ch
-000275f0: 616e 6765 733d 6f6e 6c79 5f63 6861 6e67  anges=only_chang
-00027600: 6573 206f 7220 2864 6570 6c6f 796d 656e  es or (deploymen
-00027610: 742e 6973 5f67 6974 5f72 656c 6561 7365  t.is_git_release
-00027620: 2061 6e64 2068 6173 5f73 656d 7665 7229   and has_semver)
-00027630: 2c0a 2020 2020 2020 2020 666f 726b 5f64  ,.        fork_d
-00027640: 6f77 6e73 7472 6561 6d3d 666f 726b 5f64  ownstream=fork_d
-00027650: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
-00027660: 2020 2069 735f 696e 7465 726e 616c 3d69     is_internal=i
-00027670: 735f 696e 7465 726e 616c 2c0a 2020 2020  s_internal,.    
-00027680: 290a 0a20 2020 2023 2075 7064 6174 6520  )..    # update 
-00027690: 6578 6973 7469 6e67 2076 6572 7369 6f6e  existing version
-000276a0: 730a 2020 2020 6966 206e 6f74 206e 6f5f  s.    if not no_
-000276b0: 7665 7273 696f 6e73 3a0a 2020 2020 2020  versions:.      
-000276c0: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
-000276d0: 6f6e 7320 3d20 6765 745f 7265 736f 7572  ons = get_resour
-000276e0: 6365 5f76 6572 7369 6f6e 7328 6578 6973  ce_versions(exis
-000276f0: 7469 6e67 5f72 6573 6f75 7263 6573 290a  ting_resources).
-00027700: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
-00027710: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
-00027720: 6e73 203d 2072 6573 6f75 7263 655f 7665  ns = resource_ve
-00027730: 7273 696f 6e73 2e63 6f70 7928 290a 0a20  rsions.copy().. 
-00027740: 2020 2020 2020 2066 6f72 2064 6570 2069         for dep i
-00027750: 6e20 6465 7065 6e64 656e 6369 6573 5f67  n dependencies_g
-00027760: 7261 7068 2e74 6f5f 7275 6e2e 7661 6c75  raph.to_run.valu
-00027770: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00027780: 2020 6473 203d 2064 6570 5b22 7265 736f    ds = dep["reso
-00027790: 7572 6365 5f6e 616d 6522 5d0a 2020 2020  urce_name"].    
-000277a0: 2020 2020 2020 2020 6966 2064 6570 5b22          if dep["
-000277b0: 7665 7273 696f 6e22 5d20 6973 206e 6f74  version"] is not
-000277c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000277d0: 2020 2020 2020 206c 6174 6573 745f 6461         latest_da
-000277e0: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
-000277f0: 735b 6473 5d20 3d20 6465 705b 2276 6572  s[ds] = dep["ver
-00027800: 7369 6f6e 225d 0a20 2020 2065 6c73 653a  sion"].    else:
-00027810: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-00027820: 655f 7665 7273 696f 6e73 203d 207b 7d0a  e_versions = {}.
-00027830: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
-00027840: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
-00027850: 6e73 203d 207b 7d0a 0a20 2020 2023 2049  ns = {}..    # I
-00027860: 6620 7765 2068 6176 6520 6461 7461 736f  f we have dataso
-00027870: 7572 6365 7320 7573 696e 6720 5645 5253  urces using VERS
-00027880: 494f 4e2c 206c 6574 2773 2074 7279 2074  ION, let's try t
-00027890: 6f20 6765 7420 7468 6520 6c61 7465 7374  o get the latest
-000278a0: 2076 6572 7369 6f6e 0a20 2020 2064 6570   version.    dep
-000278b0: 656e 6465 6e63 6965 735f 6772 6170 6820  endencies_graph 
-000278c0: 3d20 6177 6169 7420 6275 696c 645f 6772  = await build_gr
-000278d0: 6170 6828 0a20 2020 2020 2020 2066 696c  aph(.        fil
-000278e0: 656e 616d 6573 2c0a 2020 2020 2020 2020  enames,.        
-000278f0: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
-00027900: 2020 2064 6972 5f70 6174 683d 666f 6c64     dir_path=fold
-00027910: 6572 2c0a 2020 2020 2020 2020 7265 736f  er,.        reso
-00027920: 7572 6365 5f76 6572 7369 6f6e 733d 6c61  urce_versions=la
-00027930: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
-00027940: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
-00027950: 2020 776f 726b 7370 6163 655f 6d61 703d    workspace_map=
-00027960: 776f 726b 7370 6163 655f 6d61 702c 0a20  workspace_map,. 
-00027970: 2020 2020 2020 2070 726f 6365 7373 5f64         process_d
-00027980: 6570 656e 6465 6e63 6965 733d 7075 7368  ependencies=push
-00027990: 5f64 6570 732c 0a20 2020 2020 2020 2076  _deps,.        v
-000279a0: 6572 626f 7365 3d76 6572 626f 7365 2c0a  erbose=verbose,.
-000279b0: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
-000279c0: 655f 6c69 625f 7061 7468 733d 776f 726b  e_lib_paths=work
-000279d0: 7370 6163 655f 6c69 625f 7061 7468 732c  space_lib_paths,
-000279e0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
-000279f0: 5f77 733d 6375 7272 656e 745f 7773 2c0a  _ws=current_ws,.
-00027a00: 2020 2020 2020 2020 6368 616e 6765 643d          changed=
-00027a10: 6368 616e 6765 642c 0a20 2020 2020 2020  changed,.       
-00027a20: 206f 6e6c 795f 6368 616e 6765 733d 6f6e   only_changes=on
-00027a30: 6c79 5f63 6861 6e67 6573 206f 7220 2864  ly_changes or (d
-00027a40: 6570 6c6f 796d 656e 742e 6973 5f67 6974  eployment.is_git
-00027a50: 5f72 656c 6561 7365 2061 6e64 2068 6173  _release and has
-00027a60: 5f73 656d 7665 7229 2c0a 2020 2020 2020  _semver),.      
-00027a70: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
-00027a80: 6d3d 666f 726b 5f64 6f77 6e73 7472 6561  m=fork_downstrea
-00027a90: 6d2c 0a20 2020 2020 2020 2069 735f 696e  m,.        is_in
-00027aa0: 7465 726e 616c 3d69 735f 696e 7465 726e  ternal=is_intern
-00027ab0: 616c 2c0a 2020 2020 290a 0a20 2020 2069  al,.    )..    i
-00027ac0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00027ad0: 2070 702e 7070 7269 6e74 2864 6570 656e   pp.pprint(depen
-00027ae0: 6465 6e63 6965 735f 6772 6170 682e 746f  dencies_graph.to
-00027af0: 5f72 756e 290a 0a20 2020 2069 6620 7665  _run)..    if ve
-00027b00: 7262 6f73 653a 0a20 2020 2020 2020 2063  rbose:.        c
-00027b10: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-00027b20: 636b 4d61 6e61 6765 722e 696e 666f 5f62  ckManager.info_b
-00027b30: 7569 6c64 696e 675f 6465 7065 6e64 656e  uilding_dependen
-00027b40: 6369 6573 2829 290a 0a20 2020 2064 6570  cies())..    dep
-00027b50: 6c6f 796d 656e 742e 7072 6570 6172 696e  loyment.preparin
-00027b60: 675f 6465 7065 6e64 656e 6369 6573 2863  g_dependencies(c
-00027b70: 6861 6e67 6564 2c20 6465 7065 6e64 656e  hanged, dependen
-00027b80: 6369 6573 5f67 7261 7068 2e64 6570 5f6d  cies_graph.dep_m
-00027b90: 6170 2c20 6c61 7465 7374 5f64 6174 6173  ap, latest_datas
-00027ba0: 6f75 7263 655f 7665 7273 696f 6e73 290a  ource_versions).
-00027bb0: 0a20 2020 2064 6566 2073 686f 756c 645f  .    def should_
-00027bc0: 7075 7368 5f66 696c 6528 0a20 2020 2020  push_file(.     
-00027bd0: 2020 206e 616d 653a 2073 7472 2c0a 2020     name: str,.  
-00027be0: 2020 2020 2020 7265 6d6f 7465 5f72 6573        remote_res
-00027bf0: 6f75 7263 655f 6e61 6d65 733a 204c 6973  ource_names: Lis
-00027c00: 745b 7374 725d 2c0a 2020 2020 2020 2020  t[str],.        
-00027c10: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
-00027c20: 655f 7665 7273 696f 6e73 3a20 4469 6374  e_versions: Dict
-00027c30: 5b73 7472 2c20 416e 795d 2c0a 2020 2020  [str, Any],.    
-00027c40: 2020 2020 666f 7263 653a 2062 6f6f 6c2c      force: bool,
-00027c50: 0a20 2020 2020 2020 2072 756e 5f74 6573  .        run_tes
-00027c60: 7473 3a20 626f 6f6c 2c0a 2020 2020 2920  ts: bool,.    ) 
-00027c70: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00027c80: 2022 2222 0a20 2020 2020 2020 2046 756e   """.        Fun
-00027c90: 6374 696f 6e20 746f 206b 6e6f 7720 6966  ction to know if
-00027ca0: 2077 6520 6e65 6564 2074 6f20 7275 6e20   we need to run 
-00027cb0: 6120 6669 6c65 206f 7220 6e6f 740a 2020  a file or not.  
-00027cc0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00027cd0: 2020 6966 206e 616d 6520 6e6f 7420 696e    if name not in
-00027ce0: 2072 656d 6f74 655f 7265 736f 7572 6365   remote_resource
-00027cf0: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
-00027d00: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00027d10: 2020 2020 2020 2020 2320 5768 656e 2077          # When w
-00027d20: 6520 6e65 6564 2074 6f20 7472 7920 746f  e need to try to
-00027d30: 2070 7573 6820 6120 6669 6c65 2077 6865   push a file whe
-00027d40: 6e20 6974 2064 6f65 736e 2774 2065 7869  n it doesn't exi
-00027d50: 7374 2061 6e64 2074 6865 2076 6572 7369  st and the versi
-00027d60: 6f6e 2069 7320 6469 6666 6572 656e 7420  on is different 
-00027d70: 7468 6174 2074 6865 2065 7869 7374 696e  that the existin
-00027d80: 6720 6f6e 650a 2020 2020 2020 2020 7265  g one.        re
-00027d90: 736f 7572 6365 5f66 756c 6c5f 6e61 6d65  source_full_name
-00027da0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00027db0: 2066 227b 6e61 6d65 7d5f 5f76 7b6c 6174   f"{name}__v{lat
-00027dc0: 6573 745f 6461 7461 736f 7572 6365 5f76  est_datasource_v
-00027dd0: 6572 7369 6f6e 732e 6765 7428 6e61 6d65  ersions.get(name
-00027de0: 297d 2220 6966 206e 616d 6520 696e 206c  )}" if name in l
-00027df0: 6174 6573 745f 6461 7461 736f 7572 6365  atest_datasource
-00027e00: 5f76 6572 7369 6f6e 7320 656c 7365 206e  _versions else n
-00027e10: 616d 650a 2020 2020 2020 2020 290a 2020  ame.        ).  
-00027e20: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
-00027e30: 655f 6675 6c6c 5f6e 616d 6520 6e6f 7420  e_full_name not 
-00027e40: 696e 2065 7869 7374 696e 675f 7265 736f  in existing_reso
-00027e50: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
-00027e60: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
-00027e70: 2020 2020 2020 2069 6620 666f 7263 6520         if force 
-00027e80: 6f72 2072 756e 5f74 6573 7473 3a0a 2020  or run_tests:.  
-00027e90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00027ea0: 2054 7275 650a 2020 2020 2020 2020 7265   True.        re
-00027eb0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00027ec0: 6173 796e 6320 6465 6620 7075 7368 280a  async def push(.
-00027ed0: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
-00027ee0: 722c 0a20 2020 2020 2020 2074 6f5f 7275  r,.        to_ru
-00027ef0: 6e3a 2044 6963 745b 7374 722c 2044 6963  n: Dict[str, Dic
-00027f00: 745b 7374 722c 2041 6e79 5d5d 2c0a 2020  t[str, Any]],.  
-00027f10: 2020 2020 2020 7265 736f 7572 6365 5f76        resource_v
-00027f20: 6572 7369 6f6e 733a 2044 6963 745b 7374  ersions: Dict[st
-00027f30: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
-00027f40: 206c 6174 6573 745f 6461 7461 736f 7572   latest_datasour
-00027f50: 6365 5f76 6572 7369 6f6e 733a 2044 6963  ce_versions: Dic
-00027f60: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-00027f70: 2020 2020 2064 7279 5f72 756e 3a20 626f       dry_run: bo
-00027f80: 6f6c 2c0a 2020 2020 2020 2020 666f 726b  ol,.        fork
-00027f90: 5f64 6f77 6e73 7472 6561 6d3a 204f 7074  _downstream: Opt
-00027fa0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
-00027fb0: 6c73 652c 0a20 2020 2020 2020 2066 6f72  lse,.        for
-00027fc0: 6b3a 204f 7074 696f 6e61 6c5b 626f 6f6c  k: Optional[bool
-00027fd0: 5d20 3d20 4661 6c73 652c 0a20 2020 2029  ] = False,.    )
-00027fe0: 3a0a 2020 2020 2020 2020 6966 206e 616d  :.        if nam
-00027ff0: 6520 696e 2074 6f5f 7275 6e3a 0a20 2020  e in to_run:.   
-00028000: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00028010: 6472 795f 7275 6e3a 0a20 2020 2020 2020  dry_run:.       
-00028020: 2020 2020 2020 2020 2069 6620 7368 6f75           if shou
-00028030: 6c64 5f70 7573 685f 6669 6c65 286e 616d  ld_push_file(nam
-00028040: 652c 2072 656d 6f74 655f 7265 736f 7572  e, remote_resour
-00028050: 6365 5f6e 616d 6573 2c20 6c61 7465 7374  ce_names, latest
-00028060: 5f64 6174 6173 6f75 7263 655f 7665 7273  _datasource_vers
-00028070: 696f 6e73 2c20 666f 7263 652c 2072 756e  ions, force, run
-00028080: 5f74 6573 7473 293a 0a20 2020 2020 2020  _tests):.       
-00028090: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000280a0: 6e61 6d65 206e 6f74 2069 6e20 7265 736f  name not in reso
-000280b0: 7572 6365 5f76 6572 7369 6f6e 733a 0a20  urce_versions:. 
-000280c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000280d0: 2020 2020 2020 2076 6572 7369 6f6e 203d         version =
-000280e0: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
-000280f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00028100: 616d 6520 696e 206c 6174 6573 745f 6461  ame in latest_da
-00028110: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
-00028120: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00028130: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00028140: 6572 7369 6f6e 203d 2066 2228 767b 6c61  ersion = f"(v{la
-00028150: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
-00028160: 7665 7273 696f 6e73 5b6e 616d 655d 7d29  versions[name]})
-00028170: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00028180: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-00028190: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-000281a0: 6167 6572 2e69 6e66 6f5f 7072 6f63 6573  ager.info_proces
-000281b0: 7369 6e67 5f6e 6577 5f72 6573 6f75 7263  sing_new_resourc
-000281c0: 6528 6e61 6d65 3d6e 616d 652c 2076 6572  e(name=name, ver
-000281d0: 7369 6f6e 3d76 6572 7369 6f6e 2929 0a20  sion=version)). 
+00025360: 2020 2020 666f 7220 5f6b 6579 2c20 5f64      for _key, _d
+00025370: 6570 7320 696e 2061 6c6c 5f64 6570 5f6d  eps in all_dep_m
+00025380: 6170 2e69 7465 6d73 2829 3a0a 2020 2020  ap.items():.    
+00025390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253a0: 2020 2020 666f 7220 6465 7020 696e 205f      for dep in _
+000253b0: 6465 7073 3a0a 2020 2020 2020 2020 2020  deps:.          
+000253c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253d0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+000253e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253f0: 2020 2020 2020 2064 6570 203d 3d20 7461         dep == ta
+00025400: 7267 6574 5f64 6174 6173 6f75 7263 650a  rget_datasource.
+00025410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025430: 6f72 2028 6465 7020 3d3d 206b 6579 2061  or (dep == key a
+00025440: 6e64 2074 6172 6765 745f 6461 7461 736f  nd target_dataso
+00025450: 7572 6365 206e 6f74 2069 6e20 616c 6c5f  urce not in all_
+00025460: 6465 705f 6d61 702e 6765 7428 6b65 792c  dep_map.get(key,
+00025470: 205b 5d29 290a 2020 2020 2020 2020 2020   [])).          
+00025480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025490: 2020 2920 616e 6420 6973 5f65 6e64 706f    ) and is_endpo
+000254a0: 696e 745f 7769 7468 5f6e 6f5f 6465 7065  int_with_no_depe
+000254b0: 6e64 656e 6369 6573 280a 2020 2020 2020  ndencies(.      
+000254c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000254d0: 2020 2020 2020 2020 2020 616c 6c5f 7265            all_re
+000254e0: 736f 7572 6365 732e 6765 7428 5f6b 6579  sources.get(_key
+000254f0: 2c20 7b7d 292c 2061 6c6c 5f64 6570 5f6d  , {}), all_dep_m
+00025500: 6170 2c20 616c 6c5f 7265 736f 7572 6365  ap, all_resource
+00025510: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00025520: 2020 2020 2020 2020 2020 2020 2020 293a                ):
+00025530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025550: 2064 6570 5f6d 6170 5b5f 6b65 795d 203d   dep_map[_key] =
+00025560: 205f 6465 7073 0a20 2020 2020 2020 2020   _deps.         
+00025570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025580: 2020 2020 2020 2074 6f5f 7275 6e5b 5f6b         to_run[_k
+00025590: 6579 5d20 3d20 616c 6c5f 7265 736f 7572  ey] = all_resour
+000255a0: 6365 732e 6765 7428 5f6b 6579 290a 2020  ces.get(_key).  
+000255b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000255c0: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
+000255d0: 6e28 6465 7073 2920 3e20 303a 0a20 2020  n(deps) > 0:.   
+000255e0: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+000255f0: 203d 2064 6570 732e 706f 7028 290a 2020   = deps.pop().  
+00025600: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00025610: 2064 6570 206e 6f74 2069 6e20 7072 6f63   dep not in proc
+00025620: 6573 7365 643a 0a20 2020 2020 2020 2020  essed:.         
+00025630: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+00025640: 7373 6564 2e61 6464 2864 6570 290a 2020  ssed.add(dep).  
+00025650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025660: 2020 6620 3d20 6675 6c6c 5f70 6174 685f    f = full_path_
+00025670: 6279 5f6e 616d 6528 6469 725f 7061 7468  by_name(dir_path
+00025680: 2c20 6465 702c 2077 6f72 6b73 7061 6365  , dep, workspace
+00025690: 5f6c 6962 5f70 6174 6873 290a 2020 2020  _lib_paths).    
+000256a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256b0: 6966 2066 3a0a 2020 2020 2020 2020 2020  if f:.          
+000256c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000256d0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+000256e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256f0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00025700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025710: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+00025720: 7373 6564 5f66 696c 656e 616d 6520 3d20  ssed_filename = 
+00025730: 662e 7265 6c61 7469 7665 5f74 6f28 6f73  f.relative_to(os
+00025740: 2e67 6574 6377 6428 2929 0a20 2020 2020  .getcwd()).     
+00025750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025760: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
+00025770: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
+00025780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025790: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
+000257a0: 7365 645f 6669 6c65 6e61 6d65 203d 2066  sed_filename = f
+000257b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000257c0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+000257d0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
+000257e0: 4d61 6e61 6765 722e 696e 666f 5f70 726f  Manager.info_pro
+000257f0: 6365 7373 696e 675f 6669 6c65 2866 696c  cessing_file(fil
+00025800: 656e 616d 653d 7072 6f63 6573 7365 645f  ename=processed_
+00025810: 6669 6c65 6e61 6d65 2929 0a20 2020 2020  filename)).     
+00025820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025830: 2020 2061 7761 6974 2070 726f 6365 7373     await process
+00025840: 2873 7472 2866 292c 2064 6570 732c 2064  (str(f), deps, d
+00025850: 6570 5f6d 6170 2c20 746f 5f72 756e 2c20  ep_map, to_run, 
+00025860: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+00025870: 7468 7329 0a0a 2020 2020 7265 7475 726e  ths)..    return
+00025880: 2047 7261 7068 4465 7065 6e64 656e 6369   GraphDependenci
+00025890: 6573 2864 6570 5f6d 6170 2c20 746f 5f72  es(dep_map, to_r
+000258a0: 756e 2c20 616c 6c5f 6465 705f 6d61 702c  un, all_dep_map,
+000258b0: 2061 6c6c 5f72 6573 6f75 7263 6573 290a   all_resources).
+000258c0: 0a0a 6173 796e 6320 6465 6620 6765 745f  ..async def get_
+000258d0: 6368 616e 6765 735f 6672 6f6d 5f6d 6169  changes_from_mai
+000258e0: 6e28 0a20 2020 206f 6e6c 795f 6368 616e  n(.    only_chan
+000258f0: 6765 733a 2062 6f6f 6c2c 0a20 2020 2063  ges: bool,.    c
+00025900: 6c69 656e 743a 2054 696e 7942 2c0a 2020  lient: TinyB,.  
+00025910: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+00025920: 616c 5b44 6963 745b 7374 722c 2041 6e79  al[Dict[str, Any
+00025930: 5d5d 203d 204e 6f6e 652c 0a20 2020 2063  ]] = None,.    c
+00025940: 7572 7265 6e74 5f77 733a 204f 7074 696f  urrent_ws: Optio
+00025950: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
+00025960: 795d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  y]] = None,.    
+00025970: 6669 6c65 6e61 6d65 733a 204f 7074 696f  filenames: Optio
+00025980: 6e61 6c5b 4c69 7374 5b73 7472 5d5d 203d  nal[List[str]] =
+00025990: 204e 6f6e 652c 0a29 3a0a 2020 2020 6368   None,.):.    ch
+000259a0: 616e 6765 6420 3d20 4e6f 6e65 0a20 2020  anged = None.   
+000259b0: 2069 6620 6e6f 7420 6f6e 6c79 5f63 6861   if not only_cha
+000259c0: 6e67 6573 3a0a 2020 2020 2020 2020 7265  nges:.        re
+000259d0: 7475 726e 2063 6861 6e67 6564 0a0a 2020  turn changed..  
+000259e0: 2020 6966 2063 7572 7265 6e74 5f77 7320    if current_ws 
+000259f0: 616e 6420 6e6f 7420 6375 7272 656e 745f  and not current_
+00025a00: 7773 2e67 6574 2822 6973 5f62 7261 6e63  ws.get("is_branc
+00025a10: 6822 293a 0a20 2020 2020 2020 2063 6861  h"):.        cha
+00025a20: 6e67 6564 203d 2061 7761 6974 2064 6966  nged = await dif
+00025a30: 665f 636f 6d6d 616e 6428 6669 6c65 6e61  f_command(filena
+00025a40: 6d65 732c 2054 7275 652c 2063 6c69 656e  mes, True, clien
+00025a50: 742c 206e 6f5f 636f 6c6f 723d 5472 7565  t, no_color=True
+00025a60: 2c20 7769 7468 5f70 7269 6e74 3d46 616c  , with_print=Fal
+00025a70: 7365 290a 2020 2020 656c 6966 2063 6f6e  se).    elif con
+00025a80: 6669 6720 616e 6420 636f 6e66 6967 2e67  fig and config.g
+00025a90: 6574 2822 686f 7374 2229 3a0a 2020 2020  et("host"):.    
+00025aa0: 2020 2020 776f 726b 7370 6163 6520 3d20      workspace = 
+00025ab0: 6177 6169 7420 6765 745f 6375 7272 656e  await get_curren
+00025ac0: 745f 6d61 696e 5f77 6f72 6b73 7061 6365  t_main_workspace
+00025ad0: 2863 6c69 656e 742c 2063 6f6e 6669 6729  (client, config)
+00025ae0: 0a0a 2020 2020 2020 2020 6966 2077 6f72  ..        if wor
+00025af0: 6b73 7061 6365 3a0a 2020 2020 2020 2020  kspace:.        
+00025b00: 2020 2020 7773 5f63 6c69 656e 7420 3d20      ws_client = 
+00025b10: 5f67 6574 5f74 625f 636c 6965 6e74 2877  _get_tb_client(w
+00025b20: 6f72 6b73 7061 6365 5b22 746f 6b65 6e22  orkspace["token"
+00025b30: 5d2c 2063 6f6e 6669 675b 2268 6f73 7422  ], config["host"
+00025b40: 5d29 0a20 2020 2020 2020 2020 2020 2063  ]).            c
+00025b50: 6861 6e67 6564 203d 2061 7761 6974 2064  hanged = await d
+00025b60: 6966 665f 636f 6d6d 616e 6428 6669 6c65  iff_command(file
+00025b70: 6e61 6d65 732c 2054 7275 652c 2077 735f  names, True, ws_
+00025b80: 636c 6965 6e74 2c20 6e6f 5f63 6f6c 6f72  client, no_color
+00025b90: 3d54 7275 652c 2077 6974 685f 7072 696e  =True, with_prin
+00025ba0: 743d 4661 6c73 6529 0a20 2020 2072 6574  t=False).    ret
+00025bb0: 7572 6e20 6368 616e 6765 640a 0a0a 6465  urn changed...de
+00025bc0: 6620 6765 745f 7072 6f6a 6563 745f 6669  f get_project_fi
+00025bd0: 6c65 6e61 6d65 7328 666f 6c64 6572 3a20  lenames(folder: 
+00025be0: 7374 722c 2077 6974 685f 7665 6e64 6f72  str, with_vendor
+00025bf0: 3d46 616c 7365 2920 2d3e 204c 6973 745b  =False) -> List[
+00025c00: 7374 725d 3a0a 2020 2020 666f 6c64 6572  str]:.    folder
+00025c10: 733a 204c 6973 745b 7374 725d 203d 205b  s: List[str] = [
+00025c20: 0a20 2020 2020 2020 2066 227b 666f 6c64  .        f"{fold
+00025c30: 6572 7d2f 2a2e 6461 7461 736f 7572 6365  er}/*.datasource
+00025c40: 222c 0a20 2020 2020 2020 2066 227b 666f  ",.        f"{fo
+00025c50: 6c64 6572 7d2f 6461 7461 736f 7572 6365  lder}/datasource
+00025c60: 732f 2a2e 6461 7461 736f 7572 6365 222c  s/*.datasource",
+00025c70: 0a20 2020 2020 2020 2066 227b 666f 6c64  .        f"{fold
+00025c80: 6572 7d2f 2a2e 7069 7065 222c 0a20 2020  er}/*.pipe",.   
+00025c90: 2020 2020 2066 227b 666f 6c64 6572 7d2f       f"{folder}/
+00025ca0: 7069 7065 732f 2a2e 7069 7065 222c 0a20  pipes/*.pipe",. 
+00025cb0: 2020 2020 2020 2066 227b 666f 6c64 6572         f"{folder
+00025cc0: 7d2f 656e 6470 6f69 6e74 732f 2a2e 7069  }/endpoints/*.pi
+00025cd0: 7065 222c 0a20 2020 2020 2020 2066 227b  pe",.        f"{
+00025ce0: 666f 6c64 6572 7d2f 2a2e 746f 6b65 6e22  folder}/*.token"
+00025cf0: 2c0a 2020 2020 2020 2020 6622 7b66 6f6c  ,.        f"{fol
+00025d00: 6465 727d 2f74 6f6b 656e 732f 2a2e 746f  der}/tokens/*.to
+00025d10: 6b65 6e22 2c0a 2020 2020 5d0a 2020 2020  ken",.    ].    
+00025d20: 6966 2077 6974 685f 7665 6e64 6f72 3a0a  if with_vendor:.
+00025d30: 2020 2020 2020 2020 666f 6c64 6572 732e          folders.
+00025d40: 6170 7065 6e64 2866 227b 666f 6c64 6572  append(f"{folder
+00025d50: 7d2f 7665 6e64 6f72 2f2a 2a2f 2a2a 2f2a  }/vendor/**/**/*
+00025d60: 2e64 6174 6173 6f75 7263 6522 290a 2020  .datasource").  
+00025d70: 2020 6669 6c65 6e61 6d65 733a 204c 6973    filenames: Lis
+00025d80: 745b 7374 725d 203d 205b 5d0a 2020 2020  t[str] = [].    
+00025d90: 666f 7220 7820 696e 2066 6f6c 6465 7273  for x in folders
+00025da0: 3a0a 2020 2020 2020 2020 6669 6c65 6e61  :.        filena
+00025db0: 6d65 7320 2b3d 2067 6c6f 622e 676c 6f62  mes += glob.glob
+00025dc0: 2878 290a 2020 2020 7265 7475 726e 2066  (x).    return f
+00025dd0: 696c 656e 616d 6573 0a0a 0a64 6566 2069  ilenames...def i
+00025de0: 735f 6e65 7728 0a20 2020 206e 616d 653a  s_new(.    name:
+00025df0: 2073 7472 2c0a 2020 2020 6368 616e 6765   str,.    change
+00025e00: 643a 2044 6963 745b 7374 722c 2073 7472  d: Dict[str, str
+00025e10: 5d2c 0a20 2020 206e 6f72 6d61 6c5f 6465  ],.    normal_de
+00025e20: 7065 6e64 656e 6379 3a20 4469 6374 5b73  pendency: Dict[s
+00025e30: 7472 2c20 5365 745b 7374 725d 5d2c 0a20  tr, Set[str]],. 
+00025e40: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
+00025e50: 616d 5f64 6570 656e 6465 6e63 793a 2044  am_dependency: D
+00025e60: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
+00025e70: 5d5d 2c0a 2920 2d3e 2062 6f6f 6c3a 0a20  ]],.) -> bool:. 
+00025e80: 2020 2064 6566 2069 735f 6769 745f 6e65     def is_git_ne
+00025e90: 7728 6e61 6d65 3a20 7374 7229 3a0a 2020  w(name: str):.  
+00025ea0: 2020 2020 2020 7265 7475 726e 2063 6861        return cha
+00025eb0: 6e67 6564 2061 6e64 2063 6861 6e67 6564  nged and changed
+00025ec0: 2e67 6574 286e 616d 6529 203d 3d20 2241  .get(name) == "A
+00025ed0: 220a 0a20 2020 2069 6620 6e6f 7420 6973  "..    if not is
+00025ee0: 5f67 6974 5f6e 6577 286e 616d 6529 3a0a  _git_new(name):.
+00025ef0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00025f00: 616c 7365 0a0a 2020 2020 2320 6966 2073  alse..    # if s
+00025f10: 686f 756c 6420 6e6f 7420 6465 7065 6e64  hould not depend
+00025f20: 206f 6e20 6120 6368 616e 6765 6420 7265   on a changed re
+00025f30: 736f 7572 6365 0a20 2020 2069 6620 6261  source.    if ba
+00025f40: 636b 5f64 6570 7320 3a3d 206e 6f72 6d61  ck_deps := norma
+00025f50: 6c5f 6465 7065 6e64 656e 6379 2e67 6574  l_dependency.get
+00025f60: 286e 616d 6529 3a0a 2020 2020 2020 2020  (name):.        
+00025f70: 666f 7220 6465 7020 696e 2062 6163 6b5f  for dep in back_
+00025f80: 6465 7073 3a0a 2020 2020 2020 2020 2020  deps:.          
+00025f90: 2020 6966 2064 6570 2069 6e20 666f 726b    if dep in fork
+00025fa0: 5f64 6f77 6e73 7472 6561 6d5f 6465 7065  _downstream_depe
+00025fb0: 6e64 656e 6379 2061 6e64 206e 6f74 2069  ndency and not i
+00025fc0: 735f 6769 745f 6e65 7728 6465 7029 3a0a  s_git_new(dep):.
+00025fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025fe0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+00025ff0: 2020 7265 7475 726e 2054 7275 650a 0a0a    return True...
+00026000: 6173 796e 6320 6465 6620 666f 6c64 6572  async def folder
+00026010: 5f70 7573 6828 0a20 2020 2074 625f 636c  _push(.    tb_cl
+00026020: 6965 6e74 3a20 5469 6e79 422c 0a20 2020  ient: TinyB,.   
+00026030: 2066 696c 656e 616d 6573 3a20 4f70 7469   filenames: Opti
+00026040: 6f6e 616c 5b4c 6973 745b 7374 725d 5d20  onal[List[str]] 
+00026050: 3d20 4e6f 6e65 2c0a 2020 2020 6472 795f  = None,.    dry_
+00026060: 7275 6e3a 2062 6f6f 6c20 3d20 4661 6c73  run: bool = Fals
+00026070: 652c 0a20 2020 2063 6865 636b 3a20 626f  e,.    check: bo
+00026080: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00026090: 7075 7368 5f64 6570 733a 2062 6f6f 6c20  push_deps: bool 
+000260a0: 3d20 4661 6c73 652c 0a20 2020 206f 6e6c  = False,.    onl
+000260b0: 795f 6368 616e 6765 733a 2062 6f6f 6c20  y_changes: bool 
+000260c0: 3d20 4661 6c73 652c 0a20 2020 2067 6974  = False,.    git
+000260d0: 5f72 656c 6561 7365 3a20 626f 6f6c 203d  _release: bool =
+000260e0: 2046 616c 7365 2c0a 2020 2020 6465 6275   False,.    debu
+000260f0: 673a 2062 6f6f 6c20 3d20 4661 6c73 652c  g: bool = False,
+00026100: 0a20 2020 2066 6f72 6365 3a20 626f 6f6c  .    force: bool
+00026110: 203d 2046 616c 7365 2c0a 2020 2020 6f76   = False,.    ov
+00026120: 6572 7269 6465 5f64 6174 6173 6f75 7263  erride_datasourc
+00026130: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+00026140: 0a20 2020 2066 6f6c 6465 723a 2073 7472  .    folder: str
+00026150: 203d 2022 2e22 2c0a 2020 2020 706f 7075   = ".",.    popu
+00026160: 6c61 7465 3a20 626f 6f6c 203d 2046 616c  late: bool = Fal
+00026170: 7365 2c0a 2020 2020 706f 7075 6c61 7465  se,.    populate
+00026180: 5f73 7562 7365 743d 4e6f 6e65 2c0a 2020  _subset=None,.  
+00026190: 2020 706f 7075 6c61 7465 5f63 6f6e 6469    populate_condi
+000261a0: 7469 6f6e 3a20 4f70 7469 6f6e 616c 5b73  tion: Optional[s
+000261b0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+000261c0: 756e 6c69 6e6b 5f6f 6e5f 706f 7075 6c61  unlink_on_popula
+000261d0: 7465 5f65 7272 6f72 3a20 626f 6f6c 203d  te_error: bool =
+000261e0: 2046 616c 7365 2c0a 2020 2020 7570 6c6f   False,.    uplo
+000261f0: 6164 5f66 6978 7475 7265 733a 2062 6f6f  ad_fixtures: boo
+00026200: 6c20 3d20 4661 6c73 652c 0a20 2020 2077  l = False,.    w
+00026210: 6169 743a 2062 6f6f 6c20 3d20 4661 6c73  ait: bool = Fals
+00026220: 652c 0a20 2020 2069 676e 6f72 655f 7371  e,.    ignore_sq
+00026230: 6c5f 6572 726f 7273 3a20 626f 6f6c 203d  l_errors: bool =
+00026240: 2046 616c 7365 2c0a 2020 2020 736b 6970   False,.    skip
+00026250: 5f63 6f6e 6669 726d 6174 696f 6e3a 2062  _confirmation: b
+00026260: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00026270: 206f 6e6c 795f 7265 7370 6f6e 7365 5f74   only_response_t
+00026280: 696d 6573 3a20 626f 6f6c 203d 2046 616c  imes: bool = Fal
+00026290: 7365 2c0a 2020 2020 776f 726b 7370 6163  se,.    workspac
+000262a0: 655f 6d61 703d 4e6f 6e65 2c0a 2020 2020  e_map=None,.    
+000262b0: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+000262c0: 7468 733d 4e6f 6e65 2c0a 2020 2020 6e6f  ths=None,.    no
+000262d0: 5f76 6572 7369 6f6e 733a 2062 6f6f 6c20  _versions: bool 
+000262e0: 3d20 4661 6c73 652c 0a20 2020 2072 756e  = False,.    run
+000262f0: 5f74 6573 7473 3a20 626f 6f6c 203d 2046  _tests: bool = F
+00026300: 616c 7365 2c0a 2020 2020 6173 5f73 7461  alse,.    as_sta
+00026310: 6e64 6172 643a 2062 6f6f 6c20 3d20 4661  ndard: bool = Fa
+00026320: 6c73 652c 0a20 2020 2072 6169 7365 5f6f  lse,.    raise_o
+00026330: 6e5f 6578 6973 7473 3a20 626f 6f6c 203d  n_exists: bool =
+00026340: 2046 616c 7365 2c0a 2020 2020 7665 7262   False,.    verb
+00026350: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
+00026360: 2c0a 2020 2020 7465 7374 735f 746f 5f72  ,.    tests_to_r
+00026370: 756e 3a20 696e 7420 3d20 302c 0a20 2020  un: int = 0,.   
+00026380: 2074 6573 7473 5f73 616d 706c 655f 6279   tests_sample_by
+00026390: 5f70 6172 616d 733a 2069 6e74 203d 2030  _params: int = 0
+000263a0: 2c0a 2020 2020 7465 7374 735f 6669 6c74  ,.    tests_filt
+000263b0: 6572 5f62 793a 204f 7074 696f 6e61 6c5b  er_by: Optional[
+000263c0: 4c69 7374 5b73 7472 5d5d 203d 204e 6f6e  List[str]] = Non
+000263d0: 652c 0a20 2020 2074 6573 7473 5f66 6169  e,.    tests_fai
+000263e0: 6c66 6173 743a 2062 6f6f 6c20 3d20 4661  lfast: bool = Fa
+000263f0: 6c73 652c 0a20 2020 2074 6573 7473 5f69  lse,.    tests_i
+00026400: 676e 6f72 655f 6f72 6465 723a 2062 6f6f  gnore_order: boo
+00026410: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
+00026420: 6573 7473 5f76 616c 6964 6174 655f 7072  ests_validate_pr
+00026430: 6f63 6573 7365 645f 6279 7465 733a 2062  ocessed_bytes: b
+00026440: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00026450: 2074 6573 7473 5f63 6865 636b 5f72 6571   tests_check_req
+00026460: 7565 7374 735f 6672 6f6d 5f62 7261 6e63  uests_from_branc
+00026470: 683a 2062 6f6f 6c20 3d20 4661 6c73 652c  h: bool = False,
+00026480: 0a20 2020 2063 6f6e 6669 673a 204f 7074  .    config: Opt
+00026490: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+000264a0: 416e 795d 5d20 3d20 4e6f 6e65 2c0a 2020  Any]] = None,.  
+000264b0: 2020 7573 6572 5f74 6f6b 656e 3a20 4f70    user_token: Op
+000264c0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+000264d0: 6e65 2c0a 2020 2020 666f 726b 5f64 6f77  ne,.    fork_dow
+000264e0: 6e73 7472 6561 6d3a 204f 7074 696f 6e61  nstream: Optiona
+000264f0: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+00026500: 0a20 2020 2066 6f72 6b3a 204f 7074 696f  .    fork: Optio
+00026510: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00026520: 652c 0a20 2020 2069 735f 696e 7465 726e  e,.    is_intern
+00026530: 616c 3a20 4f70 7469 6f6e 616c 5b62 6f6f  al: Optional[boo
+00026540: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+00026550: 7265 6c65 6173 655f 6372 6561 7465 643a  release_created:
+00026560: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00026570: 3d20 4661 6c73 652c 0a20 2020 2061 7574  = False,.    aut
+00026580: 6f5f 7072 6f6d 6f74 653a 204f 7074 696f  o_promote: Optio
+00026590: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+000265a0: 652c 0a20 2020 2063 6865 636b 5f62 6163  e,.    check_bac
+000265b0: 6b66 696c 6c5f 7265 7175 6972 6564 3a20  kfill_required: 
+000265c0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+000265d0: 2020 7573 655f 6d61 696e 3a20 626f 6f6c    use_main: bool
+000265e0: 203d 2046 616c 7365 2c0a 293a 2020 2320   = False,.):  # 
+000265f0: 6e6f 7161 3a20 4339 3031 0a20 2020 2077  noqa: C901.    w
+00026600: 6f72 6b73 7061 6365 733a 204c 6973 745b  orkspaces: List[
+00026610: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+00026620: 3d20 2861 7761 6974 2074 625f 636c 6965  = (await tb_clie
+00026630: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
+00026640: 6573 5f61 6e64 5f62 7261 6e63 6865 7328  es_and_branches(
+00026650: 2929 2e67 6574 2822 776f 726b 7370 6163  )).get("workspac
+00026660: 6573 222c 205b 5d29 0a20 2020 2063 7572  es", []).    cur
+00026670: 7265 6e74 5f77 733a 2044 6963 745b 7374  rent_ws: Dict[st
+00026680: 722c 2041 6e79 5d20 3d20 6e65 7874 280a  r, Any] = next(.
+00026690: 2020 2020 2020 2020 2877 6f72 6b73 7061          (workspa
+000266a0: 6365 2066 6f72 2077 6f72 6b73 7061 6365  ce for workspace
+000266b0: 2069 6e20 776f 726b 7370 6163 6573 2069   in workspaces i
+000266c0: 6620 636f 6e66 6967 2061 6e64 2077 6f72  f config and wor
+000266d0: 6b73 7061 6365 2e67 6574 2822 6964 222c  kspace.get("id",
+000266e0: 2022 2e22 2920 3d3d 2063 6f6e 6669 672e   ".") == config.
+000266f0: 6765 7428 2269 6422 2c20 222e 2e22 2929  get("id", ".."))
+00026700: 2c20 7b7d 0a20 2020 2029 0a20 2020 2069  , {}.    ).    i
+00026710: 735f 6272 616e 6368 203d 2063 7572 7265  s_branch = curre
+00026720: 6e74 5f77 732e 6765 7428 2269 735f 6272  nt_ws.get("is_br
+00026730: 616e 6368 222c 2046 616c 7365 290a 2020  anch", False).  
+00026740: 2020 6861 735f 7365 6d76 6572 3a20 626f    has_semver: bo
+00026750: 6f6c 203d 2072 656c 6561 7365 5f63 7265  ol = release_cre
+00026760: 6174 6564 206f 7220 4661 6c73 650a 0a20  ated or False.. 
+00026770: 2020 2064 6570 6c6f 796d 656e 7420 3d20     deployment = 
+00026780: 4465 706c 6f79 6d65 6e74 2863 7572 7265  Deployment(curre
+00026790: 6e74 5f77 732c 2067 6974 5f72 656c 6561  nt_ws, git_relea
+000267a0: 7365 2c20 7462 5f63 6c69 656e 742c 2064  se, tb_client, d
+000267b0: 7279 5f72 756e 2c20 6f6e 6c79 5f63 6861  ry_run, only_cha
+000267c0: 6e67 6573 290a 0a20 2020 2069 6620 6e6f  nges)..    if no
+000267d0: 7420 776f 726b 7370 6163 655f 6d61 703a  t workspace_map:
+000267e0: 0a20 2020 2020 2020 2077 6f72 6b73 7061  .        workspa
+000267f0: 6365 5f6d 6170 203d 207b 7d0a 2020 2020  ce_map = {}.    
+00026800: 6966 206e 6f74 2077 6f72 6b73 7061 6365  if not workspace
+00026810: 5f6c 6962 5f70 6174 6873 3a0a 2020 2020  _lib_paths:.    
+00026820: 2020 2020 776f 726b 7370 6163 655f 6c69      workspace_li
+00026830: 625f 7061 7468 7320 3d20 5b5d 0a0a 2020  b_paths = []..  
+00026840: 2020 776f 726b 7370 6163 655f 6c69 625f    workspace_lib_
+00026850: 7061 7468 7320 3d20 6c69 7374 2877 6f72  paths = list(wor
+00026860: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
+00026870: 290a 2020 2020 2320 696e 636c 7564 6520  ).    # include 
+00026880: 7665 6e64 6f72 206c 6962 7320 7769 7468  vendor libs with
+00026890: 6f75 7420 6f76 6572 7269 6469 6e67 2075  out overriding u
+000268a0: 7365 7220 6f6e 6573 0a20 2020 2065 7869  ser ones.    exi
+000268b0: 7374 696e 675f 776f 726b 7370 6163 6573  sting_workspaces
+000268c0: 203d 2073 6574 2878 5b31 5d20 666f 7220   = set(x[1] for 
+000268d0: 7820 696e 2077 6f72 6b73 7061 6365 5f6c  x in workspace_l
+000268e0: 6962 5f70 6174 6873 290a 2020 2020 7665  ib_paths).    ve
+000268f0: 6e64 6f72 5f70 6174 6820 3d20 5061 7468  ndor_path = Path
+00026900: 2822 7665 6e64 6f72 2229 0a20 2020 2069  ("vendor").    i
+00026910: 6620 7665 6e64 6f72 5f70 6174 682e 6578  f vendor_path.ex
+00026920: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+00026930: 666f 7220 7820 696e 2076 656e 646f 725f  for x in vendor_
+00026940: 7061 7468 2e69 7465 7264 6972 2829 3a0a  path.iterdir():.
+00026950: 2020 2020 2020 2020 2020 2020 6966 2078              if x
+00026960: 2e69 735f 6469 7228 2920 616e 6420 782e  .is_dir() and x.
+00026970: 6e61 6d65 206e 6f74 2069 6e20 6578 6973  name not in exis
+00026980: 7469 6e67 5f77 6f72 6b73 7061 6365 733a  ting_workspaces:
+00026990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000269a0: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+000269b0: 6174 6873 2e61 7070 656e 6428 2878 2e6e  aths.append((x.n
+000269c0: 616d 652c 2078 2929 0a0a 2020 2020 6461  ame, x))..    da
+000269d0: 7461 736f 7572 6365 733a 204c 6973 745b  tasources: List[
+000269e0: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+000269f0: 3d20 6177 6169 7420 7462 5f63 6c69 656e  = await tb_clien
+00026a00: 742e 6461 7461 736f 7572 6365 7328 290a  t.datasources().
+00026a10: 2020 2020 7069 7065 733a 204c 6973 745b      pipes: List[
+00026a20: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+00026a30: 3d20 6177 6169 7420 7462 5f63 6c69 656e  = await tb_clien
+00026a40: 742e 7069 7065 7328 6465 7065 6e64 656e  t.pipes(dependen
+00026a50: 6369 6573 3d54 7275 6529 0a0a 2020 2020  cies=True)..    
+00026a60: 6578 6973 7469 6e67 5f72 6573 6f75 7263  existing_resourc
+00026a70: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
+00026a80: 5b78 5b22 6e61 6d65 225d 2066 6f72 2078  [x["name"] for x
+00026a90: 2069 6e20 6461 7461 736f 7572 6365 735d   in datasources]
+00026aa0: 202b 205b 785b 226e 616d 6522 5d20 666f   + [x["name"] fo
+00026ab0: 7220 7820 696e 2070 6970 6573 5d0a 2020  r x in pipes].  
+00026ac0: 2020 2320 7265 706c 6163 6520 776f 726b    # replace work
+00026ad0: 7370 6163 6520 6d61 7070 696e 6720 6e61  space mapping na
+00026ae0: 6d65 730a 2020 2020 666f 7220 6f6c 645f  mes.    for old_
+00026af0: 7773 2c20 6e65 775f 7773 2069 6e20 776f  ws, new_ws in wo
+00026b00: 726b 7370 6163 655f 6d61 702e 6974 656d  rkspace_map.item
+00026b10: 7328 293a 0a20 2020 2020 2020 2065 7869  s():.        exi
+00026b20: 7374 696e 675f 7265 736f 7572 6365 7320  sting_resources 
+00026b30: 3d20 5b72 652e 7375 6228 6622 5e7b 6f6c  = [re.sub(f"^{ol
+00026b40: 645f 7773 7d5c 2e22 2c20 6622 7b6e 6577  d_ws}\.", f"{new
+00026b50: 5f77 737d 2e22 2c20 7829 2066 6f72 2078  _ws}.", x) for x
+00026b60: 2069 6e20 6578 6973 7469 6e67 5f72 6573   in existing_res
+00026b70: 6f75 7263 6573 5d0a 0a20 2020 2072 656d  ources]..    rem
+00026b80: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
+00026b90: 6573 203d 205b 6765 745f 7265 6d6f 7465  es = [get_remote
+00026ba0: 5f72 6573 6f75 7263 655f 6e61 6d65 5f77  _resource_name_w
+00026bb0: 6974 686f 7574 5f76 6572 7369 6f6e 2878  ithout_version(x
+00026bc0: 2920 666f 7220 7820 696e 2065 7869 7374  ) for x in exist
+00026bd0: 696e 675f 7265 736f 7572 6365 735d 0a0a  ing_resources]..
+00026be0: 2020 2020 2320 7265 706c 6163 6520 776f      # replace wo
+00026bf0: 726b 7370 6163 6520 6d61 7070 696e 6720  rkspace mapping 
+00026c00: 6e61 6d65 730a 2020 2020 666f 7220 6f6c  names.    for ol
+00026c10: 645f 7773 2c20 6e65 775f 7773 2069 6e20  d_ws, new_ws in 
+00026c20: 776f 726b 7370 6163 655f 6d61 702e 6974  workspace_map.it
+00026c30: 656d 7328 293a 0a20 2020 2020 2020 2072  ems():.        r
+00026c40: 656d 6f74 655f 7265 736f 7572 6365 5f6e  emote_resource_n
+00026c50: 616d 6573 203d 205b 7265 2e73 7562 2866  ames = [re.sub(f
+00026c60: 225e 7b6f 6c64 5f77 737d 5c2e 222c 2066  "^{old_ws}\.", f
+00026c70: 227b 6e65 775f 7773 7d2e 222c 2078 2920  "{new_ws}.", x) 
+00026c80: 666f 7220 7820 696e 2072 656d 6f74 655f  for x in remote_
+00026c90: 7265 736f 7572 6365 5f6e 616d 6573 5d0a  resource_names].
+00026ca0: 0a20 2020 2069 6620 6e6f 7420 6669 6c65  .    if not file
+00026cb0: 6e61 6d65 733a 0a20 2020 2020 2020 2066  names:.        f
+00026cc0: 696c 656e 616d 6573 203d 2067 6574 5f70  ilenames = get_p
+00026cd0: 726f 6a65 6374 5f66 696c 656e 616d 6573  roject_filenames
+00026ce0: 2866 6f6c 6465 7229 0a0a 2020 2020 2320  (folder)..    # 
+00026cf0: 6765 7420 7468 6520 6c69 7374 206f 6620  get the list of 
+00026d00: 6368 616e 6765 730a 2020 2020 6368 616e  changes.    chan
+00026d10: 6765 642c 2064 656c 6574 6564 203d 2061  ged, deleted = a
+00026d20: 7761 6974 2064 6570 6c6f 796d 656e 742e  wait deployment.
+00026d30: 6465 7465 6374 5f63 6861 6e67 6573 2866  detect_changes(f
+00026d40: 696c 656e 616d 6573 2c20 6f6e 6c79 5f63  ilenames, only_c
+00026d50: 6861 6e67 6573 2c20 636f 6e66 6967 2c20  hanges, config, 
+00026d60: 7573 655f 6d61 696e 290a 0a20 2020 2064  use_main)..    d
+00026d70: 6570 6c6f 796d 656e 742e 6368 6563 6b5f  eployment.check_
+00026d80: 6368 616e 6765 7328 6368 616e 6765 642c  changes(changed,
+00026d90: 2070 6970 6573 2c20 7265 6c65 6173 655f   pipes, release_
+00026da0: 6372 6561 7465 6429 0a0a 2020 2020 6465  created)..    de
+00026db0: 706c 6f79 6d65 6e74 2e70 7265 7061 7269  ployment.prepari
+00026dc0: 6e67 5f72 656c 6561 7365 2829 0a0a 2020  ng_release()..  
+00026dd0: 2020 2320 6275 696c 6420 6772 6170 6820    # build graph 
+00026de0: 746f 2067 6574 206e 6577 2076 6572 7369  to get new versi
+00026df0: 6f6e 7320 666f 7220 616c 6c20 7468 6520  ons for all the 
+00026e00: 6669 6c65 7320 696e 766f 6c76 6564 2069  files involved i
+00026e10: 6e20 7468 6520 7175 6572 790a 2020 2020  n the query.    
+00026e20: 2320 6465 7065 6e64 656e 6369 6573 206e  # dependencies n
+00026e30: 6565 6420 746f 2062 6520 7072 6f63 6573  eed to be proces
+00026e40: 7365 6420 616c 7761 7973 2074 6f20 6765  sed always to ge
+00026e50: 7420 7468 6520 7665 7273 696f 6e73 0a20  t the versions. 
+00026e60: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
+00026e70: 6772 6170 6820 3d20 6177 6169 7420 6275  graph = await bu
+00026e80: 696c 645f 6772 6170 6828 0a20 2020 2020  ild_graph(.     
+00026e90: 2020 2066 696c 656e 616d 6573 2c0a 2020     filenames,.  
+00026ea0: 2020 2020 2020 7462 5f63 6c69 656e 742c        tb_client,
+00026eb0: 0a20 2020 2020 2020 2064 6972 5f70 6174  .        dir_pat
+00026ec0: 683d 666f 6c64 6572 2c0a 2020 2020 2020  h=folder,.      
+00026ed0: 2020 7072 6f63 6573 735f 6465 7065 6e64    process_depend
+00026ee0: 656e 6369 6573 3d54 7275 652c 0a20 2020  encies=True,.   
+00026ef0: 2020 2020 2077 6f72 6b73 7061 6365 5f6d       workspace_m
+00026f00: 6170 3d77 6f72 6b73 7061 6365 5f6d 6170  ap=workspace_map
+00026f10: 2c0a 2020 2020 2020 2020 736b 6970 5f63  ,.        skip_c
+00026f20: 6f6e 6e65 6374 6f72 733d 5472 7565 2c0a  onnectors=True,.
+00026f30: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
+00026f40: 655f 6c69 625f 7061 7468 733d 776f 726b  e_lib_paths=work
+00026f50: 7370 6163 655f 6c69 625f 7061 7468 732c  space_lib_paths,
+00026f60: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
+00026f70: 5f77 733d 6375 7272 656e 745f 7773 2c0a  _ws=current_ws,.
+00026f80: 2020 2020 2020 2020 6368 616e 6765 643d          changed=
+00026f90: 6368 616e 6765 642c 0a20 2020 2020 2020  changed,.       
+00026fa0: 206f 6e6c 795f 6368 616e 6765 733d 6f6e   only_changes=on
+00026fb0: 6c79 5f63 6861 6e67 6573 206f 7220 2864  ly_changes or (d
+00026fc0: 6570 6c6f 796d 656e 742e 6973 5f67 6974  eployment.is_git
+00026fd0: 5f72 656c 6561 7365 2061 6e64 2068 6173  _release and has
+00026fe0: 5f73 656d 7665 7229 2c0a 2020 2020 2020  _semver),.      
+00026ff0: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
+00027000: 6d3d 666f 726b 5f64 6f77 6e73 7472 6561  m=fork_downstrea
+00027010: 6d2c 0a20 2020 2020 2020 2069 735f 696e  m,.        is_in
+00027020: 7465 726e 616c 3d69 735f 696e 7465 726e  ternal=is_intern
+00027030: 616c 2c0a 2020 2020 290a 0a20 2020 2023  al,.    )..    #
+00027040: 2075 7064 6174 6520 6578 6973 7469 6e67   update existing
+00027050: 2076 6572 7369 6f6e 730a 2020 2020 6966   versions.    if
+00027060: 206e 6f74 206e 6f5f 7665 7273 696f 6e73   not no_versions
+00027070: 3a0a 2020 2020 2020 2020 7265 736f 7572  :.        resour
+00027080: 6365 5f76 6572 7369 6f6e 7320 3d20 6765  ce_versions = ge
+00027090: 745f 7265 736f 7572 6365 5f76 6572 7369  t_resource_versi
+000270a0: 6f6e 7328 6578 6973 7469 6e67 5f72 6573  ons(existing_res
+000270b0: 6f75 7263 6573 290a 2020 2020 2020 2020  ources).        
+000270c0: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+000270d0: 655f 7665 7273 696f 6e73 203d 2072 6573  e_versions = res
+000270e0: 6f75 7263 655f 7665 7273 696f 6e73 2e63  ource_versions.c
+000270f0: 6f70 7928 290a 0a20 2020 2020 2020 2066  opy()..        f
+00027100: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
+00027110: 656e 6369 6573 5f67 7261 7068 2e74 6f5f  encies_graph.to_
+00027120: 7275 6e2e 7661 6c75 6573 2829 3a0a 2020  run.values():.  
+00027130: 2020 2020 2020 2020 2020 6473 203d 2064            ds = d
+00027140: 6570 5b22 7265 736f 7572 6365 5f6e 616d  ep["resource_nam
+00027150: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+00027160: 6966 2064 6570 5b22 7665 7273 696f 6e22  if dep["version"
+00027170: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+00027180: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00027190: 6174 6573 745f 6461 7461 736f 7572 6365  atest_datasource
+000271a0: 5f76 6572 7369 6f6e 735b 6473 5d20 3d20  _versions[ds] = 
+000271b0: 6465 705b 2276 6572 7369 6f6e 225d 0a20  dep["version"]. 
+000271c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000271d0: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
+000271e0: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
+000271f0: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00027200: 655f 7665 7273 696f 6e73 203d 207b 7d0a  e_versions = {}.
+00027210: 0a20 2020 2023 2049 6620 7765 2068 6176  .    # If we hav
+00027220: 6520 6461 7461 736f 7572 6365 7320 7573  e datasources us
+00027230: 696e 6720 5645 5253 494f 4e2c 206c 6574  ing VERSION, let
+00027240: 2773 2074 7279 2074 6f20 6765 7420 7468  's try to get th
+00027250: 6520 6c61 7465 7374 2076 6572 7369 6f6e  e latest version
+00027260: 0a20 2020 2064 6570 656e 6465 6e63 6965  .    dependencie
+00027270: 735f 6772 6170 6820 3d20 6177 6169 7420  s_graph = await 
+00027280: 6275 696c 645f 6772 6170 6828 0a20 2020  build_graph(.   
+00027290: 2020 2020 2066 696c 656e 616d 6573 2c0a       filenames,.
+000272a0: 2020 2020 2020 2020 7462 5f63 6c69 656e          tb_clien
+000272b0: 742c 0a20 2020 2020 2020 2064 6972 5f70  t,.        dir_p
+000272c0: 6174 683d 666f 6c64 6572 2c0a 2020 2020  ath=folder,.    
+000272d0: 2020 2020 7265 736f 7572 6365 5f76 6572      resource_ver
+000272e0: 7369 6f6e 733d 6c61 7465 7374 5f64 6174  sions=latest_dat
+000272f0: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
+00027300: 2c0a 2020 2020 2020 2020 776f 726b 7370  ,.        worksp
+00027310: 6163 655f 6d61 703d 776f 726b 7370 6163  ace_map=workspac
+00027320: 655f 6d61 702c 0a20 2020 2020 2020 2070  e_map,.        p
+00027330: 726f 6365 7373 5f64 6570 656e 6465 6e63  rocess_dependenc
+00027340: 6965 733d 7075 7368 5f64 6570 732c 0a20  ies=push_deps,. 
+00027350: 2020 2020 2020 2076 6572 626f 7365 3d76         verbose=v
+00027360: 6572 626f 7365 2c0a 2020 2020 2020 2020  erbose,.        
+00027370: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+00027380: 7468 733d 776f 726b 7370 6163 655f 6c69  ths=workspace_li
+00027390: 625f 7061 7468 732c 0a20 2020 2020 2020  b_paths,.       
+000273a0: 2063 7572 7265 6e74 5f77 733d 6375 7272   current_ws=curr
+000273b0: 656e 745f 7773 2c0a 2020 2020 2020 2020  ent_ws,.        
+000273c0: 6368 616e 6765 643d 6368 616e 6765 642c  changed=changed,
+000273d0: 0a20 2020 2020 2020 206f 6e6c 795f 6368  .        only_ch
+000273e0: 616e 6765 733d 6f6e 6c79 5f63 6861 6e67  anges=only_chang
+000273f0: 6573 206f 7220 2864 6570 6c6f 796d 656e  es or (deploymen
+00027400: 742e 6973 5f67 6974 5f72 656c 6561 7365  t.is_git_release
+00027410: 2061 6e64 2068 6173 5f73 656d 7665 7229   and has_semver)
+00027420: 2c0a 2020 2020 2020 2020 666f 726b 5f64  ,.        fork_d
+00027430: 6f77 6e73 7472 6561 6d3d 666f 726b 5f64  ownstream=fork_d
+00027440: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+00027450: 2020 2069 735f 696e 7465 726e 616c 3d69     is_internal=i
+00027460: 735f 696e 7465 726e 616c 2c0a 2020 2020  s_internal,.    
+00027470: 290a 0a20 2020 2069 6620 6465 6275 673a  )..    if debug:
+00027480: 0a20 2020 2020 2020 2070 702e 7070 7269  .        pp.ppri
+00027490: 6e74 2864 6570 656e 6465 6e63 6965 735f  nt(dependencies_
+000274a0: 6772 6170 682e 746f 5f72 756e 290a 0a20  graph.to_run).. 
+000274b0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+000274c0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+000274d0: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
+000274e0: 722e 696e 666f 5f62 7569 6c64 696e 675f  r.info_building_
+000274f0: 6465 7065 6e64 656e 6369 6573 2829 290a  dependencies()).
+00027500: 0a20 2020 2064 6570 6c6f 796d 656e 742e  .    deployment.
+00027510: 7072 6570 6172 696e 675f 6465 7065 6e64  preparing_depend
+00027520: 656e 6369 6573 2863 6861 6e67 6564 2c20  encies(changed, 
+00027530: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
+00027540: 7068 2e64 6570 5f6d 6170 2c20 6c61 7465  ph.dep_map, late
+00027550: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+00027560: 7273 696f 6e73 290a 0a20 2020 2064 6566  rsions)..    def
+00027570: 2073 686f 756c 645f 7075 7368 5f66 696c   should_push_fil
+00027580: 6528 0a20 2020 2020 2020 206e 616d 653a  e(.        name:
+00027590: 2073 7472 2c0a 2020 2020 2020 2020 7265   str,.        re
+000275a0: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
+000275b0: 6d65 733a 204c 6973 745b 7374 725d 2c0a  mes: List[str],.
+000275c0: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
+000275d0: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
+000275e0: 6e73 3a20 4469 6374 5b73 7472 2c20 416e  ns: Dict[str, An
+000275f0: 795d 2c0a 2020 2020 2020 2020 666f 7263  y],.        forc
+00027600: 653a 2062 6f6f 6c2c 0a20 2020 2020 2020  e: bool,.       
+00027610: 2072 756e 5f74 6573 7473 3a20 626f 6f6c   run_tests: bool
+00027620: 2c0a 2020 2020 2920 2d3e 2062 6f6f 6c3a  ,.    ) -> bool:
+00027630: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00027640: 2020 2020 2046 756e 6374 696f 6e20 746f       Function to
+00027650: 206b 6e6f 7720 6966 2077 6520 6e65 6564   know if we need
+00027660: 2074 6f20 7275 6e20 6120 6669 6c65 206f   to run a file o
+00027670: 7220 6e6f 740a 2020 2020 2020 2020 2222  r not.        ""
+00027680: 220a 2020 2020 2020 2020 6966 206e 616d  ".        if nam
+00027690: 6520 6e6f 7420 696e 2072 656d 6f74 655f  e not in remote_
+000276a0: 7265 736f 7572 6365 5f6e 616d 6573 3a0a  resource_names:.
+000276b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000276c0: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
+000276d0: 2320 5768 656e 2077 6520 6e65 6564 2074  # When we need t
+000276e0: 6f20 7472 7920 746f 2070 7573 6820 6120  o try to push a 
+000276f0: 6669 6c65 2077 6865 6e20 6974 2064 6f65  file when it doe
+00027700: 736e 2774 2065 7869 7374 2061 6e64 2074  sn't exist and t
+00027710: 6865 2076 6572 7369 6f6e 2069 7320 6469  he version is di
+00027720: 6666 6572 656e 7420 7468 6174 2074 6865  fferent that the
+00027730: 2065 7869 7374 696e 6720 6f6e 650a 2020   existing one.  
+00027740: 2020 2020 2020 7265 736f 7572 6365 5f66        resource_f
+00027750: 756c 6c5f 6e61 6d65 203d 2028 0a20 2020  ull_name = (.   
+00027760: 2020 2020 2020 2020 2066 227b 6e61 6d65           f"{name
+00027770: 7d5f 5f76 7b6c 6174 6573 745f 6461 7461  }__v{latest_data
+00027780: 736f 7572 6365 5f76 6572 7369 6f6e 732e  source_versions.
+00027790: 6765 7428 6e61 6d65 297d 2220 6966 206e  get(name)}" if n
+000277a0: 616d 6520 696e 206c 6174 6573 745f 6461  ame in latest_da
+000277b0: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
+000277c0: 7320 656c 7365 206e 616d 650a 2020 2020  s else name.    
+000277d0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+000277e0: 2072 6573 6f75 7263 655f 6675 6c6c 5f6e   resource_full_n
+000277f0: 616d 6520 6e6f 7420 696e 2065 7869 7374  ame not in exist
+00027800: 696e 675f 7265 736f 7572 6365 733a 0a20  ing_resources:. 
+00027810: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00027820: 6e20 5472 7565 0a20 2020 2020 2020 2069  n True.        i
+00027830: 6620 666f 7263 6520 6f72 2072 756e 5f74  f force or run_t
+00027840: 6573 7473 3a0a 2020 2020 2020 2020 2020  ests:.          
+00027850: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
+00027860: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00027870: 7365 0a0a 2020 2020 6173 796e 6320 6465  se..    async de
+00027880: 6620 7075 7368 280a 2020 2020 2020 2020  f push(.        
+00027890: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+000278a0: 2020 2074 6f5f 7275 6e3a 2044 6963 745b     to_run: Dict[
+000278b0: 7374 722c 2044 6963 745b 7374 722c 2041  str, Dict[str, A
+000278c0: 6e79 5d5d 2c0a 2020 2020 2020 2020 7265  ny]],.        re
+000278d0: 736f 7572 6365 5f76 6572 7369 6f6e 733a  source_versions:
+000278e0: 2044 6963 745b 7374 722c 2041 6e79 5d2c   Dict[str, Any],
+000278f0: 0a20 2020 2020 2020 206c 6174 6573 745f  .        latest_
+00027900: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
+00027910: 6f6e 733a 2044 6963 745b 7374 722c 2041  ons: Dict[str, A
+00027920: 6e79 5d2c 0a20 2020 2020 2020 2064 7279  ny],.        dry
+00027930: 5f72 756e 3a20 626f 6f6c 2c0a 2020 2020  _run: bool,.    
+00027940: 2020 2020 666f 726b 5f64 6f77 6e73 7472      fork_downstr
+00027950: 6561 6d3a 204f 7074 696f 6e61 6c5b 626f  eam: Optional[bo
+00027960: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+00027970: 2020 2020 2066 6f72 6b3a 204f 7074 696f       fork: Optio
+00027980: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00027990: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+000279a0: 2020 6966 206e 616d 6520 696e 2074 6f5f    if name in to_
+000279b0: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
+000279c0: 2069 6620 6e6f 7420 6472 795f 7275 6e3a   if not dry_run:
+000279d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000279e0: 2069 6620 7368 6f75 6c64 5f70 7573 685f   if should_push_
+000279f0: 6669 6c65 286e 616d 652c 2072 656d 6f74  file(name, remot
+00027a00: 655f 7265 736f 7572 6365 5f6e 616d 6573  e_resource_names
+00027a10: 2c20 6c61 7465 7374 5f64 6174 6173 6f75  , latest_datasou
+00027a20: 7263 655f 7665 7273 696f 6e73 2c20 666f  rce_versions, fo
+00027a30: 7263 652c 2072 756e 5f74 6573 7473 293a  rce, run_tests):
+00027a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027a50: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
+00027a60: 2069 6e20 7265 736f 7572 6365 5f76 6572   in resource_ver
+00027a70: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
+00027a80: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00027a90: 6572 7369 6f6e 203d 2022 220a 2020 2020  ersion = "".    
+00027aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ab0: 2020 2020 6966 206e 616d 6520 696e 206c      if name in l
+00027ac0: 6174 6573 745f 6461 7461 736f 7572 6365  atest_datasource
+00027ad0: 5f76 6572 7369 6f6e 733a 0a20 2020 2020  _versions:.     
+00027ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027af0: 2020 2020 2020 2076 6572 7369 6f6e 203d         version =
+00027b00: 2066 2228 767b 6c61 7465 7374 5f64 6174   f"(v{latest_dat
+00027b10: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
+00027b20: 5b6e 616d 655d 7d29 220a 2020 2020 2020  [name]})".      
+00027b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b40: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
+00027b50: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+00027b60: 6f5f 7072 6f63 6573 7369 6e67 5f6e 6577  o_processing_new
+00027b70: 5f72 6573 6f75 7263 6528 6e61 6d65 3d6e  _resource(name=n
+00027b80: 616d 652c 2076 6572 7369 6f6e 3d76 6572  ame, version=ver
+00027b90: 7369 6f6e 2929 0a20 2020 2020 2020 2020  sion)).         
+00027ba0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00027bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027bc0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00027bd0: 6368 6f28 0a20 2020 2020 2020 2020 2020  cho(.           
+00027be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027bf0: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+00027c00: 2e69 6e66 6f5f 7072 6f63 6573 7369 6e67  .info_processing
+00027c10: 5f72 6573 6f75 7263 6528 0a20 2020 2020  _resource(.     
+00027c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c30: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00027c40: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00027c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c60: 2020 2020 2020 7665 7273 696f 6e3d 6c61        version=la
+00027c70: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
+00027c80: 7665 7273 696f 6e73 5b6e 616d 655d 2c0a  versions[name],.
+00027c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027cb0: 6c61 7465 7374 5f76 6572 7369 6f6e 3d72  latest_version=r
+00027cc0: 6573 6f75 7263 655f 7665 7273 696f 6e73  esource_versions
+00027cd0: 2e67 6574 286e 616d 6529 2c0a 2020 2020  .get(name),.    
+00027ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027cf0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00027d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d10: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00027d20: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00027d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d40: 2020 2020 2061 7761 6974 2065 7865 635f       await exec_
+00027d50: 6669 6c65 280a 2020 2020 2020 2020 2020  file(.          
+00027d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d70: 2020 636f 6e66 6967 2c0a 2020 2020 2020    config,.      
+00027d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d90: 2020 2020 2020 746f 5f72 756e 5b6e 616d        to_run[nam
+00027da0: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+00027db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027dc0: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
+00027dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027de0: 2020 2020 2020 2066 6f72 6365 2c0a 2020         force,.  
+00027df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e00: 2020 2020 2020 2020 2020 6368 6563 6b2c            check,
+00027e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027e20: 2020 2020 2020 2020 2020 2020 2064 6562               deb
+00027e30: 7567 2061 6e64 2076 6572 626f 7365 2c0a  ug and verbose,.
+00027e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e50: 2020 2020 2020 2020 2020 2020 706f 7075              popu
+00027e60: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
+00027e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e80: 2020 706f 7075 6c61 7465 5f73 7562 7365    populate_subse
+00027e90: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00027ea0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00027eb0: 6f70 756c 6174 655f 636f 6e64 6974 696f  opulate_conditio
+00027ec0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00027ed0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00027ee0: 6e6c 696e 6b5f 6f6e 5f70 6f70 756c 6174  nlink_on_populat
+00027ef0: 655f 6572 726f 722c 0a20 2020 2020 2020  e_error,.       
+00027f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f10: 2020 2020 2077 6169 742c 0a20 2020 2020       wait,.     
+00027f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f30: 2020 2020 2020 2075 7365 725f 746f 6b65         user_toke
+00027f40: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00027f50: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00027f60: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
+00027f70: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00027f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f90: 6967 6e6f 7265 5f73 716c 5f65 7272 6f72  ignore_sql_error
+00027fa0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00027fb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00027fc0: 6b69 705f 636f 6e66 6972 6d61 7469 6f6e  kip_confirmation
+00027fd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027fe0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+00027ff0: 6c79 5f72 6573 706f 6e73 655f 7469 6d65  ly_response_time
+00028000: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00028010: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00028020: 756e 5f74 6573 7473 2c0a 2020 2020 2020  un_tests,.      
+00028030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028040: 2020 2020 2020 6173 5f73 7461 6e64 6172        as_standar
+00028050: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00028060: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028070: 6573 7473 5f74 6f5f 7275 6e2c 0a20 2020  ests_to_run,.   
+00028080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028090: 2020 2020 2020 2020 2074 6573 7473 5f73           tests_s
+000280a0: 616d 706c 655f 6279 5f70 6172 616d 732c  ample_by_params,
+000280b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000280c0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+000280d0: 7473 5f66 696c 7465 725f 6279 2c0a 2020  ts_filter_by,.  
+000280e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000280f0: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
+00028100: 6661 696c 6661 7374 2c0a 2020 2020 2020  failfast,.      
+00028110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028120: 2020 2020 2020 7465 7374 735f 6967 6e6f        tests_igno
+00028130: 7265 5f6f 7264 6572 2c0a 2020 2020 2020  re_order,.      
+00028140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028150: 2020 2020 2020 7465 7374 735f 7661 6c69        tests_vali
+00028160: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
+00028170: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
+00028180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028190: 2020 7465 7374 735f 6368 6563 6b5f 7265    tests_check_re
+000281a0: 7175 6573 7473 5f66 726f 6d5f 6272 616e  quests_from_bran
+000281b0: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
+000281c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000281d0: 6375 7272 656e 745f 7773 2c0a 2020 2020  current_ws,.    
 000281e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028210: 2063 6c69 636b 2e65 6368 6f28 0a20 2020   click.echo(.   
-00028220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028230: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
-00028240: 6b4d 616e 6167 6572 2e69 6e66 6f5f 7072  kManager.info_pr
-00028250: 6f63 6573 7369 6e67 5f72 6573 6f75 7263  ocessing_resourc
-00028260: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000281f0: 2020 2020 2020 2020 666f 726b 5f64 6f77          fork_dow
+00028200: 6e73 7472 6561 6d2c 0a20 2020 2020 2020  nstream,.       
+00028210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028220: 2020 2020 2066 6f72 6b2c 0a20 2020 2020       fork,.     
+00028230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028240: 2020 2020 2020 2067 6974 5f72 656c 6561         git_relea
+00028250: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00028260: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
 00028270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028280: 2020 206e 616d 653d 6e61 6d65 2c0a 2020     name=name,.  
-00028290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000282a0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-000282b0: 7273 696f 6e3d 6c61 7465 7374 5f64 6174  rsion=latest_dat
-000282c0: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
-000282d0: 5b6e 616d 655d 2c0a 2020 2020 2020 2020  [name],.        
-000282e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000282f0: 2020 2020 2020 2020 6c61 7465 7374 5f76          latest_v
-00028300: 6572 7369 6f6e 3d72 6573 6f75 7263 655f  ersion=resource_
-00028310: 7665 7273 696f 6e73 2e67 6574 286e 616d  versions.get(nam
-00028320: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00028280: 2020 2020 2020 6966 206e 6f74 2072 756e        if not run
+00028290: 5f74 6573 7473 3a0a 2020 2020 2020 2020  _tests:.        
+000282a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282b0: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
+000282c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282e0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+000282f0: 7375 6363 6573 735f 6372 6561 7465 280a  success_create(.
+00028300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028320: 2020 2020 6e61 6d65 3d28 0a20 2020 2020      name=(.     
 00028330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028340: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028350: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00028340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028350: 2020 206e 616d 650a 2020 2020 2020 2020     name.        
 00028360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028370: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00028380: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00028390: 6974 2065 7865 635f 6669 6c65 280a 2020  it exec_file(.  
-000283a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283b0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-000283c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000283d0: 2020 2020 2020 2020 2020 2020 2020 746f                to
-000283e0: 5f72 756e 5b6e 616d 655d 2c0a 2020 2020  _run[name],.    
-000283f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028400: 2020 2020 2020 2020 7462 5f63 6c69 656e          tb_clien
-00028410: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00028420: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00028430: 6f72 6365 2c0a 2020 2020 2020 2020 2020  orce,.          
+00028370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028380: 6966 2074 6f5f 7275 6e5b 6e61 6d65 5d5b  if to_run[name][
+00028390: 2276 6572 7369 6f6e 225d 2069 7320 4e6f  "version"] is No
+000283a0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+000283b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000283c0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+000283d0: 6627 7b6e 616d 657d 5f5f 767b 746f 5f72  f'{name}__v{to_r
+000283e0: 756e 5b6e 616d 655d 5b22 7665 7273 696f  un[name]["versio
+000283f0: 6e22 5d7d 270a 2020 2020 2020 2020 2020  n"]}'.          
+00028400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028410: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00028420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028430: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
 00028440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028450: 2020 6368 6563 6b2c 0a20 2020 2020 2020    check,.       
+00028450: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
 00028460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028470: 2020 2020 2064 6562 7567 2061 6e64 2076       debug and v
-00028480: 6572 626f 7365 2c0a 2020 2020 2020 2020  erbose,.        
-00028490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284a0: 2020 2020 706f 7075 6c61 7465 2c0a 2020      populate,.  
-000284b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284c0: 2020 2020 2020 2020 2020 706f 7075 6c61            popula
-000284d0: 7465 5f73 7562 7365 742c 0a20 2020 2020  te_subset,.     
+00028470: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00028480: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00028490: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000284a0: 7863 6570 7469 6f6e 203d 2046 6565 6462  xception = Feedb
+000284b0: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+000284c0: 5f70 7573 685f 6669 6c65 5f65 7863 6570  _push_file_excep
+000284d0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
 000284e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284f0: 2020 2020 2020 2070 6f70 756c 6174 655f         populate_
-00028500: 636f 6e64 6974 696f 6e2c 0a20 2020 2020  condition,.     
-00028510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028520: 2020 2020 2020 2075 6e6c 696e 6b5f 6f6e         unlink_on
-00028530: 5f70 6f70 756c 6174 655f 6572 726f 722c  _populate_error,
-00028540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028550: 2020 2020 2020 2020 2020 2020 2077 6169               wai
-00028560: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00028570: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00028580: 7365 725f 746f 6b65 6e2c 0a20 2020 2020  ser_token,.     
-00028590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285a0: 2020 2020 2020 206f 7665 7272 6964 655f         override_
-000285b0: 6461 7461 736f 7572 6365 2c0a 2020 2020  datasource,.    
-000285c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285d0: 2020 2020 2020 2020 6967 6e6f 7265 5f73          ignore_s
-000285e0: 716c 5f65 7272 6f72 732c 0a20 2020 2020  ql_errors,.     
+000284f0: 2020 6669 6c65 6e61 6d65 3d74 6f5f 7275    filename=to_ru
+00028500: 6e5b 6e61 6d65 5d5b 2266 696c 656e 616d  n[name]["filenam
+00028510: 6522 5d2c 2065 7272 6f72 3d65 0a20 2020  e"], error=e.   
+00028520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028530: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00028540: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00028550: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
+00028560: 4578 6365 7074 696f 6e28 6578 6365 7074  Exception(except
+00028570: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+00028580: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00028590: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000285a0: 6620 7261 6973 655f 6f6e 5f65 7869 7374  f raise_on_exist
+000285b0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000285c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000285d0: 2041 6c72 6561 6479 4578 6973 7473 4578   AlreadyExistsEx
+000285e0: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
 000285f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028600: 2020 2020 2020 2073 6b69 705f 636f 6e66         skip_conf
-00028610: 6972 6d61 7469 6f6e 2c0a 2020 2020 2020  irmation,.      
-00028620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028630: 2020 2020 2020 6f6e 6c79 5f72 6573 706f        only_respo
-00028640: 6e73 655f 7469 6d65 732c 0a20 2020 2020  nse_times,.     
-00028650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028660: 2020 2020 2020 2074 696d 656f 7574 2c0a         timeout,.
-00028670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028680: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-00028690: 7465 7374 732c 0a20 2020 2020 2020 2020  tests,.         
-000286a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286b0: 2020 2061 735f 7374 616e 6461 7264 2c0a     as_standard,.
-000286c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286d0: 2020 2020 2020 2020 2020 2020 7465 7374              test
-000286e0: 735f 746f 5f72 756e 2c0a 2020 2020 2020  s_to_run,.      
-000286f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028700: 2020 2020 2020 7465 7374 735f 7361 6d70        tests_samp
-00028710: 6c65 5f62 795f 7061 7261 6d73 2c0a 2020  le_by_params,.  
+00028600: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
+00028610: 6167 6572 2e77 6172 6e69 6e67 5f6e 616d  ager.warning_nam
+00028620: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
+00028630: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00028640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028650: 2020 6e61 6d65 3d6e 616d 6520 6966 2074    name=name if t
+00028660: 6f5f 7275 6e5b 6e61 6d65 5d5b 2276 6572  o_run[name]["ver
+00028670: 7369 6f6e 225d 2069 7320 4e6f 6e65 2065  sion"] is None e
+00028680: 6c73 6520 6627 7b6e 616d 657d 5f5f 767b  lse f'{name}__v{
+00028690: 746f 5f72 756e 5b6e 616d 655d 5b22 7665  to_run[name]["ve
+000286a0: 7273 696f 6e22 5d7d 270a 2020 2020 2020  rsion"]}'.      
+000286b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000286c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000286d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000286e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000286f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00028700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028710: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
 00028720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028730: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
-00028740: 6669 6c74 6572 5f62 792c 0a20 2020 2020  filter_by,.     
-00028750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028760: 2020 2020 2020 2074 6573 7473 5f66 6169         tests_fai
-00028770: 6c66 6173 742c 0a20 2020 2020 2020 2020  lfast,.         
-00028780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028790: 2020 2074 6573 7473 5f69 676e 6f72 655f     tests_ignore_
-000287a0: 6f72 6465 722c 0a20 2020 2020 2020 2020  order,.         
-000287b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000287c0: 2020 2074 6573 7473 5f76 616c 6964 6174     tests_validat
-000287d0: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
-000287e0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-000287f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028800: 6573 7473 5f63 6865 636b 5f72 6571 7565  ests_check_reque
-00028810: 7374 735f 6672 6f6d 5f62 7261 6e63 682c  sts_from_branch,
-00028820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028830: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00028840: 7265 6e74 5f77 732c 0a20 2020 2020 2020  rent_ws,.       
-00028850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028860: 2020 2020 2066 6f72 6b5f 646f 776e 7374       fork_downst
-00028870: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
-00028880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028890: 2020 666f 726b 2c0a 2020 2020 2020 2020    fork,.        
-000288a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288b0: 2020 2020 6769 745f 7265 6c65 6173 652c      git_release,
-000288c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000288d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000288e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288f0: 2020 2069 6620 6e6f 7420 7275 6e5f 7465     if not run_te
-00028900: 7374 733a 0a20 2020 2020 2020 2020 2020  sts:.           
-00028910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028920: 2063 6c69 636b 2e65 6368 6f28 0a20 2020   click.echo(.   
-00028930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028940: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
-00028950: 6462 6163 6b4d 616e 6167 6572 2e73 7563  dbackManager.suc
-00028960: 6365 7373 5f63 7265 6174 6528 0a20 2020  cess_create(.   
-00028970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028990: 206e 616d 653d 280a 2020 2020 2020 2020   name=(.        
-000289a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289c0: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-000289d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000289f0: 746f 5f72 756e 5b6e 616d 655d 5b22 7665  to_run[name]["ve
-00028a00: 7273 696f 6e22 5d20 6973 204e 6f6e 650a  rsion"] is None.
+00028730: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
+00028740: 6261 636b 4d61 6e61 6765 722e 7761 726e  backManager.warn
+00028750: 696e 675f 6e61 6d65 5f61 6c72 6561 6479  ing_name_already
+00028760: 5f65 7869 7374 7328 0a20 2020 2020 2020  _exists(.       
+00028770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028780: 2020 2020 2020 2020 206e 616d 653d 6e61           name=na
+00028790: 6d65 2069 6620 746f 5f72 756e 5b6e 616d  me if to_run[nam
+000287a0: 655d 5b22 7665 7273 696f 6e22 5d20 6973  e]["version"] is
+000287b0: 204e 6f6e 6520 656c 7365 2066 277b 6e61   None else f'{na
+000287c0: 6d65 7d5f 5f76 7b74 6f5f 7275 6e5b 6e61  me}__v{to_run[na
+000287d0: 6d65 5d5b 2276 6572 7369 6f6e 225d 7d27  me]["version"]}'
+000287e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000287f0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00028800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028810: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00028820: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00028830: 2020 2020 2020 2020 2020 2069 6620 7368             if sh
+00028840: 6f75 6c64 5f70 7573 685f 6669 6c65 286e  ould_push_file(n
+00028850: 616d 652c 2072 656d 6f74 655f 7265 736f  ame, remote_reso
+00028860: 7572 6365 5f6e 616d 6573 2c20 6c61 7465  urce_names, late
+00028870: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+00028880: 7273 696f 6e73 2c20 666f 7263 652c 2072  rsions, force, r
+00028890: 756e 5f74 6573 7473 293a 0a20 2020 2020  un_tests):.     
+000288a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000288b0: 6620 6e61 6d65 206e 6f74 2069 6e20 7265  f name not in re
+000288c0: 736f 7572 6365 5f76 6572 7369 6f6e 733a  source_versions:
+000288d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000288e0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+000288f0: 203d 2022 220a 2020 2020 2020 2020 2020   = "".          
+00028900: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00028910: 206e 616d 6520 696e 206c 6174 6573 745f   name in latest_
+00028920: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
+00028930: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00028940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028950: 2076 6572 7369 6f6e 203d 2066 2228 767b   version = f"(v{
+00028960: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00028970: 655f 7665 7273 696f 6e73 5b6e 616d 655d  e_versions[name]
+00028980: 7d29 220a 2020 2020 2020 2020 2020 2020  })".            
+00028990: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+000289a0: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
+000289b0: 616e 6167 6572 2e69 6e66 6f5f 6472 795f  anager.info_dry_
+000289c0: 7072 6f63 6573 7369 6e67 5f6e 6577 5f72  processing_new_r
+000289d0: 6573 6f75 7263 6528 6e61 6d65 3d6e 616d  esource(name=nam
+000289e0: 652c 2076 6572 7369 6f6e 3d76 6572 7369  e, version=versi
+000289f0: 6f6e 2929 0a20 2020 2020 2020 2020 2020  on)).           
+00028a00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 00028a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a30: 2020 2020 2020 2020 656c 7365 2066 277b          else f'{
-00028a40: 6e61 6d65 7d5f 5f76 7b74 6f5f 7275 6e5b  name}__v{to_run[
-00028a50: 6e61 6d65 5d5b 2276 6572 7369 6f6e 225d  name]["version"]
-00028a60: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00028a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00028a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028aa0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00028a20: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+00028a30: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+00028a40: 2020 2020 2020 2020 2020 2020 2020 2046                 F
+00028a50: 6565 6462 6163 6b4d 616e 6167 6572 2e69  eedbackManager.i
+00028a60: 6e66 6f5f 6472 795f 7072 6f63 6573 7369  nfo_dry_processi
+00028a70: 6e67 5f72 6573 6f75 7263 6528 0a20 2020  ng_resource(.   
+00028a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a90: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00028aa0: 653d 6e61 6d65 2c0a 2020 2020 2020 2020  e=name,.        
 00028ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ac0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00028ad0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00028ae0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00028af0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00028b00: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00028b10: 7074 696f 6e20 3d20 4665 6564 6261 636b  ption = Feedback
-00028b20: 4d61 6e61 6765 722e 6572 726f 725f 7075  Manager.error_pu
-00028b30: 7368 5f66 696c 655f 6578 6365 7074 696f  sh_file_exceptio
-00028b40: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00028b50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00028b60: 696c 656e 616d 653d 746f 5f72 756e 5b6e  ilename=to_run[n
-00028b70: 616d 655d 5b22 6669 6c65 6e61 6d65 225d  ame]["filename"]
-00028b80: 2c20 6572 726f 723d 650a 2020 2020 2020  , error=e.      
+00028ac0: 2020 2020 2020 2020 7665 7273 696f 6e3d          version=
+00028ad0: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00028ae0: 655f 7665 7273 696f 6e73 5b6e 616d 655d  e_versions[name]
+00028af0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b10: 2020 6c61 7465 7374 5f76 6572 7369 6f6e    latest_version
+00028b20: 3d72 6573 6f75 7263 655f 7665 7273 696f  =resource_versio
+00028b30: 6e73 2e67 6574 286e 616d 6529 2c0a 2020  ns.get(name),.  
+00028b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00028b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b70: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00028b80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
 00028b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ba0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00028bb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00028bc0: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-00028bd0: 6570 7469 6f6e 2865 7863 6570 7469 6f6e  eption(exception
-00028be0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028bf0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00028c00: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00028c10: 6169 7365 5f6f 6e5f 6578 6973 7473 3a0a  aise_on_exists:.
-00028c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c30: 2020 2020 2020 2020 7261 6973 6520 416c          raise Al
-00028c40: 7265 6164 7945 7869 7374 7345 7863 6570  readyExistsExcep
-00028c50: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00028c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c70: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-00028c80: 722e 7761 726e 696e 675f 6e61 6d65 5f61  r.warning_name_a
-00028c90: 6c72 6561 6479 5f65 7869 7374 7328 0a20  lready_exists(. 
-00028ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028cb0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00028cc0: 616d 653d 6e61 6d65 2069 6620 746f 5f72  ame=name if to_r
-00028cd0: 756e 5b6e 616d 655d 5b22 7665 7273 696f  un[name]["versio
-00028ce0: 6e22 5d20 6973 204e 6f6e 6520 656c 7365  n"] is None else
-00028cf0: 2066 277b 6e61 6d65 7d5f 5f76 7b74 6f5f   f'{name}__v{to_
-00028d00: 7275 6e5b 6e61 6d65 5d5b 2276 6572 7369  run[name]["versi
-00028d10: 6f6e 225d 7d27 0a20 2020 2020 2020 2020  on"]}'.         
-00028d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028d40: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00028d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d80: 2063 6c69 636b 2e65 6368 6f28 0a20 2020   click.echo(.   
-00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028da0: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
-00028db0: 6b4d 616e 6167 6572 2e77 6172 6e69 6e67  kManager.warning
-00028dc0: 5f6e 616d 655f 616c 7265 6164 795f 6578  _name_already_ex
-00028dd0: 6973 7473 280a 2020 2020 2020 2020 2020  ists(.          
-00028de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028df0: 2020 2020 2020 6e61 6d65 3d6e 616d 6520        name=name 
-00028e00: 6966 2074 6f5f 7275 6e5b 6e61 6d65 5d5b  if to_run[name][
-00028e10: 2276 6572 7369 6f6e 225d 2069 7320 4e6f  "version"] is No
-00028e20: 6e65 2065 6c73 6520 6627 7b6e 616d 657d  ne else f'{name}
-00028e30: 5f5f 767b 746f 5f72 756e 5b6e 616d 655d  __v{to_run[name]
-00028e40: 5b22 7665 7273 696f 6e22 5d7d 270a 2020  ["version"]}'.  
-00028e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00028e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00028e90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00028ea0: 2020 2020 2020 2020 6966 2073 686f 756c          if shoul
-00028eb0: 645f 7075 7368 5f66 696c 6528 6e61 6d65  d_push_file(name
-00028ec0: 2c20 7265 6d6f 7465 5f72 6573 6f75 7263  , remote_resourc
-00028ed0: 655f 6e61 6d65 732c 206c 6174 6573 745f  e_names, latest_
-00028ee0: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
-00028ef0: 6f6e 732c 2066 6f72 6365 2c20 7275 6e5f  ons, force, run_
-00028f00: 7465 7374 7329 3a0a 2020 2020 2020 2020  tests):.        
-00028f10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00028f20: 616d 6520 6e6f 7420 696e 2072 6573 6f75  ame not in resou
-00028f30: 7263 655f 7665 7273 696f 6e73 3a0a 2020  rce_versions:.  
-00028f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f50: 2020 2020 2020 7665 7273 696f 6e20 3d20        version = 
-00028f60: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-00028f70: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
-00028f80: 6d65 2069 6e20 6c61 7465 7374 5f64 6174  me in latest_dat
-00028f90: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
-00028fa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028fb0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00028fc0: 7273 696f 6e20 3d20 6622 2876 7b6c 6174  rsion = f"(v{lat
-00028fd0: 6573 745f 6461 7461 736f 7572 6365 5f76  est_datasource_v
-00028fe0: 6572 7369 6f6e 735b 6e61 6d65 5d7d 2922  ersions[name]})"
-00028ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029000: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-00029010: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-00029020: 6765 722e 696e 666f 5f64 7279 5f70 726f  ger.info_dry_pro
-00029030: 6365 7373 696e 675f 6e65 775f 7265 736f  cessing_new_reso
-00029040: 7572 6365 286e 616d 653d 6e61 6d65 2c20  urce(name=name, 
-00029050: 7665 7273 696f 6e3d 7665 7273 696f 6e29  version=version)
-00029060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00029070: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029090: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
-000290a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290b0: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
-000290c0: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
-000290d0: 5f64 7279 5f70 726f 6365 7373 696e 675f  _dry_processing_
-000290e0: 7265 736f 7572 6365 280a 2020 2020 2020  resource(.      
-000290f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029100: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
-00029110: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00029120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029130: 2020 2020 2076 6572 7369 6f6e 3d6c 6174       version=lat
-00029140: 6573 745f 6461 7461 736f 7572 6365 5f76  est_datasource_v
-00029150: 6572 7369 6f6e 735b 6e61 6d65 5d2c 0a20  ersions[name],. 
-00029160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029170: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00029180: 6174 6573 745f 7665 7273 696f 6e3d 7265  atest_version=re
-00029190: 736f 7572 6365 5f76 6572 7369 6f6e 732e  source_versions.
-000291a0: 6765 7428 6e61 6d65 292c 0a20 2020 2020  get(name),.     
-000291b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000291d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000291f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00029200: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-00029210: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-00029220: 4d61 6e61 6765 722e 7761 726e 696e 675f  Manager.warning_
-00029230: 6472 795f 6e61 6d65 5f61 6c72 6561 6479  dry_name_already
-00029240: 5f65 7869 7374 7328 6e61 6d65 3d6e 616d  _exists(name=nam
-00029250: 6529 290a 0a20 2020 2061 7379 6e63 2064  e))..    async d
-00029260: 6566 2070 7573 685f 6669 6c65 7328 0a20  ef push_files(. 
-00029270: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00029280: 795f 6772 6170 683a 2047 7261 7068 4465  y_graph: GraphDe
-00029290: 7065 6e64 656e 6369 6573 2c0a 2020 2020  pendencies,.    
-000292a0: 2020 2020 6472 795f 7275 6e3a 2062 6f6f      dry_run: boo
-000292b0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-000292c0: 2020 2063 6865 636b 5f62 6163 6b66 696c     check_backfil
-000292d0: 6c5f 7265 7175 6972 6564 3a20 626f 6f6c  l_required: bool
-000292e0: 203d 2046 616c 7365 2c0a 2020 2020 293a   = False,.    ):
-000292f0: 0a20 2020 2020 2020 2065 6e64 706f 696e  .        endpoin
-00029300: 7473 5f64 6570 5f6d 6170 203d 2064 6963  ts_dep_map = dic
-00029310: 7428 290a 2020 2020 2020 2020 7072 6f63  t().        proc
-00029320: 6573 7365 6420 3d20 7365 7428 290a 0a20  essed = set().. 
-00029330: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00029340: 6965 735f 6772 6170 6820 3d20 6465 7065  ies_graph = depe
-00029350: 6e64 656e 6379 5f67 7261 7068 2e64 6570  ndency_graph.dep
-00029360: 5f6d 6170 0a20 2020 2020 2020 2072 6573  _map.        res
-00029370: 6f75 7263 6573 5f74 6f5f 7275 6e20 3d20  ources_to_run = 
-00029380: 6465 7065 6e64 656e 6379 5f67 7261 7068  dependency_graph
-00029390: 2e74 6f5f 7275 6e0a 0a20 2020 2020 2020  .to_run..       
-000293a0: 2069 6620 6e6f 7420 666f 726b 5f64 6f77   if not fork_dow
-000293b0: 6e73 7472 6561 6d3a 0a20 2020 2020 2020  nstream:.       
-000293c0: 2020 2020 2023 2046 6972 7374 2c20 7765       # First, we
-000293d0: 2077 696c 6c20 6465 706c 6f79 2074 6865   will deploy the
-000293e0: 2061 6c6c 2074 6865 2072 6573 6f75 7263   all the resourc
-000293f0: 6573 2066 6f6c 6c6f 7769 6e67 2074 6865  es following the
-00029400: 2064 6570 656e 6465 6e63 7920 6772 6170   dependency grap
-00029410: 6820 6578 6365 7074 2066 6f72 2074 6865  h except for the
-00029420: 2065 6e64 706f 696e 7473 0a20 2020 2020   endpoints.     
-00029430: 2020 2020 2020 2067 726f 7570 7320 3d20         groups = 
-00029440: 5b67 726f 7570 2066 6f72 2067 726f 7570  [group for group
-00029450: 2069 6e20 746f 706f 736f 7274 2864 6570   in toposort(dep
-00029460: 656e 6465 6e63 6965 735f 6772 6170 6829  endencies_graph)
-00029470: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00029480: 7220 6772 6f75 7020 696e 2067 726f 7570  r group in group
-00029490: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000294a0: 2020 2066 6f72 206e 616d 6520 696e 2067     for name in g
-000294b0: 726f 7570 3a0a 2020 2020 2020 2020 2020  roup:.          
-000294c0: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
-000294d0: 6520 696e 2070 726f 6365 7373 6564 3a0a  e in processed:.
-000294e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294f0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00029500: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00029510: 2020 2020 2020 6966 2069 735f 656e 6470        if is_endp
-00029520: 6f69 6e74 5f77 6974 685f 6e6f 5f64 6570  oint_with_no_dep
-00029530: 656e 6465 6e63 6965 7328 0a20 2020 2020  endencies(.     
-00029540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029550: 2020 2072 6573 6f75 7263 6573 5f74 6f5f     resources_to_
-00029560: 7275 6e2e 6765 7428 6e61 6d65 2c20 7b7d  run.get(name, {}
-00029570: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00029580: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00029590: 6465 6e63 6965 735f 6772 6170 682c 0a20  dencies_graph,. 
-000295a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295b0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-000295c0: 5f74 6f5f 7275 6e2c 0a20 2020 2020 2020  _to_run,.       
-000295d0: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
-000295e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295f0: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-00029600: 735f 6465 705f 6d61 705b 6e61 6d65 5d20  s_dep_map[name] 
-00029610: 3d20 6465 7065 6e64 656e 6369 6573 5f67  = dependencies_g
-00029620: 7261 7068 5b6e 616d 655d 0a20 2020 2020  raph[name].     
-00029630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029640: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00029650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029660: 2061 7761 6974 2070 7573 6828 0a20 2020   await push(.   
-00029670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029680: 2020 2020 206e 616d 652c 0a20 2020 2020       name,.     
-00029690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000296a0: 2020 2072 6573 6f75 7263 6573 5f74 6f5f     resources_to_
-000296b0: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-000296c0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000296d0: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
-000296e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000296f0: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
-00029700: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
-00029710: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00029720: 2020 2020 2020 2020 2020 2020 6472 795f              dry_
-00029730: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-00029740: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00029750: 6b5f 646f 776e 7374 7265 616d 2c0a 2020  k_downstream,.  
-00029760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029770: 2020 2020 2020 666f 726b 2c0a 2020 2020        fork,.    
-00029780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000297a0: 2020 2020 2020 7072 6f63 6573 7365 642e        processed.
-000297b0: 6164 6428 6e61 6d65 290a 0a20 2020 2020  add(name)..     
-000297c0: 2020 2020 2020 2023 2054 6865 6e2c 2077         # Then, w
-000297d0: 6520 7769 6c6c 2064 6570 6c6f 7920 7468  e will deploy th
-000297e0: 6520 656e 6470 6f69 6e74 7320 7468 6174  e endpoints that
-000297f0: 2061 7265 206f 6e20 7468 6520 6465 7065   are on the depe
-00029800: 6e64 656e 6379 2067 7261 7068 0a20 2020  ndency graph.   
-00029810: 2020 2020 2020 2020 2067 726f 7570 7320           groups 
-00029820: 3d20 5b67 726f 7570 2066 6f72 2067 726f  = [group for gro
-00029830: 7570 2069 6e20 746f 706f 736f 7274 2865  up in toposort(e
-00029840: 6e64 706f 696e 7473 5f64 6570 5f6d 6170  ndpoints_dep_map
-00029850: 295d 0a20 2020 2020 2020 2020 2020 2066  )].            f
-00029860: 6f72 2067 726f 7570 2069 6e20 6772 6f75  or group in grou
-00029870: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
-00029880: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
-00029890: 6772 6f75 703a 0a20 2020 2020 2020 2020  group:.         
-000298a0: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
-000298b0: 6d65 206e 6f74 2069 6e20 7072 6f63 6573  me not in proces
-000298c0: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
-000298d0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000298e0: 6974 2070 7573 6828 0a20 2020 2020 2020  it push(.       
-000298f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029900: 2020 2020 206e 616d 652c 0a20 2020 2020       name,.     
+00028ba0: 636c 6963 6b2e 6563 686f 2846 6565 6462  click.echo(Feedb
+00028bb0: 6163 6b4d 616e 6167 6572 2e77 6172 6e69  ackManager.warni
+00028bc0: 6e67 5f64 7279 5f6e 616d 655f 616c 7265  ng_dry_name_alre
+00028bd0: 6164 795f 6578 6973 7473 286e 616d 653d  ady_exists(name=
+00028be0: 6e61 6d65 2929 0a0a 2020 2020 6173 796e  name))..    asyn
+00028bf0: 6320 6465 6620 7075 7368 5f66 696c 6573  c def push_files
+00028c00: 280a 2020 2020 2020 2020 6465 7065 6e64  (.        depend
+00028c10: 656e 6379 5f67 7261 7068 3a20 4772 6170  ency_graph: Grap
+00028c20: 6844 6570 656e 6465 6e63 6965 732c 0a20  hDependencies,. 
+00028c30: 2020 2020 2020 2064 7279 5f72 756e 3a20         dry_run: 
+00028c40: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00028c50: 2020 2020 2020 6368 6563 6b5f 6261 636b        check_back
+00028c60: 6669 6c6c 5f72 6571 7569 7265 643a 2062  fill_required: b
+00028c70: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00028c80: 2029 3a0a 2020 2020 2020 2020 656e 6470   ):.        endp
+00028c90: 6f69 6e74 735f 6465 705f 6d61 7020 3d20  oints_dep_map = 
+00028ca0: 6469 6374 2829 0a20 2020 2020 2020 2070  dict().        p
+00028cb0: 726f 6365 7373 6564 203d 2073 6574 2829  rocessed = set()
+00028cc0: 0a0a 2020 2020 2020 2020 6465 7065 6e64  ..        depend
+00028cd0: 656e 6369 6573 5f67 7261 7068 203d 2064  encies_graph = d
+00028ce0: 6570 656e 6465 6e63 795f 6772 6170 682e  ependency_graph.
+00028cf0: 6465 705f 6d61 700a 2020 2020 2020 2020  dep_map.        
+00028d00: 7265 736f 7572 6365 735f 746f 5f72 756e  resources_to_run
+00028d10: 203d 2064 6570 656e 6465 6e63 795f 6772   = dependency_gr
+00028d20: 6170 682e 746f 5f72 756e 0a0a 2020 2020  aph.to_run..    
+00028d30: 2020 2020 6966 206e 6f74 2066 6f72 6b5f      if not fork_
+00028d40: 646f 776e 7374 7265 616d 3a0a 2020 2020  downstream:.    
+00028d50: 2020 2020 2020 2020 2320 4669 7273 742c          # First,
+00028d60: 2077 6520 7769 6c6c 2064 6570 6c6f 7920   we will deploy 
+00028d70: 7468 6520 616c 6c20 7468 6520 7265 736f  the all the reso
+00028d80: 7572 6365 7320 666f 6c6c 6f77 696e 6720  urces following 
+00028d90: 7468 6520 6465 7065 6e64 656e 6379 2067  the dependency g
+00028da0: 7261 7068 2065 7863 6570 7420 666f 7220  raph except for 
+00028db0: 7468 6520 656e 6470 6f69 6e74 730a 2020  the endpoints.  
+00028dc0: 2020 2020 2020 2020 2020 6772 6f75 7073            groups
+00028dd0: 203d 205b 6772 6f75 7020 666f 7220 6772   = [group for gr
+00028de0: 6f75 7020 696e 2074 6f70 6f73 6f72 7428  oup in toposort(
+00028df0: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
+00028e00: 7068 295d 0a20 2020 2020 2020 2020 2020  ph)].           
+00028e10: 2066 6f72 2067 726f 7570 2069 6e20 6772   for group in gr
+00028e20: 6f75 7073 3a0a 2020 2020 2020 2020 2020  oups:.          
+00028e30: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+00028e40: 6e20 6772 6f75 703a 0a20 2020 2020 2020  n group:.       
+00028e50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00028e60: 6e61 6d65 2069 6e20 7072 6f63 6573 7365  name in processe
+00028e70: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00028e80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00028e90: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00028ea0: 2020 2020 2020 2020 2069 6620 6973 5f65           if is_e
+00028eb0: 6e64 706f 696e 745f 7769 7468 5f6e 6f5f  ndpoint_with_no_
+00028ec0: 6465 7065 6e64 656e 6369 6573 280a 2020  dependencies(.  
+00028ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ee0: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
+00028ef0: 746f 5f72 756e 2e67 6574 286e 616d 652c  to_run.get(name,
+00028f00: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00028f10: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00028f20: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
+00028f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028f40: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+00028f50: 6365 735f 746f 5f72 756e 2c0a 2020 2020  ces_to_run,.    
+00028f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00028f80: 2020 2020 2020 2020 2020 2065 6e64 706f             endpo
+00028f90: 696e 7473 5f64 6570 5f6d 6170 5b6e 616d  ints_dep_map[nam
+00028fa0: 655d 203d 2064 6570 656e 6465 6e63 6965  e] = dependencie
+00028fb0: 735f 6772 6170 685b 6e61 6d65 5d0a 2020  s_graph[name].  
+00028fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028fd0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+00028fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ff0: 2020 2020 6177 6169 7420 7075 7368 280a      await push(.
+00029000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029010: 2020 2020 2020 2020 6e61 6d65 2c0a 2020          name,.  
+00029020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029030: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
+00029040: 746f 5f72 756e 2c0a 2020 2020 2020 2020  to_run,.        
+00029050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029060: 7265 736f 7572 6365 5f76 6572 7369 6f6e  resource_version
+00029070: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00029080: 2020 2020 2020 2020 2020 206c 6174 6573             lates
+00029090: 745f 6461 7461 736f 7572 6365 5f76 6572  t_datasource_ver
+000290a0: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+000290b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000290c0: 7279 5f72 756e 2c0a 2020 2020 2020 2020  ry_run,.        
+000290d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290e0: 666f 726b 5f64 6f77 6e73 7472 6561 6d2c  fork_downstream,
+000290f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029100: 2020 2020 2020 2020 2066 6f72 6b2c 0a20           fork,. 
+00029110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029120: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00029130: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00029140: 6564 2e61 6464 286e 616d 6529 0a0a 2020  ed.add(name)..  
+00029150: 2020 2020 2020 2020 2020 2320 5468 656e            # Then
+00029160: 2c20 7765 2077 696c 6c20 6465 706c 6f79  , we will deploy
+00029170: 2074 6865 2065 6e64 706f 696e 7473 2074   the endpoints t
+00029180: 6861 7420 6172 6520 6f6e 2074 6865 2064  hat are on the d
+00029190: 6570 656e 6465 6e63 7920 6772 6170 680a  ependency graph.
+000291a0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+000291b0: 7073 203d 205b 6772 6f75 7020 666f 7220  ps = [group for 
+000291c0: 6772 6f75 7020 696e 2074 6f70 6f73 6f72  group in toposor
+000291d0: 7428 656e 6470 6f69 6e74 735f 6465 705f  t(endpoints_dep_
+000291e0: 6d61 7029 5d0a 2020 2020 2020 2020 2020  map)].          
+000291f0: 2020 666f 7220 6772 6f75 7020 696e 2067    for group in g
+00029200: 726f 7570 733a 0a20 2020 2020 2020 2020  roups:.         
+00029210: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+00029220: 696e 2067 726f 7570 3a0a 2020 2020 2020  in group:.      
+00029230: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00029240: 206e 616d 6520 6e6f 7420 696e 2070 726f   name not in pro
+00029250: 6365 7373 6564 3a0a 2020 2020 2020 2020  cessed:.        
+00029260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029270: 6177 6169 7420 7075 7368 280a 2020 2020  await push(.    
+00029280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029290: 2020 2020 2020 2020 6e61 6d65 2c0a 2020          name,.  
+000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292b0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+000292c0: 6365 735f 746f 5f72 756e 2c0a 2020 2020  ces_to_run,.    
+000292d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292e0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+000292f0: 5f76 6572 7369 6f6e 732c 0a20 2020 2020  _versions,.     
+00029300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029310: 2020 2020 2020 206c 6174 6573 745f 6461         latest_da
+00029320: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
+00029330: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00029340: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00029350: 7279 5f72 756e 2c0a 2020 2020 2020 2020  ry_run,.        
+00029360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029370: 2020 2020 666f 726b 5f64 6f77 6e73 7472      fork_downstr
+00029380: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
+00029390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293a0: 2066 6f72 6b2c 0a20 2020 2020 2020 2020   fork,.         
+000293b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000293c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000293d0: 2020 2020 2020 2020 2070 726f 6365 7373           process
+000293e0: 6564 2e61 6464 286e 616d 6529 0a20 2020  ed.add(name).   
+000293f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00029400: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
+00029410: 6c6c 2067 656e 6572 6174 6520 7468 6520  ll generate the 
+00029420: 6772 6170 6820 6672 6f6d 2072 6967 6874  graph from right
+00029430: 2074 6f20 6c65 6674 2061 6e64 2077 696c   to left and wil
+00029440: 6c20 6669 6c6c 2074 6865 2067 6170 7320  l fill the gaps 
+00029450: 6f66 2074 6865 2064 6570 656e 6465 6e63  of the dependenc
+00029460: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+00029470: 2320 4966 2077 6520 6861 7665 2061 2067  # If we have a g
+00029480: 7261 7068 206c 696b 6520 7468 6973 3a0a  raph like this:.
+00029490: 2020 2020 2020 2020 2020 2020 2320 4120              # A 
+000294a0: 2d3e 2042 202d 3e20 430a 2020 2020 2020  -> B -> C.      
+000294b0: 2020 2020 2020 2320 4966 2077 6520 6f6e        # If we on
+000294c0: 6c79 206d 6f64 6966 7920 412c 2074 6865  ly modify A, the
+000294d0: 206e 6f72 6d61 6c20 6465 7065 6e64 656e   normal dependen
+000294e0: 6369 6573 2067 7261 7068 2077 696c 6c20  cies graph will 
+000294f0: 6f6e 6c79 2063 6f6e 7461 696e 2061 206e  only contain a n
+00029500: 6f64 6520 6c69 6b65 205f 7b41 203d 3e20  ode like _{A => 
+00029510: 427d 0a20 2020 2020 2020 2020 2020 2023  B}.            #
+00029520: 2042 7574 2077 6520 6e65 6564 2061 2067   But we need a g
+00029530: 7261 7068 2074 6861 7420 636f 6e74 6169  raph that contai
+00029540: 6e73 2041 2c20 4220 616e 6420 4320 616e  ns A, B and C an
+00029550: 6420 7468 6520 6465 7065 6e64 656e 6369  d the dependenci
+00029560: 6573 2062 6574 7765 656e 2074 6865 6d20  es between them 
+00029570: 746f 2064 6570 6c6f 7920 7468 656d 2069  to deploy them i
+00029580: 6e20 7468 6520 7269 6768 7420 6f72 6465  n the right orde
+00029590: 720a 2020 2020 2020 2020 2020 2020 6465  r.            de
+000295a0: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
+000295b0: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
+000295c0: 2c20 7265 736f 7572 6365 735f 746f 5f72  , resources_to_r
+000295d0: 756e 5f66 6f72 6b5f 646f 776e 7374 7265  un_fork_downstre
+000295e0: 616d 203d 2067 656e 6572 6174 655f 666f  am = generate_fo
+000295f0: 726b 646f 776e 7374 7265 616d 5f67 7261  rkdownstream_gra
+00029600: 7068 280a 2020 2020 2020 2020 2020 2020  ph(.            
+00029610: 2020 2020 6465 7065 6e64 656e 6379 5f67      dependency_g
+00029620: 7261 7068 2e61 6c6c 5f64 6570 5f6d 6170  raph.all_dep_map
+00029630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029640: 2020 6465 7065 6e64 656e 6379 5f67 7261    dependency_gra
+00029650: 7068 2e61 6c6c 5f72 6573 6f75 7263 6573  ph.all_resources
+00029660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029670: 2020 7265 736f 7572 6365 735f 746f 5f72    resources_to_r
+00029680: 756e 2c0a 2020 2020 2020 2020 2020 2020  un,.            
+00029690: 2020 2020 6c69 7374 2864 6570 656e 6465      list(depende
+000296a0: 6e63 795f 6772 6170 682e 6465 705f 6d61  ncy_graph.dep_ma
+000296b0: 702e 6b65 7973 2829 292c 0a20 2020 2020  p.keys()),.     
+000296c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000296d0: 2020 2020 2020 2320 4669 7273 742c 2077        # First, w
+000296e0: 6520 7769 6c6c 2064 6570 6c6f 7920 7468  e will deploy th
+000296f0: 6520 6461 7461 736f 7572 6365 7320 7468  e datasources th
+00029700: 6174 206e 6565 6420 746f 2062 6520 6465  at need to be de
+00029710: 706c 6f79 6564 2e0a 2020 2020 2020 2020  ployed..        
+00029720: 2020 2020 2320 5765 206e 6565 6420 746f      # We need to
+00029730: 2064 6570 6c6f 7920 7468 6520 6461 7461   deploy the data
+00029740: 736f 7572 6365 7320 6672 6f6d 206c 6566  sources from lef
+00029750: 7420 746f 2072 6967 6874 2061 7320 736f  t to right as so
+00029760: 6d65 2064 6174 6173 6f75 7263 6573 206d  me datasources m
+00029770: 6967 6874 2068 6176 6520 4d56 2074 6861  ight have MV tha
+00029780: 7420 6465 7065 6e64 206f 6e20 7468 6520  t depend on the 
+00029790: 636f 6c75 6d6e 2074 7970 6573 206f 6620  column types of 
+000297a0: 7072 6576 696f 7573 2064 6174 6173 6f75  previous datasou
+000297b0: 7263 6573 2e20 4578 3a20 6074 6573 745f  rces. Ex: `test_
+000297c0: 6368 616e 6765 5f63 6f6c 756d 6e5f 7479  change_column_ty
+000297d0: 7065 5f6c 616e 6469 6e67 5f64 6174 6173  pe_landing_datas
+000297e0: 6f75 7263 6560 2074 6573 740a 2020 2020  ource` test.    
+000297f0: 2020 2020 2020 2020 6772 6f75 7073 203d          groups =
+00029800: 205b 6772 6f75 7020 666f 7220 6772 6f75   [group for grou
+00029810: 7020 696e 2074 6f70 6f73 6f72 7428 6465  p in toposort(de
+00029820: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
+00029830: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
+00029840: 295d 0a20 2020 2020 2020 2020 2020 2067  )].            g
+00029850: 726f 7570 732e 7265 7665 7273 6528 290a  roups.reverse().
+00029860: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00029870: 6772 6f75 7020 696e 2067 726f 7570 733a  group in groups:
+00029880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029890: 2066 6f72 206e 616d 6520 696e 2067 726f   for name in gro
+000298a0: 7570 3a0a 2020 2020 2020 2020 2020 2020  up:.            
+000298b0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+000298c0: 696e 2070 726f 6365 7373 6564 206f 7220  in processed or 
+000298d0: 6e6f 7420 6973 5f64 6174 6173 6f75 7263  not is_datasourc
+000298e0: 6528 7265 736f 7572 6365 735f 746f 5f72  e(resources_to_r
+000298f0: 756e 5f66 6f72 6b5f 646f 776e 7374 7265  un_fork_downstre
+00029900: 616d 5b6e 616d 655d 293a 0a20 2020 2020  am[name]):.     
 00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029920: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00029930: 5f74 6f5f 7275 6e2c 0a20 2020 2020 2020  _to_run,.       
-00029940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029950: 2020 2020 2072 6573 6f75 7263 655f 7665       resource_ve
-00029960: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
-00029970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029980: 2020 2020 6c61 7465 7374 5f64 6174 6173      latest_datas
-00029990: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
-000299a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000299b0: 2020 2020 2020 2020 2020 2020 6472 795f              dry_
-000299c0: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-000299d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000299e0: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
-000299f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029a00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00029a10: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
-00029a20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00029a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a40: 2020 2020 2020 7072 6f63 6573 7365 642e        processed.
-00029a50: 6164 6428 6e61 6d65 290a 2020 2020 2020  add(name).      
-00029a60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00029a70: 2020 2020 2320 5468 6973 2077 696c 6c20      # This will 
-00029a80: 6765 6e65 7261 7465 2074 6865 2067 7261  generate the gra
-00029a90: 7068 2066 726f 6d20 7269 6768 7420 746f  ph from right to
-00029aa0: 206c 6566 7420 616e 6420 7769 6c6c 2066   left and will f
-00029ab0: 696c 6c20 7468 6520 6761 7073 206f 6620  ill the gaps of 
-00029ac0: 7468 6520 6465 7065 6e64 656e 6369 6573  the dependencies
-00029ad0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00029ae0: 6620 7765 2068 6176 6520 6120 6772 6170  f we have a grap
-00029af0: 6820 6c69 6b65 2074 6869 733a 0a20 2020  h like this:.   
-00029b00: 2020 2020 2020 2020 2023 2041 202d 3e20           # A -> 
-00029b10: 4220 2d3e 2043 0a20 2020 2020 2020 2020  B -> C.         
-00029b20: 2020 2023 2049 6620 7765 206f 6e6c 7920     # If we only 
-00029b30: 6d6f 6469 6679 2041 2c20 7468 6520 6e6f  modify A, the no
-00029b40: 726d 616c 2064 6570 656e 6465 6e63 6965  rmal dependencie
-00029b50: 7320 6772 6170 6820 7769 6c6c 206f 6e6c  s graph will onl
-00029b60: 7920 636f 6e74 6169 6e20 6120 6e6f 6465  y contain a node
-00029b70: 206c 696b 6520 5f7b 4120 3d3e 2042 7d0a   like _{A => B}.
-00029b80: 2020 2020 2020 2020 2020 2020 2320 4275              # Bu
-00029b90: 7420 7765 206e 6565 6420 6120 6772 6170  t we need a grap
-00029ba0: 6820 7468 6174 2063 6f6e 7461 696e 7320  h that contains 
-00029bb0: 412c 2042 2061 6e64 2043 2061 6e64 2074  A, B and C and t
-00029bc0: 6865 2064 6570 656e 6465 6e63 6965 7320  he dependencies 
-00029bd0: 6265 7477 6565 6e20 7468 656d 2074 6f20  between them to 
-00029be0: 6465 706c 6f79 2074 6865 6d20 696e 2074  deploy them in t
-00029bf0: 6865 2072 6967 6874 206f 7264 6572 0a20  he right order. 
-00029c00: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00029c10: 6465 6e63 6965 735f 6772 6170 685f 666f  dencies_graph_fo
-00029c20: 726b 5f64 6f77 6e73 7472 6561 6d2c 2072  rk_downstream, r
-00029c30: 6573 6f75 7263 6573 5f74 6f5f 7275 6e5f  esources_to_run_
-00029c40: 666f 726b 5f64 6f77 6e73 7472 6561 6d20  fork_downstream 
-00029c50: 3d20 6765 6e65 7261 7465 5f66 6f72 6b64  = generate_forkd
-00029c60: 6f77 6e73 7472 6561 6d5f 6772 6170 6828  ownstream_graph(
-00029c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029c80: 2064 6570 656e 6465 6e63 795f 6772 6170   dependency_grap
-00029c90: 682e 616c 6c5f 6465 705f 6d61 702c 0a20  h.all_dep_map,. 
-00029ca0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00029cb0: 6570 656e 6465 6e63 795f 6772 6170 682e  ependency_graph.
-00029cc0: 616c 6c5f 7265 736f 7572 6365 732c 0a20  all_resources,. 
-00029cd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00029ce0: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2c  esources_to_run,
-00029cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029d00: 206c 6973 7428 6465 7065 6e64 656e 6379   list(dependency
-00029d10: 5f67 7261 7068 2e64 6570 5f6d 6170 2e6b  _graph.dep_map.k
-00029d20: 6579 7328 2929 2c0a 2020 2020 2020 2020  eys()),.        
-00029d30: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00029d40: 2020 2023 2046 6972 7374 2c20 7765 2077     # First, we w
-00029d50: 696c 6c20 6465 706c 6f79 2074 6865 2064  ill deploy the d
-00029d60: 6174 6173 6f75 7263 6573 2074 6861 7420  atasources that 
-00029d70: 6e65 6564 2074 6f20 6265 2064 6570 6c6f  need to be deplo
-00029d80: 7965 642e 0a20 2020 2020 2020 2020 2020  yed..           
-00029d90: 2023 2057 6520 6e65 6564 2074 6f20 6465   # We need to de
-00029da0: 706c 6f79 2074 6865 2064 6174 6173 6f75  ploy the datasou
-00029db0: 7263 6573 2066 726f 6d20 6c65 6674 2074  rces from left t
-00029dc0: 6f20 7269 6768 7420 6173 2073 6f6d 6520  o right as some 
-00029dd0: 6461 7461 736f 7572 6365 7320 6d69 6768  datasources migh
-00029de0: 7420 6861 7665 204d 5620 7468 6174 2064  t have MV that d
-00029df0: 6570 656e 6420 6f6e 2074 6865 2063 6f6c  epend on the col
-00029e00: 756d 6e20 7479 7065 7320 6f66 2070 7265  umn types of pre
-00029e10: 7669 6f75 7320 6461 7461 736f 7572 6365  vious datasource
-00029e20: 732e 2045 783a 2060 7465 7374 5f63 6861  s. Ex: `test_cha
-00029e30: 6e67 655f 636f 6c75 6d6e 5f74 7970 655f  nge_column_type_
-00029e40: 6c61 6e64 696e 675f 6461 7461 736f 7572  landing_datasour
-00029e50: 6365 6020 7465 7374 0a20 2020 2020 2020  ce` test.       
-00029e60: 2020 2020 2067 726f 7570 7320 3d20 5b67       groups = [g
-00029e70: 726f 7570 2066 6f72 2067 726f 7570 2069  roup for group i
-00029e80: 6e20 746f 706f 736f 7274 2864 6570 656e  n toposort(depen
-00029e90: 6465 6e63 6965 735f 6772 6170 685f 666f  dencies_graph_fo
-00029ea0: 726b 5f64 6f77 6e73 7472 6561 6d29 5d0a  rk_downstream)].
-00029eb0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00029ec0: 7073 2e72 6576 6572 7365 2829 0a20 2020  ps.reverse().   
-00029ed0: 2020 2020 2020 2020 2066 6f72 2067 726f           for gro
-00029ee0: 7570 2069 6e20 6772 6f75 7073 3a0a 2020  up in groups:.  
-00029ef0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00029f00: 7220 6e61 6d65 2069 6e20 6772 6f75 703a  r name in group:
-00029f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029f20: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
-00029f30: 7072 6f63 6573 7365 6420 6f72 206e 6f74  processed or not
-00029f40: 2069 735f 6461 7461 736f 7572 6365 2872   is_datasource(r
-00029f50: 6573 6f75 7263 6573 5f74 6f5f 7275 6e5f  esources_to_run_
-00029f60: 666f 726b 5f64 6f77 6e73 7472 6561 6d5b  fork_downstream[
-00029f70: 6e61 6d65 5d29 3a0a 2020 2020 2020 2020  name]):.        
-00029f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f90: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-00029fa0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00029fb0: 4966 2074 6865 2072 6573 6f75 7263 6520  If the resource 
-00029fc0: 6973 206e 6577 2c20 7765 2077 696c 6c20  is new, we will 
-00029fd0: 7573 6520 7468 6520 6e6f 726d 616c 2072  use the normal r
-00029fe0: 6573 6f75 7263 6520 696e 666f 726d 6174  esource informat
-00029ff0: 696f 6e20 746f 2064 6570 6c6f 7920 6974  ion to deploy it
-0002a000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a010: 2020 2020 2023 2054 6869 7320 6973 206d       # This is m
-0002a020: 6f73 746c 7920 7573 6564 2066 6f72 2064  ostly used for d
-0002a030: 6174 6173 6f75 7263 6573 2077 6974 6820  atasources with 
-0002a040: 636f 6e6e 6563 7469 6f6e 732e 0a20 2020  connections..   
-0002a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a060: 2023 2041 7420 7468 6520 6d6f 6d65 6e74   # At the moment
-0002a070: 2c20 6072 6573 6f75 7263 6573 5f74 6f5f  , `resources_to_
-0002a080: 7275 6e5f 666f 726b 5f64 6f77 6e73 7472  run_fork_downstr
-0002a090: 6561 6d60 2069 7320 6765 6e65 7261 7465  eam` is generate
-0002a0a0: 6420 6279 2060 616c 6c5f 7265 736f 7572  d by `all_resour
-0002a0b0: 6365 7360 2061 6e64 2074 6869 7320 6973  ces` and this is
-0002a0c0: 2067 656e 6572 6174 6564 2075 7369 6e67   generated using
-0002a0d0: 2074 6865 2070 6172 616d 6574 6572 2060   the parameter `
-0002a0e0: 736b 6970 5f63 6f6e 6e65 6374 6f72 733d  skip_connectors=
-0002a0f0: 5472 7565 600a 2020 2020 2020 2020 2020  True`.          
-0002a100: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-0002a110: 3a20 5368 6f75 6c64 2074 6865 2060 7265  : Should the `re
-0002a120: 736f 7572 6365 735f 746f 5f72 756e 5f66  sources_to_run_f
-0002a130: 6f72 6b5f 646f 776e 7374 7265 616d 6020  ork_downstream` 
-0002a140: 6265 2067 656e 6572 6174 6564 2075 7369  be generated usi
-0002a150: 6e67 2074 6865 2060 736b 6970 5f63 6f6e  ng the `skip_con
-0002a160: 6e65 6374 6f72 7360 2070 6172 616d 6574  nectors` paramet
-0002a170: 6572 3f0a 2020 2020 2020 2020 2020 2020  er?.            
-0002a180: 2020 2020 2020 2020 6966 2069 735f 6e65          if is_ne
-0002a190: 7728 6e61 6d65 2c20 6368 616e 6765 642c  w(name, changed,
-0002a1a0: 2064 6570 656e 6465 6e63 6965 735f 6772   dependencies_gr
-0002a1b0: 6170 685f 666f 726b 5f64 6f77 6e73 7472  aph_fork_downstr
-0002a1c0: 6561 6d2c 2064 6570 656e 6465 6e63 6965  eam, dependencie
-0002a1d0: 735f 6772 6170 685f 666f 726b 5f64 6f77  s_graph_fork_dow
-0002a1e0: 6e73 7472 6561 6d29 3a0a 2020 2020 2020  nstream):.      
-0002a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a200: 2020 6177 6169 7420 7075 7368 280a 2020    await push(.  
+00029920: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00029930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029940: 2023 2049 6620 7468 6520 7265 736f 7572   # If the resour
+00029950: 6365 2069 7320 6e65 772c 2077 6520 7769  ce is new, we wi
+00029960: 6c6c 2075 7365 2074 6865 206e 6f72 6d61  ll use the norma
+00029970: 6c20 7265 736f 7572 6365 2069 6e66 6f72  l resource infor
+00029980: 6d61 7469 6f6e 2074 6f20 6465 706c 6f79  mation to deploy
+00029990: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+000299a0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+000299b0: 7320 6d6f 7374 6c79 2075 7365 6420 666f  s mostly used fo
+000299c0: 7220 6461 7461 736f 7572 6365 7320 7769  r datasources wi
+000299d0: 7468 2063 6f6e 6e65 6374 696f 6e73 2e0a  th connections..
+000299e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299f0: 2020 2020 2320 4174 2074 6865 206d 6f6d      # At the mom
+00029a00: 656e 742c 2060 7265 736f 7572 6365 735f  ent, `resources_
+00029a10: 746f 5f72 756e 5f66 6f72 6b5f 646f 776e  to_run_fork_down
+00029a20: 7374 7265 616d 6020 6973 2067 656e 6572  stream` is gener
+00029a30: 6174 6564 2062 7920 6061 6c6c 5f72 6573  ated by `all_res
+00029a40: 6f75 7263 6573 6020 616e 6420 7468 6973  ources` and this
+00029a50: 2069 7320 6765 6e65 7261 7465 6420 7573   is generated us
+00029a60: 696e 6720 7468 6520 7061 7261 6d65 7465  ing the paramete
+00029a70: 7220 6073 6b69 705f 636f 6e6e 6563 746f  r `skip_connecto
+00029a80: 7273 3d54 7275 6560 0a20 2020 2020 2020  rs=True`.       
+00029a90: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+00029aa0: 4f44 4f3a 2053 686f 756c 6420 7468 6520  ODO: Should the 
+00029ab0: 6072 6573 6f75 7263 6573 5f74 6f5f 7275  `resources_to_ru
+00029ac0: 6e5f 666f 726b 5f64 6f77 6e73 7472 6561  n_fork_downstrea
+00029ad0: 6d60 2062 6520 6765 6e65 7261 7465 6420  m` be generated 
+00029ae0: 7573 696e 6720 7468 6520 6073 6b69 705f  using the `skip_
+00029af0: 636f 6e6e 6563 746f 7273 6020 7061 7261  connectors` para
+00029b00: 6d65 7465 723f 0a20 2020 2020 2020 2020  meter?.         
+00029b10: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00029b20: 5f6e 6577 286e 616d 652c 2063 6861 6e67  _new(name, chang
+00029b30: 6564 2c20 6465 7065 6e64 656e 6369 6573  ed, dependencies
+00029b40: 5f67 7261 7068 5f66 6f72 6b5f 646f 776e  _graph_fork_down
+00029b50: 7374 7265 616d 2c20 6465 7065 6e64 656e  stream, dependen
+00029b60: 6369 6573 5f67 7261 7068 5f66 6f72 6b5f  cies_graph_fork_
+00029b70: 646f 776e 7374 7265 616d 293a 0a20 2020  downstream):.   
+00029b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b90: 2020 2020 2061 7761 6974 2070 7573 6828       await push(
+00029ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029bb0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00029bc0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00029bd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00029be0: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2c  esources_to_run,
+00029bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029c00: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00029c10: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
+00029c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c30: 2020 2020 2020 2020 2020 2020 6c61 7465              late
+00029c40: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+00029c50: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+00029c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c70: 2020 2020 6472 795f 7275 6e2c 0a20 2020      dry_run,.   
+00029c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c90: 2020 2020 2020 2020 2066 6f72 6b5f 646f           fork_do
+00029ca0: 776e 7374 7265 616d 2c0a 2020 2020 2020  wnstream,.      
+00029cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029cc0: 2020 2020 2020 666f 726b 2c0a 2020 2020        fork,.    
+00029cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ce0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00029cf0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00029d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d10: 2020 2020 2020 2020 2320 4966 2077 6520          # If we 
+00029d20: 6172 6520 7472 7969 6e67 2074 6f20 6d6f  are trying to mo
+00029d30: 6469 6679 2061 204b 6166 6b61 206f 7220  dify a Kafka or 
+00029d40: 4344 4b20 6461 7461 736f 7572 6365 2c20  CDK datasource, 
+00029d50: 7765 206e 6565 6420 746f 2069 6e66 6f72  we need to infor
+00029d60: 6d20 7468 6520 7573 6572 2074 6861 7420  m the user that 
+00029d70: 7468 6520 7265 736f 7572 6365 206e 6565  the resource nee
+00029d80: 6473 2074 6f20 6265 2070 6f73 742d 7265  ds to be post-re
+00029d90: 6c65 6173 6564 0a20 2020 2020 2020 2020  leased.         
+00029da0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00029db0: 6166 6b61 5f63 6f6e 6e65 6374 696f 6e5f  afka_connection_
+00029dc0: 6e61 6d65 203d 2028 0a20 2020 2020 2020  name = (.       
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029de0: 2020 2020 2072 6573 6f75 7263 6573 5f74       resources_t
+00029df0: 6f5f 7275 6e5f 666f 726b 5f64 6f77 6e73  o_run_fork_downs
+00029e00: 7472 6561 6d5b 6e61 6d65 5d2e 6765 7428  tream[name].get(
+00029e10: 2270 6172 616d 7322 2c20 7b7d 292e 6765  "params", {}).ge
+00029e20: 7428 226b 6166 6b61 5f63 6f6e 6e65 6374  t("kafka_connect
+00029e30: 696f 6e5f 6e61 6d65 2229 0a20 2020 2020  ion_name").     
+00029e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e50: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00029e60: 2020 2020 2020 2020 2020 2020 2073 6572               ser
+00029e70: 7669 6365 203d 2072 6573 6f75 7263 6573  vice = resources
+00029e80: 5f74 6f5f 7275 6e5f 666f 726b 5f64 6f77  _to_run_fork_dow
+00029e90: 6e73 7472 6561 6d5b 6e61 6d65 5d2e 6765  nstream[name].ge
+00029ea0: 7428 2270 6172 616d 7322 2c20 7b7d 292e  t("params", {}).
+00029eb0: 6765 7428 2269 6d70 6f72 745f 7365 7276  get("import_serv
+00029ec0: 6963 6522 290a 2020 2020 2020 2020 2020  ice").          
+00029ed0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00029ee0: 2072 656c 6561 7365 5f63 7265 6174 6564   release_created
+00029ef0: 2061 6e64 2028 6b61 666b 615f 636f 6e6e   and (kafka_conn
+00029f00: 6563 7469 6f6e 5f6e 616d 6520 6f72 2073  ection_name or s
+00029f10: 6572 7669 6365 293a 0a20 2020 2020 2020  ervice):.       
+00029f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f30: 2020 2020 2063 6f6e 6e65 6374 6f72 203d       connector =
+00029f40: 2022 4b61 666b 6122 2069 6620 6b61 666b   "Kafka" if kafk
+00029f50: 615f 636f 6e6e 6563 7469 6f6e 5f6e 616d  a_connection_nam
+00029f60: 6520 656c 7365 2073 6572 7669 6365 0a20  e else service. 
+00029f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f80: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+00029f90: 5f6d 7367 203d 2046 6565 6462 6163 6b4d  _msg = FeedbackM
+00029fa0: 616e 6167 6572 2e65 7272 6f72 5f63 6f6e  anager.error_con
+00029fb0: 6e65 6374 6f72 5f72 6571 7569 7265 5f70  nector_require_p
+00029fc0: 6f73 745f 7265 6c65 6173 6528 636f 6e6e  ost_release(conn
+00029fd0: 6563 746f 723d 636f 6e6e 6563 746f 7229  ector=connector)
+00029fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029ff0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0002a000: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+0002a010: 6365 7074 696f 6e28 6572 726f 725f 6d73  ception(error_ms
+0002a020: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
+0002a030: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002a040: 2077 6520 6172 6520 7075 7368 696e 6720   we are pushing 
+0002a050: 6120 6d6f 6469 6669 6564 2064 6174 6173  a modified datas
+0002a060: 6f75 7263 652c 2069 6e66 6f72 6d20 6162  ource, inform ab
+0002a070: 6f75 7420 7468 6520 6261 636b 6669 6c6c  out the backfill
+0002a080: 6060 0a20 2020 2020 2020 2020 2020 2020  ``.             
+0002a090: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+0002a0a0: 6563 6b5f 6261 636b 6669 6c6c 5f72 6571  eck_backfill_req
+0002a0b0: 7569 7265 6420 616e 6420 6175 746f 5f70  uired and auto_p
+0002a0c0: 726f 6d6f 7465 2061 6e64 2072 656c 6561  romote and relea
+0002a0d0: 7365 5f63 7265 6174 6564 3a0a 2020 2020  se_created:.    
+0002a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0f0: 2020 2020 2020 2020 6572 726f 725f 6d73          error_ms
+0002a100: 6720 3d20 4665 6564 6261 636b 4d61 6e61  g = FeedbackMana
+0002a110: 6765 722e 6572 726f 725f 6368 6563 6b5f  ger.error_check_
+0002a120: 6261 636b 6669 6c6c 5f72 6571 7569 7265  backfill_require
+0002a130: 6428 7265 736f 7572 6365 5f6e 616d 653d  d(resource_name=
+0002a140: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0002a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a160: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0002a170: 6963 6b45 7863 6570 7469 6f6e 2865 7272  ickException(err
+0002a180: 6f72 5f6d 7367 290a 0a20 2020 2020 2020  or_msg)..       
+0002a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a1a0: 2061 7761 6974 2070 7573 6828 0a20 2020   await push(.   
+0002a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a1c0: 2020 2020 2020 2020 206e 616d 652c 0a20           name,. 
+0002a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a1e0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+0002a1f0: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
+0002a200: 5f64 6f77 6e73 7472 6561 6d2c 0a20 2020  _downstream,.   
 0002a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a220: 2020 2020 2020 2020 2020 6e61 6d65 2c0a            name,.
-0002a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a240: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0002a250: 7572 6365 735f 746f 5f72 756e 2c0a 2020  urces_to_run,.  
-0002a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a270: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-0002a280: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
-0002a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2a0: 2020 2020 2020 2020 206c 6174 6573 745f           latest_
-0002a2b0: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
-0002a2c0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0002a220: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+0002a230: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
+0002a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a250: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
+0002a260: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
+0002a270: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0002a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a290: 6472 795f 7275 6e2c 0a20 2020 2020 2020  dry_run,.       
+0002a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a2b0: 2020 2020 2066 6f72 6b5f 646f 776e 7374       fork_downst
+0002a2c0: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
 0002a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2e0: 2064 7279 5f72 756e 2c0a 2020 2020 2020   dry_run,.      
+0002a2e0: 2020 666f 726b 2c0a 2020 2020 2020 2020    fork,.        
 0002a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a300: 2020 2020 2020 666f 726b 5f64 6f77 6e73        fork_downs
-0002a310: 7472 6561 6d2c 0a20 2020 2020 2020 2020  tream,.         
-0002a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a330: 2020 2066 6f72 6b2c 0a20 2020 2020 2020     fork,.       
-0002a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a350: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0002a360: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a380: 2020 2020 2023 2049 6620 7765 2061 7265       # If we are
-0002a390: 2074 7279 696e 6720 746f 206d 6f64 6966   trying to modif
-0002a3a0: 7920 6120 4b61 666b 6120 6f72 2043 444b  y a Kafka or CDK
-0002a3b0: 2064 6174 6173 6f75 7263 652c 2077 6520   datasource, we 
-0002a3c0: 6e65 6564 2074 6f20 696e 666f 726d 2074  need to inform t
-0002a3d0: 6865 2075 7365 7220 7468 6174 2074 6865  he user that the
-0002a3e0: 2072 6573 6f75 7263 6520 6e65 6564 7320   resource needs 
-0002a3f0: 746f 2062 6520 706f 7374 2d72 656c 6561  to be post-relea
-0002a400: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
-0002a410: 2020 2020 2020 2020 2020 2020 6b61 666b              kafk
-0002a420: 615f 636f 6e6e 6563 7469 6f6e 5f6e 616d  a_connection_nam
-0002a430: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-0002a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a450: 2020 7265 736f 7572 6365 735f 746f 5f72    resources_to_r
-0002a460: 756e 5f66 6f72 6b5f 646f 776e 7374 7265  un_fork_downstre
-0002a470: 616d 5b6e 616d 655d 2e67 6574 2822 7061  am[name].get("pa
-0002a480: 7261 6d73 222c 207b 7d29 2e67 6574 2822  rams", {}).get("
-0002a490: 6b61 666b 615f 636f 6e6e 6563 7469 6f6e  kafka_connection
-0002a4a0: 5f6e 616d 6522 290a 2020 2020 2020 2020  _name").        
-0002a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002a4d0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
-0002a4e0: 6520 3d20 7265 736f 7572 6365 735f 746f  e = resources_to
-0002a4f0: 5f72 756e 5f66 6f72 6b5f 646f 776e 7374  _run_fork_downst
-0002a500: 7265 616d 5b6e 616d 655d 2e67 6574 2822  ream[name].get("
-0002a510: 7061 7261 6d73 222c 207b 7d29 2e67 6574  params", {}).get
-0002a520: 2822 696d 706f 7274 5f73 6572 7669 6365  ("import_service
-0002a530: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0002a540: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0002a550: 6c65 6173 655f 6372 6561 7465 6420 616e  lease_created an
-0002a560: 6420 286b 6166 6b61 5f63 6f6e 6e65 6374  d (kafka_connect
-0002a570: 696f 6e5f 6e61 6d65 206f 7220 7365 7276  ion_name or serv
-0002a580: 6963 6529 3a0a 2020 2020 2020 2020 2020  ice):.          
-0002a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5a0: 2020 636f 6e6e 6563 746f 7220 3d20 224b    connector = "K
-0002a5b0: 6166 6b61 2220 6966 206b 6166 6b61 5f63  afka" if kafka_c
-0002a5c0: 6f6e 6e65 6374 696f 6e5f 6e61 6d65 2065  onnection_name e
-0002a5d0: 6c73 6520 7365 7276 6963 650a 2020 2020  lse service.    
-0002a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5f0: 2020 2020 2020 2020 6572 726f 725f 6d73          error_ms
-0002a600: 6720 3d20 4665 6564 6261 636b 4d61 6e61  g = FeedbackMana
-0002a610: 6765 722e 6572 726f 725f 636f 6e6e 6563  ger.error_connec
-0002a620: 746f 725f 7265 7175 6972 655f 706f 7374  tor_require_post
-0002a630: 5f72 656c 6561 7365 2863 6f6e 6e65 6374  _release(connect
-0002a640: 6f72 3d63 6f6e 6e65 6374 6f72 290a 2020  or=connector).  
-0002a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a660: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002a670: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-0002a680: 7469 6f6e 2865 7272 6f72 5f6d 7367 290a  tion(error_msg).
-0002a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a6a0: 2020 2020 2020 2020 2023 2049 6620 7765           # If we
-0002a6b0: 2061 7265 2070 7573 6869 6e67 2061 206d   are pushing a m
-0002a6c0: 6f64 6966 6965 6420 6461 7461 736f 7572  odified datasour
-0002a6d0: 6365 2c20 696e 666f 726d 2061 626f 7574  ce, inform about
-0002a6e0: 2074 6865 2062 6163 6b66 696c 6c60 600a   the backfill``.
-0002a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a700: 2020 2020 2020 2020 6966 2063 6865 636b          if check
-0002a710: 5f62 6163 6b66 696c 6c5f 7265 7175 6972  _backfill_requir
-0002a720: 6564 2061 6e64 2061 7574 6f5f 7072 6f6d  ed and auto_prom
-0002a730: 6f74 6520 616e 6420 7265 6c65 6173 655f  ote and release_
-0002a740: 6372 6561 7465 643a 0a20 2020 2020 2020  created:.       
-0002a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a760: 2020 2020 2065 7272 6f72 5f6d 7367 203d       error_msg =
-0002a770: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
-0002a780: 2e65 7272 6f72 5f63 6865 636b 5f62 6163  .error_check_bac
-0002a790: 6b66 696c 6c5f 7265 7175 6972 6564 2872  kfill_required(r
-0002a7a0: 6573 6f75 7263 655f 6e61 6d65 3d6e 616d  esource_name=nam
-0002a7b0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0002a7c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002a7d0: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-0002a7e0: 4578 6365 7074 696f 6e28 6572 726f 725f  Exception(error_
-0002a7f0: 6d73 6729 0a0a 2020 2020 2020 2020 2020  msg)..          
-0002a800: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0002a810: 6169 7420 7075 7368 280a 2020 2020 2020  ait push(.      
-0002a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a830: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
-0002a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a850: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0002a860: 735f 746f 5f72 756e 5f66 6f72 6b5f 646f  s_to_run_fork_do
-0002a870: 776e 7374 7265 616d 2c0a 2020 2020 2020  wnstream,.      
-0002a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a890: 2020 2020 2020 7265 736f 7572 6365 5f76        resource_v
-0002a8a0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-0002a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8c0: 2020 2020 206c 6174 6573 745f 6461 7461       latest_data
-0002a8d0: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
-0002a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a8f0: 2020 2020 2020 2020 2020 2020 2064 7279               dry
-0002a900: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
-0002a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a920: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
-0002a930: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-0002a940: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002a950: 6f72 6b2c 0a20 2020 2020 2020 2020 2020  ork,.           
-0002a960: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0002a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a980: 2020 2070 726f 6365 7373 6564 2e61 6464     processed.add
-0002a990: 286e 616d 6529 0a0a 2020 2020 2020 2020  (name)..        
-0002a9a0: 2020 2020 2320 4e6f 772c 2077 6520 7769      # Now, we wi
-0002a9b0: 6c6c 2063 7265 6174 6520 6120 6d61 7020  ll create a map 
-0002a9c0: 6f66 2061 6c6c 2074 6865 2065 6e64 706f  of all the endpo
-0002a9d0: 696e 7473 2061 6e64 2074 6865 7265 2064  ints and there d
-0002a9e0: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
-0002a9f0: 2020 2020 2020 2020 2320 5765 2061 7265          # We are
-0002aa00: 2075 7369 6e67 2074 6865 2066 6f72 6b64   using the forkd
-0002aa10: 6f77 6e73 7472 6561 6d20 6772 6170 6820  ownstream graph 
-0002aa20: 746f 2067 6574 2074 6865 2064 6570 656e  to get the depen
-0002aa30: 6465 6e63 6965 7320 6f66 2074 6865 2065  dencies of the e
-0002aa40: 6e64 706f 696e 7473 2061 7320 7468 6520  ndpoints as the 
-0002aa50: 6e6f 726d 616c 2064 6570 656e 6465 6e63  normal dependenc
-0002aa60: 6965 7320 6772 6170 6820 6f6e 6c79 2063  ies graph only c
-0002aa70: 6f6e 7461 696e 7320 7468 6520 7265 736f  ontains the reso
-0002aa80: 7572 6365 7320 7468 6174 2061 7265 2067  urces that are g
-0002aa90: 6f69 6e67 2074 6f20 6265 2064 6570 6c6f  oing to be deplo
-0002aaa0: 7965 640a 2020 2020 2020 2020 2020 2020  yed.            
-0002aab0: 2320 4275 7420 646f 6573 206e 6f74 2069  # But does not i
-0002aac0: 6e63 6c75 6465 2074 6865 206d 6973 7369  nclude the missi
-0002aad0: 6e67 2067 6170 730a 2020 2020 2020 2020  ng gaps.        
-0002aae0: 2020 2020 2320 4966 2077 6520 6861 7665      # If we have
-0002aaf0: 2045 4e44 504f 494e 545f 4120 2d2d 2d2d   ENDPOINT_A ----
-0002ab00: 3e20 4d56 5f50 4950 455f 4220 2d2d 2d2d  > MV_PIPE_B ----
-0002ab10: 2d3e 2044 4154 4153 4f55 5243 455f 4220  -> DATASOURCE_B 
-0002ab20: 2d2d 2d2d 2d2d 3e20 454e 4450 4f49 4e54  ------> ENDPOINT
-0002ab30: 5f43 0a20 2020 2020 2020 2020 2020 2023  _C.            #
-0002ab40: 2057 6865 7265 2065 6e64 706f 696e 7420   Where endpoint 
-0002ab50: 4120 6973 2062 6569 6e67 2075 7365 6420  A is being used 
-0002ab60: 696e 2074 6865 204d 565f 5049 5045 5f42  in the MV_PIPE_B
-0002ab70: 2c20 6966 2077 6520 6f6e 6c79 206d 6f64  , if we only mod
-0002ab80: 6966 7920 7468 6520 656e 6470 6f69 6e74  ify the endpoint
-0002ab90: 2041 0a20 2020 2020 2020 2020 2020 2023   A.            #
-0002aba0: 2054 6865 2064 6570 656e 6465 6e63 6965   The dependencie
-0002abb0: 7320 6772 6170 6820 7769 6c6c 206f 6e6c  s graph will onl
-0002abc0: 7920 636f 6e74 6169 6e20 7468 6520 656e  y contain the en
-0002abd0: 6470 6f69 6e74 2041 2061 6e64 2074 6865  dpoint A and the
-0002abe0: 204d 565f 5049 5045 5f42 2c20 6275 7420   MV_PIPE_B, but 
-0002abf0: 6e6f 7420 7468 6520 4441 5441 534f 5552  not the DATASOUR
-0002ac00: 4345 5f42 2061 6e64 2074 6865 2045 4e44  CE_B and the END
-0002ac10: 504f 494e 545f 430a 2020 2020 2020 2020  POINT_C.        
-0002ac20: 2020 2020 6772 6f75 7073 203d 205b 6772      groups = [gr
-0002ac30: 6f75 7020 666f 7220 6772 6f75 7020 696e  oup for group in
-0002ac40: 2074 6f70 6f73 6f72 7428 6465 7065 6e64   toposort(depend
-0002ac50: 656e 6369 6573 5f67 7261 7068 5f66 6f72  encies_graph_for
-0002ac60: 6b5f 646f 776e 7374 7265 616d 295d 0a20  k_downstream)]. 
-0002ac70: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
-0002ac80: 726f 7570 2069 6e20 6772 6f75 7073 3a0a  roup in groups:.
-0002ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aca0: 666f 7220 6e61 6d65 2069 6e20 6772 6f75  for name in grou
-0002acb0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0002acc0: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
-0002acd0: 6e20 7072 6f63 6573 7365 6420 6f72 206e  n processed or n
-0002ace0: 6f74 2069 735f 656e 6470 6f69 6e74 2872  ot is_endpoint(r
-0002acf0: 6573 6f75 7263 6573 5f74 6f5f 7275 6e5f  esources_to_run_
-0002ad00: 666f 726b 5f64 6f77 6e73 7472 6561 6d5b  fork_downstream[
-0002ad10: 6e61 6d65 5d29 3a0a 2020 2020 2020 2020  name]):.        
-0002ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad30: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0002ad40: 2020 2020 2020 2020 2020 2020 2020 656e                en
-0002ad50: 6470 6f69 6e74 735f 6465 705f 6d61 705b  dpoints_dep_map[
-0002ad60: 6e61 6d65 5d20 3d20 6465 7065 6e64 656e  name] = dependen
-0002ad70: 6369 6573 5f67 7261 7068 5f66 6f72 6b5f  cies_graph_fork_
-0002ad80: 646f 776e 7374 7265 616d 5b6e 616d 655d  downstream[name]
-0002ad90: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0002ada0: 4e6f 7720 7468 6174 2077 6520 6861 7665  Now that we have
-0002adb0: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
-0002adc0: 7320 6f66 2074 6865 2065 6e64 706f 696e  s of the endpoin
-0002add0: 7473 2c20 7765 206e 6565 6420 746f 2063  ts, we need to c
-0002ade0: 6865 636b 2074 6861 7420 7468 6520 7265  heck that the re
-0002adf0: 736f 7572 6365 7320 6861 7320 6e6f 7420  sources has not 
-0002ae00: 6265 656e 2064 6570 6c6f 7965 6420 7965  been deployed ye
-0002ae10: 7420 616e 6420 6f6e 6c79 2063 6172 6520  t and only care 
-0002ae20: 6162 6f75 7420 7468 6520 656e 6470 6f69  about the endpoi
-0002ae30: 6e74 7320 7468 6174 2064 6570 656e 6420  nts that depend 
-0002ae40: 6f6e 2065 6e64 706f 696e 7473 0a20 2020  on endpoints.   
-0002ae50: 2020 2020 2020 2020 2067 726f 7570 7320           groups 
-0002ae60: 3d20 5b67 726f 7570 2066 6f72 2067 726f  = [group for gro
-0002ae70: 7570 2069 6e20 746f 706f 736f 7274 2865  up in toposort(e
-0002ae80: 6e64 706f 696e 7473 5f64 6570 5f6d 6170  ndpoints_dep_map
-0002ae90: 295d 0a0a 2020 2020 2020 2020 2020 2020  )]..            
-0002aea0: 2320 4173 2077 6520 6861 7665 2075 7365  # As we have use
-0002aeb0: 6420 7468 6520 666f 726b 646f 776e 7374  d the forkdownst
-0002aec0: 7265 616d 2067 7261 7068 2074 6f20 6765  ream graph to ge
-0002aed0: 7420 7468 6520 6465 7065 6e64 656e 6369  t the dependenci
-0002aee0: 6573 206f 6620 7468 6520 656e 6470 6f69  es of the endpoi
-0002aef0: 6e74 732c 2077 6520 6861 7665 2061 6c6c  nts, we have all
-0002af00: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
-0002af10: 7320 6f66 2074 6865 2065 6e64 706f 696e  s of the endpoin
-0002af20: 7473 0a20 2020 2020 2020 2020 2020 2023  ts.            #
-0002af30: 2042 7574 2077 6520 6e65 6564 2074 6f20   But we need to 
-0002af40: 6465 706c 6f79 2074 6865 2065 6e64 706f  deploy the endpo
-0002af50: 696e 7473 2061 6e64 2074 6865 2064 6570  ints and the dep
-0002af60: 656e 6465 6e63 6965 7320 6f66 2074 6865  endencies of the
-0002af70: 2065 6e64 706f 696e 7473 2066 726f 6d20   endpoints from 
-0002af80: 6c65 6674 2074 6f20 7269 6768 740a 2020  left to right.  
-0002af90: 2020 2020 2020 2020 2020 2320 536f 2077            # So w
-0002afa0: 6520 6e65 6564 2074 6f20 7265 7665 7273  e need to revers
-0002afb0: 6520 7468 6520 6772 6f75 7073 0a20 2020  e the groups.   
-0002afc0: 2020 2020 2020 2020 2067 726f 7570 732e           groups.
-0002afd0: 7265 7665 7273 6528 290a 2020 2020 2020  reverse().      
-0002afe0: 2020 2020 2020 666f 7220 6772 6f75 7020        for group 
-0002aff0: 696e 2067 726f 7570 733a 0a20 2020 2020  in groups:.     
-0002b000: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-0002b010: 616d 6520 696e 2067 726f 7570 3a0a 2020  ame in group:.  
-0002b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b030: 2020 6966 206e 616d 6520 696e 2070 726f    if name in pro
-0002b040: 6365 7373 6564 206f 7220 6e6f 7420 6973  cessed or not is
-0002b050: 5f65 6e64 706f 696e 7428 7265 736f 7572  _endpoint(resour
-0002b060: 6365 735f 746f 5f72 756e 5f66 6f72 6b5f  ces_to_run_fork_
-0002b070: 646f 776e 7374 7265 616d 5b6e 616d 655d  downstream[name]
-0002b080: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002b090: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0002b0a0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0002b0b0: 2020 2020 2020 2020 2061 7761 6974 2070           await p
-0002b0c0: 7573 6828 0a20 2020 2020 2020 2020 2020  ush(.           
-0002b0d0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-0002b0e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002b0f0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-0002b100: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
-0002b110: 5f64 6f77 6e73 7472 6561 6d2c 0a20 2020  _downstream,.   
-0002b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b130: 2020 2020 2072 6573 6f75 7263 655f 7665       resource_ve
-0002b140: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
-0002b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b160: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
-0002b170: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
-0002b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b190: 2020 2020 6472 795f 7275 6e2c 0a20 2020      dry_run,.   
-0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1b0: 2020 2020 2066 6f72 6b5f 646f 776e 7374       fork_downst
-0002b1c0: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
-0002b1d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002b1e0: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
-0002b1f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002b200: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0002b210: 6f63 6573 7365 642e 6164 6428 6e61 6d65  ocessed.add(name
-0002b220: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0002b230: 204e 6f77 2077 6520 7368 6f75 6c64 2068   Now we should h
-0002b240: 6176 6520 7468 6520 656e 6470 6f69 6e74  ave the endpoint
-0002b250: 7320 616e 6420 6461 7461 736f 7572 6365  s and datasource
-0002b260: 7320 6465 706c 6f79 6564 2c20 7765 2063  s deployed, we c
-0002b270: 616e 2064 6570 6c6f 7920 7468 6520 7265  an deploy the re
-0002b280: 7374 206f 6620 7468 6520 7069 7065 7320  st of the pipes 
-0002b290: 2863 6f70 7920 2620 7369 6e6b 7329 0a20  (copy & sinks). 
-0002b2a0: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0002b2b0: 6e65 6564 2074 6f20 7265 6c79 206f 6e20  need to rely on 
-0002b2c0: 7468 6520 666f 726b 646f 776e 7374 7265  the forkdownstre
-0002b2d0: 616d 2067 7261 7068 2061 7320 6974 2063  am graph as it c
-0002b2e0: 6f6e 7461 696e 7320 616c 6c20 7468 6520  ontains all the 
-0002b2f0: 6d6f 6469 6669 6564 2070 6970 6573 2061  modified pipes a
-0002b300: 7320 7765 6c6c 2061 7320 7468 6520 6465  s well as the de
-0002b310: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
-0002b320: 6520 7069 7065 730a 2020 2020 2020 2020  e pipes.        
-0002b330: 2020 2020 2320 496e 2074 6869 7320 6361      # In this ca
-0002b340: 7365 2c20 7765 2064 6f6e 2774 206e 6565  se, we don't nee
-0002b350: 6420 746f 2067 656e 6572 6174 6520 6120  d to generate a 
-0002b360: 6e65 7720 6772 6170 6820 6173 2077 6520  new graph as we 
-0002b370: 6469 6420 666f 7220 7468 6520 656e 6470  did for the endp
-0002b380: 6f69 6e74 7320 6173 2074 6865 2070 6970  oints as the pip
-0002b390: 6573 2061 7265 206e 6f74 2067 6f69 6e67  es are not going
-0002b3a0: 2074 6f20 6265 2075 7365 6420 6173 2064   to be used as d
-0002b3b0: 6570 656e 6465 6e63 6965 7320 616e 6420  ependencies and 
-0002b3c0: 7468 6520 6461 7461 736f 7572 6365 7320  the datasources 
-0002b3d0: 6172 6520 616c 7265 6164 7920 6465 706c  are already depl
-0002b3e0: 6f79 6564 0a20 2020 2020 2020 2020 2020  oyed.           
-0002b3f0: 2067 726f 7570 7320 3d20 5b67 726f 7570   groups = [group
-0002b400: 2066 6f72 2067 726f 7570 2069 6e20 746f   for group in to
-0002b410: 706f 736f 7274 2864 6570 656e 6465 6e63  posort(dependenc
-0002b420: 6965 735f 6772 6170 685f 666f 726b 5f64  ies_graph_fork_d
-0002b430: 6f77 6e73 7472 6561 6d29 5d0a 2020 2020  ownstream)].    
-0002b440: 2020 2020 2020 2020 666f 7220 6772 6f75          for grou
-0002b450: 7020 696e 2067 726f 7570 733a 0a20 2020  p in groups:.   
-0002b460: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002b470: 206e 616d 6520 696e 2067 726f 7570 3a0a   name in group:.
-0002b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b490: 2020 2020 6966 206e 616d 6520 696e 2070      if name in p
-0002b4a0: 726f 6365 7373 6564 206f 7220 6973 5f6d  rocessed or is_m
-0002b4b0: 6174 6572 6961 6c69 7a65 6428 7265 736f  aterialized(reso
-0002b4c0: 7572 6365 735f 746f 5f72 756e 5f66 6f72  urces_to_run_for
-0002b4d0: 6b5f 646f 776e 7374 7265 616d 2e67 6574  k_downstream.get
-0002b4e0: 286e 616d 6529 293a 0a20 2020 2020 2020  (name)):.       
-0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b500: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0002b510: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002b520: 7761 6974 2070 7573 6828 0a20 2020 2020  wait push(.     
-0002b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b540: 2020 206e 616d 652c 0a20 2020 2020 2020     name,.       
-0002b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b560: 2072 6573 6f75 7263 6573 5f74 6f5f 7275   resources_to_ru
-0002b570: 6e5f 666f 726b 5f64 6f77 6e73 7472 6561  n_fork_downstrea
-0002b580: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-0002b590: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-0002b5a0: 7263 655f 7665 7273 696f 6e73 2c0a 2020  rce_versions,.  
-0002b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5c0: 2020 2020 2020 6c61 7465 7374 5f64 6174        latest_dat
-0002b5d0: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
-0002b5e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b5f0: 2020 2020 2020 2020 2020 6472 795f 7275            dry_ru
-0002b600: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0002b610: 2020 2020 2020 2020 2020 2066 6f72 6b5f             fork_
-0002b620: 646f 776e 7374 7265 616d 2c0a 2020 2020  downstream,.    
-0002b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b640: 2020 2020 666f 726b 2c0a 2020 2020 2020      fork,.      
-0002b650: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0002b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b670: 2020 2020 7072 6f63 6573 7365 642e 6164      processed.ad
-0002b680: 6428 6e61 6d65 290a 0a20 2020 2020 2020  d(name)..       
-0002b690: 2020 2020 2023 2046 696e 616c 6c79 2c20       # Finally, 
-0002b6a0: 7765 206e 6565 6420 746f 2064 6570 6c6f  we need to deplo
-0002b6b0: 7920 7468 6520 6d61 7465 7269 616c 697a  y the materializ
-0002b6c0: 6564 2076 6965 7773 2066 726f 6d20 7269  ed views from ri
-0002b6d0: 6768 7420 746f 206c 6566 742e 0a20 2020  ght to left..   
-0002b6e0: 2020 2020 2020 2020 2023 2057 6520 6e65           # We ne
-0002b6f0: 6564 2074 6f20 7265 6c79 206f 6e20 7468  ed to rely on th
-0002b700: 6520 666f 726b 646f 776e 7374 7265 616d  e forkdownstream
-0002b710: 2067 7261 7068 2061 7320 6974 2063 6f6e   graph as it con
-0002b720: 7461 696e 7320 616c 6c20 7468 6520 6d6f  tains all the mo
-0002b730: 6469 6669 6564 206d 6174 6572 6961 6c69  dified materiali
-0002b740: 7a65 6420 7669 6577 7320 6173 2077 656c  zed views as wel
-0002b750: 6c20 6173 2074 6865 2064 6570 656e 6465  l as the depende
-0002b760: 6e63 6965 7320 6f66 2074 6865 206d 6174  ncies of the mat
-0002b770: 6572 6961 6c69 7a65 6420 7669 6577 730a  erialized views.
-0002b780: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-0002b790: 2074 6869 7320 6361 7365 2c20 7765 2064   this case, we d
-0002b7a0: 6f6e 2774 206e 6565 6420 746f 2067 656e  on't need to gen
-0002b7b0: 6572 6174 6520 6120 6e65 7720 6772 6170  erate a new grap
-0002b7c0: 6820 6173 2077 6520 6469 6420 666f 7220  h as we did for 
-0002b7d0: 7468 6520 656e 6470 6f69 6e74 7320 6173  the endpoints as
-0002b7e0: 2074 6865 2070 6970 6573 2061 7265 206e   the pipes are n
-0002b7f0: 6f74 2067 6f69 6e67 2074 6f20 6265 2075  ot going to be u
-0002b800: 7365 6420 6173 2064 6570 656e 6465 6e63  sed as dependenc
-0002b810: 6965 7320 616e 6420 7468 6520 6461 7461  ies and the data
-0002b820: 736f 7572 6365 7320 6172 6520 616c 7265  sources are alre
-0002b830: 6164 7920 6465 706c 6f79 6564 0a20 2020  ady deployed.   
-0002b840: 2020 2020 2020 2020 2067 726f 7570 7320           groups 
-0002b850: 3d20 5b67 726f 7570 2066 6f72 2067 726f  = [group for gro
-0002b860: 7570 2069 6e20 746f 706f 736f 7274 2864  up in toposort(d
-0002b870: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
-0002b880: 685f 666f 726b 5f64 6f77 6e73 7472 6561  h_fork_downstrea
-0002b890: 6d29 5d0a 2020 2020 2020 2020 2020 2020  m)].            
-0002b8a0: 666f 7220 6772 6f75 7020 696e 2067 726f  for group in gro
-0002b8b0: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
-0002b8c0: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-0002b8d0: 2067 726f 7570 3a0a 2020 2020 2020 2020   group:.        
-0002b8e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002b8f0: 616d 6520 696e 2070 726f 6365 7373 6564  ame in processed
-0002b900: 206f 7220 6e6f 7420 6973 5f6d 6174 6572   or not is_mater
-0002b910: 6961 6c69 7a65 6428 7265 736f 7572 6365  ialized(resource
-0002b920: 735f 746f 5f72 756e 5f66 6f72 6b5f 646f  s_to_run_fork_do
-0002b930: 776e 7374 7265 616d 2e67 6574 286e 616d  wnstream.get(nam
-0002b940: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
-0002b950: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0002b960: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0002b970: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0002b980: 2070 7573 6828 0a20 2020 2020 2020 2020   push(.         
-0002b990: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002b9a0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002b9b0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0002b9c0: 6f75 7263 6573 5f74 6f5f 7275 6e5f 666f  ources_to_run_fo
-0002b9d0: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
-0002b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b9f0: 2020 2020 2020 2072 6573 6f75 7263 655f         resource_
-0002ba00: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
-0002ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba20: 2020 6c61 7465 7374 5f64 6174 6173 6f75    latest_datasou
-0002ba30: 7263 655f 7665 7273 696f 6e73 2c0a 2020  rce_versions,.  
-0002ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba50: 2020 2020 2020 6472 795f 7275 6e2c 0a20        dry_run,. 
-0002ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba70: 2020 2020 2020 2066 6f72 6b5f 646f 776e         fork_down
-0002ba80: 7374 7265 616d 2c0a 2020 2020 2020 2020  stream,.        
-0002ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002baa0: 666f 726b 2c0a 2020 2020 2020 2020 2020  fork,.          
-0002bab0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bad0: 7072 6f63 6573 7365 642e 6164 6428 6e61  processed.add(na
-0002bae0: 6d65 290a 0a20 2020 2069 6620 6465 706c  me)..    if depl
-0002baf0: 6f79 6d65 6e74 2e69 735f 6769 745f 7265  oyment.is_git_re
-0002bb00: 6c65 6173 653a 0a20 2020 2020 2020 2064  lease:.        d
-0002bb10: 6570 6c6f 796d 656e 742e 6465 706c 6f79  eployment.deploy
-0002bb20: 696e 675f 6472 795f 7275 6e28 290a 2020  ing_dry_run().  
-0002bb30: 2020 2020 2020 6177 6169 7420 7075 7368        await push
-0002bb40: 5f66 696c 6573 2864 6570 656e 6465 6e63  _files(dependenc
-0002bb50: 6965 735f 6772 6170 682c 2064 7279 5f72  ies_graph, dry_r
-0002bb60: 756e 3d54 7275 652c 2063 6865 636b 5f62  un=True, check_b
-0002bb70: 6163 6b66 696c 6c5f 7265 7175 6972 6564  ackfill_required
-0002bb80: 3d63 6865 636b 5f62 6163 6b66 696c 6c5f  =check_backfill_
-0002bb90: 7265 7175 6972 6564 290a 0a20 2020 2020  required)..     
-0002bba0: 2020 2061 7761 6974 2064 6570 6c6f 796d     await deploym
-0002bbb0: 656e 742e 6465 6c65 7465 5f72 6573 6f75  ent.delete_resou
-0002bbc0: 7263 6573 2864 656c 6574 6564 2c20 7069  rces(deleted, pi
-0002bbd0: 7065 732c 2064 7279 5f72 756e 3d54 7275  pes, dry_run=Tru
-0002bbe0: 6529 0a20 2020 2020 2020 2069 6620 6e6f  e).        if no
-0002bbf0: 7420 6465 706c 6f79 6d65 6e74 2e64 7279  t deployment.dry
-0002bc00: 5f72 756e 3a0a 2020 2020 2020 2020 2020  _run:.          
-0002bc10: 2020 6465 706c 6f79 6d65 6e74 2e64 6570    deployment.dep
-0002bc20: 6c6f 7969 6e67 2829 0a20 2020 2020 2020  loying().       
-0002bc30: 2020 2020 2061 7761 6974 2070 7573 685f       await push_
-0002bc40: 6669 6c65 7328 6465 7065 6e64 656e 6369  files(dependenci
-0002bc50: 6573 5f67 7261 7068 2c20 6472 795f 7275  es_graph, dry_ru
-0002bc60: 6e29 0a20 2020 2020 2020 2020 2020 2061  n).            a
-0002bc70: 7761 6974 2064 6570 6c6f 796d 656e 742e  wait deployment.
-0002bc80: 6465 6c65 7465 5f72 6573 6f75 7263 6573  delete_resources
-0002bc90: 2864 656c 6574 6564 2c20 7069 7065 7329  (deleted, pipes)
-0002bca0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002bcb0: 2020 2061 7761 6974 2070 7573 685f 6669     await push_fi
-0002bcc0: 6c65 7328 6465 7065 6e64 656e 6369 6573  les(dependencies
-0002bcd0: 5f67 7261 7068 2c20 6472 795f 7275 6e29  _graph, dry_run)
-0002bce0: 0a0a 2020 2020 6966 206e 6f74 2064 7279  ..    if not dry
-0002bcf0: 5f72 756e 2061 6e64 206e 6f74 2072 756e  _run and not run
-0002bd00: 5f74 6573 7473 3a0a 2020 2020 2020 2020  _tests:.        
-0002bd10: 6966 2075 706c 6f61 645f 6669 7874 7572  if upload_fixtur
-0002bd20: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002bd30: 636c 6963 6b2e 6563 686f 2846 6565 6462  click.echo(Feedb
-0002bd40: 6163 6b4d 616e 6167 6572 2e69 6e66 6f5f  ackManager.info_
-0002bd50: 7075 7368 696e 675f 6669 7874 7572 6573  pushing_fixtures
-0002bd60: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-0002bd70: 2023 2057 6520 6e65 6564 2074 6f20 7570   # We need to up
-0002bd80: 6c6f 6164 2074 6865 2066 6978 7475 7265  load the fixture
-0002bd90: 7320 6576 656e 2069 6620 7468 6572 6520  s even if there 
-0002bda0: 6973 206e 6f20 6368 616e 6765 0a20 2020  is no change.   
-0002bdb0: 2020 2020 2020 2020 2069 6620 6973 5f62           if is_b
-0002bdc0: 7261 6e63 683a 0a20 2020 2020 2020 2020  ranch:.         
-0002bdd0: 2020 2020 2020 2066 696c 656e 616d 6573         filenames
-0002bde0: 203d 2067 6574 5f70 726f 6a65 6374 5f66   = get_project_f
-0002bdf0: 696c 656e 616d 6573 2866 6f6c 6465 722c  ilenames(folder,
-0002be00: 2077 6974 685f 7665 6e64 6f72 3d54 7275   with_vendor=Tru
-0002be10: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0002be20: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
-0002be30: 6772 6170 6820 3d20 6177 6169 7420 6275  graph = await bu
-0002be40: 696c 645f 6772 6170 6828 0a20 2020 2020  ild_graph(.     
-0002be50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002be60: 696c 656e 616d 6573 2c0a 2020 2020 2020  ilenames,.      
-0002be70: 2020 2020 2020 2020 2020 2020 2020 7462                tb
-0002be80: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
-0002be90: 2020 2020 2020 2020 2020 2020 2064 6972               dir
-0002bea0: 5f70 6174 683d 666f 6c64 6572 2c0a 2020  _path=folder,.  
-0002beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bec0: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
-0002bed0: 6f6e 733d 6c61 7465 7374 5f64 6174 6173  ons=latest_datas
-0002bee0: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
-0002bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf00: 2020 2020 776f 726b 7370 6163 655f 6d61      workspace_ma
-0002bf10: 703d 776f 726b 7370 6163 655f 6d61 702c  p=workspace_map,
-0002bf20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bf30: 2020 2020 2070 726f 6365 7373 5f64 6570       process_dep
-0002bf40: 656e 6465 6e63 6965 733d 7075 7368 5f64  endencies=push_d
-0002bf50: 6570 732c 0a20 2020 2020 2020 2020 2020  eps,.           
-0002bf60: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-0002bf70: 3d76 6572 626f 7365 2c0a 2020 2020 2020  =verbose,.      
-0002bf80: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0002bf90: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
-0002bfa0: 733d 776f 726b 7370 6163 655f 6c69 625f  s=workspace_lib_
-0002bfb0: 7061 7468 732c 0a20 2020 2020 2020 2020  paths,.         
-0002bfc0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-0002bfd0: 6e74 5f77 733d 6375 7272 656e 745f 7773  nt_ws=current_ws
-0002bfe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bff0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0002c000: 2070 726f 6365 7373 6564 203d 2073 6574   processed = set
-0002c010: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
-0002c020: 6f72 2067 726f 7570 2069 6e20 746f 706f  or group in topo
-0002c030: 736f 7274 2864 6570 656e 6465 6e63 6965  sort(dependencie
-0002c040: 735f 6772 6170 682e 6465 705f 6d61 7029  s_graph.dep_map)
-0002c050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c060: 2020 666f 7220 6620 696e 2067 726f 7570    for f in group
-0002c070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c080: 2020 2020 2020 6e61 6d65 203d 206f 732e        name = os.
-0002c090: 7061 7468 2e62 6173 656e 616d 6528 6629  path.basename(f)
-0002c0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c0b0: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
-0002c0c0: 2069 6e20 7072 6f63 6573 7365 643a 0a20   in processed:. 
-0002c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0e0: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
-0002c0f0: 6e20 6465 7065 6e64 656e 6369 6573 5f67  n dependencies_g
-0002c100: 7261 7068 2e74 6f5f 7275 6e3a 0a20 2020  raph.to_run:.   
-0002c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c120: 2020 2020 2020 2020 2061 7761 6974 2063           await c
-0002c130: 6865 636b 5f66 6978 7475 7265 735f 6461  heck_fixtures_da
-0002c140: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
-0002c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c160: 2020 2020 7462 5f63 6c69 656e 742c 0a20      tb_client,. 
-0002c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c180: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002c190: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
-0002c1a0: 682e 746f 5f72 756e 5b6e 616d 655d 2c0a  h.to_run[name],.
-0002c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1d0: 6465 6275 672c 0a20 2020 2020 2020 2020  debug,.         
-0002c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1f0: 2020 2020 2020 2066 6f6c 6465 722c 0a20         folder,. 
-0002c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c210: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002c220: 6f72 6365 2c0a 2020 2020 2020 2020 2020  orce,.          
-0002c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c240: 2020 2020 2020 6d6f 6465 3d22 6170 7065        mode="appe
-0002c250: 6e64 2220 6966 2069 735f 6272 616e 6368  nd" if is_branch
-0002c260: 2065 6c73 6520 2272 6570 6c61 6365 222c   else "replace",
-0002c270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c280: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2a0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-0002c2b0: 7373 6564 2e61 6464 286e 616d 6529 0a20  ssed.add(name). 
-0002c2c0: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
-0002c2d0: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
-0002c2e0: 5f67 7261 7068 2e74 6f5f 7275 6e3a 0a20  _graph.to_run:. 
-0002c2f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002c300: 6620 6620 6e6f 7420 696e 2070 726f 6365  f f not in proce
-0002c310: 7373 6564 3a0a 2020 2020 2020 2020 2020  ssed:.          
-0002c320: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0002c330: 6368 6563 6b5f 6669 7874 7572 6573 5f64  check_fixtures_d
-0002c340: 6174 6128 0a20 2020 2020 2020 2020 2020  ata(.           
-0002c350: 2020 2020 2020 2020 2020 2020 2074 625f               tb_
-0002c360: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c380: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
-0002c390: 7068 2e74 6f5f 7275 6e5b 665d 2c0a 2020  ph.to_run[f],.  
-0002c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3b0: 2020 2020 2020 6465 6275 672c 0a20 2020        debug,.   
-0002c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3d0: 2020 2020 2066 6f6c 6465 722c 0a20 2020       folder,.   
-0002c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3f0: 2020 2020 2066 6f72 6365 2c0a 2020 2020       force,.    
-0002c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c410: 2020 2020 6d6f 6465 3d22 6170 7065 6e64      mode="append
-0002c420: 2220 6966 2069 735f 6272 616e 6368 2065  " if is_branch e
-0002c430: 6c73 6520 2272 6570 6c61 6365 222c 0a20  lse "replace",. 
-0002c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c450: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0002c460: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0002c470: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0002c480: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-0002c490: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
-0002c4a0: 6e61 6765 722e 696e 666f 5f6e 6f74 5f70  nager.info_not_p
-0002c4b0: 7573 6869 6e67 5f66 6978 7475 7265 7328  ushing_fixtures(
-0002c4c0: 2929 0a0a 2020 2020 6177 6169 7420 6465  ))..    await de
-0002c4d0: 706c 6f79 6d65 6e74 2e75 7064 6174 655f  ployment.update_
-0002c4e0: 7265 6c65 6173 6528 6861 735f 7365 6d76  release(has_semv
-0002c4f0: 6572 3d68 6173 5f73 656d 7665 722c 2072  er=has_semver, r
-0002c500: 656c 6561 7365 5f63 7265 6174 6564 3d72  elease_created=r
-0002c510: 656c 6561 7365 5f63 7265 6174 6564 290a  elease_created).
-0002c520: 0a20 2020 2072 6574 7572 6e20 6465 7065  .    return depe
-0002c530: 6e64 656e 6369 6573 5f67 7261 7068 2e74  ndencies_graph.t
-0002c540: 6f5f 7275 6e0a 0a0a 6173 796e 6320 6465  o_run...async de
-0002c550: 6620 6368 6563 6b5f 6669 7874 7572 6573  f check_fixtures
-0002c560: 5f64 6174 6128 0a20 2020 2063 6c69 656e  _data(.    clien
-0002c570: 743a 2054 696e 7942 2c20 7265 736f 7572  t: TinyB, resour
-0002c580: 6365 3a20 4469 6374 5b73 7472 2c20 416e  ce: Dict[str, An
-0002c590: 795d 2c20 6465 6275 673a 2062 6f6f 6c2c  y], debug: bool,
-0002c5a0: 2066 6f6c 6465 723a 2073 7472 203d 2022   folder: str = "
-0002c5b0: 222c 2066 6f72 6365 3a20 626f 6f6c 203d  ", force: bool =
-0002c5c0: 2046 616c 7365 2c20 6d6f 6465 3a20 7374   False, mode: st
-0002c5d0: 7220 3d20 2272 6570 6c61 6365 220a 293a  r = "replace".):
-0002c5e0: 0a20 2020 2069 6620 6465 6275 673a 0a20  .    if debug:. 
-0002c5f0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-0002c600: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-0002c610: 722e 696e 666f 5f63 6865 636b 696e 675f  r.info_checking_
-0002c620: 6669 6c65 2866 696c 653d 7070 2e70 666f  file(file=pp.pfo
-0002c630: 726d 6174 2872 6573 6f75 7263 6529 2929  rmat(resource)))
-0002c640: 0a20 2020 2069 6620 7265 736f 7572 6365  .    if resource
-0002c650: 5b22 7265 736f 7572 6365 225d 2069 6e20  ["resource"] in 
-0002c660: 5b22 7069 7065 7322 2c20 2274 6f6b 656e  ["pipes", "token
-0002c670: 7322 5d3a 0a20 2020 2020 2020 2070 6173  s"]:.        pas
-0002c680: 730a 2020 2020 656c 6966 2072 6573 6f75  s.    elif resou
-0002c690: 7263 655b 2272 6573 6f75 7263 6522 5d20  rce["resource"] 
-0002c6a0: 3d3d 2022 6461 7461 736f 7572 6365 7322  == "datasources"
-0002c6b0: 3a0a 2020 2020 2020 2020 6461 7461 736f  :.        dataso
-0002c6c0: 7572 6365 5f6e 616d 6520 3d20 7265 736f  urce_name = reso
-0002c6d0: 7572 6365 5b22 7061 7261 6d73 225d 5b22  urce["params"]["
-0002c6e0: 6e61 6d65 225d 0a20 2020 2020 2020 206e  name"].        n
-0002c6f0: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
-0002c700: 7365 6e61 6d65 2872 6573 6f75 7263 655b  sename(resource[
-0002c710: 2266 696c 656e 616d 6522 5d29 2e72 7370  "filename"]).rsp
-0002c720: 6c69 7428 222e 222c 2031 295b 305d 0a20  lit(".", 1)[0]. 
-0002c730: 2020 2020 2020 2066 6978 7475 7265 5f70         fixture_p
-0002c740: 6174 6820 3d20 5061 7468 2866 6f6c 6465  ath = Path(folde
-0002c750: 7229 202f 2022 6669 7874 7572 6573 2220  r) / "fixtures" 
-0002c760: 2f20 6622 7b6e 616d 657d 2e63 7376 220a  / f"{name}.csv".
-0002c770: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0002c780: 6669 7874 7572 655f 7061 7468 2e65 7869  fixture_path.exi
-0002c790: 7374 7328 293a 0a20 2020 2020 2020 2020  sts():.         
-0002c7a0: 2020 2066 6978 7475 7265 5f70 6174 6820     fixture_path 
-0002c7b0: 3d20 5061 7468 2866 6f6c 6465 7229 202f  = Path(folder) /
-0002c7c0: 2022 6461 7461 736f 7572 6365 7322 202f   "datasources" /
-0002c7d0: 2022 6669 7874 7572 6573 2220 2f20 6622   "fixtures" / f"
-0002c7e0: 7b6e 616d 657d 2e63 7376 220a 2020 2020  {name}.csv".    
-0002c7f0: 2020 2020 6966 206e 6f74 2066 6978 7475      if not fixtu
-0002c800: 7265 5f70 6174 682e 6578 6973 7473 2829  re_path.exists()
-0002c810: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-0002c820: 7874 7572 655f 7061 7468 203d 2050 6174  xture_path = Pat
-0002c830: 6828 666f 6c64 6572 2920 2f20 2264 6174  h(folder) / "dat
-0002c840: 6173 6f75 7263 6573 2220 2f20 2266 6978  asources" / "fix
-0002c850: 7475 7265 7322 202f 2066 227b 6e61 6d65  tures" / f"{name
-0002c860: 7d2e 6e64 6a73 6f6e 220a 2020 2020 2020  }.ndjson".      
-0002c870: 2020 6966 206e 6f74 2066 6978 7475 7265    if not fixture
-0002c880: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
-0002c890: 2020 2020 2020 2020 2020 2020 6669 7874              fixt
-0002c8a0: 7572 655f 7061 7468 203d 2050 6174 6828  ure_path = Path(
-0002c8b0: 666f 6c64 6572 2920 2f20 2264 6174 6173  folder) / "datas
-0002c8c0: 6f75 7263 6573 2220 2f20 2266 6978 7475  ources" / "fixtu
-0002c8d0: 7265 7322 202f 2066 227b 6e61 6d65 7d2e  res" / f"{name}.
-0002c8e0: 7061 7271 7565 7422 0a20 2020 2020 2020  parquet".       
-0002c8f0: 2069 6620 6669 7874 7572 655f 7061 7468   if fixture_path
-0002c900: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
-0002c910: 2020 2020 2020 2023 204c 6574 2773 2076         # Let's v
-0002c920: 616c 6964 6174 6520 6f6e 6c79 2077 6865  alidate only whe
-0002c930: 6e20 7768 656e 2077 6520 6172 6520 676f  n when we are go
-0002c940: 696e 6720 746f 2072 6570 6c61 6365 2074  ing to replace t
-0002c950: 6865 2061 6374 7561 6c20 6461 7461 0a20  he actual data. 
-0002c960: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-0002c970: 7420 3d20 6177 6169 7420 636c 6965 6e74  t = await client
-0002c980: 2e71 7565 7279 2873 716c 3d66 2253 454c  .query(sql=f"SEL
-0002c990: 4543 5420 636f 756e 7428 2920 6173 2063  ECT count() as c
-0002c9a0: 2046 524f 4d20 7b64 6174 6173 6f75 7263   FROM {datasourc
-0002c9b0: 655f 6e61 6d65 7d20 464f 524d 4154 204a  e_name} FORMAT J
-0002c9c0: 534f 4e22 290a 2020 2020 2020 2020 2020  SON").          
-0002c9d0: 2020 636f 756e 7420 3d20 7265 7375 6c74    count = result
-0002c9e0: 5b22 6461 7461 225d 5b30 5d5b 2263 225d  ["data"][0]["c"]
-0002c9f0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0002ca00: 2063 6f75 6e74 203e 2030 2061 6e64 206e   count > 0 and n
-0002ca10: 6f74 2066 6f72 6365 3a0a 2020 2020 2020  ot force:.      
-0002ca20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002ca30: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-0002ca40: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0002ca50: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0002ca60: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0002ca70: 7075 7368 5f66 6978 7475 7265 5f77 696c  push_fixture_wil
-0002ca80: 6c5f 7265 706c 6163 655f 6461 7461 2864  l_replace_data(d
-0002ca90: 6174 6173 6f75 7263 653d 6461 7461 736f  atasource=dataso
-0002caa0: 7572 6365 5f6e 616d 6529 0a20 2020 2020  urce_name).     
-0002cab0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0002cac0: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0002cad0: 6563 686f 280a 2020 2020 2020 2020 2020  echo(.          
-0002cae0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0002caf0: 6e61 6765 722e 696e 666f 5f63 6865 636b  nager.info_check
-0002cb00: 696e 675f 6669 6c65 5f73 697a 6528 0a20  ing_file_size(. 
-0002cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cb20: 2020 2066 696c 656e 616d 653d 7265 736f     filename=reso
-0002cb30: 7572 6365 5b22 6669 6c65 6e61 6d65 225d  urce["filename"]
-0002cb40: 2c20 7369 7a65 3d73 697a 656f 665f 666d  , size=sizeof_fm
-0002cb50: 7428 6f73 2e73 7461 7428 6669 7874 7572  t(os.stat(fixtur
-0002cb60: 655f 7061 7468 292e 7374 5f73 697a 6529  e_path).st_size)
-0002cb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cb80: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
-0002cb90: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
-0002cba0: 2e73 7464 6f75 742e 666c 7573 6828 290a  .stdout.flush().
-0002cbb0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0002cbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cbd0: 2061 7761 6974 2063 6c69 656e 742e 6461   await client.da
-0002cbe0: 7461 736f 7572 6365 5f61 7070 656e 645f  tasource_append_
-0002cbf0: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
-0002cc00: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
-0002cc10: 7572 6365 5f6e 616d 653d 7265 736f 7572  urce_name=resour
-0002cc20: 6365 5b22 7061 7261 6d73 225d 5b22 6e61  ce["params"]["na
-0002cc30: 6d65 225d 2c0a 2020 2020 2020 2020 2020  me"],.          
-0002cc40: 2020 2020 2020 2020 2020 6669 6c65 3d66            file=f
-0002cc50: 6978 7475 7265 5f70 6174 682c 0a20 2020  ixture_path,.   
-0002cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc70: 206d 6f64 653d 6d6f 6465 2c0a 2020 2020   mode=mode,.    
-0002cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc90: 666f 726d 6174 3d66 6978 7475 7265 5f70  format=fixture_p
-0002cca0: 6174 682e 7375 6666 6978 5b31 3a5d 2c0a  ath.suffix[1:],.
-0002ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ccc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002ccd0: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-0002cce0: 6462 6163 6b4d 616e 6167 6572 2e73 7563  dbackManager.suc
-0002ccf0: 6365 7373 5f70 726f 6365 7373 696e 675f  cess_processing_
-0002cd00: 6461 7461 2829 290a 2020 2020 2020 2020  data()).        
-0002cd10: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002cd20: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002cd30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002cd40: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-0002cd50: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
-0002cd60: 6e61 6765 722e 6572 726f 725f 7072 6f63  nager.error_proc
-0002cd70: 6573 7369 6e67 5f62 6c6f 636b 7328 6572  essing_blocks(er
-0002cd80: 726f 723d 6529 290a 0a20 2020 2020 2020  ror=e))..       
-0002cd90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002cda0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-0002cdb0: 6564 6261 636b 4d61 6e61 6765 722e 7761  edbackManager.wa
-0002cdc0: 726e 696e 675f 6669 7874 7572 655f 6e6f  rning_fixture_no
-0002cdd0: 745f 666f 756e 6428 6461 7461 736f 7572  t_found(datasour
-0002cde0: 6365 5f6e 616d 653d 6e61 6d65 2929 0a20  ce_name=name)). 
-0002cdf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002ce00: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-0002ce10: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-0002ce20: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-0002ce30: 725f 756e 6b6e 6f77 6e5f 7265 736f 7572  r_unknown_resour
-0002ce40: 6365 2872 6573 6f75 7263 653d 7265 736f  ce(resource=reso
-0002ce50: 7572 6365 5b22 7265 736f 7572 6365 225d  urce["resource"]
-0002ce60: 2929 0a0a 0a44 4154 4146 494c 455f 4e45  ))...DATAFILE_NE
-0002ce70: 575f 4c49 4e45 203d 2022 5c6e 220a 4441  W_LINE = "\n".DA
-0002ce80: 5441 4649 4c45 5f49 4e44 454e 5420 3d20  TAFILE_INDENT = 
-0002ce90: 2220 2220 2a20 340a 0a0a 6465 6620 666f  " " * 4...def fo
-0002cea0: 726d 6174 5f73 6368 656d 6128 6669 6c65  rmat_schema(file
-0002ceb0: 5f70 6172 7473 3a20 4c69 7374 5b73 7472  _parts: List[str
-0002cec0: 5d2c 206e 6f64 653a 2044 6963 745b 7374  ], node: Dict[st
-0002ced0: 722c 2041 6e79 5d29 202d 3e20 4c69 7374  r, Any]) -> List
-0002cee0: 5b73 7472 5d3a 0a20 2020 2069 6620 2273  [str]:.    if "s
-0002cef0: 6368 656d 6122 2069 6e20 6e6f 6465 2061  chema" in node a
-0002cf00: 6e64 206e 6f64 655b 2273 6368 656d 6122  nd node["schema"
-0002cf10: 5d3a 0a20 2020 2020 2020 2066 696c 655f  ]:.        file_
-0002cf20: 7061 7274 732e 6170 7065 6e64 2822 5343  parts.append("SC
-0002cf30: 4845 4d41 203e 2229 0a20 2020 2020 2020  HEMA >").       
-0002cf40: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002cf50: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
-0002cf60: 4c49 4e45 290a 2020 2020 2020 2020 636f  LINE).        co
-0002cf70: 6c75 6d6e 7320 3d20 7363 6865 6d61 5f74  lumns = schema_t
-0002cf80: 6f5f 7371 6c5f 636f 6c75 6d6e 7328 6e6f  o_sql_columns(no
-0002cf90: 6465 5b22 636f 6c75 6d6e 7322 5d29 0a20  de["columns"]). 
-0002cfa0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002cfb0: 732e 6170 7065 6e64 2866 222c 7b44 4154  s.append(f",{DAT
-0002cfc0: 4146 494c 455f 4e45 575f 4c49 4e45 7d22  AFILE_NEW_LINE}"
-0002cfd0: 2e6a 6f69 6e28 6d61 7028 6c61 6d62 6461  .join(map(lambda
-0002cfe0: 2078 3a20 6622 2020 2020 7b78 7d22 2c20   x: f"    {x}", 
-0002cff0: 636f 6c75 6d6e 7329 2929 0a20 2020 2020  columns))).     
-0002d000: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002d010: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
-0002d020: 575f 4c49 4e45 290a 2020 2020 2020 2020  W_LINE).        
-0002d030: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002d040: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
-0002d050: 494e 4529 0a0a 2020 2020 7265 7475 726e  INE)..    return
-0002d060: 2066 696c 655f 7061 7274 730a 0a0a 6465   file_parts...de
-0002d070: 6620 666f 726d 6174 5f69 6e64 6963 6573  f format_indices
-0002d080: 2866 696c 655f 7061 7274 733a 204c 6973  (file_parts: Lis
-0002d090: 745b 7374 725d 2c20 6e6f 6465 3a20 4469  t[str], node: Di
-0002d0a0: 6374 5b73 7472 2c20 416e 795d 2920 2d3e  ct[str, Any]) ->
-0002d0b0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-0002d0c0: 6966 2022 696e 6465 7865 7322 2069 6e20  if "indexes" in 
-0002d0d0: 6e6f 6465 2061 6e64 206e 6f64 655b 2269  node and node["i
-0002d0e0: 6e64 6578 6573 225d 3a0a 2020 2020 2020  ndexes"]:.      
-0002d0f0: 2020 696e 6465 7865 7320 3d20 6e6f 6465    indexes = node
-0002d100: 5b22 696e 6465 7865 7322 5d0a 2020 2020  ["indexes"].    
-0002d110: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002d120: 7070 656e 6428 2249 4e44 4558 4553 203e  ppend("INDEXES >
-0002d130: 2229 0a20 2020 2020 2020 2066 696c 655f  ").        file_
-0002d140: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
-0002d150: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
-0002d160: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002d170: 7473 2e61 7070 656e 6428 6622 7b44 4154  ts.append(f"{DAT
-0002d180: 4146 494c 455f 4e45 575f 4c49 4e45 7d22  AFILE_NEW_LINE}"
-0002d190: 2e6a 6f69 6e28 6d61 7028 6c61 6d62 6461  .join(map(lambda
-0002d1a0: 2069 6e64 6578 3a20 6622 2020 2020 7b69   index: f"    {i
-0002d1b0: 6e64 6578 2e74 6f5f 6461 7461 6669 6c65  ndex.to_datafile
-0002d1c0: 2829 7d22 2c20 696e 6465 7865 7329 2929  ()}", indexes)))
-0002d1d0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002d1e0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002d1f0: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002d200: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002d210: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-0002d220: 5f4e 4557 5f4c 494e 4529 0a0a 2020 2020  _NEW_LINE)..    
-0002d230: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
-0002d240: 730a 0a0a 6465 6620 666f 726d 6174 5f64  s...def format_d
-0002d250: 6174 615f 636f 6e6e 6563 746f 7228 6669  ata_connector(fi
-0002d260: 6c65 5f70 6172 7473 3a20 4c69 7374 5b73  le_parts: List[s
-0002d270: 7472 5d2c 206e 6f64 653a 2044 6963 745b  tr], node: Dict[
-0002d280: 7374 722c 2041 6e79 5d29 202d 3e20 4c69  str, Any]) -> Li
-0002d290: 7374 5b73 7472 5d3a 0a20 2020 206c 6c20  st[str]:.    ll 
-0002d2a0: 3d20 6c65 6e28 6669 6c65 5f70 6172 7473  = len(file_parts
-0002d2b0: 290a 2020 2020 7175 6f74 6573 203d 2022  ).    quotes = "
-0002d2c0: 2727 220a 2020 2020 5b66 696c 655f 7061  ''".    [file_pa
-0002d2d0: 7274 732e 6170 7065 6e64 2866 227b 6b2e  rts.append(f"{k.
-0002d2e0: 7570 7065 7228 297d 207b 7620 6f72 2071  upper()} {v or q
-0002d2f0: 756f 7465 737d 7b44 4154 4146 494c 455f  uotes}{DATAFILE_
-0002d300: 4e45 575f 4c49 4e45 7d22 2920 666f 7220  NEW_LINE}") for 
-0002d310: 6b2c 2076 2069 6e20 6e6f 6465 2e69 7465  k, v in node.ite
-0002d320: 6d73 2829 2069 6620 226b 6166 6b61 2220  ms() if "kafka" 
-0002d330: 696e 206b 5d20 2023 2074 7970 653a 2069  in k]  # type: i
-0002d340: 676e 6f72 650a 2020 2020 6966 206c 6c20  gnore.    if ll 
-0002d350: 3c20 6c65 6e28 6669 6c65 5f70 6172 7473  < len(file_parts
-0002d360: 293a 0a20 2020 2020 2020 2066 696c 655f  ):.        file_
-0002d370: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
-0002d380: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
-0002d390: 2020 2020 7265 7475 726e 2066 696c 655f      return file_
-0002d3a0: 7061 7274 730a 0a0a 6465 6620 666f 726d  parts...def form
-0002d3b0: 6174 5f69 6d70 6f72 745f 7365 7474 696e  at_import_settin
-0002d3c0: 6773 2866 696c 655f 7061 7274 733a 204c  gs(file_parts: L
-0002d3d0: 6973 745b 7374 725d 2c20 6e6f 6465 3a20  ist[str], node: 
-0002d3e0: 4469 6374 5b73 7472 2c20 416e 795d 2920  Dict[str, Any]) 
-0002d3f0: 2d3e 204c 6973 745b 7374 725d 3a0a 2020  -> List[str]:.  
-0002d400: 2020 6c6c 203d 206c 656e 2866 696c 655f    ll = len(file_
-0002d410: 7061 7274 7329 0a20 2020 205b 6669 6c65  parts).    [file
-0002d420: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
-0002d430: 7b6b 2e75 7070 6572 2829 7d20 7b76 7d7b  {k.upper()} {v}{
-0002d440: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
-0002d450: 457d 2229 2066 6f72 206b 2c20 7620 696e  E}") for k, v in
-0002d460: 206e 6f64 652e 6974 656d 7328 2920 6966   node.items() if
-0002d470: 2022 696d 706f 7274 5f22 2069 6e20 6b5d   "import_" in k]
-0002d480: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0002d490: 0a20 2020 2069 6620 6c6c 203c 206c 656e  .    if ll < len
-0002d4a0: 2866 696c 655f 7061 7274 7329 3a0a 2020  (file_parts):.  
-0002d4b0: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002d4c0: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-0002d4d0: 5f4e 4557 5f4c 494e 4529 0a20 2020 2072  _NEW_LINE).    r
-0002d4e0: 6574 7572 6e20 6669 6c65 5f70 6172 7473  eturn file_parts
-0002d4f0: 0a0a 0a64 6566 2066 6f72 6d61 745f 696e  ...def format_in
-0002d500: 636c 7564 6528 6669 6c65 5f70 6172 7473  clude(file_parts
-0002d510: 3a20 4c69 7374 5b73 7472 5d2c 2064 6f63  : List[str], doc
-0002d520: 3a20 4461 7461 6669 6c65 2c20 756e 726f  : Datafile, unro
-0002d530: 6c6c 5f69 6e63 6c75 6465 733a 2062 6f6f  ll_includes: boo
-0002d540: 6c20 3d20 4661 6c73 6529 202d 3e20 4c69  l = False) -> Li
-0002d550: 7374 5b73 7472 5d3a 0a20 2020 2069 6620  st[str]:.    if 
-0002d560: 756e 726f 6c6c 5f69 6e63 6c75 6465 733a  unroll_includes:
-0002d570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002d580: 6669 6c65 5f70 6172 7473 0a0a 2020 2020  file_parts..    
-0002d590: 6173 7365 7274 2064 6f63 2e72 6177 2069  assert doc.raw i
-0002d5a0: 7320 6e6f 7420 4e6f 6e65 0a0a 2020 2020  s not None..    
-0002d5b0: 696e 636c 7564 6520 3d20 5b6c 696e 6520  include = [line 
-0002d5c0: 666f 7220 6c69 6e65 2069 6e20 646f 632e  for line in doc.
-0002d5d0: 7261 7720 6966 2022 494e 434c 5544 4522  raw if "INCLUDE"
-0002d5e0: 2069 6e20 6c69 6e65 2061 6e64 2022 2e69   in line and ".i
-0002d5f0: 6e63 6c22 2069 6e20 6c69 6e65 5d0a 2020  ncl" in line].  
-0002d600: 2020 6966 206c 656e 2869 6e63 6c75 6465    if len(include
-0002d610: 293a 0a20 2020 2020 2020 2066 696c 655f  ):.        file_
-0002d620: 7061 7274 732e 6170 7065 6e64 2869 6e63  parts.append(inc
-0002d630: 6c75 6465 5b30 5d29 0a20 2020 2020 2020  lude[0]).       
-0002d640: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002d650: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
-0002d660: 4c49 4e45 290a 2020 2020 7265 7475 726e  LINE).    return
-0002d670: 2066 696c 655f 7061 7274 730a 0a0a 6173   file_parts...as
-0002d680: 796e 6320 6465 6620 666f 726d 6174 5f64  ync def format_d
-0002d690: 6174 6173 6f75 7263 6528 0a20 2020 2066  atasource(.    f
-0002d6a0: 696c 656e 616d 653a 2073 7472 2c0a 2020  ilename: str,.  
-0002d6b0: 2020 756e 726f 6c6c 5f69 6e63 6c75 6465    unroll_include
-0002d6c0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0002d6d0: 0a20 2020 2066 6f72 5f64 6966 663a 2062  .    for_diff: b
-0002d6e0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0002d6f0: 2063 6c69 656e 743a 204f 7074 696f 6e61   client: Optiona
-0002d700: 6c5b 5469 6e79 425d 203d 204e 6f6e 652c  l[TinyB] = None,
-0002d710: 0a20 2020 2072 6570 6c61 6365 5f69 6e63  .    replace_inc
-0002d720: 6c75 6465 733a 2062 6f6f 6c20 3d20 4661  ludes: bool = Fa
-0002d730: 6c73 652c 0a20 2020 2064 6174 6166 696c  lse,.    datafil
-0002d740: 653a 204f 7074 696f 6e61 6c5b 4461 7461  e: Optional[Data
-0002d750: 6669 6c65 5d20 3d20 4e6f 6e65 2c0a 2020  file] = None,.  
-0002d760: 2020 666f 725f 6465 706c 6f79 5f64 6966    for_deploy_dif
-0002d770: 663a 2062 6f6f 6c20 3d20 4661 6c73 652c  f: bool = False,
-0002d780: 0a20 2020 2073 6b69 705f 6576 616c 3a20  .    skip_eval: 
-0002d790: 626f 6f6c 203d 2046 616c 7365 2c0a 2920  bool = False,.) 
-0002d7a0: 2d3e 2073 7472 3a0a 2020 2020 6966 2064  -> str:.    if d
-0002d7b0: 6174 6166 696c 653a 0a20 2020 2020 2020  atafile:.       
-0002d7c0: 2064 6f63 203d 2064 6174 6166 696c 650a   doc = datafile.
-0002d7d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002d7e0: 2020 646f 6320 3d20 7061 7273 655f 6461    doc = parse_da
-0002d7f0: 7461 736f 7572 6365 2866 696c 656e 616d  tasource(filenam
-0002d800: 652c 2072 6570 6c61 6365 5f69 6e63 6c75  e, replace_inclu
-0002d810: 6465 733d 7265 706c 6163 655f 696e 636c  des=replace_incl
-0002d820: 7564 6573 2c20 736b 6970 5f65 7661 6c3d  udes, skip_eval=
-0002d830: 736b 6970 5f65 7661 6c29 0a0a 2020 2020  skip_eval)..    
-0002d840: 6669 6c65 5f70 6172 7473 3a20 4c69 7374  file_parts: List
-0002d850: 5b73 7472 5d20 3d20 5b5d 0a20 2020 2069  [str] = [].    i
-0002d860: 6620 666f 725f 6469 6666 3a0a 2020 2020  f for_diff:.    
-0002d870: 2020 2020 6973 5f6b 6166 6b61 203d 2022      is_kafka = "
-0002d880: 6b61 666b 615f 636f 6e6e 6563 7469 6f6e  kafka_connection
-0002d890: 5f6e 616d 6522 2069 6e20 646f 632e 6e6f  _name" in doc.no
-0002d8a0: 6465 735b 305d 0a20 2020 2020 2020 2069  des[0].        i
-0002d8b0: 6620 6973 5f6b 6166 6b61 3a0a 2020 2020  f is_kafka:.    
-0002d8c0: 2020 2020 2020 2020 6b61 666b 615f 6d65          kafka_me
-0002d8d0: 7461 6461 7461 5f63 6f6c 756d 6e73 203d  tadata_columns =
-0002d8e0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0002d8f0: 2020 2022 5f5f 7661 6c75 6522 2c0a 2020     "__value",.  
-0002d900: 2020 2020 2020 2020 2020 2020 2020 225f                "_
-0002d910: 5f68 6561 6465 7273 222c 0a20 2020 2020  _headers",.     
-0002d920: 2020 2020 2020 2020 2020 2022 5f5f 746f             "__to
-0002d930: 7069 6322 2c0a 2020 2020 2020 2020 2020  pic",.          
-0002d940: 2020 2020 2020 225f 5f70 6172 7469 7469        "__partiti
-0002d950: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-0002d960: 2020 2020 2022 5f5f 6f66 6673 6574 222c       "__offset",
-0002d970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d980: 2022 5f5f 7469 6d65 7374 616d 7022 2c0a   "__timestamp",.
-0002d990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d9a0: 225f 5f6b 6579 222c 0a20 2020 2020 2020  "__key",.       
-0002d9b0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-0002d9c0: 2020 2063 6f6c 756d 6e73 203d 205b 6320     columns = [c 
-0002d9d0: 666f 7220 6320 696e 2064 6f63 2e6e 6f64  for c in doc.nod
-0002d9e0: 6573 5b30 5d5b 2263 6f6c 756d 6e73 225d  es[0]["columns"]
-0002d9f0: 2069 6620 635b 226e 616d 6522 5d20 6e6f   if c["name"] no
-0002da00: 7420 696e 206b 6166 6b61 5f6d 6574 6164  t in kafka_metad
-0002da10: 6174 615f 636f 6c75 6d6e 735d 0a20 2020  ata_columns].   
-0002da20: 2020 2020 2020 2020 2064 6f63 2e6e 6f64           doc.nod
-0002da30: 6573 5b30 5d2e 7570 6461 7465 280a 2020  es[0].update(.  
-0002da40: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0002da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da60: 2020 2020 2263 6f6c 756d 6e73 223a 2063      "columns": c
-0002da70: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
-0002da80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0002da90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002daa0: 666f 726d 6174 5f76 6572 7369 6f6e 2866  format_version(f
-0002dab0: 696c 655f 7061 7274 732c 2064 6f63 290a  ile_parts, doc).
-0002dac0: 2020 2020 2020 2020 6966 2066 6f72 5f64          if for_d
-0002dad0: 6570 6c6f 795f 6469 6666 3a0a 2020 2020  eploy_diff:.    
-0002dae0: 2020 2020 2020 2020 666f 726d 6174 5f64          format_d
-0002daf0: 6573 6372 6970 7469 6f6e 2866 696c 655f  escription(file_
-0002db00: 7061 7274 732c 2064 6f63 290a 2020 2020  parts, doc).    
-0002db10: 2020 2020 666f 726d 6174 5f74 6f6b 656e      format_token
-0002db20: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
-0002db30: 6329 0a20 2020 2020 2020 2066 6f72 6d61  c).        forma
-0002db40: 745f 7363 6865 6d61 2866 696c 655f 7061  t_schema(file_pa
-0002db50: 7274 732c 2064 6f63 2e6e 6f64 6573 5b30  rts, doc.nodes[0
-0002db60: 5d29 0a20 2020 2020 2020 2066 6f72 6d61  ]).        forma
-0002db70: 745f 696e 6469 6365 7328 6669 6c65 5f70  t_indices(file_p
-0002db80: 6172 7473 2c20 646f 632e 6e6f 6465 735b  arts, doc.nodes[
-0002db90: 305d 290a 2020 2020 2020 2020 6177 6169  0]).        awai
-0002dba0: 7420 666f 726d 6174 5f65 6e67 696e 6528  t format_engine(
-0002dbb0: 6669 6c65 5f70 6172 7473 2c20 646f 632e  file_parts, doc.
-0002dbc0: 6e6f 6465 735b 305d 2c20 6f6e 6c79 5f74  nodes[0], only_t
-0002dbd0: 746c 3d54 7275 6520 6966 206e 6f74 2066  tl=True if not f
-0002dbe0: 6f72 5f64 6570 6c6f 795f 6469 6666 2065  or_deploy_diff e
-0002dbf0: 6c73 6520 4661 6c73 652c 2063 6c69 656e  lse False, clien
-0002dc00: 743d 636c 6965 6e74 290a 2020 2020 2020  t=client).      
-0002dc10: 2020 6966 2066 6f72 5f64 6570 6c6f 795f    if for_deploy_
-0002dc20: 6469 6666 3a0a 2020 2020 2020 2020 2020  diff:.          
-0002dc30: 2020 666f 726d 6174 5f69 6d70 6f72 745f    format_import_
-0002dc40: 7365 7474 696e 6773 2866 696c 655f 7061  settings(file_pa
-0002dc50: 7274 732c 2064 6f63 2e6e 6f64 6573 5b30  rts, doc.nodes[0
-0002dc60: 5d29 0a20 2020 2020 2020 2066 6f72 6d61  ]).        forma
-0002dc70: 745f 7368 6172 6564 5f77 6974 6828 6669  t_shared_with(fi
-0002dc80: 6c65 5f70 6172 7473 2c20 646f 6329 0a0a  le_parts, doc)..
-0002dc90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002dca0: 2020 666f 726d 6174 5f73 6f75 7263 6573    format_sources
-0002dcb0: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
-0002dcc0: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
-0002dcd0: 5f6d 6169 6e74 6169 6e65 7228 6669 6c65  _maintainer(file
-0002dce0: 5f70 6172 7473 2c20 646f 6329 0a20 2020  _parts, doc).   
-0002dcf0: 2020 2020 2066 6f72 6d61 745f 7665 7273       format_vers
-0002dd00: 696f 6e28 6669 6c65 5f70 6172 7473 2c20  ion(file_parts, 
-0002dd10: 646f 6329 0a20 2020 2020 2020 2066 6f72  doc).        for
-0002dd20: 6d61 745f 6465 7363 7269 7074 696f 6e28  mat_description(
-0002dd30: 6669 6c65 5f70 6172 7473 2c20 646f 6329  file_parts, doc)
-0002dd40: 0a20 2020 2020 2020 2066 6f72 6d61 745f  .        format_
-0002dd50: 746f 6b65 6e73 2866 696c 655f 7061 7274  tokens(file_part
-0002dd60: 732c 2064 6f63 290a 2020 2020 2020 2020  s, doc).        
-0002dd70: 666f 726d 6174 5f73 6368 656d 6128 6669  format_schema(fi
-0002dd80: 6c65 5f70 6172 7473 2c20 646f 632e 6e6f  le_parts, doc.no
-0002dd90: 6465 735b 305d 290a 2020 2020 2020 2020  des[0]).        
-0002dda0: 666f 726d 6174 5f69 6e64 6963 6573 2866  format_indices(f
-0002ddb0: 696c 655f 7061 7274 732c 2064 6f63 2e6e  ile_parts, doc.n
-0002ddc0: 6f64 6573 5b30 5d29 0a20 2020 2020 2020  odes[0]).       
-0002ddd0: 2061 7761 6974 2066 6f72 6d61 745f 656e   await format_en
-0002dde0: 6769 6e65 2866 696c 655f 7061 7274 732c  gine(file_parts,
-0002ddf0: 2064 6f63 2e6e 6f64 6573 5b30 5d29 0a20   doc.nodes[0]). 
-0002de00: 2020 2020 2020 2066 6f72 6d61 745f 696e         format_in
-0002de10: 636c 7564 6528 6669 6c65 5f70 6172 7473  clude(file_parts
-0002de20: 2c20 646f 632c 2075 6e72 6f6c 6c5f 696e  , doc, unroll_in
-0002de30: 636c 7564 6573 3d75 6e72 6f6c 6c5f 696e  cludes=unroll_in
-0002de40: 636c 7564 6573 290a 2020 2020 2020 2020  cludes).        
-0002de50: 666f 726d 6174 5f64 6174 615f 636f 6e6e  format_data_conn
-0002de60: 6563 746f 7228 6669 6c65 5f70 6172 7473  ector(file_parts
-0002de70: 2c20 646f 632e 6e6f 6465 735b 305d 290a  , doc.nodes[0]).
-0002de80: 2020 2020 2020 2020 666f 726d 6174 5f69          format_i
-0002de90: 6d70 6f72 745f 7365 7474 696e 6773 2866  mport_settings(f
-0002dea0: 696c 655f 7061 7274 732c 2064 6f63 2e6e  ile_parts, doc.n
-0002deb0: 6f64 6573 5b30 5d29 0a20 2020 2020 2020  odes[0]).       
-0002dec0: 2066 6f72 6d61 745f 7368 6172 6564 5f77   format_shared_w
-0002ded0: 6974 6828 6669 6c65 5f70 6172 7473 2c20  ith(file_parts, 
-0002dee0: 646f 6329 0a20 2020 2072 6573 756c 7420  doc).    result 
-0002def0: 3d20 2222 2e6a 6f69 6e28 6669 6c65 5f70  = "".join(file_p
-0002df00: 6172 7473 290a 2020 2020 7265 7375 6c74  arts).    result
-0002df10: 203d 2072 6573 756c 742e 7273 7472 6970   = result.rstrip
-0002df20: 2822 5c6e 2229 202b 2022 5c6e 220a 2020  ("\n") + "\n".  
-0002df30: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0002df40: 0a0a 6465 6620 666f 726d 6174 5f76 6572  ..def format_ver
-0002df50: 7369 6f6e 2866 696c 655f 7061 7274 733a  sion(file_parts:
-0002df60: 204c 6973 745b 7374 725d 2c20 646f 633a   List[str], doc:
-0002df70: 2044 6174 6166 696c 6529 202d 3e20 4c69   Datafile) -> Li
-0002df80: 7374 5b73 7472 5d3a 0a20 2020 2076 6572  st[str]:.    ver
-0002df90: 7369 6f6e 203d 2064 6f63 2e76 6572 7369  sion = doc.versi
-0002dfa0: 6f6e 2069 6620 646f 632e 7665 7273 696f  on if doc.versio
-0002dfb0: 6e20 6973 206e 6f74 204e 6f6e 6520 656c  n is not None el
-0002dfc0: 7365 2022 220a 2020 2020 6966 2076 6572  se "".    if ver
-0002dfd0: 7369 6f6e 2021 3d20 2222 3a0a 2020 2020  sion != "":.    
-0002dfe0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002dff0: 7070 656e 6428 6622 5645 5253 494f 4e20  ppend(f"VERSION 
-0002e000: 7b76 6572 7369 6f6e 7d22 290a 2020 2020  {version}").    
-0002e010: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002e020: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
-0002e030: 4557 5f4c 494e 4529 0a20 2020 2020 2020  EW_LINE).       
-0002e040: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002e050: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
-0002e060: 4c49 4e45 290a 2020 2020 7265 7475 726e  LINE).    return
-0002e070: 2066 696c 655f 7061 7274 730a 0a0a 6465   file_parts...de
-0002e080: 6620 666f 726d 6174 5f6d 6169 6e74 6169  f format_maintai
-0002e090: 6e65 7228 6669 6c65 5f70 6172 7473 3a20  ner(file_parts: 
-0002e0a0: 4c69 7374 5b73 7472 5d2c 2064 6f63 3a20  List[str], doc: 
-0002e0b0: 4461 7461 6669 6c65 2920 2d3e 204c 6973  Datafile) -> Lis
-0002e0c0: 745b 7374 725d 3a0a 2020 2020 6d61 696e  t[str]:.    main
-0002e0d0: 7461 696e 6572 203d 2064 6f63 2e6d 6169  tainer = doc.mai
-0002e0e0: 6e74 6169 6e65 7220 6966 2064 6f63 2e6d  ntainer if doc.m
-0002e0f0: 6169 6e74 6169 6e65 7220 6973 206e 6f74  aintainer is not
-0002e100: 204e 6f6e 6520 656c 7365 2022 220a 2020   None else "".  
-0002e110: 2020 6966 206d 6169 6e74 6169 6e65 723a    if maintainer:
-0002e120: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002e130: 7274 732e 6170 7065 6e64 2866 224d 4149  rts.append(f"MAI
-0002e140: 4e54 4149 4e45 5220 7b6d 6169 6e74 6169  NTAINER {maintai
-0002e150: 6e65 727d 2229 0a20 2020 2020 2020 2066  ner}").        f
-0002e160: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e170: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e180: 4e45 290a 2020 2020 2020 2020 6669 6c65  NE).        file
-0002e190: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
-0002e1a0: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
-0002e1b0: 0a20 2020 2072 6574 7572 6e20 6669 6c65  .    return file
-0002e1c0: 5f70 6172 7473 0a0a 0a64 6566 2066 6f72  _parts...def for
-0002e1d0: 6d61 745f 736f 7572 6365 7328 6669 6c65  mat_sources(file
-0002e1e0: 5f70 6172 7473 3a20 4c69 7374 5b73 7472  _parts: List[str
-0002e1f0: 5d2c 2064 6f63 3a20 4461 7461 6669 6c65  ], doc: Datafile
-0002e200: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
-0002e210: 2020 2020 666f 7220 736f 7572 6365 2069      for source i
-0002e220: 6e20 646f 632e 736f 7572 6365 733a 0a20  n doc.sources:. 
-0002e230: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002e240: 732e 6170 7065 6e64 2866 2253 4f55 5243  s.append(f"SOURC
-0002e250: 4520 7b73 6f75 7263 657d 2229 0a20 2020  E {source}").   
-0002e260: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
-0002e270: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
-0002e280: 4e45 575f 4c49 4e45 290a 2020 2020 7265  NEW_LINE).    re
-0002e290: 7475 726e 2066 696c 655f 7061 7274 730a  turn file_parts.
-0002e2a0: 0a0a 6465 6620 666f 726d 6174 5f64 6573  ..def format_des
-0002e2b0: 6372 6970 7469 6f6e 2866 696c 655f 7061  cription(file_pa
-0002e2c0: 7274 733a 204c 6973 745b 7374 725d 2c20  rts: List[str], 
-0002e2d0: 646f 633a 2041 6e79 2920 2d3e 204c 6973  doc: Any) -> Lis
-0002e2e0: 745b 7374 725d 3a0a 2020 2020 6465 7363  t[str]:.    desc
-0002e2f0: 7269 7074 696f 6e20 3d20 646f 632e 6465  ription = doc.de
-0002e300: 7363 7269 7074 696f 6e20 6966 2064 6f63  scription if doc
-0002e310: 2e64 6573 6372 6970 7469 6f6e 2069 7320  .description is 
-0002e320: 6e6f 7420 4e6f 6e65 2065 6c73 6520 2222  not None else ""
-0002e330: 0a20 2020 2069 6620 6465 7363 7269 7074  .    if descript
-0002e340: 696f 6e3a 0a20 2020 2020 2020 2066 696c  ion:.        fil
-0002e350: 655f 7061 7274 732e 6170 7065 6e64 2822  e_parts.append("
-0002e360: 4445 5343 5249 5054 494f 4e20 3e22 290a  DESCRIPTION >").
-0002e370: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002e380: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
-0002e390: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
-0002e3a0: 2020 2020 205b 6669 6c65 5f70 6172 7473       [file_parts
-0002e3b0: 2e61 7070 656e 6428 6622 7b44 4154 4146  .append(f"{DATAF
-0002e3c0: 494c 455f 494e 4445 4e54 7d7b 642e 7374  ILE_INDENT}{d.st
-0002e3d0: 7269 7028 297d 5c6e 2229 2066 6f72 2064  rip()}\n") for d
-0002e3e0: 2069 6e20 6465 7363 7269 7074 696f 6e2e   in description.
-0002e3f0: 7370 6c69 7428 4441 5441 4649 4c45 5f4e  split(DATAFILE_N
-0002e400: 4557 5f4c 494e 4529 2069 6620 642e 7374  EW_LINE) if d.st
-0002e410: 7269 7028 295d 2020 2320 7479 7065 3a20  rip()]  # type: 
-0002e420: 6967 6e6f 7265 0a20 2020 2020 2020 2066  ignore.        f
-0002e430: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e440: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e450: 4e45 290a 2020 2020 7265 7475 726e 2066  NE).    return f
-0002e460: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
-0002e470: 666f 726d 6174 5f74 6f6b 656e 7328 6669  format_tokens(fi
-0002e480: 6c65 5f70 6172 7473 3a20 4c69 7374 5b73  le_parts: List[s
-0002e490: 7472 5d2c 2064 6f63 3a20 4461 7461 6669  tr], doc: Datafi
-0002e4a0: 6c65 2920 2d3e 204c 6973 745b 7374 725d  le) -> List[str]
-0002e4b0: 3a0a 2020 2020 666f 7220 746f 6b65 6e20  :.    for token 
-0002e4c0: 696e 2064 6f63 2e74 6f6b 656e 733a 0a20  in doc.tokens:. 
-0002e4d0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002e4e0: 732e 6170 7065 6e64 2866 2754 4f4b 454e  s.append(f'TOKEN
-0002e4f0: 2022 7b74 6f6b 656e 5b22 746f 6b65 6e5f   "{token["token_
-0002e500: 6e61 6d65 225d 7d22 207b 746f 6b65 6e5b  name"]}" {token[
-0002e510: 2270 6572 6d69 7373 696f 6e73 225d 7d27  "permissions"]}'
-0002e520: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-0002e530: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
-0002e540: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
-0002e550: 2020 2069 6620 6c65 6e28 646f 632e 746f     if len(doc.to
-0002e560: 6b65 6e73 293a 0a20 2020 2020 2020 2066  kens):.        f
-0002e570: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e580: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e590: 4e45 290a 2020 2020 7265 7475 726e 2066  NE).    return f
-0002e5a0: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
-0002e5b0: 666f 726d 6174 5f6e 6f64 655f 7371 6c28  format_node_sql(
-0002e5c0: 0a20 2020 2066 696c 655f 7061 7274 733a  .    file_parts:
-0002e5d0: 204c 6973 745b 7374 725d 2c20 6e6f 6465   List[str], node
-0002e5e0: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
-0002e5f0: 2c20 6c69 6e65 5f6c 656e 6774 683a 204f  , line_length: O
-0002e600: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-0002e610: 6f6e 652c 206c 6f77 6572 5f6b 6579 776f  one, lower_keywo
-0002e620: 7264 733a 2062 6f6f 6c20 3d20 4661 6c73  rds: bool = Fals
-0002e630: 650a 2920 2d3e 204c 6973 745b 7374 725d  e.) -> List[str]
-0002e640: 3a0a 2020 2020 6669 6c65 5f70 6172 7473  :.    file_parts
-0002e650: 2e61 7070 656e 6428 2253 514c 203e 2229  .append("SQL >")
-0002e660: 0a20 2020 2066 696c 655f 7061 7274 732e  .    file_parts.
-0002e670: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
-0002e680: 4e45 575f 4c49 4e45 290a 2020 2020 6669  NEW_LINE).    fi
-0002e690: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002e6a0: 666f 726d 6174 5f73 716c 286e 6f64 655b  format_sql(node[
-0002e6b0: 2273 716c 225d 2c20 4441 5441 4649 4c45  "sql"], DATAFILE
-0002e6c0: 5f49 4e44 454e 542c 206c 696e 655f 6c65  _INDENT, line_le
-0002e6d0: 6e67 7468 3d6c 696e 655f 6c65 6e67 7468  ngth=line_length
-0002e6e0: 2c20 6c6f 7765 725f 6b65 7977 6f72 6473  , lower_keywords
-0002e6f0: 3d6c 6f77 6572 5f6b 6579 776f 7264 7329  =lower_keywords)
-0002e700: 290a 2020 2020 6669 6c65 5f70 6172 7473  ).    file_parts
-0002e710: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-0002e720: 5f4e 4557 5f4c 494e 4529 0a20 2020 2066  _NEW_LINE).    f
-0002e730: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e740: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e750: 4e45 290a 2020 2020 7265 7475 726e 2066  NE).    return f
-0002e760: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
-0002e770: 666f 726d 6174 5f73 6861 7265 645f 7769  format_shared_wi
-0002e780: 7468 2866 696c 655f 7061 7274 733a 204c  th(file_parts: L
-0002e790: 6973 745b 7374 725d 2c20 646f 633a 2044  ist[str], doc: D
-0002e7a0: 6174 6166 696c 6529 202d 3e20 4c69 7374  atafile) -> List
-0002e7b0: 5b73 7472 5d3a 0a20 2020 2069 6620 646f  [str]:.    if do
-0002e7c0: 632e 7368 6172 6564 5f77 6974 683a 0a20  c.shared_with:. 
-0002e7d0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002e7e0: 732e 6170 7065 6e64 2822 5348 4152 4544  s.append("SHARED
-0002e7f0: 5f57 4954 4820 3e22 290a 2020 2020 2020  _WITH >").      
-0002e800: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002e810: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
-0002e820: 5f4c 494e 4529 0a20 2020 2020 2020 2066  _LINE).        f
-0002e830: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e840: 2822 5c6e 222e 6a6f 696e 285b 6622 7b44  ("\n".join([f"{D
-0002e850: 4154 4146 494c 455f 494e 4445 4e54 7d7b  ATAFILE_INDENT}{
-0002e860: 776f 726b 7370 6163 655f 6e61 6d65 7d22  workspace_name}"
-0002e870: 2066 6f72 2077 6f72 6b73 7061 6365 5f6e   for workspace_n
-0002e880: 616d 6520 696e 2064 6f63 2e73 6861 7265  ame in doc.share
-0002e890: 645f 7769 7468 5d29 290a 2020 2020 7265  d_with])).    re
-0002e8a0: 7475 726e 2066 696c 655f 7061 7274 730a  turn file_parts.
-0002e8b0: 0a0a 6173 796e 6320 6465 6620 666f 726d  ..async def form
-0002e8c0: 6174 5f65 6e67 696e 6528 0a20 2020 2066  at_engine(.    f
-0002e8d0: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
-0002e8e0: 7374 725d 2c20 6e6f 6465 3a20 4469 6374  str], node: Dict
-0002e8f0: 5b73 7472 2c20 416e 795d 2c20 6f6e 6c79  [str, Any], only
-0002e900: 5f74 746c 3a20 626f 6f6c 203d 2046 616c  _ttl: bool = Fal
-0002e910: 7365 2c20 636c 6965 6e74 3a20 4f70 7469  se, client: Opti
-0002e920: 6f6e 616c 5b54 696e 7942 5d20 3d20 4e6f  onal[TinyB] = No
-0002e930: 6e65 0a29 202d 3e20 4c69 7374 5b73 7472  ne.) -> List[str
-0002e940: 5d3a 0a20 2020 2069 6620 6f6e 6c79 5f74  ]:.    if only_t
-0002e950: 746c 3a0a 2020 2020 2020 2020 6966 206e  tl:.        if n
-0002e960: 6f64 652e 6765 7428 2265 6e67 696e 6522  ode.get("engine"
-0002e970: 2c20 4e6f 6e65 293a 0a20 2020 2020 2020  , None):.       
-0002e980: 2020 2020 2066 6f72 2061 7267 2069 6e20       for arg in 
-0002e990: 736f 7274 6564 286e 6f64 655b 2265 6e67  sorted(node["eng
-0002e9a0: 696e 6522 5d2e 6765 7428 2261 7267 7322  ine"].get("args"
-0002e9b0: 2c20 5b5d 2929 3a0a 2020 2020 2020 2020  , [])):.        
-0002e9c0: 2020 2020 2020 2020 6966 2061 7267 5b30          if arg[0
-0002e9d0: 5d2e 7570 7065 7228 2920 3d3d 2022 5454  ].upper() == "TT
-0002e9e0: 4c22 3a0a 2020 2020 2020 2020 2020 2020  L":.            
-0002e9f0: 2020 2020 2020 2020 656c 656d 203d 2022          elem = "
-0002ea00: 2c20 222e 6a6f 696e 285b 782e 7374 7269  , ".join([x.stri
-0002ea10: 7028 2920 666f 7220 7820 696e 2061 7267  p() for x in arg
-0002ea20: 5b31 5d2e 7370 6c69 7428 222c 2229 5d29  [1].split(",")])
-0002ea30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ea40: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea60: 2020 6966 2063 6c69 656e 743a 0a20 2020    if client:.   
-0002ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea80: 2020 2020 2020 2020 2074 746c 5f73 716c           ttl_sql
-0002ea90: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-0002eaa0: 7371 6c5f 6765 745f 666f 726d 6174 2866  sql_get_format(f
-0002eab0: 2273 656c 6563 7420 7b65 6c65 6d7d 222c  "select {elem}",
-0002eac0: 2077 6974 685f 636c 6963 6b68 6f75 7365   with_clickhouse
-0002ead0: 5f66 6f72 6d61 743d 5472 7565 290a 2020  _format=True).  
-0002eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eaf0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0002eb00: 7465 645f 7474 6c20 3d20 7474 6c5f 7371  ted_ttl = ttl_sq
-0002eb10: 6c5b 373a 5d0a 2020 2020 2020 2020 2020  l[7:].          
-0002eb20: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002eb30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb50: 666f 726d 6174 7465 645f 7474 6c20 3d20  formatted_ttl = 
-0002eb60: 656c 656d 0a20 2020 2020 2020 2020 2020  elem.           
-0002eb70: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0002eb80: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-0002eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eba0: 2020 2066 6f72 6d61 7474 6564 5f74 746c     formatted_ttl
-0002ebb0: 203d 2065 6c65 6d0a 2020 2020 2020 2020   = elem.        
-0002ebc0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0002ebd0: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
-0002ebe0: 454e 4749 4e45 5f7b 6172 675b 305d 2e75  ENGINE_{arg[0].u
-0002ebf0: 7070 6572 2829 7d20 7b66 6f72 6d61 7474  pper()} {formatt
-0002ec00: 6564 5f74 746c 7d22 290a 2020 2020 2020  ed_ttl}").      
-0002ec10: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0002ec20: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002ec30: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
-0002ec40: 4529 0a20 2020 2020 2020 2020 2020 2066  E).            f
-0002ec50: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002ec60: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002ec70: 4e45 290a 2020 2020 2020 2020 7265 7475  NE).        retu
-0002ec80: 726e 2066 696c 655f 7061 7274 730a 2020  rn file_parts.  
-0002ec90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002eca0: 6966 206e 6f64 652e 6765 7428 2265 6e67  if node.get("eng
-0002ecb0: 696e 6522 2c20 4e6f 6e65 293a 0a20 2020  ine", None):.   
-0002ecc0: 2020 2020 2020 2020 2065 6d70 7479 203d           empty =
-0002ecd0: 2027 2222 270a 2020 2020 2020 2020 2020   '""'.          
-0002ece0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002ecf0: 656e 6428 6627 454e 4749 4e45 207b 6e6f  end(f'ENGINE {no
-0002ed00: 6465 5b22 656e 6769 6e65 225d 5b22 7479  de["engine"]["ty
-0002ed10: 7065 225d 7d27 2069 6620 6e6f 6465 2e67  pe"]}' if node.g
-0002ed20: 6574 2822 656e 6769 6e65 222c 207b 7d29  et("engine", {})
-0002ed30: 2e67 6574 2822 7479 7065 2229 2065 6c73  .get("type") els
-0002ed40: 6520 656d 7074 7929 0a20 2020 2020 2020  e empty).       
-0002ed50: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
-0002ed60: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
-0002ed70: 4e45 575f 4c49 4e45 290a 2020 2020 2020  NEW_LINE).      
-0002ed80: 2020 2020 2020 666f 7220 6172 6720 696e        for arg in
-0002ed90: 2073 6f72 7465 6428 6e6f 6465 5b22 656e   sorted(node["en
-0002eda0: 6769 6e65 225d 2e67 6574 2822 6172 6773  gine"].get("args
-0002edb0: 222c 205b 5d29 293a 0a20 2020 2020 2020  ", [])):.       
-0002edc0: 2020 2020 2020 2020 2065 6c65 6d20 3d20           elem = 
-0002edd0: 222c 2022 2e6a 6f69 6e28 5b78 2e73 7472  ", ".join([x.str
-0002ede0: 6970 2829 2066 6f72 2078 2069 6e20 6172  ip() for x in ar
-0002edf0: 675b 315d 2e73 706c 6974 2822 2c22 295d  g[1].split(",")]
-0002ee00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002ee10: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002ee20: 656e 6428 6622 454e 4749 4e45 5f7b 6172  end(f"ENGINE_{ar
-0002ee30: 675b 305d 2e75 7070 6572 2829 7d20 7b65  g[0].upper()} {e
-0002ee40: 6c65 6d20 6966 2065 6c65 6d20 656c 7365  lem if elem else
-0002ee50: 2065 6d70 7479 7d22 290a 2020 2020 2020   empty}").      
-0002ee60: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-0002ee70: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
-0002ee80: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
-0002ee90: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-0002eea0: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
-0002eeb0: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
-0002eec0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0002eed0: 696c 655f 7061 7274 730a 0a0a 6173 796e  ile_parts...asyn
-0002eee0: 6320 6465 6620 666f 726d 6174 5f6e 6f64  c def format_nod
-0002eef0: 655f 7479 7065 2866 696c 655f 7061 7274  e_type(file_part
-0002ef00: 733a 204c 6973 745b 7374 725d 2c20 6e6f  s: List[str], no
-0002ef10: 6465 3a20 4469 6374 5b73 7472 2c20 416e  de: Dict[str, An
-0002ef20: 795d 2920 2d3e 204c 6973 745b 7374 725d  y]) -> List[str]
-0002ef30: 3a0a 2020 2020 6e6f 6465 5f74 7970 6520  :.    node_type 
-0002ef40: 3d20 6e6f 6465 2e67 6574 2822 7479 7065  = node.get("type
-0002ef50: 222c 2022 2229 2e6c 6f77 6572 2829 0a20  ", "").lower(). 
-0002ef60: 2020 206e 6f64 655f 7479 7065 5f75 7070     node_type_upp
-0002ef70: 6572 203d 2066 2254 5950 4520 7b6e 6f64  er = f"TYPE {nod
-0002ef80: 655f 7479 7065 2e75 7070 6572 2829 7d22  e_type.upper()}"
-0002ef90: 0a0a 2020 2020 2320 4d61 7465 7269 616c  ..    # Material
-0002efa0: 697a 6564 2070 6970 650a 2020 2020 6966  ized pipe.    if
-0002efb0: 206e 6f64 655f 7479 7065 203d 3d20 5069   node_type == Pi
-0002efc0: 7065 4e6f 6465 5479 7065 732e 4d41 5445  peNodeTypes.MATE
-0002efd0: 5249 414c 495a 4544 3a0a 2020 2020 2020  RIALIZED:.      
-0002efe0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002eff0: 656e 6428 6e6f 6465 5f74 7970 655f 7570  end(node_type_up
-0002f000: 7065 7229 0a20 2020 2020 2020 2066 696c  per).        fil
-0002f010: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
-0002f020: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
-0002f030: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-0002f040: 6172 7473 2e61 7070 656e 6428 6627 4441  arts.append(f'DA
-0002f050: 5441 534f 5552 4345 207b 6e6f 6465 5b22  TASOURCE {node["
-0002f060: 6461 7461 736f 7572 6365 225d 7d27 290a  datasource"]}').
-0002f070: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002f080: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
-0002f090: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
-0002f0a0: 2020 2020 2061 7761 6974 2066 6f72 6d61       await forma
-0002f0b0: 745f 656e 6769 6e65 2866 696c 655f 7061  t_engine(file_pa
-0002f0c0: 7274 732c 206e 6f64 6529 0a0a 2020 2020  rts, node)..    
-0002f0d0: 2320 436f 7079 2070 6970 650a 2020 2020  # Copy pipe.    
-0002f0e0: 6966 206e 6f64 655f 7479 7065 203d 3d20  if node_type == 
-0002f0f0: 5069 7065 4e6f 6465 5479 7065 732e 434f  PipeNodeTypes.CO
-0002f100: 5059 3a0a 2020 2020 2020 2020 6669 6c65  PY:.        file
-0002f110: 5f70 6172 7473 2e61 7070 656e 6428 6e6f  _parts.append(no
-0002f120: 6465 5f74 7970 655f 7570 7065 7229 0a20  de_type_upper). 
-0002f130: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002f140: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002f150: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
-0002f160: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002f170: 7070 656e 6428 6627 5441 5247 4554 5f44  ppend(f'TARGET_D
-0002f180: 4154 4153 4f55 5243 4520 7b6e 6f64 655b  ATASOURCE {node[
-0002f190: 2274 6172 6765 745f 6461 7461 736f 7572  "target_datasour
-0002f1a0: 6365 225d 7d27 290a 2020 2020 2020 2020  ce"]}').        
-0002f1b0: 6966 2043 6f70 7950 6172 616d 6574 6572  if CopyParameter
-0002f1c0: 732e 434f 5059 5f53 4348 4544 554c 4520  s.COPY_SCHEDULE 
-0002f1d0: 696e 206e 6f64 6520 616e 6420 6e6f 6465  in node and node
-0002f1e0: 5b43 6f70 7950 6172 616d 6574 6572 732e  [CopyParameters.
-0002f1f0: 434f 5059 5f53 4348 4544 554c 455d 3a0a  COPY_SCHEDULE]:.
-0002f200: 2020 2020 2020 2020 2020 2020 6973 5f6f              is_o
-0002f210: 6e64 656d 616e 6420 3d20 6e6f 6465 5b43  ndemand = node[C
-0002f220: 6f70 7950 6172 616d 6574 6572 732e 434f  opyParameters.CO
-0002f230: 5059 5f53 4348 4544 554c 455d 2e6c 6f77  PY_SCHEDULE].low
-0002f240: 6572 2829 203d 3d20 4f4e 5f44 454d 414e  er() == ON_DEMAN
-0002f250: 440a 2020 2020 2020 2020 2020 2020 6669  D.            fi
-0002f260: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002f270: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
-0002f280: 4529 0a20 2020 2020 2020 2020 2020 2066  E).            f
-0002f290: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002f2a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002f2b0: 2020 6622 7b43 6f70 7950 6172 616d 6574    f"{CopyParamet
-0002f2c0: 6572 732e 434f 5059 5f53 4348 4544 554c  ers.COPY_SCHEDUL
-0002f2d0: 452e 7570 7065 7228 297d 207b 4f4e 5f44  E.upper()} {ON_D
-0002f2e0: 454d 414e 4420 6966 2069 735f 6f6e 6465  EMAND if is_onde
-0002f2f0: 6d61 6e64 2065 6c73 6520 6e6f 6465 5b43  mand else node[C
-0002f300: 6f70 7950 6172 616d 6574 6572 732e 434f  opyParameters.CO
-0002f310: 5059 5f53 4348 4544 554c 455d 7d22 0a20  PY_SCHEDULE]}". 
-0002f320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002f330: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002f340: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002f350: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002f360: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
-0002f370: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002f380: 7473 2e61 7070 656e 6428 6622 7b43 6f70  ts.append(f"{Cop
-0002f390: 7950 6172 616d 6574 6572 732e 434f 5059  yParameters.COPY
-0002f3a0: 5f53 4348 4544 554c 452e 7570 7065 7228  _SCHEDULE.upper(
-0002f3b0: 297d 207b 4f4e 5f44 454d 414e 447d 2229  )} {ON_DEMAND}")
-0002f3c0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002f3d0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002f3e0: 494c 455f 4e45 575f 4c49 4e45 290a 0a20  ILE_NEW_LINE).. 
-0002f3f0: 2020 2023 2053 696e 6b20 7069 7065 0a20     # Sink pipe. 
-0002f400: 2020 2069 6620 4578 706f 7274 5265 706c     if ExportRepl
-0002f410: 6163 656d 656e 7473 2e69 735f 6578 706f  acements.is_expo
-0002f420: 7274 5f6e 6f64 6528 6e6f 6465 293a 0a20  rt_node(node):. 
-0002f430: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002f440: 732e 6170 7065 6e64 286e 6f64 655f 7479  s.append(node_ty
-0002f450: 7065 5f75 7070 6572 290a 2020 2020 2020  pe_upper).      
-0002f460: 2020 6578 706f 7274 5f70 6172 616d 7320    export_params 
-0002f470: 3d20 4578 706f 7274 5265 706c 6163 656d  = ExportReplacem
-0002f480: 656e 7473 2e67 6574 5f70 6172 616d 735f  ents.get_params_
-0002f490: 6672 6f6d 5f64 6174 6166 696c 6528 6e6f  from_datafile(no
-0002f4a0: 6465 290a 2020 2020 2020 2020 6669 6c65  de).        file
-0002f4b0: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
-0002f4c0: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
-0002f4d0: 0a20 2020 2020 2020 2066 6f72 2070 6172  .        for par
-0002f4e0: 616d 2c20 7661 6c75 6520 696e 2065 7870  am, value in exp
-0002f4f0: 6f72 745f 7061 7261 6d73 2e69 7465 6d73  ort_params.items
-0002f500: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002f510: 6966 2070 6172 616d 203d 3d20 2273 6368  if param == "sch
-0002f520: 6564 756c 655f 6372 6f6e 2220 616e 6420  edule_cron" and 
-0002f530: 6e6f 7420 7661 6c75 653a 0a20 2020 2020  not value:.     
-0002f540: 2020 2020 2020 2020 2020 2076 616c 7565             value
-0002f550: 203d 204f 4e5f 4445 4d41 4e44 0a20 2020   = ON_DEMAND.   
-0002f560: 2020 2020 2020 2020 2064 6174 6166 696c           datafil
-0002f570: 655f 6b65 7920 3d20 4578 706f 7274 5265  e_key = ExportRe
-0002f580: 706c 6163 656d 656e 7473 2e67 6574 5f64  placements.get_d
-0002f590: 6174 6166 696c 655f 6b65 7928 7061 7261  atafile_key(para
-0002f5a0: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
-0002f5b0: 6620 6461 7461 6669 6c65 5f6b 6579 3a0a  f datafile_key:.
-0002f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5d0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002f5e0: 6428 6622 7b64 6174 6166 696c 655f 6b65  d(f"{datafile_ke
-0002f5f0: 797d 207b 7661 6c75 657d 2229 0a20 2020  y} {value}").   
-0002f600: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0002f610: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
-0002f620: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
-0002f630: 290a 0a20 2020 2072 6574 7572 6e20 6669  )..    return fi
-0002f640: 6c65 5f70 6172 7473 0a0a 0a64 6566 2066  le_parts...def f
-0002f650: 6f72 6d61 745f 7069 7065 5f69 6e63 6c75  ormat_pipe_inclu
-0002f660: 6465 2866 696c 655f 7061 7274 733a 204c  de(file_parts: L
-0002f670: 6973 745b 7374 725d 2c20 6e6f 6465 3a20  ist[str], node: 
-0002f680: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
-0002f690: 696e 636c 7564 6573 3a20 4469 6374 5b73  includes: Dict[s
-0002f6a0: 7472 2c20 416e 795d 2920 2d3e 204c 6973  tr, Any]) -> Lis
-0002f6b0: 745b 7374 725d 3a0a 2020 2020 6966 2069  t[str]:.    if i
-0002f6c0: 6e63 6c75 6465 733a 0a20 2020 2020 2020  ncludes:.       
-0002f6d0: 2066 6f72 206b 2c20 7620 696e 2069 6e63   for k, v in inc
-0002f6e0: 6c75 6465 732e 636f 7079 2829 2e69 7465  ludes.copy().ite
-0002f6f0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0002f700: 2020 6966 206e 6f64 655b 226e 616d 6522    if node["name"
-0002f710: 5d20 696e 2076 3a0a 2020 2020 2020 2020  ] in v:.        
-0002f720: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002f730: 7473 2e61 7070 656e 6428 6622 494e 434c  ts.append(f"INCL
-0002f740: 5544 4520 7b6b 7d22 290a 2020 2020 2020  UDE {k}").      
-0002f750: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-0002f760: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
-0002f770: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
-0002f780: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002f790: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002f7a0: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002f7b0: 4e45 290a 2020 2020 2020 2020 2020 2020  NE).            
-0002f7c0: 2020 2020 6465 6c20 696e 636c 7564 6573      del includes
-0002f7d0: 5b6b 5d0a 2020 2020 7265 7475 726e 2066  [k].    return f
-0002f7e0: 696c 655f 7061 7274 730a 0a0a 6173 796e  ile_parts...asyn
-0002f7f0: 6320 6465 6620 666f 726d 6174 5f6e 6f64  c def format_nod
-0002f800: 6528 0a20 2020 2066 696c 655f 7061 7274  e(.    file_part
-0002f810: 733a 204c 6973 745b 7374 725d 2c0a 2020  s: List[str],.  
-0002f820: 2020 6e6f 6465 3a20 4469 6374 5b73 7472    node: Dict[str
-0002f830: 2c20 416e 795d 2c0a 2020 2020 696e 636c  , Any],.    incl
-0002f840: 7564 6573 3a20 4469 6374 5b73 7472 2c20  udes: Dict[str, 
-0002f850: 416e 795d 2c0a 2020 2020 6c69 6e65 5f6c  Any],.    line_l
-0002f860: 656e 6774 683a 204f 7074 696f 6e61 6c5b  ength: Optional[
-0002f870: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
-0002f880: 2075 6e72 6f6c 6c5f 696e 636c 7564 6573   unroll_includes
-0002f890: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-0002f8a0: 2020 2020 6c6f 7765 725f 6b65 7977 6f72      lower_keywor
-0002f8b0: 6473 3a20 626f 6f6c 203d 2046 616c 7365  ds: bool = False
-0002f8c0: 2c0a 2920 2d3e 204e 6f6e 653a 0a20 2020  ,.) -> None:.   
-0002f8d0: 2069 6620 6e6f 7420 756e 726f 6c6c 5f69   if not unroll_i
-0002f8e0: 6e63 6c75 6465 733a 0a20 2020 2020 2020  ncludes:.       
-0002f8f0: 2066 6f72 6d61 745f 7069 7065 5f69 6e63   format_pipe_inc
-0002f900: 6c75 6465 2866 696c 655f 7061 7274 732c  lude(file_parts,
-0002f910: 206e 6f64 652c 2069 6e63 6c75 6465 7329   node, includes)
-0002f920: 0a20 2020 2069 7465 6d20 3d20 5b6b 2066  .    item = [k f
-0002f930: 6f72 206b 2c20 5f20 696e 2069 6e63 6c75  or k, _ in inclu
-0002f940: 6465 732e 6974 656d 7328 2920 6966 206e  des.items() if n
-0002f950: 6f64 655b 226e 616d 6522 5d2e 7374 7269  ode["name"].stri
-0002f960: 7028 2920 696e 206b 5d0a 2020 2020 6966  p() in k].    if
-0002f970: 2069 7465 6d20 616e 6420 6e6f 7420 756e   item and not un
-0002f980: 726f 6c6c 5f69 6e63 6c75 6465 733a 0a20  roll_includes:. 
-0002f990: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-0002f9a0: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002f9b0: 7065 6e64 2866 274e 4f44 4520 7b6e 6f64  pend(f'NODE {nod
-0002f9c0: 655b 226e 616d 6522 5d2e 7374 7269 7028  e["name"].strip(
-0002f9d0: 297d 2729 0a20 2020 2066 696c 655f 7061  )}').    file_pa
-0002f9e0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002f9f0: 494c 455f 4e45 575f 4c49 4e45 290a 0a20  ILE_NEW_LINE).. 
-0002fa00: 2020 2066 726f 6d20 636f 6c6c 6563 7469     from collecti
-0002fa10: 6f6e 7320 696d 706f 7274 206e 616d 6564  ons import named
-0002fa20: 7475 706c 650a 0a20 2020 2044 6f63 203d  tuple..    Doc =
-0002fa30: 206e 616d 6564 7475 706c 6528 2244 6f63   namedtuple("Doc
-0002fa40: 222c 205b 2264 6573 6372 6970 7469 6f6e  ", ["description
-0002fa50: 225d 290a 2020 2020 666f 726d 6174 5f64  "]).    format_d
-0002fa60: 6573 6372 6970 7469 6f6e 2866 696c 655f  escription(file_
-0002fa70: 7061 7274 732c 2044 6f63 286e 6f64 652e  parts, Doc(node.
-0002fa80: 6765 7428 2264 6573 6372 6970 7469 6f6e  get("description
-0002fa90: 222c 2022 2229 2929 0a20 2020 2066 6f72  ", ""))).    for
-0002faa0: 6d61 745f 6e6f 6465 5f73 716c 2866 696c  mat_node_sql(fil
-0002fab0: 655f 7061 7274 732c 206e 6f64 652c 206c  e_parts, node, l
-0002fac0: 696e 655f 6c65 6e67 7468 3d6c 696e 655f  ine_length=line_
-0002fad0: 6c65 6e67 7468 2c20 6c6f 7765 725f 6b65  length, lower_ke
-0002fae0: 7977 6f72 6473 3d6c 6f77 6572 5f6b 6579  ywords=lower_key
-0002faf0: 776f 7264 7329 0a20 2020 2061 7761 6974  words).    await
-0002fb00: 2066 6f72 6d61 745f 6e6f 6465 5f74 7970   format_node_typ
-0002fb10: 6528 6669 6c65 5f70 6172 7473 2c20 6e6f  e(file_parts, no
-0002fb20: 6465 290a 0a0a 6173 796e 6320 6465 6620  de)...async def 
-0002fb30: 666f 726d 6174 5f70 6970 6528 0a20 2020  format_pipe(.   
-0002fb40: 2066 696c 656e 616d 653a 2073 7472 2c0a   filename: str,.
-0002fb50: 2020 2020 6c69 6e65 5f6c 656e 6774 683a      line_length:
-0002fb60: 204f 7074 696f 6e61 6c5b 696e 745d 2c0a   Optional[int],.
-0002fb70: 2020 2020 756e 726f 6c6c 5f69 6e63 6c75      unroll_inclu
-0002fb80: 6465 733a 2062 6f6f 6c20 3d20 4661 6c73  des: bool = Fals
-0002fb90: 652c 0a20 2020 2072 6570 6c61 6365 5f69  e,.    replace_i
-0002fba0: 6e63 6c75 6465 733a 2062 6f6f 6c20 3d20  ncludes: bool = 
-0002fbb0: 4661 6c73 652c 0a20 2020 2064 6174 6166  False,.    dataf
-0002fbc0: 696c 653a 204f 7074 696f 6e61 6c5b 4461  ile: Optional[Da
-0002fbd0: 7461 6669 6c65 5d20 3d20 4e6f 6e65 2c0a  tafile] = None,.
-0002fbe0: 2020 2020 666f 725f 6465 706c 6f79 5f64      for_deploy_d
-0002fbf0: 6966 663a 2062 6f6f 6c20 3d20 4661 6c73  iff: bool = Fals
-0002fc00: 652c 0a20 2020 2073 6b69 705f 6576 616c  e,.    skip_eval
-0002fc10: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-0002fc20: 2920 2d3e 2073 7472 3a0a 2020 2020 6966  ) -> str:.    if
-0002fc30: 2064 6174 6166 696c 653a 0a20 2020 2020   datafile:.     
-0002fc40: 2020 2064 6f63 203d 2064 6174 6166 696c     doc = datafil
-0002fc50: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-0002fc60: 2020 2020 646f 6320 3d20 7061 7273 655f      doc = parse_
-0002fc70: 7069 7065 2866 696c 656e 616d 652c 2072  pipe(filename, r
-0002fc80: 6570 6c61 6365 5f69 6e63 6c75 6465 733d  eplace_includes=
-0002fc90: 7265 706c 6163 655f 696e 636c 7564 6573  replace_includes
-0002fca0: 2c20 736b 6970 5f65 7661 6c3d 736b 6970  , skip_eval=skip
-0002fcb0: 5f65 7661 6c29 0a0a 2020 2020 6669 6c65  _eval)..    file
-0002fcc0: 5f70 6172 7473 3a20 4c69 7374 5b73 7472  _parts: List[str
-0002fcd0: 5d20 3d20 5b5d 0a20 2020 2066 6f72 6d61  ] = [].    forma
-0002fce0: 745f 736f 7572 6365 7328 6669 6c65 5f70  t_sources(file_p
-0002fcf0: 6172 7473 2c20 646f 6329 0a20 2020 2066  arts, doc).    f
-0002fd00: 6f72 6d61 745f 6d61 696e 7461 696e 6572  ormat_maintainer
-0002fd10: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
-0002fd20: 290a 2020 2020 666f 726d 6174 5f76 6572  ).    format_ver
-0002fd30: 7369 6f6e 2866 696c 655f 7061 7274 732c  sion(file_parts,
-0002fd40: 2064 6f63 290a 2020 2020 666f 726d 6174   doc).    format
-0002fd50: 5f64 6573 6372 6970 7469 6f6e 2866 696c  _description(fil
-0002fd60: 655f 7061 7274 732c 2064 6f63 290a 2020  e_parts, doc).  
-0002fd70: 2020 666f 726d 6174 5f74 6f6b 656e 7328    format_tokens(
-0002fd80: 6669 6c65 5f70 6172 7473 2c20 646f 6329  file_parts, doc)
-0002fd90: 0a20 2020 2069 6620 646f 632e 696e 636c  .    if doc.incl
-0002fda0: 7564 6573 2061 6e64 206e 6f74 2075 6e72  udes and not unr
-0002fdb0: 6f6c 6c5f 696e 636c 7564 6573 3a0a 2020  oll_includes:.  
-0002fdc0: 2020 2020 2020 666f 7220 6b20 696e 2064        for k in d
-0002fdd0: 6f63 2e69 6e63 6c75 6465 733a 0a20 2020  oc.includes:.   
-0002fde0: 2020 2020 2020 2020 2023 2057 6520 6669           # We fi
-0002fdf0: 6c74 6572 206f 6e6c 7920 7468 6520 696e  lter only the in
-0002fe00: 636c 7564 6520 6669 6c65 7320 6173 2077  clude files as w
-0002fe10: 6520 6375 7272 656e 746c 7920 6861 7665  e currently have
-0002fe20: 2032 2069 7465 6d73 2066 6f72 2065 6163   2 items for eac
-0002fe30: 6820 696e 636c 7564 650a 2020 2020 2020  h include.      
-0002fe40: 2020 2020 2020 2320 7b20 2769 6e63 6c75        # { 'inclu
-0002fe50: 6465 5f66 696c 652e 696e 636c 273a 2027  de_file.incl': '
-0002fe60: 4669 7273 7420 6e6f 6465 206f 6620 7468  First node of th
-0002fe70: 6520 696e 636c 7564 6522 207d 0a20 2020  e include" }.   
-0002fe80: 2020 2020 2020 2020 2023 207b 2027 6669           # { 'fi
-0002fe90: 7273 7420 6e6f 6465 206f 6620 7468 6520  rst node of the 
-0002fea0: 7069 7065 2061 6674 6572 2074 6865 2069  pipe after the i
-0002feb0: 6e63 6c75 6465 273a 207d 0a20 2020 2020  nclude': }.     
-0002fec0: 2020 2020 2020 2069 6620 222e 696e 636c         if ".incl
-0002fed0: 2220 6e6f 7420 696e 206b 3a0a 2020 2020  " not in k:.    
-0002fee0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0002fef0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-0002ff00: 2020 2320 5765 2067 6574 2061 6c6c 2074    # We get all t
-0002ff10: 6865 206e 6f64 6573 2069 6e73 6964 6520  he nodes inside 
-0002ff20: 7468 6520 696e 636c 7564 6520 616e 6420  the include and 
-0002ff30: 7265 6d6f 7665 2074 6865 6d20 6672 6f6d  remove them from
-0002ff40: 2074 6865 2075 6e72 6f6c 6c65 6420 7069   the unrolled pi
-0002ff50: 7065 2061 7320 7765 2077 616e 7420 7468  pe as we want th
-0002ff60: 696e 6773 2075 6e72 6f6c 6c65 640a 2020  ings unrolled.  
-0002ff70: 2020 2020 2020 2020 2020 696e 636c 7564            includ
-0002ff80: 655f 7061 7261 6d65 7465 7273 203d 205f  e_parameters = _
-0002ff90: 756e 7175 6f74 6528 6b29 0a0a 2020 2020  unquote(k)..    
-0002ffa0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-0002ffb0: 7920 7573 6520 616e 2069 6e63 6c75 6465  y use an include
-0002ffc0: 2077 6974 6820 7061 7261 6d65 7465 7273   with parameters
-0002ffd0: 206c 696b 6520 6049 4e43 4c55 4445 2022   like `INCLUDE "
-0002ffe0: 7878 782e 696e 636c 2220 2247 524f 5550  xxx.incl" "GROUP
-0002fff0: 5f43 4f4c 3d70 6174 6822 2022 4d41 5445  _COL=path" "MATE
-00030000: 5249 414c 495a 4544 5f56 4945 573d 7370  RIALIZED_VIEW=sp
-00030010: 6565 645f 696e 7369 6768 7473 5f70 6174  eed_insights_pat
-00030020: 685f 6461 696c 795f 6d76 2260 600a 2020  h_daily_mv"``.  
-00030030: 2020 2020 2020 2020 2020 2320 5765 206a            # We j
-00030040: 7573 7420 7761 6e74 2074 6865 2066 696c  ust want the fil
-00030050: 6520 6e61 6d65 2074 6f20 7461 6b65 206e  e name to take n
-00030060: 6f64 6573 0a20 2020 2020 2020 2020 2020  odes.           
-00030070: 2069 6e63 6c75 6465 5f66 696c 6520 3d20   include_file = 
-00030080: 696e 636c 7564 655f 7061 7261 6d65 7465  include_paramete
-00030090: 7273 2e73 706c 6974 2827 2227 295b 305d  rs.split('"')[0]
-000300a0: 0a20 2020 2020 2020 2020 2020 2069 6e63  .            inc
-000300b0: 6c75 6465 5f66 696c 6520 3d20 280a 2020  lude_file = (.  
-000300c0: 2020 2020 2020 2020 2020 2020 2020 5061                Pa
-000300d0: 7468 286f 732e 7061 7468 2e64 6972 6e61  th(os.path.dirna
-000300e0: 6d65 2866 696c 656e 616d 6529 2920 2f20  me(filename)) / 
-000300f0: 6576 616c 5f76 6172 2869 6e63 6c75 6465  eval_var(include
-00030100: 5f66 696c 6529 0a20 2020 2020 2020 2020  _file).         
-00030110: 2020 2020 2020 2069 6620 222e 2220 696e         if "." in
-00030120: 2069 6e63 6c75 6465 5f66 696c 650a 2020   include_file.  
-00030130: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00030140: 7365 2065 7661 6c5f 7661 7228 696e 636c  se eval_var(incl
-00030150: 7564 655f 6669 6c65 290a 2020 2020 2020  ude_file).      
-00030160: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00030170: 2020 2020 696e 636c 7564 6564 5f70 6970      included_pip
-00030180: 6520 3d20 7061 7273 655f 7069 7065 2869  e = parse_pipe(i
-00030190: 6e63 6c75 6465 5f66 696c 652c 2073 6b69  nclude_file, ski
-000301a0: 705f 6576 616c 3d73 6b69 705f 6576 616c  p_eval=skip_eval
-000301b0: 290a 2020 2020 2020 2020 2020 2020 7069  ).            pi
-000301c0: 7065 5f6e 6f64 6573 203d 2064 6f63 2e6e  pe_nodes = doc.n
-000301d0: 6f64 6573 2e63 6f70 7928 290a 2020 2020  odes.copy().    
-000301e0: 2020 2020 2020 2020 666f 7220 696e 636c          for incl
-000301f0: 7564 6564 5f6e 6f64 6520 696e 2069 6e63  uded_node in inc
-00030200: 6c75 6465 645f 7069 7065 2e6e 6f64 6573  luded_pipe.nodes
-00030210: 2e63 6f70 7928 293a 0a20 2020 2020 2020  .copy():.       
-00030220: 2020 2020 2020 2020 2075 6e72 6f6c 6c65           unrolle
-00030230: 645f 696e 636c 7564 6564 5f6e 6f64 6520  d_included_node 
-00030240: 3d20 6e65 7874 280a 2020 2020 2020 2020  = next(.        
-00030250: 2020 2020 2020 2020 2020 2020 286e 6f64              (nod
-00030260: 6520 666f 7220 6e6f 6465 2069 6e20 7069  e for node in pi
-00030270: 7065 5f6e 6f64 6573 2069 6620 6e6f 6465  pe_nodes if node
-00030280: 5b22 6e61 6d65 225d 203d 3d20 696e 636c  ["name"] == incl
-00030290: 7564 6564 5f6e 6f64 655b 226e 616d 6522  uded_node["name"
-000302a0: 5d29 2c20 4e6f 6e65 0a20 2020 2020 2020  ]), None.       
-000302b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000302c0: 2020 2020 2020 2020 2020 2069 6620 756e             if un
-000302d0: 726f 6c6c 6564 5f69 6e63 6c75 6465 645f  rolled_included_
-000302e0: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-000302f0: 2020 2020 2020 2020 2020 646f 632e 6e6f            doc.no
-00030300: 6465 732e 7265 6d6f 7665 2875 6e72 6f6c  des.remove(unrol
-00030310: 6c65 645f 696e 636c 7564 6564 5f6e 6f64  led_included_nod
-00030320: 6529 0a20 2020 2066 6f72 206e 6f64 6520  e).    for node 
-00030330: 696e 2064 6f63 2e6e 6f64 6573 3a0a 2020  in doc.nodes:.  
-00030340: 2020 2020 2020 6177 6169 7420 666f 726d        await form
-00030350: 6174 5f6e 6f64 6528 0a20 2020 2020 2020  at_node(.       
-00030360: 2020 2020 2066 696c 655f 7061 7274 732c       file_parts,
-00030370: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00030380: 652c 0a20 2020 2020 2020 2020 2020 2064  e,.            d
-00030390: 6f63 2e69 6e63 6c75 6465 732c 0a20 2020  oc.includes,.   
-000303a0: 2020 2020 2020 2020 206c 696e 655f 6c65           line_le
-000303b0: 6e67 7468 3d6c 696e 655f 6c65 6e67 7468  ngth=line_length
-000303c0: 2c0a 2020 2020 2020 2020 2020 2020 756e  ,.            un
-000303d0: 726f 6c6c 5f69 6e63 6c75 6465 733d 756e  roll_includes=un
-000303e0: 726f 6c6c 5f69 6e63 6c75 6465 732c 0a20  roll_includes,. 
-000303f0: 2020 2020 2020 2020 2020 206c 6f77 6572             lower
-00030400: 5f6b 6579 776f 7264 733d 5472 7565 2069  _keywords=True i
-00030410: 6620 666f 725f 6465 706c 6f79 5f64 6966  f for_deploy_dif
-00030420: 6620 656c 7365 2046 616c 7365 2c0a 2020  f else False,.  
-00030430: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
-00030440: 6e6f 7420 756e 726f 6c6c 5f69 6e63 6c75  not unroll_inclu
-00030450: 6465 733a 0a20 2020 2020 2020 2066 6f72  des:.        for
-00030460: 206b 2c20 5f20 696e 2064 6f63 2e69 6e63   k, _ in doc.inc
-00030470: 6c75 6465 732e 6974 656d 7328 293a 0a20  ludes.items():. 
-00030480: 2020 2020 2020 2020 2020 2069 6620 222e             if ".
-00030490: 696e 636c 2220 6e6f 7420 696e 206b 3a0a  incl" not in k:.
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000304c0: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
-000304d0: 6170 7065 6e64 2866 2249 4e43 4c55 4445  append(f"INCLUDE
-000304e0: 207b 6b7d 2229 0a20 2020 2020 2020 2020   {k}").         
-000304f0: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-00030500: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
-00030510: 575f 4c49 4e45 290a 2020 2020 2020 2020  W_LINE).        
-00030520: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-00030530: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
-00030540: 4557 5f4c 494e 4529 0a0a 2020 2020 7265  EW_LINE)..    re
-00030550: 7375 6c74 203d 2022 222e 6a6f 696e 2866  sult = "".join(f
-00030560: 696c 655f 7061 7274 7329 0a20 2020 2072  ile_parts).    r
-00030570: 6573 756c 7420 3d20 7265 7375 6c74 2e72  esult = result.r
-00030580: 7374 7269 7028 225c 6e22 2920 2b20 225c  strip("\n") + "\
-00030590: 6e22 0a20 2020 2072 6574 7572 6e20 7265  n".    return re
-000305a0: 7375 6c74 0a0a 0a64 6566 2066 6f72 6d61  sult...def forma
-000305b0: 745f 7371 6c28 7371 6c3a 2073 7472 2c20  t_sql(sql: str, 
-000305c0: 4441 5441 4649 4c45 5f49 4e44 454e 543a  DATAFILE_INDENT:
-000305d0: 2073 7472 2c20 6c69 6e65 5f6c 656e 6774   str, line_lengt
-000305e0: 683a 204f 7074 696f 6e61 6c5b 696e 745d  h: Optional[int]
-000305f0: 203d 204e 6f6e 652c 206c 6f77 6572 5f6b   = None, lower_k
-00030600: 6579 776f 7264 733a 2062 6f6f 6c20 3d20  eywords: bool = 
-00030610: 4661 6c73 6529 202d 3e20 7374 723a 0a20  False) -> str:. 
-00030620: 2020 2073 716c 203d 2066 6f72 6d61 745f     sql = format_
-00030630: 7371 6c5f 7465 6d70 6c61 7465 2873 716c  sql_template(sql
-00030640: 2e73 7472 6970 2829 2c20 6c69 6e65 5f6c  .strip(), line_l
-00030650: 656e 6774 683d 6c69 6e65 5f6c 656e 6774  ength=line_lengt
-00030660: 682c 206c 6f77 6572 5f6b 6579 776f 7264  h, lower_keyword
-00030670: 733d 6c6f 7765 725f 6b65 7977 6f72 6473  s=lower_keywords
-00030680: 290a 2020 2020 7265 7475 726e 2022 5c6e  ).    return "\n
-00030690: 222e 6a6f 696e 285b 6622 7b44 4154 4146  ".join([f"{DATAF
-000306a0: 494c 455f 494e 4445 4e54 7d7b 7061 7274  ILE_INDENT}{part
-000306b0: 7d22 2066 6f72 2070 6172 7420 696e 2073  }" for part in s
-000306c0: 716c 2e73 706c 6974 2822 5c6e 2229 2069  ql.split("\n") i
-000306d0: 6620 6c65 6e28 7061 7274 2e73 7472 6970  f len(part.strip
-000306e0: 2829 295d 290a 0a0a 6173 796e 6320 6465  ())])...async de
-000306f0: 6620 5f67 6174 6865 725f 7769 7468 5f63  f _gather_with_c
-00030700: 6f6e 6375 7272 656e 6379 286e 2c20 2a74  oncurrency(n, *t
-00030710: 6173 6b73 293a 0a20 2020 2073 656d 6170  asks):.    semap
-00030720: 686f 7265 203d 2053 656d 6170 686f 7265  hore = Semaphore
-00030730: 286e 290a 0a20 2020 2061 7379 6e63 2064  (n)..    async d
-00030740: 6566 2073 656d 5f74 6173 6b28 7461 736b  ef sem_task(task
-00030750: 293a 0a20 2020 2020 2020 2061 7379 6e63  ):.        async
-00030760: 2077 6974 6820 7365 6d61 7068 6f72 653a   with semaphore:
-00030770: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00030780: 7572 6e20 6177 6169 7420 7461 736b 0a0a  urn await task..
-00030790: 2020 2020 7265 7475 726e 2061 7761 6974      return await
-000307a0: 2067 6174 6865 7228 2a28 7365 6d5f 7461   gather(*(sem_ta
-000307b0: 736b 2874 6173 6b29 2066 6f72 2074 6173  sk(task) for tas
-000307c0: 6b20 696e 2074 6173 6b73 2929 0a0a 0a61  k in tasks))...a
-000307d0: 7379 6e63 2064 6566 2066 6f6c 6465 725f  sync def folder_
-000307e0: 7075 6c6c 280a 2020 2020 636c 6965 6e74  pull(.    client
-000307f0: 3a20 5469 6e79 422c 0a20 2020 2066 6f6c  : TinyB,.    fol
-00030800: 6465 723a 2073 7472 2c0a 2020 2020 6175  der: str,.    au
-00030810: 746f 3a20 626f 6f6c 2c0a 2020 2020 6d61  to: bool,.    ma
-00030820: 7463 683a 204f 7074 696f 6e61 6c5b 7374  tch: Optional[st
-00030830: 725d 2c0a 2020 2020 666f 7263 653a 2062  r],.    force: b
-00030840: 6f6f 6c2c 0a20 2020 2076 6572 626f 7365  ool,.    verbose
-00030850: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00030860: 2020 2070 726f 6772 6573 735f 6261 723a     progress_bar:
-00030870: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
-00030880: 3a20 2023 206e 6f71 613a 2043 3930 310a  :  # noqa: C901.
-00030890: 2020 2020 7061 7474 6572 6e20 3d20 7265      pattern = re
-000308a0: 2e63 6f6d 7069 6c65 286d 6174 6368 2920  .compile(match) 
-000308b0: 6966 206d 6174 6368 2065 6c73 6520 4e6f  if match else No
-000308c0: 6e65 0a0a 2020 2020 6465 6620 5f67 6574  ne..    def _get
-000308d0: 5f6c 6174 6573 745f 7665 7273 696f 6e73  _latest_versions
-000308e0: 2872 6573 6f75 7263 6573 3a20 4c69 7374  (resources: List
-000308f0: 5b73 7472 5d29 3a0a 2020 2020 2020 2020  [str]):.        
-00030900: 7665 7273 696f 6e73 3a20 4469 6374 5b73  versions: Dict[s
-00030910: 7472 2c20 416e 795d 203d 207b 7d0a 0a20  tr, Any] = {}.. 
-00030920: 2020 2020 2020 2066 6f72 2078 2069 6e20         for x in 
-00030930: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
-00030940: 2020 2020 2020 2074 203d 2067 6574 5f6e         t = get_n
-00030950: 616d 655f 7665 7273 696f 6e28 7829 0a20  ame_version(x). 
-00030960: 2020 2020 2020 2020 2020 2074 5b22 6f72             t["or
-00030970: 6967 696e 616c 5f6e 616d 6522 5d20 3d20  iginal_name"] = 
-00030980: 780a 2020 2020 2020 2020 2020 2020 6966  x.            if
-00030990: 2074 5b22 7665 7273 696f 6e22 5d20 6973   t["version"] is
-000309a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000309b0: 2020 2020 2020 2074 5b22 7665 7273 696f         t["versio
-000309c0: 6e22 5d20 3d20 2d31 0a20 2020 2020 2020  n"] = -1.       
-000309d0: 2020 2020 206e 616d 6520 3d20 745b 226e       name = t["n
-000309e0: 616d 6522 5d0a 0a20 2020 2020 2020 2020  ame"]..         
-000309f0: 2020 2069 6620 6e61 6d65 206e 6f74 2069     if name not i
-00030a00: 6e20 7665 7273 696f 6e73 206f 7220 6e61  n versions or na
-00030a10: 6d65 203d 3d20 7820 6f72 2076 6572 7369  me == x or versi
-00030a20: 6f6e 735b 6e61 6d65 5d5b 2276 6572 7369  ons[name]["versi
-00030a30: 6f6e 225d 203c 2074 5b22 7665 7273 696f  on"] < t["versio
-00030a40: 6e22 5d3a 0a20 2020 2020 2020 2020 2020  n"]:.           
-00030a50: 2020 2020 2076 6572 7369 6f6e 735b 6e61       versions[na
-00030a60: 6d65 5d20 3d20 740a 2020 2020 2020 2020  me] = t.        
-00030a70: 7265 7475 726e 2076 6572 7369 6f6e 730a  return versions.
-00030a80: 0a20 2020 2064 6566 2067 6574 5f66 696c  .    def get_fil
-00030a90: 655f 666f 6c64 6572 2865 7874 656e 7369  e_folder(extensi
-00030aa0: 6f6e 3a20 7374 7229 3a0a 2020 2020 2020  on: str):.      
-00030ab0: 2020 6966 206e 6f74 2061 7574 6f3a 0a20    if not auto:. 
-00030ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00030ad0: 6e20 4e6f 6e65 0a20 2020 2020 2020 2069  n None.        i
-00030ae0: 6620 6578 7465 6e73 696f 6e20 3d3d 2022  f extension == "
-00030af0: 6461 7461 736f 7572 6365 223a 0a20 2020  datasource":.   
-00030b00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00030b10: 2264 6174 6173 6f75 7263 6573 220a 2020  "datasources".  
-00030b20: 2020 2020 2020 6966 2065 7874 656e 7369        if extensi
-00030b30: 6f6e 203d 3d20 2270 6970 6522 3a0a 2020  on == "pipe":.  
-00030b40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00030b50: 2022 7069 7065 7322 0a20 2020 2020 2020   "pipes".       
-00030b60: 2069 6620 6578 7465 6e73 696f 6e20 3d3d   if extension ==
-00030b70: 2022 746f 6b65 6e22 3a0a 2020 2020 2020   "token":.      
-00030b80: 2020 2020 2020 7265 7475 726e 2022 746f        return "to
-00030b90: 6b65 6e73 220a 2020 2020 2020 2020 7265  kens".        re
-00030ba0: 7475 726e 204e 6f6e 650a 0a20 2020 2061  turn None..    a
-00030bb0: 7379 6e63 2064 6566 2077 7269 7465 5f66  sync def write_f
-00030bc0: 696c 6573 280a 2020 2020 2020 2020 7665  iles(.        ve
-00030bd0: 7273 696f 6e73 3a20 4469 6374 5b73 7472  rsions: Dict[str
-00030be0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00030bf0: 7265 736f 7572 6365 733a 204c 6973 745b  resources: List[
-00030c00: 7374 725d 2c0a 2020 2020 2020 2020 6578  str],.        ex
-00030c10: 7465 6e73 696f 6e3a 2073 7472 2c0a 2020  tension: str,.  
-00030c20: 2020 2020 2020 6765 745f 7265 736f 7572        get_resour
-00030c30: 6365 5f66 756e 6374 696f 6e3a 2073 7472  ce_function: str
-00030c40: 2c0a 2020 2020 2020 2020 7072 6f67 7265  ,.        progre
-00030c50: 7373 5f62 6172 3a20 626f 6f6c 203d 2046  ss_bar: bool = F
-00030c60: 616c 7365 2c0a 2020 2020 293a 0a20 2020  alse,.    ):.   
-00030c70: 2020 2020 2061 7379 6e63 2064 6566 2077       async def w
-00030c80: 7269 7465 5f72 6573 6f75 7263 6528 6b3a  rite_resource(k:
-00030c90: 2044 6963 745b 7374 722c 2041 6e79 5d29   Dict[str, Any])
-00030ca0: 3a0a 2020 2020 2020 2020 2020 2020 6e61  :.            na
-00030cb0: 6d65 203d 2066 227b 6b5b 276e 616d 6527  me = f"{k['name'
-00030cc0: 5d7d 2e7b 6578 7465 6e73 696f 6e7d 220a  ]}.{extension}".
-00030cd0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00030ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030cf0: 2069 6620 7061 7474 6572 6e20 616e 6420   if pattern and 
-00030d00: 6e6f 7420 7061 7474 6572 6e2e 7365 6172  not pattern.sear
-00030d10: 6368 286e 616d 6529 3a0a 2020 2020 2020  ch(name):.      
-00030d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00030d30: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00030d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d50: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-00030d60: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
-00030d70: 6f5f 736b 6970 7069 6e67 5f72 6573 6f75  o_skipping_resou
-00030d80: 7263 6528 7265 736f 7572 6365 3d6e 616d  rce(resource=nam
-00030d90: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00030da0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00030db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030dc0: 7265 736f 7572 6365 203d 2061 7761 6974  resource = await
-00030dd0: 2067 6574 6174 7472 2863 6c69 656e 742c   getattr(client,
-00030de0: 2067 6574 5f72 6573 6f75 7263 655f 6675   get_resource_fu
-00030df0: 6e63 7469 6f6e 2928 6b5b 226f 7269 6769  nction)(k["origi
-00030e00: 6e61 6c5f 6e61 6d65 225d 290a 0a20 2020  nal_name"])..   
-00030e10: 2020 2020 2020 2020 2020 2020 2064 6573               des
-00030e20: 745f 666f 6c64 6572 203d 2066 6f6c 6465  t_folder = folde
-00030e30: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00030e40: 2020 6966 2022 2e22 2069 6e20 6b5b 226e    if "." in k["n
-00030e50: 616d 6522 5d20 616e 6420 6578 7465 6e73  ame"] and extens
-00030e60: 696f 6e20 213d 2022 746f 6b65 6e22 3a0a  ion != "token":.
-00030e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e80: 2020 2020 6465 7374 5f66 6f6c 6465 7220      dest_folder 
-00030e90: 3d20 5061 7468 2866 6f6c 6465 7229 202f  = Path(folder) /
-00030ea0: 2022 7665 6e64 6f72 2220 2f20 6b5b 226e   "vendor" / k["n
-00030eb0: 616d 6522 5d2e 7370 6c69 7428 222e 222c  ame"].split(".",
-00030ec0: 2031 295b 305d 0a20 2020 2020 2020 2020   1)[0].         
-00030ed0: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-00030ee0: 3d20 6622 7b6b 5b27 6e61 6d65 275d 2e73  = f"{k['name'].s
-00030ef0: 706c 6974 2827 2e27 2c20 3129 5b31 5d7d  plit('.', 1)[1]}
-00030f00: 2e7b 6578 7465 6e73 696f 6e7d 220a 0a20  .{extension}".. 
-00030f10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030f20: 696c 655f 666f 6c64 6572 203d 2067 6574  ile_folder = get
-00030f30: 5f66 696c 655f 666f 6c64 6572 2865 7874  _file_folder(ext
-00030f40: 656e 7369 6f6e 290a 2020 2020 2020 2020  ension).        
-00030f50: 2020 2020 2020 2020 6620 3d20 5061 7468          f = Path
-00030f60: 2864 6573 745f 666f 6c64 6572 2920 2f20  (dest_folder) / 
-00030f70: 6669 6c65 5f66 6f6c 6465 7220 6966 2066  file_folder if f
-00030f80: 696c 655f 666f 6c64 6572 2069 7320 6e6f  ile_folder is no
-00030f90: 7420 4e6f 6e65 2065 6c73 6520 5061 7468  t None else Path
-00030fa0: 2864 6573 745f 666f 6c64 6572 290a 0a20  (dest_folder).. 
-00030fb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00030fc0: 6620 6e6f 7420 662e 6578 6973 7473 2829  f not f.exists()
-00030fd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00030fe0: 2020 2020 2020 662e 6d6b 6469 7228 7061        f.mkdir(pa
-00030ff0: 7265 6e74 733d 5472 7565 290a 0a20 2020  rents=True)..   
-00031000: 2020 2020 2020 2020 2020 2020 2066 203d               f =
-00031010: 2066 202f 206e 616d 650a 2020 2020 2020   f / name.      
-00031020: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-00031030: 6365 5f6e 616d 6573 203d 205b 782e 7370  ce_names = [x.sp
-00031040: 6c69 7428 222e 2229 5b2d 315d 2066 6f72  lit(".")[-1] for
-00031050: 2078 2069 6e20 7265 736f 7572 6365 735d   x in resources]
-00031060: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00031070: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00031080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031090: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-000310a0: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
-000310b0: 6f5f 7772 6974 696e 675f 7265 736f 7572  o_writing_resour
-000310c0: 6365 2872 6573 6f75 7263 653d 6629 290a  ce(resource=f)).
-000310d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310e0: 6966 206e 6f74 2066 2e65 7869 7374 7328  if not f.exists(
-000310f0: 2920 6f72 2066 6f72 6365 3a0a 2020 2020  ) or force:.    
-00031100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031110: 7769 7468 206f 7065 6e28 662c 2022 7722  with open(f, "w"
-00031120: 2920 6173 2066 643a 0a20 2020 2020 2020  ) as fd:.       
-00031130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031140: 2023 2076 6572 7369 6f6e 7320 6172 6520   # versions are 
-00031150: 6120 636c 6965 6e74 206f 6e6c 7920 7468  a client only th
-00031160: 696e 6720 736f 0a20 2020 2020 2020 2020  ing so.         
-00031170: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00031180: 2064 6174 6166 696c 6573 2066 726f 6d20   datafiles from 
-00031190: 7468 6520 7365 7276 6572 2064 6f20 6e6f  the server do no
-000311a0: 7420 636f 6e74 6169 6e73 2069 6e66 6f72  t contains infor
-000311b0: 6d61 7469 6f6e 2061 626f 7574 2076 6572  mation about ver
-000311c0: 7369 6f6e 730a 2020 2020 2020 2020 2020  sions.          
-000311d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000311e0: 206b 5b22 7665 7273 696f 6e22 5d20 3e3d   k["version"] >=
-000311f0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00031200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031210: 7265 736f 7572 6365 203d 2066 2256 4552  resource = f"VER
-00031220: 5349 4f4e 207b 6b5b 2776 6572 7369 6f6e  SION {k['version
-00031230: 275d 7d5c 6e22 202b 2072 6573 6f75 7263  ']}\n" + resourc
-00031240: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00031250: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-00031260: 6f75 7263 653a 0a20 2020 2020 2020 2020  ource:.         
-00031270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031280: 2020 206d 6174 6368 6573 203d 2072 652e     matches = re.
-00031290: 6669 6e64 616c 6c28 7222 285b 5e5c 735c  findall(r"([^\s\
-000312a0: 2e5d 2a5f 5f76 5c64 2b29 222c 2072 6573  .]*__v\d+)", res
-000312b0: 6f75 7263 6529 0a20 2020 2020 2020 2020  ource).         
-000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312d0: 2020 2066 6f72 206d 6174 6368 2069 6e20     for match in 
-000312e0: 7365 7428 6d61 7463 6865 7329 3a0a 2020  set(matches):.  
-000312f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031300: 2020 2020 2020 2020 2020 2020 2020 6d20                m 
-00031310: 3d20 6d61 7463 682e 7370 6c69 7428 225f  = match.split("_
-00031320: 5f76 2229 5b30 5d0a 2020 2020 2020 2020  _v")[0].        
-00031330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031340: 2020 2020 2020 2020 6966 206d 2069 6e20          if m in 
-00031350: 7265 736f 7572 6365 7320 6f72 206d 2069  resources or m i
-00031360: 6e20 7265 736f 7572 6365 5f6e 616d 6573  n resource_names
-00031370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031390: 2020 2020 2020 7265 736f 7572 6365 203d        resource =
-000313a0: 2072 6573 6f75 7263 652e 7265 706c 6163   resource.replac
-000313b0: 6528 6d61 7463 682c 206d 290a 2020 2020  e(match, m).    
-000313c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313d0: 2020 2020 2020 2020 6664 2e77 7269 7465          fd.write
-000313e0: 2872 6573 6f75 7263 6529 0a20 2020 2020  (resource).     
-000313f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00031400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031410: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00031420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031430: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-00031440: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-00031450: 6765 722e 696e 666f 5f73 6b69 705f 616c  ger.info_skip_al
-00031460: 7265 6164 795f 6578 6973 7473 2829 290a  ready_exists()).
-00031470: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00031480: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00031490: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000314a0: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
-000314b0: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
-000314c0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-000314d0: 726f 725f 6578 6365 7074 696f 6e28 6572  ror_exception(er
-000314e0: 726f 723d 6529 290a 0a20 2020 2020 2020  ror=e))..       
-000314f0: 2076 616c 7565 7320 3d20 7665 7273 696f   values = versio
-00031500: 6e73 2e76 616c 7565 7328 290a 0a20 2020  ns.values()..   
-00031510: 2020 2020 2069 6620 7072 6f67 7265 7373       if progress
-00031520: 5f62 6172 3a0a 2020 2020 2020 2020 2020  _bar:.          
-00031530: 2020 7769 7468 2063 6c69 636b 2e70 726f    with click.pro
-00031540: 6772 6573 7362 6172 2876 616c 7565 732c  gressbar(values,
-00031550: 206c 6162 656c 3d66 2250 756c 6c69 6e67   label=f"Pulling
-00031560: 207b 6578 7465 6e73 696f 6e7d 7322 2920   {extension}s") 
-00031570: 6173 2076 616c 7565 733a 2020 2320 7479  as values:  # ty
-00031580: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-00031590: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-000315a0: 2069 6e20 7661 6c75 6573 3a0a 2020 2020   in values:.    
-000315b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315c0: 6177 6169 7420 7772 6974 655f 7265 736f  await write_reso
-000315d0: 7572 6365 286b 290a 2020 2020 2020 2020  urce(k).        
-000315e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000315f0: 2020 7461 736b 7320 3d20 5b77 7269 7465    tasks = [write
-00031600: 5f72 6573 6f75 7263 6528 6b29 2066 6f72  _resource(k) for
-00031610: 206b 2069 6e20 7661 6c75 6573 5d0a 2020   k in values].  
-00031620: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00031630: 5f67 6174 6865 725f 7769 7468 5f63 6f6e  _gather_with_con
-00031640: 6375 7272 656e 6379 2835 2c20 2a74 6173  currency(5, *tas
-00031650: 6b73 290a 0a20 2020 2074 7279 3a0a 2020  ks)..    try:.  
-00031660: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00031670: 7320 3d20 6177 6169 7420 636c 6965 6e74  s = await client
-00031680: 2e64 6174 6173 6f75 7263 6573 2829 0a20  .datasources(). 
-00031690: 2020 2020 2020 2072 656d 6f74 655f 6461         remote_da
-000316a0: 7461 736f 7572 6365 7320 3d20 736f 7274  tasources = sort
-000316b0: 6564 285b 785b 226e 616d 6522 5d20 666f  ed([x["name"] fo
-000316c0: 7220 7820 696e 2064 6174 6173 6f75 7263  r x in datasourc
-000316d0: 6573 5d29 0a20 2020 2020 2020 2064 6174  es]).        dat
-000316e0: 6173 6f75 7263 6573 5f76 6572 7369 6f6e  asources_version
-000316f0: 7320 3d20 5f67 6574 5f6c 6174 6573 745f  s = _get_latest_
-00031700: 7665 7273 696f 6e73 2872 656d 6f74 655f  versions(remote_
-00031710: 6461 7461 736f 7572 6365 7329 0a0a 2020  datasources)..  
-00031720: 2020 2020 2020 7069 7065 7320 3d20 6177        pipes = aw
-00031730: 6169 7420 636c 6965 6e74 2e70 6970 6573  ait client.pipes
-00031740: 2829 0a20 2020 2020 2020 2072 656d 6f74  ().        remot
-00031750: 655f 7069 7065 7320 3d20 736f 7274 6564  e_pipes = sorted
-00031760: 285b 785b 226e 616d 6522 5d20 666f 7220  ([x["name"] for 
-00031770: 7820 696e 2070 6970 6573 5d29 0a20 2020  x in pipes]).   
-00031780: 2020 2020 2070 6970 6573 5f76 6572 7369       pipes_versi
-00031790: 6f6e 7320 3d20 5f67 6574 5f6c 6174 6573  ons = _get_lates
-000317a0: 745f 7665 7273 696f 6e73 2872 656d 6f74  t_versions(remot
-000317b0: 655f 7069 7065 7329 0a0a 2020 2020 2020  e_pipes)..      
-000317c0: 2020 7265 736f 7572 6365 7320 3d20 6c69    resources = li
-000317d0: 7374 2864 6174 6173 6f75 7263 6573 5f76  st(datasources_v
-000317e0: 6572 7369 6f6e 732e 6b65 7973 2829 2920  ersions.keys()) 
-000317f0: 2b20 6c69 7374 2870 6970 6573 5f76 6572  + list(pipes_ver
-00031800: 7369 6f6e 732e 6b65 7973 2829 290a 0a20  sions.keys()).. 
-00031810: 2020 2020 2020 2061 7761 6974 2077 7269         await wri
-00031820: 7465 5f66 696c 6573 2864 6174 6173 6f75  te_files(datasou
-00031830: 7263 6573 5f76 6572 7369 6f6e 732c 2072  rces_versions, r
-00031840: 6573 6f75 7263 6573 2c20 2264 6174 6173  esources, "datas
-00031850: 6f75 7263 6522 2c20 2264 6174 6173 6f75  ource", "datasou
-00031860: 7263 655f 6669 6c65 222c 2070 726f 6772  rce_file", progr
-00031870: 6573 735f 6261 723d 7072 6f67 7265 7373  ess_bar=progress
-00031880: 5f62 6172 290a 2020 2020 2020 2020 6177  _bar).        aw
-00031890: 6169 7420 7772 6974 655f 6669 6c65 7328  ait write_files(
-000318a0: 7069 7065 735f 7665 7273 696f 6e73 2c20  pipes_versions, 
-000318b0: 7265 736f 7572 6365 732c 2022 7069 7065  resources, "pipe
-000318c0: 222c 2022 7069 7065 5f66 696c 6522 2c20  ", "pipe_file", 
-000318d0: 7072 6f67 7265 7373 5f62 6172 3d70 726f  progress_bar=pro
-000318e0: 6772 6573 735f 6261 7229 0a0a 2020 2020  gress_bar)..    
-000318f0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00031900: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00031910: 2061 7320 653a 0a20 2020 2020 2020 2072   as e:.        r
-00031920: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-00031930: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-00031940: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-00031950: 7075 6c6c 2865 7272 6f72 3d73 7472 2865  pull(error=str(e
-00031960: 2929 290a 0a0a 6465 6620 636f 6c6f 725f  )))...def color_
-00031970: 6469 6666 2864 6966 663a 2049 7465 7261  diff(diff: Itera
-00031980: 626c 655b 7374 725d 2920 2d3e 2047 656e  ble[str]) -> Gen
-00031990: 6572 6174 6f72 5b73 7472 2c20 416e 792c  erator[str, Any,
-000319a0: 204e 6f6e 655d 3a0a 2020 2020 666f 7220   None]:.    for 
-000319b0: 6c69 6e65 2069 6e20 6469 6666 3a0a 2020  line in diff:.  
-000319c0: 2020 2020 2020 6966 206c 696e 652e 7374        if line.st
-000319d0: 6172 7473 7769 7468 2822 2b22 293a 0a20  artswith("+"):. 
-000319e0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-000319f0: 2046 6f72 652e 4752 4545 4e20 2b20 6c69   Fore.GREEN + li
-00031a00: 6e65 202b 2046 6f72 652e 5245 5345 540a  ne + Fore.RESET.
-00031a10: 2020 2020 2020 2020 656c 6966 206c 696e          elif lin
-00031a20: 652e 7374 6172 7473 7769 7468 2822 2d22  e.startswith("-"
-00031a30: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
-00031a40: 6965 6c64 2046 6f72 652e 5245 4420 2b20  ield Fore.RED + 
-00031a50: 6c69 6e65 202b 2046 6f72 652e 5245 5345  line + Fore.RESE
-00031a60: 540a 2020 2020 2020 2020 656c 6966 206c  T.        elif l
-00031a70: 696e 652e 7374 6172 7473 7769 7468 2822  ine.startswith("
-00031a80: 5e22 293a 0a20 2020 2020 2020 2020 2020  ^"):.           
-00031a90: 2079 6965 6c64 2046 6f72 652e 424c 5545   yield Fore.BLUE
-00031aa0: 202b 206c 696e 6520 2b20 466f 7265 2e52   + line + Fore.R
-00031ab0: 4553 4554 0a20 2020 2020 2020 2065 6c73  ESET.        els
-00031ac0: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
-00031ad0: 6965 6c64 206c 696e 650a 0a0a 6465 6620  ield line...def 
-00031ae0: 7065 656b 2869 7465 7261 626c 6529 3a0a  peek(iterable):.
-00031af0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00031b00: 2066 6972 7374 203d 206e 6578 7428 6974   first = next(it
-00031b10: 6572 6162 6c65 290a 2020 2020 6578 6365  erable).    exce
-00031b20: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-00031b30: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00031b40: 652c 204e 6f6e 650a 2020 2020 7265 7475  e, None.    retu
-00031b50: 726e 2066 6972 7374 2c20 6974 6572 746f  rn first, iterto
-00031b60: 6f6c 732e 6368 6169 6e28 5b66 6972 7374  ols.chain([first
-00031b70: 5d2c 2069 7465 7261 626c 6529 0a0a 0a61  ], iterable)...a
-00031b80: 7379 6e63 2064 6566 2064 6966 665f 636f  sync def diff_co
-00031b90: 6d6d 616e 6428 0a20 2020 2066 696c 656e  mmand(.    filen
-00031ba0: 616d 6573 3a20 4f70 7469 6f6e 616c 5b4c  ames: Optional[L
-00031bb0: 6973 745b 7374 725d 5d2c 0a20 2020 2066  ist[str]],.    f
-00031bc0: 6d74 3a20 626f 6f6c 2c0a 2020 2020 636c  mt: bool,.    cl
-00031bd0: 6965 6e74 3a20 5469 6e79 422c 0a20 2020  ient: TinyB,.   
-00031be0: 206e 6f5f 636f 6c6f 723a 204f 7074 696f   no_color: Optio
-00031bf0: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
-00031c00: 652c 0a20 2020 2077 6974 685f 7072 696e  e,.    with_prin
-00031c10: 743a 204f 7074 696f 6e61 6c5b 626f 6f6c  t: Optional[bool
-00031c20: 5d20 3d20 5472 7565 2c0a 2020 2020 7665  ] = True,.    ve
-00031c30: 7262 6f73 653a 204f 7074 696f 6e61 6c5b  rbose: Optional[
-00031c40: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
-00031c50: 2020 636c 6561 6e5f 7570 3a20 4f70 7469    clean_up: Opti
-00031c60: 6f6e 616c 5b62 6f6f 6c5d 203d 2046 616c  onal[bool] = Fal
-00031c70: 7365 2c0a 2020 2020 7072 6f67 7265 7373  se,.    progress
-00031c80: 5f62 6172 3a20 626f 6f6c 203d 2046 616c  _bar: bool = Fal
-00031c90: 7365 2c0a 2020 2020 666f 725f 6465 706c  se,.    for_depl
-00031ca0: 6f79 3a20 626f 6f6c 203d 2046 616c 7365  oy: bool = False
-00031cb0: 2c0a 293a 0a20 2020 2064 6566 2069 735f  ,.):.    def is_
-00031cc0: 7368 6172 6564 5f64 6174 6173 6f75 7263  shared_datasourc
-00031cd0: 6528 6e61 6d65 293a 0a20 2020 2020 2020  e(name):.       
-00031ce0: 2072 6574 7572 6e20 222e 2220 696e 206e   return "." in n
-00031cf0: 616d 650a 0a20 2020 2077 6974 685f 6578  ame..    with_ex
-00031d00: 706c 6963 6974 5f66 696c 656e 616d 6573  plicit_filenames
-00031d10: 203d 2066 696c 656e 616d 6573 0a20 2020   = filenames.   
-00031d20: 2076 6572 626f 7365 203d 2054 7275 6520   verbose = True 
-00031d30: 6966 2076 6572 626f 7365 2069 7320 4e6f  if verbose is No
-00031d40: 6e65 2065 6c73 6520 7665 7262 6f73 650a  ne else verbose.
-00031d50: 0a20 2020 2074 6172 6765 745f 6469 7220  .    target_dir 
-00031d60: 3d20 6765 7463 7764 2829 202b 206f 732e  = getcwd() + os.
-00031d70: 7061 7468 2e73 6570 202b 2022 2e64 6966  path.sep + ".dif
-00031d80: 665f 746d 7022 0a20 2020 2050 6174 6828  f_tmp".    Path(
-00031d90: 7461 7267 6574 5f64 6972 292e 6d6b 6469  target_dir).mkdi
-00031da0: 7228 7061 7265 6e74 733d 5472 7565 2c20  r(parents=True, 
-00031db0: 6578 6973 745f 6f6b 3d54 7275 6529 0a0a  exist_ok=True)..
-00031dc0: 2020 2020 6966 2066 696c 656e 616d 6573      if filenames
-00031dd0: 3a0a 2020 2020 2020 2020 6966 206c 656e  :.        if len
-00031de0: 2866 696c 656e 616d 6573 2920 3d3d 2031  (filenames) == 1
-00031df0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00031e00: 6c65 6e61 6d65 7320 3d20 5b66 696c 656e  lenames = [filen
-00031e10: 616d 6573 5b30 5d5d 202b 2067 6574 5f70  ames[0]] + get_p
-00031e20: 726f 6a65 6374 5f66 696c 656e 616d 6573  roject_filenames
-00031e30: 2866 696c 656e 616d 6573 5b30 5d29 0a20  (filenames[0]). 
-00031e40: 2020 2020 2020 2061 7761 6974 2066 6f6c         await fol
-00031e50: 6465 725f 7075 6c6c 2863 6c69 656e 742c  der_pull(client,
-00031e60: 2074 6172 6765 745f 6469 722c 2046 616c   target_dir, Fal
-00031e70: 7365 2c20 4e6f 6e65 2c20 5472 7565 2c20  se, None, True, 
-00031e80: 7665 7262 6f73 653d 4661 6c73 6529 0a20  verbose=False). 
-00031e90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00031ea0: 2066 696c 656e 616d 6573 203d 2067 6574   filenames = get
-00031eb0: 5f70 726f 6a65 6374 5f66 696c 656e 616d  _project_filenam
-00031ec0: 6573 2822 2e22 290a 2020 2020 2020 2020  es(".").        
-00031ed0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00031ee0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-00031ef0: 686f 2822 5361 7669 6e67 2072 656d 6f74  ho("Saving remot
-00031f00: 6520 7265 736f 7572 6365 7320 696e 202e  e resources in .
-00031f10: 6469 6666 5f74 6d70 2066 6f6c 6465 722e  diff_tmp folder.
-00031f20: 5c6e 2229 0a20 2020 2020 2020 2061 7761  \n").        awa
-00031f30: 6974 2066 6f6c 6465 725f 7075 6c6c 2863  it folder_pull(c
-00031f40: 6c69 656e 742c 2074 6172 6765 745f 6469  lient, target_di
-00031f50: 722c 2046 616c 7365 2c20 4e6f 6e65 2c20  r, False, None, 
-00031f60: 5472 7565 2c20 7665 7262 6f73 653d 7665  True, verbose=ve
-00031f70: 7262 6f73 652c 2070 726f 6772 6573 735f  rbose, progress_
-00031f80: 6261 723d 7072 6f67 7265 7373 5f62 6172  bar=progress_bar
-00031f90: 290a 0a20 2020 2072 656d 6f74 655f 6461  )..    remote_da
-00031fa0: 7461 736f 7572 6365 733a 204c 6973 745b  tasources: List[
-00031fb0: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
-00031fc0: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
-00031fd0: 6174 6173 6f75 7263 6573 2829 0a20 2020  atasources().   
-00031fe0: 2072 656d 6f74 655f 7069 7065 733a 204c   remote_pipes: L
-00031ff0: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-00032000: 795d 5d20 3d20 6177 6169 7420 636c 6965  y]] = await clie
-00032010: 6e74 2e70 6970 6573 2829 0a0a 2020 2020  nt.pipes()..    
-00032020: 6c6f 6361 6c5f 7265 736f 7572 6365 7320  local_resources 
-00032030: 3d20 7b0a 2020 2020 2020 2020 5061 7468  = {.        Path
-00032040: 2866 696c 6529 2e72 6573 6f6c 7665 2829  (file).resolve()
-00032050: 2e73 7465 6d3a 2066 696c 650a 2020 2020  .stem: file.    
-00032060: 2020 2020 666f 7220 6669 6c65 2069 6e20      for file in 
-00032070: 6669 6c65 6e61 6d65 730a 2020 2020 2020  filenames.      
-00032080: 2020 6966 2028 222e 6461 7461 736f 7572    if (".datasour
-00032090: 6365 2220 696e 2066 696c 6520 6f72 2022  ce" in file or "
-000320a0: 2e70 6970 6522 2069 6e20 6669 6c65 2920  .pipe" in file) 
-000320b0: 616e 6420 222e 696e 636c 2220 6e6f 7420  and ".incl" not 
-000320c0: 696e 2066 696c 650a 2020 2020 7d0a 0a20  in file.    }.. 
-000320d0: 2020 2063 6861 6e67 6564 203d 207b 7d0a     changed = {}.
-000320e0: 2020 2020 666f 7220 7265 736f 7572 6365      for resource
-000320f0: 2069 6e20 7265 6d6f 7465 5f64 6174 6173   in remote_datas
-00032100: 6f75 7263 6573 202b 2072 656d 6f74 655f  ources + remote_
-00032110: 7069 7065 733a 0a20 2020 2020 2020 2070  pipes:.        p
-00032120: 726f 7065 7274 6965 733a 2044 6963 745b  roperties: Dict[
-00032130: 7374 722c 2041 6e79 5d20 3d20 6765 745f  str, Any] = get_
-00032140: 6e61 6d65 5f76 6572 7369 6f6e 2872 6573  name_version(res
-00032150: 6f75 7263 655b 226e 616d 6522 5d29 0a20  ource["name"]). 
-00032160: 2020 2020 2020 206e 616d 6520 3d20 7072         name = pr
-00032170: 6f70 6572 7469 6573 2e67 6574 2822 6e61  operties.get("na
-00032180: 6d65 222c 204e 6f6e 6529 0a20 2020 2020  me", None).     
-00032190: 2020 2069 6620 6e61 6d65 3a0a 2020 2020     if name:.    
-000321a0: 2020 2020 2020 2020 2872 6669 6c65 6e61          (rfilena
-000321b0: 6d65 2c20 6669 6c65 2920 3d20 6e65 7874  me, file) = next
-000321c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000321d0: 2020 2828 7266 696c 656e 616d 652c 2066    ((rfilename, f
-000321e0: 696c 6529 2066 6f72 2028 7266 696c 656e  ile) for (rfilen
-000321f0: 616d 652c 2066 696c 6529 2069 6e20 6c6f  ame, file) in lo
-00032200: 6361 6c5f 7265 736f 7572 6365 732e 6974  cal_resources.it
-00032210: 656d 7328 2920 6966 206e 616d 6520 3d3d  ems() if name ==
-00032220: 2072 6669 6c65 6e61 6d65 292c 0a20 2020   rfilename),.   
-00032230: 2020 2020 2020 2020 2020 2020 2028 2222               (""
-00032240: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-00032250: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00032260: 2020 2069 6620 6e6f 7420 6669 6c65 3a0a     if not file:.
-00032270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032280: 6966 206e 6f74 2077 6974 685f 6578 706c  if not with_expl
-00032290: 6963 6974 5f66 696c 656e 616d 6573 3a0a  icit_filenames:.
-000322a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000322b0: 2020 2020 6966 2077 6974 685f 7072 696e      if with_prin
-000322c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-000322d0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-000322e0: 2e65 6368 6f28 6622 7b72 6573 6f75 7263  .echo(f"{resourc
-000322f0: 655b 276e 616d 6527 5d7d 206f 6e6c 7920  e['name']} only 
-00032300: 6578 6973 7473 2072 656d 6f74 656c 795c  exists remotely\
-00032310: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
-00032320: 2020 2020 2020 2020 6966 2069 735f 7368          if is_sh
-00032330: 6172 6564 5f64 6174 6173 6f75 7263 6528  ared_datasource(
-00032340: 7265 736f 7572 6365 5b22 6e61 6d65 225d  resource["name"]
-00032350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00032360: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-00032370: 6564 5b72 6573 6f75 7263 655b 226e 616d  ed[resource["nam
-00032380: 6522 5d5d 203d 2022 7368 6172 6564 220a  e"]] = "shared".
-00032390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000323b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323c0: 2020 6368 616e 6765 645b 7265 736f 7572    changed[resour
-000323d0: 6365 5b22 6e61 6d65 225d 5d20 3d20 2272  ce["name"]] = "r
-000323e0: 656d 6f74 6522 0a20 2020 2020 2020 2020  emote".         
-000323f0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00032400: 0a20 2020 2020 2020 2020 2020 2073 7566  .            suf
-00032410: 6669 7820 3d20 222e 6461 7461 736f 7572  fix = ".datasour
-00032420: 6365 2220 6966 2022 2e64 6174 6173 6f75  ce" if ".datasou
-00032430: 7263 6522 2069 6e20 6669 6c65 2065 6c73  rce" in file els
-00032440: 6520 222e 7069 7065 220a 2020 2020 2020  e ".pipe".      
-00032450: 2020 2020 2020 7461 7267 6574 203d 2074        target = t
-00032460: 6172 6765 745f 6469 7220 2b20 6f73 2e70  arget_dir + os.p
-00032470: 6174 682e 7365 7020 2b20 7266 696c 656e  ath.sep + rfilen
-00032480: 616d 6520 2b20 7375 6666 6978 0a0a 2020  ame + suffix..  
-00032490: 2020 2020 2020 2020 2020 6469 6666 5f6c            diff_l
-000324a0: 696e 6573 203d 2061 7761 6974 2064 6966  ines = await dif
-000324b0: 665f 6669 6c65 7328 0a20 2020 2020 2020  f_files(.       
-000324c0: 2020 2020 2020 2020 2074 6172 6765 742c           target,
-000324d0: 2066 696c 652c 2077 6974 685f 666f 726d   file, with_form
-000324e0: 6174 3d66 6d74 2c20 7769 7468 5f63 6f6c  at=fmt, with_col
-000324f0: 6f72 3d28 6e6f 7420 6e6f 5f63 6f6c 6f72  or=(not no_color
-00032500: 292c 2063 6c69 656e 743d 636c 6965 6e74  ), client=client
-00032510: 2c20 666f 725f 6465 706c 6f79 3d66 6f72  , for_deploy=for
-00032520: 5f64 6570 6c6f 790a 2020 2020 2020 2020  _deploy.        
-00032530: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00032540: 2020 6e6f 745f 656d 7074 792c 2064 6966    not_empty, dif
-00032550: 665f 6c69 6e65 7320 3d20 7065 656b 2864  f_lines = peek(d
-00032560: 6966 665f 6c69 6e65 7329 0a20 2020 2020  iff_lines).     
-00032570: 2020 2020 2020 2063 6861 6e67 6564 5b72         changed[r
-00032580: 6669 6c65 6e61 6d65 5d20 3d20 6e6f 745f  filename] = not_
-00032590: 656d 7074 790a 2020 2020 2020 2020 2020  empty.          
-000325a0: 2020 6966 206e 6f74 5f65 6d70 7479 2061    if not_empty a
-000325b0: 6e64 2077 6974 685f 7072 696e 743a 0a20  nd with_print:. 
-000325c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000325d0: 7973 2e73 7464 6f75 742e 7772 6974 656c  ys.stdout.writel
-000325e0: 696e 6573 2864 6966 665f 6c69 6e65 7329  ines(diff_lines)
-000325f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032600: 2063 6c69 636b 2e65 6368 6f28 2222 290a   click.echo("").
-00032610: 0a20 2020 2066 6f72 2072 6669 6c65 6e61  .    for rfilena
-00032620: 6d65 2c20 5f20 696e 206c 6f63 616c 5f72  me, _ in local_r
-00032630: 6573 6f75 7263 6573 2e69 7465 6d73 2829  esources.items()
-00032640: 3a0a 2020 2020 2020 2020 6966 2072 6669  :.        if rfi
-00032650: 6c65 6e61 6d65 206e 6f74 2069 6e20 6368  lename not in ch
-00032660: 616e 6765 643a 0a20 2020 2020 2020 2020  anged:.         
-00032670: 2020 2066 6f72 2072 6573 6f75 7263 6520     for resource 
-00032680: 696e 2072 656d 6f74 655f 6461 7461 736f  in remote_dataso
-00032690: 7572 6365 7320 2b20 7265 6d6f 7465 5f70  urces + remote_p
-000326a0: 6970 6573 3a0a 2020 2020 2020 2020 2020  ipes:.          
-000326b0: 2020 2020 2020 7072 6f70 6572 7469 6573        properties
-000326c0: 203d 2067 6574 5f6e 616d 655f 7665 7273   = get_name_vers
-000326d0: 696f 6e28 7265 736f 7572 6365 5b22 6e61  ion(resource["na
-000326e0: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
-000326f0: 2020 2020 2020 6e61 6d65 203d 2070 726f        name = pro
-00032700: 7065 7274 6965 732e 6765 7428 226e 616d  perties.get("nam
-00032710: 6522 2c20 4e6f 6e65 290a 2020 2020 2020  e", None).      
-00032720: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
-00032730: 6520 616e 6420 6e61 6d65 203d 3d20 7266  e and name == rf
-00032740: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
-00032750: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00032760: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-00032770: 2020 2020 6966 2077 6974 685f 7072 696e      if with_prin
-00032780: 7420 616e 6420 7266 696c 656e 616d 6520  t and rfilename 
-00032790: 6e6f 7420 696e 2063 6861 6e67 6564 3a0a  not in changed:.
-000327a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000327b0: 2020 2020 636c 6963 6b2e 6563 686f 2866      click.echo(f
-000327c0: 227b 7266 696c 656e 616d 657d 206f 6e6c  "{rfilename} onl
-000327d0: 7920 6578 6973 7473 206c 6f63 616c 6c79  y exists locally
-000327e0: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
-000327f0: 2020 2020 2063 6861 6e67 6564 5b72 6669       changed[rfi
-00032800: 6c65 6e61 6d65 5d20 3d20 226c 6f63 616c  lename] = "local
-00032810: 220a 2020 2020 6966 2063 6c65 616e 5f75  ".    if clean_u
-00032820: 703a 0a20 2020 2020 2020 2073 6875 7469  p:.        shuti
-00032830: 6c2e 726d 7472 6565 2874 6172 6765 745f  l.rmtree(target_
-00032840: 6469 7229 0a0a 2020 2020 7265 7475 726e  dir)..    return
-00032850: 2063 6861 6e67 6564 0a0a 0a61 7379 6e63   changed...async
-00032860: 2064 6566 2064 6966 665f 6669 6c65 7328   def diff_files(
-00032870: 0a20 2020 2066 726f 6d5f 6669 6c65 3a20  .    from_file: 
-00032880: 7374 722c 0a20 2020 2074 6f5f 6669 6c65  str,.    to_file
-00032890: 3a20 7374 722c 0a20 2020 2066 726f 6d5f  : str,.    from_
-000328a0: 6669 6c65 5f73 7566 6669 783a 2073 7472  file_suffix: str
-000328b0: 203d 2022 5b72 656d 6f74 655d 222c 0a20   = "[remote]",. 
-000328c0: 2020 2074 6f5f 6669 6c65 5f73 7566 6669     to_file_suffi
-000328d0: 783a 2073 7472 203d 2022 5b6c 6f63 616c  x: str = "[local
-000328e0: 5d22 2c0a 2020 2020 7769 7468 5f66 6f72  ]",.    with_for
-000328f0: 6d61 743a 2062 6f6f 6c20 3d20 5472 7565  mat: bool = True
-00032900: 2c0a 2020 2020 7769 7468 5f63 6f6c 6f72  ,.    with_color
-00032910: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00032920: 2020 2020 636c 6965 6e74 3a20 4f70 7469      client: Opti
-00032930: 6f6e 616c 5b54 696e 7942 5d20 3d20 4e6f  onal[TinyB] = No
-00032940: 6e65 2c0a 2020 2020 666f 725f 6465 706c  ne,.    for_depl
-00032950: 6f79 3a20 626f 6f6c 203d 2046 616c 7365  oy: bool = False
-00032960: 2c0a 293a 0a20 2020 2064 6566 2066 696c  ,.):.    def fil
-00032970: 655f 6c69 6e65 7328 6669 6c65 6e61 6d65  e_lines(filename
-00032980: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-00032990: 6f70 656e 2866 696c 656e 616d 6529 2061  open(filename) a
-000329a0: 7320 6669 6c65 3a0a 2020 2020 2020 2020  s file:.        
-000329b0: 2020 2020 7265 7475 726e 2066 696c 652e      return file.
-000329c0: 7265 6164 6c69 6e65 7328 290a 0a20 2020  readlines()..   
-000329d0: 2061 7379 6e63 2064 6566 2070 6172 7365   async def parse
-000329e0: 2866 696c 656e 616d 652c 2077 6974 685f  (filename, with_
-000329f0: 666f 726d 6174 3d54 7275 652c 2075 6e72  format=True, unr
-00032a00: 6f6c 6c5f 696e 636c 7564 6573 3d46 616c  oll_includes=Fal
-00032a10: 7365 293a 0a20 2020 2020 2020 2065 7874  se):.        ext
-00032a20: 656e 7369 6f6e 7320 3d20 5061 7468 2866  ensions = Path(f
-00032a30: 696c 656e 616d 6529 2e73 7566 6669 7865  ilename).suffixe
-00032a40: 730a 2020 2020 2020 2020 6c69 6e65 7320  s.        lines 
-00032a50: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-00032a60: 6620 6973 5f66 696c 655f 615f 6461 7461  f is_file_a_data
-00032a70: 736f 7572 6365 2866 696c 656e 616d 6529  source(filename)
-00032a80: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
-00032a90: 6e65 7320 3d20 280a 2020 2020 2020 2020  nes = (.        
-00032aa0: 2020 2020 2020 2020 6177 6169 7420 666f          await fo
-00032ab0: 726d 6174 5f64 6174 6173 6f75 7263 6528  rmat_datasource(
-00032ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032ad0: 2020 2020 2066 696c 656e 616d 652c 0a20       filename,. 
-00032ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032af0: 2020 2075 6e72 6f6c 6c5f 696e 636c 7564     unroll_includ
-00032b00: 6573 3d75 6e72 6f6c 6c5f 696e 636c 7564  es=unroll_includ
-00032b10: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00032b20: 2020 2020 2020 2020 666f 725f 6469 6666          for_diff
-00032b30: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00032b40: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-00032b50: 743d 636c 6965 6e74 2c0a 2020 2020 2020  t=client,.      
-00032b60: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00032b70: 706c 6163 655f 696e 636c 7564 6573 3d54  place_includes=T
-00032b80: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00032b90: 2020 2020 2020 2020 2066 6f72 5f64 6570           for_dep
-00032ba0: 6c6f 795f 6469 6666 3d66 6f72 5f64 6570  loy_diff=for_dep
-00032bb0: 6c6f 792c 0a20 2020 2020 2020 2020 2020  loy,.           
-00032bc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00032bd0: 2020 2020 2020 2069 6620 7769 7468 5f66         if with_f
-00032be0: 6f72 6d61 740a 2020 2020 2020 2020 2020  ormat.          
-00032bf0: 2020 2020 2020 656c 7365 2066 696c 655f        else file_
-00032c00: 6c69 6e65 7328 6669 6c65 6e61 6d65 290a  lines(filename).
-00032c10: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00032c20: 2020 2020 2020 656c 6966 2028 222e 7069        elif (".pi
-00032c30: 7065 2220 696e 2065 7874 656e 7369 6f6e  pe" in extension
-00032c40: 7329 206f 7220 2822 2e69 6e63 6c22 2069  s) or (".incl" i
-00032c50: 6e20 6578 7465 6e73 696f 6e73 293a 0a20  n extensions):. 
-00032c60: 2020 2020 2020 2020 2020 206c 696e 6573             lines
-00032c70: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00032c80: 2020 2020 2061 7761 6974 2066 6f72 6d61       await forma
-00032c90: 745f 7069 7065 280a 2020 2020 2020 2020  t_pipe(.        
-00032ca0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00032cb0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00032cc0: 2020 2020 2020 2020 2020 4445 4641 554c            DEFAUL
-00032cd0: 545f 464d 545f 4c49 4e45 5f4c 454e 4754  T_FMT_LINE_LENGT
-00032ce0: 482c 0a20 2020 2020 2020 2020 2020 2020  H,.             
-00032cf0: 2020 2020 2020 2075 6e72 6f6c 6c5f 696e         unroll_in
-00032d00: 636c 7564 6573 3d75 6e72 6f6c 6c5f 696e  cludes=unroll_in
-00032d10: 636c 7564 6573 2c0a 2020 2020 2020 2020  cludes,.        
-00032d20: 2020 2020 2020 2020 2020 2020 7265 706c              repl
-00032d30: 6163 655f 696e 636c 7564 6573 3d54 7275  ace_includes=Tru
-00032d40: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00032d50: 2020 2020 2020 2066 6f72 5f64 6570 6c6f         for_deplo
-00032d60: 795f 6469 6666 3d66 6f72 5f64 6570 6c6f  y_diff=for_deplo
-00032d70: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-00032d80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00032d90: 2020 2020 2069 6620 7769 7468 5f66 6f72       if with_for
-00032da0: 6d61 740a 2020 2020 2020 2020 2020 2020  mat.            
-00032db0: 2020 2020 656c 7365 2066 696c 655f 6c69      else file_li
-00032dc0: 6e65 7328 6669 6c65 6e61 6d65 290a 2020  nes(filename).  
-00032dd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00032de0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00032df0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00032e00: 2866 2255 6e73 7570 706f 7274 6564 2066  (f"Unsupported f
-00032e10: 696c 6520 7479 7065 3a20 7b66 696c 656e  ile type: {filen
-00032e20: 616d 657d 2229 0a20 2020 2020 2020 2069  ame}").        i
-00032e30: 6620 6c69 6e65 733a 0a20 2020 2020 2020  f lines:.       
-00032e40: 2020 2020 2072 6574 7572 6e20 5b66 227b       return [f"{
-00032e50: 6c7d 5c6e 2220 666f 7220 6c20 696e 206c  l}\n" for l in l
-00032e60: 696e 6573 2e73 706c 6974 2822 5c6e 2229  ines.split("\n")
-00032e70: 5d20 6966 2077 6974 685f 666f 726d 6174  ] if with_format
-00032e80: 2065 6c73 6520 6c69 6e65 7320 2023 206e   else lines  # n
-00032e90: 6f71 613a 2045 3734 310a 0a20 2020 2074  oqa: E741..    t
-00032ea0: 7279 3a0a 2020 2020 2020 2020 6c69 6e65  ry:.        line
-00032eb0: 7331 203d 2061 7761 6974 2070 6172 7365  s1 = await parse
-00032ec0: 2866 726f 6d5f 6669 6c65 2c20 7769 7468  (from_file, with
-00032ed0: 5f66 6f72 6d61 7429 0a20 2020 2020 2020  _format).       
-00032ee0: 206c 696e 6573 3220 3d20 6177 6169 7420   lines2 = await 
-00032ef0: 7061 7273 6528 746f 5f66 696c 652c 2077  parse(to_file, w
-00032f00: 6974 685f 666f 726d 6174 2c20 756e 726f  ith_format, unro
-00032f10: 6c6c 5f69 6e63 6c75 6465 733d 5472 7565  ll_includes=True
-00032f20: 290a 2020 2020 6578 6365 7074 2046 696c  ).    except Fil
-00032f30: 654e 6f74 466f 756e 6445 7272 6f72 2061  eNotFoundError a
-00032f40: 7320 653a 0a20 2020 2020 2020 2066 696c  s e:.        fil
-00032f50: 656e 616d 6520 3d20 6f73 2e70 6174 682e  ename = os.path.
-00032f60: 6261 7365 6e61 6d65 2873 7472 2865 2929  basename(str(e))
-00032f70: 2e73 7472 6970 2822 2722 290a 2020 2020  .strip("'").    
-00032f80: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
-00032f90: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
-00032fa0: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
-00032fb0: 7272 6f72 5f64 6966 665f 6669 6c65 2866  rror_diff_file(f
-00032fc0: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
-00032fd0: 2929 0a0a 2020 2020 6966 206e 6f74 206c  ))..    if not l
-00032fe0: 696e 6573 3120 6f72 206e 6f74 206c 696e  ines1 or not lin
-00032ff0: 6573 323a 0a20 2020 2020 2020 2072 6574  es2:.        ret
-00033000: 7572 6e0a 0a20 2020 2064 6966 6620 3d20  urn..    diff = 
-00033010: 6469 6666 6c69 622e 756e 6966 6965 645f  difflib.unified_
-00033020: 6469 6666 280a 2020 2020 2020 2020 6c69  diff(.        li
-00033030: 6e65 7331 2c20 6c69 6e65 7332 2c20 6672  nes1, lines2, fr
-00033040: 6f6d 6669 6c65 3d66 227b 5061 7468 2866  omfile=f"{Path(f
-00033050: 726f 6d5f 6669 6c65 292e 6e61 6d65 7d20  rom_file).name} 
-00033060: 7b66 726f 6d5f 6669 6c65 5f73 7566 6669  {from_file_suffi
-00033070: 787d 222c 2074 6f66 696c 653d 6622 7b74  x}", tofile=f"{t
-00033080: 6f5f 6669 6c65 7d20 7b74 6f5f 6669 6c65  o_file} {to_file
-00033090: 5f73 7566 6669 787d 220a 2020 2020 290a  _suffix}".    ).
-000330a0: 0a20 2020 2069 6620 7769 7468 5f63 6f6c  .    if with_col
-000330b0: 6f72 3a0a 2020 2020 2020 2020 6469 6666  or:.        diff
-000330c0: 203d 2063 6f6c 6f72 5f64 6966 6628 6469   = color_diff(di
-000330d0: 6666 290a 0a20 2020 2072 6574 7572 6e20  ff)..    return 
-000330e0: 6469 6666 0a0a 0a64 6566 2069 735f 656e  diff...def is_en
-000330f0: 6470 6f69 6e74 2872 6573 6f75 7263 653a  dpoint(resource:
-00033100: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
-00033110: 7472 2c20 416e 795d 5d29 202d 3e20 626f  tr, Any]]) -> bo
-00033120: 6f6c 3a0a 2020 2020 6966 2072 6573 6f75  ol:.    if resou
-00033130: 7263 6520 616e 6420 6c65 6e28 7265 736f  rce and len(reso
-00033140: 7572 6365 2e67 6574 2822 746f 6b65 6e73  urce.get("tokens
-00033150: 222c 205b 5d29 2920 213d 2030 2061 6e64  ", [])) != 0 and
-00033160: 2072 6573 6f75 7263 652e 6765 7428 2272   resource.get("r
-00033170: 6573 6f75 7263 6522 2920 3d3d 2022 7069  esource") == "pi
-00033180: 7065 7322 3a0a 2020 2020 2020 2020 7265  pes":.        re
-00033190: 7475 726e 2054 7275 650a 2020 2020 7265  turn True.    re
-000331a0: 7475 726e 2046 616c 7365 0a0a 0a64 6566  turn False...def
-000331b0: 2069 735f 6d61 7465 7269 616c 697a 6564   is_materialized
-000331c0: 2872 6573 6f75 7263 653a 204f 7074 696f  (resource: Optio
-000331d0: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
-000331e0: 795d 5d29 202d 3e20 626f 6f6c 3a0a 2020  y]]) -> bool:.  
-000331f0: 2020 6966 206e 6f74 2072 6573 6f75 7263    if not resourc
-00033200: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00033210: 6e20 4661 6c73 650a 0a20 2020 2069 735f  n False..    is_
-00033220: 6d61 7465 7269 616c 697a 6564 203d 2061  materialized = a
-00033230: 6e79 280a 2020 2020 2020 2020 5b6e 6f64  ny(.        [nod
-00033240: 652e 6765 7428 2270 6172 616d 7322 2c20  e.get("params", 
-00033250: 7b7d 292e 6765 7428 2274 7970 6522 2c20  {}).get("type", 
-00033260: 4e6f 6e65 2920 3d3d 2022 6d61 7465 7269  None) == "materi
-00033270: 616c 697a 6564 2220 666f 7220 6e6f 6465  alized" for node
-00033280: 2069 6e20 7265 736f 7572 6365 2e67 6574   in resource.get
-00033290: 2822 6e6f 6465 7322 2c20 5b5d 2920 6f72  ("nodes", []) or
-000332a0: 205b 5d5d 0a20 2020 2029 0a20 2020 2072   []].    ).    r
-000332b0: 6574 7572 6e20 6973 5f6d 6174 6572 6961  eturn is_materia
-000332c0: 6c69 7a65 640a 0a0a 6465 6620 6973 5f65  lized...def is_e
-000332d0: 6e64 706f 696e 745f 7769 7468 5f6e 6f5f  ndpoint_with_no_
-000332e0: 6465 7065 6e64 656e 6369 6573 280a 2020  dependencies(.  
-000332f0: 2020 7265 736f 7572 6365 3a20 4469 6374    resource: Dict
-00033300: 5b73 7472 2c20 416e 795d 2c20 6465 705f  [str, Any], dep_
-00033310: 6d61 703a 2044 6963 745b 7374 722c 2053  map: Dict[str, S
-00033320: 6574 5b73 7472 5d5d 2c20 746f 5f72 756e  et[str]], to_run
-00033330: 3a20 4469 6374 5b73 7472 2c20 4469 6374  : Dict[str, Dict
-00033340: 5b73 7472 2c20 416e 795d 5d0a 2920 2d3e  [str, Any]].) ->
-00033350: 2062 6f6f 6c3a 0a20 2020 2069 6620 6e6f   bool:.    if no
-00033360: 7420 7265 736f 7572 6365 206f 7220 7265  t resource or re
-00033370: 736f 7572 6365 2e67 6574 2822 7265 736f  source.get("reso
-00033380: 7572 6365 2229 203d 3d20 2264 6174 6173  urce") == "datas
-00033390: 6f75 7263 6573 223a 0a20 2020 2020 2020  ources":.       
-000333a0: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-000333b0: 2020 2066 6f72 206e 6f64 6520 696e 2072     for node in r
-000333c0: 6573 6f75 7263 652e 6765 7428 226e 6f64  esource.get("nod
-000333d0: 6573 222c 205b 5d29 3a0a 2020 2020 2020  es", []):.      
-000333e0: 2020 2320 4649 584d 453a 2068 7474 7073    # FIXME: https
-000333f0: 3a2f 2f67 6974 6c61 622e 636f 6d2f 7469  ://gitlab.com/ti
-00033400: 6e79 6269 7264 2f61 6e61 6c79 7469 6373  nybird/analytics
-00033410: 2f2d 2f69 7373 7565 732f 3233 3931 0a20  /-/issues/2391. 
-00033420: 2020 2020 2020 2069 6620 6e6f 6465 2e67         if node.g
-00033430: 6574 2822 7061 7261 6d73 222c 207b 7d29  et("params", {})
-00033440: 2e67 6574 2822 7479 7065 222c 2022 2229  .get("type", "")
-00033450: 2e6c 6f77 6572 2829 2069 6e20 5b0a 2020  .lower() in [.  
-00033460: 2020 2020 2020 2020 2020 5069 7065 4e6f            PipeNo
-00033470: 6465 5479 7065 732e 4d41 5445 5249 414c  deTypes.MATERIAL
-00033480: 495a 4544 2c0a 2020 2020 2020 2020 2020  IZED,.          
-00033490: 2020 5069 7065 4e6f 6465 5479 7065 732e    PipeNodeTypes.
-000334a0: 434f 5059 2c0a 2020 2020 2020 2020 2020  COPY,.          
-000334b0: 2020 5069 7065 4e6f 6465 5479 7065 732e    PipeNodeTypes.
-000334c0: 4441 5441 5f53 494e 4b2c 0a20 2020 2020  DATA_SINK,.     
-000334d0: 2020 205d 3a0a 2020 2020 2020 2020 2020     ]:.          
-000334e0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-000334f0: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
-00033500: 7565 7320 696e 2064 6570 5f6d 6170 2e69  ues in dep_map.i
-00033510: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00033520: 6966 2072 6573 6f75 7263 655b 2272 6573  if resource["res
-00033530: 6f75 7263 655f 6e61 6d65 225d 2069 6e20  ource_name"] in 
-00033540: 7661 6c75 6573 3a0a 2020 2020 2020 2020  values:.        
-00033550: 2020 2020 7220 3d20 746f 5f72 756e 2e67      r = to_run.g
-00033560: 6574 286b 6579 2c20 4e6f 6e65 290a 2020  et(key, None).  
-00033570: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00033580: 2072 3a0a 2020 2020 2020 2020 2020 2020   r:.            
-00033590: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-000335a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000335b0: 4661 6c73 650a 0a20 2020 2064 6570 7320  False..    deps 
-000335c0: 3d20 6465 705f 6d61 702e 6765 7428 7265  = dep_map.get(re
-000335d0: 736f 7572 6365 5b22 7265 736f 7572 6365  source["resource
-000335e0: 5f6e 616d 6522 5d29 0a20 2020 2069 6620  _name"]).    if 
-000335f0: 6e6f 7420 6465 7073 3a0a 2020 2020 2020  not deps:.      
-00033600: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00033610: 2020 2066 6f72 2064 6570 2069 6e20 6465     for dep in de
-00033620: 7073 3a0a 2020 2020 2020 2020 7220 3d20  ps:.        r = 
-00033630: 746f 5f72 756e 2e67 6574 2864 6570 2c20  to_run.get(dep, 
-00033640: 4e6f 6e65 290a 2020 2020 2020 2020 6966  None).        if
-00033650: 2069 735f 656e 6470 6f69 6e74 2872 2920   is_endpoint(r) 
-00033660: 6f72 2069 735f 6d61 7465 7269 616c 697a  or is_materializ
-00033670: 6564 2872 293a 0a20 2020 2020 2020 2020  ed(r):.         
-00033680: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-00033690: 0a20 2020 2072 6574 7572 6e20 5472 7565  .    return True
-000336a0: 0a0a 0a64 6566 2067 6574 5f74 6172 6765  ...def get_targe
-000336b0: 745f 6d61 7465 7269 616c 697a 6564 5f64  t_materialized_d
-000336c0: 6174 615f 736f 7572 6365 5f6e 616d 6528  ata_source_name(
-000336d0: 7265 736f 7572 6365 3a20 4f70 7469 6f6e  resource: Option
-000336e0: 616c 5b44 6963 745b 7374 722c 2041 6e79  al[Dict[str, Any
-000336f0: 5d5d 2920 2d3e 204f 7074 696f 6e61 6c5b  ]]) -> Optional[
-00033700: 7374 725d 3a0a 2020 2020 6966 206e 6f74  str]:.    if not
-00033710: 2072 6573 6f75 7263 653a 0a20 2020 2020   resource:.     
-00033720: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00033730: 2020 2020 666f 7220 6e6f 6465 2069 6e20      for node in 
-00033740: 7265 736f 7572 6365 2e67 6574 2822 6e6f  resource.get("no
-00033750: 6465 7322 2c20 5b5d 293a 0a20 2020 2020  des", []):.     
-00033760: 2020 2023 2046 4958 4d45 3a20 6874 7470     # FIXME: http
-00033770: 733a 2f2f 6769 746c 6162 2e63 6f6d 2f74  s://gitlab.com/t
-00033780: 696e 7962 6972 642f 616e 616c 7974 6963  inybird/analytic
-00033790: 732f 2d2f 6973 7375 6573 2f32 3339 310a  s/-/issues/2391.
-000337a0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-000337b0: 6765 7428 2270 6172 616d 7322 2c20 7b7d  get("params", {}
-000337c0: 292e 6765 7428 2274 7970 6522 2c20 2222  ).get("type", ""
-000337d0: 292e 6c6f 7765 7228 2920 3d3d 2050 6970  ).lower() == Pip
-000337e0: 654e 6f64 6554 7970 6573 2e4d 4154 4552  eNodeTypes.MATER
-000337f0: 4941 4c49 5a45 443a 0a20 2020 2020 2020  IALIZED:.       
-00033800: 2020 2020 2072 6574 7572 6e20 6e6f 6465       return node
-00033810: 2e67 6574 2822 7061 7261 6d73 2229 5b22  .get("params")["
-00033820: 6461 7461 736f 7572 6365 225d 2e73 706c  datasource"].spl
-00033830: 6974 2822 5f5f 7622 295b 305d 0a0a 2020  it("__v")[0]..  
-00033840: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-00033850: 6465 6620 6973 5f64 6174 6173 6f75 7263  def is_datasourc
-00033860: 6528 7265 736f 7572 6365 3a20 4f70 7469  e(resource: Opti
-00033870: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
-00033880: 6e79 5d5d 2920 2d3e 2062 6f6f 6c3a 0a20  ny]]) -> bool:. 
-00033890: 2020 2069 6620 7265 736f 7572 6365 2061     if resource a
-000338a0: 6e64 2072 6573 6f75 7263 652e 6765 7428  nd resource.get(
-000338b0: 2272 6573 6f75 7263 6522 2920 3d3d 2022  "resource") == "
-000338c0: 6461 7461 736f 7572 6365 7322 3a0a 2020  datasources":.  
-000338d0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-000338e0: 650a 2020 2020 7265 7475 726e 2046 616c  e.    return Fal
-000338f0: 7365 0a0a 0a61 7379 6e63 2064 6566 2063  se...async def c
-00033900: 7265 6174 655f 7265 6c65 6173 6528 0a20  reate_release(. 
-00033910: 2020 2063 6c69 656e 743a 2054 696e 7942     client: TinyB
-00033920: 2c20 636f 6e66 6967 3a20 556e 696f 6e5b  , config: Union[
-00033930: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
-00033940: 434c 4943 6f6e 6669 675d 2c20 7365 6d76  CLIConfig], semv
-00033950: 6572 3a20 7374 722c 2066 6f6c 6465 723a  er: str, folder:
-00033960: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00033970: 204e 6f6e 650a 2920 2d3e 204e 6f6e 653a   None.) -> None:
-00033980: 0a20 2020 2069 6620 6e6f 7420 666f 6c64  .    if not fold
-00033990: 6572 3a0a 2020 2020 2020 2020 666f 6c64  er:.        fold
-000339a0: 6572 203d 2067 6574 6377 6428 290a 2020  er = getcwd().  
-000339b0: 2020 636c 695f 6769 745f 7265 6c65 6173    cli_git_releas
-000339c0: 6520 3d20 4e6f 6e65 0a20 2020 2074 7279  e = None.    try
-000339d0: 3a0a 2020 2020 2020 2020 636c 695f 6769  :.        cli_gi
-000339e0: 745f 7265 6c65 6173 6520 3d20 434c 4947  t_release = CLIG
-000339f0: 6974 5265 6c65 6173 6528 7061 7468 3d66  itRelease(path=f
-00033a00: 6f6c 6465 7229 0a20 2020 2020 2020 2063  older).        c
-00033a10: 6f6d 6d69 7420 3d20 636c 695f 6769 745f  ommit = cli_git_
-00033a20: 7265 6c65 6173 652e 6865 6164 5f63 6f6d  release.head_com
-00033a30: 6d69 7428 290a 2020 2020 6578 6365 7074  mit().    except
-00033a40: 2043 4c49 4769 7452 656c 6561 7365 4578   CLIGitReleaseEx
-00033a50: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00033a60: 2072 6169 7365 2043 4c49 4769 7452 656c   raise CLIGitRel
-00033a70: 6561 7365 4578 6365 7074 696f 6e28 4665  easeException(Fe
-00033a80: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-00033a90: 726f 725f 6e6f 5f67 6974 5f72 6570 6f5f  ror_no_git_repo_
-00033aa0: 666f 725f 696e 6974 2872 6570 6f5f 7061  for_init(repo_pa
-00033ab0: 7468 3d66 6f6c 6465 7229 290a 0a20 2020  th=folder))..   
-00033ac0: 2061 7761 6974 2063 6c69 656e 742e 7265   await client.re
-00033ad0: 6c65 6173 655f 6e65 7728 636f 6e66 6967  lease_new(config
-00033ae0: 5b22 6964 225d 2c20 7365 6d76 6572 2c20  ["id"], semver, 
-00033af0: 636f 6d6d 6974 290a 2020 2020 636c 6963  commit).    clic
-00033b00: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-00033b10: 616e 6167 6572 2e73 7563 6365 7373 5f64  anager.success_d
-00033b20: 6570 6c6f 796d 656e 745f 7265 6c65 6173  eployment_releas
-00033b30: 6528 7365 6d76 6572 3d73 656d 7665 7229  e(semver=semver)
-00033b40: 290a 0a0a 6465 6620 6861 735f 696e 7465  )...def has_inte
-00033b50: 726e 616c 5f64 6174 6166 696c 6573 2866  rnal_datafiles(f
-00033b60: 6f6c 6465 723a 2073 7472 2920 2d3e 2062  older: str) -> b
-00033b70: 6f6f 6c3a 0a20 2020 2066 6f6c 6465 7220  ool:.    folder 
-00033b80: 3d20 666f 6c64 6572 206f 7220 222e 220a  = folder or ".".
-00033b90: 2020 2020 6669 6c65 6e61 6d65 7320 3d20      filenames = 
-00033ba0: 6765 745f 7072 6f6a 6563 745f 6669 6c65  get_project_file
-00033bb0: 6e61 6d65 7328 666f 6c64 6572 290a 2020  names(folder).  
-00033bc0: 2020 7265 7475 726e 2061 6e79 285b 6620    return any([f 
-00033bd0: 666f 7220 6620 696e 2066 696c 656e 616d  for f in filenam
-00033be0: 6573 2069 6620 2273 7061 6e73 2220 696e  es if "spans" in
-00033bf0: 2073 7472 2866 2920 616e 6420 2276 656e   str(f) and "ven
-00033c00: 646f 7222 206e 6f74 2069 6e20 7374 7228  dor" not in str(
-00033c10: 6629 5d29 0a0a 0a64 6566 2069 735f 6669  f)])...def is_fi
-00033c20: 6c65 5f61 5f64 6174 6173 6f75 7263 6528  le_a_datasource(
-00033c30: 6669 6c65 6e61 6d65 3a20 7374 7229 202d  filename: str) -
-00033c40: 3e20 626f 6f6c 3a0a 2020 2020 6578 7465  > bool:.    exte
-00033c50: 6e73 696f 6e73 203d 2050 6174 6828 6669  nsions = Path(fi
-00033c60: 6c65 6e61 6d65 292e 7375 6666 6978 6573  lename).suffixes
-00033c70: 0a20 2020 2069 6620 222e 6461 7461 736f  .    if ".dataso
-00033c80: 7572 6365 2220 696e 2065 7874 656e 7369  urce" in extensi
-00033c90: 6f6e 733a 2020 2320 4163 6365 7074 7320  ons:  # Accepts 
-00033ca0: 272e 6461 7461 736f 7572 6365 2720 616e  '.datasource' an
-00033cb0: 6420 272e 6461 7461 736f 7572 6365 2e69  d '.datasource.i
-00033cc0: 6e63 6c27 0a20 2020 2020 2020 2072 6574  ncl'.        ret
-00033cd0: 7572 6e20 5472 7565 0a0a 2020 2020 6966  urn True..    if
-00033ce0: 2022 2e69 6e63 6c22 2069 6e20 6578 7465   ".incl" in exte
-00033cf0: 6e73 696f 6e73 3a0a 2020 2020 2020 2020  nsions:.        
-00033d00: 6c69 6e65 7320 3d20 5b5d 0a20 2020 2020  lines = [].     
-00033d10: 2020 2077 6974 6820 6f70 656e 2866 696c     with open(fil
-00033d20: 656e 616d 6529 2061 7320 6669 6c65 3a0a  ename) as file:.
-00033d30: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-00033d40: 7320 3d20 6669 6c65 2e72 6561 646c 696e  s = file.readlin
-00033d50: 6573 2829 0a0a 2020 2020 2020 2020 666f  es()..        fo
-00033d60: 7220 6c69 6e65 2069 6e20 6c69 6e65 733a  r line in lines:
-00033d70: 0a20 2020 2020 2020 2020 2020 2074 7269  .            tri
-00033d80: 6d6d 6564 5f6c 696e 6520 3d20 6c69 6e65  mmed_line = line
-00033d90: 2e73 7472 6970 2829 2e6c 6f77 6572 2829  .strip().lower()
-00033da0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00033db0: 7472 696d 6d65 645f 6c69 6e65 2e73 7461  trimmed_line.sta
-00033dc0: 7274 7377 6974 6828 2273 6368 656d 6122  rtswith("schema"
-00033dd0: 2920 6f72 2074 7269 6d6d 6564 5f6c 696e  ) or trimmed_lin
-00033de0: 652e 7374 6172 7473 7769 7468 2822 656e  e.startswith("en
-00033df0: 6769 6e65 2229 3a0a 2020 2020 2020 2020  gine"):.        
-00033e00: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00033e10: 7275 650a 0a20 2020 2072 6574 7572 6e20  rue..    return 
-00033e20: 4661 6c73 650a                           False.
+0002a300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002a310: 2020 2020 2020 7072 6f63 6573 7365 642e        processed.
+0002a320: 6164 6428 6e61 6d65 290a 0a20 2020 2020  add(name)..     
+0002a330: 2020 2020 2020 2023 204e 6f77 2c20 7765         # Now, we
+0002a340: 2077 696c 6c20 6372 6561 7465 2061 206d   will create a m
+0002a350: 6170 206f 6620 616c 6c20 7468 6520 656e  ap of all the en
+0002a360: 6470 6f69 6e74 7320 616e 6420 7468 6572  dpoints and ther
+0002a370: 6520 6465 7065 6e64 656e 6369 6573 0a20  e dependencies. 
+0002a380: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0002a390: 6172 6520 7573 696e 6720 7468 6520 666f  are using the fo
+0002a3a0: 726b 646f 776e 7374 7265 616d 2067 7261  rkdownstream gra
+0002a3b0: 7068 2074 6f20 6765 7420 7468 6520 6465  ph to get the de
+0002a3c0: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
+0002a3d0: 6520 656e 6470 6f69 6e74 7320 6173 2074  e endpoints as t
+0002a3e0: 6865 206e 6f72 6d61 6c20 6465 7065 6e64  he normal depend
+0002a3f0: 656e 6369 6573 2067 7261 7068 206f 6e6c  encies graph onl
+0002a400: 7920 636f 6e74 6169 6e73 2074 6865 2072  y contains the r
+0002a410: 6573 6f75 7263 6573 2074 6861 7420 6172  esources that ar
+0002a420: 6520 676f 696e 6720 746f 2062 6520 6465  e going to be de
+0002a430: 706c 6f79 6564 0a20 2020 2020 2020 2020  ployed.         
+0002a440: 2020 2023 2042 7574 2064 6f65 7320 6e6f     # But does no
+0002a450: 7420 696e 636c 7564 6520 7468 6520 6d69  t include the mi
+0002a460: 7373 696e 6720 6761 7073 0a20 2020 2020  ssing gaps.     
+0002a470: 2020 2020 2020 2023 2049 6620 7765 2068         # If we h
+0002a480: 6176 6520 454e 4450 4f49 4e54 5f41 202d  ave ENDPOINT_A -
+0002a490: 2d2d 2d3e 204d 565f 5049 5045 5f42 202d  ---> MV_PIPE_B -
+0002a4a0: 2d2d 2d2d 3e20 4441 5441 534f 5552 4345  ----> DATASOURCE
+0002a4b0: 5f42 202d 2d2d 2d2d 2d3e 2045 4e44 504f  _B ------> ENDPO
+0002a4c0: 494e 545f 430a 2020 2020 2020 2020 2020  INT_C.          
+0002a4d0: 2020 2320 5768 6572 6520 656e 6470 6f69    # Where endpoi
+0002a4e0: 6e74 2041 2069 7320 6265 696e 6720 7573  nt A is being us
+0002a4f0: 6564 2069 6e20 7468 6520 4d56 5f50 4950  ed in the MV_PIP
+0002a500: 455f 422c 2069 6620 7765 206f 6e6c 7920  E_B, if we only 
+0002a510: 6d6f 6469 6679 2074 6865 2065 6e64 706f  modify the endpo
+0002a520: 696e 7420 410a 2020 2020 2020 2020 2020  int A.          
+0002a530: 2020 2320 5468 6520 6465 7065 6e64 656e    # The dependen
+0002a540: 6369 6573 2067 7261 7068 2077 696c 6c20  cies graph will 
+0002a550: 6f6e 6c79 2063 6f6e 7461 696e 2074 6865  only contain the
+0002a560: 2065 6e64 706f 696e 7420 4120 616e 6420   endpoint A and 
+0002a570: 7468 6520 4d56 5f50 4950 455f 422c 2062  the MV_PIPE_B, b
+0002a580: 7574 206e 6f74 2074 6865 2044 4154 4153  ut not the DATAS
+0002a590: 4f55 5243 455f 4220 616e 6420 7468 6520  OURCE_B and the 
+0002a5a0: 454e 4450 4f49 4e54 5f43 0a20 2020 2020  ENDPOINT_C.     
+0002a5b0: 2020 2020 2020 2067 726f 7570 7320 3d20         groups = 
+0002a5c0: 5b67 726f 7570 2066 6f72 2067 726f 7570  [group for group
+0002a5d0: 2069 6e20 746f 706f 736f 7274 2864 6570   in toposort(dep
+0002a5e0: 656e 6465 6e63 6965 735f 6772 6170 685f  endencies_graph_
+0002a5f0: 666f 726b 5f64 6f77 6e73 7472 6561 6d29  fork_downstream)
+0002a600: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+0002a610: 7220 6772 6f75 7020 696e 2067 726f 7570  r group in group
+0002a620: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002a630: 2020 2066 6f72 206e 616d 6520 696e 2067     for name in g
+0002a640: 726f 7570 3a0a 2020 2020 2020 2020 2020  roup:.          
+0002a650: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
+0002a660: 6520 696e 2070 726f 6365 7373 6564 206f  e in processed o
+0002a670: 7220 6e6f 7420 6973 5f65 6e64 706f 696e  r not is_endpoin
+0002a680: 7428 7265 736f 7572 6365 735f 746f 5f72  t(resources_to_r
+0002a690: 756e 5f66 6f72 6b5f 646f 776e 7374 7265  un_fork_downstre
+0002a6a0: 616d 5b6e 616d 655d 293a 0a20 2020 2020  am[name]):.     
+0002a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6c0: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+0002a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6e0: 2065 6e64 706f 696e 7473 5f64 6570 5f6d   endpoints_dep_m
+0002a6f0: 6170 5b6e 616d 655d 203d 2064 6570 656e  ap[name] = depen
+0002a700: 6465 6e63 6965 735f 6772 6170 685f 666f  dencies_graph_fo
+0002a710: 726b 5f64 6f77 6e73 7472 6561 6d5b 6e61  rk_downstream[na
+0002a720: 6d65 5d0a 0a20 2020 2020 2020 2020 2020  me]..           
+0002a730: 2023 204e 6f77 2074 6861 7420 7765 2068   # Now that we h
+0002a740: 6176 6520 7468 6520 6465 7065 6e64 656e  ave the dependen
+0002a750: 6369 6573 206f 6620 7468 6520 656e 6470  cies of the endp
+0002a760: 6f69 6e74 732c 2077 6520 6e65 6564 2074  oints, we need t
+0002a770: 6f20 6368 6563 6b20 7468 6174 2074 6865  o check that the
+0002a780: 2072 6573 6f75 7263 6573 2068 6173 206e   resources has n
+0002a790: 6f74 2062 6565 6e20 6465 706c 6f79 6564  ot been deployed
+0002a7a0: 2079 6574 2061 6e64 206f 6e6c 7920 6361   yet and only ca
+0002a7b0: 7265 2061 626f 7574 2074 6865 2065 6e64  re about the end
+0002a7c0: 706f 696e 7473 2074 6861 7420 6465 7065  points that depe
+0002a7d0: 6e64 206f 6e20 656e 6470 6f69 6e74 730a  nd on endpoints.
+0002a7e0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0002a7f0: 7073 203d 205b 6772 6f75 7020 666f 7220  ps = [group for 
+0002a800: 6772 6f75 7020 696e 2074 6f70 6f73 6f72  group in toposor
+0002a810: 7428 656e 6470 6f69 6e74 735f 6465 705f  t(endpoints_dep_
+0002a820: 6d61 7029 5d0a 0a20 2020 2020 2020 2020  map)]..         
+0002a830: 2020 2023 2041 7320 7765 2068 6176 6520     # As we have 
+0002a840: 7573 6564 2074 6865 2066 6f72 6b64 6f77  used the forkdow
+0002a850: 6e73 7472 6561 6d20 6772 6170 6820 746f  nstream graph to
+0002a860: 2067 6574 2074 6865 2064 6570 656e 6465   get the depende
+0002a870: 6e63 6965 7320 6f66 2074 6865 2065 6e64  ncies of the end
+0002a880: 706f 696e 7473 2c20 7765 2068 6176 6520  points, we have 
+0002a890: 616c 6c20 7468 6520 6465 7065 6e64 656e  all the dependen
+0002a8a0: 6369 6573 206f 6620 7468 6520 656e 6470  cies of the endp
+0002a8b0: 6f69 6e74 730a 2020 2020 2020 2020 2020  oints.          
+0002a8c0: 2020 2320 4275 7420 7765 206e 6565 6420    # But we need 
+0002a8d0: 746f 2064 6570 6c6f 7920 7468 6520 656e  to deploy the en
+0002a8e0: 6470 6f69 6e74 7320 616e 6420 7468 6520  dpoints and the 
+0002a8f0: 6465 7065 6e64 656e 6369 6573 206f 6620  dependencies of 
+0002a900: 7468 6520 656e 6470 6f69 6e74 7320 6672  the endpoints fr
+0002a910: 6f6d 206c 6566 7420 746f 2072 6967 6874  om left to right
+0002a920: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0002a930: 6f20 7765 206e 6565 6420 746f 2072 6576  o we need to rev
+0002a940: 6572 7365 2074 6865 2067 726f 7570 730a  erse the groups.
+0002a950: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0002a960: 7073 2e72 6576 6572 7365 2829 0a20 2020  ps.reverse().   
+0002a970: 2020 2020 2020 2020 2066 6f72 2067 726f           for gro
+0002a980: 7570 2069 6e20 6772 6f75 7073 3a0a 2020  up in groups:.  
+0002a990: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002a9a0: 7220 6e61 6d65 2069 6e20 6772 6f75 703a  r name in group:
+0002a9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a9c0: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
+0002a9d0: 7072 6f63 6573 7365 6420 6f72 206e 6f74  processed or not
+0002a9e0: 2069 735f 656e 6470 6f69 6e74 2872 6573   is_endpoint(res
+0002a9f0: 6f75 7263 6573 5f74 6f5f 7275 6e5f 666f  ources_to_run_fo
+0002aa00: 726b 5f64 6f77 6e73 7472 6561 6d5b 6e61  rk_downstream[na
+0002aa10: 6d65 5d29 3a0a 2020 2020 2020 2020 2020  me]):.          
+0002aa20: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0002aa30: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+0002aa40: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0002aa50: 7420 7075 7368 280a 2020 2020 2020 2020  t push(.        
+0002aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa70: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0002aa80: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002aa90: 736f 7572 6365 735f 746f 5f72 756e 5f66  sources_to_run_f
+0002aaa0: 6f72 6b5f 646f 776e 7374 7265 616d 2c0a  ork_downstream,.
+0002aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aac0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+0002aad0: 5f76 6572 7369 6f6e 732c 0a20 2020 2020  _versions,.     
+0002aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aaf0: 2020 206c 6174 6573 745f 6461 7461 736f     latest_dataso
+0002ab00: 7572 6365 5f76 6572 7369 6f6e 732c 0a20  urce_versions,. 
+0002ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab20: 2020 2020 2020 2064 7279 5f72 756e 2c0a         dry_run,.
+0002ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab40: 2020 2020 2020 2020 666f 726b 5f64 6f77          fork_dow
+0002ab50: 6e73 7472 6561 6d2c 0a20 2020 2020 2020  nstream,.       
+0002ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab70: 2066 6f72 6b2c 0a20 2020 2020 2020 2020   fork,.         
+0002ab80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aba0: 2070 726f 6365 7373 6564 2e61 6464 286e   processed.add(n
+0002abb0: 616d 6529 0a0a 2020 2020 2020 2020 2020  ame)..          
+0002abc0: 2020 2320 4e6f 7720 7765 2073 686f 756c    # Now we shoul
+0002abd0: 6420 6861 7665 2074 6865 2065 6e64 706f  d have the endpo
+0002abe0: 696e 7473 2061 6e64 2064 6174 6173 6f75  ints and datasou
+0002abf0: 7263 6573 2064 6570 6c6f 7965 642c 2077  rces deployed, w
+0002ac00: 6520 6361 6e20 6465 706c 6f79 2074 6865  e can deploy the
+0002ac10: 2072 6573 7420 6f66 2074 6865 2070 6970   rest of the pip
+0002ac20: 6573 2028 636f 7079 2026 2073 696e 6b73  es (copy & sinks
+0002ac30: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0002ac40: 5765 206e 6565 6420 746f 2072 656c 7920  We need to rely 
+0002ac50: 6f6e 2074 6865 2066 6f72 6b64 6f77 6e73  on the forkdowns
+0002ac60: 7472 6561 6d20 6772 6170 6820 6173 2069  tream graph as i
+0002ac70: 7420 636f 6e74 6169 6e73 2061 6c6c 2074  t contains all t
+0002ac80: 6865 206d 6f64 6966 6965 6420 7069 7065  he modified pipe
+0002ac90: 7320 6173 2077 656c 6c20 6173 2074 6865  s as well as the
+0002aca0: 2064 6570 656e 6465 6e63 6965 7320 6f66   dependencies of
+0002acb0: 2074 6865 2070 6970 6573 0a20 2020 2020   the pipes.     
+0002acc0: 2020 2020 2020 2023 2049 6e20 7468 6973         # In this
+0002acd0: 2063 6173 652c 2077 6520 646f 6e27 7420   case, we don't 
+0002ace0: 6e65 6564 2074 6f20 6765 6e65 7261 7465  need to generate
+0002acf0: 2061 206e 6577 2067 7261 7068 2061 7320   a new graph as 
+0002ad00: 7765 2064 6964 2066 6f72 2074 6865 2065  we did for the e
+0002ad10: 6e64 706f 696e 7473 2061 7320 7468 6520  ndpoints as the 
+0002ad20: 7069 7065 7320 6172 6520 6e6f 7420 676f  pipes are not go
+0002ad30: 696e 6720 746f 2062 6520 7573 6564 2061  ing to be used a
+0002ad40: 7320 6465 7065 6e64 656e 6369 6573 2061  s dependencies a
+0002ad50: 6e64 2074 6865 2064 6174 6173 6f75 7263  nd the datasourc
+0002ad60: 6573 2061 7265 2061 6c72 6561 6479 2064  es are already d
+0002ad70: 6570 6c6f 7965 640a 2020 2020 2020 2020  eployed.        
+0002ad80: 2020 2020 6772 6f75 7073 203d 205b 6772      groups = [gr
+0002ad90: 6f75 7020 666f 7220 6772 6f75 7020 696e  oup for group in
+0002ada0: 2074 6f70 6f73 6f72 7428 6465 7065 6e64   toposort(depend
+0002adb0: 656e 6369 6573 5f67 7261 7068 5f66 6f72  encies_graph_for
+0002adc0: 6b5f 646f 776e 7374 7265 616d 295d 0a20  k_downstream)]. 
+0002add0: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
+0002ade0: 726f 7570 2069 6e20 6772 6f75 7073 3a0a  roup in groups:.
+0002adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae00: 666f 7220 6e61 6d65 2069 6e20 6772 6f75  for name in grou
+0002ae10: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
+0002ae20: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
+0002ae30: 6e20 7072 6f63 6573 7365 6420 6f72 2069  n processed or i
+0002ae40: 735f 6d61 7465 7269 616c 697a 6564 2872  s_materialized(r
+0002ae50: 6573 6f75 7263 6573 5f74 6f5f 7275 6e5f  esources_to_run_
+0002ae60: 666f 726b 5f64 6f77 6e73 7472 6561 6d2e  fork_downstream.
+0002ae70: 6765 7428 6e61 6d65 2929 3a0a 2020 2020  get(name)):.    
+0002ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae90: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0002aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aeb0: 2020 6177 6169 7420 7075 7368 280a 2020    await push(.  
+0002aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aed0: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
+0002aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aef0: 2020 2020 7265 736f 7572 6365 735f 746f      resources_to
+0002af00: 5f72 756e 5f66 6f72 6b5f 646f 776e 7374  _run_fork_downst
+0002af10: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
+0002af20: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002af30: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
+0002af40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002af50: 2020 2020 2020 2020 206c 6174 6573 745f           latest_
+0002af60: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
+0002af70: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0002af80: 2020 2020 2020 2020 2020 2020 2064 7279               dry
+0002af90: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
+0002afa0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002afb0: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
+0002afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afd0: 2020 2020 2020 2066 6f72 6b2c 0a20 2020         fork,.   
+0002afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aff0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0002b000: 2020 2020 2020 2070 726f 6365 7373 6564         processed
+0002b010: 2e61 6464 286e 616d 6529 0a0a 2020 2020  .add(name)..    
+0002b020: 2020 2020 2020 2020 2320 4669 6e61 6c6c          # Finall
+0002b030: 792c 2077 6520 6e65 6564 2074 6f20 6465  y, we need to de
+0002b040: 706c 6f79 2074 6865 206d 6174 6572 6961  ploy the materia
+0002b050: 6c69 7a65 6420 7669 6577 7320 6672 6f6d  lized views from
+0002b060: 2072 6967 6874 2074 6f20 6c65 6674 2e0a   right to left..
+0002b070: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0002b080: 206e 6565 6420 746f 2072 656c 7920 6f6e   need to rely on
+0002b090: 2074 6865 2066 6f72 6b64 6f77 6e73 7472   the forkdownstr
+0002b0a0: 6561 6d20 6772 6170 6820 6173 2069 7420  eam graph as it 
+0002b0b0: 636f 6e74 6169 6e73 2061 6c6c 2074 6865  contains all the
+0002b0c0: 206d 6f64 6966 6965 6420 6d61 7465 7269   modified materi
+0002b0d0: 616c 697a 6564 2076 6965 7773 2061 7320  alized views as 
+0002b0e0: 7765 6c6c 2061 7320 7468 6520 6465 7065  well as the depe
+0002b0f0: 6e64 656e 6369 6573 206f 6620 7468 6520  ndencies of the 
+0002b100: 6d61 7465 7269 616c 697a 6564 2076 6965  materialized vie
+0002b110: 7773 0a20 2020 2020 2020 2020 2020 2023  ws.            #
+0002b120: 2049 6e20 7468 6973 2063 6173 652c 2077   In this case, w
+0002b130: 6520 646f 6e27 7420 6e65 6564 2074 6f20  e don't need to 
+0002b140: 6765 6e65 7261 7465 2061 206e 6577 2067  generate a new g
+0002b150: 7261 7068 2061 7320 7765 2064 6964 2066  raph as we did f
+0002b160: 6f72 2074 6865 2065 6e64 706f 696e 7473  or the endpoints
+0002b170: 2061 7320 7468 6520 7069 7065 7320 6172   as the pipes ar
+0002b180: 6520 6e6f 7420 676f 696e 6720 746f 2062  e not going to b
+0002b190: 6520 7573 6564 2061 7320 6465 7065 6e64  e used as depend
+0002b1a0: 656e 6369 6573 2061 6e64 2074 6865 2064  encies and the d
+0002b1b0: 6174 6173 6f75 7263 6573 2061 7265 2061  atasources are a
+0002b1c0: 6c72 6561 6479 2064 6570 6c6f 7965 640a  lready deployed.
+0002b1d0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0002b1e0: 7073 203d 205b 6772 6f75 7020 666f 7220  ps = [group for 
+0002b1f0: 6772 6f75 7020 696e 2074 6f70 6f73 6f72  group in toposor
+0002b200: 7428 6465 7065 6e64 656e 6369 6573 5f67  t(dependencies_g
+0002b210: 7261 7068 5f66 6f72 6b5f 646f 776e 7374  raph_fork_downst
+0002b220: 7265 616d 295d 0a20 2020 2020 2020 2020  ream)].         
+0002b230: 2020 2066 6f72 2067 726f 7570 2069 6e20     for group in 
+0002b240: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
+0002b250: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+0002b260: 2069 6e20 6772 6f75 703a 0a20 2020 2020   in group:.     
+0002b270: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002b280: 6620 6e61 6d65 2069 6e20 7072 6f63 6573  f name in proces
+0002b290: 7365 6420 6f72 206e 6f74 2069 735f 6d61  sed or not is_ma
+0002b2a0: 7465 7269 616c 697a 6564 2872 6573 6f75  terialized(resou
+0002b2b0: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
+0002b2c0: 5f64 6f77 6e73 7472 6561 6d2e 6765 7428  _downstream.get(
+0002b2d0: 6e61 6d65 2929 3a0a 2020 2020 2020 2020  name)):.        
+0002b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b2f0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0002b300: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+0002b310: 6169 7420 7075 7368 280a 2020 2020 2020  ait push(.      
+0002b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b330: 2020 6e61 6d65 2c0a 2020 2020 2020 2020    name,.        
+0002b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b350: 7265 736f 7572 6365 735f 746f 5f72 756e  resources_to_run
+0002b360: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
+0002b370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b380: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0002b390: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
+0002b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3b0: 2020 2020 206c 6174 6573 745f 6461 7461       latest_data
+0002b3c0: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
+0002b3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b3e0: 2020 2020 2020 2020 2064 7279 5f72 756e           dry_run
+0002b3f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b400: 2020 2020 2020 2020 2020 666f 726b 5f64            fork_d
+0002b410: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+0002b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b430: 2020 2066 6f72 6b2c 0a20 2020 2020 2020     fork,.       
+0002b440: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b460: 2020 2070 726f 6365 7373 6564 2e61 6464     processed.add
+0002b470: 286e 616d 6529 0a0a 2020 2020 6966 2064  (name)..    if d
+0002b480: 6570 6c6f 796d 656e 742e 6973 5f67 6974  eployment.is_git
+0002b490: 5f72 656c 6561 7365 3a0a 2020 2020 2020  _release:.      
+0002b4a0: 2020 6465 706c 6f79 6d65 6e74 2e64 6570    deployment.dep
+0002b4b0: 6c6f 7969 6e67 5f64 7279 5f72 756e 2829  loying_dry_run()
+0002b4c0: 0a20 2020 2020 2020 2061 7761 6974 2070  .        await p
+0002b4d0: 7573 685f 6669 6c65 7328 6465 7065 6e64  ush_files(depend
+0002b4e0: 656e 6369 6573 5f67 7261 7068 2c20 6472  encies_graph, dr
+0002b4f0: 795f 7275 6e3d 5472 7565 2c20 6368 6563  y_run=True, chec
+0002b500: 6b5f 6261 636b 6669 6c6c 5f72 6571 7569  k_backfill_requi
+0002b510: 7265 643d 6368 6563 6b5f 6261 636b 6669  red=check_backfi
+0002b520: 6c6c 5f72 6571 7569 7265 6429 0a0a 2020  ll_required)..  
+0002b530: 2020 2020 2020 6177 6169 7420 6465 706c        await depl
+0002b540: 6f79 6d65 6e74 2e64 656c 6574 655f 7265  oyment.delete_re
+0002b550: 736f 7572 6365 7328 6465 6c65 7465 642c  sources(deleted,
+0002b560: 2070 6970 6573 2c20 6472 795f 7275 6e3d   pipes, dry_run=
+0002b570: 5472 7565 290a 2020 2020 2020 2020 6966  True).        if
+0002b580: 206e 6f74 2064 6570 6c6f 796d 656e 742e   not deployment.
+0002b590: 6472 795f 7275 6e3a 0a20 2020 2020 2020  dry_run:.       
+0002b5a0: 2020 2020 2064 6570 6c6f 796d 656e 742e       deployment.
+0002b5b0: 6465 706c 6f79 696e 6728 290a 2020 2020  deploying().    
+0002b5c0: 2020 2020 2020 2020 6177 6169 7420 7075          await pu
+0002b5d0: 7368 5f66 696c 6573 2864 6570 656e 6465  sh_files(depende
+0002b5e0: 6e63 6965 735f 6772 6170 682c 2064 7279  ncies_graph, dry
+0002b5f0: 5f72 756e 290a 2020 2020 2020 2020 2020  _run).          
+0002b600: 2020 6177 6169 7420 6465 706c 6f79 6d65    await deployme
+0002b610: 6e74 2e64 656c 6574 655f 7265 736f 7572  nt.delete_resour
+0002b620: 6365 7328 6465 6c65 7465 642c 2070 6970  ces(deleted, pip
+0002b630: 6573 290a 2020 2020 656c 7365 3a0a 2020  es).    else:.  
+0002b640: 2020 2020 2020 6177 6169 7420 7075 7368        await push
+0002b650: 5f66 696c 6573 2864 6570 656e 6465 6e63  _files(dependenc
+0002b660: 6965 735f 6772 6170 682c 2064 7279 5f72  ies_graph, dry_r
+0002b670: 756e 290a 0a20 2020 2069 6620 6e6f 7420  un)..    if not 
+0002b680: 6472 795f 7275 6e20 616e 6420 6e6f 7420  dry_run and not 
+0002b690: 7275 6e5f 7465 7374 733a 0a20 2020 2020  run_tests:.     
+0002b6a0: 2020 2069 6620 7570 6c6f 6164 5f66 6978     if upload_fix
+0002b6b0: 7475 7265 733a 0a20 2020 2020 2020 2020  tures:.         
+0002b6c0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+0002b6d0: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
+0002b6e0: 666f 5f70 7573 6869 6e67 5f66 6978 7475  fo_pushing_fixtu
+0002b6f0: 7265 7328 2929 0a0a 2020 2020 2020 2020  res())..        
+0002b700: 2020 2020 2320 5765 206e 6565 6420 746f      # We need to
+0002b710: 2075 706c 6f61 6420 7468 6520 6669 7874   upload the fixt
+0002b720: 7572 6573 2065 7665 6e20 6966 2074 6865  ures even if the
+0002b730: 7265 2069 7320 6e6f 2063 6861 6e67 650a  re is no change.
+0002b740: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0002b750: 735f 6272 616e 6368 3a0a 2020 2020 2020  s_branch:.      
+0002b760: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
+0002b770: 6d65 7320 3d20 6765 745f 7072 6f6a 6563  mes = get_projec
+0002b780: 745f 6669 6c65 6e61 6d65 7328 666f 6c64  t_filenames(fold
+0002b790: 6572 2c20 7769 7468 5f76 656e 646f 723d  er, with_vendor=
+0002b7a0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0002b7b0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+0002b7c0: 6573 5f67 7261 7068 203d 2061 7761 6974  es_graph = await
+0002b7d0: 2062 7569 6c64 5f67 7261 7068 280a 2020   build_graph(.  
+0002b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b7f0: 2020 6669 6c65 6e61 6d65 732c 0a20 2020    filenames,.   
+0002b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b810: 2074 625f 636c 6965 6e74 2c0a 2020 2020   tb_client,.    
+0002b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b830: 6469 725f 7061 7468 3d66 6f6c 6465 722c  dir_path=folder,
+0002b840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b850: 2020 2020 2072 6573 6f75 7263 655f 7665       resource_ve
+0002b860: 7273 696f 6e73 3d6c 6174 6573 745f 6461  rsions=latest_da
+0002b870: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
+0002b880: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002b890: 2020 2020 2020 2077 6f72 6b73 7061 6365         workspace
+0002b8a0: 5f6d 6170 3d77 6f72 6b73 7061 6365 5f6d  _map=workspace_m
+0002b8b0: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
+0002b8c0: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
+0002b8d0: 6465 7065 6e64 656e 6369 6573 3d70 7573  dependencies=pus
+0002b8e0: 685f 6465 7073 2c0a 2020 2020 2020 2020  h_deps,.        
+0002b8f0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+0002b900: 6f73 653d 7665 7262 6f73 652c 0a20 2020  ose=verbose,.   
+0002b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b920: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+0002b930: 6174 6873 3d77 6f72 6b73 7061 6365 5f6c  aths=workspace_l
+0002b940: 6962 5f70 6174 6873 2c0a 2020 2020 2020  ib_paths,.      
+0002b950: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0002b960: 7272 656e 745f 7773 3d63 7572 7265 6e74  rrent_ws=current
+0002b970: 5f77 732c 0a20 2020 2020 2020 2020 2020  _ws,.           
+0002b980: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002b990: 2020 2020 7072 6f63 6573 7365 6420 3d20      processed = 
+0002b9a0: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+0002b9b0: 2020 666f 7220 6772 6f75 7020 696e 2074    for group in t
+0002b9c0: 6f70 6f73 6f72 7428 6465 7065 6e64 656e  oposort(dependen
+0002b9d0: 6369 6573 5f67 7261 7068 2e64 6570 5f6d  cies_graph.dep_m
+0002b9e0: 6170 293a 0a20 2020 2020 2020 2020 2020  ap):.           
+0002b9f0: 2020 2020 2066 6f72 2066 2069 6e20 6772       for f in gr
+0002ba00: 6f75 703a 0a20 2020 2020 2020 2020 2020  oup:.           
+0002ba10: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
+0002ba20: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+0002ba30: 2866 290a 2020 2020 2020 2020 2020 2020  (f).            
+0002ba40: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+0002ba50: 6e6f 7420 696e 2070 726f 6365 7373 6564  not in processed
+0002ba60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ba70: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
+0002ba80: 6520 696e 2064 6570 656e 6465 6e63 6965  e in dependencie
+0002ba90: 735f 6772 6170 682e 746f 5f72 756e 3a0a  s_graph.to_run:.
+0002baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bab0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0002bac0: 7420 6368 6563 6b5f 6669 7874 7572 6573  t check_fixtures
+0002bad0: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002baf0: 2020 2020 2020 2074 625f 636c 6965 6e74         tb_client
+0002bb00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb20: 2020 6465 7065 6e64 656e 6369 6573 5f67    dependencies_g
+0002bb30: 7261 7068 2e74 6f5f 7275 6e5b 6e61 6d65  raph.to_run[name
+0002bb40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb60: 2020 2064 6562 7567 2c0a 2020 2020 2020     debug,.      
+0002bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb80: 2020 2020 2020 2020 2020 666f 6c64 6572            folder
+0002bb90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbb0: 2020 666f 7263 652c 0a20 2020 2020 2020    force,.       
+0002bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbd0: 2020 2020 2020 2020 206d 6f64 653d 2261           mode="a
+0002bbe0: 7070 656e 6422 2069 6620 6973 5f62 7261  ppend" if is_bra
+0002bbf0: 6e63 6820 656c 7365 2022 7265 706c 6163  nch else "replac
+0002bc00: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0002bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002bc30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0002bc40: 6f63 6573 7365 642e 6164 6428 6e61 6d65  ocessed.add(name
+0002bc50: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0002bc60: 7220 6620 696e 2064 6570 656e 6465 6e63  r f in dependenc
+0002bc70: 6965 735f 6772 6170 682e 746f 5f72 756e  ies_graph.to_run
+0002bc80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002bc90: 2020 6966 2066 206e 6f74 2069 6e20 7072    if f not in pr
+0002bca0: 6f63 6573 7365 643a 0a20 2020 2020 2020  ocessed:.       
+0002bcb0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+0002bcc0: 6974 2063 6865 636b 5f66 6978 7475 7265  it check_fixture
+0002bcd0: 735f 6461 7461 280a 2020 2020 2020 2020  s_data(.        
+0002bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bcf0: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
+0002bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd10: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
+0002bd20: 6772 6170 682e 746f 5f72 756e 5b66 5d2c  graph.to_run[f],
+0002bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bd40: 2020 2020 2020 2020 2064 6562 7567 2c0a           debug,.
+0002bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd60: 2020 2020 2020 2020 666f 6c64 6572 2c0a          folder,.
+0002bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd80: 2020 2020 2020 2020 666f 7263 652c 0a20          force,. 
+0002bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bda0: 2020 2020 2020 206d 6f64 653d 2261 7070         mode="app
+0002bdb0: 656e 6422 2069 6620 6973 5f62 7261 6e63  end" if is_branc
+0002bdc0: 6820 656c 7365 2022 7265 706c 6163 6522  h else "replace"
+0002bdd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bde0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002bdf0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002be00: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0002be10: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+0002be20: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
+0002be30: 6b4d 616e 6167 6572 2e69 6e66 6f5f 6e6f  kManager.info_no
+0002be40: 745f 7075 7368 696e 675f 6669 7874 7572  t_pushing_fixtur
+0002be50: 6573 2829 290a 0a20 2020 2061 7761 6974  es())..    await
+0002be60: 2064 6570 6c6f 796d 656e 742e 7570 6461   deployment.upda
+0002be70: 7465 5f72 656c 6561 7365 2868 6173 5f73  te_release(has_s
+0002be80: 656d 7665 723d 6861 735f 7365 6d76 6572  emver=has_semver
+0002be90: 2c20 7265 6c65 6173 655f 6372 6561 7465  , release_create
+0002bea0: 643d 7265 6c65 6173 655f 6372 6561 7465  d=release_create
+0002beb0: 6429 0a0a 2020 2020 7265 7475 726e 2064  d)..    return d
+0002bec0: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
+0002bed0: 682e 746f 5f72 756e 0a0a 0a61 7379 6e63  h.to_run...async
+0002bee0: 2064 6566 2063 6865 636b 5f66 6978 7475   def check_fixtu
+0002bef0: 7265 735f 6461 7461 280a 2020 2020 636c  res_data(.    cl
+0002bf00: 6965 6e74 3a20 5469 6e79 422c 2072 6573  ient: TinyB, res
+0002bf10: 6f75 7263 653a 2044 6963 745b 7374 722c  ource: Dict[str,
+0002bf20: 2041 6e79 5d2c 2064 6562 7567 3a20 626f   Any], debug: bo
+0002bf30: 6f6c 2c20 666f 6c64 6572 3a20 7374 7220  ol, folder: str 
+0002bf40: 3d20 2222 2c20 666f 7263 653a 2062 6f6f  = "", force: boo
+0002bf50: 6c20 3d20 4661 6c73 652c 206d 6f64 653a  l = False, mode:
+0002bf60: 2073 7472 203d 2022 7265 706c 6163 6522   str = "replace"
+0002bf70: 0a29 3a0a 2020 2020 6966 2064 6562 7567  .):.    if debug
+0002bf80: 3a0a 2020 2020 2020 2020 636c 6963 6b2e  :.        click.
+0002bf90: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+0002bfa0: 6167 6572 2e69 6e66 6f5f 6368 6563 6b69  ager.info_checki
+0002bfb0: 6e67 5f66 696c 6528 6669 6c65 3d70 702e  ng_file(file=pp.
+0002bfc0: 7066 6f72 6d61 7428 7265 736f 7572 6365  pformat(resource
+0002bfd0: 2929 290a 2020 2020 6966 2072 6573 6f75  ))).    if resou
+0002bfe0: 7263 655b 2272 6573 6f75 7263 6522 5d20  rce["resource"] 
+0002bff0: 696e 205b 2270 6970 6573 222c 2022 746f  in ["pipes", "to
+0002c000: 6b65 6e73 225d 3a0a 2020 2020 2020 2020  kens"]:.        
+0002c010: 7061 7373 0a20 2020 2065 6c69 6620 7265  pass.    elif re
+0002c020: 736f 7572 6365 5b22 7265 736f 7572 6365  source["resource
+0002c030: 225d 203d 3d20 2264 6174 6173 6f75 7263  "] == "datasourc
+0002c040: 6573 223a 0a20 2020 2020 2020 2064 6174  es":.        dat
+0002c050: 6173 6f75 7263 655f 6e61 6d65 203d 2072  asource_name = r
+0002c060: 6573 6f75 7263 655b 2270 6172 616d 7322  esource["params"
+0002c070: 5d5b 226e 616d 6522 5d0a 2020 2020 2020  ]["name"].      
+0002c080: 2020 6e61 6d65 203d 206f 732e 7061 7468    name = os.path
+0002c090: 2e62 6173 656e 616d 6528 7265 736f 7572  .basename(resour
+0002c0a0: 6365 5b22 6669 6c65 6e61 6d65 225d 292e  ce["filename"]).
+0002c0b0: 7273 706c 6974 2822 2e22 2c20 3129 5b30  rsplit(".", 1)[0
+0002c0c0: 5d0a 2020 2020 2020 2020 6669 7874 7572  ].        fixtur
+0002c0d0: 655f 7061 7468 203d 2050 6174 6828 666f  e_path = Path(fo
+0002c0e0: 6c64 6572 2920 2f20 2266 6978 7475 7265  lder) / "fixture
+0002c0f0: 7322 202f 2066 227b 6e61 6d65 7d2e 6373  s" / f"{name}.cs
+0002c100: 7622 0a0a 2020 2020 2020 2020 6966 206e  v"..        if n
+0002c110: 6f74 2066 6978 7475 7265 5f70 6174 682e  ot fixture_path.
+0002c120: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+0002c130: 2020 2020 2020 6669 7874 7572 655f 7061        fixture_pa
+0002c140: 7468 203d 2050 6174 6828 666f 6c64 6572  th = Path(folder
+0002c150: 2920 2f20 2264 6174 6173 6f75 7263 6573  ) / "datasources
+0002c160: 2220 2f20 2266 6978 7475 7265 7322 202f  " / "fixtures" /
+0002c170: 2066 227b 6e61 6d65 7d2e 6373 7622 0a20   f"{name}.csv". 
+0002c180: 2020 2020 2020 2069 6620 6e6f 7420 6669         if not fi
+0002c190: 7874 7572 655f 7061 7468 2e65 7869 7374  xture_path.exist
+0002c1a0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0002c1b0: 2066 6978 7475 7265 5f70 6174 6820 3d20   fixture_path = 
+0002c1c0: 5061 7468 2866 6f6c 6465 7229 202f 2022  Path(folder) / "
+0002c1d0: 6461 7461 736f 7572 6365 7322 202f 2022  datasources" / "
+0002c1e0: 6669 7874 7572 6573 2220 2f20 6622 7b6e  fixtures" / f"{n
+0002c1f0: 616d 657d 2e6e 646a 736f 6e22 0a20 2020  ame}.ndjson".   
+0002c200: 2020 2020 2069 6620 6e6f 7420 6669 7874       if not fixt
+0002c210: 7572 655f 7061 7468 2e65 7869 7374 7328  ure_path.exists(
+0002c220: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+0002c230: 6978 7475 7265 5f70 6174 6820 3d20 5061  ixture_path = Pa
+0002c240: 7468 2866 6f6c 6465 7229 202f 2022 6461  th(folder) / "da
+0002c250: 7461 736f 7572 6365 7322 202f 2022 6669  tasources" / "fi
+0002c260: 7874 7572 6573 2220 2f20 6622 7b6e 616d  xtures" / f"{nam
+0002c270: 657d 2e70 6172 7175 6574 220a 2020 2020  e}.parquet".    
+0002c280: 2020 2020 6966 2066 6978 7475 7265 5f70      if fixture_p
+0002c290: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
+0002c2a0: 2020 2020 2020 2020 2020 2320 4c65 7427            # Let'
+0002c2b0: 7320 7661 6c69 6461 7465 206f 6e6c 7920  s validate only 
+0002c2c0: 7768 656e 2077 6865 6e20 7765 2061 7265  when when we are
+0002c2d0: 2067 6f69 6e67 2074 6f20 7265 706c 6163   going to replac
+0002c2e0: 6520 7468 6520 6163 7475 616c 2064 6174  e the actual dat
+0002c2f0: 610a 2020 2020 2020 2020 2020 2020 7265  a.            re
+0002c300: 7375 6c74 203d 2061 7761 6974 2063 6c69  sult = await cli
+0002c310: 656e 742e 7175 6572 7928 7371 6c3d 6622  ent.query(sql=f"
+0002c320: 5345 4c45 4354 2063 6f75 6e74 2829 2061  SELECT count() a
+0002c330: 7320 6320 4652 4f4d 207b 6461 7461 736f  s c FROM {dataso
+0002c340: 7572 6365 5f6e 616d 657d 2046 4f52 4d41  urce_name} FORMA
+0002c350: 5420 4a53 4f4e 2229 0a20 2020 2020 2020  T JSON").       
+0002c360: 2020 2020 2063 6f75 6e74 203d 2072 6573       count = res
+0002c370: 756c 745b 2264 6174 6122 5d5b 305d 5b22  ult["data"][0]["
+0002c380: 6322 5d0a 0a20 2020 2020 2020 2020 2020  c"]..           
+0002c390: 2069 6620 636f 756e 7420 3e20 3020 616e   if count > 0 an
+0002c3a0: 6420 6e6f 7420 666f 7263 653a 0a20 2020  d not force:.   
+0002c3b0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0002c3c0: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+0002c3d0: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+0002c3e0: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
+0002c3f0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0002c400: 6f72 5f70 7573 685f 6669 7874 7572 655f  or_push_fixture_
+0002c410: 7769 6c6c 5f72 6570 6c61 6365 5f64 6174  will_replace_dat
+0002c420: 6128 6461 7461 736f 7572 6365 3d64 6174  a(datasource=dat
+0002c430: 6173 6f75 7263 655f 6e61 6d65 290a 2020  asource_name).  
+0002c440: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002c450: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0002c460: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
+0002c470: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
+0002c480: 6b4d 616e 6167 6572 2e69 6e66 6f5f 6368  kManager.info_ch
+0002c490: 6563 6b69 6e67 5f66 696c 655f 7369 7a65  ecking_file_size
+0002c4a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002c4b0: 2020 2020 2020 6669 6c65 6e61 6d65 3d72        filename=r
+0002c4c0: 6573 6f75 7263 655b 2266 696c 656e 616d  esource["filenam
+0002c4d0: 6522 5d2c 2073 697a 653d 7369 7a65 6f66  e"], size=sizeof
+0002c4e0: 5f66 6d74 286f 732e 7374 6174 2866 6978  _fmt(os.stat(fix
+0002c4f0: 7475 7265 5f70 6174 6829 2e73 745f 7369  ture_path).st_si
+0002c500: 7a65 290a 2020 2020 2020 2020 2020 2020  ze).            
+0002c510: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002c520: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002c530: 7379 732e 7374 646f 7574 2e66 6c75 7368  sys.stdout.flush
+0002c540: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
+0002c550: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002c560: 2020 2020 6177 6169 7420 636c 6965 6e74      await client
+0002c570: 2e64 6174 6173 6f75 7263 655f 6170 7065  .datasource_appe
+0002c580: 6e64 5f64 6174 6128 0a20 2020 2020 2020  nd_data(.       
+0002c590: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0002c5a0: 6173 6f75 7263 655f 6e61 6d65 3d72 6573  asource_name=res
+0002c5b0: 6f75 7263 655b 2270 6172 616d 7322 5d5b  ource["params"][
+0002c5c0: 226e 616d 6522 5d2c 0a20 2020 2020 2020  "name"],.       
+0002c5d0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0002c5e0: 653d 6669 7874 7572 655f 7061 7468 2c0a  e=fixture_path,.
+0002c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c600: 2020 2020 6d6f 6465 3d6d 6f64 652c 0a20      mode=mode,. 
+0002c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c620: 2020 2066 6f72 6d61 743d 6669 7874 7572     format=fixtur
+0002c630: 655f 7061 7468 2e73 7566 6669 785b 313a  e_path.suffix[1:
+0002c640: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002c650: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002c660: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0002c670: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0002c680: 7375 6363 6573 735f 7072 6f63 6573 7369  success_processi
+0002c690: 6e67 5f64 6174 6128 2929 0a20 2020 2020  ng_data()).     
+0002c6a0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0002c6b0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0002c6c0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0002c6d0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0002c6e0: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0002c6f0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f70  kManager.error_p
+0002c700: 726f 6365 7373 696e 675f 626c 6f63 6b73  rocessing_blocks
+0002c710: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
+0002c720: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002c730: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+0002c740: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+0002c750: 2e77 6172 6e69 6e67 5f66 6978 7475 7265  .warning_fixture
+0002c760: 5f6e 6f74 5f66 6f75 6e64 2864 6174 6173  _not_found(datas
+0002c770: 6f75 7263 655f 6e61 6d65 3d6e 616d 6529  ource_name=name)
+0002c780: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0002c790: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+0002c7a0: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
+0002c7b0: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+0002c7c0: 7272 6f72 5f75 6e6b 6e6f 776e 5f72 6573  rror_unknown_res
+0002c7d0: 6f75 7263 6528 7265 736f 7572 6365 3d72  ource(resource=r
+0002c7e0: 6573 6f75 7263 655b 2272 6573 6f75 7263  esource["resourc
+0002c7f0: 6522 5d29 290a 0a0a 4441 5441 4649 4c45  e"]))...DATAFILE
+0002c800: 5f4e 4557 5f4c 494e 4520 3d20 225c 6e22  _NEW_LINE = "\n"
+0002c810: 0a44 4154 4146 494c 455f 494e 4445 4e54  .DATAFILE_INDENT
+0002c820: 203d 2022 2022 202a 2034 0a0a 0a64 6566   = " " * 4...def
+0002c830: 2066 6f72 6d61 745f 7363 6865 6d61 2866   format_schema(f
+0002c840: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
+0002c850: 7374 725d 2c20 6e6f 6465 3a20 4469 6374  str], node: Dict
+0002c860: 5b73 7472 2c20 416e 795d 2920 2d3e 204c  [str, Any]) -> L
+0002c870: 6973 745b 7374 725d 3a0a 2020 2020 6966  ist[str]:.    if
+0002c880: 2022 7363 6865 6d61 2220 696e 206e 6f64   "schema" in nod
+0002c890: 6520 616e 6420 6e6f 6465 5b22 7363 6865  e and node["sche
+0002c8a0: 6d61 225d 3a0a 2020 2020 2020 2020 6669  ma"]:.        fi
+0002c8b0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002c8c0: 2253 4348 454d 4120 3e22 290a 2020 2020  "SCHEMA >").    
+0002c8d0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002c8e0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
+0002c8f0: 4557 5f4c 494e 4529 0a20 2020 2020 2020  EW_LINE).       
+0002c900: 2063 6f6c 756d 6e73 203d 2073 6368 656d   columns = schem
+0002c910: 615f 746f 5f73 716c 5f63 6f6c 756d 6e73  a_to_sql_columns
+0002c920: 286e 6f64 655b 2263 6f6c 756d 6e73 225d  (node["columns"]
+0002c930: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0002c940: 6172 7473 2e61 7070 656e 6428 6622 2c7b  arts.append(f",{
+0002c950: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002c960: 457d 222e 6a6f 696e 286d 6170 286c 616d  E}".join(map(lam
+0002c970: 6264 6120 783a 2066 2220 2020 207b 787d  bda x: f"    {x}
+0002c980: 222c 2063 6f6c 756d 6e73 2929 290a 2020  ", columns))).  
+0002c990: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
+0002c9a0: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
+0002c9b0: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
+0002c9c0: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002c9d0: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
+0002c9e0: 575f 4c49 4e45 290a 0a20 2020 2072 6574  W_LINE)..    ret
+0002c9f0: 7572 6e20 6669 6c65 5f70 6172 7473 0a0a  urn file_parts..
+0002ca00: 0a64 6566 2066 6f72 6d61 745f 696e 6469  .def format_indi
+0002ca10: 6365 7328 6669 6c65 5f70 6172 7473 3a20  ces(file_parts: 
+0002ca20: 4c69 7374 5b73 7472 5d2c 206e 6f64 653a  List[str], node:
+0002ca30: 2044 6963 745b 7374 722c 2041 6e79 5d29   Dict[str, Any])
+0002ca40: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0002ca50: 2020 2069 6620 2269 6e64 6578 6573 2220     if "indexes" 
+0002ca60: 696e 206e 6f64 6520 616e 6420 6e6f 6465  in node and node
+0002ca70: 5b22 696e 6465 7865 7322 5d3a 0a20 2020  ["indexes"]:.   
+0002ca80: 2020 2020 2069 6e64 6578 6573 203d 206e       indexes = n
+0002ca90: 6f64 655b 2269 6e64 6578 6573 225d 0a20  ode["indexes"]. 
+0002caa0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002cab0: 732e 6170 7065 6e64 2822 494e 4445 5845  s.append("INDEXE
+0002cac0: 5320 3e22 290a 2020 2020 2020 2020 6669  S >").        fi
+0002cad0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002cae0: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002caf0: 4529 0a20 2020 2020 2020 2066 696c 655f  E).        file_
+0002cb00: 7061 7274 732e 6170 7065 6e64 2866 227b  parts.append(f"{
+0002cb10: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002cb20: 457d 222e 6a6f 696e 286d 6170 286c 616d  E}".join(map(lam
+0002cb30: 6264 6120 696e 6465 783a 2066 2220 2020  bda index: f"   
+0002cb40: 207b 696e 6465 782e 746f 5f64 6174 6166   {index.to_dataf
+0002cb50: 696c 6528 297d 222c 2069 6e64 6578 6573  ile()}", indexes
+0002cb60: 2929 290a 2020 2020 2020 2020 6669 6c65  ))).        file
+0002cb70: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
+0002cb80: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+0002cb90: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0002cba0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002cbb0: 494c 455f 4e45 575f 4c49 4e45 290a 0a20  ILE_NEW_LINE).. 
+0002cbc0: 2020 2072 6574 7572 6e20 6669 6c65 5f70     return file_p
+0002cbd0: 6172 7473 0a0a 0a64 6566 2066 6f72 6d61  arts...def forma
+0002cbe0: 745f 6461 7461 5f63 6f6e 6e65 6374 6f72  t_data_connector
+0002cbf0: 2866 696c 655f 7061 7274 733a 204c 6973  (file_parts: Lis
+0002cc00: 745b 7374 725d 2c20 6e6f 6465 3a20 4469  t[str], node: Di
+0002cc10: 6374 5b73 7472 2c20 416e 795d 2920 2d3e  ct[str, Any]) ->
+0002cc20: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+0002cc30: 6c6c 203d 206c 656e 2866 696c 655f 7061  ll = len(file_pa
+0002cc40: 7274 7329 0a20 2020 2071 756f 7465 7320  rts).    quotes 
+0002cc50: 3d20 2227 2722 0a20 2020 205b 6669 6c65  = "''".    [file
+0002cc60: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
+0002cc70: 7b6b 2e75 7070 6572 2829 7d20 7b76 206f  {k.upper()} {v o
+0002cc80: 7220 7175 6f74 6573 7d7b 4441 5441 4649  r quotes}{DATAFI
+0002cc90: 4c45 5f4e 4557 5f4c 494e 457d 2229 2066  LE_NEW_LINE}") f
+0002cca0: 6f72 206b 2c20 7620 696e 206e 6f64 652e  or k, v in node.
+0002ccb0: 6974 656d 7328 2920 6966 2022 6b61 666b  items() if "kafk
+0002ccc0: 6122 2069 6e20 6b5d 2020 2320 7479 7065  a" in k]  # type
+0002ccd0: 3a20 6967 6e6f 7265 0a20 2020 2069 6620  : ignore.    if 
+0002cce0: 6c6c 203c 206c 656e 2866 696c 655f 7061  ll < len(file_pa
+0002ccf0: 7274 7329 3a0a 2020 2020 2020 2020 6669  rts):.        fi
+0002cd00: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002cd10: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002cd20: 4529 0a20 2020 2072 6574 7572 6e20 6669  E).    return fi
+0002cd30: 6c65 5f70 6172 7473 0a0a 0a64 6566 2066  le_parts...def f
+0002cd40: 6f72 6d61 745f 696d 706f 7274 5f73 6574  ormat_import_set
+0002cd50: 7469 6e67 7328 6669 6c65 5f70 6172 7473  tings(file_parts
+0002cd60: 3a20 4c69 7374 5b73 7472 5d2c 206e 6f64  : List[str], nod
+0002cd70: 653a 2044 6963 745b 7374 722c 2041 6e79  e: Dict[str, Any
+0002cd80: 5d29 202d 3e20 4c69 7374 5b73 7472 5d3a  ]) -> List[str]:
+0002cd90: 0a20 2020 206c 6c20 3d20 6c65 6e28 6669  .    ll = len(fi
+0002cda0: 6c65 5f70 6172 7473 290a 2020 2020 5b66  le_parts).    [f
+0002cdb0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002cdc0: 2866 227b 6b2e 7570 7065 7228 297d 207b  (f"{k.upper()} {
+0002cdd0: 767d 7b44 4154 4146 494c 455f 4e45 575f  v}{DATAFILE_NEW_
+0002cde0: 4c49 4e45 7d22 2920 666f 7220 6b2c 2076  LINE}") for k, v
+0002cdf0: 2069 6e20 6e6f 6465 2e69 7465 6d73 2829   in node.items()
+0002ce00: 2069 6620 2269 6d70 6f72 745f 2220 696e   if "import_" in
+0002ce10: 206b 5d20 2023 2074 7970 653a 2069 676e   k]  # type: ign
+0002ce20: 6f72 650a 2020 2020 6966 206c 6c20 3c20  ore.    if ll < 
+0002ce30: 6c65 6e28 6669 6c65 5f70 6172 7473 293a  len(file_parts):
+0002ce40: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0002ce50: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002ce60: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
+0002ce70: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
+0002ce80: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
+0002ce90: 5f69 6e63 6c75 6465 2866 696c 655f 7061  _include(file_pa
+0002cea0: 7274 733a 204c 6973 745b 7374 725d 2c20  rts: List[str], 
+0002ceb0: 646f 633a 2044 6174 6166 696c 652c 2075  doc: Datafile, u
+0002cec0: 6e72 6f6c 6c5f 696e 636c 7564 6573 3a20  nroll_includes: 
+0002ced0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+0002cee0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+0002cef0: 6966 2075 6e72 6f6c 6c5f 696e 636c 7564  if unroll_includ
+0002cf00: 6573 3a0a 2020 2020 2020 2020 7265 7475  es:.        retu
+0002cf10: 726e 2066 696c 655f 7061 7274 730a 0a20  rn file_parts.. 
+0002cf20: 2020 2061 7373 6572 7420 646f 632e 7261     assert doc.ra
+0002cf30: 7720 6973 206e 6f74 204e 6f6e 650a 0a20  w is not None.. 
+0002cf40: 2020 2069 6e63 6c75 6465 203d 205b 6c69     include = [li
+0002cf50: 6e65 2066 6f72 206c 696e 6520 696e 2064  ne for line in d
+0002cf60: 6f63 2e72 6177 2069 6620 2249 4e43 4c55  oc.raw if "INCLU
+0002cf70: 4445 2220 696e 206c 696e 6520 616e 6420  DE" in line and 
+0002cf80: 222e 696e 636c 2220 696e 206c 696e 655d  ".incl" in line]
+0002cf90: 0a20 2020 2069 6620 6c65 6e28 696e 636c  .    if len(incl
+0002cfa0: 7564 6529 3a0a 2020 2020 2020 2020 6669  ude):.        fi
+0002cfb0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002cfc0: 696e 636c 7564 655b 305d 290a 2020 2020  include[0]).    
+0002cfd0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002cfe0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
+0002cff0: 4557 5f4c 494e 4529 0a20 2020 2072 6574  EW_LINE).    ret
+0002d000: 7572 6e20 6669 6c65 5f70 6172 7473 0a0a  urn file_parts..
+0002d010: 0a61 7379 6e63 2064 6566 2066 6f72 6d61  .async def forma
+0002d020: 745f 6461 7461 736f 7572 6365 280a 2020  t_datasource(.  
+0002d030: 2020 6669 6c65 6e61 6d65 3a20 7374 722c    filename: str,
+0002d040: 0a20 2020 2075 6e72 6f6c 6c5f 696e 636c  .    unroll_incl
+0002d050: 7564 6573 3a20 626f 6f6c 203d 2046 616c  udes: bool = Fal
+0002d060: 7365 2c0a 2020 2020 666f 725f 6469 6666  se,.    for_diff
+0002d070: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+0002d080: 2020 2020 636c 6965 6e74 3a20 4f70 7469      client: Opti
+0002d090: 6f6e 616c 5b54 696e 7942 5d20 3d20 4e6f  onal[TinyB] = No
+0002d0a0: 6e65 2c0a 2020 2020 7265 706c 6163 655f  ne,.    replace_
+0002d0b0: 696e 636c 7564 6573 3a20 626f 6f6c 203d  includes: bool =
+0002d0c0: 2046 616c 7365 2c0a 2020 2020 6461 7461   False,.    data
+0002d0d0: 6669 6c65 3a20 4f70 7469 6f6e 616c 5b44  file: Optional[D
+0002d0e0: 6174 6166 696c 655d 203d 204e 6f6e 652c  atafile] = None,
+0002d0f0: 0a20 2020 2066 6f72 5f64 6570 6c6f 795f  .    for_deploy_
+0002d100: 6469 6666 3a20 626f 6f6c 203d 2046 616c  diff: bool = Fal
+0002d110: 7365 2c0a 2020 2020 736b 6970 5f65 7661  se,.    skip_eva
+0002d120: 6c3a 2062 6f6f 6c20 3d20 4661 6c73 652c  l: bool = False,
+0002d130: 0a29 202d 3e20 7374 723a 0a20 2020 2069  .) -> str:.    i
+0002d140: 6620 6461 7461 6669 6c65 3a0a 2020 2020  f datafile:.    
+0002d150: 2020 2020 646f 6320 3d20 6461 7461 6669      doc = datafi
+0002d160: 6c65 0a20 2020 2065 6c73 653a 0a20 2020  le.    else:.   
+0002d170: 2020 2020 2064 6f63 203d 2070 6172 7365       doc = parse
+0002d180: 5f64 6174 6173 6f75 7263 6528 6669 6c65  _datasource(file
+0002d190: 6e61 6d65 2c20 7265 706c 6163 655f 696e  name, replace_in
+0002d1a0: 636c 7564 6573 3d72 6570 6c61 6365 5f69  cludes=replace_i
+0002d1b0: 6e63 6c75 6465 732c 2073 6b69 705f 6576  ncludes, skip_ev
+0002d1c0: 616c 3d73 6b69 705f 6576 616c 290a 0a20  al=skip_eval).. 
+0002d1d0: 2020 2066 696c 655f 7061 7274 733a 204c     file_parts: L
+0002d1e0: 6973 745b 7374 725d 203d 205b 5d0a 2020  ist[str] = [].  
+0002d1f0: 2020 6966 2066 6f72 5f64 6966 663a 0a20    if for_diff:. 
+0002d200: 2020 2020 2020 2069 735f 6b61 666b 6120         is_kafka 
+0002d210: 3d20 226b 6166 6b61 5f63 6f6e 6e65 6374  = "kafka_connect
+0002d220: 696f 6e5f 6e61 6d65 2220 696e 2064 6f63  ion_name" in doc
+0002d230: 2e6e 6f64 6573 5b30 5d0a 2020 2020 2020  .nodes[0].      
+0002d240: 2020 6966 2069 735f 6b61 666b 613a 0a20    if is_kafka:. 
+0002d250: 2020 2020 2020 2020 2020 206b 6166 6b61             kafka
+0002d260: 5f6d 6574 6164 6174 615f 636f 6c75 6d6e  _metadata_column
+0002d270: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+0002d280: 2020 2020 2020 225f 5f76 616c 7565 222c        "__value",
+0002d290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d2a0: 2022 5f5f 6865 6164 6572 7322 2c0a 2020   "__headers",.  
+0002d2b0: 2020 2020 2020 2020 2020 2020 2020 225f                "_
+0002d2c0: 5f74 6f70 6963 222c 0a20 2020 2020 2020  _topic",.       
+0002d2d0: 2020 2020 2020 2020 2022 5f5f 7061 7274           "__part
+0002d2e0: 6974 696f 6e22 2c0a 2020 2020 2020 2020  ition",.        
+0002d2f0: 2020 2020 2020 2020 225f 5f6f 6666 7365          "__offse
+0002d300: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0002d310: 2020 2020 225f 5f74 696d 6573 7461 6d70      "__timestamp
+0002d320: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002d330: 2020 2022 5f5f 6b65 7922 2c0a 2020 2020     "__key",.    
+0002d340: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0002d350: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+0002d360: 5b63 2066 6f72 2063 2069 6e20 646f 632e  [c for c in doc.
+0002d370: 6e6f 6465 735b 305d 5b22 636f 6c75 6d6e  nodes[0]["column
+0002d380: 7322 5d20 6966 2063 5b22 6e61 6d65 225d  s"] if c["name"]
+0002d390: 206e 6f74 2069 6e20 6b61 666b 615f 6d65   not in kafka_me
+0002d3a0: 7461 6461 7461 5f63 6f6c 756d 6e73 5d0a  tadata_columns].
+0002d3b0: 2020 2020 2020 2020 2020 2020 646f 632e              doc.
+0002d3c0: 6e6f 6465 735b 305d 2e75 7064 6174 6528  nodes[0].update(
+0002d3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d3e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002d3f0: 2020 2020 2020 2022 636f 6c75 6d6e 7322         "columns"
+0002d400: 3a20 636f 6c75 6d6e 732c 0a20 2020 2020  : columns,.     
+0002d410: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0002d420: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002d430: 2020 2066 6f72 6d61 745f 7665 7273 696f     format_versio
+0002d440: 6e28 6669 6c65 5f70 6172 7473 2c20 646f  n(file_parts, do
+0002d450: 6329 0a20 2020 2020 2020 2069 6620 666f  c).        if fo
+0002d460: 725f 6465 706c 6f79 5f64 6966 663a 0a20  r_deploy_diff:. 
+0002d470: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0002d480: 745f 6465 7363 7269 7074 696f 6e28 6669  t_description(fi
+0002d490: 6c65 5f70 6172 7473 2c20 646f 6329 0a20  le_parts, doc). 
+0002d4a0: 2020 2020 2020 2066 6f72 6d61 745f 746f         format_to
+0002d4b0: 6b65 6e73 2866 696c 655f 7061 7274 732c  kens(file_parts,
+0002d4c0: 2064 6f63 290a 2020 2020 2020 2020 666f   doc).        fo
+0002d4d0: 726d 6174 5f73 6368 656d 6128 6669 6c65  rmat_schema(file
+0002d4e0: 5f70 6172 7473 2c20 646f 632e 6e6f 6465  _parts, doc.node
+0002d4f0: 735b 305d 290a 2020 2020 2020 2020 666f  s[0]).        fo
+0002d500: 726d 6174 5f69 6e64 6963 6573 2866 696c  rmat_indices(fil
+0002d510: 655f 7061 7274 732c 2064 6f63 2e6e 6f64  e_parts, doc.nod
+0002d520: 6573 5b30 5d29 0a20 2020 2020 2020 2061  es[0]).        a
+0002d530: 7761 6974 2066 6f72 6d61 745f 656e 6769  wait format_engi
+0002d540: 6e65 2866 696c 655f 7061 7274 732c 2064  ne(file_parts, d
+0002d550: 6f63 2e6e 6f64 6573 5b30 5d2c 206f 6e6c  oc.nodes[0], onl
+0002d560: 795f 7474 6c3d 5472 7565 2069 6620 6e6f  y_ttl=True if no
+0002d570: 7420 666f 725f 6465 706c 6f79 5f64 6966  t for_deploy_dif
+0002d580: 6620 656c 7365 2046 616c 7365 2c20 636c  f else False, cl
+0002d590: 6965 6e74 3d63 6c69 656e 7429 0a20 2020  ient=client).   
+0002d5a0: 2020 2020 2069 6620 666f 725f 6465 706c       if for_depl
+0002d5b0: 6f79 5f64 6966 663a 0a20 2020 2020 2020  oy_diff:.       
+0002d5c0: 2020 2020 2066 6f72 6d61 745f 696d 706f       format_impo
+0002d5d0: 7274 5f73 6574 7469 6e67 7328 6669 6c65  rt_settings(file
+0002d5e0: 5f70 6172 7473 2c20 646f 632e 6e6f 6465  _parts, doc.node
+0002d5f0: 735b 305d 290a 2020 2020 2020 2020 666f  s[0]).        fo
+0002d600: 726d 6174 5f73 6861 7265 645f 7769 7468  rmat_shared_with
+0002d610: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
+0002d620: 290a 0a20 2020 2065 6c73 653a 0a20 2020  )..    else:.   
+0002d630: 2020 2020 2066 6f72 6d61 745f 736f 7572       format_sour
+0002d640: 6365 7328 6669 6c65 5f70 6172 7473 2c20  ces(file_parts, 
+0002d650: 646f 6329 0a20 2020 2020 2020 2066 6f72  doc).        for
+0002d660: 6d61 745f 6d61 696e 7461 696e 6572 2866  mat_maintainer(f
+0002d670: 696c 655f 7061 7274 732c 2064 6f63 290a  ile_parts, doc).
+0002d680: 2020 2020 2020 2020 666f 726d 6174 5f76          format_v
+0002d690: 6572 7369 6f6e 2866 696c 655f 7061 7274  ersion(file_part
+0002d6a0: 732c 2064 6f63 290a 2020 2020 2020 2020  s, doc).        
+0002d6b0: 666f 726d 6174 5f64 6573 6372 6970 7469  format_descripti
+0002d6c0: 6f6e 2866 696c 655f 7061 7274 732c 2064  on(file_parts, d
+0002d6d0: 6f63 290a 2020 2020 2020 2020 666f 726d  oc).        form
+0002d6e0: 6174 5f74 6f6b 656e 7328 6669 6c65 5f70  at_tokens(file_p
+0002d6f0: 6172 7473 2c20 646f 6329 0a20 2020 2020  arts, doc).     
+0002d700: 2020 2066 6f72 6d61 745f 7363 6865 6d61     format_schema
+0002d710: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
+0002d720: 2e6e 6f64 6573 5b30 5d29 0a20 2020 2020  .nodes[0]).     
+0002d730: 2020 2066 6f72 6d61 745f 696e 6469 6365     format_indice
+0002d740: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
+0002d750: 632e 6e6f 6465 735b 305d 290a 2020 2020  c.nodes[0]).    
+0002d760: 2020 2020 6177 6169 7420 666f 726d 6174      await format
+0002d770: 5f65 6e67 696e 6528 6669 6c65 5f70 6172  _engine(file_par
+0002d780: 7473 2c20 646f 632e 6e6f 6465 735b 305d  ts, doc.nodes[0]
+0002d790: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
+0002d7a0: 5f69 6e63 6c75 6465 2866 696c 655f 7061  _include(file_pa
+0002d7b0: 7274 732c 2064 6f63 2c20 756e 726f 6c6c  rts, doc, unroll
+0002d7c0: 5f69 6e63 6c75 6465 733d 756e 726f 6c6c  _includes=unroll
+0002d7d0: 5f69 6e63 6c75 6465 7329 0a20 2020 2020  _includes).     
+0002d7e0: 2020 2066 6f72 6d61 745f 6461 7461 5f63     format_data_c
+0002d7f0: 6f6e 6e65 6374 6f72 2866 696c 655f 7061  onnector(file_pa
+0002d800: 7274 732c 2064 6f63 2e6e 6f64 6573 5b30  rts, doc.nodes[0
+0002d810: 5d29 0a20 2020 2020 2020 2066 6f72 6d61  ]).        forma
+0002d820: 745f 696d 706f 7274 5f73 6574 7469 6e67  t_import_setting
+0002d830: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
+0002d840: 632e 6e6f 6465 735b 305d 290a 2020 2020  c.nodes[0]).    
+0002d850: 2020 2020 666f 726d 6174 5f73 6861 7265      format_share
+0002d860: 645f 7769 7468 2866 696c 655f 7061 7274  d_with(file_part
+0002d870: 732c 2064 6f63 290a 2020 2020 7265 7375  s, doc).    resu
+0002d880: 6c74 203d 2022 222e 6a6f 696e 2866 696c  lt = "".join(fil
+0002d890: 655f 7061 7274 7329 0a20 2020 2072 6573  e_parts).    res
+0002d8a0: 756c 7420 3d20 7265 7375 6c74 2e72 7374  ult = result.rst
+0002d8b0: 7269 7028 225c 6e22 2920 2b20 225c 6e22  rip("\n") + "\n"
+0002d8c0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0002d8d0: 6c74 0a0a 0a64 6566 2066 6f72 6d61 745f  lt...def format_
+0002d8e0: 7665 7273 696f 6e28 6669 6c65 5f70 6172  version(file_par
+0002d8f0: 7473 3a20 4c69 7374 5b73 7472 5d2c 2064  ts: List[str], d
+0002d900: 6f63 3a20 4461 7461 6669 6c65 2920 2d3e  oc: Datafile) ->
+0002d910: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+0002d920: 7665 7273 696f 6e20 3d20 646f 632e 7665  version = doc.ve
+0002d930: 7273 696f 6e20 6966 2064 6f63 2e76 6572  rsion if doc.ver
+0002d940: 7369 6f6e 2069 7320 6e6f 7420 4e6f 6e65  sion is not None
+0002d950: 2065 6c73 6520 2222 0a20 2020 2069 6620   else "".    if 
+0002d960: 7665 7273 696f 6e20 213d 2022 223a 0a20  version != "":. 
+0002d970: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002d980: 732e 6170 7065 6e64 2866 2256 4552 5349  s.append(f"VERSI
+0002d990: 4f4e 207b 7665 7273 696f 6e7d 2229 0a20  ON {version}"). 
+0002d9a0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002d9b0: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002d9c0: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002d9d0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002d9e0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
+0002d9f0: 4557 5f4c 494e 4529 0a20 2020 2072 6574  EW_LINE).    ret
+0002da00: 7572 6e20 6669 6c65 5f70 6172 7473 0a0a  urn file_parts..
+0002da10: 0a64 6566 2066 6f72 6d61 745f 6d61 696e  .def format_main
+0002da20: 7461 696e 6572 2866 696c 655f 7061 7274  tainer(file_part
+0002da30: 733a 204c 6973 745b 7374 725d 2c20 646f  s: List[str], do
+0002da40: 633a 2044 6174 6166 696c 6529 202d 3e20  c: Datafile) -> 
+0002da50: 4c69 7374 5b73 7472 5d3a 0a20 2020 206d  List[str]:.    m
+0002da60: 6169 6e74 6169 6e65 7220 3d20 646f 632e  aintainer = doc.
+0002da70: 6d61 696e 7461 696e 6572 2069 6620 646f  maintainer if do
+0002da80: 632e 6d61 696e 7461 696e 6572 2069 7320  c.maintainer is 
+0002da90: 6e6f 7420 4e6f 6e65 2065 6c73 6520 2222  not None else ""
+0002daa0: 0a20 2020 2069 6620 6d61 696e 7461 696e  .    if maintain
+0002dab0: 6572 3a0a 2020 2020 2020 2020 6669 6c65  er:.        file
+0002dac0: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
+0002dad0: 4d41 494e 5441 494e 4552 207b 6d61 696e  MAINTAINER {main
+0002dae0: 7461 696e 6572 7d22 290a 2020 2020 2020  tainer}").      
+0002daf0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002db00: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002db10: 5f4c 494e 4529 0a20 2020 2020 2020 2066  _LINE).        f
+0002db20: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002db30: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
+0002db40: 4e45 290a 2020 2020 7265 7475 726e 2066  NE).    return f
+0002db50: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
+0002db60: 666f 726d 6174 5f73 6f75 7263 6573 2866  format_sources(f
+0002db70: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
+0002db80: 7374 725d 2c20 646f 633a 2044 6174 6166  str], doc: Dataf
+0002db90: 696c 6529 202d 3e20 4c69 7374 5b73 7472  ile) -> List[str
+0002dba0: 5d3a 0a20 2020 2066 6f72 2073 6f75 7263  ]:.    for sourc
+0002dbb0: 6520 696e 2064 6f63 2e73 6f75 7263 6573  e in doc.sources
+0002dbc0: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
+0002dbd0: 6172 7473 2e61 7070 656e 6428 6622 534f  arts.append(f"SO
+0002dbe0: 5552 4345 207b 736f 7572 6365 7d22 290a  URCE {source}").
+0002dbf0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002dc00: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
+0002dc10: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
+0002dc20: 2072 6574 7572 6e20 6669 6c65 5f70 6172   return file_par
+0002dc30: 7473 0a0a 0a64 6566 2066 6f72 6d61 745f  ts...def format_
+0002dc40: 6465 7363 7269 7074 696f 6e28 6669 6c65  description(file
+0002dc50: 5f70 6172 7473 3a20 4c69 7374 5b73 7472  _parts: List[str
+0002dc60: 5d2c 2064 6f63 3a20 416e 7929 202d 3e20  ], doc: Any) -> 
+0002dc70: 4c69 7374 5b73 7472 5d3a 0a20 2020 2064  List[str]:.    d
+0002dc80: 6573 6372 6970 7469 6f6e 203d 2064 6f63  escription = doc
+0002dc90: 2e64 6573 6372 6970 7469 6f6e 2069 6620  .description if 
+0002dca0: 646f 632e 6465 7363 7269 7074 696f 6e20  doc.description 
+0002dcb0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0002dcc0: 2022 220a 2020 2020 6966 2064 6573 6372   "".    if descr
+0002dcd0: 6970 7469 6f6e 3a0a 2020 2020 2020 2020  iption:.        
+0002dce0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002dcf0: 6428 2244 4553 4352 4950 5449 4f4e 203e  d("DESCRIPTION >
+0002dd00: 2229 0a20 2020 2020 2020 2066 696c 655f  ").        file_
+0002dd10: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
+0002dd20: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
+0002dd30: 2020 2020 2020 2020 5b66 696c 655f 7061          [file_pa
+0002dd40: 7274 732e 6170 7065 6e64 2866 227b 4441  rts.append(f"{DA
+0002dd50: 5441 4649 4c45 5f49 4e44 454e 547d 7b64  TAFILE_INDENT}{d
+0002dd60: 2e73 7472 6970 2829 7d5c 6e22 2920 666f  .strip()}\n") fo
+0002dd70: 7220 6420 696e 2064 6573 6372 6970 7469  r d in descripti
+0002dd80: 6f6e 2e73 706c 6974 2844 4154 4146 494c  on.split(DATAFIL
+0002dd90: 455f 4e45 575f 4c49 4e45 2920 6966 2064  E_NEW_LINE) if d
+0002dda0: 2e73 7472 6970 2829 5d20 2023 2074 7970  .strip()]  # typ
+0002ddb0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+0002ddc0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002ddd0: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002dde0: 5f4c 494e 4529 0a20 2020 2072 6574 7572  _LINE).    retur
+0002ddf0: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a64  n file_parts...d
+0002de00: 6566 2066 6f72 6d61 745f 746f 6b65 6e73  ef format_tokens
+0002de10: 2866 696c 655f 7061 7274 733a 204c 6973  (file_parts: Lis
+0002de20: 745b 7374 725d 2c20 646f 633a 2044 6174  t[str], doc: Dat
+0002de30: 6166 696c 6529 202d 3e20 4c69 7374 5b73  afile) -> List[s
+0002de40: 7472 5d3a 0a20 2020 2066 6f72 2074 6f6b  tr]:.    for tok
+0002de50: 656e 2069 6e20 646f 632e 746f 6b65 6e73  en in doc.tokens
+0002de60: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
+0002de70: 6172 7473 2e61 7070 656e 6428 6627 544f  arts.append(f'TO
+0002de80: 4b45 4e20 227b 746f 6b65 6e5b 2274 6f6b  KEN "{token["tok
+0002de90: 656e 5f6e 616d 6522 5d7d 2220 7b74 6f6b  en_name"]}" {tok
+0002dea0: 656e 5b22 7065 726d 6973 7369 6f6e 7322  en["permissions"
+0002deb0: 5d7d 2729 0a20 2020 2020 2020 2066 696c  ]}').        fil
+0002dec0: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002ded0: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002dee0: 290a 2020 2020 6966 206c 656e 2864 6f63  ).    if len(doc
+0002def0: 2e74 6f6b 656e 7329 3a0a 2020 2020 2020  .tokens):.      
+0002df00: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002df10: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002df20: 5f4c 494e 4529 0a20 2020 2072 6574 7572  _LINE).    retur
+0002df30: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a64  n file_parts...d
+0002df40: 6566 2066 6f72 6d61 745f 6e6f 6465 5f73  ef format_node_s
+0002df50: 716c 280a 2020 2020 6669 6c65 5f70 6172  ql(.    file_par
+0002df60: 7473 3a20 4c69 7374 5b73 7472 5d2c 206e  ts: List[str], n
+0002df70: 6f64 653a 2044 6963 745b 7374 722c 2041  ode: Dict[str, A
+0002df80: 6e79 5d2c 206c 696e 655f 6c65 6e67 7468  ny], line_length
+0002df90: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
+0002dfa0: 3d20 4e6f 6e65 2c20 6c6f 7765 725f 6b65  = None, lower_ke
+0002dfb0: 7977 6f72 6473 3a20 626f 6f6c 203d 2046  ywords: bool = F
+0002dfc0: 616c 7365 0a29 202d 3e20 4c69 7374 5b73  alse.) -> List[s
+0002dfd0: 7472 5d3a 0a20 2020 2066 696c 655f 7061  tr]:.    file_pa
+0002dfe0: 7274 732e 6170 7065 6e64 2822 5351 4c20  rts.append("SQL 
+0002dff0: 3e22 290a 2020 2020 6669 6c65 5f70 6172  >").    file_par
+0002e000: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
+0002e010: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
+0002e020: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002e030: 6e64 2866 6f72 6d61 745f 7371 6c28 6e6f  nd(format_sql(no
+0002e040: 6465 5b22 7371 6c22 5d2c 2044 4154 4146  de["sql"], DATAF
+0002e050: 494c 455f 494e 4445 4e54 2c20 6c69 6e65  ILE_INDENT, line
+0002e060: 5f6c 656e 6774 683d 6c69 6e65 5f6c 656e  _length=line_len
+0002e070: 6774 682c 206c 6f77 6572 5f6b 6579 776f  gth, lower_keywo
+0002e080: 7264 733d 6c6f 7765 725f 6b65 7977 6f72  rds=lower_keywor
+0002e090: 6473 2929 0a20 2020 2066 696c 655f 7061  ds)).    file_pa
+0002e0a0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002e0b0: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
+0002e0c0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002e0d0: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002e0e0: 5f4c 494e 4529 0a20 2020 2072 6574 7572  _LINE).    retur
+0002e0f0: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a64  n file_parts...d
+0002e100: 6566 2066 6f72 6d61 745f 7368 6172 6564  ef format_shared
+0002e110: 5f77 6974 6828 6669 6c65 5f70 6172 7473  _with(file_parts
+0002e120: 3a20 4c69 7374 5b73 7472 5d2c 2064 6f63  : List[str], doc
+0002e130: 3a20 4461 7461 6669 6c65 2920 2d3e 204c  : Datafile) -> L
+0002e140: 6973 745b 7374 725d 3a0a 2020 2020 6966  ist[str]:.    if
+0002e150: 2064 6f63 2e73 6861 7265 645f 7769 7468   doc.shared_with
+0002e160: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
+0002e170: 6172 7473 2e61 7070 656e 6428 2253 4841  arts.append("SHA
+0002e180: 5245 445f 5749 5448 203e 2229 0a20 2020  RED_WITH >").   
+0002e190: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002e1a0: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
+0002e1b0: 4e45 575f 4c49 4e45 290a 2020 2020 2020  NEW_LINE).      
+0002e1c0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002e1d0: 656e 6428 225c 6e22 2e6a 6f69 6e28 5b66  end("\n".join([f
+0002e1e0: 227b 4441 5441 4649 4c45 5f49 4e44 454e  "{DATAFILE_INDEN
+0002e1f0: 547d 7b77 6f72 6b73 7061 6365 5f6e 616d  T}{workspace_nam
+0002e200: 657d 2220 666f 7220 776f 726b 7370 6163  e}" for workspac
+0002e210: 655f 6e61 6d65 2069 6e20 646f 632e 7368  e_name in doc.sh
+0002e220: 6172 6564 5f77 6974 685d 2929 0a20 2020  ared_with])).   
+0002e230: 2072 6574 7572 6e20 6669 6c65 5f70 6172   return file_par
+0002e240: 7473 0a0a 0a61 7379 6e63 2064 6566 2066  ts...async def f
+0002e250: 6f72 6d61 745f 656e 6769 6e65 280a 2020  ormat_engine(.  
+0002e260: 2020 6669 6c65 5f70 6172 7473 3a20 4c69    file_parts: Li
+0002e270: 7374 5b73 7472 5d2c 206e 6f64 653a 2044  st[str], node: D
+0002e280: 6963 745b 7374 722c 2041 6e79 5d2c 206f  ict[str, Any], o
+0002e290: 6e6c 795f 7474 6c3a 2062 6f6f 6c20 3d20  nly_ttl: bool = 
+0002e2a0: 4661 6c73 652c 2063 6c69 656e 743a 204f  False, client: O
+0002e2b0: 7074 696f 6e61 6c5b 5469 6e79 425d 203d  ptional[TinyB] =
+0002e2c0: 204e 6f6e 650a 2920 2d3e 204c 6973 745b   None.) -> List[
+0002e2d0: 7374 725d 3a0a 2020 2020 6966 206f 6e6c  str]:.    if onl
+0002e2e0: 795f 7474 6c3a 0a20 2020 2020 2020 2069  y_ttl:.        i
+0002e2f0: 6620 6e6f 6465 2e67 6574 2822 656e 6769  f node.get("engi
+0002e300: 6e65 222c 204e 6f6e 6529 3a0a 2020 2020  ne", None):.    
+0002e310: 2020 2020 2020 2020 666f 7220 6172 6720          for arg 
+0002e320: 696e 2073 6f72 7465 6428 6e6f 6465 5b22  in sorted(node["
+0002e330: 656e 6769 6e65 225d 2e67 6574 2822 6172  engine"].get("ar
+0002e340: 6773 222c 205b 5d29 293a 0a20 2020 2020  gs", [])):.     
+0002e350: 2020 2020 2020 2020 2020 2069 6620 6172             if ar
+0002e360: 675b 305d 2e75 7070 6572 2829 203d 3d20  g[0].upper() == 
+0002e370: 2254 544c 223a 0a20 2020 2020 2020 2020  "TTL":.         
+0002e380: 2020 2020 2020 2020 2020 2065 6c65 6d20             elem 
+0002e390: 3d20 222c 2022 2e6a 6f69 6e28 5b78 2e73  = ", ".join([x.s
+0002e3a0: 7472 6970 2829 2066 6f72 2078 2069 6e20  trip() for x in 
+0002e3b0: 6172 675b 315d 2e73 706c 6974 2822 2c22  arg[1].split(","
+0002e3c0: 295d 290a 2020 2020 2020 2020 2020 2020  )]).            
+0002e3d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3f0: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
+0002e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e410: 2020 2020 2020 2020 2020 2020 7474 6c5f              ttl_
+0002e420: 7371 6c20 3d20 6177 6169 7420 636c 6965  sql = await clie
+0002e430: 6e74 2e73 716c 5f67 6574 5f66 6f72 6d61  nt.sql_get_forma
+0002e440: 7428 6622 7365 6c65 6374 207b 656c 656d  t(f"select {elem
+0002e450: 7d22 2c20 7769 7468 5f63 6c69 636b 686f  }", with_clickho
+0002e460: 7573 655f 666f 726d 6174 3d54 7275 6529  use_format=True)
+0002e470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e480: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002e490: 6d61 7474 6564 5f74 746c 203d 2074 746c  matted_ttl = ttl
+0002e4a0: 5f73 716c 5b37 3a5d 0a20 2020 2020 2020  _sql[7:].       
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4e0: 2020 2066 6f72 6d61 7474 6564 5f74 746c     formatted_ttl
+0002e4f0: 203d 2065 6c65 6d0a 2020 2020 2020 2020   = elem.        
+0002e500: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002e510: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+0002e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e530: 2020 2020 2020 666f 726d 6174 7465 645f        formatted_
+0002e540: 7474 6c20 3d20 656c 656d 0a20 2020 2020  ttl = elem.     
+0002e550: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002e560: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002e570: 2866 2245 4e47 494e 455f 7b61 7267 5b30  (f"ENGINE_{arg[0
+0002e580: 5d2e 7570 7065 7228 297d 207b 666f 726d  ].upper()} {form
+0002e590: 6174 7465 645f 7474 6c7d 2229 0a20 2020  atted_ttl}").   
+0002e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5b0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002e5c0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
+0002e5d0: 4c49 4e45 290a 2020 2020 2020 2020 2020  LINE).          
+0002e5e0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002e5f0: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002e600: 5f4c 494e 4529 0a20 2020 2020 2020 2072  _LINE).        r
+0002e610: 6574 7572 6e20 6669 6c65 5f70 6172 7473  eturn file_parts
+0002e620: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0002e630: 2020 2069 6620 6e6f 6465 2e67 6574 2822     if node.get("
+0002e640: 656e 6769 6e65 222c 204e 6f6e 6529 3a0a  engine", None):.
+0002e650: 2020 2020 2020 2020 2020 2020 656d 7074              empt
+0002e660: 7920 3d20 2722 2227 0a20 2020 2020 2020  y = '""'.       
+0002e670: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002e680: 6170 7065 6e64 2866 2745 4e47 494e 4520  append(f'ENGINE 
+0002e690: 7b6e 6f64 655b 2265 6e67 696e 6522 5d5b  {node["engine"][
+0002e6a0: 2274 7970 6522 5d7d 2720 6966 206e 6f64  "type"]}' if nod
+0002e6b0: 652e 6765 7428 2265 6e67 696e 6522 2c20  e.get("engine", 
+0002e6c0: 7b7d 292e 6765 7428 2274 7970 6522 2920  {}).get("type") 
+0002e6d0: 656c 7365 2065 6d70 7479 290a 2020 2020  else empty).    
+0002e6e0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002e6f0: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
+0002e700: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
+0002e710: 2020 2020 2020 2020 2066 6f72 2061 7267           for arg
+0002e720: 2069 6e20 736f 7274 6564 286e 6f64 655b   in sorted(node[
+0002e730: 2265 6e67 696e 6522 5d2e 6765 7428 2261  "engine"].get("a
+0002e740: 7267 7322 2c20 5b5d 2929 3a0a 2020 2020  rgs", [])):.    
+0002e750: 2020 2020 2020 2020 2020 2020 656c 656d              elem
+0002e760: 203d 2022 2c20 222e 6a6f 696e 285b 782e   = ", ".join([x.
+0002e770: 7374 7269 7028 2920 666f 7220 7820 696e  strip() for x in
+0002e780: 2061 7267 5b31 5d2e 7370 6c69 7428 222c   arg[1].split(",
+0002e790: 2229 5d29 0a20 2020 2020 2020 2020 2020  ")]).           
+0002e7a0: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002e7b0: 6170 7065 6e64 2866 2245 4e47 494e 455f  append(f"ENGINE_
+0002e7c0: 7b61 7267 5b30 5d2e 7570 7065 7228 297d  {arg[0].upper()}
+0002e7d0: 207b 656c 656d 2069 6620 656c 656d 2065   {elem if elem e
+0002e7e0: 6c73 6520 656d 7074 797d 2229 0a20 2020  lse empty}").   
+0002e7f0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0002e800: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002e810: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002e820: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
+0002e830: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002e840: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002e850: 4529 0a20 2020 2020 2020 2072 6574 7572  E).        retur
+0002e860: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a61  n file_parts...a
+0002e870: 7379 6e63 2064 6566 2066 6f72 6d61 745f  sync def format_
+0002e880: 6e6f 6465 5f74 7970 6528 6669 6c65 5f70  node_type(file_p
+0002e890: 6172 7473 3a20 4c69 7374 5b73 7472 5d2c  arts: List[str],
+0002e8a0: 206e 6f64 653a 2044 6963 745b 7374 722c   node: Dict[str,
+0002e8b0: 2041 6e79 5d29 202d 3e20 4c69 7374 5b73   Any]) -> List[s
+0002e8c0: 7472 5d3a 0a20 2020 206e 6f64 655f 7479  tr]:.    node_ty
+0002e8d0: 7065 203d 206e 6f64 652e 6765 7428 2274  pe = node.get("t
+0002e8e0: 7970 6522 2c20 2222 292e 6c6f 7765 7228  ype", "").lower(
+0002e8f0: 290a 2020 2020 6e6f 6465 5f74 7970 655f  ).    node_type_
+0002e900: 7570 7065 7220 3d20 6622 5459 5045 207b  upper = f"TYPE {
+0002e910: 6e6f 6465 5f74 7970 652e 7570 7065 7228  node_type.upper(
+0002e920: 297d 220a 0a20 2020 2023 204d 6174 6572  )}"..    # Mater
+0002e930: 6961 6c69 7a65 6420 7069 7065 0a20 2020  ialized pipe.   
+0002e940: 2069 6620 6e6f 6465 5f74 7970 6520 3d3d   if node_type ==
+0002e950: 2050 6970 654e 6f64 6554 7970 6573 2e4d   PipeNodeTypes.M
+0002e960: 4154 4552 4941 4c49 5a45 443a 0a20 2020  ATERIALIZED:.   
+0002e970: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002e980: 6170 7065 6e64 286e 6f64 655f 7479 7065  append(node_type
+0002e990: 5f75 7070 6572 290a 2020 2020 2020 2020  _upper).        
+0002e9a0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002e9b0: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
+0002e9c0: 494e 4529 0a20 2020 2020 2020 2066 696c  INE).        fil
+0002e9d0: 655f 7061 7274 732e 6170 7065 6e64 2866  e_parts.append(f
+0002e9e0: 2744 4154 4153 4f55 5243 4520 7b6e 6f64  'DATASOURCE {nod
+0002e9f0: 655b 2264 6174 6173 6f75 7263 6522 5d7d  e["datasource"]}
+0002ea00: 2729 0a20 2020 2020 2020 2066 696c 655f  ').        file_
+0002ea10: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
+0002ea20: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
+0002ea30: 2020 2020 2020 2020 6177 6169 7420 666f          await fo
+0002ea40: 726d 6174 5f65 6e67 696e 6528 6669 6c65  rmat_engine(file
+0002ea50: 5f70 6172 7473 2c20 6e6f 6465 290a 0a20  _parts, node).. 
+0002ea60: 2020 2023 2043 6f70 7920 7069 7065 0a20     # Copy pipe. 
+0002ea70: 2020 2069 6620 6e6f 6465 5f74 7970 6520     if node_type 
+0002ea80: 3d3d 2050 6970 654e 6f64 6554 7970 6573  == PipeNodeTypes
+0002ea90: 2e43 4f50 593a 0a20 2020 2020 2020 2066  .COPY:.        f
+0002eaa0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002eab0: 286e 6f64 655f 7479 7065 5f75 7070 6572  (node_type_upper
+0002eac0: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0002ead0: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
+0002eae0: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
+0002eaf0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002eb00: 732e 6170 7065 6e64 2866 2754 4152 4745  s.append(f'TARGE
+0002eb10: 545f 4441 5441 534f 5552 4345 207b 6e6f  T_DATASOURCE {no
+0002eb20: 6465 5b22 7461 7267 6574 5f64 6174 6173  de["target_datas
+0002eb30: 6f75 7263 6522 5d7d 2729 0a20 2020 2020  ource"]}').     
+0002eb40: 2020 2069 6620 436f 7079 5061 7261 6d65     if CopyParame
+0002eb50: 7465 7273 2e43 4f50 595f 5343 4845 4455  ters.COPY_SCHEDU
+0002eb60: 4c45 2069 6e20 6e6f 6465 2061 6e64 206e  LE in node and n
+0002eb70: 6f64 655b 436f 7079 5061 7261 6d65 7465  ode[CopyParamete
+0002eb80: 7273 2e43 4f50 595f 5343 4845 4455 4c45  rs.COPY_SCHEDULE
+0002eb90: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
+0002eba0: 735f 6f6e 6465 6d61 6e64 203d 206e 6f64  s_ondemand = nod
+0002ebb0: 655b 436f 7079 5061 7261 6d65 7465 7273  e[CopyParameters
+0002ebc0: 2e43 4f50 595f 5343 4845 4455 4c45 5d2e  .COPY_SCHEDULE].
+0002ebd0: 6c6f 7765 7228 2920 3d3d 204f 4e5f 4445  lower() == ON_DE
+0002ebe0: 4d41 4e44 0a20 2020 2020 2020 2020 2020  MAND.           
+0002ebf0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002ec00: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
+0002ec10: 4c49 4e45 290a 2020 2020 2020 2020 2020  LINE).          
+0002ec20: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002ec30: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+0002ec40: 2020 2020 2066 227b 436f 7079 5061 7261       f"{CopyPara
+0002ec50: 6d65 7465 7273 2e43 4f50 595f 5343 4845  meters.COPY_SCHE
+0002ec60: 4455 4c45 2e75 7070 6572 2829 7d20 7b4f  DULE.upper()} {O
+0002ec70: 4e5f 4445 4d41 4e44 2069 6620 6973 5f6f  N_DEMAND if is_o
+0002ec80: 6e64 656d 616e 6420 656c 7365 206e 6f64  ndemand else nod
+0002ec90: 655b 436f 7079 5061 7261 6d65 7465 7273  e[CopyParameters
+0002eca0: 2e43 4f50 595f 5343 4845 4455 4c45 5d7d  .COPY_SCHEDULE]}
+0002ecb0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0002ecc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002ecd0: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
+0002ece0: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
+0002ecf0: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
+0002ed00: 2020 2020 2020 2020 2020 2066 696c 655f             file_
+0002ed10: 7061 7274 732e 6170 7065 6e64 2866 227b  parts.append(f"{
+0002ed20: 436f 7079 5061 7261 6d65 7465 7273 2e43  CopyParameters.C
+0002ed30: 4f50 595f 5343 4845 4455 4c45 2e75 7070  OPY_SCHEDULE.upp
+0002ed40: 6572 2829 7d20 7b4f 4e5f 4445 4d41 4e44  er()} {ON_DEMAND
+0002ed50: 7d22 290a 2020 2020 2020 2020 6669 6c65  }").        file
+0002ed60: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
+0002ed70: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+0002ed80: 0a0a 2020 2020 2320 5369 6e6b 2070 6970  ..    # Sink pip
+0002ed90: 650a 2020 2020 6966 2045 7870 6f72 7452  e.    if ExportR
+0002eda0: 6570 6c61 6365 6d65 6e74 732e 6973 5f65  eplacements.is_e
+0002edb0: 7870 6f72 745f 6e6f 6465 286e 6f64 6529  xport_node(node)
+0002edc0: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
+0002edd0: 6172 7473 2e61 7070 656e 6428 6e6f 6465  arts.append(node
+0002ede0: 5f74 7970 655f 7570 7065 7229 0a20 2020  _type_upper).   
+0002edf0: 2020 2020 2065 7870 6f72 745f 7061 7261       export_para
+0002ee00: 6d73 203d 2045 7870 6f72 7452 6570 6c61  ms = ExportRepla
+0002ee10: 6365 6d65 6e74 732e 6765 745f 7061 7261  cements.get_para
+0002ee20: 6d73 5f66 726f 6d5f 6461 7461 6669 6c65  ms_from_datafile
+0002ee30: 286e 6f64 6529 0a20 2020 2020 2020 2066  (node).        f
+0002ee40: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002ee50: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
+0002ee60: 4e45 290a 2020 2020 2020 2020 666f 7220  NE).        for 
+0002ee70: 7061 7261 6d2c 2076 616c 7565 2069 6e20  param, value in 
+0002ee80: 6578 706f 7274 5f70 6172 616d 732e 6974  export_params.it
+0002ee90: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+0002eea0: 2020 2069 6620 7061 7261 6d20 3d3d 2022     if param == "
+0002eeb0: 7363 6865 6475 6c65 5f63 726f 6e22 2061  schedule_cron" a
+0002eec0: 6e64 206e 6f74 2076 616c 7565 3a0a 2020  nd not value:.  
+0002eed0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+0002eee0: 6c75 6520 3d20 4f4e 5f44 454d 414e 440a  lue = ON_DEMAND.
+0002eef0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0002ef00: 6669 6c65 5f6b 6579 203d 2045 7870 6f72  file_key = Expor
+0002ef10: 7452 6570 6c61 6365 6d65 6e74 732e 6765  tReplacements.ge
+0002ef20: 745f 6461 7461 6669 6c65 5f6b 6579 2870  t_datafile_key(p
+0002ef30: 6172 616d 290a 2020 2020 2020 2020 2020  aram).          
+0002ef40: 2020 6966 2064 6174 6166 696c 655f 6b65    if datafile_ke
+0002ef50: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002ef60: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002ef70: 7065 6e64 2866 227b 6461 7461 6669 6c65  pend(f"{datafile
+0002ef80: 5f6b 6579 7d20 7b76 616c 7565 7d22 290a  _key} {value}").
+0002ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efa0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002efb0: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
+0002efc0: 494e 4529 0a0a 2020 2020 7265 7475 726e  INE)..    return
+0002efd0: 2066 696c 655f 7061 7274 730a 0a0a 6465   file_parts...de
+0002efe0: 6620 666f 726d 6174 5f70 6970 655f 696e  f format_pipe_in
+0002eff0: 636c 7564 6528 6669 6c65 5f70 6172 7473  clude(file_parts
+0002f000: 3a20 4c69 7374 5b73 7472 5d2c 206e 6f64  : List[str], nod
+0002f010: 653a 2044 6963 745b 7374 722c 2041 6e79  e: Dict[str, Any
+0002f020: 5d2c 2069 6e63 6c75 6465 733a 2044 6963  ], includes: Dic
+0002f030: 745b 7374 722c 2041 6e79 5d29 202d 3e20  t[str, Any]) -> 
+0002f040: 4c69 7374 5b73 7472 5d3a 0a20 2020 2069  List[str]:.    i
+0002f050: 6620 696e 636c 7564 6573 3a0a 2020 2020  f includes:.    
+0002f060: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+0002f070: 696e 636c 7564 6573 2e63 6f70 7928 292e  includes.copy().
+0002f080: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0002f090: 2020 2020 2069 6620 6e6f 6465 5b22 6e61       if node["na
+0002f0a0: 6d65 225d 2069 6e20 763a 0a20 2020 2020  me"] in v:.     
+0002f0b0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
+0002f0c0: 7061 7274 732e 6170 7065 6e64 2866 2249  parts.append(f"I
+0002f0d0: 4e43 4c55 4445 207b 6b7d 2229 0a20 2020  NCLUDE {k}").   
+0002f0e0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0002f0f0: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002f100: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002f110: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002f120: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002f130: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002f140: 5f4c 494e 4529 0a20 2020 2020 2020 2020  _LINE).         
+0002f150: 2020 2020 2020 2064 656c 2069 6e63 6c75         del inclu
+0002f160: 6465 735b 6b5d 0a20 2020 2072 6574 7572  des[k].    retur
+0002f170: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a61  n file_parts...a
+0002f180: 7379 6e63 2064 6566 2066 6f72 6d61 745f  sync def format_
+0002f190: 6e6f 6465 280a 2020 2020 6669 6c65 5f70  node(.    file_p
+0002f1a0: 6172 7473 3a20 4c69 7374 5b73 7472 5d2c  arts: List[str],
+0002f1b0: 0a20 2020 206e 6f64 653a 2044 6963 745b  .    node: Dict[
+0002f1c0: 7374 722c 2041 6e79 5d2c 0a20 2020 2069  str, Any],.    i
+0002f1d0: 6e63 6c75 6465 733a 2044 6963 745b 7374  ncludes: Dict[st
+0002f1e0: 722c 2041 6e79 5d2c 0a20 2020 206c 696e  r, Any],.    lin
+0002f1f0: 655f 6c65 6e67 7468 3a20 4f70 7469 6f6e  e_length: Option
+0002f200: 616c 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a  al[int] = None,.
+0002f210: 2020 2020 756e 726f 6c6c 5f69 6e63 6c75      unroll_inclu
+0002f220: 6465 733a 2062 6f6f 6c20 3d20 4661 6c73  des: bool = Fals
+0002f230: 652c 0a20 2020 206c 6f77 6572 5f6b 6579  e,.    lower_key
+0002f240: 776f 7264 733a 2062 6f6f 6c20 3d20 4661  words: bool = Fa
+0002f250: 6c73 652c 0a29 202d 3e20 4e6f 6e65 3a0a  lse,.) -> None:.
+0002f260: 2020 2020 6966 206e 6f74 2075 6e72 6f6c      if not unrol
+0002f270: 6c5f 696e 636c 7564 6573 3a0a 2020 2020  l_includes:.    
+0002f280: 2020 2020 666f 726d 6174 5f70 6970 655f      format_pipe_
+0002f290: 696e 636c 7564 6528 6669 6c65 5f70 6172  include(file_par
+0002f2a0: 7473 2c20 6e6f 6465 2c20 696e 636c 7564  ts, node, includ
+0002f2b0: 6573 290a 2020 2020 6974 656d 203d 205b  es).    item = [
+0002f2c0: 6b20 666f 7220 6b2c 205f 2069 6e20 696e  k for k, _ in in
+0002f2d0: 636c 7564 6573 2e69 7465 6d73 2829 2069  cludes.items() i
+0002f2e0: 6620 6e6f 6465 5b22 6e61 6d65 225d 2e73  f node["name"].s
+0002f2f0: 7472 6970 2829 2069 6e20 6b5d 0a20 2020  trip() in k].   
+0002f300: 2069 6620 6974 656d 2061 6e64 206e 6f74   if item and not
+0002f310: 2075 6e72 6f6c 6c5f 696e 636c 7564 6573   unroll_includes
+0002f320: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0002f330: 0a0a 2020 2020 6669 6c65 5f70 6172 7473  ..    file_parts
+0002f340: 2e61 7070 656e 6428 6627 4e4f 4445 207b  .append(f'NODE {
+0002f350: 6e6f 6465 5b22 6e61 6d65 225d 2e73 7472  node["name"].str
+0002f360: 6970 2829 7d27 290a 2020 2020 6669 6c65  ip()}').    file
+0002f370: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
+0002f380: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+0002f390: 0a0a 2020 2020 6672 6f6d 2063 6f6c 6c65  ..    from colle
+0002f3a0: 6374 696f 6e73 2069 6d70 6f72 7420 6e61  ctions import na
+0002f3b0: 6d65 6474 7570 6c65 0a0a 2020 2020 446f  medtuple..    Do
+0002f3c0: 6320 3d20 6e61 6d65 6474 7570 6c65 2822  c = namedtuple("
+0002f3d0: 446f 6322 2c20 5b22 6465 7363 7269 7074  Doc", ["descript
+0002f3e0: 696f 6e22 5d29 0a20 2020 2066 6f72 6d61  ion"]).    forma
+0002f3f0: 745f 6465 7363 7269 7074 696f 6e28 6669  t_description(fi
+0002f400: 6c65 5f70 6172 7473 2c20 446f 6328 6e6f  le_parts, Doc(no
+0002f410: 6465 2e67 6574 2822 6465 7363 7269 7074  de.get("descript
+0002f420: 696f 6e22 2c20 2222 2929 290a 2020 2020  ion", ""))).    
+0002f430: 666f 726d 6174 5f6e 6f64 655f 7371 6c28  format_node_sql(
+0002f440: 6669 6c65 5f70 6172 7473 2c20 6e6f 6465  file_parts, node
+0002f450: 2c20 6c69 6e65 5f6c 656e 6774 683d 6c69  , line_length=li
+0002f460: 6e65 5f6c 656e 6774 682c 206c 6f77 6572  ne_length, lower
+0002f470: 5f6b 6579 776f 7264 733d 6c6f 7765 725f  _keywords=lower_
+0002f480: 6b65 7977 6f72 6473 290a 2020 2020 6177  keywords).    aw
+0002f490: 6169 7420 666f 726d 6174 5f6e 6f64 655f  ait format_node_
+0002f4a0: 7479 7065 2866 696c 655f 7061 7274 732c  type(file_parts,
+0002f4b0: 206e 6f64 6529 0a0a 0a61 7379 6e63 2064   node)...async d
+0002f4c0: 6566 2066 6f72 6d61 745f 7069 7065 280a  ef format_pipe(.
+0002f4d0: 2020 2020 6669 6c65 6e61 6d65 3a20 7374      filename: st
+0002f4e0: 722c 0a20 2020 206c 696e 655f 6c65 6e67  r,.    line_leng
+0002f4f0: 7468 3a20 4f70 7469 6f6e 616c 5b69 6e74  th: Optional[int
+0002f500: 5d2c 0a20 2020 2075 6e72 6f6c 6c5f 696e  ],.    unroll_in
+0002f510: 636c 7564 6573 3a20 626f 6f6c 203d 2046  cludes: bool = F
+0002f520: 616c 7365 2c0a 2020 2020 7265 706c 6163  alse,.    replac
+0002f530: 655f 696e 636c 7564 6573 3a20 626f 6f6c  e_includes: bool
+0002f540: 203d 2046 616c 7365 2c0a 2020 2020 6461   = False,.    da
+0002f550: 7461 6669 6c65 3a20 4f70 7469 6f6e 616c  tafile: Optional
+0002f560: 5b44 6174 6166 696c 655d 203d 204e 6f6e  [Datafile] = Non
+0002f570: 652c 0a20 2020 2066 6f72 5f64 6570 6c6f  e,.    for_deplo
+0002f580: 795f 6469 6666 3a20 626f 6f6c 203d 2046  y_diff: bool = F
+0002f590: 616c 7365 2c0a 2020 2020 736b 6970 5f65  alse,.    skip_e
+0002f5a0: 7661 6c3a 2062 6f6f 6c20 3d20 4661 6c73  val: bool = Fals
+0002f5b0: 652c 0a29 202d 3e20 7374 723a 0a20 2020  e,.) -> str:.   
+0002f5c0: 2069 6620 6461 7461 6669 6c65 3a0a 2020   if datafile:.  
+0002f5d0: 2020 2020 2020 646f 6320 3d20 6461 7461        doc = data
+0002f5e0: 6669 6c65 0a20 2020 2065 6c73 653a 0a20  file.    else:. 
+0002f5f0: 2020 2020 2020 2064 6f63 203d 2070 6172         doc = par
+0002f600: 7365 5f70 6970 6528 6669 6c65 6e61 6d65  se_pipe(filename
+0002f610: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
+0002f620: 6573 3d72 6570 6c61 6365 5f69 6e63 6c75  es=replace_inclu
+0002f630: 6465 732c 2073 6b69 705f 6576 616c 3d73  des, skip_eval=s
+0002f640: 6b69 705f 6576 616c 290a 0a20 2020 2066  kip_eval)..    f
+0002f650: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
+0002f660: 7374 725d 203d 205b 5d0a 2020 2020 666f  str] = [].    fo
+0002f670: 726d 6174 5f73 6f75 7263 6573 2866 696c  rmat_sources(fil
+0002f680: 655f 7061 7274 732c 2064 6f63 290a 2020  e_parts, doc).  
+0002f690: 2020 666f 726d 6174 5f6d 6169 6e74 6169    format_maintai
+0002f6a0: 6e65 7228 6669 6c65 5f70 6172 7473 2c20  ner(file_parts, 
+0002f6b0: 646f 6329 0a20 2020 2066 6f72 6d61 745f  doc).    format_
+0002f6c0: 7665 7273 696f 6e28 6669 6c65 5f70 6172  version(file_par
+0002f6d0: 7473 2c20 646f 6329 0a20 2020 2066 6f72  ts, doc).    for
+0002f6e0: 6d61 745f 6465 7363 7269 7074 696f 6e28  mat_description(
+0002f6f0: 6669 6c65 5f70 6172 7473 2c20 646f 6329  file_parts, doc)
+0002f700: 0a20 2020 2066 6f72 6d61 745f 746f 6b65  .    format_toke
+0002f710: 6e73 2866 696c 655f 7061 7274 732c 2064  ns(file_parts, d
+0002f720: 6f63 290a 2020 2020 6966 2064 6f63 2e69  oc).    if doc.i
+0002f730: 6e63 6c75 6465 7320 616e 6420 6e6f 7420  ncludes and not 
+0002f740: 756e 726f 6c6c 5f69 6e63 6c75 6465 733a  unroll_includes:
+0002f750: 0a20 2020 2020 2020 2066 6f72 206b 2069  .        for k i
+0002f760: 6e20 646f 632e 696e 636c 7564 6573 3a0a  n doc.includes:.
+0002f770: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0002f780: 2066 696c 7465 7220 6f6e 6c79 2074 6865   filter only the
+0002f790: 2069 6e63 6c75 6465 2066 696c 6573 2061   include files a
+0002f7a0: 7320 7765 2063 7572 7265 6e74 6c79 2068  s we currently h
+0002f7b0: 6176 6520 3220 6974 656d 7320 666f 7220  ave 2 items for 
+0002f7c0: 6561 6368 2069 6e63 6c75 6465 0a20 2020  each include.   
+0002f7d0: 2020 2020 2020 2020 2023 207b 2027 696e           # { 'in
+0002f7e0: 636c 7564 655f 6669 6c65 2e69 6e63 6c27  clude_file.incl'
+0002f7f0: 3a20 2746 6972 7374 206e 6f64 6520 6f66  : 'First node of
+0002f800: 2074 6865 2069 6e63 6c75 6465 2220 7d0a   the include" }.
+0002f810: 2020 2020 2020 2020 2020 2020 2320 7b20              # { 
+0002f820: 2766 6972 7374 206e 6f64 6520 6f66 2074  'first node of t
+0002f830: 6865 2070 6970 6520 6166 7465 7220 7468  he pipe after th
+0002f840: 6520 696e 636c 7564 6527 3a20 7d0a 2020  e include': }.  
+0002f850: 2020 2020 2020 2020 2020 6966 2022 2e69            if ".i
+0002f860: 6e63 6c22 206e 6f74 2069 6e20 6b3a 0a20  ncl" not in k:. 
+0002f870: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002f880: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0002f890: 2020 2020 2023 2057 6520 6765 7420 616c       # We get al
+0002f8a0: 6c20 7468 6520 6e6f 6465 7320 696e 7369  l the nodes insi
+0002f8b0: 6465 2074 6865 2069 6e63 6c75 6465 2061  de the include a
+0002f8c0: 6e64 2072 656d 6f76 6520 7468 656d 2066  nd remove them f
+0002f8d0: 726f 6d20 7468 6520 756e 726f 6c6c 6564  rom the unrolled
+0002f8e0: 2070 6970 6520 6173 2077 6520 7761 6e74   pipe as we want
+0002f8f0: 2074 6869 6e67 7320 756e 726f 6c6c 6564   things unrolled
+0002f900: 0a20 2020 2020 2020 2020 2020 2069 6e63  .            inc
+0002f910: 6c75 6465 5f70 6172 616d 6574 6572 7320  lude_parameters 
+0002f920: 3d20 5f75 6e71 756f 7465 286b 290a 0a20  = _unquote(k).. 
+0002f930: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0002f940: 7468 6579 2075 7365 2061 6e20 696e 636c  they use an incl
+0002f950: 7564 6520 7769 7468 2070 6172 616d 6574  ude with paramet
+0002f960: 6572 7320 6c69 6b65 2060 494e 434c 5544  ers like `INCLUD
+0002f970: 4520 2278 7878 2e69 6e63 6c22 2022 4752  E "xxx.incl" "GR
+0002f980: 4f55 505f 434f 4c3d 7061 7468 2220 224d  OUP_COL=path" "M
+0002f990: 4154 4552 4941 4c49 5a45 445f 5649 4557  ATERIALIZED_VIEW
+0002f9a0: 3d73 7065 6564 5f69 6e73 6967 6874 735f  =speed_insights_
+0002f9b0: 7061 7468 5f64 6169 6c79 5f6d 7622 6060  path_daily_mv"``
+0002f9c0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+0002f9d0: 6520 6a75 7374 2077 616e 7420 7468 6520  e just want the 
+0002f9e0: 6669 6c65 206e 616d 6520 746f 2074 616b  file name to tak
+0002f9f0: 6520 6e6f 6465 730a 2020 2020 2020 2020  e nodes.        
+0002fa00: 2020 2020 696e 636c 7564 655f 6669 6c65      include_file
+0002fa10: 203d 2069 6e63 6c75 6465 5f70 6172 616d   = include_param
+0002fa20: 6574 6572 732e 7370 6c69 7428 2722 2729  eters.split('"')
+0002fa30: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0002fa40: 696e 636c 7564 655f 6669 6c65 203d 2028  include_file = (
+0002fa50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fa60: 2050 6174 6828 6f73 2e70 6174 682e 6469   Path(os.path.di
+0002fa70: 726e 616d 6528 6669 6c65 6e61 6d65 2929  rname(filename))
+0002fa80: 202f 2065 7661 6c5f 7661 7228 696e 636c   / eval_var(incl
+0002fa90: 7564 655f 6669 6c65 290a 2020 2020 2020  ude_file).      
+0002faa0: 2020 2020 2020 2020 2020 6966 2022 2e22            if "."
+0002fab0: 2069 6e20 696e 636c 7564 655f 6669 6c65   in include_file
+0002fac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fad0: 2065 6c73 6520 6576 616c 5f76 6172 2869   else eval_var(i
+0002fae0: 6e63 6c75 6465 5f66 696c 6529 0a20 2020  nclude_file).   
+0002faf0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002fb00: 2020 2020 2020 2069 6e63 6c75 6465 645f         included_
+0002fb10: 7069 7065 203d 2070 6172 7365 5f70 6970  pipe = parse_pip
+0002fb20: 6528 696e 636c 7564 655f 6669 6c65 2c20  e(include_file, 
+0002fb30: 736b 6970 5f65 7661 6c3d 736b 6970 5f65  skip_eval=skip_e
+0002fb40: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
+0002fb50: 2070 6970 655f 6e6f 6465 7320 3d20 646f   pipe_nodes = do
+0002fb60: 632e 6e6f 6465 732e 636f 7079 2829 0a20  c.nodes.copy(). 
+0002fb70: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0002fb80: 6e63 6c75 6465 645f 6e6f 6465 2069 6e20  ncluded_node in 
+0002fb90: 696e 636c 7564 6564 5f70 6970 652e 6e6f  included_pipe.no
+0002fba0: 6465 732e 636f 7079 2829 3a0a 2020 2020  des.copy():.    
+0002fbb0: 2020 2020 2020 2020 2020 2020 756e 726f              unro
+0002fbc0: 6c6c 6564 5f69 6e63 6c75 6465 645f 6e6f  lled_included_no
+0002fbd0: 6465 203d 206e 6578 7428 0a20 2020 2020  de = next(.     
+0002fbe0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0002fbf0: 6e6f 6465 2066 6f72 206e 6f64 6520 696e  node for node in
+0002fc00: 2070 6970 655f 6e6f 6465 7320 6966 206e   pipe_nodes if n
+0002fc10: 6f64 655b 226e 616d 6522 5d20 3d3d 2069  ode["name"] == i
+0002fc20: 6e63 6c75 6465 645f 6e6f 6465 5b22 6e61  ncluded_node["na
+0002fc30: 6d65 225d 292c 204e 6f6e 650a 2020 2020  me"]), None.    
+0002fc40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002fc50: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002fc60: 2075 6e72 6f6c 6c65 645f 696e 636c 7564   unrolled_includ
+0002fc70: 6564 5f6e 6f64 653a 0a20 2020 2020 2020  ed_node:.       
+0002fc80: 2020 2020 2020 2020 2020 2020 2064 6f63               doc
+0002fc90: 2e6e 6f64 6573 2e72 656d 6f76 6528 756e  .nodes.remove(un
+0002fca0: 726f 6c6c 6564 5f69 6e63 6c75 6465 645f  rolled_included_
+0002fcb0: 6e6f 6465 290a 2020 2020 666f 7220 6e6f  node).    for no
+0002fcc0: 6465 2069 6e20 646f 632e 6e6f 6465 733a  de in doc.nodes:
+0002fcd0: 0a20 2020 2020 2020 2061 7761 6974 2066  .        await f
+0002fce0: 6f72 6d61 745f 6e6f 6465 280a 2020 2020  ormat_node(.    
+0002fcf0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002fd00: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+0002fd10: 6e6f 6465 2c0a 2020 2020 2020 2020 2020  node,.          
+0002fd20: 2020 646f 632e 696e 636c 7564 6573 2c0a    doc.includes,.
+0002fd30: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0002fd40: 5f6c 656e 6774 683d 6c69 6e65 5f6c 656e  _length=line_len
+0002fd50: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
+0002fd60: 2075 6e72 6f6c 6c5f 696e 636c 7564 6573   unroll_includes
+0002fd70: 3d75 6e72 6f6c 6c5f 696e 636c 7564 6573  =unroll_includes
+0002fd80: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
+0002fd90: 7765 725f 6b65 7977 6f72 6473 3d54 7275  wer_keywords=Tru
+0002fda0: 6520 6966 2066 6f72 5f64 6570 6c6f 795f  e if for_deploy_
+0002fdb0: 6469 6666 2065 6c73 6520 4661 6c73 652c  diff else False,
+0002fdc0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0002fdd0: 6966 206e 6f74 2075 6e72 6f6c 6c5f 696e  if not unroll_in
+0002fde0: 636c 7564 6573 3a0a 2020 2020 2020 2020  cludes:.        
+0002fdf0: 666f 7220 6b2c 205f 2069 6e20 646f 632e  for k, _ in doc.
+0002fe00: 696e 636c 7564 6573 2e69 7465 6d73 2829  includes.items()
+0002fe10: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0002fe20: 2022 2e69 6e63 6c22 206e 6f74 2069 6e20   ".incl" not in 
+0002fe30: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+0002fe40: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0002fe50: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002fe60: 7473 2e61 7070 656e 6428 6622 494e 434c  ts.append(f"INCL
+0002fe70: 5544 4520 7b6b 7d22 290a 2020 2020 2020  UDE {k}").      
+0002fe80: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
+0002fe90: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
+0002fea0: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
+0002feb0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002fec0: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002fed0: 455f 4e45 575f 4c49 4e45 290a 0a20 2020  E_NEW_LINE)..   
+0002fee0: 2072 6573 756c 7420 3d20 2222 2e6a 6f69   result = "".joi
+0002fef0: 6e28 6669 6c65 5f70 6172 7473 290a 2020  n(file_parts).  
+0002ff00: 2020 7265 7375 6c74 203d 2072 6573 756c    result = resul
+0002ff10: 742e 7273 7472 6970 2822 5c6e 2229 202b  t.rstrip("\n") +
+0002ff20: 2022 5c6e 220a 2020 2020 7265 7475 726e   "\n".    return
+0002ff30: 2072 6573 756c 740a 0a0a 6465 6620 666f   result...def fo
+0002ff40: 726d 6174 5f73 716c 2873 716c 3a20 7374  rmat_sql(sql: st
+0002ff50: 722c 2044 4154 4146 494c 455f 494e 4445  r, DATAFILE_INDE
+0002ff60: 4e54 3a20 7374 722c 206c 696e 655f 6c65  NT: str, line_le
+0002ff70: 6e67 7468 3a20 4f70 7469 6f6e 616c 5b69  ngth: Optional[i
+0002ff80: 6e74 5d20 3d20 4e6f 6e65 2c20 6c6f 7765  nt] = None, lowe
+0002ff90: 725f 6b65 7977 6f72 6473 3a20 626f 6f6c  r_keywords: bool
+0002ffa0: 203d 2046 616c 7365 2920 2d3e 2073 7472   = False) -> str
+0002ffb0: 3a0a 2020 2020 7371 6c20 3d20 666f 726d  :.    sql = form
+0002ffc0: 6174 5f73 716c 5f74 656d 706c 6174 6528  at_sql_template(
+0002ffd0: 7371 6c2e 7374 7269 7028 292c 206c 696e  sql.strip(), lin
+0002ffe0: 655f 6c65 6e67 7468 3d6c 696e 655f 6c65  e_length=line_le
+0002fff0: 6e67 7468 2c20 6c6f 7765 725f 6b65 7977  ngth, lower_keyw
+00030000: 6f72 6473 3d6c 6f77 6572 5f6b 6579 776f  ords=lower_keywo
+00030010: 7264 7329 0a20 2020 2072 6574 7572 6e20  rds).    return 
+00030020: 225c 6e22 2e6a 6f69 6e28 5b66 227b 4441  "\n".join([f"{DA
+00030030: 5441 4649 4c45 5f49 4e44 454e 547d 7b70  TAFILE_INDENT}{p
+00030040: 6172 747d 2220 666f 7220 7061 7274 2069  art}" for part i
+00030050: 6e20 7371 6c2e 7370 6c69 7428 225c 6e22  n sql.split("\n"
+00030060: 2920 6966 206c 656e 2870 6172 742e 7374  ) if len(part.st
+00030070: 7269 7028 2929 5d29 0a0a 0a61 7379 6e63  rip())])...async
+00030080: 2064 6566 205f 6761 7468 6572 5f77 6974   def _gather_wit
+00030090: 685f 636f 6e63 7572 7265 6e63 7928 6e2c  h_concurrency(n,
+000300a0: 202a 7461 736b 7329 3a0a 2020 2020 7365   *tasks):.    se
+000300b0: 6d61 7068 6f72 6520 3d20 5365 6d61 7068  maphore = Semaph
+000300c0: 6f72 6528 6e29 0a0a 2020 2020 6173 796e  ore(n)..    asyn
+000300d0: 6320 6465 6620 7365 6d5f 7461 736b 2874  c def sem_task(t
+000300e0: 6173 6b29 3a0a 2020 2020 2020 2020 6173  ask):.        as
+000300f0: 796e 6320 7769 7468 2073 656d 6170 686f  ync with semapho
+00030100: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
+00030110: 7265 7475 726e 2061 7761 6974 2074 6173  return await tas
+00030120: 6b0a 0a20 2020 2072 6574 7572 6e20 6177  k..    return aw
+00030130: 6169 7420 6761 7468 6572 282a 2873 656d  ait gather(*(sem
+00030140: 5f74 6173 6b28 7461 736b 2920 666f 7220  _task(task) for 
+00030150: 7461 736b 2069 6e20 7461 736b 7329 290a  task in tasks)).
+00030160: 0a0a 6173 796e 6320 6465 6620 666f 6c64  ..async def fold
+00030170: 6572 5f70 756c 6c28 0a20 2020 2063 6c69  er_pull(.    cli
+00030180: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
+00030190: 666f 6c64 6572 3a20 7374 722c 0a20 2020  folder: str,.   
+000301a0: 2061 7574 6f3a 2062 6f6f 6c2c 0a20 2020   auto: bool,.   
+000301b0: 206d 6174 6368 3a20 4f70 7469 6f6e 616c   match: Optional
+000301c0: 5b73 7472 5d2c 0a20 2020 2066 6f72 6365  [str],.    force
+000301d0: 3a20 626f 6f6c 2c0a 2020 2020 7665 7262  : bool,.    verb
+000301e0: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
+000301f0: 2c0a 2020 2020 7072 6f67 7265 7373 5f62  ,.    progress_b
+00030200: 6172 3a20 626f 6f6c 203d 2046 616c 7365  ar: bool = False
+00030210: 2c0a 293a 2020 2320 6e6f 7161 3a20 4339  ,.):  # noqa: C9
+00030220: 3031 0a20 2020 2070 6174 7465 726e 203d  01.    pattern =
+00030230: 2072 652e 636f 6d70 696c 6528 6d61 7463   re.compile(matc
+00030240: 6829 2069 6620 6d61 7463 6820 656c 7365  h) if match else
+00030250: 204e 6f6e 650a 0a20 2020 2064 6566 205f   None..    def _
+00030260: 6765 745f 6c61 7465 7374 5f76 6572 7369  get_latest_versi
+00030270: 6f6e 7328 7265 736f 7572 6365 733a 204c  ons(resources: L
+00030280: 6973 745b 7374 725d 293a 0a20 2020 2020  ist[str]):.     
+00030290: 2020 2076 6572 7369 6f6e 733a 2044 6963     versions: Dic
+000302a0: 745b 7374 722c 2041 6e79 5d20 3d20 7b7d  t[str, Any] = {}
+000302b0: 0a0a 2020 2020 2020 2020 666f 7220 7820  ..        for x 
+000302c0: 696e 2072 6573 6f75 7263 6573 3a0a 2020  in resources:.  
+000302d0: 2020 2020 2020 2020 2020 7420 3d20 6765            t = ge
+000302e0: 745f 6e61 6d65 5f76 6572 7369 6f6e 2878  t_name_version(x
+000302f0: 290a 2020 2020 2020 2020 2020 2020 745b  ).            t[
+00030300: 226f 7269 6769 6e61 6c5f 6e61 6d65 225d  "original_name"]
+00030310: 203d 2078 0a20 2020 2020 2020 2020 2020   = x.           
+00030320: 2069 6620 745b 2276 6572 7369 6f6e 225d   if t["version"]
+00030330: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00030340: 2020 2020 2020 2020 2020 745b 2276 6572            t["ver
+00030350: 7369 6f6e 225d 203d 202d 310a 2020 2020  sion"] = -1.    
+00030360: 2020 2020 2020 2020 6e61 6d65 203d 2074          name = t
+00030370: 5b22 6e61 6d65 225d 0a0a 2020 2020 2020  ["name"]..      
+00030380: 2020 2020 2020 6966 206e 616d 6520 6e6f        if name no
+00030390: 7420 696e 2076 6572 7369 6f6e 7320 6f72  t in versions or
+000303a0: 206e 616d 6520 3d3d 2078 206f 7220 7665   name == x or ve
+000303b0: 7273 696f 6e73 5b6e 616d 655d 5b22 7665  rsions[name]["ve
+000303c0: 7273 696f 6e22 5d20 3c20 745b 2276 6572  rsion"] < t["ver
+000303d0: 7369 6f6e 225d 3a0a 2020 2020 2020 2020  sion"]:.        
+000303e0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000303f0: 5b6e 616d 655d 203d 2074 0a20 2020 2020  [name] = t.     
+00030400: 2020 2072 6574 7572 6e20 7665 7273 696f     return versio
+00030410: 6e73 0a0a 2020 2020 6465 6620 6765 745f  ns..    def get_
+00030420: 6669 6c65 5f66 6f6c 6465 7228 6578 7465  file_folder(exte
+00030430: 6e73 696f 6e3a 2073 7472 293a 0a20 2020  nsion: str):.   
+00030440: 2020 2020 2069 6620 6e6f 7420 6175 746f       if not auto
+00030450: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00030460: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
+00030470: 2020 6966 2065 7874 656e 7369 6f6e 203d    if extension =
+00030480: 3d20 2264 6174 6173 6f75 7263 6522 3a0a  = "datasource":.
+00030490: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000304a0: 726e 2022 6461 7461 736f 7572 6365 7322  rn "datasources"
+000304b0: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
+000304c0: 6e73 696f 6e20 3d3d 2022 7069 7065 223a  nsion == "pipe":
+000304d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000304e0: 7572 6e20 2270 6970 6573 220a 2020 2020  urn "pipes".    
+000304f0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
+00030500: 203d 3d20 2274 6f6b 656e 223a 0a20 2020   == "token":.   
+00030510: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00030520: 2274 6f6b 656e 7322 0a20 2020 2020 2020  "tokens".       
+00030530: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+00030540: 2020 6173 796e 6320 6465 6620 7772 6974    async def writ
+00030550: 655f 6669 6c65 7328 0a20 2020 2020 2020  e_files(.       
+00030560: 2076 6572 7369 6f6e 733a 2044 6963 745b   versions: Dict[
+00030570: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
+00030580: 2020 2072 6573 6f75 7263 6573 3a20 4c69     resources: Li
+00030590: 7374 5b73 7472 5d2c 0a20 2020 2020 2020  st[str],.       
+000305a0: 2065 7874 656e 7369 6f6e 3a20 7374 722c   extension: str,
+000305b0: 0a20 2020 2020 2020 2067 6574 5f72 6573  .        get_res
+000305c0: 6f75 7263 655f 6675 6e63 7469 6f6e 3a20  ource_function: 
+000305d0: 7374 722c 0a20 2020 2020 2020 2070 726f  str,.        pro
+000305e0: 6772 6573 735f 6261 723a 2062 6f6f 6c20  gress_bar: bool 
+000305f0: 3d20 4661 6c73 652c 0a20 2020 2029 3a0a  = False,.    ):.
+00030600: 2020 2020 2020 2020 6173 796e 6320 6465          async de
+00030610: 6620 7772 6974 655f 7265 736f 7572 6365  f write_resource
+00030620: 286b 3a20 4469 6374 5b73 7472 2c20 416e  (k: Dict[str, An
+00030630: 795d 293a 0a20 2020 2020 2020 2020 2020  y]):.           
+00030640: 206e 616d 6520 3d20 6622 7b6b 5b27 6e61   name = f"{k['na
+00030650: 6d65 275d 7d2e 7b65 7874 656e 7369 6f6e  me']}.{extension
+00030660: 7d22 0a20 2020 2020 2020 2020 2020 2074  }".            t
+00030670: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00030680: 2020 2020 6966 2070 6174 7465 726e 2061      if pattern a
+00030690: 6e64 206e 6f74 2070 6174 7465 726e 2e73  nd not pattern.s
+000306a0: 6561 7263 6828 6e61 6d65 293a 0a20 2020  earch(name):.   
+000306b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306c0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+000306d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306e0: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+000306f0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00030700: 696e 666f 5f73 6b69 7070 696e 675f 7265  info_skipping_re
+00030710: 736f 7572 6365 2872 6573 6f75 7263 653d  source(resource=
+00030720: 6e61 6d65 2929 0a20 2020 2020 2020 2020  name)).         
+00030730: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00030740: 6e0a 0a20 2020 2020 2020 2020 2020 2020  n..             
+00030750: 2020 2072 6573 6f75 7263 6520 3d20 6177     resource = aw
+00030760: 6169 7420 6765 7461 7474 7228 636c 6965  ait getattr(clie
+00030770: 6e74 2c20 6765 745f 7265 736f 7572 6365  nt, get_resource
+00030780: 5f66 756e 6374 696f 6e29 286b 5b22 6f72  _function)(k["or
+00030790: 6967 696e 616c 5f6e 616d 6522 5d29 0a0a  iginal_name"])..
+000307a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000307b0: 6465 7374 5f66 6f6c 6465 7220 3d20 666f  dest_folder = fo
+000307c0: 6c64 6572 0a20 2020 2020 2020 2020 2020  lder.           
+000307d0: 2020 2020 2069 6620 222e 2220 696e 206b       if "." in k
+000307e0: 5b22 6e61 6d65 225d 2061 6e64 2065 7874  ["name"] and ext
+000307f0: 656e 7369 6f6e 2021 3d20 2274 6f6b 656e  ension != "token
+00030800: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00030810: 2020 2020 2020 2064 6573 745f 666f 6c64         dest_fold
+00030820: 6572 203d 2050 6174 6828 666f 6c64 6572  er = Path(folder
+00030830: 2920 2f20 2276 656e 646f 7222 202f 206b  ) / "vendor" / k
+00030840: 5b22 6e61 6d65 225d 2e73 706c 6974 2822  ["name"].split("
+00030850: 2e22 2c20 3129 5b30 5d0a 2020 2020 2020  .", 1)[0].      
+00030860: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+00030870: 6d65 203d 2066 227b 6b5b 276e 616d 6527  me = f"{k['name'
+00030880: 5d2e 7370 6c69 7428 272e 272c 2031 295b  ].split('.', 1)[
+00030890: 315d 7d2e 7b65 7874 656e 7369 6f6e 7d22  1]}.{extension}"
+000308a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000308b0: 2020 6669 6c65 5f66 6f6c 6465 7220 3d20    file_folder = 
+000308c0: 6765 745f 6669 6c65 5f66 6f6c 6465 7228  get_file_folder(
+000308d0: 6578 7465 6e73 696f 6e29 0a20 2020 2020  extension).     
+000308e0: 2020 2020 2020 2020 2020 2066 203d 2050             f = P
+000308f0: 6174 6828 6465 7374 5f66 6f6c 6465 7229  ath(dest_folder)
+00030900: 202f 2066 696c 655f 666f 6c64 6572 2069   / file_folder i
+00030910: 6620 6669 6c65 5f66 6f6c 6465 7220 6973  f file_folder is
+00030920: 206e 6f74 204e 6f6e 6520 656c 7365 2050   not None else P
+00030930: 6174 6828 6465 7374 5f66 6f6c 6465 7229  ath(dest_folder)
+00030940: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00030950: 2020 6966 206e 6f74 2066 2e65 7869 7374    if not f.exist
+00030960: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00030970: 2020 2020 2020 2020 2066 2e6d 6b64 6972           f.mkdir
+00030980: 2870 6172 656e 7473 3d54 7275 6529 0a0a  (parents=True)..
+00030990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309a0: 6620 3d20 6620 2f20 6e61 6d65 0a20 2020  f = f / name.   
+000309b0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+000309c0: 6f75 7263 655f 6e61 6d65 7320 3d20 5b78  ource_names = [x
+000309d0: 2e73 706c 6974 2822 2e22 295b 2d31 5d20  .split(".")[-1] 
+000309e0: 666f 7220 7820 696e 2072 6573 6f75 7263  for x in resourc
+000309f0: 6573 5d0a 0a20 2020 2020 2020 2020 2020  es]..           
+00030a00: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00030a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030a20: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00030a30: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00030a40: 696e 666f 5f77 7269 7469 6e67 5f72 6573  info_writing_res
+00030a50: 6f75 7263 6528 7265 736f 7572 6365 3d66  ource(resource=f
+00030a60: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00030a70: 2020 2069 6620 6e6f 7420 662e 6578 6973     if not f.exis
+00030a80: 7473 2829 206f 7220 666f 7263 653a 0a20  ts() or force:. 
+00030a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030aa0: 2020 2077 6974 6820 6f70 656e 2866 2c20     with open(f, 
+00030ab0: 2277 2229 2061 7320 6664 3a0a 2020 2020  "w") as fd:.    
+00030ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ad0: 2020 2020 2320 7665 7273 696f 6e73 2061      # versions a
+00030ae0: 7265 2061 2063 6c69 656e 7420 6f6e 6c79  re a client only
+00030af0: 2074 6869 6e67 2073 6f0a 2020 2020 2020   thing so.      
+00030b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b10: 2020 2320 6461 7461 6669 6c65 7320 6672    # datafiles fr
+00030b20: 6f6d 2074 6865 2073 6572 7665 7220 646f  om the server do
+00030b30: 206e 6f74 2063 6f6e 7461 696e 7320 696e   not contains in
+00030b40: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+00030b50: 7665 7273 696f 6e73 0a20 2020 2020 2020  versions.       
+00030b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b70: 2069 6620 6b5b 2276 6572 7369 6f6e 225d   if k["version"]
+00030b80: 203e 3d20 303a 0a20 2020 2020 2020 2020   >= 0:.         
+00030b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ba0: 2020 2072 6573 6f75 7263 6520 3d20 6622     resource = f"
+00030bb0: 5645 5253 494f 4e20 7b6b 5b27 7665 7273  VERSION {k['vers
+00030bc0: 696f 6e27 5d7d 5c6e 2220 2b20 7265 736f  ion']}\n" + reso
+00030bd0: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
+00030be0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00030bf0: 7265 736f 7572 6365 3a0a 2020 2020 2020  resource:.      
+00030c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c10: 2020 2020 2020 6d61 7463 6865 7320 3d20        matches = 
+00030c20: 7265 2e66 696e 6461 6c6c 2872 2228 5b5e  re.findall(r"([^
+00030c30: 5c73 5c2e 5d2a 5f5f 765c 642b 2922 2c20  \s\.]*__v\d+)", 
+00030c40: 7265 736f 7572 6365 290a 2020 2020 2020  resource).      
+00030c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c60: 2020 2020 2020 666f 7220 6d61 7463 6820        for match 
+00030c70: 696e 2073 6574 286d 6174 6368 6573 293a  in set(matches):
+00030c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ca0: 206d 203d 206d 6174 6368 2e73 706c 6974   m = match.split
+00030cb0: 2822 5f5f 7622 295b 305d 0a20 2020 2020  ("__v")[0].     
+00030cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cd0: 2020 2020 2020 2020 2020 2069 6620 6d20             if m 
+00030ce0: 696e 2072 6573 6f75 7263 6573 206f 7220  in resources or 
+00030cf0: 6d20 696e 2072 6573 6f75 7263 655f 6e61  m in resource_na
+00030d00: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
+00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d20: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00030d30: 6520 3d20 7265 736f 7572 6365 2e72 6570  e = resource.rep
+00030d40: 6c61 6365 286d 6174 6368 2c20 6d29 0a20  lace(match, m). 
+00030d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d60: 2020 2020 2020 2020 2020 2066 642e 7772             fd.wr
+00030d70: 6974 6528 7265 736f 7572 6365 290a 2020  ite(resource).  
+00030d80: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00030d90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00030da0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00030db0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00030dc0: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+00030dd0: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
+00030de0: 616e 6167 6572 2e69 6e66 6f5f 736b 6970  anager.info_skip
+00030df0: 5f61 6c72 6561 6479 5f65 7869 7374 7328  _already_exists(
+00030e00: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+00030e10: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00030e20: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00030e30: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
+00030e40: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
+00030e50: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+00030e60: 2e65 7272 6f72 5f65 7863 6570 7469 6f6e  .error_exception
+00030e70: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
+00030e80: 2020 2020 7661 6c75 6573 203d 2076 6572      values = ver
+00030e90: 7369 6f6e 732e 7661 6c75 6573 2829 0a0a  sions.values()..
+00030ea0: 2020 2020 2020 2020 6966 2070 726f 6772          if progr
+00030eb0: 6573 735f 6261 723a 0a20 2020 2020 2020  ess_bar:.       
+00030ec0: 2020 2020 2077 6974 6820 636c 6963 6b2e       with click.
+00030ed0: 7072 6f67 7265 7373 6261 7228 7661 6c75  progressbar(valu
+00030ee0: 6573 2c20 6c61 6265 6c3d 6622 5075 6c6c  es, label=f"Pull
+00030ef0: 696e 6720 7b65 7874 656e 7369 6f6e 7d73  ing {extension}s
+00030f00: 2229 2061 7320 7661 6c75 6573 3a20 2023  ") as values:  #
+00030f10: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+00030f20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00030f30: 7220 6b20 696e 2076 616c 7565 733a 0a20  r k in values:. 
+00030f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f50: 2020 2061 7761 6974 2077 7269 7465 5f72     await write_r
+00030f60: 6573 6f75 7263 6528 6b29 0a20 2020 2020  esource(k).     
+00030f70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00030f80: 2020 2020 2074 6173 6b73 203d 205b 7772       tasks = [wr
+00030f90: 6974 655f 7265 736f 7572 6365 286b 2920  ite_resource(k) 
+00030fa0: 666f 7220 6b20 696e 2076 616c 7565 735d  for k in values]
+00030fb0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00030fc0: 6974 205f 6761 7468 6572 5f77 6974 685f  it _gather_with_
+00030fd0: 636f 6e63 7572 7265 6e63 7928 352c 202a  concurrency(5, *
+00030fe0: 7461 736b 7329 0a0a 2020 2020 7472 793a  tasks)..    try:
+00030ff0: 0a20 2020 2020 2020 2064 6174 6173 6f75  .        datasou
+00031000: 7263 6573 203d 2061 7761 6974 2063 6c69  rces = await cli
+00031010: 656e 742e 6461 7461 736f 7572 6365 7328  ent.datasources(
+00031020: 290a 2020 2020 2020 2020 7265 6d6f 7465  ).        remote
+00031030: 5f64 6174 6173 6f75 7263 6573 203d 2073  _datasources = s
+00031040: 6f72 7465 6428 5b78 5b22 6e61 6d65 225d  orted([x["name"]
+00031050: 2066 6f72 2078 2069 6e20 6461 7461 736f   for x in dataso
+00031060: 7572 6365 735d 290a 2020 2020 2020 2020  urces]).        
+00031070: 6461 7461 736f 7572 6365 735f 7665 7273  datasources_vers
+00031080: 696f 6e73 203d 205f 6765 745f 6c61 7465  ions = _get_late
+00031090: 7374 5f76 6572 7369 6f6e 7328 7265 6d6f  st_versions(remo
+000310a0: 7465 5f64 6174 6173 6f75 7263 6573 290a  te_datasources).
+000310b0: 0a20 2020 2020 2020 2070 6970 6573 203d  .        pipes =
+000310c0: 2061 7761 6974 2063 6c69 656e 742e 7069   await client.pi
+000310d0: 7065 7328 290a 2020 2020 2020 2020 7265  pes().        re
+000310e0: 6d6f 7465 5f70 6970 6573 203d 2073 6f72  mote_pipes = sor
+000310f0: 7465 6428 5b78 5b22 6e61 6d65 225d 2066  ted([x["name"] f
+00031100: 6f72 2078 2069 6e20 7069 7065 735d 290a  or x in pipes]).
+00031110: 2020 2020 2020 2020 7069 7065 735f 7665          pipes_ve
+00031120: 7273 696f 6e73 203d 205f 6765 745f 6c61  rsions = _get_la
+00031130: 7465 7374 5f76 6572 7369 6f6e 7328 7265  test_versions(re
+00031140: 6d6f 7465 5f70 6970 6573 290a 0a20 2020  mote_pipes)..   
+00031150: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
+00031160: 206c 6973 7428 6461 7461 736f 7572 6365   list(datasource
+00031170: 735f 7665 7273 696f 6e73 2e6b 6579 7328  s_versions.keys(
+00031180: 2929 202b 206c 6973 7428 7069 7065 735f  )) + list(pipes_
+00031190: 7665 7273 696f 6e73 2e6b 6579 7328 2929  versions.keys())
+000311a0: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
+000311b0: 7772 6974 655f 6669 6c65 7328 6461 7461  write_files(data
+000311c0: 736f 7572 6365 735f 7665 7273 696f 6e73  sources_versions
+000311d0: 2c20 7265 736f 7572 6365 732c 2022 6461  , resources, "da
+000311e0: 7461 736f 7572 6365 222c 2022 6461 7461  tasource", "data
+000311f0: 736f 7572 6365 5f66 696c 6522 2c20 7072  source_file", pr
+00031200: 6f67 7265 7373 5f62 6172 3d70 726f 6772  ogress_bar=progr
+00031210: 6573 735f 6261 7229 0a20 2020 2020 2020  ess_bar).       
+00031220: 2061 7761 6974 2077 7269 7465 5f66 696c   await write_fil
+00031230: 6573 2870 6970 6573 5f76 6572 7369 6f6e  es(pipes_version
+00031240: 732c 2072 6573 6f75 7263 6573 2c20 2270  s, resources, "p
+00031250: 6970 6522 2c20 2270 6970 655f 6669 6c65  ipe", "pipe_file
+00031260: 222c 2070 726f 6772 6573 735f 6261 723d  ", progress_bar=
+00031270: 7072 6f67 7265 7373 5f62 6172 290a 0a20  progress_bar).. 
+00031280: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00031290: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000312a0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+000312b0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+000312c0: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+000312d0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+000312e0: 6f72 5f70 756c 6c28 6572 726f 723d 7374  or_pull(error=st
+000312f0: 7228 6529 2929 0a0a 0a64 6566 2063 6f6c  r(e)))...def col
+00031300: 6f72 5f64 6966 6628 6469 6666 3a20 4974  or_diff(diff: It
+00031310: 6572 6162 6c65 5b73 7472 5d29 202d 3e20  erable[str]) -> 
+00031320: 4765 6e65 7261 746f 725b 7374 722c 2041  Generator[str, A
+00031330: 6e79 2c20 4e6f 6e65 5d3a 0a20 2020 2066  ny, None]:.    f
+00031340: 6f72 206c 696e 6520 696e 2064 6966 663a  or line in diff:
+00031350: 0a20 2020 2020 2020 2069 6620 6c69 6e65  .        if line
+00031360: 2e73 7461 7274 7377 6974 6828 222b 2229  .startswith("+")
+00031370: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
+00031380: 656c 6420 466f 7265 2e47 5245 454e 202b  eld Fore.GREEN +
+00031390: 206c 696e 6520 2b20 466f 7265 2e52 4553   line + Fore.RES
+000313a0: 4554 0a20 2020 2020 2020 2065 6c69 6620  ET.        elif 
+000313b0: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
+000313c0: 222d 2229 3a0a 2020 2020 2020 2020 2020  "-"):.          
+000313d0: 2020 7969 656c 6420 466f 7265 2e52 4544    yield Fore.RED
+000313e0: 202b 206c 696e 6520 2b20 466f 7265 2e52   + line + Fore.R
+000313f0: 4553 4554 0a20 2020 2020 2020 2065 6c69  ESET.        eli
+00031400: 6620 6c69 6e65 2e73 7461 7274 7377 6974  f line.startswit
+00031410: 6828 225e 2229 3a0a 2020 2020 2020 2020  h("^"):.        
+00031420: 2020 2020 7969 656c 6420 466f 7265 2e42      yield Fore.B
+00031430: 4c55 4520 2b20 6c69 6e65 202b 2046 6f72  LUE + line + For
+00031440: 652e 5245 5345 540a 2020 2020 2020 2020  e.RESET.        
+00031450: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00031460: 2020 7969 656c 6420 6c69 6e65 0a0a 0a64    yield line...d
+00031470: 6566 2070 6565 6b28 6974 6572 6162 6c65  ef peek(iterable
+00031480: 293a 0a20 2020 2074 7279 3a0a 2020 2020  ):.    try:.    
+00031490: 2020 2020 6669 7273 7420 3d20 6e65 7874      first = next
+000314a0: 2869 7465 7261 626c 6529 0a20 2020 2065  (iterable).    e
+000314b0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+000314c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000314d0: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2072  None, None.    r
+000314e0: 6574 7572 6e20 6669 7273 742c 2069 7465  eturn first, ite
+000314f0: 7274 6f6f 6c73 2e63 6861 696e 285b 6669  rtools.chain([fi
+00031500: 7273 745d 2c20 6974 6572 6162 6c65 290a  rst], iterable).
+00031510: 0a0a 6173 796e 6320 6465 6620 6469 6666  ..async def diff
+00031520: 5f63 6f6d 6d61 6e64 280a 2020 2020 6669  _command(.    fi
+00031530: 6c65 6e61 6d65 733a 204f 7074 696f 6e61  lenames: Optiona
+00031540: 6c5b 4c69 7374 5b73 7472 5d5d 2c0a 2020  l[List[str]],.  
+00031550: 2020 666d 743a 2062 6f6f 6c2c 0a20 2020    fmt: bool,.   
+00031560: 2063 6c69 656e 743a 2054 696e 7942 2c0a   client: TinyB,.
+00031570: 2020 2020 6e6f 5f63 6f6c 6f72 3a20 4f70      no_color: Op
+00031580: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
+00031590: 616c 7365 2c0a 2020 2020 7769 7468 5f70  alse,.    with_p
+000315a0: 7269 6e74 3a20 4f70 7469 6f6e 616c 5b62  rint: Optional[b
+000315b0: 6f6f 6c5d 203d 2054 7275 652c 0a20 2020  ool] = True,.   
+000315c0: 2076 6572 626f 7365 3a20 4f70 7469 6f6e   verbose: Option
+000315d0: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+000315e0: 0a20 2020 2063 6c65 616e 5f75 703a 204f  .    clean_up: O
+000315f0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00031600: 4661 6c73 652c 0a20 2020 2070 726f 6772  False,.    progr
+00031610: 6573 735f 6261 723a 2062 6f6f 6c20 3d20  ess_bar: bool = 
+00031620: 4661 6c73 652c 0a20 2020 2066 6f72 5f64  False,.    for_d
+00031630: 6570 6c6f 793a 2062 6f6f 6c20 3d20 4661  eploy: bool = Fa
+00031640: 6c73 652c 0a29 3a0a 2020 2020 6465 6620  lse,.):.    def 
+00031650: 6973 5f73 6861 7265 645f 6461 7461 736f  is_shared_dataso
+00031660: 7572 6365 286e 616d 6529 3a0a 2020 2020  urce(name):.    
+00031670: 2020 2020 7265 7475 726e 2022 2e22 2069      return "." i
+00031680: 6e20 6e61 6d65 0a0a 2020 2020 7769 7468  n name..    with
+00031690: 5f65 7870 6c69 6369 745f 6669 6c65 6e61  _explicit_filena
+000316a0: 6d65 7320 3d20 6669 6c65 6e61 6d65 730a  mes = filenames.
+000316b0: 2020 2020 7665 7262 6f73 6520 3d20 5472      verbose = Tr
+000316c0: 7565 2069 6620 7665 7262 6f73 6520 6973  ue if verbose is
+000316d0: 204e 6f6e 6520 656c 7365 2076 6572 626f   None else verbo
+000316e0: 7365 0a0a 2020 2020 7461 7267 6574 5f64  se..    target_d
+000316f0: 6972 203d 2067 6574 6377 6428 2920 2b20  ir = getcwd() + 
+00031700: 6f73 2e70 6174 682e 7365 7020 2b20 222e  os.path.sep + ".
+00031710: 6469 6666 5f74 6d70 220a 2020 2020 5061  diff_tmp".    Pa
+00031720: 7468 2874 6172 6765 745f 6469 7229 2e6d  th(target_dir).m
+00031730: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
+00031740: 652c 2065 7869 7374 5f6f 6b3d 5472 7565  e, exist_ok=True
+00031750: 290a 0a20 2020 2069 6620 6669 6c65 6e61  )..    if filena
+00031760: 6d65 733a 0a20 2020 2020 2020 2069 6620  mes:.        if 
+00031770: 6c65 6e28 6669 6c65 6e61 6d65 7329 203d  len(filenames) =
+00031780: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00031790: 2066 696c 656e 616d 6573 203d 205b 6669   filenames = [fi
+000317a0: 6c65 6e61 6d65 735b 305d 5d20 2b20 6765  lenames[0]] + ge
+000317b0: 745f 7072 6f6a 6563 745f 6669 6c65 6e61  t_project_filena
+000317c0: 6d65 7328 6669 6c65 6e61 6d65 735b 305d  mes(filenames[0]
+000317d0: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
+000317e0: 666f 6c64 6572 5f70 756c 6c28 636c 6965  folder_pull(clie
+000317f0: 6e74 2c20 7461 7267 6574 5f64 6972 2c20  nt, target_dir, 
+00031800: 4661 6c73 652c 204e 6f6e 652c 2054 7275  False, None, Tru
+00031810: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
+00031820: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00031830: 2020 2020 6669 6c65 6e61 6d65 7320 3d20      filenames = 
+00031840: 6765 745f 7072 6f6a 6563 745f 6669 6c65  get_project_file
+00031850: 6e61 6d65 7328 222e 2229 0a20 2020 2020  names(".").     
+00031860: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00031870: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+00031880: 2e65 6368 6f28 2253 6176 696e 6720 7265  .echo("Saving re
+00031890: 6d6f 7465 2072 6573 6f75 7263 6573 2069  mote resources i
+000318a0: 6e20 2e64 6966 665f 746d 7020 666f 6c64  n .diff_tmp fold
+000318b0: 6572 2e5c 6e22 290a 2020 2020 2020 2020  er.\n").        
+000318c0: 6177 6169 7420 666f 6c64 6572 5f70 756c  await folder_pul
+000318d0: 6c28 636c 6965 6e74 2c20 7461 7267 6574  l(client, target
+000318e0: 5f64 6972 2c20 4661 6c73 652c 204e 6f6e  _dir, False, Non
+000318f0: 652c 2054 7275 652c 2076 6572 626f 7365  e, True, verbose
+00031900: 3d76 6572 626f 7365 2c20 7072 6f67 7265  =verbose, progre
+00031910: 7373 5f62 6172 3d70 726f 6772 6573 735f  ss_bar=progress_
+00031920: 6261 7229 0a0a 2020 2020 7265 6d6f 7465  bar)..    remote
+00031930: 5f64 6174 6173 6f75 7263 6573 3a20 4c69  _datasources: Li
+00031940: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
+00031950: 5d5d 203d 2061 7761 6974 2063 6c69 656e  ]] = await clien
+00031960: 742e 6461 7461 736f 7572 6365 7328 290a  t.datasources().
+00031970: 2020 2020 7265 6d6f 7465 5f70 6970 6573      remote_pipes
+00031980: 3a20 4c69 7374 5b44 6963 745b 7374 722c  : List[Dict[str,
+00031990: 2041 6e79 5d5d 203d 2061 7761 6974 2063   Any]] = await c
+000319a0: 6c69 656e 742e 7069 7065 7328 290a 0a20  lient.pipes().. 
+000319b0: 2020 206c 6f63 616c 5f72 6573 6f75 7263     local_resourc
+000319c0: 6573 203d 207b 0a20 2020 2020 2020 2050  es = {.        P
+000319d0: 6174 6828 6669 6c65 292e 7265 736f 6c76  ath(file).resolv
+000319e0: 6528 292e 7374 656d 3a20 6669 6c65 0a20  e().stem: file. 
+000319f0: 2020 2020 2020 2066 6f72 2066 696c 6520         for file 
+00031a00: 696e 2066 696c 656e 616d 6573 0a20 2020  in filenames.   
+00031a10: 2020 2020 2069 6620 2822 2e64 6174 6173       if (".datas
+00031a20: 6f75 7263 6522 2069 6e20 6669 6c65 206f  ource" in file o
+00031a30: 7220 222e 7069 7065 2220 696e 2066 696c  r ".pipe" in fil
+00031a40: 6529 2061 6e64 2022 2e69 6e63 6c22 206e  e) and ".incl" n
+00031a50: 6f74 2069 6e20 6669 6c65 0a20 2020 207d  ot in file.    }
+00031a60: 0a0a 2020 2020 6368 616e 6765 6420 3d20  ..    changed = 
+00031a70: 7b7d 0a20 2020 2066 6f72 2072 6573 6f75  {}.    for resou
+00031a80: 7263 6520 696e 2072 656d 6f74 655f 6461  rce in remote_da
+00031a90: 7461 736f 7572 6365 7320 2b20 7265 6d6f  tasources + remo
+00031aa0: 7465 5f70 6970 6573 3a0a 2020 2020 2020  te_pipes:.      
+00031ab0: 2020 7072 6f70 6572 7469 6573 3a20 4469    properties: Di
+00031ac0: 6374 5b73 7472 2c20 416e 795d 203d 2067  ct[str, Any] = g
+00031ad0: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
+00031ae0: 7265 736f 7572 6365 5b22 6e61 6d65 225d  resource["name"]
+00031af0: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
+00031b00: 2070 726f 7065 7274 6965 732e 6765 7428   properties.get(
+00031b10: 226e 616d 6522 2c20 4e6f 6e65 290a 2020  "name", None).  
+00031b20: 2020 2020 2020 6966 206e 616d 653a 0a20        if name:. 
+00031b30: 2020 2020 2020 2020 2020 2028 7266 696c             (rfil
+00031b40: 656e 616d 652c 2066 696c 6529 203d 206e  ename, file) = n
+00031b50: 6578 7428 0a20 2020 2020 2020 2020 2020  ext(.           
+00031b60: 2020 2020 2028 2872 6669 6c65 6e61 6d65       ((rfilename
+00031b70: 2c20 6669 6c65 2920 666f 7220 2872 6669  , file) for (rfi
+00031b80: 6c65 6e61 6d65 2c20 6669 6c65 2920 696e  lename, file) in
+00031b90: 206c 6f63 616c 5f72 6573 6f75 7263 6573   local_resources
+00031ba0: 2e69 7465 6d73 2829 2069 6620 6e61 6d65  .items() if name
+00031bb0: 203d 3d20 7266 696c 656e 616d 6529 2c0a   == rfilename),.
+00031bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031bd0: 2822 222c 204e 6f6e 6529 2c0a 2020 2020  ("", None),.    
+00031be0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00031bf0: 2020 2020 2020 6966 206e 6f74 2066 696c        if not fil
+00031c00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00031c10: 2020 2069 6620 6e6f 7420 7769 7468 5f65     if not with_e
+00031c20: 7870 6c69 6369 745f 6669 6c65 6e61 6d65  xplicit_filename
+00031c30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00031c40: 2020 2020 2020 2069 6620 7769 7468 5f70         if with_p
+00031c50: 7269 6e74 3a0a 2020 2020 2020 2020 2020  rint:.          
+00031c60: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00031c70: 6963 6b2e 6563 686f 2866 227b 7265 736f  ick.echo(f"{reso
+00031c80: 7572 6365 5b27 6e61 6d65 275d 7d20 6f6e  urce['name']} on
+00031c90: 6c79 2065 7869 7374 7320 7265 6d6f 7465  ly exists remote
+00031ca0: 6c79 5c6e 2229 0a20 2020 2020 2020 2020  ly\n").         
+00031cb0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00031cc0: 5f73 6861 7265 645f 6461 7461 736f 7572  _shared_datasour
+00031cd0: 6365 2872 6573 6f75 7263 655b 226e 616d  ce(resource["nam
+00031ce0: 6522 5d29 3a0a 2020 2020 2020 2020 2020  e"]):.          
+00031cf0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00031d00: 616e 6765 645b 7265 736f 7572 6365 5b22  anged[resource["
+00031d10: 6e61 6d65 225d 5d20 3d20 2273 6861 7265  name"]] = "share
+00031d20: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+00031d30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00031d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d50: 2020 2020 2063 6861 6e67 6564 5b72 6573       changed[res
+00031d60: 6f75 7263 655b 226e 616d 6522 5d5d 203d  ource["name"]] =
+00031d70: 2022 7265 6d6f 7465 220a 2020 2020 2020   "remote".      
+00031d80: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00031d90: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00031da0: 7375 6666 6978 203d 2022 2e64 6174 6173  suffix = ".datas
+00031db0: 6f75 7263 6522 2069 6620 222e 6461 7461  ource" if ".data
+00031dc0: 736f 7572 6365 2220 696e 2066 696c 6520  source" in file 
+00031dd0: 656c 7365 2022 2e70 6970 6522 0a20 2020  else ".pipe".   
+00031de0: 2020 2020 2020 2020 2074 6172 6765 7420           target 
+00031df0: 3d20 7461 7267 6574 5f64 6972 202b 206f  = target_dir + o
+00031e00: 732e 7061 7468 2e73 6570 202b 2072 6669  s.path.sep + rfi
+00031e10: 6c65 6e61 6d65 202b 2073 7566 6669 780a  lename + suffix.
+00031e20: 0a20 2020 2020 2020 2020 2020 2064 6966  .            dif
+00031e30: 665f 6c69 6e65 7320 3d20 6177 6169 7420  f_lines = await 
+00031e40: 6469 6666 5f66 696c 6573 280a 2020 2020  diff_files(.    
+00031e50: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00031e60: 6574 2c20 6669 6c65 2c20 7769 7468 5f66  et, file, with_f
+00031e70: 6f72 6d61 743d 666d 742c 2077 6974 685f  ormat=fmt, with_
+00031e80: 636f 6c6f 723d 286e 6f74 206e 6f5f 636f  color=(not no_co
+00031e90: 6c6f 7229 2c20 636c 6965 6e74 3d63 6c69  lor), client=cli
+00031ea0: 656e 742c 2066 6f72 5f64 6570 6c6f 793d  ent, for_deploy=
+00031eb0: 666f 725f 6465 706c 6f79 0a20 2020 2020  for_deploy.     
+00031ec0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00031ed0: 2020 2020 206e 6f74 5f65 6d70 7479 2c20       not_empty, 
+00031ee0: 6469 6666 5f6c 696e 6573 203d 2070 6565  diff_lines = pee
+00031ef0: 6b28 6469 6666 5f6c 696e 6573 290a 2020  k(diff_lines).  
+00031f00: 2020 2020 2020 2020 2020 6368 616e 6765            change
+00031f10: 645b 7266 696c 656e 616d 655d 203d 206e  d[rfilename] = n
+00031f20: 6f74 5f65 6d70 7479 0a20 2020 2020 2020  ot_empty.       
+00031f30: 2020 2020 2069 6620 6e6f 745f 656d 7074       if not_empt
+00031f40: 7920 616e 6420 7769 7468 5f70 7269 6e74  y and with_print
+00031f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00031f60: 2020 7379 732e 7374 646f 7574 2e77 7269    sys.stdout.wri
+00031f70: 7465 6c69 6e65 7328 6469 6666 5f6c 696e  telines(diff_lin
+00031f80: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00031f90: 2020 2020 636c 6963 6b2e 6563 686f 2822      click.echo("
+00031fa0: 2229 0a0a 2020 2020 666f 7220 7266 696c  ")..    for rfil
+00031fb0: 656e 616d 652c 205f 2069 6e20 6c6f 6361  ename, _ in loca
+00031fc0: 6c5f 7265 736f 7572 6365 732e 6974 656d  l_resources.item
+00031fd0: 7328 293a 0a20 2020 2020 2020 2069 6620  s():.        if 
+00031fe0: 7266 696c 656e 616d 6520 6e6f 7420 696e  rfilename not in
+00031ff0: 2063 6861 6e67 6564 3a0a 2020 2020 2020   changed:.      
+00032000: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
+00032010: 6365 2069 6e20 7265 6d6f 7465 5f64 6174  ce in remote_dat
+00032020: 6173 6f75 7263 6573 202b 2072 656d 6f74  asources + remot
+00032030: 655f 7069 7065 733a 0a20 2020 2020 2020  e_pipes:.       
+00032040: 2020 2020 2020 2020 2070 726f 7065 7274           propert
+00032050: 6965 7320 3d20 6765 745f 6e61 6d65 5f76  ies = get_name_v
+00032060: 6572 7369 6f6e 2872 6573 6f75 7263 655b  ersion(resource[
+00032070: 226e 616d 6522 5d29 0a20 2020 2020 2020  "name"]).       
+00032080: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
+00032090: 7072 6f70 6572 7469 6573 2e67 6574 2822  properties.get("
+000320a0: 6e61 6d65 222c 204e 6f6e 6529 0a20 2020  name", None).   
+000320b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000320c0: 6e61 6d65 2061 6e64 206e 616d 6520 3d3d  name and name ==
+000320d0: 2072 6669 6c65 6e61 6d65 3a0a 2020 2020   rfilename:.    
+000320e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000320f0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+00032100: 2020 2020 2020 2069 6620 7769 7468 5f70         if with_p
+00032110: 7269 6e74 2061 6e64 2072 6669 6c65 6e61  rint and rfilena
+00032120: 6d65 206e 6f74 2069 6e20 6368 616e 6765  me not in change
+00032130: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00032140: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+00032150: 6f28 6622 7b72 6669 6c65 6e61 6d65 7d20  o(f"{rfilename} 
+00032160: 6f6e 6c79 2065 7869 7374 7320 6c6f 6361  only exists loca
+00032170: 6c6c 795c 6e22 290a 2020 2020 2020 2020  lly\n").        
+00032180: 2020 2020 2020 2020 6368 616e 6765 645b          changed[
+00032190: 7266 696c 656e 616d 655d 203d 2022 6c6f  rfilename] = "lo
+000321a0: 6361 6c22 0a20 2020 2069 6620 636c 6561  cal".    if clea
+000321b0: 6e5f 7570 3a0a 2020 2020 2020 2020 7368  n_up:.        sh
+000321c0: 7574 696c 2e72 6d74 7265 6528 7461 7267  util.rmtree(targ
+000321d0: 6574 5f64 6972 290a 0a20 2020 2072 6574  et_dir)..    ret
+000321e0: 7572 6e20 6368 616e 6765 640a 0a0a 6173  urn changed...as
+000321f0: 796e 6320 6465 6620 6469 6666 5f66 696c  ync def diff_fil
+00032200: 6573 280a 2020 2020 6672 6f6d 5f66 696c  es(.    from_fil
+00032210: 653a 2073 7472 2c0a 2020 2020 746f 5f66  e: str,.    to_f
+00032220: 696c 653a 2073 7472 2c0a 2020 2020 6672  ile: str,.    fr
+00032230: 6f6d 5f66 696c 655f 7375 6666 6978 3a20  om_file_suffix: 
+00032240: 7374 7220 3d20 225b 7265 6d6f 7465 5d22  str = "[remote]"
+00032250: 2c0a 2020 2020 746f 5f66 696c 655f 7375  ,.    to_file_su
+00032260: 6666 6978 3a20 7374 7220 3d20 225b 6c6f  ffix: str = "[lo
+00032270: 6361 6c5d 222c 0a20 2020 2077 6974 685f  cal]",.    with_
+00032280: 666f 726d 6174 3a20 626f 6f6c 203d 2054  format: bool = T
+00032290: 7275 652c 0a20 2020 2077 6974 685f 636f  rue,.    with_co
+000322a0: 6c6f 723a 2062 6f6f 6c20 3d20 4661 6c73  lor: bool = Fals
+000322b0: 652c 0a20 2020 2063 6c69 656e 743a 204f  e,.    client: O
+000322c0: 7074 696f 6e61 6c5b 5469 6e79 425d 203d  ptional[TinyB] =
+000322d0: 204e 6f6e 652c 0a20 2020 2066 6f72 5f64   None,.    for_d
+000322e0: 6570 6c6f 793a 2062 6f6f 6c20 3d20 4661  eploy: bool = Fa
+000322f0: 6c73 652c 0a29 3a0a 2020 2020 6465 6620  lse,.):.    def 
+00032300: 6669 6c65 5f6c 696e 6573 2866 696c 656e  file_lines(filen
+00032310: 616d 6529 3a0a 2020 2020 2020 2020 7769  ame):.        wi
+00032320: 7468 206f 7065 6e28 6669 6c65 6e61 6d65  th open(filename
+00032330: 2920 6173 2066 696c 653a 0a20 2020 2020  ) as file:.     
+00032340: 2020 2020 2020 2072 6574 7572 6e20 6669         return fi
+00032350: 6c65 2e72 6561 646c 696e 6573 2829 0a0a  le.readlines()..
+00032360: 2020 2020 6173 796e 6320 6465 6620 7061      async def pa
+00032370: 7273 6528 6669 6c65 6e61 6d65 2c20 7769  rse(filename, wi
+00032380: 7468 5f66 6f72 6d61 743d 5472 7565 2c20  th_format=True, 
+00032390: 756e 726f 6c6c 5f69 6e63 6c75 6465 733d  unroll_includes=
+000323a0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+000323b0: 6578 7465 6e73 696f 6e73 203d 2050 6174  extensions = Pat
+000323c0: 6828 6669 6c65 6e61 6d65 292e 7375 6666  h(filename).suff
+000323d0: 6978 6573 0a20 2020 2020 2020 206c 696e  ixes.        lin
+000323e0: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
+000323f0: 2020 6966 2069 735f 6669 6c65 5f61 5f64    if is_file_a_d
+00032400: 6174 6173 6f75 7263 6528 6669 6c65 6e61  atasource(filena
+00032410: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
+00032420: 206c 696e 6573 203d 2028 0a20 2020 2020   lines = (.     
+00032430: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00032440: 2066 6f72 6d61 745f 6461 7461 736f 7572   format_datasour
+00032450: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00032460: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00032470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032480: 2020 2020 2020 756e 726f 6c6c 5f69 6e63        unroll_inc
+00032490: 6c75 6465 733d 756e 726f 6c6c 5f69 6e63  ludes=unroll_inc
+000324a0: 6c75 6465 732c 0a20 2020 2020 2020 2020  ludes,.         
+000324b0: 2020 2020 2020 2020 2020 2066 6f72 5f64             for_d
+000324c0: 6966 663d 5472 7565 2c0a 2020 2020 2020  iff=True,.      
+000324d0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+000324e0: 6965 6e74 3d63 6c69 656e 742c 0a20 2020  ient=client,.   
+000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032500: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
+00032510: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+00032520: 2020 2020 2020 2020 2020 2020 666f 725f              for_
+00032530: 6465 706c 6f79 5f64 6966 663d 666f 725f  deploy_diff=for_
+00032540: 6465 706c 6f79 2c0a 2020 2020 2020 2020  deploy,.        
+00032550: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00032560: 2020 2020 2020 2020 2020 6966 2077 6974            if wit
+00032570: 685f 666f 726d 6174 0a20 2020 2020 2020  h_format.       
+00032580: 2020 2020 2020 2020 2065 6c73 6520 6669           else fi
+00032590: 6c65 5f6c 696e 6573 2866 696c 656e 616d  le_lines(filenam
+000325a0: 6529 0a20 2020 2020 2020 2020 2020 2029  e).            )
+000325b0: 0a20 2020 2020 2020 2065 6c69 6620 2822  .        elif ("
+000325c0: 2e70 6970 6522 2069 6e20 6578 7465 6e73  .pipe" in extens
+000325d0: 696f 6e73 2920 6f72 2028 222e 696e 636c  ions) or (".incl
+000325e0: 2220 696e 2065 7874 656e 7369 6f6e 7329  " in extensions)
+000325f0: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
+00032600: 6e65 7320 3d20 280a 2020 2020 2020 2020  nes = (.        
+00032610: 2020 2020 2020 2020 6177 6169 7420 666f          await fo
+00032620: 726d 6174 5f70 6970 6528 0a20 2020 2020  rmat_pipe(.     
+00032630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00032640: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
+00032650: 2020 2020 2020 2020 2020 2020 2044 4546               DEF
+00032660: 4155 4c54 5f46 4d54 5f4c 494e 455f 4c45  AULT_FMT_LINE_LE
+00032670: 4e47 5448 2c0a 2020 2020 2020 2020 2020  NGTH,.          
+00032680: 2020 2020 2020 2020 2020 756e 726f 6c6c            unroll
+00032690: 5f69 6e63 6c75 6465 733d 756e 726f 6c6c  _includes=unroll
+000326a0: 5f69 6e63 6c75 6465 732c 0a20 2020 2020  _includes,.     
+000326b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000326c0: 6570 6c61 6365 5f69 6e63 6c75 6465 733d  eplace_includes=
+000326d0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000326e0: 2020 2020 2020 2020 2020 666f 725f 6465            for_de
+000326f0: 706c 6f79 5f64 6966 663d 666f 725f 6465  ploy_diff=for_de
+00032700: 706c 6f79 2c0a 2020 2020 2020 2020 2020  ploy,.          
+00032710: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00032720: 2020 2020 2020 2020 6966 2077 6974 685f          if with_
+00032730: 666f 726d 6174 0a20 2020 2020 2020 2020  format.         
+00032740: 2020 2020 2020 2065 6c73 6520 6669 6c65         else file
+00032750: 5f6c 696e 6573 2866 696c 656e 616d 6529  _lines(filename)
+00032760: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00032770: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00032780: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00032790: 6368 6f28 6622 556e 7375 7070 6f72 7465  cho(f"Unsupporte
+000327a0: 6420 6669 6c65 2074 7970 653a 207b 6669  d file type: {fi
+000327b0: 6c65 6e61 6d65 7d22 290a 2020 2020 2020  lename}").      
+000327c0: 2020 6966 206c 696e 6573 3a0a 2020 2020    if lines:.    
+000327d0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+000327e0: 6622 7b6c 7d5c 6e22 2066 6f72 206c 2069  f"{l}\n" for l i
+000327f0: 6e20 6c69 6e65 732e 7370 6c69 7428 225c  n lines.split("\
+00032800: 6e22 295d 2069 6620 7769 7468 5f66 6f72  n")] if with_for
+00032810: 6d61 7420 656c 7365 206c 696e 6573 2020  mat else lines  
+00032820: 2320 6e6f 7161 3a20 4537 3431 0a0a 2020  # noqa: E741..  
+00032830: 2020 7472 793a 0a20 2020 2020 2020 206c    try:.        l
+00032840: 696e 6573 3120 3d20 6177 6169 7420 7061  ines1 = await pa
+00032850: 7273 6528 6672 6f6d 5f66 696c 652c 2077  rse(from_file, w
+00032860: 6974 685f 666f 726d 6174 290a 2020 2020  ith_format).    
+00032870: 2020 2020 6c69 6e65 7332 203d 2061 7761      lines2 = awa
+00032880: 6974 2070 6172 7365 2874 6f5f 6669 6c65  it parse(to_file
+00032890: 2c20 7769 7468 5f66 6f72 6d61 742c 2075  , with_format, u
+000328a0: 6e72 6f6c 6c5f 696e 636c 7564 6573 3d54  nroll_includes=T
+000328b0: 7275 6529 0a20 2020 2065 7863 6570 7420  rue).    except 
+000328c0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+000328d0: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+000328e0: 6669 6c65 6e61 6d65 203d 206f 732e 7061  filename = os.pa
+000328f0: 7468 2e62 6173 656e 616d 6528 7374 7228  th.basename(str(
+00032900: 6529 292e 7374 7269 7028 2227 2229 0a20  e)).strip("'"). 
+00032910: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
+00032920: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
+00032930: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
+00032940: 722e 6572 726f 725f 6469 6666 5f66 696c  r.error_diff_fil
+00032950: 6528 6669 6c65 6e61 6d65 3d66 696c 656e  e(filename=filen
+00032960: 616d 6529 290a 0a20 2020 2069 6620 6e6f  ame))..    if no
+00032970: 7420 6c69 6e65 7331 206f 7220 6e6f 7420  t lines1 or not 
+00032980: 6c69 6e65 7332 3a0a 2020 2020 2020 2020  lines2:.        
+00032990: 7265 7475 726e 0a0a 2020 2020 6469 6666  return..    diff
+000329a0: 203d 2064 6966 666c 6962 2e75 6e69 6669   = difflib.unifi
+000329b0: 6564 5f64 6966 6628 0a20 2020 2020 2020  ed_diff(.       
+000329c0: 206c 696e 6573 312c 206c 696e 6573 322c   lines1, lines2,
+000329d0: 2066 726f 6d66 696c 653d 6622 7b50 6174   fromfile=f"{Pat
+000329e0: 6828 6672 6f6d 5f66 696c 6529 2e6e 616d  h(from_file).nam
+000329f0: 657d 207b 6672 6f6d 5f66 696c 655f 7375  e} {from_file_su
+00032a00: 6666 6978 7d22 2c20 746f 6669 6c65 3d66  ffix}", tofile=f
+00032a10: 227b 746f 5f66 696c 657d 207b 746f 5f66  "{to_file} {to_f
+00032a20: 696c 655f 7375 6666 6978 7d22 0a20 2020  ile_suffix}".   
+00032a30: 2029 0a0a 2020 2020 6966 2077 6974 685f   )..    if with_
+00032a40: 636f 6c6f 723a 0a20 2020 2020 2020 2064  color:.        d
+00032a50: 6966 6620 3d20 636f 6c6f 725f 6469 6666  iff = color_diff
+00032a60: 2864 6966 6629 0a0a 2020 2020 7265 7475  (diff)..    retu
+00032a70: 726e 2064 6966 660a 0a0a 6465 6620 6973  rn diff...def is
+00032a80: 5f65 6e64 706f 696e 7428 7265 736f 7572  _endpoint(resour
+00032a90: 6365 3a20 4f70 7469 6f6e 616c 5b44 6963  ce: Optional[Dic
+00032aa0: 745b 7374 722c 2041 6e79 5d5d 2920 2d3e  t[str, Any]]) ->
+00032ab0: 2062 6f6f 6c3a 0a20 2020 2069 6620 7265   bool:.    if re
+00032ac0: 736f 7572 6365 2061 6e64 206c 656e 2872  source and len(r
+00032ad0: 6573 6f75 7263 652e 6765 7428 2274 6f6b  esource.get("tok
+00032ae0: 656e 7322 2c20 5b5d 2929 2021 3d20 3020  ens", [])) != 0 
+00032af0: 616e 6420 7265 736f 7572 6365 2e67 6574  and resource.get
+00032b00: 2822 7265 736f 7572 6365 2229 203d 3d20  ("resource") == 
+00032b10: 2270 6970 6573 223a 0a20 2020 2020 2020  "pipes":.       
+00032b20: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+00032b30: 2072 6574 7572 6e20 4661 6c73 650a 0a0a   return False...
+00032b40: 6465 6620 6973 5f6d 6174 6572 6961 6c69  def is_materiali
+00032b50: 7a65 6428 7265 736f 7572 6365 3a20 4f70  zed(resource: Op
+00032b60: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
+00032b70: 2041 6e79 5d5d 2920 2d3e 2062 6f6f 6c3a   Any]]) -> bool:
+00032b80: 0a20 2020 2069 6620 6e6f 7420 7265 736f  .    if not reso
+00032b90: 7572 6365 3a0a 2020 2020 2020 2020 7265  urce:.        re
+00032ba0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00032bb0: 6973 5f6d 6174 6572 6961 6c69 7a65 6420  is_materialized 
+00032bc0: 3d20 616e 7928 0a20 2020 2020 2020 205b  = any(.        [
+00032bd0: 6e6f 6465 2e67 6574 2822 7061 7261 6d73  node.get("params
+00032be0: 222c 207b 7d29 2e67 6574 2822 7479 7065  ", {}).get("type
+00032bf0: 222c 204e 6f6e 6529 203d 3d20 226d 6174  ", None) == "mat
+00032c00: 6572 6961 6c69 7a65 6422 2066 6f72 206e  erialized" for n
+00032c10: 6f64 6520 696e 2072 6573 6f75 7263 652e  ode in resource.
+00032c20: 6765 7428 226e 6f64 6573 222c 205b 5d29  get("nodes", [])
+00032c30: 206f 7220 5b5d 5d0a 2020 2020 290a 2020   or []].    ).  
+00032c40: 2020 7265 7475 726e 2069 735f 6d61 7465    return is_mate
+00032c50: 7269 616c 697a 6564 0a0a 0a64 6566 2069  rialized...def i
+00032c60: 735f 656e 6470 6f69 6e74 5f77 6974 685f  s_endpoint_with_
+00032c70: 6e6f 5f64 6570 656e 6465 6e63 6965 7328  no_dependencies(
+00032c80: 0a20 2020 2072 6573 6f75 7263 653a 2044  .    resource: D
+00032c90: 6963 745b 7374 722c 2041 6e79 5d2c 2064  ict[str, Any], d
+00032ca0: 6570 5f6d 6170 3a20 4469 6374 5b73 7472  ep_map: Dict[str
+00032cb0: 2c20 5365 745b 7374 725d 5d2c 2074 6f5f  , Set[str]], to_
+00032cc0: 7275 6e3a 2044 6963 745b 7374 722c 2044  run: Dict[str, D
+00032cd0: 6963 745b 7374 722c 2041 6e79 5d5d 0a29  ict[str, Any]].)
+00032ce0: 202d 3e20 626f 6f6c 3a0a 2020 2020 6966   -> bool:.    if
+00032cf0: 206e 6f74 2072 6573 6f75 7263 6520 6f72   not resource or
+00032d00: 2072 6573 6f75 7263 652e 6765 7428 2272   resource.get("r
+00032d10: 6573 6f75 7263 6522 2920 3d3d 2022 6461  esource") == "da
+00032d20: 7461 736f 7572 6365 7322 3a0a 2020 2020  tasources":.    
+00032d30: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00032d40: 0a0a 2020 2020 666f 7220 6e6f 6465 2069  ..    for node i
+00032d50: 6e20 7265 736f 7572 6365 2e67 6574 2822  n resource.get("
+00032d60: 6e6f 6465 7322 2c20 5b5d 293a 0a20 2020  nodes", []):.   
+00032d70: 2020 2020 2023 2046 4958 4d45 3a20 6874       # FIXME: ht
+00032d80: 7470 733a 2f2f 6769 746c 6162 2e63 6f6d  tps://gitlab.com
+00032d90: 2f74 696e 7962 6972 642f 616e 616c 7974  /tinybird/analyt
+00032da0: 6963 732f 2d2f 6973 7375 6573 2f32 3339  ics/-/issues/239
+00032db0: 310a 2020 2020 2020 2020 6966 206e 6f64  1.        if nod
+00032dc0: 652e 6765 7428 2270 6172 616d 7322 2c20  e.get("params", 
+00032dd0: 7b7d 292e 6765 7428 2274 7970 6522 2c20  {}).get("type", 
+00032de0: 2222 292e 6c6f 7765 7228 2920 696e 205b  "").lower() in [
+00032df0: 0a20 2020 2020 2020 2020 2020 2050 6970  .            Pip
+00032e00: 654e 6f64 6554 7970 6573 2e4d 4154 4552  eNodeTypes.MATER
+00032e10: 4941 4c49 5a45 442c 0a20 2020 2020 2020  IALIZED,.       
+00032e20: 2020 2020 2050 6970 654e 6f64 6554 7970       PipeNodeTyp
+00032e30: 6573 2e43 4f50 592c 0a20 2020 2020 2020  es.COPY,.       
+00032e40: 2020 2020 2050 6970 654e 6f64 6554 7970       PipeNodeTyp
+00032e50: 6573 2e44 4154 415f 5349 4e4b 2c0a 2020  es.DATA_SINK,.  
+00032e60: 2020 2020 2020 5d3a 0a20 2020 2020 2020        ]:.       
+00032e70: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00032e80: 650a 0a20 2020 2066 6f72 206b 6579 2c20  e..    for key, 
+00032e90: 7661 6c75 6573 2069 6e20 6465 705f 6d61  values in dep_ma
+00032ea0: 702e 6974 656d 7328 293a 0a20 2020 2020  p.items():.     
+00032eb0: 2020 2069 6620 7265 736f 7572 6365 5b22     if resource["
+00032ec0: 7265 736f 7572 6365 5f6e 616d 6522 5d20  resource_name"] 
+00032ed0: 696e 2076 616c 7565 733a 0a20 2020 2020  in values:.     
+00032ee0: 2020 2020 2020 2072 203d 2074 6f5f 7275         r = to_ru
+00032ef0: 6e2e 6765 7428 6b65 792c 204e 6f6e 6529  n.get(key, None)
+00032f00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00032f10: 6e6f 7420 723a 0a20 2020 2020 2020 2020  not r:.         
+00032f20: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00032f30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00032f40: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
+00032f50: 7073 203d 2064 6570 5f6d 6170 2e67 6574  ps = dep_map.get
+00032f60: 2872 6573 6f75 7263 655b 2272 6573 6f75  (resource["resou
+00032f70: 7263 655f 6e61 6d65 225d 290a 2020 2020  rce_name"]).    
+00032f80: 6966 206e 6f74 2064 6570 733a 0a20 2020  if not deps:.   
+00032f90: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00032fa0: 0a0a 2020 2020 666f 7220 6465 7020 696e  ..    for dep in
+00032fb0: 2064 6570 733a 0a20 2020 2020 2020 2072   deps:.        r
+00032fc0: 203d 2074 6f5f 7275 6e2e 6765 7428 6465   = to_run.get(de
+00032fd0: 702c 204e 6f6e 6529 0a20 2020 2020 2020  p, None).       
+00032fe0: 2069 6620 6973 5f65 6e64 706f 696e 7428   if is_endpoint(
+00032ff0: 7229 206f 7220 6973 5f6d 6174 6572 6961  r) or is_materia
+00033000: 6c69 7a65 6428 7229 3a0a 2020 2020 2020  lized(r):.      
+00033010: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00033020: 7365 0a0a 2020 2020 7265 7475 726e 2054  se..    return T
+00033030: 7275 650a 0a0a 6465 6620 6765 745f 7461  rue...def get_ta
+00033040: 7267 6574 5f6d 6174 6572 6961 6c69 7a65  rget_materialize
+00033050: 645f 6461 7461 5f73 6f75 7263 655f 6e61  d_data_source_na
+00033060: 6d65 2872 6573 6f75 7263 653a 204f 7074  me(resource: Opt
+00033070: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+00033080: 416e 795d 5d29 202d 3e20 4f70 7469 6f6e  Any]]) -> Option
+00033090: 616c 5b73 7472 5d3a 0a20 2020 2069 6620  al[str]:.    if 
+000330a0: 6e6f 7420 7265 736f 7572 6365 3a0a 2020  not resource:.  
+000330b0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+000330c0: 650a 0a20 2020 2066 6f72 206e 6f64 6520  e..    for node 
+000330d0: 696e 2072 6573 6f75 7263 652e 6765 7428  in resource.get(
+000330e0: 226e 6f64 6573 222c 205b 5d29 3a0a 2020  "nodes", []):.  
+000330f0: 2020 2020 2020 2320 4649 584d 453a 2068        # FIXME: h
+00033100: 7474 7073 3a2f 2f67 6974 6c61 622e 636f  ttps://gitlab.co
+00033110: 6d2f 7469 6e79 6269 7264 2f61 6e61 6c79  m/tinybird/analy
+00033120: 7469 6373 2f2d 2f69 7373 7565 732f 3233  tics/-/issues/23
+00033130: 3931 0a20 2020 2020 2020 2069 6620 6e6f  91.        if no
+00033140: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
+00033150: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
+00033160: 2022 2229 2e6c 6f77 6572 2829 203d 3d20   "").lower() == 
+00033170: 5069 7065 4e6f 6465 5479 7065 732e 4d41  PipeNodeTypes.MA
+00033180: 5445 5249 414c 495a 4544 3a0a 2020 2020  TERIALIZED:.    
+00033190: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+000331a0: 6f64 652e 6765 7428 2270 6172 616d 7322  ode.get("params"
+000331b0: 295b 2264 6174 6173 6f75 7263 6522 5d2e  )["datasource"].
+000331c0: 7370 6c69 7428 225f 5f76 2229 5b30 5d0a  split("__v")[0].
+000331d0: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
+000331e0: 0a0a 0a64 6566 2069 735f 6461 7461 736f  ...def is_dataso
+000331f0: 7572 6365 2872 6573 6f75 7263 653a 204f  urce(resource: O
+00033200: 7074 696f 6e61 6c5b 4469 6374 5b73 7472  ptional[Dict[str
+00033210: 2c20 416e 795d 5d29 202d 3e20 626f 6f6c  , Any]]) -> bool
+00033220: 3a0a 2020 2020 6966 2072 6573 6f75 7263  :.    if resourc
+00033230: 6520 616e 6420 7265 736f 7572 6365 2e67  e and resource.g
+00033240: 6574 2822 7265 736f 7572 6365 2229 203d  et("resource") =
+00033250: 3d20 2264 6174 6173 6f75 7263 6573 223a  = "datasources":
+00033260: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00033270: 5472 7565 0a20 2020 2072 6574 7572 6e20  True.    return 
+00033280: 4661 6c73 650a 0a0a 6173 796e 6320 6465  False...async de
+00033290: 6620 6372 6561 7465 5f72 656c 6561 7365  f create_release
+000332a0: 280a 2020 2020 636c 6965 6e74 3a20 5469  (.    client: Ti
+000332b0: 6e79 422c 2063 6f6e 6669 673a 2055 6e69  nyB, config: Uni
+000332c0: 6f6e 5b44 6963 745b 7374 722c 2041 6e79  on[Dict[str, Any
+000332d0: 5d2c 2043 4c49 436f 6e66 6967 5d2c 2073  ], CLIConfig], s
+000332e0: 656d 7665 723a 2073 7472 2c20 666f 6c64  emver: str, fold
+000332f0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00033300: 5d20 3d20 4e6f 6e65 0a29 202d 3e20 4e6f  ] = None.) -> No
+00033310: 6e65 3a0a 2020 2020 6966 206e 6f74 2066  ne:.    if not f
+00033320: 6f6c 6465 723a 0a20 2020 2020 2020 2066  older:.        f
+00033330: 6f6c 6465 7220 3d20 6765 7463 7764 2829  older = getcwd()
+00033340: 0a20 2020 2063 6c69 5f67 6974 5f72 656c  .    cli_git_rel
+00033350: 6561 7365 203d 204e 6f6e 650a 2020 2020  ease = None.    
+00033360: 7472 793a 0a20 2020 2020 2020 2063 6c69  try:.        cli
+00033370: 5f67 6974 5f72 656c 6561 7365 203d 2043  _git_release = C
+00033380: 4c49 4769 7452 656c 6561 7365 2870 6174  LIGitRelease(pat
+00033390: 683d 666f 6c64 6572 290a 2020 2020 2020  h=folder).      
+000333a0: 2020 636f 6d6d 6974 203d 2063 6c69 5f67    commit = cli_g
+000333b0: 6974 5f72 656c 6561 7365 2e68 6561 645f  it_release.head_
+000333c0: 636f 6d6d 6974 2829 0a20 2020 2065 7863  commit().    exc
+000333d0: 6570 7420 434c 4947 6974 5265 6c65 6173  ept CLIGitReleas
+000333e0: 6545 7863 6570 7469 6f6e 3a0a 2020 2020  eException:.    
+000333f0: 2020 2020 7261 6973 6520 434c 4947 6974      raise CLIGit
+00033400: 5265 6c65 6173 6545 7863 6570 7469 6f6e  ReleaseException
+00033410: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+00033420: 2e65 7272 6f72 5f6e 6f5f 6769 745f 7265  .error_no_git_re
+00033430: 706f 5f66 6f72 5f69 6e69 7428 7265 706f  po_for_init(repo
+00033440: 5f70 6174 683d 666f 6c64 6572 2929 0a0a  _path=folder))..
+00033450: 2020 2020 6177 6169 7420 636c 6965 6e74      await client
+00033460: 2e72 656c 6561 7365 5f6e 6577 2863 6f6e  .release_new(con
+00033470: 6669 675b 2269 6422 5d2c 2073 656d 7665  fig["id"], semve
+00033480: 722c 2063 6f6d 6d69 7429 0a20 2020 2063  r, commit).    c
+00033490: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+000334a0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+000334b0: 735f 6465 706c 6f79 6d65 6e74 5f72 656c  s_deployment_rel
+000334c0: 6561 7365 2873 656d 7665 723d 7365 6d76  ease(semver=semv
+000334d0: 6572 2929 0a0a 0a64 6566 2068 6173 5f69  er))...def has_i
+000334e0: 6e74 6572 6e61 6c5f 6461 7461 6669 6c65  nternal_datafile
+000334f0: 7328 666f 6c64 6572 3a20 7374 7229 202d  s(folder: str) -
+00033500: 3e20 626f 6f6c 3a0a 2020 2020 666f 6c64  > bool:.    fold
+00033510: 6572 203d 2066 6f6c 6465 7220 6f72 2022  er = folder or "
+00033520: 2e22 0a20 2020 2066 696c 656e 616d 6573  .".    filenames
+00033530: 203d 2067 6574 5f70 726f 6a65 6374 5f66   = get_project_f
+00033540: 696c 656e 616d 6573 2866 6f6c 6465 7229  ilenames(folder)
+00033550: 0a20 2020 2072 6574 7572 6e20 616e 7928  .    return any(
+00033560: 5b66 2066 6f72 2066 2069 6e20 6669 6c65  [f for f in file
+00033570: 6e61 6d65 7320 6966 2022 7370 616e 7322  names if "spans"
+00033580: 2069 6e20 7374 7228 6629 2061 6e64 2022   in str(f) and "
+00033590: 7665 6e64 6f72 2220 6e6f 7420 696e 2073  vendor" not in s
+000335a0: 7472 2866 295d 290a 0a0a 6465 6620 6973  tr(f)])...def is
+000335b0: 5f66 696c 655f 615f 6461 7461 736f 7572  _file_a_datasour
+000335c0: 6365 2866 696c 656e 616d 653a 2073 7472  ce(filename: str
+000335d0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2065  ) -> bool:.    e
+000335e0: 7874 656e 7369 6f6e 7320 3d20 5061 7468  xtensions = Path
+000335f0: 2866 696c 656e 616d 6529 2e73 7566 6669  (filename).suffi
+00033600: 7865 730a 2020 2020 6966 2022 2e64 6174  xes.    if ".dat
+00033610: 6173 6f75 7263 6522 2069 6e20 6578 7465  asource" in exte
+00033620: 6e73 696f 6e73 3a20 2023 2041 6363 6570  nsions:  # Accep
+00033630: 7473 2027 2e64 6174 6173 6f75 7263 6527  ts '.datasource'
+00033640: 2061 6e64 2027 2e64 6174 6173 6f75 7263   and '.datasourc
+00033650: 652e 696e 636c 270a 2020 2020 2020 2020  e.incl'.        
+00033660: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+00033670: 2069 6620 222e 696e 636c 2220 696e 2065   if ".incl" in e
+00033680: 7874 656e 7369 6f6e 733a 0a20 2020 2020  xtensions:.     
+00033690: 2020 206c 696e 6573 203d 205b 5d0a 2020     lines = [].  
+000336a0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+000336b0: 6669 6c65 6e61 6d65 2920 6173 2066 696c  filename) as fil
+000336c0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+000336d0: 696e 6573 203d 2066 696c 652e 7265 6164  ines = file.read
+000336e0: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
+000336f0: 2066 6f72 206c 696e 6520 696e 206c 696e   for line in lin
+00033700: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00033710: 7472 696d 6d65 645f 6c69 6e65 203d 206c  trimmed_line = l
+00033720: 696e 652e 7374 7269 7028 292e 6c6f 7765  ine.strip().lowe
+00033730: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00033740: 6966 2074 7269 6d6d 6564 5f6c 696e 652e  if trimmed_line.
+00033750: 7374 6172 7473 7769 7468 2822 7363 6865  startswith("sche
+00033760: 6d61 2229 206f 7220 7472 696d 6d65 645f  ma") or trimmed_
+00033770: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
+00033780: 2265 6e67 696e 6522 293a 0a20 2020 2020  "engine"):.     
+00033790: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000337a0: 6e20 5472 7565 0a0a 2020 2020 7265 7475  n True..    retu
+000337b0: 726e 2046 616c 7365 0a                   rn False.
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/datatypes.py` & `tinybird-cli-4.0.1.dev0/tinybird/datatypes.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/feedback_manager.py` & `tinybird-cli-4.0.1.dev0/tinybird/feedback_manager.py`

 * *Files 2% similar despite different names*

```diff
@@ -289,23 +289,23 @@
     error_no_git_repo_for_release = error_message("Invalid git repository in '{path}'")
     error_commit_changes_to_release = error_message(
         "Data project has changes: 'git status -s {path}'\n\n{git_output} \n\n You need to commit your changes in the data project, then re-run 'tb deploy' to deploy"
     )
     error_head_outdated = error_message(
         "Current HEAD commit '{commit}' is outdated.\n\n    💡Hint: consider to rebase your Git branch with base branch."
     )
-    error_head_already_released = error_message("Current HEAD commit '{commit}' is already released")
+    error_head_already_released = error_message("Current HEAD commit '{commit}' is already deployed")
     error_in_git_ancestor_commits = error_message(
         "Error checking relationship between HEAD '{head_commit}' and Workspace commit '{workspace_commit}'.\n\n    Current Workspace commit needs to be an ancestor of the commit being deployed.\n\n    💡 Hint: consider to rebase your Git branch. If the problem persists, double check the Workspace commit exists in the git log, if it does not exist you can override the Workspace commit to an ancestor of the commit being deployed using `tb init --override-commit <commit>`"
     )
     error_init_release = error_message(
-        "No release on Workspace '{workspace}'. Hint: use 'tb init --git' to start working with git releases"
+        "No release on Workspace '{workspace}'. Hint: use 'tb init --git' to start working with git"
     )
     error_branch_init_release = error_message(
-        "Branch '{workspace}' not ready for deploy. Hint: use 'tb init --git' to start working with git releases and assure Branch is completely created using '--wait' on 'tb branch create'"
+        "Branch '{workspace}' not ready for deploy. Hint: use 'tb init --git' to start working with git and assure Branch is completely created using '--wait' on 'tb branch create'"
     )
     error_commit_changes_to_init_release = error_message(
         "Data project has changes: 'git status -s {path}'\n\n{git_output} \n\n You need to commit your changes in the data project, then re-run 'tb init --git' to finish git initialization."
     )
     error_no_git_repo_for_init = error_message(
         "'{repo_path}' does not appear to be a git repository. Hint: you can create it with 'git init'"
     )
@@ -314,42 +314,42 @@
         "Include '.tinyb' in .gitignore. Otherwise you could expose tokens. Hint: 'echo \".tinyb\" >> {git_working_dir}.gitignore'"
     )
     error_dotdiff_not_ignored = error_message(
         "Include '.diff_tmp' in .gitignore. Hint: 'echo \".diff_tmp\" >> {git_working_dir}.gitignore'"
     )
     error_token_does_not_exist = error_message("Token '{token_id}' does not exist")
     error_no_correct_token_for_init = error_message(
-        "No access to git releases. Use a Workspace admin token. See https://www.tinybird.co/docs/version-control/working-with-version-control.html"
+        "No access to git. Use a Workspace admin token. See https://www.tinybird.co/docs/production/working-with-version-control.html"
     )
     error_diff_resources_for_git_init = error_message(
         "Error initializing Git, there are diffs between local Data Project and Workspace '{workspace}'.\nHint: Execute '{pull_command}' to download  Datafiles"
     )
     error_remove_oldest_rollback = error_message(
         "Removal of oldest rollback Release failed with error: {error}. Release {semver} is in preview status and has not been promoted, remove the rollback Release and promote to finish the deployment."
     )
-    error_release_already_set = error_message("Can't init '{workspace}', it has already a release '{commit}'")
+    error_release_already_set = error_message("Can't init '{workspace}', it has already a commit '{commit}'")
     error_release_rm_param = error_message("One of --semver <semver> or --oldest-rollback are required.")
     error_release_rollback_live_not_found = error_message("Live Release not found. Rollback can't be applied")
     error_git_provider_index = error_message(
         "Error selecting provider '{host_index}', available options are: {available_options} or 0"
     )
     error_unsupported_datafile = error_message("Unsupported Datafile type {extension}")
     error_unable_to_identify_main_workspace = error_message("We could not identify the main workspace")
     error_unsupported_diff = error_message(
         "There are resources renamed. `tb deploy` can't deploy renamed resources, create new resources instead."
     )
     error_forkdownstream_pipes_with_engine = error_message(
         "Materialized view {pipe} has the datasource definition in the same file as the SQL transformation. This is no longer supported while using Versions. Please, split the datasource definition into a separate file."
     )
     error_check_backfill_required = error_message(
-        "Not safe to deploy to live resource '{resource_name}', backfill might be required. Consider deploying to preview bumping SemVer to major or disabling 'TB_AUTO_PROMOTE'. In case you want to disable this check use 'TB_CHECK_BACKFILL_REQUIRED=0'. For more information about the deployment process, please visit https://www.tinybird.co/docs/version-control/deployment-strategies"
+        "Not safe to deploy to live resource '{resource_name}', backfill might be required. Consider deploying to preview bumping SemVer to major or disabling 'TB_AUTO_PROMOTE'. In case you want to disable this check use 'TB_CHECK_BACKFILL_REQUIRED=0'. For more information about the deployment process, please visit https://www.tinybird.co/docs/production/deployment-strategies"
     )
 
     error_connector_require_post_release = error_message(
-        "{connector} Data sources require a post-release deployment. Increment the post-release number of the semver (for example: 0.0.1 -> 0.0.1-1) to do so. You can read more about post-releases at https://www.tinybird.co/docs/version-control/deployment-strategies"
+        "{connector} Data sources require a post-release deployment. Increment the post-release number of the semver (for example: 0.0.1 -> 0.0.1-1) to do so. You can read more about post-releases at https://www.tinybird.co/docs/production/deployment-strategies"
     )
 
     info_incl_relative_path = info_message("** Relative path {path} does not exist, skipping.")
     info_ignoring_incl_file = info_message(
         "** Ignoring file {filename}. .incl files are not checked independently. They are checked as part of the file that includes them. Please check the file that includes this .incl file."
     )
 
@@ -415,15 +415,15 @@
         """\n[3] Go to IAM > Roles. Create a new IAM Role using the following custom trust policy and attach the access policy you just created in the previous step:\n\n{trust_policy}\n\n"""
     )
     prompt_init_git_release_pull = prompt_message(
         "❓ Download the Data Project to continue, otherwise you can't initialize Workspace with Git. Execute '{pull_command}'?"
     )
     prompt_init_cicd = prompt_message("\n Do you want to generate CI/CD config files?")
     prompt_init_git_release_force = prompt_message(
-        "You are going to manually update workspace release commit reference manually, this is just for special ocasions. Do you want to update current commit release reference '{current_commit}' to '{new_commit}'?"
+        "You are going to manually update workspace commit reference manually, this is just for special occasions. Do you want to update current commit reference '{current_commit}' to '{new_commit}'?"
     )
 
     warning_no_test_results = warning_message("Warning: No test results to show")
     warning_using_branch_token = warning_message("** You're using the token defined in $TB_TOKEN.")
     warning_using_branch_host = warning_message("** You're using the token defined in $TB_HOST.")
 
     error_bump_release = error_message(
@@ -458,14 +458,17 @@
     warning_beta_tester = warning_message(
         "This feature is under development and released as a beta version. You can report any feedback (bugs, feature requests, etc.) to support@tinybird.co"
     )
     warning_connector_not_installed = warning_message(
         "Auth found for {connector} connector but it's not properly installed. Please run `pip install tinybird-cli[{connector}]` to use it"
     )
     warning_deprecated = warning_message("** 🚨🚨🚨 [DEPRECATED]: {warning}")
+    warning_deprecated_releases = warning_message(
+        "** 🚨🚨🚨 [DEPRECATED]: --semver and Releases are deprecated. You can keep using `tb deploy` to deploy the changed resources from a git commit to the main Workspace and any other command without the --semver flag."
+    )
     warning_token_pipe = warning_message("** There's no read token for pipe {pipe}")
     warning_file_not_found_inside = warning_message(
         "** Warning: {name} not found inside: \n   - {folder}\n   - {folder}/datasources\n   - {folder}/endpoints"
     )
     warning_check_pipe = warning_message("** Warning: Failed removing checker pipe: {content}")
     single_warning_materialized_pipe = warning_message(
         "⚠️  {content} For more information read {docs_url} or contact us at support@tinybird.co"
@@ -513,14 +516,18 @@
     )
     warning_datasource_share = warning_message(
         "** Warning: Do you want to share the datasource {datasource} from the workspace {source_workspace} to {destination_workspace}?"
     )
     warning_datasource_unshare = warning_message(
         "** Warning: Do you want to unshare the datasource {datasource} from the workspace {source_workspace} shared with {destination_workspace}?"
     )
+    warning_datasource_sync = warning_message("** Warning: Do you want to sync the Data Source {datasource}?")
+    warning_datasource_sync_bucket = warning_message(
+        "** Warning: Do you want to ingest all the selected files (new and previous) from the {datasource} bucket? Be aware that data might be duplicated if you have previously ingested those files.\n"
+    )
     warning_users_dont_exist = warning_message(
         "** Warning: The following users do not exist in the workspace {workspace}: {users}"
     )
     warning_user_doesnt_exist = warning_message(
         "** Warning: The user {user} does not exist in the workspace {workspace}"
     )
     warning_skipping_include_file = warning_message("** Warning: Skipping {file} as is an included file")
@@ -649,15 +656,15 @@
     info_copy_datasource_created = info_message("** Copy pipe '{pipe}' created the Data Source '{datasource}'")
     info_copy_datasource_used = info_message("** Copy pipe '{pipe}' using the Data Source '{datasource}'")
     info_no_pipes_stats = info_message("** No pipe stats")
     info_starting_export_process = info_message("** \N{Chicken} starting export process from {connector}")
     info_ask_for_datasource_confirmation = info_message("** Please type the Data Source name to be replaced")
     info_datasource_doesnt_match = info_message("** The description or schema of '{datasource}' has changed.")
     info_custom_deployment = info_message(
-        "** 🚨 Warning 🚨: The changes in the branch require the `--yes` flag to the `tb deploy` command to overwrite resources. Run `tb release generate --semver <semver> to generate a custom deployment and include the `--yes` flag. Read more about custom deployments => https://www.tinybird.co/docs/version-control/deployment-strategies.html#customizing-deployments"
+        "** 🚨 Warning 🚨: The changes in the branch require the `--yes` flag to the `tb deploy` command to overwrite resources. Run `tb release generate --semver <semver> to generate a custom deployment and include the `--yes` flag. Read more about custom deployments => https://www.tinybird.co/docs/production/deployment-strategies.html#customizing-deployments"
     )
     info_ask_for_alter_confirmation = info_message("** Please confirm you want to apply the changes above y/N")
     info_available_regions = info_message("** List of available regions:")
     info_trying_authenticate = info_message("** Trying to authenticate with {host}")
     info_auth_cancelled_by_user = info_message("** Auth cancelled by user.")
     info_user_already_exists = info_message("** The user '{user}' already exists in {workspace_name}")
     info_users_already_exists = info_message("** All users already exist in {workspace_name}")
@@ -673,28 +680,28 @@
     )
     info_create_ws_msg_template = info_message(
         "Now let's pick a starter template! 🐣\nStarter template are pre-built data projects for different use cases, that you can use as a starting point and then build on top of that.\nYou can bypass this step by supplying a value for the --starter-kit option."
     )
     info_workspace_branch_create_greeting = info_message(
         "Please enter the name for your new Branch. Remember the name you choose must be unique, you can add a suffix in case of collision.\nYou can bypass this step by supplying a value for the --name option."
     )
-    info_no_git_release_yet = info_message("\n** Initializing releases based on git for Workspace '{workspace}'")
+    info_no_git_release_yet = info_message("\n** Initializing based on git for Workspace '{workspace}'")
     info_diff_resources_for_git_init = info_message(
         "** Checking diffs between remote Workspace and local. Hint: use 'tb diff' to check if your Data Project and Workspace synced"
     )
     info_cicd_file_generated = info_message("** File {file_path} generated for CI/CD")
     info_available_git_providers = info_message("** List of available providers:")
     info_git_release_init_without_diffs = info_message("** No diffs detected for '{workspace}'")
-    info_deployment_detecting_changes_header = info_message("\n** Detecting changes from last release ...")
-    info_deployment_preparing_release_header = info_message("\n** Preparing release ...")
-    info_deployment_deploying_release_dry_run_header = info_message("\n** [DRY RUN] Deploying release ...")
-    info_deployment_deploying_release_header = info_message("\n** Deploying release ...")
+    info_deployment_detecting_changes_header = info_message("\n** Detecting changes from last commit ...")
+    info_deployment_preparing_release_header = info_message("\n** Preparing commit ...")
+    info_deployment_deploying_release_dry_run_header = info_message("\n** [DRY RUN] Deploying commit ...")
+    info_deployment_deploying_release_header = info_message("\n** Deploying commit ...")
     info_deployment_deploy_deps = info_message("** Deploying downstream dependent pipes ...")
     info_git_release_diffs = info_message(
-        "** Diffs from current release '{current_release_commit}' and new '{new_release_commit}':"
+        "** Diffs from current commit '{current_release_commit}' and new '{new_release_commit}':"
     )
     info_git_release_diff = info_message("\t{change_type}:\t{datafile_changed}")
     info_git_release_no_diffs = info_message("\tno diffs detected")
     info_detected_changes_from_includes = info_message("** Changes from includes:")
     info_processing_from_include = info_message("\t{include_filename} => {filename}")
     info_deps_for_resource = info_message("\t{resource} => '{dep}'")
     info_deleting_resource = info_message("** {dry_run}Deleting '{resource_name}'")
@@ -705,15 +712,15 @@
     info_skipping_sharing_datasources_branch = info_message(
         "** Skipping sharing the datasoure {datasource} in a Branch"
     )
     info_skipping_shared_with_entry = info_message(
         "** Skipping `SHARED_WITH` entry as the flag --user_token was not used"
     )
     info_generate_cicd_config = info_message(
-        "** {provider} CI/CD config files generated. Read this guide to learn how to run CI/CD pipelines: https://www.tinybird.co/docs/version-control/continuous-integration.html"
+        "** {provider} CI/CD config files generated. Read this guide to learn how to run CI/CD pipelines: https://www.tinybird.co/docs/production/continuous-integration.html"
     )
     info_release_no_rollback = info_message("** No action")
     info_no_release_deleted = info_message(" ** No Release deleted")
     info_release_rm_resources_dry_run = info_message(
         "** Release {semver} delete (dry run). The following resources IDs are only present in this Release and will be deleted:"
     )
     info_release_rm_resources = info_message(
@@ -846,14 +853,17 @@
     success_connection_created = success_message("** Connection {id} created successfully!")
 
     # TODO: Update the message when the .env feature is implemented
     # xxxx.connection created successfully! Connection details saved into the .env file and referenced automatically in your connection file.
     success_connection_file_created = success_message(
         "** {name} created successfully! Connection details saved in your connection file."
     )
+    success_s3_iam_connection_created = success_message(
+        "** Info associated with this connection:\n** External ID: {external_id}\n** Role ARN: {role_arn}"
+    )
 
     success_delete_connection = success_message("** Connection {connection_id} removed successfully")
     success_connection_using = success_message("** Using connection '{connection_name}'")
     success_using_host = success_message("** Using host: {host} ({name})")
     success_workspace_created = success_message("** Workspace '{workspace_name}' has been created")
     success_workspace_branch_created = success_message(
         "** Branch '{branch_name}' from '{workspace_name}' has been created"
@@ -875,18 +885,18 @@
     success_workspace_user_removed = success_message("** User {user} removed from workspace '{workspace_name}'")
     success_workspace_users_removed = success_message("** Users removed from workspace '{workspace_name}'")
     success_workspace_user_changed_role = success_message("** {user}'s role setted to {role} in '{workspace_name}'")
     success_workspace_users_changed_role = success_message("** Users' role setted to {role} in '{workspace_name}'")
 
     success_test_added = success_message("** Test added successfully")
     success_remember_api_host = success_message("** Remember to use {api_host} in all your API calls.")
-    success_git_release = success_message("** New release deployed: '{release_commit}'")
-    success_dry_git_release = success_message("** [DRY RUN] New release deployed: '{release_commit}'")
+    success_git_release = success_message("** New commit deployed: '{release_commit}'")
+    success_dry_git_release = success_message("** [DRY RUN] New commit deployed: '{release_commit}'")
     success_init_git_release = success_message(
-        "** Workspace '{workspace_name}' release initialized to commit '{release_commit}'.\n Now start working with git, pushing changes to pull requests and let the CI/CD work for you. More details in this guide: https://www.tinybird.co/docs/version-control/working-with-version-control.html."
+        "** Workspace '{workspace_name}' initialized to commit '{release_commit}'.\n Now start working with git, pushing changes to pull requests and let the CI/CD work for you. More details in this guide: https://www.tinybird.co/docs/production/working-with-version-control.html."
     )
     success_release_update = success_message("** Live Release {semver} updated to {new_semver}")
     success_dry_release_update = success_message("** [DRY RUN] Live Release {semver} updated to {new_semver}")
     success_release_promote = success_message("** Release {semver} promoted to live")
     success_dry_release_promote = success_message("** [DRY RUN] Release {semver} promoted to live")
     success_release_preview = success_message("** Release {semver} in preview status")
     success_dry_release_preview = success_message("** [DRY RUN] Release {semver} in preview status")
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/git_settings.py` & `tinybird-cli-4.0.1.dev0/tinybird/git_settings.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/sql.py` & `tinybird-cli-4.0.1.dev0/tinybird/sql.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/sql_template.py` & `tinybird-cli-4.0.1.dev0/tinybird/sql_template.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,19 +3,21 @@
 import linecache
 import logging
 import re
 from datetime import datetime
 from functools import lru_cache
 from io import StringIO
 from json import loads
-from typing import Optional, Tuple, Union
+from typing import Any, List, Optional, Tuple, Union
 
 from tornado import escape
 from tornado.util import ObjectDict, exec_in, unicode_type
 
+from tinybird.context import ff_preprocess_parameters_circuit_breaker, ff_split_to_array_escape
+
 from .datatypes import testers
 from .tornado_template import VALID_CUSTOM_FUNCTION_NAMES, SecurityException, Template
 
 
 class SQLTemplateCustomError(Exception):
     def __init__(self, err, code=400):
         self.code = code
@@ -1249,25 +1251,39 @@
         "\\": "\\\\",
         "%": "\\%",
         "`": "\\`",
     }
 )
 
 
-def expression_wrapper(x, name):
+def escape_single_quote_str(s):
+    return "'" + s.replace("'", "''") + "'"
+
+
+def expression_wrapper(x, name, escape_arrays: bool = False):
     if type(x) in (unicode_type, bytes, str):
         return "'" + sqlescape_for_string_expression(x) + "'"
     elif isinstance(x, Placeholder):
         return "'__placeholder__'"
     elif isinstance(x, Comment):
         return "-- {x} \n"
     if x is None:
         raise SQLTemplateException(
             f'expression "{name}" evaluated to null', documentation="/cli/advanced-templates.html"
         )
+    if isinstance(x, list) and escape_arrays:
+        logging.warning(f"expression_wrapper -> list :{x}:")
+
+        try:
+            result = (
+                f"[{','.join(escape_single_quote_str(item) if isinstance(item, str) else str(item) for item in x)}]"
+            )
+            return result
+        except Exception as e:
+            logging.error(f"Error escaping array: {e}")
     return x
 
 
 _namespace = {
     "column": column,
     "symbol": symbol,
     "error": error,
@@ -1669,25 +1685,33 @@
 
 
 @lru_cache(maxsize=256)
 def get_var_names_and_types_cached(t: Template):
     return get_var_names_and_types(t)
 
 
-def wrap_vars(t):
+def wrap_vars(t, escape_arrays: bool = False):
     def _n(chunks, v):
         for x in chunks:
             if type(x).__name__ == "_ChunkList":
                 _n(x.chunks, v)
             elif type(x).__name__ == "_Expression":
-                x.expression = "expression_wrapper(" + x.expression + ',"""' + x.expression.replace('"', '\\"') + '""")'
+                x.expression = (
+                    "expression_wrapper("
+                    + x.expression
+                    + ',"""'
+                    + x.expression.replace('"', '\\"')
+                    + '""",escape_arrays='
+                    + str(escape_arrays)
+                    + ")"
+                )
             elif type(x).__name__ == "_ControlBlock":
                 _n(x.body.chunks, v)
 
-    var = []
+    var: List[Any] = []
     _n(t.file.body.chunks, var)
     t.code = t._generate_python(t.loader)
     try:
         t.compiled = compile(
             escape.to_unicode(t.code), "%s.generated.py" % t.name.replace(".", "_"), "exec", dont_inherit=True
         )
     except Exception:
@@ -1737,15 +1761,15 @@
         _n(t.file.body.chunks, tables)
         return tables
     except SecurityException as e:
         raise SQLTemplateException(e)
 
 
 @lru_cache(maxsize=2**13)
-def get_template_and_variables(sql: str, name: Optional[str]):
+def get_template_and_variables(sql: str, name: Optional[str], escape_arrays: bool = False):
     """
     Generates a Template and does all the processes necessary. As the object and template variables are cached
     it is important to NOT MODIFY THESE OBJECTS.
     Neither render_sql_template() or generate() modify them, so neither should you
     """
     try:
         t = Template(sql, name)
@@ -1753,15 +1777,15 @@
 
         for variable in template_variables:
             if variable["name"] in DEFAULT_PARAM_NAMES:
                 name = variable["name"]
                 line = variable["line"]
                 raise ValueError(f'"{name}" can not be used as a variable name, line {line}')
 
-        wrap_vars(t)
+        wrap_vars(t, escape_arrays=escape_arrays)
 
         return t, template_variables
     except SecurityException as e:
         raise SQLTemplateException(e)
 
 
 def preprocess_variables(variables: dict, t: Template):
@@ -1808,15 +1832,14 @@
 
 
 def render_sql_template(
     sql: str,
     variables: Optional[dict] = None,
     test_mode: bool = False,
     name: Optional[str] = None,
-    preprocess_variables_flag: bool = False,
 ) -> Tuple[str, dict]:
     """
     >>> render_sql_template("select * from table where f = {{Float32(foo)}}", { 'foo': -1 })
     ("select * from table where f = toFloat32('-1.0')", {})
     >>> render_sql_template("{% if defined(open) %}ERROR{% else %}YEAH!{% end %}")
     ('YEAH!', {})
     >>> render_sql_template("{% if defined(close) %}ERROR{% else %}YEAH!{% end %}")
@@ -1995,37 +2018,33 @@
     Traceback (most recent call last):
     ...
     tinybird.sql_template.SQLTemplateException: Template Syntax Error: Error parsing JSON: '__placeholder__' - Expecting value: line 1 column 1 (char 0)
     >>> render_sql_template("% {% for kv in JSON(payload, '') %} department = {{kv['dp']}} {% end %}")
     Traceback (most recent call last):
     ...
     tinybird.sql_template.SQLTemplateException: Template Syntax Error: Error parsing JSON: '' - Expecting value: line 1 column 1 (char 0)
-    >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": "1,2"}, preprocess_variables_flag=True)
+    >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": "1,2"})
     ("%  SELECT test as aa, ['1','2'] as test, '1,2' as a ", {})
-    >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": ["1","2"]}, preprocess_variables_flag=True)
+    >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": ["1","2"]})
     ("%  SELECT test as aa, ['1','2'] as test, '1,2' as a ", {})
-    >>> render_sql_template("% {% if defined(test) %}{% set _total = sum(test) %} SELECT test as aa, {{Array(test, 'Int32')}} as test, {{_total}} as a {% end %}", {"test": "1,2"}, preprocess_variables_flag=True)
+    >>> render_sql_template("% {% if defined(test) %}{% set _total = sum(test) %} SELECT test as aa, {{Array(test, 'Int32')}} as test, {{_total}} as a {% end %}", {"test": "1,2"})
     ('%  SELECT test as aa, [1,2] as test, 3 as a ', {})
-    >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": "1,2"})
-    ("%  SELECT test as aa, ['1','2'] as test, '1,,,2' as a ", {})
     >>> render_sql_template("% {% if defined(test) %}{% set _groupByCSV = ','.join(test) %} SELECT test as aa, {{Array(test, 'String')}} as test, {{_groupByCSV}} as a {% end %}", {"test": ["1","2"]})
     ("%  SELECT test as aa, ['1','2'] as test, '1,2' as a ", {})
-    >>> render_sql_template("% {% if defined(test) %}{% set _total = sum(test) %} SELECT test as aa, {{Array(test, 'Int32')}} as test, {{_total}} as a {% end %}", {"test": "1,2"})
-    Traceback (most recent call last):
-    ...
-    ValueError: unsupported operand type(s) for +: 'int' and 'str'
-    >>> render_sql_template("% SELECT {% if defined(x) %} x, 1", preprocess_variables_flag=True)
+    >>> render_sql_template("% SELECT {% if defined(x) %} x, 1")
     Traceback (most recent call last):
     ...
     tinybird.tornado_template.UnClosedIfError: Missing {% end %} block for if at line 1
     """
+    escape_split_to_array = ff_split_to_array_escape.get(False)
+    bypass_preprocess_variables = ff_preprocess_parameters_circuit_breaker.get(False)
 
-    t, template_variables = get_template_and_variables(sql, name)
+    t, template_variables = get_template_and_variables(sql, name, escape_arrays=escape_split_to_array)
 
-    if preprocess_variables_flag and variables is not None:
+    if not bypass_preprocess_variables and variables is not None:
         processed_variables = preprocess_variables(variables, t)
         variables.update(processed_variables)
 
     if test_mode:
 
         def dummy(*args, **kwargs):
             return Comment("error launched")
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/sql_template_fmt.py` & `tinybird-cli-4.0.1.dev0/tinybird/sql_template_fmt.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/sql_toolset.py` & `tinybird-cli-4.0.1.dev0/tinybird/sql_toolset.py`

 * *Files 1% similar despite different names*

```diff
@@ -160,15 +160,14 @@
     replacements: dict,
     default_database: str = "",
     check_functions: bool = False,
     only_replacements: bool = False,
     valid_tables: Optional[Set[Tuple[str, str]]] = None,
     output_one_line: bool = False,
     timestamp: Optional[datetime] = None,
-    preprocess_variables_flag: bool = False,
 ) -> str:
     """
     Given a query and a list of table replacements, returns the query after applying the table replacements.
     It takes into account dependencies between replacement subqueries (if any)
     It also validates the sql to verify it's valid and doesn't use unknown or prohibited functions
     """
     if not replacements:
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/syncasync.py` & `tinybird-cli-4.0.1.dev0/tinybird/syncasync.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/auth.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/auth.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/branch.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/branch.py`

 * *Files 0% similar despite different names*

```diff
@@ -43,15 +43,15 @@
     """Release commands"""
 
 
 @release.command(name="ls", short_help="Lists Releases for the current Workspace")
 @coro
 async def release_ls() -> None:
     """List current available Releases in the Workspace"""
-
+    click.echo(FeedbackManager.warning_deprecated_releases())
     config = CLIConfig.get_project_config()
     _ = await try_update_config_with_remote(config, only_if_needed=True)
 
     await print_releases(config)
 
 
 async def print_releases(config: CLIConfig):
@@ -74,14 +74,15 @@
     is_flag=False,
     required=True,
     type=str,
     help="Semver of the new Release. Example: 1.0.0",
 )
 @coro
 async def release_generate(semver: str) -> None:
+    click.echo(FeedbackManager.warning_deprecated_releases())
     if os.path.exists(".tinyenv"):
         with open(".tinyenv", "r") as env_file:
             lines = env_file.readlines()
 
         updated_lines = []
         for line in lines:
             if line.startswith("VERSION="):
@@ -133,14 +134,15 @@
     is_flag=False,
     required=True,
     type=str,
     help="Semver of the new Release. Example: 1.0.0",
 )
 @coro
 async def release_create(semver: str) -> None:
+    click.echo(FeedbackManager.warning_deprecated_releases())
     config = CLIConfig.get_project_config()
     _ = await try_update_config_with_remote(config, only_if_needed=True)
 
     client = config.get_client()
     folder = getcwd()
     await create_release(client, config, semver, folder)
 
@@ -150,14 +152,15 @@
     "--semver", required=True, type=str, help="Semver of a preview Release to promote to live. Example: 1.0.0"
 )
 @coro
 async def release_promote(semver: str) -> None:
     """
     The oldest rollback Release will be automatically removed if no usage, otherwise export TB_FORCE_REMOVE_OLDEST_ROLLBACK="1" to force deletion
     """
+    click.echo(FeedbackManager.warning_deprecated_releases())
     config = CLIConfig.get_project_config()
     _ = await try_update_config_with_remote(config, only_if_needed=True)
 
     client = config.get_client()
 
     try:
         force_remove = getenv_bool("TB_FORCE_REMOVE_OLDEST_ROLLBACK", False)
@@ -175,14 +178,15 @@
 
 @release.command(name="preview", short_help="Updates the status of a deploying Release to preview")
 @click.option(
     "--semver", is_flag=False, required=True, type=str, help="Semver of a preview Release to preview. Example: 1.0.0"
 )
 @coro
 async def release_preview(semver: str) -> None:
+    click.echo(FeedbackManager.warning_deprecated_releases())
     config = CLIConfig.get_project_config()
     _ = await try_update_config_with_remote(config, only_if_needed=True)
 
     client = config.get_client()
 
     try:
         await client.release_preview(config["id"], semver)
@@ -191,14 +195,15 @@
         raise CLIReleaseException(FeedbackManager.error_exception(error=str(e)))
 
 
 @release.command(name="rollback", short_help="Rollbacks to a previous Release")
 @click.option("--yes", is_flag=True, default=False, help="Do not ask for confirmation")
 @coro
 async def release_rollback(yes: bool) -> None:
+    click.echo(FeedbackManager.warning_deprecated_releases())
     config = CLIConfig.get_project_config()
     _ = await try_update_config_with_remote(config, only_if_needed=False)
 
     client = config.get_client()
 
     releases_response = await config.get_client().releases(config["id"])
 
@@ -234,14 +239,15 @@
 )
 @click.option("--yes", is_flag=True, default=False, help="Do not ask for confirmation")
 @click.option(
     "--dry-run", is_flag=True, default=False, help="Checks the Release could be deleted without actually deleting it"
 )
 @coro
 async def release_rm(semver: str, oldest_rollback: bool, force: bool, yes: bool, dry_run: bool) -> None:
+    click.echo(FeedbackManager.warning_deprecated_releases())
     if (not semver and not oldest_rollback) or (semver and oldest_rollback):
         raise CLIException(FeedbackManager.error_release_rm_param())
 
     config = CLIConfig.get_project_config()
     client = config.get_client()
     _ = await try_update_config_with_remote(config)
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/cicd.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/cicd.py`

 * *Files 1% similar despite different names*

```diff
@@ -205,23 +205,18 @@
 
 
 EXEC_TEST_SH = """
 #!/usr/bin/env bash
 set -euxo pipefail
 
 export TB_VERSION_WARNING=0
-export VERSION=$1
 
 run_test() {
     t=$1
     echo "** Running $t **"
-    # Check if VERSION is provided
-    if [[ -n $VERSION ]]; then
-        sed -i "s/tb/tb --semver $VERSION/" $t
-    fi
     echo "** $(cat $t)"
     tmpfile=$(mktemp)
     retries=0
     TOTAL_RETRIES=3
 
     # When appending fixtures, we need to retry in case of the data is not replicated in time
     while [ $retries -lt $TOTAL_RETRIES ]; do
@@ -258,40 +253,38 @@
         return 1
     fi
     echo ""
 }
 export -f run_test
 
 fail=0
-find ./tests -name "*.test" -print0 | xargs -0 -I {} -P 4 bash -c 'run_test "$@"' _ {} $VERSION || fail=1
+find ./tests -name "*.test" -print0 | xargs -0 -I {} -P 4 bash -c 'run_test "$@"' _ {} || fail=1
 
 if [ $fail == 1 ]; then
   exit -1;
 fi
 """
 
 APPEND_FIXTURES_SH = """
 #!/usr/bin/env bash
 set -euxo pipefail
 
-VERSION=$1
-
 directory="datasources/fixtures"
 extensions=("csv" "ndjson")
 
 absolute_directory=$(realpath "$directory")
 
 for extension in "${extensions[@]}"; do
   file_list=$(find "$absolute_directory" -type f -name "*.$extension")
 
   for file_path in $file_list; do
     file_name=$(basename "$file_path")
     file_name_without_extension="${file_name%.*}"
 
-    command="tb --semver $VERSION datasource append $file_name_without_extension datasources/fixtures/$file_name"
+    command="tb datasource append $file_name_without_extension datasources/fixtures/$file_name"
     echo $command
     $command
   done
 done
 """
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/cli.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -86,15 +86,15 @@
 @click.option(
     "--debug/--no-debug",
     default=False,
     help="Prints internal representation, can be combined with any command to get more information.",
 )
 @click.option("--token", help="Use auth token, defaults to TB_TOKEN envvar, then to the .tinyb file")
 @click.option("--host", help="Use custom host, defaults to TB_HOST envvar, then to https://api.tinybird.co")
-@click.option("--semver", help="Semver of a Release to run the command. Example: 1.0.0")
+@click.option("--semver", help="Semver of a Release to run the command. Example: 1.0.0", hidden=True)
 @click.option("--gcp-project-id", help="The Google Cloud project ID", hidden=True)
 @click.option(
     "--gcs-bucket", help="The Google Cloud Storage bucket to write temp files when using the connectors", hidden=True
 )
 @click.option(
     "--google-application-credentials",
     envvar="GOOGLE_APPLICATION_CREDENTIALS",
@@ -292,18 +292,15 @@
 )
 @click.option(
     "--override-commit",
     default=None,
     help="Use this option to manually override the reference commit of your workspace. This is useful if a commit is not recognized in your git log, such as after a force push (git push -f).",
 )
 @click.option(
-    "--cicd",
-    is_flag=True,
-    default=False,
-    help="Generates only CI/CD files for your git provider",
+    "--cicd", is_flag=True, default=False, help="Generates only CI/CD files for your git provider", hidden=True
 )
 @click.pass_context
 @coro
 async def init(
     ctx: Context,
     generate_datasources: bool,
     folder: Optional[str],
@@ -433,15 +430,15 @@
         if not force and cicd_provider:
             if cicd:
                 final_response = FeedbackManager.error_cicd_already_exists(provider=cicd_provider.name)
                 error = True
             else:
                 click.echo(FeedbackManager.info_cicd_already_exists(provider=cicd_provider.name))
         else:
-            if cicd or click.confirm(FeedbackManager.prompt_init_cicd(), default=True):
+            if cicd:
                 data_project_dir = os.path.relpath(folder, cli_git_release.working_dir())
                 await init_cicd(
                     client, current_ws, config, path=cli_git_release.working_dir(), data_project_dir=data_project_dir
                 )
 
     if final_response:
         if error:
@@ -563,15 +560,14 @@
 )
 @click.option(
     "--no-versions",
     is_flag=True,
     default=False,
     help="when set, resource dependency versions are not used, it pushes the dependencies as-is",
 )
-@click.option("--timeout", type=float, default=None, help="timeout you want to use for the job populate")
 @click.option(
     "-l", "--limit", type=click.IntRange(0, 100), default=0, required=False, help="Number of requests to validate"
 )
 @click.option(
     "--sample-by-params",
     type=click.IntRange(1, 100),
     default=1,
@@ -630,15 +626,14 @@
     fixtures: bool,
     wait: bool,
     yes: bool,
     only_response_times: bool,
     workspace_map,
     workspace,
     no_versions: bool,
-    timeout: Optional[float],
     limit: int,
     sample_by_params: int,
     failfast: bool,
     ignore_order: bool,
     validate_processed_bytes: bool,
     check_requests_from_main: bool,
     folder: str,
@@ -669,15 +664,14 @@
         wait=wait,
         ignore_sql_errors=ignore_sql_errors,
         skip_confirmation=yes,
         only_response_times=only_response_times,
         workspace_map=dict(workspace_map),
         workspace_lib_paths=workspace,
         no_versions=no_versions,
-        timeout=timeout,
         run_tests=False,
         tests_to_run=limit,
         tests_sample_by_params=sample_by_params,
         tests_failfast=failfast,
         tests_ignore_order=ignore_order,
         tests_validate_processed_bytes=validate_processed_bytes,
         tests_check_requests_from_branch=check_requests_from_main,
@@ -1064,21 +1058,18 @@
     verbose: bool,
     force_populate: Optional[str],
     unlink_on_populate_error: bool,
     override_pipe: bool,
     override_datasource: bool,
     target_datasource: Optional[str] = None,
 ) -> None:
-    """[BETA] Given a local Pipe datafile path (FILENAME) and optionally a Materialized View name (TARGET_DATASOURCE), choose one of its nodes to materialize.
-
-    This command guides you to generate the Materialized View with name TARGET_DATASOURCE, the only requirement is having a valid Pipe datafile locally. Use `tb pull` to download resources from your workspace when needed.
-
-    Syntax: tb materialize path/to/pipe.pipe
-    """
-
+    deprecation_notice = FeedbackManager.warning_deprecated(
+        warning="'tb materialize' is deprecated. To create a Materialized View in a guided way you can use the UI: `Create Pipe` and use the `Create Materialized View` wizard. Finally download the resulting `.pipe` and `.datasource` files."
+    )
+    click.echo(deprecation_notice)
     cl = create_tb_client(ctx)
 
     async def _try_push_pipe_to_analyze(pipe_name):
         try:
             to_run = await folder_push(
                 cl,
                 filenames=[filename],
@@ -1398,15 +1389,14 @@
 @click.option(
     "--workspace",
     nargs=2,
     type=str,
     multiple=True,
     help="add a workspace path to the list of external workspaces, usage: --workspace name path/to/folder",
 )
-@click.option("--timeout", type=float, default=None, help="timeout you want to use for the job populate")
 @click.option(
     "--folder",
     default=".",
     help="Folder from where to execute the command. By default the current folder",
     hidden=True,
     type=click.types.STRING,
 )
@@ -1450,36 +1440,23 @@
     subset: Optional[float],
     sql_condition: Optional[str],
     unlink_on_populate_error: bool,
     wait: bool,
     yes: bool,
     workspace_map,
     workspace,
-    timeout: Optional[float],
     folder: str,
     user_token: Optional[str],
     fork_downstream: bool,
     fork: bool,
     use_main: bool,
 ) -> None:
-    """Deploy in Tinybird pushing resources changed from previous Release using git.
-
-    Usage: tb --semver <semver> deploy
-
-    Semantic versioning logic is as follows:
-
-    --semver <semver> format is major.minor.patch-post where major, minor, patch and post are integer numbers
+    """Deploy in Tinybird pushing resources changed from last git commit deployed.
 
-      - bump post to deploy to the current live Release, rollback to previous post version is not available
-
-      - bump patch or minor to deploy a new Release and auto-promote it to live. Add TB_AUTO_PROMOTE=0 to create the Release in preview status
-
-      - bump major to deploy a new Release in preview status
-
-    When auto-promote the oldest rollback Release will be automatically removed if no usage, otherwise export TB_FORCE_REMOVE_OLDEST_ROLLBACK="1" to force deletion
+    Usage: tb deploy
     """
     try:
         ignore_sql_errors = FeatureFlags.ignore_sql_errors()
         context.disable_template_security_validation.set(True)
 
         is_internal = has_internal_datafiles(folder)
 
@@ -1500,59 +1477,78 @@
         if not current_semver:
             click.echo(FeedbackManager.error_init_release(workspace=current_ws.get("name")))
             sys.exit(1)
 
         release_created = False
         new_release = False
         check_backfill_required = False
+
+        # semver is now optional, if not sent force the bump
+        if not semver:
+            semver = current_semver
+        else:
+            click.echo(FeedbackManager.warning_deprecated_releases())
+
         if semver and current_semver:
             new_version = version.parse(semver.split("-snapshot")[0])
             current_version = version.parse(current_semver.split("-snapshot")[0])
-            if dry_run:
-                click.echo(
-                    FeedbackManager.info_dry_releases_detected(current_semver=current_version, semver=new_version)
-                )
-            else:
-                click.echo(FeedbackManager.info_releases_detected(current_semver=current_version, semver=new_version))
-            if new_version <= current_version:
-                click.echo(FeedbackManager.error_bump_release(command="deploy [OPTIONS]"))
-                sys.exit(1)
-
-            if is_post_semver(new_version, current_version):
+            show_feedback = new_version != current_version
+            if show_feedback:
                 if dry_run:
-                    click.echo(FeedbackManager.info_dry_local_release(version=new_version))
+                    click.echo(
+                        FeedbackManager.info_dry_releases_detected(current_semver=current_version, semver=new_version)
+                    )
+                else:
+                    click.echo(
+                        FeedbackManager.info_releases_detected(current_semver=current_version, semver=new_version)
+                    )
+
+            if new_version == current_version:
+                if current_version.post is None:
+                    semver = str(current_version) + "-1"
+                    new_version = version.Version(semver)
                 else:
-                    click.echo(FeedbackManager.info_local_release(version=new_version))
+                    semver = f"{current_version.major}.{current_version.minor}.{current_version.micro}-{current_version.post + 1}"
+                    new_version = version.Version(semver)
+
+            if is_post_semver(new_version, current_version):
+                if show_feedback:
+                    if dry_run:
+                        click.echo(FeedbackManager.info_dry_local_release(version=new_version))
+                    else:
+                        click.echo(FeedbackManager.info_local_release(version=new_version))
                 yes = True
                 auto_promote = False
                 new_release = False
             elif is_major_semver(new_version, current_version):
-                if dry_run:
-                    click.echo(FeedbackManager.info_dry_major_release(version=new_version))
-                else:
-                    click.echo(FeedbackManager.info_major_release(version=new_version))
+                if show_feedback:
+                    if dry_run:
+                        click.echo(FeedbackManager.info_dry_major_release(version=new_version))
+                    else:
+                        click.echo(FeedbackManager.info_major_release(version=new_version))
                 auto_promote = False
                 new_release = True
             else:
                 # allows TB_AUTO_PROMOTE=0 so release is left in preview
                 auto_promote = getenv_bool("TB_AUTO_PROMOTE", True)
                 if auto_promote:
-                    if dry_run:
-                        click.echo(FeedbackManager.info_dry_minor_patch_release_with_autopromote(version=new_version))
-                    else:
-                        click.echo(FeedbackManager.info_minor_patch_release_with_autopromote(version=new_version))
+                    if show_feedback:
+                        if dry_run:
+                            click.echo(
+                                FeedbackManager.info_dry_minor_patch_release_with_autopromote(version=new_version)
+                            )
+                        else:
+                            click.echo(FeedbackManager.info_minor_patch_release_with_autopromote(version=new_version))
                 else:
-                    if dry_run:
-                        click.echo(FeedbackManager.info_dry_minor_patch_release_no_autopromote(version=new_version))
-                    else:
-                        click.echo(FeedbackManager.info_minor_patch_release_no_autopromote(version=new_version))
+                    if show_feedback:
+                        if dry_run:
+                            click.echo(FeedbackManager.info_dry_minor_patch_release_no_autopromote(version=new_version))
+                        else:
+                            click.echo(FeedbackManager.info_minor_patch_release_no_autopromote(version=new_version))
                 new_release = True
-        else:
-            click.echo(FeedbackManager.error_bump_release(command="deploy [OPTIONS]"))
-            sys.exit(1)
 
         if new_release:
             if not dry_run:
                 try:
                     await create_release(client, config, semver)
                 except OperationCanNotBePerformed as e:
                     raise CLIException(FeedbackManager.error_exception(error=str(e)))
@@ -1580,15 +1576,14 @@
                 unlink_on_populate_error=unlink_on_populate_error,
                 upload_fixtures=False,
                 wait=wait,
                 ignore_sql_errors=ignore_sql_errors,
                 skip_confirmation=yes,
                 workspace_map=dict(workspace_map),
                 workspace_lib_paths=workspace,
-                timeout=timeout,
                 run_tests=False,
                 folder=folder,
                 config=ctx.ensure_object(dict)["config"],
                 user_token=user_token,
                 fork_downstream=fork_downstream,
                 fork=fork,
                 is_internal=is_internal,
@@ -1632,14 +1627,16 @@
                     except Exception as e:
                         raise CLIException(FeedbackManager.error_exception(error=str(e)))
             except Exception as e:
                 raise CLIException(FeedbackManager.error_exception(error=str(e)))
 
         if not new_release:
             if dry_run:
-                click.echo(FeedbackManager.success_dry_release_update(semver=current_semver, new_semver=semver))
+                if show_feedback:
+                    click.echo(FeedbackManager.success_dry_release_update(semver=current_semver, new_semver=semver))
             else:
                 client.semver = None
                 await client.update_release_semver(config["id"], current_semver, semver)
-                click.echo(FeedbackManager.success_release_update(semver=current_semver, new_semver=semver))
+                if show_feedback:
+                    click.echo(FeedbackManager.success_release_update(semver=current_semver, new_semver=semver))
     except Exception as e:
         raise CLIException(str(e))
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/common.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/common.py`

 * *Files 1% similar despite different names*

```diff
@@ -229,22 +229,14 @@
 class AliasedGroup(click.Group):
     def get_command(self, ctx, cmd_name):
         # Step one: built-in commands as normal
         cm = click.Group.get_command(self, ctx, cmd_name)
         if cm is not None:
             return cm
 
-        if cmd_name == "env":
-            deprecation_notice = FeedbackManager.warning_deprecated(
-                warning="'tb env' is deprecated, use 'tb branch' instead. 'tb env' will be removed in the next 3.0.0 release, please update your scripts."
-            )
-            click.echo(deprecation_notice)
-
-            return click.Group.get_command(self, ctx, "branch")
-
     def resolve_command(self, ctx, args):
         # always return the command's name, not the alias
         _, cmd, args = super().resolve_command(ctx, args)
         return cmd.name, cmd, args
 
 
 class CatchAuthExceptions(AliasedGroup):
@@ -427,15 +419,15 @@
             base = Path()
         f = base / ("example.yml")
         if not base.exists() or force:
             with open(f"{f}", "w") as t_file:
                 t_file.write(
                     """
 ##############################################################################################################################
-###   Visit https://www.tinybird.co/docs/version-control/implementing-test-strategies.html#data-quality-tests              ###
+###   Visit https://www.tinybird.co/docs/production/implementing-test-strategies.html#data-quality-tests              ###
 ###   for more details on Data Quality tests                                                                               ###
 ##############################################################################################################################
 
 - example_no_negative_numbers:
     max_bytes_read: null
     max_time: null
     sql: |
@@ -463,15 +455,15 @@
 
         f = base / ("regression.yaml")
         if not base.exists() or force:
             with open(f"{f}", "w") as t_file:
                 t_file.write(
                     """
 ############################################################################################################################
-###   Visit https://www.tinybird.co/docs/version-control/implementing-test-strategies.html#regression-tests              ###
+###   Visit https://www.tinybird.co/docs/production/implementing-test-strategies.html#regression-tests              ###
 ###   for more details on Regression tests                                                                               ###
 ############################################################################################################################
 
 ###
 ### New pipes are covered by this rule, rules below this one supersede this setting
 ###
 - pipe: '.*'
@@ -1167,15 +1159,15 @@
     if failed:
         for step in response["progress"]:
             if not step["run"]["was_successfull"]:
                 for failure in step["run"]["failed"]:
                     click.echo(f"❌ FAILED {failure['name']}\n")
     if failed:
         raise CLIException(
-            "Check Failures Detail above for more information. If the results are expected, skip asserts or increase thresholds, see 💡 Hints above (note skip asserts flags are applied to all regression tests, so use them when it makes sense).\n\nIf you are using the CI template for GitHub or GitLab you can add skip asserts flags as labels to the MR and they are automatically applied. Find available flags to skip asserts and thresholds here => https://www.tinybird.co/docs/version-control/implementing-test-strategies.html#fixture-tests"
+            "Check Failures Detail above for more information. If the results are expected, skip asserts or increase thresholds, see 💡 Hints above (note skip asserts flags are applied to all regression tests, so use them when it makes sense).\n\nIf you are using the CI template for GitHub or GitLab you can add skip asserts flags as labels to the MR and they are automatically applied. Find available flags to skip asserts and thresholds here => https://www.tinybird.co/docs/production/implementing-test-strategies.html#fixture-tests"
         )
 
 
 class PlanName(Enum):
     DEV = "Build"
     PRO = "Pro"
     ENTERPRISE = "Enterprise"
@@ -1369,15 +1361,15 @@
     except OperationCanNotBePerformed as e:
         raise CLIException(FeedbackManager.error_operation_can_not_be_performed(error=e))
     except Exception as e:
         raise CLIException(FeedbackManager.error_exception(error=e))
     else:
         click.echo(FeedbackManager.success_progress_blocks())
         if mode == "append":
-            if parser != "clickhouse":
+            if parser and parser != "clickhouse":
                 click.echo(FeedbackManager.success_appended_rows(appended_rows=appended_rows))
 
         click.echo(FeedbackManager.success_total_rows(datasource=datasource_name, total_rows=total_rows))
 
         if mode == "replace":
             click.echo(FeedbackManager.success_replaced_datasource(datasource=datasource_name))
         else:
@@ -1387,21 +1379,32 @@
         try:
             for url in urls:
                 _connector.clean(urlparse(url).path.split("/")[-1])
         except Exception:
             pass
 
 
-async def sync_data(ctx, datasource_name: str):
+async def sync_data(ctx, datasource_name: str, yes: bool):
     client: TinyB = ctx.obj["client"]
     datasource = await client.get_datasource(datasource_name)
+
     VALID_DATASOURCES = ["bigquery", "snowflake", "s3", "gcs"]
     if datasource["type"] not in VALID_DATASOURCES:
         raise CLIException(FeedbackManager.error_sync_not_supported(valid_datasources=VALID_DATASOURCES))
-    await client.datasource_sync(datasource["id"])
+
+    warning_message = (
+        FeedbackManager.warning_datasource_sync_bucket(datasource=datasource_name)
+        if datasource["type"] in ["s3", "gcs"]
+        else FeedbackManager.warning_datasource_sync(
+            datasource=datasource_name,
+        )
+    )
+    if yes or click.confirm(warning_message):
+        await client.datasource_sync(datasource["id"])
+        click.echo(FeedbackManager.success_sync_datasource(datasource=datasource_name))
 
 
 # eval "$(_TB_COMPLETE=source_bash tb)"
 def autocomplete_topics(ctx: Context, args, incomplete):
     try:
         config = async_to_sync(get_config)(None, None)
         ctx.ensure_object(dict)["config"] = config
@@ -1887,15 +1890,14 @@
 
 
 async def wait_job(
     tb_client: TinyB,
     job_id: str,
     job_url: str,
     label: str,
-    timeout: Optional[int] = None,
     wait_observer: Optional[Callable[[Dict[str, Any], ProgressBar], None]] = None,
 ) -> Dict[str, Any]:
     progress_bar: ProgressBar
     with click.progressbar(
         label=f"{label} ",
         length=100,
         show_eta=False,
@@ -1911,34 +1913,33 @@
             if "progress_percentage" in res:
                 progress_bar.update(int(round(res["progress_percentage"])) - progress_bar.pos)
             elif res["status"] != "working":
                 progress_bar.update(progress_bar.length if progress_bar.length else 0)
 
         try:
             # TODO: Simplify this as it's not needed to use two functions for
-            result = await wait_job_no_ui(tb_client, job_id, timeout, progressbar_cb)
+            result = await wait_job_no_ui(tb_client, job_id, progressbar_cb)
             if result["status"] != "done":
                 raise CLIException(FeedbackManager.error_while_running_job(error=result["error"]))
             return result
         except asyncio.TimeoutError:
             raise CLIException(FeedbackManager.error_while_running_job(error="Reach timeout, job cancelled"))
         except JobException as e:
             raise CLIException(FeedbackManager.error_while_running_job(error=str(e)))
         except Exception as e:
             raise CLIException(FeedbackManager.error_getting_job_info(error=str(e), url=job_url))
 
 
 async def wait_job_no_ui(
     tb_client: TinyB,
     job_id: str,
-    timeout: Optional[int] = None,
     status_callback: Optional[Callable[[Dict[str, Any]], None]] = None,
 ) -> Dict[str, Any]:
     try:
-        result = await asyncio.wait_for(tb_client.wait_for_job(job_id, status_callback=status_callback), timeout)
+        result = await asyncio.wait_for(tb_client.wait_for_job(job_id, status_callback=status_callback), None)
         if result["status"] != "done":
             raise JobException(result.get("error"))
         return result
     except asyncio.TimeoutError:
         await tb_client.job_cancel(job_id)
         raise
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/config.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/config.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/connection.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/connection.py`

 * *Files 5% similar despite different names*

```diff
@@ -753,20 +753,23 @@
         s3_trust_policy: Dict[str, Any] = {}
         try:
             s3_trust_policy = await client.get_s3_trust_policy()
             if not len(s3_trust_policy) > 0:
                 raise Exception("S3 Integration not supported in this region")
         except Exception as e:
             raise CLIConnectionException(FeedbackManager.error_connection_integration_not_available(error=str(e)))
-
-        return json.dumps(s3_access_policy, indent=4), json.dumps(s3_trust_policy, indent=4)
+        try:
+            external_id = s3_trust_policy["Statement"][0]["Condition"]["StringEquals"]["sts:ExternalId"]
+        except Exception:
+            external_id = ""
+        return json.dumps(s3_access_policy, indent=4), json.dumps(s3_trust_policy, indent=4), external_id
 
     async def validate_s3_integration(role_arn: Optional[str], region: Optional[str]):
         if no_validate is False:
-            access_policy, trust_policy = await get_s3_policies()
+            access_policy, trust_policy, external_id = await get_s3_policies()
 
             if not role_arn:
                 if not click.confirm(
                     FeedbackManager.prompt_s3_iamrole_connection_login_aws(),
                     show_default=False,
                     prompt_suffix="Press y to continue:",
                 ):
@@ -801,24 +804,29 @@
                         if trust_policy_copied
                         else FeedbackManager.prompt_s3_iamrole_connection_role_not_copied(trust_policy=trust_policy)
                     ),
                     show_default=False,
                     prompt_suffix="Press y to continue:",
                 ):
                     sys.exit(1)
-
+        else:
+            try:
+                trust_policy = await client.get_s3_trust_policy()
+                external_id = trust_policy["Statement"][0]["Condition"]["StringEquals"]["sts:ExternalId"]
+            except Exception:
+                external_id = ""
         if not role_arn:
             role_arn = click.prompt("Enter the ARN of the role you just created")
             validate_string_connector_param("Role ARN", role_arn)
 
         if not region:
             region = click.prompt("Enter the region where the bucket is located")
             validate_string_connector_param("Region", region)
 
-        return role_arn, region
+        return role_arn, region, external_id
 
     async def validate_connection_name(connection_name: Optional[str]) -> str:
         if connection_name and no_validate is False:
             if await client.get_connector(connection_name) is not None:
                 raise CLIConnectionException(FeedbackManager.info_connection_already_exists(name=connection_name))
         else:
             while not connection_name:
@@ -858,10 +866,16 @@
             f.write(
                 f"""TYPE {service}
 
 """
             )
         click.echo(FeedbackManager.success_connection_file_created(name=conn_file_name))
 
-    role_arn, region = await validate_s3_integration(role_arn, region)
+    role_arn, region, external_id = await validate_s3_integration(role_arn, region)
     connection_name = await validate_connection_name(connection_name)
     await create_connection(connection_name, role_arn, region)
+    if external_id:
+        click.echo(
+            FeedbackManager.success_s3_iam_connection_created(
+                connection_name=connection_name, external_id=external_id, role_arn=role_arn
+            )
+        )
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/datasource.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/datasource.py`

 * *Files 0% similar despite different names*

```diff
@@ -719,26 +719,25 @@
             )
         except Exception as e:
             raise CLIDatasourceException(FeedbackManager.error_exception(error=str(e)))
 
 
 @datasource.command(name="sync")
 @click.argument("datasource_name")
+@click.option("--yes", is_flag=True, default=False, help="Do not ask for confirmation")
 @click.pass_context
 @coro
-async def datasource_sync(ctx, datasource_name):
+async def datasource_sync(ctx, datasource_name: str, yes: bool):
     """Sync from connector defined in .datasource file"""
 
     try:
-        await sync_data(ctx, datasource_name)
+        await sync_data(ctx, datasource_name, yes)
     except Exception as e:
         raise CLIDatasourceException(FeedbackManager.error_syncing_datasource(datasource=datasource_name, error=str(e)))
 
-    click.echo(FeedbackManager.success_sync_datasource(datasource=datasource_name))
-
 
 @datasource.command(name="exchange", hidden=True)
 @click.argument("datasource_a", required=True)
 @click.argument("datasource_b", required=True)
 @click.pass_context
 @coro
 async def datasource_exchange(ctx, datasource_a, datasource_b):
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/exceptions.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/exceptions.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/job.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/job.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/pipe.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/pipe.py`

 * *Files 1% similar despite different names*

```diff
@@ -577,15 +577,14 @@
         wait=False,
         ignore_sql_errors=ignore_sql_errors,
         skip_confirmation=False,
         only_response_times=only_response_times,
         workspace_map=dict(workspace_map),
         workspace_lib_paths=workspace,
         no_versions=no_versions,
-        timeout=False,
         run_tests=True,
         tests_to_run=limit,
         tests_sample_by_params=sample_by_params,
         tests_filter_by=match,
         tests_failfast=failfast,
         tests_ignore_order=ignore_order,
         tests_validate_processed_bytes=validate_processed_bytes,
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/regions.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/regions.py`

 * *Files 14% similar despite different names*

```diff
@@ -30,14 +30,21 @@
         "name": "us-east-1",
         "provider": "aws",
         "api_host": "https://api.us-east.aws.tinybird.co",
         "host": "https://ui.us-east.aws.tinybird.co",
         "default_password": "",
     },
     {
+        "name": "us-west-2",
+        "provider": "aws",
+        "api_host": "https://api.us-west-2.aws.tinybird.co",
+        "host": "https://ui.us-west-2.aws.tinybird.co",
+        "default_password": "",
+    },
+    {
         "name": "eu-central-1",
         "provider": "aws",
         "api_host": "https://api.eu-central-1.aws.tinybird.co",
         "host": "https://ui.eu-central-1.aws.tinybird.co",
         "default_password": "",
     },
 ]
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/telemetry.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/telemetry.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/test.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/test.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/tinyunit/tinyunit.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/tinyunit/tinyunit.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/token.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/token.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/workspace.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/workspace.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tb_cli_modules/workspace_members.py` & `tinybird-cli-4.0.1.dev0/tinybird/tb_cli_modules/workspace_members.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird/tornado_template.py` & `tinybird-cli-4.0.1.dev0/tinybird/tornado_template.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/PKG-INFO` & `tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tinybird-cli
-Version: 3.9.1.dev6
+Version: 4.0.1.dev0
 Summary: Tinybird Command Line Tool
 Home-page: https://www.tinybird.co/docs/cli/introduction.html
 Author: Tinybird
 Author-email: support@tinybird.co
 Requires-Python: >=3.8, <3.12
 Description-Content-Type: text/x-rst
 Provides-Extra: bigquery
@@ -14,37 +14,48 @@
 =============
 
 The Tinybird command-line tool allows you to use all the Tinybird functionality directly from the command line. Additionally, it includes several functions to create and manage data projects easily.
 
 Changelog
 ----------
 
-3.9.1.dev6
+4.0.0
 ************
 
-- `Added` Support for unlink materialized pipes doing `tb workspace clear`
+This is a major release, please read the commands affected below and consider updating your scripts and workflow before upgrading to these version.
 
-3.9.1.dev5
-************
-
-- `Added` support for adding multiple tokens when pushing a `.datasource` file
+- `Deprecated` `--semver` flag and `tb release` commands are now deprecated. You can keep using `tb deploy` to integrate and deploy from git. Changes are deployed to the main Workspace instead of to a Release.
+- `Removed` `--cicd` flag and CI/CD templates generation from `tb init`. You can still use the git integration, just create your own pipelines. You can use the ones in this repo as an exmple https://github.com/tinybirdco/ci
+- `Removed` `tb env` command is removed, use `tb branch` instead.
+- `Deprecated` .datasource files with `ENGINE "Join"` are deprecated, use `Engine "MergeeTree"` instead.
+- `Deprecated` `tb materialize`
+- `Removed` Drop the `--timeout` flag from `tb push` which made the populate job to timeout. You can use now `--wait` to wait for the job to finish or nothing to just create the job and return.
+- `Removed` Support for `KEY` directive is removed. The `KEY` was used to create a Data Source with Join engine by the given `KEY` column name. Join engines are also deprecated, you can use a regular `MergeTree` Data Source instead and adapt the pipes SQL accordingly.
 
-3.9.1.dev4
+3.12.0
 ************
 
-- `Fixed` s3 iamrole connection creation will not fail when `pbcopy` dependency is not available
+- `Added` new "us-west-2" region to `tb auth ls`
+- `Fixed` "Appended 0 new rows" message when appending NDJSON
 
-3.9.1.dev3
+3.11.0
 ************
 
-- `Fixed` Fixed a bug on data branching
+- `Added` confirmation step to `tb datasource sync` command
+- `Fixed` support for KAFKA_STORE_BINARY_HEADERS for new Data Sources. Only relevant when KAFKA_STORE_HEADERS is also enabled, used to store Kafka headers as binary data (default option from now on).
+- `Fixed` Report error when `tb push --force --yes` cannot apply a change in a .datasource schema
+- `Fixed` Skip error when using `tb push --only-changes` and no local .git directory is present
 
-3.9.1.dev2
+3.10.0
 ************
 
+- `Added` support for unlink materialized pipes doing `tb workspace clear`
+- `Added` support for adding multiple tokens when pushing a `.datasource` file
+- `Fixed` s3 iamrole connection creation will not fail when `pbcopy` dependency is not available
+- `Fixed` Fixed a bug on data branching
 - `Fixed` Support ngram index
 
 3.9.0
 ************
 
 - `Added` Support for connection names when doing `tb connection rm`
 - `Added` New `--policy` option for `create s3_iamrole` command that will generate different hints depending on the case
```

### Comparing `tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/SOURCES.txt` & `tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.9.1.dev6/tinybird_cli.egg-info/requires.txt` & `tinybird-cli-4.0.1.dev0/tinybird_cli.egg-info/requires.txt`

 * *Files identical despite different names*

